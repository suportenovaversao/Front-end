<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>King Agenda</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/icone.png" type="image/png">
  <link rel="apple-touch-icon" href="/icone.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <script src="https://unpkg.com/@studio-freight/lenis@1.0.33/dist/lenis.min.js"></script>


  <style>
    /* CORREÇÃO: Regra fora do root */
    .onboard-screen[style*="background-image"] {
        background-repeat: no-repeat;
        background-position: center center !important; 
        background-size: cover !important;
    }

    :root {
      --cor-fundo: #0c0c0c;
      --cor-card: #181818;
      --cor-botoes: #222222;
      --cor-texto-principal: #e0e0e0;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-rosa: #e57373;
      --cor-destaque-prata: #c0c0c0;
      --cor-destaque-azul: #007BFF;
      --cor-sombra: #000000;
      --cor-borda: #333;
      --cor-destaque: var(--cor-destaque-ouro);
    }

/* --- SENSAÇÃO DE APP NATIVO (BLOQUEIOS VISUAIS) --- */
* {
    -webkit-tap-highlight-color: transparent; /* Remove flash azul ao tocar */
    -webkit-touch-callout: none; /* Remove menu de toque longo (iOS) */
    -webkit-user-select: none;   /* Chrome/Safari */
    -moz-user-select: none;      /* Firefox */
    -ms-user-select: none;       /* IE */
    user-select: none;           /* Padrão */
}

/* IMPORTANTE: Libera seleção onde é necessário digitar */
input, textarea {
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}

/* ANIMAÇÃO DE BRILHO DOURADO PARA OPÇÃO SELECIONADA */
@keyframes brilhoDourado {
    0% {
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
    }
    50% {
        box-shadow: 0 0 15px var(--cor-tema-forte), 0 0 25px var(--cor-tema-forte); /* cor-tema-forte é o seu dourado */
    }
    100% {
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
    }
}

/* Estilo para o botão de Usuários Online (Admin) */
#onlineUserCount {
    font-size: 14px;
    font-weight: 600;
    /* color: #2ecc71;  <-- REMOVIDO */
    background: linear-gradient(45deg, var(--cor-destaque-prata), var(--cor-destaque-ouro));
    color: var(--cor-fundo);
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    /* animation: pulse-green 2s infinite; <-- REMOVIDO */
    cursor: pointer;
    transition: all 0.3s ease;
}
#onlineUserCount:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.8);
}

/* Esconde o painel branco de texto da rota */

/* Deixa o mapa com aspecto "Noturno" e neon */
.leaflet-tile-pane {
    filter: brightness(0.8) contrast(1.2);
}

/* Ícones pulsantes no mapa */
@keyframes pulse-marker {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}
.custom-map-marker div {
    animation: pulse-marker 1.5s infinite;
    text-shadow: 0 0 5px rgba(0,0,0,0.8);
}

/* Estilo para o modal de novo agendamento (não-fechável) */
#modalNovoAgendamento {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

/* Estilo para item clicável na lista de usuários online */
#listaUsuariosOnline .selectable-item {
    background: var(--cor-botoes);
    border: 1px solid var(--cor-borda);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
#listaUsuariosOnline .selectable-item:hover {
    border-color: var(--cor-destaque);
    background-color: var(--cor-card);
}

/* Estilos para Desktop - Agendamentos do Profissional */
@media (min-width: 768px) { /* Aplica a partir de telas médias (tablets e desktops) */
  #modalAgendamentosBarbeiro .modal-content {
    max-width: 800px; /* Modal um pouco mais largo */
  }

  #agendamentosPainel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Cria colunas */
    gap: 15px; /* Espaçamento entre os cards */
    max-height: 70vh; /* Ajusta a altura máxima se necessário */
  }

  #agendamentosPainel .card {
    width: auto; /* Deixa o card ocupar o espaço da coluna */
    margin: 0; /* Remove margem padrão do card */
  }

  /* Opcional: Ajustar tamanho da fonte ou padding nos cards se necessário */
  #agendamentosPainel .card p,
  #agendamentosPainel .card button {
    font-size: 0.9em; /* Levemente menor para caber mais info */
  }
   #agendamentosPainel .card button {
      padding: 8px 10px;
   }

   /* Ajustes gerais para telas maiores */
   .content-container {
      max-width: 900px; /* Container principal mais largo */
   }
   .card {
     max-width: none; /* Remove limitação de largura dos cards */
   }
}

/* Garante que o modal da agenda tenha rolagem interna */
#modalAgendaBarbeiro .modal-content {
    max-height: 85vh; /* Altura máxima */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* O scroll vai no corpo, não no modal todo */
}

/* Área de rolagem para os botões e grid */
#agendaScrollContent {
    overflow-y: auto;
    padding-right: 5px;
    flex-grow: 1;
}

/* Correção visual do Grid de Horários */
#horariosContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
    padding: 10px;
    background: var(--cor-fundo);
    border: 1px solid var(--cor-borda);
    border-radius: 8px;
    margin-top: 10px;
}

/* CLASSE QUE APLICA A ANIMAÇÃO QUANDO SELECIONADO */
.onboard-option.selected {
    border: 2px solid var(--cor-tema-forte) !important; /* Adiciona uma borda dourada sólida */
    animation: brilhoDourado 1.5s infinite alternate; /* Aplica o brilho piscante */
}

/* Garante que o item não selecionado não tenha a animação */
.onboard-option:not(.selected) {
    animation: none;
}
    body.tema-claro {
      --cor-fundo: #f0f0f0;
      --cor-card: #ffffff;
      --cor-botoes: #e0e0e0;
      --cor-texto-principal: #333;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-rosa: #e57373;
      --cor-destaque-prata: #808080;
      --cor-destaque-azul: #0056b3;
      --cor-sombra: #b0b0b0;
      --cor-borda: #ccc;
    }
    body {
      background-image: url('/icone.png'); /* Caminho correto para o Firebase Hosting/Web */
      background-size: cover; /* Garante que a imagem cubra todo o elemento */
      background-position: center; /* Centraliza a imagem */
      background-repeat: no-repeat; /* Evita repetição */
      background-attachment: fixed; /* Opcional: mantém a imagem fixa ao rolar */

      /* Adiciona um overlay escuro para o texto ficar mais legível */
      background-blend-mode: multiply;
      background-color: rgba(0, 0, 0, 0.6); /* Cor de fundo escura (ajuste a opacidade 0.6 se necessário) */
      
      margin: 0;
      background: var(--cor-fundo);
      color: var(--cor-texto-principal);
      font-family: 'Poppins', sans-serif;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }
    .content-container {
      width: 100%;
      max-width: 500px;
      padding-top: 60px;
      padding-bottom: 80px; /* Espaço para os botões do rodapé */
      box-sizing: border-box;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative; /* Adicionado para posicionamento do chat preview */
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border: 1px solid var(--cor-borda);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box; /* CORREÇÃO: Garante que padding não estoure a div */
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    button:disabled {
        cursor: not-allowed;
        background: #444;
        opacity: 0.6;
    }
    .card {
      background: var(--cor-card);
      padding: 24px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 6px 15px var(--cor-sombra);
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      /* Transição mais fluida */
      transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
    .card.exiting {
        opacity: 0;
        transform: translateX(-50px);
    }
    .card.entering {
        opacity: 0;
        transform: translateX(50px);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hidden {
      display: none !important;
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--cor-card);
      color: var(--cor-texto-principal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 4px #000;
      font-size: 18px;
      z-index: 10;
      border-bottom: 2px solid var(--cor-borda);
    }
    .logo {
      font-weight: 600;
      color: var(--cor-destaque);
      font-size: 18px;
      text-shadow: 0 0 5px var(--cor-destaque);
      transition: color 0.3s;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 15px; /* Aumentado o espaço */
    }
    #btnConfig {
      font-size: 20px;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--cor-card);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
      border: 1px solid var(--cor-borda);
      position: relative; /* Para popups sobrepostos */
    }
    .modal-overlay-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(12, 12, 12, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 20px;
        z-index: 25; /* Fica acima do conteúdo do modal pai */
    }
    /* Estilo para o modal de ranking maior */
    #modalRankingUnificado .modal-content {
        max-width: 600px; /* Maior para caber as duas colunas */
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .servico-btn {
      background: #333;
      margin: 6px 0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px;
      text-align: left;
    }
    .bottom-buttons-container {
      position: fixed;
      bottom: 12px;
      width: 90%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      z-index: 15;
    }
    .redeem-container {
      position: fixed;
      bottom: 25px; /* Posição ajustada */
      width: 100%;
      max-width: 500px;
      text-align: center;
      z-index: 15;
      box-sizing: border-box;
    }
    .redeem-container button {
      width: 200px;
      font-size: 14px;
      padding: 10px;
      margin: 0;
    }
    #btnChat, #btnDenuncia {
      font-size: 26px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: relative; /* Para o contador de notificação */
    }
    #btnSair {
      font-size: 20px; /* Reduzido */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: fixed;
      bottom: 72px; /* Posição alterada para ficar acima do botão de denúncia */
      left: 12px;
      z-index: 15;
    }
    #btnTema {
      font-size: 18px; /* Ajuste aqui */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    #btnCarteiraTop {
      font-size: 16px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #botaoExtra {
      margin: 10px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .vantagens ul {
      list-style-type: '✅';
      padding-left: 20px;
    }
    .vantagens li {
      background: transparent;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding-left: 10px;
    }
    @keyframes vaga-glow {
      0% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
      50% { box-shadow: 0 0 16px #4CAF50, 0 0 24px #4CAF50; }
      100% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
    }
    @keyframes gold-flash-background {
        0%, 100% { background-color: var(--cor-card); }
        50% { background-color: #2c250e; }
    }
    .boosted-card {
        border: 2px solid var(--cor-destaque);
        animation: gold-flash-background 3s ease-in-out infinite, fadeIn 0.5s;
    }
    .boost-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        text-shadow: 0 0 8px var(--cor-destaque);
    }
    @keyframes gold-flash {
      0%, 100% { background-color: transparent; transform: scale(1); }
      50% { background-color: rgba(212, 175, 55, 0.8); transform: scale(1.2); }
    }
    @keyframes gold-pulse {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
      70% { box-shadow: 0 0 10px 15px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .notificacao-pulsante {
        animation: gold-pulse 1.5s infinite;
    }
    .new-message-glow {
        animation: gold-flash 1.5s ease-in-out infinite;
        border-radius: 50%;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid var(--cor-fundo);
    }
    .vip-glow {
      box-shadow: 0 0 8px var(--cor-destaque), 0 0 12px var(--cor-destaque);
      border: 1px solid var(--cor-destaque);
    }
    
    /* NOVO ESTILO ADICIONADO AQUI */
    .pro-glow {
      box-shadow: 0 0 8px var(--cor-destaque-azul), 0 0 12px var(--cor-destaque-azul);
      border: 1px solid var(--cor-destaque-azul);
    }
    .promocao-card {
      background: linear-gradient(45deg, #181818, var(--cor-destaque));
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: #fff;
    }
    .chat-container {
      height: 100%;
      flex-grow: 1; /* Faz o container crescer */
      overflow-y: auto;
      border: 1px solid var(--cor-borda);
      padding: 10px;
      border-radius: 10px;
      background: #0d0d0d;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column; 
    }
    .chat-message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      animation: fadeIn 0.3s ease-in-out;
      transition: opacity 1.5s ease-out; /* Transição para o fade out */
    }
    .chat-message.fading-out {
        opacity: 0;
    }
    .chat-sent {
      text-align: right;
      background: #333;
      margin-left: 20%;
    }
    .chat-received {
      text-align: left;
      background: #555;
      margin-right: 20%;
    }
    .scrollable-list {
      max-height: 250px; /* Ou outro valor que funcione bem */
overflow-y: auto;
padding-right: 10px; /* Espaço para a barra de rolagem */
    }
    .aviso-item {
      text-align: left;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      opacity: 0.8;
      transition: opacity 0.3s ease-in-out;
    }
    .horario-btn {
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 8px;
        margin: 5px;
        width: 100px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .horario-btn.selecionado {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
    }
    .horario-btn.bloqueado {
        background: #772014;
        color: #fff;
        border-color: #772014;
        text-decoration: line-through;
    }
    .horarios-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
    }
    .horarios-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .horario-disponivel {
      background: var(--cor-botoes);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--cor-texto-principal);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .horario-disponivel:hover {
      background: var(--cor-destaque);
    }
    .admin-chat-red {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }
    .barbeiro-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-azul);
    }
    .cliente-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-prata);
    }
    .show-password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .show-password-container input {
        padding-right: 40px;
    }
    .show-password-toggle {
        position: absolute;
        right: 15px;
        cursor: pointer;
        color: var(--cor-destaque-prata);
    }
    .barbeiro-card {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: flex-start; /* Alinha itens ao início (esquerda) */
        align-items: center; /* Centraliza verticalmente */
        border-bottom: 1px solid var(--cor-borda);
        padding-bottom: 10px;
        gap: 15px; /* Espaço entre a logo e o texto */
    }

    .card-header img {
        flex-shrink: 0; /* Garante que a logo não diminua */
        margin: 0; /* Remove margens antigas */
    }

    .card-header-info {
        flex-grow: 1; /* Faz essa div ocupar todo o espaço restante */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center; /* Centraliza o texto horizontalmente */
        text-align: center; /* Garante que o texto dentro fique centralizado */
        min-width: 0; /* Evita que textos longos quebrem o layout flex */
    }
    .card-header-info h4 {
        margin: 0;
        font-size: 1.1em;
        color: var(--cor-destaque);
    }
    .card-header-info p {
        margin: 4px 0 0;
        font-size: 0.8em;
        opacity: 0.8;
    }
    .card-reputacao {
        font-size: 0.9em;
        text-align: right;
    }
    .card-status {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }
    .status-imediato {
        background-color: #4CAF50;
        color: white;
        animation: vaga-glow 1.5s ease-in-out infinite;
    }
    .status-manual {
        background-color: var(--cor-botoes);
    }
    .status-indisponivel {
        background-color: #555;
        opacity: 0.7;
    }
    .card-horarios-disponiveis {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
    }
    .card-horarios-disponiveis span {
        background: #333;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85em;
    }
    .card-servicos-title {
        font-size: 0.9em;
        font-weight: 600;
        margin-top: 8px;
        border-top: 1px solid var(--cor-borda);
        padding-top: 10px;
    }
    .card-servicos-list {
        font-size: 0.8em;
        opacity: 0.9;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .popup-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--cor-borda);
    }
    .popup-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .selectable-item {
        background: var(--cor-botoes);
        border: 1px solid var(--cor-borda);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .selectable-item:hover {
        border-color: var(--cor-destaque);
    }
    .selectable-item.selected {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
        font-weight: 600;
    }
    #barbeiroPerfilHorariosList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }
    #barbeiroPerfilHorariosList .selectable-item {
        flex-grow: 1;
        text-align: center;
    }
    #modalBarbeiroPerfil .modal-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    #chatPreview {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 24, 0.8);
        color: var(--cor-texto-principal);
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    #chatPreview.show {
        opacity: 1;
    }
    .conquista-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--cor-botoes);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .conquista-item.unlocked {
        border-left: 5px solid var(--cor-destaque);
    }
    .conquista-item.locked {
        opacity: 0.5;
        border-left: 5px solid var(--cor-borda);
    }
    .conquista-icon {
        font-size: 2em;
    }
    .ranking-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }
    .ranking-column {
        flex: 1;
        min-width: 0;
    }
    .ranking-column h4 {
        text-align: center;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .ranking-item:first-child {
        font-weight: bold;
        color: var(--cor-destaque);
    }
    .chat-medal {
        margin-right: 4px;
    }
    .app-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 5px 0;
        font-size: 10px;
        color: var(--cor-texto-principal);
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
    }
    /* Estilos do Chat Fullscreen */
    #janelaChat.fullscreen {
        padding: 0;
        border-radius: 0;
    }
    #janelaChat.fullscreen .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #janelaChat.fullscreen #chatInput {
        margin-bottom: 0;
    }
    #janelaChat #carregarMaisMsgBtn {
        margin: 0;
        width: 100%;
        border-radius: 0;
        background-color: var(--cor-botoes);
    }
    /* Estilos do Portfólio */
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 10px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .portfolio-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--cor-borda);
    }
    #modalPortfolioCliente .modal-content, #lojaView .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }

/* Estilos para o novo gerenciador de portfólio do profissional */
#portfolioInputsContainer {
    display: grid;
    /* Cria um grid que se ajusta, mostrando quantas colunas de 120px couberem */
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
    gap: 10px;
    max-height: 400px; /* Aumentado de 250px para 400px para caber mais */
    overflow-y: auto;
    padding: 5px;
    background: var(--cor-fundo); /* Fundo para ver os cards */
    border-radius: 8px;
}
.portfolio-admin-item {
    border: 1px solid var(--cor-borda);
    border-radius: 8px;
    overflow: hidden; /* Para o input não vazar */
    background: var(--cor-botoes);
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.portfolio-admin-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    background: #333; /* Cor de fundo enquanto a imagem carrega */
    border-bottom: 1px solid var(--cor-borda);
}
.portfolio-admin-item input {
    width: 100%;
    border-radius: 0;
    margin: 0;
    border: none;
    font-size: 12px;
    padding: 8px;
    box-sizing: border-box; /* Garante que o padding não quebre o layout */
}

    /* Estilos da Loja */
    .loja-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .produto-card {
        background: var(--cor-botoes);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--cor-borda);
        cursor: pointer;
    }
    .produto-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .produto-info {
        padding: 10px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .produto-nome { font-weight: 600; font-size: 1em; }
    .produto-preco { font-size: 1.1em; color: var(--cor-destaque); margin-top: 5px; }
    .produto-preco-original { text-decoration: line-through; opacity: 0.7; font-size: 0.9em; }
    .produto-card button { font-size: 14px; padding: 8px; margin-top: 10px;}
    #lojaView .card-header { display: flex; justify-content: space-between; align-items: center; }
    #lojaView .card-header h3 { font-size: 1.1em; white-space: nowrap; }
    #lojaContainer h4 { font-size: 1.0em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tamanho-options { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
    .tamanho-options label {
      padding: 5px 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .tamanho-options input { display: none; }
    .tamanho-options input:checked + label {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      border-color: var(--cor-destaque);
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .checkbox-group input { width: auto; margin: 0; }

    .modal-venda {
      z-index: 99;
    }
    .modal-venda .modal-content {
      background: #c0392b;
      color: white;
      text-align: center;
      border: 3px solid #e74c3c;
      animation: flash-red 1.5s infinite;
    }
    .modal-venda h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes flash-red {
      0%, 100% { background-color: #c0392b; }
      50% { background-color: #e74c3c; }
    }
    
    /* NOVOS ESTILOS */
    .barbeiro-list-container {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .promo-info {
      font-size: 0.8em;
      color: var(--cor-destaque);
      margin: 8px 0 0 0;
      padding-top: 8px;
      border-top: 1px dashed var(--cor-borda);
    }
    #pix-qrcode {
        max-width: 200px;
        margin: 15px auto;
        display: block;
        border: 5px solid white;
        border-radius: 10px;
    }
    .pix-copia-cola-container {
      position: relative;
    }
    .pix-copia-cola-container button {
        width: 100%;
    }
    #pixChaveAleatoria {
        display: none;
    }
    .metodos-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #detalhesProdutoAvaliacao {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }
    .avaliacao-estrelas {
        font-size: 1.2em;
        color: var(--cor-destaque);
    }
    .avaliacao-comentario {
        font-style: italic;
        opacity: 0.8;
        margin-top: 5px;
        font-size: 0.9em;
        background: var(--cor-botoes);
        padding: 8px;
        border-radius: 8px;
    }
    /* Estilo para imagem de produto no popup */
    #detalhesProdutoImg {
        width: 100%;
        height: 250px;
        object-fit: contain; /* Garante que a imagem apareça inteira */
        border-radius: 10px;
        margin-bottom: 15px;
        background-color: var(--cor-botoes);
    }

/* ===================================================================== */
/* ====== INÍCIO: CSS PARA SCROLLBARS (COPIAR) ======================== */
/* ===================================================================== */

/* ===================================================================== */
/* ====== INÍCIO: CORREÇÃO LAYOUT E SCROLL (SUBSTITUIR) =============== */
/* ===================================================================== */

/* Adiciona scroll ao popup de perfil do profissional (para o cliente) */
#modalBarbeiroPerfil .modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

/* --- CORREÇÃO DE LAYOUT E SCROLL DOS MODAIS DE ONBOARDING --- */
/* Garante que o conteúdo dos modais fique em coluna (um abaixo do outro) */
#modalOnboardingProfissionalServicos .modal-content,
#modalAddPromocao .modal-content, 
#modalOnboardingPromocoes .modal-content,
#modalOnboardingAgenda .modal-content,
#modalOnboardingLogomarca .modal-content,
#modalOnboardingPortfolio .modal-content {
    overflow-y: auto;
    max-height: 90vh;
    display: flex; 
    flex-direction: column; /* <-- ESTA É A CORREÇÃO PRINCIPAL */
}

/* Garante que a área de conteúdo (inputs, listas, etc.) possa rolar */
#modalOnboardingProfissionalServicos .modal-content,
#modalOnboardingAgenda .modal-content,
#modalOnboardingLogomarca .modal-content,
#modalOnboardingPortfolio .modal-content {
    overflow-y: auto; /* Adiciona scroll ao modal-content principal */
}

/* Para os modais de promoção (que têm um scrollable-list interno) */
#modalAddPromocao .scrollable-list, 
#modalOnboardingPromocoes .scrollable-list {
    overflow-y: auto;
    flex-grow: 1; /* Faz esta área crescer para ocupar o espaço */
    padding-right: 10px;
}
/* ===================================================================== */
/* ====== FIM: CORREÇÃO LAYOUT E SCROLL (SUBSTITUIR) ================== */
/* ===================================================================== */

    /* ESTILOS ADICIONAIS Nova Versão */
    #popupAguarde {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        z-index: 101;
    }
    #popupAguarde .modal-content {
        background: transparent;
        box-shadow: none;
        border: none;
        text-align: center;
        font-size: 1.2em;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid var(--cor-destaque);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    .modal-fullscreen {
        align-items: flex-end; /* Alinha o modal na parte inferior */
        background: none;
    }
    .modal-fullscreen .modal-content {
        width: 100%;
        height: 90vh;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        animation: slide-up 0.5s ease-out;
    }
    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    #onboardingContent {
        text-align: center;
    }
    #onboardingContent img {
        max-width: 80%;
        height: auto;
        margin-bottom: 20px;
    }
    .interest-options button {
    background: var(--cor-botoes);
    border: 2px solid transparent;
    transition: all 0.3s ease; /* Adicionado para suavizar o efeito */
}
    .interest-options button.selected {
    border-color: var(--cor-destaque);
    background: var(--cor-destaque-ouro);
    color: var(--cor-fundo);
    box-shadow: 0 0 15px var(--cor-destaque-ouro); /* Adicionado para o efeito de brilho */
}
    .onboarding-background-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.15;
      z-index: -1;
      border-radius: 20px 20px 0 0;
    }
    .onboarding-content-wrapper {
      position: relative;
      z-index: 1;
      padding: 20px;
      color: white;
      text-shadow: 1px 1px 3px black;
    }

/* Adicionado para a tela de onboarding ficar cheia */
#modalOnboarding .modal-content {
    padding: 0;
    border-radius: 0;
    height: 100%;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-image: linear-gradient(rgba(0,0,0, 0.7), rgba(0,0,0, 0.7)), url('https://i.postimg.cc/NjxQW6sm/ezgif-com-animated-gif-maker.gif');
    background-size: cover;
    background-position: center;
}

    @keyframes blink-animation {
      0%, 100% { background-color: var(--cor-botoes); }
      50% { background-color: var(--cor-destaque); }
    }
    .blinking-button.closed {
      animation: blink-animation 2s infinite;
    }
    .chat-tabs {
        display: flex;
        border-bottom: 1px solid var(--cor-borda);
        margin-bottom: 10px;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
    }
    .chat-tab.active {
        border-bottom-color: var(--cor-destaque);
    }
    .config-section button.selected {
        background-color: var(--cor-destaque);
        color: var(--cor-fundo);
    }
.footer-contact a {
    color: inherit; /* Herda a cor do texto padrão */
    text-decoration: none;
    display: inline-block; /* Necessário para aplicar gradiente corretamente */
}

.animated-gradient-text {
    background: linear-gradient(90deg, var(--cor-destaque-prata), var(--cor-destaque-ouro), var(--cor-destaque-prata));
    background-size: 200% auto; /* Tamanho do gradiente para animação */
    color: transparent; /* Torna o texto transparente */
    -webkit-background-clip: text;
    background-clip: text;
    animation: gradient-animation 4s linear infinite;
    font-weight: 500; /* Um pouco mais de destaque */
}

@keyframes gradient-animation {
    0% { background-position: 200% center; }
    100% { background-position: 0% center; }
}

.online-counter {
    font-size: 14px;
    font-weight: 600;
    color: #2ecc71; /* Verde vivo */
    background-color: var(--cor-botoes);
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
    animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
    0% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.3); }
    50% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.8); }
    100% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.3); }
}

/* Feedback visual para admin poder deletar msg no chat */
.chat-message.admin-deletable {
    cursor: pointer;
    border: 1px dashed rgba(255, 0, 0, 0.3);
    transition: all 0.2s ease-in-out;
}
.chat-message.admin-deletable:hover {
    background-color: #4d1c1c; /* Fundo vermelho escuro no hover */
    border: 1px dashed rgba(255, 0, 0, 0.8);
}

.professional-name-card {
        margin: 0;
        font-size: 1.2em; /* Um pouco maior */
        font-weight: 700; /* Mais forte (Poppins 700) */
        color: var(--cor-destaque); /* Usa a cor do tema */
        text-shadow: 0 0 6px rgba(212, 175, 55, 0.4); /* Brilho sutil */
        transition: text-shadow 0.3s ease;
    }
    .barbeiro-card:hover .professional-name-card {
         text-shadow: 0 0 10px var(--cor-destaque); /* Brilho maior no hover */
    }

.card-reputacao-info {
        font-size: 0.9em;
        margin-top: 5px; /* Espaçamento do item acima (distância) */
        color: var(--cor-destaque); /* Cor dourada/tema */
    }
    .card-reputacao-info span {
        color: var(--cor-texto-principal); /* Cor do texto normal para o número */
        opacity: 0.8;
        font-size: 0.9em;
    }
.card-action-btn { /* Classe base para ações no card */
        position: absolute;
        bottom: 10px;
        background: rgba(0,0,0,0.6);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        z-index: 5;
        transition: transform 0.2s;
        color: var(--cor-texto-principal); /* Cor do ícone */
    }
    .card-action-btn:hover {
        transform: scale(1.1);
    }
    
    .card-favorite-btn {
        right: 10px; /* Coração na direita */
    }
    
    .card-share-btn {
        right: 50px; /* Link ao lado do Coração */
        font-size: 18px; 
    }
/* Agenda Visual Corrigida */
#horariosContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* Botoes com tamanho fixo e responsivo */
    gap: 8px;
    justify-content: center;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: var(--cor-fundo);
    border-radius: 8px;
    border: 1px solid var(--cor-borda);
    margin-top: 10px;
}
/* Ajuste no botão de horário */
.horario-btn {
    width: 100% !important; /* Ocupa a célula do grid */
    margin: 0 !important;   /* Remove margem externa pois usamos gap */
    font-size: 13px;
    padding: 8px 2px;
}

    /* Scroll para a Agenda do Onboarding */
    #onboardingHorariosContainer {
        display: flex; 
        flex-wrap: wrap; 
        gap: 5px; 
        justify-content: center;
        max-height: 200px; /* Define uma altura máxima */
        overflow-y: auto; /* Adiciona o scroll vertical */
        padding: 5px;
        background: var(--cor-fundo);
        border-radius: 5px;
    }

/* --- NOVOS ESTILOS (FAVORITOS, PREMIUM, PERFIL, MOLDURAS) --- */

/* Botão Favoritos Estilizado */
.btn-favoritos-estilo {
    font-size: 14px !important;
    padding: 8px 16px !important;
    border-radius: 20px !important;
    font-weight: 600;
    margin: 10px auto;
    display: block;
    width: fit-content !important;
    transition: transform 0.2s;
    cursor: pointer;
}

.estilo-gold {
    background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    color: #000 !important;
    border: 1px solid #aa771c !important;
    box-shadow: 0 0 10px rgba(191, 149, 63, 0.5);
}

.estilo-pink {
    background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4);
    color: #4a0000 !important;
    border: 1px solid #ff9a9e !important;
    box-shadow: 0 0 10px rgba(255, 154, 158, 0.5);
}

/* Produto Premium na Loja */
.produto-premium {
    grid-column: 1 / -1; /* Ocupa toda a largura */
    background: radial-gradient(circle, #2c250e 0%, #000000 100%);
    border: 2px solid var(--cor-destaque-ouro);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
    transform: scale(1.02);
    margin-bottom: 20px;
    animation: gold-pulse 2s infinite;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.produto-premium .produto-nome {
    font-size: 1.3em;
    color: var(--cor-destaque-ouro);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: bold;
    margin-top: 10px;
}
.produto-premium .produto-preco {
    font-size: 1.5em;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 0 5px var(--cor-destaque-ouro);
    margin-bottom: 10px;
}

#modalMeuPerfil .modal-content {
    max-height: 90vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* Roleta Diária */
/* --- ROLETA FINAL (Visual + Seta Corrigida) --- */
.roleta-container {
    background: #111;
    border: 4px solid #d4af37;
    border-radius: 15px;
    height: 100px; 
    margin: 20px auto;
    position: relative; /* Importante para a seta */
    overflow: hidden;   /* Corta o que sai da caixa */
    width: 100%;
    max-width: 320px;
    box-shadow: inset 0 0 30px rgba(0,0,0,1); /* Sombra interna mais forte */
}

/* Sombras laterais (Fade) */
.roleta-container::before, .roleta-container::after {
    content: '';
    position: absolute;
    top: 0; bottom: 0; width: 60px; z-index: 2; pointer-events: none;
}
.roleta-container::before { left: 0; background: linear-gradient(to right, #000, transparent); }
.roleta-container::after { right: 0; background: linear-gradient(to left, #000, transparent); }

.roleta-faixa {
    display: flex;
    height: 100%;
    align-items: center;
    will-change: transform;
}

.roleta-item {
    /* MEDIDA EXATA: 80px + 5px margem esq + 5px margem dir = 90px TOTAL */
    width: 80px; 
    height: 80px;
    margin: 0 5px; 
    flex-shrink: 0;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px; /* Fonte maior */
    font-weight: 900;
    font-family: 'Arial Black', sans-serif;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    border: 2px solid rgba(255,255,255,0.2);
}

/* Cores Vivas */
.tema-barbearia .roleta-item:nth-child(odd) { background: #ffcc00; color: #000; }
.tema-barbearia .roleta-item:nth-child(even) { background: #1a1a1a; color: #ffcc00; border-color: #ffcc00; }
.tema-feminino .roleta-item:nth-child(odd) { background: #ff6b81; color: #fff; }
.tema-feminino .roleta-item:nth-child(even) { background: #1a1a1a; color: #ff6b81; border-color: #ff6b81; }
.roleta-item.especial { background: #fff !important; color: #333 !important; border: 3px solid gold; }

@keyframes pulse-glow {
    from { box-shadow: 0 0 5px rgba(255,255,255,0.5); }
    to { box-shadow: 0 0 20px rgba(255,255,255,1); }
}

/* Indicador de Seleção na Moldura */
.moldura-check {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #2ecc71;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    z-index: 2;
}
.roleta-faixa {
    display: flex; /* Flexbox para alinhar os itens */
    height: 100%;
    align-items: center; /* Centraliza verticalmente */
    will-change: transform; /* Otimiza performance */
}

/* Temas da Roleta */
.tema-barbearia .roleta-item:nth-child(odd) { background: var(--cor-destaque-ouro); color: #000; }
.tema-barbearia .roleta-item:nth-child(even) { background: #000; color: var(--cor-destaque-ouro); }
.tema-feminino .roleta-item:nth-child(odd) { background: var(--cor-destaque-rosa); color: #000; }
.tema-feminino .roleta-item:nth-child(even) { background: #000; color: var(--cor-destaque-rosa); }
.roleta-item.especial { background: #fff !important; color: #000 !important; box-shadow: 0 0 15px #fff; }


/* Molduras */
.moldura-item {
    transition: transform 0.1s, border-color 0.2s;
    -webkit-tap-highlight-color: transparent; /* Remove o fundo azul/cinza no mobile */
    outline: none; /* Remove borda de foco */
    user-select: none; /* Impede seleção de texto */
}
.moldura-item:active, .moldura-item:focus {
    background-color: transparent !important; /* Garante que não tenha fundo */
}
/* O checkmark agora é controlado por uma classe 'temp-selected' via JS para feedback instantâneo */
.moldura-item.temp-selected .moldura-check {
    display: flex !important;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.moldura-item:not(.temp-selected):not(.selecionada) .moldura-check {
    display: none;
}

@keyframes popIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}
.moldura-item.comprada { border-color: #4CAF50; }
.moldura-item.selecionada { border-color: var(--cor-destaque); }

.moldura-item.temp-selected {
    border-color: var(--cor-destaque) !important;
    transform: scale(1.05);
}
/* Molduras Visuais */
.avatar-frame-bronze { border: 3px solid #cd7f32; box-shadow: 0 0 5px #cd7f32; }
.avatar-frame-prata { border: 3px solid #c0c0c0; box-shadow: 0 0 8px #c0c0c0; }
.avatar-frame-ouro { border: 3px solid #ffd700; box-shadow: 0 0 10px #ffd700; animation: gold-pulse 2s infinite; }
.avatar-frame-diamante { border: 3px solid #b9f2ff; box-shadow: 0 0 12px #b9f2ff, inset 0 0 10px #b9f2ff; animation: flash-blue 1.5s infinite; }

@keyframes flash-blue { 0%, 100% { box-shadow: 0 0 12px #b9f2ff; } 50% { box-shadow: 0 0 20px #fff; } }

/* Foto no Chat */
.chat-user-photo {
    width: 24px; height: 24px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 5px;
    object-fit: cover;
    border: 1px solid #555;
    cursor: pointer;
}

/* Popup Perfil Bonito */
.perfil-visualizacao {
    text-align: center;
    background-size: cover;
    background-position: center;
    position: relative;
    overflow: hidden;
}
.perfil-visualizacao::before {
    content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); z-index: 0;
}
.perfil-visualizacao-content { position: relative; z-index: 1; padding: 20px; }
.perfil-foto-grande {
    width: 120px; height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
}

/* Inversão Botões Rodapé */
.bottom-buttons-container {
    display: flex;
    flex-direction: column-reverse; /* Sair embaixo, Denuncia em cima */
    align-items: flex-start;
    position: fixed;
    bottom: 12px; left: 12px;
    gap: 15px;
    z-index: 15;
    width: auto;
}
/* Reset de posições antigas para funcionar no novo container */
#btnSair { position: static !important; margin: 0 !important; }
#btnDenuncia { position: static !important; margin: 0 !important; }
/* Botão Chat Fixo na Direita */
/* === CORREÇÃO BOTÃO CHAT (RESGATE) === */
#btnChat {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    left: auto !important; /* Garante que não fique na esquerda */
    z-index: 1000 !important; /* Z-index altíssimo para ficar acima de tudo */
    display: flex !important;
    align-items: center;
    justify-content: center;
    
    /* Estilo Visual para garantir visibilidade */
    background-color: rgba(0, 0, 0, 0.6) !important; /* Fundo escuro translúcido */
    border: 1px solid var(--cor-destaque) !important; /* Borda na cor do tema */
    border-radius: 50% !important;
    width: 50px !important;
    height: 50px !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
    
    /* Texto/Emoji */
    font-size: 24px !important;
    line-height: 1 !important;
    padding: 0 !important;
    margin: 0 !important;
    cursor: pointer;
}

/* Garante que o emoji dentro não seja afetado por outros estilos */
#btnChat span {
    pointer-events: none;
    display: block;
}

/* Ajuste da bolinha de notificação */
.notification-badge {
    position: absolute !important;
    top: -5px !important;
    right: -5px !important;
    background-color: #e74c3c !important; /* Vermelho forte */
    color: white !important;
    border-radius: 50%;
    padding: 4px 7px !important;
    font-size: 11px !important;
    font-weight: bold;
    border: 2px solid #fff;
    z-index: 1002; /* Acima do botão do chat */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    display: none; /* Começa oculto */
}
.notification-badge.visible {
    display: block !important;
    animation: pulse-red 2s infinite;
}

#btnChat .notification-badge {
    position: absolute !important;
    top: -5px !important;
    right: -5px !important;
    background-color: #e74c3c !important;
    color: white !important;
    border-radius: 50%;
    padding: 4px 7px !important;
    min-width: 18px; /* Garante bolinha redonda */
    text-align: center;
    font-size: 11px !important;
    font-weight: bold;
    border: 2px solid #fff;
    z-index: 1002;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    display: none; /* Começa oculto */
}
#btnChat .notification-badge.visible {
    display: block !important;
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
    100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

/* Botão Admin Premium */
.btn-admin-premium {
    background: linear-gradient(45deg, #000, #d4af37);
    border: 1px solid #d4af37;
    color: #fff;
    width: 100%;
    margin-bottom: 10px;
    font-weight: bold;
}

/* === CORREÇÃO DE LAYOUT (CSS FIX) === */

/* 1. Forçar centralização da tela inteira */
body {
    display: flex;
    flex-direction: column;
    align-items: center !important; /* Garante que tudo fique no meio horizontalmente */
    overflow-x: hidden; /* Impede barra de rolagem lateral */
    width: 100%;
}

/* 2. Arrumar o container principal */
.content-container {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    width: 100% !important;
    max-width: 500px !important; /* Mantém o formato de app */
    margin: 0 auto !important; /* Centraliza o bloco na tela */
    padding-top: 70px !important; /* Espaço para a Topbar não cobrir o conteúdo */
    position: relative;
}

/* 3. Consertar os Cards (Admin, Cliente, etc) */
.card {
    width: 92% !important; /* Garante margem nas laterais */
    max-width: 480px !important;
    margin: 10px auto !important; /* Centraliza o card */
    box-sizing: border-box; /* Evita que o padding estoure a largura */
}

/* 4. Ajustar a Topbar para caber tudo */
.topbar {
    justify-content: space-between !important;
    padding: 0 8px !important; /* Reduz padding lateral */
    width: 100%;
    box-sizing: border-box;
    z-index: 100; /* Garante que fique acima de tudo */
}

.topbar-right {
    gap: 5px !important; /* Diminui espaço entre ícones para não vazar */
    flex-wrap: nowrap !important; /* Impede que os ícones caiam pra linha de baixo */
}

/* Ajuste de tamanho dos botões da Topbar para telas pequenas */
.topbar-right button {
    font-size: 18px !important; /* Levemente menor */
    padding: 5px !important;
}

#onlineUserCount {
    font-size: 12px !important;
    padding: 4px 8px !important;
    white-space: nowrap; /* Texto não quebra */
}

/* 5. Consertar Botões Inferiores (Sair e Denúncia) */
.bottom-buttons-container {
    position: fixed !important;
    bottom: 20px !important;
    left: 20px !important;
    display: flex !important;
    flex-direction: column-reverse !important; /* Sair em baixo, Denúncia em cima */
    gap: 15px !important;
    z-index: 99;
    align-items: center;
}

/* 6. Ajuste do Painel Admin (Botões cortados) */
#adminView > div {
    justify-content: center !important; /* Centraliza os botões do admin */
}
#adminView button {
    flex-grow: 1; /* Faz botões ocuparem espaço igual */
    min-width: 130px; /* Tamanho mínimo para não cortar texto */
    margin: 5px !important;
}

@keyframes brilhoMetalico {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Garante que modais de confirmação fiquem acima do popup de agendamento (9999) */
#modalConfirmacaoGenerica, 
#modalPopupGenerico, 
#modalBloqueante {
    z-index: 10000 !important;
}

/* --- SETAS EXTERNAS DA ROLETA --- */
.roleta-wrapper-externo {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 10px 0; /* Espaçamento geral */
}

.seta-externa {
    width: 0; 
    height: 0; 
    border-left: 10px solid transparent; /* Largura da base da seta */
    border-right: 10px solid transparent;
    z-index: 15; /* Garante que fique acima de sombras */
}

.seta-externa.topo {
    /* Seta de Cima: Aponta para BAIXO */
    border-top: 15px solid var(--cor-destaque); 
    margin-bottom: 2px; /* Cola na roleta */
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

.seta-externa.baixo {
    /* Seta de Baixo: Aponta para CIMA */
    border-bottom: 15px solid var(--cor-destaque);
    margin-top: 2px; /* Cola na roleta */
    filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.5));
}

/* Garante que o Modal de Confirmação e o Bloqueante fiquem ACIMA de tudo */
#modalConfirmacaoGenerica, 
#modalBloqueante,
#modalPopupGenerico {
    z-index: 10000 !important; /* Maior que o modal de agendamento (9999) */
}

/* Garante que o fundo escuro desses modais também fique acima */
#modalConfirmacaoGenerica.show,
#modalBloqueante.show {
    background: rgba(0,0,0,0.95); /* Fundo bem escuro para focar */
}

/* ============================================================ */
/* === MOLDURAS PREMIUM (CORRIGIDO: ASAS NO CHAT) === */
/* ============================================================ */

/* --- ESTRUTURA BASE --- */
.avatar-wrapper {
    position: relative;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    z-index: 1;
    vertical-align: middle;
    overflow: visible !important; /* Permite asas para fora */
}

/* Foto do Usuário (Chat e Geral) */
.chat-user-photo {
    position: relative;
    z-index: 20; /* Foto acima das asas */
    object-fit: cover;
    background: #000;
    display: block;
    box-sizing: border-box;
}

/* Foto do Usuário (Popup Grande) - Z-Index Alto */
.perfil-foto-grande {
    position: relative;
    z-index: 25 !important; /* Foto acima da asa no popup */
    object-fit: cover;
    background: #000;
    display: block;
}

/* Coroa (Comum a todas) */
.coroa-topo {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 30; /* Coroa acima de tudo */
    background: transparent;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8));
    pointer-events: none;
}
.coroa-topo::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; width: 100%; height: 100%;
    clip-path: polygon(5% 100%, 0% 30%, 25% 50%, 50% 0%, 75% 50%, 100% 30%, 95% 100%);
}

/* 2. TAMANHO POPUP (Grande - 120px) */
.avatar-wrapper.popup-size {
    width: 120px; height: 120px;
    margin: 15px auto 20px auto; 
}
.avatar-wrapper.popup-size .perfil-foto-grande {
    width: 100%; height: 100%;
    border-radius: 50%; padding: 3px;
}
.avatar-wrapper.popup-size .coroa-topo {
    width: 40px; height: 26px; top: -30px;
}

/* 3. TAMANHO LOJA (Médio - 60px) */
.avatar-wrapper.shop-size {
    width: 60px; height: 60px;
}
.avatar-wrapper.shop-size div[class*="avatar-frame"] { 
    z-index: 20; position: relative; 
}
.avatar-wrapper.shop-size .coroa-topo {
    width: 20px; height: 14px; top: -16px;
}

/* --- ESTILOS DOS NÍVEIS --- */

/* NÍVEL 1: BRONZE */
.avatar-wrapper.bronze .chat-user-photo,
.avatar-wrapper.bronze .perfil-foto-grande,
.avatar-wrapper.bronze .avatar-frame-bronze {
    background: linear-gradient(45deg, #804a00, #cd7f32);
    box-shadow: 0 0 0 2px #804a00; 
}
.avatar-wrapper.bronze .coroa-topo::after { background: linear-gradient(to bottom, #ffcc80, #cd7f32); }

/* NÍVEL 2: PRATA */
.avatar-wrapper.prata .chat-user-photo,
.avatar-wrapper.prata .perfil-foto-grande,
.avatar-wrapper.prata .avatar-frame-prata {
    background: linear-gradient(135deg, #fff, #c0c0c0, #777);
    box-shadow: 0 0 0 2px #777;
    animation: brilhoMetalico 3s infinite;
}
.avatar-wrapper.prata .coroa-topo::after { background: linear-gradient(to bottom, #fff, #999); }

/* NÍVEL 3: OURO */
.avatar-wrapper.ouro .chat-user-photo,
.avatar-wrapper.ouro .perfil-foto-grande,
.avatar-wrapper.ouro .avatar-frame-ouro {
    background: linear-gradient(45deg, #bf953f, #fcf6ba, #aa771c);
    box-shadow: 0 0 0 2px #aa771c, 0 0 10px rgba(255, 215, 0, 0.6);
    animation: brilhoDourado 2s infinite alternate;
}
.avatar-wrapper.ouro .coroa-topo::after { background: linear-gradient(to bottom, #fff7cc, #ffd700, #b8860b); }

/* --- NÍVEL 4: DIAMANTE (ASAS REVISADAS) --- */

.avatar-wrapper.diamante .chat-user-photo, 
.avatar-wrapper.diamante .perfil-foto-grande,
.avatar-wrapper.diamante .avatar-frame-diamante {
    background: transparent; 
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 15px rgba(0, 198, 255, 0.9), inset 0 0 10px rgba(0, 198, 255, 0.5); 
}

.avatar-wrapper.diamante .coroa-topo::after {
    background: linear-gradient(to bottom, #e0ffff, #00c6ff);
}

/* ASAS (Cristal Afiado) */
.avatar-wrapper.diamante::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0; /* Atrás da foto */
    
    background: linear-gradient(90deg, rgba(0,198,255,0) 0%, rgba(0,198,255,0.8) 20%, rgba(0,198,255,1) 50%, rgba(0,198,255,0.8) 80%, rgba(0,198,255,0) 100%);
    
    clip-path: polygon(
        0% 10%, 20% 30%, 5% 50%, 35% 55%, 
        50% 50%, 
        65% 55%, 95% 50%, 80% 30%, 100% 10%, 
        60% 40%, 50% 20%, 40% 40%
    );
    
    animation: asa-cristal-flutuar 3s ease-in-out infinite;
}

/* AJUSTE: Asa no CHAT (Agora visível e proporcional) */
.avatar-wrapper.chat-size.diamante::before {
    display: block;
    width: 54px;  /* Mais largo que os 32px da foto */
    height: 22px;
    top: 50%;
    opacity: 1;
    /* Ajuste fino para centralizar perfeitamente atrás da bolinha */
    transform: translate(-50%, -50%); 
}

/* AJUSTE: Asa no POPUP (Distante do centro) */
.avatar-wrapper.popup-size.diamante::before {
    width: 280px; height: 120px;
    top: 50%;
    transform: translate(-50%, -60%);
    filter: drop-shadow(0 0 10px #00c6ff);
}

/* AJUSTE: Asa na LOJA (Visível) */
.avatar-wrapper.shop-size.diamante::before {
    width: 130px; height: 50px;
    top: 50%;
    transform: translate(-50%, -50%);
    opacity: 1;
}

@keyframes asa-cristal-flutuar {
    0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
}

@keyframes pulse-wings {
    0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
}

/* --- CORREÇÃO: Container de Scroll das Molduras (Estilo Caixa/Roleta) --- */
.molduras-scroll-container {
    display: flex;
    overflow-x: auto; /* Permite rolar para o lado */
    overflow-y: hidden;
    gap: 15px;
    padding: 15px;
    background: #1a1a1a; /* Fundo da caixa */
    border: 1px solid var(--cor-borda);
    border-radius: 12px;
    margin-top: 10px;
    white-space: nowrap; /* Garante que fiquem em linha */
    box-shadow: inset 0 0 10px #000; /* Sombra interna para profundidade */
    align-items: center; /* Centraliza verticalmente */
}

/* Barra de rolagem mais bonita para o carrossel */
.molduras-scroll-container::-webkit-scrollbar {
    height: 6px;
}
.molduras-scroll-container::-webkit-scrollbar-thumb {
    background: var(--cor-destaque);
    border-radius: 3px;
}
.molduras-scroll-container::-webkit-scrollbar-track {
    background: #333;
}

/* --- CORREÇÃO: Wrapper da Moldura no CHAT (Pequeno e Alinhado) --- */
.avatar-wrapper.chat-size {
    width: 32px; 
    height: 32px;
    margin-right: 15px; /* Aumentei a margem para a asa não bater no nome */
    margin-left: 8px;   /* Espaço na esquerda para a asa */
    vertical-align: middle; 
    display: inline-flex; 
    position: relative;
    justify-content: center;
    align-items: center;
    overflow: visible !important; /* IMPORTANTE: Permite que a asa saia da caixinha */
}

.avatar-wrapper.chat-size .chat-user-photo {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50%;
    padding: 1px;
    margin: 0;
    display: block;
    position: relative;
    z-index: 10; /* Foto acima da asa */
}

.avatar-wrapper.chat-size .coroa-topo {
    width: 16px; 
    height: 10px; 
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 15; /* Coroa acima da foto */
}

/* Garante que as asas (::before) apareçam */
.avatar-wrapper.chat-size::before {
    display: block !important;
    z-index: 0; /* Asa atrás da foto */
}

/* Removemos aura giratória pesada no chat pequeno para não poluir,
   mas mantemos o brilho da borda definido nas classes .ouro, .diamante etc */
.avatar-wrapper.chat-size::after, 
.avatar-wrapper.chat-size::before {
    display: none; 
}

/* --- CORREÇÃO: Wrapper da Moldura no POPUP (Grande) --- */
.avatar-wrapper.popup-size {
    width: 120px;
    height: 120px;
    margin: 0 auto 15px auto;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

.avatar-wrapper.popup-size .perfil-foto-grande {
    width: 100%;
    height: 100%;
    padding: 3px;
    border-radius: 50%;
    display: block;
}

.avatar-wrapper.popup-size .coroa-topo {
    width: 50px;
    height: 30px;
    top: -35px;
    left: 50%;
    transform: translateX(-50%);
}

/* --- MOLDURAS ADMIN (BASEADA NA DIAMANTE) --- */

/* 1. SUPREME BLACK (PRETA) */
.avatar-wrapper.admin_black .chat-user-photo, 
.avatar-wrapper.admin_black .perfil-foto-grande,
.avatar-wrapper.admin_black .avatar-frame-admin-black {
    background: transparent; 
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.9), inset 0 0 10px rgba(50, 50, 50, 0.8); 
}
.avatar-wrapper.admin_black .coroa-topo::after {
    background: linear-gradient(to bottom, #444, #000); /* Coroa Preta */
}
/* Asas Pretas/Sombrias */
.avatar-wrapper.admin_black::before {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0;
    background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.9) 20%, rgba(20,20,20,1) 50%, rgba(0,0,0,0.9) 80%, rgba(0,0,0,0) 100%);
    clip-path: polygon(0% 10%, 20% 30%, 5% 50%, 35% 55%, 50% 50%, 65% 55%, 95% 50%, 80% 30%, 100% 10%, 60% 40%, 50% 20%, 40% 40%);
    animation: asa-sombria-flutuar 3s ease-in-out infinite;
}

/* 2. SUPREME RED (VERMELHA) */
.avatar-wrapper.admin_red .chat-user-photo, 
.avatar-wrapper.admin_red .perfil-foto-grande,
.avatar-wrapper.admin_red .avatar-frame-admin-red {
    background: transparent; 
    border: 1px solid rgba(255, 0, 0, 0.3);
    box-shadow: 0 0 15px rgba(231, 76, 60, 0.9), inset 0 0 10px rgba(192, 57, 43, 0.5); 
}
.avatar-wrapper.admin_red .coroa-topo::after {
    background: linear-gradient(to bottom, #ff6b6b, #c0392b); /* Coroa Vermelha */
}
/* Asas de Fogo */
.avatar-wrapper.admin_red::before {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0;
    background: linear-gradient(90deg, rgba(231,76,60,0) 0%, rgba(231,76,60,0.8) 20%, rgba(192,57,43,1) 50%, rgba(231,76,60,0.8) 80%, rgba(231,76,60,0) 100%);
    clip-path: polygon(0% 10%, 20% 30%, 5% 50%, 35% 55%, 50% 50%, 65% 55%, 95% 50%, 80% 30%, 100% 10%, 60% 40%, 50% 20%, 40% 40%);
    animation: asa-fogo-flutuar 3s ease-in-out infinite;
}

/* Animações Específicas e Ajustes de Tamanho */
@keyframes asa-sombria-flutuar {
    0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 5px black); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); filter: drop-shadow(0 0 15px black); }
}
@keyframes asa-fogo-flutuar {
    0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 5px red); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); filter: drop-shadow(0 0 15px red); }
}

/* Ajustes de Tamanho para as Asas Admin (Igual Diamante) */
.avatar-wrapper.chat-size.admin_black::before, .avatar-wrapper.chat-size.admin_red::before {
    display: block; width: 54px; height: 22px; top: 50%; opacity: 1; transform: translate(-50%, -50%);
}
.avatar-wrapper.popup-size.admin_black::before, .avatar-wrapper.popup-size.admin_red::before {
    width: 280px; height: 120px; top: 50%; transform: translate(-50%, -60%);
}
.avatar-wrapper.shop-size.admin_black::before, .avatar-wrapper.shop-size.admin_red::before {
    width: 130px; height: 50px; top: 50%; transform: translate(-50%, -50%); opacity: 1;
}

/* Correção para listas horizontais no perfil */
.molduras-scroll-container {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding: 15px;
    background: #111;
    border: 1px solid var(--cor-borda);
    border-radius: 12px;
    margin-top: 10px;
    min-height: 130px; /* Altura mínima garantida */
    align-items: center;
}

/* --- CORREÇÃO ROLETA (CSS) --- */
.roleta-container {
    background: #0a0a0a;
    border: 4px solid #d4af37;
    border-radius: 15px;
    height: 100px; 
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    width: 320px; /* Largura fixa para garantir a matemática */
    box-shadow: inset 0 0 30px rgba(0,0,0,1);
}

.roleta-faixa {
    display: flex;
    height: 100%;
    align-items: center;
    will-change: transform;
    /* A transição será injetada via JS */
}

/* O item tem 90px TOTAL (80 largura + 5 margem esq + 5 margem dir) */
.roleta-item {
    width: 80px; 
    height: 80px;
    margin: 0 5px; 
    flex-shrink: 0; /* ISSO É CRUCIAL: Impede que o item esmague */
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; 
    font-weight: 900;
    background: #1a1a1a;
    color: #fff;
    border: 1px solid #333;
    box-sizing: border-box;
    position: relative;
    overflow: hidden; /* Para conter os efeitos internos */
}

/* Estilos Específicos dos Itens da Roleta */
.roleta-item.ponto { color: #eee; }
.roleta-item.premio-top { background: #111; border: 1px solid gold; }
.roleta-item.caixa { background: #c0392b; border: 2px solid #e74c3c; animation: pulse-red 1s infinite; }

/* --- PREVIEWS REAIS DENTRO DA ROLETA --- */
.mini-moldura-preview {
    width: 50px; height: 50px; 
    border-radius: 50%; 
    background: url('https://placehold.co/50/000000/FFFFFF/?text=VC') center/cover;
    position: relative;
}
.mini-balao-preview {
    width: 60px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px;
    border-radius: 8px;
}

/* ============================================================
   ESTILOS COMPLETOS DOS BALÕES DE CHAT (FINAL)
   ============================================================ */

/* --- BASE PARA TODOS OS BALÕES CUSTOMIZADOS --- */
.chat-message.custom-bubble {
    position: relative;
    border: 1px solid transparent;
    transition: all 0.3s;
    /* 'isolation' cria um novo contexto de empilhamento.
       Isso impede que os efeitos de fundo (z-index -1) fiquem atrás do container do chat */
    isolation: isolate; 
    z-index: 1;
    /* Sombra preta forte para garantir que a letra branca apareça em qualquer fundo */
    text-shadow: 1px 1px 2px #000000, 0 0 5px #000000;
    font-weight: 600;
}

/* ============================================================
   NÍVEL 1: BRONZE (Sólido, Simples)
   ============================================================ */
.chat-message.bubble-bronze {
    border: 1px solid #cd7f32;
    background: linear-gradient(145deg, #5c3a1e, #2a1a0a);
    box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    color: #ffdcb0 !important;
}
/* Garante limpeza */
.chat-message.bubble-bronze::before, 
.chat-message.bubble-bronze::after { display: none !important; }


/* ============================================================
   NÍVEL 2: PRATA (Metálico Fosco - SEM ANIMAÇÃO DE MOVIMENTO)
   Correção: Fundo aplicado direto no elemento para não bugar.
   ============================================================ */
.chat-message.bubble-prata {
    border: 1px solid #a0a0a0;
    /* Gradiente cinza metálico chumbo */
    background: linear-gradient(145deg, #7f7f7f, #2a2a2a);
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    color: #ffffff !important; /* Texto Branco Puro */
}
.chat-message.bubble-prata::before, 
.chat-message.bubble-prata::after { display: none !important; }


/* ============================================================
   NÍVEL 3: OURO (Valioso - COM BRILHO NO FUNDO)
   Correção: Animação direta no background-position.
   ============================================================ */
.chat-message.bubble-ouro {
    border: 1px solid #FFD700;
    /* Gradiente dourado com uma faixa clara no meio */
    background: linear-gradient(110deg, #4b3b00 20%, #b88a00 40%, #fff8db 50%, #b88a00 60%, #4b3b00 80%);
    background-size: 200% 100%; /* Tamanho dobrado para permitir o movimento */
    color: #fff !important;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    animation: shine-gold 4s linear infinite; /* Brilho passando */
}
.chat-message.bubble-ouro::before, 
.chat-message.bubble-ouro::after { display: none !important; }


/* ============================================================
   NÍVEL 4: DIAMANTE (Movimento LENTO - 15s)
   ============================================================ */
.chat-message.bubble-diamante {
    background: #000 !important; /* Fundo PRETO sólido atrás do texto */
    color: #e0ffff !important; 
    border: none; 
    overflow: visible !important; /* Permite a coroa sair pra fora */
    margin-top: 12px !important; /* Espaço para a coroa */
}
/* Borda Animada (Fica atrás do fundo preto graças ao z-index -1 e isolation) */
.chat-message.bubble-diamante::before {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 14px; 
    z-index: -1; 
    background: linear-gradient(60deg, #00c6ff, #0072ff, #000, #000, #00c6ff);
    background-size: 300% 300%;
    animation: border-travel 15s linear infinite; /* LENTO */
    opacity: 0.8;
}
/* Coroa */
.chat-message.bubble-diamante::after {
    content: '👑'; position: absolute; top: -14px; right: -5px; font-size: 14px;
    animation: float-crown 4s ease-in-out infinite;
}


/* ============================================================
   ADMIN BLACK (Movimento LENTO - 15s)
   ============================================================ */
.chat-message.bubble-admin-black {
    background: #000 !important;
    color: #ffffff !important; 
    border: none;
    overflow: visible !important;
    margin-top: 12px !important;
}
.chat-message.bubble-admin-black::before {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 14px; z-index: -1;
    /* Gradiente Preto/Branco viajando */
    background: linear-gradient(60deg, #ffffff, #333, #000, #000, #ffffff);
    background-size: 300% 300%;
    animation: border-travel 15s linear infinite; /* LENTO */
}
.chat-message.bubble-admin-black::after {
    content: '👑'; position: absolute; top: -14px; right: -5px; font-size: 14px;
    filter: grayscale(100%); /* Coroa Cinza */
    animation: float-crown 4s ease-in-out infinite;
}


/* ============================================================
   ADMIN RED (Movimento LENTO - 12s)
   ============================================================ */
.chat-message.bubble-admin-red {
    background: #1a0000 !important; 
    color: #ffe0e0 !important; 
    border: none;
    overflow: visible !important;
    margin-top: 12px !important;
}
.chat-message.bubble-admin-red::before {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 14px; z-index: -1;
    /* Gradiente Vermelho Fogo viajando */
    background: linear-gradient(60deg, #ff0000, #ff4500, #2c0000, #2c0000, #ff0000);
    background-size: 300% 300%;
    animation: border-travel 12s linear infinite; /* LENTO */
}
.chat-message.bubble-admin-red::after {
    content: '👑'; position: absolute; top: -14px; right: -5px; font-size: 14px;
    filter: sepia(100%) saturate(1000%) hue-rotate(-50deg); /* Coroa Vermelha */
    animation: float-crown 4s ease-in-out infinite;
}


/* ============================================================
   ANIMAÇÕES GERAIS
   ============================================================ */
@keyframes border-travel {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes float-crown {
    0%, 100% { transform: translateY(0) rotate(5deg); }
    50% { transform: translateY(-3px) rotate(-5deg); }
}
@keyframes shine-gold {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* ============================================================
   FIX: DESTAQUE DA ASA PRETA NO POPUP (CONTRASTE)
   ============================================================ */

/* 1. Cria uma "luz" radial atrás do avatar para separar do fundo preto */
.avatar-wrapper.popup-size.admin_black {
    /* Brilho difuso branco atrás do conjunto todo */
    box-shadow: 0 0 50px 15px rgba(255, 255, 255, 0.25);
    /* Fundo radial sutil para dar profundidade */
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
    border-radius: 50%;
}

/* 2. Reforça o contorno branco na própria asa para definição máxima */
.avatar-wrapper.popup-size.admin_black::before {
    /* Drop-shadow branco intenso e nítido ao redor da asa preta */
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 1)) drop-shadow(0 0 15px rgba(255, 255, 255, 0.5)) !important;
}

/* Estilo Novo do Ranking */
.ranking-novo-item {
    display: flex;
    align-items: center;
    background: linear-gradient(90deg, var(--cor-botoes), transparent);
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 12px;
    border: 1px solid var(--cor-borda);
    transition: transform 0.2s;
}
.ranking-novo-item:hover {
    transform: scale(1.02);
    border-color: var(--cor-destaque);
}
.ranking-posicao {
    font-size: 18px;
    font-weight: 900;
    width: 30px;
    text-align: center;
    margin-right: 10px;
    color: #fff;
}
/* Cores para o Top 3 */
.ranking-novo-item:nth-child(1) .ranking-posicao { color: #ffd700; text-shadow: 0 0 5px gold; font-size: 24px; }
.ranking-novo-item:nth-child(2) .ranking-posicao { color: #c0c0c0; font-size: 22px; }
.ranking-novo-item:nth-child(3) .ranking-posicao { color: #cd7f32; font-size: 20px; }

.ranking-foto {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #444;
    margin-right: 10px;
}
.ranking-info {
    flex-grow: 1;
}
.ranking-nome {
    font-weight: 600;
    font-size: 14px;
    display: block;
}
.ranking-conquistas {
    font-size: 12px;
    margin-top: 2px;
}
.ranking-score {
    font-weight: bold;
    color: var(--cor-destaque);
    font-size: 16px;
    background: rgba(0,0,0,0.3);
    padding: 5px 10px;
    border-radius: 20px;
}

/* --- ALTERAÇÃO 4: BRILHO PARA MOLDURAS SUPREME BLACK (Para ver no fundo escuro) --- */
.avatar-wrapper.admin_black .coroa-topo {
    filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));
}
/* Adiciona contorno branco suave na asa preta */
.avatar-wrapper.admin_black::before {
    filter: drop-shadow(0 0 1px rgba(255, 255, 255, 0.5)) drop-shadow(0 0 5px rgba(0, 0, 0, 1)) !important;
}

/* --- ALTERAÇÃO 2: TAMANHO DO AVATAR NO RANKING --- */
.avatar-wrapper.ranking-size {
    width: 45px; height: 45px;
    margin-right: 10px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0; /* Não deixa esmagar */
}
.avatar-wrapper.ranking-size .ranking-foto {
    width: 100%; height: 100%;
    border-radius: 50%;
    padding: 1px;
    z-index: 10;
    position: relative;
}
.avatar-wrapper.ranking-size .coroa-topo {
    width: 20px; height: 12px;
    top: -12px; /* Posição da coroa no ranking */
    position: absolute;
    z-index: 15;
    left: 50%; transform: translateX(-50%);
}
/* Asas no Ranking (Tamanho ajustado) */
.avatar-wrapper.ranking-size::before {
    width: 80px; height: 30px; 
    top: 50%; left: 50%; 
    transform: translate(-50%, -50%);
    z-index: 0;
    opacity: 1;
    display: block;
}

/* --- CORREÇÃO VISUAL: ASAS NO CHAT --- */
/* Garante que a asa (::before) apareça na lista de mensagens */
.chat-message .avatar-wrapper.chat-size::before {
    content: '';
    display: block !important;
    position: absolute;
    z-index: 0; /* Atrás da foto */
    /* Força tamanho visível no chat pequeno */
    width: 54px !important;
    height: 22px !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
}

/* --- CORREÇÃO VISUAL: BRILHO NA ASA E COROA PRETA --- */
/* Cria um contorno branco brilhante em volta da asa preta para contraste */
.avatar-wrapper.admin_black::before {
    filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 5px rgba(255, 255, 255, 0.4)) !important;
}
/* Brilho na coroa preta */
.avatar-wrapper.admin_black .coroa-topo {
    filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.9)) !important;
}

/* --- CORREÇÃO VISUAL: RANKING CENTRALIZADO --- */
.avatar-wrapper.ranking-size {
    width: 50px; 
    height: 50px;
    margin-right: 10px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}
.avatar-wrapper.ranking-size .ranking-foto {
    width: 100% !important; 
    height: 100% !important;
    border-radius: 50%;
    z-index: 10;
    position: relative;
}
/* Centraliza a coroa no ranking */
.avatar-wrapper.ranking-size .coroa-topo {
    width: 20px; height: 12px;
    top: -14px; 
    left: 50%;
    transform: translateX(-50%);
    position: absolute;
    z-index: 15;
}
/* Centraliza a asa no ranking */
.avatar-wrapper.ranking-size::before {
    width: 90px; height: 35px; 
    top: 50%; left: 50%; 
    transform: translate(-50%, -50%);
    z-index: 0;
    display: block;
    opacity: 1;
}

/* --- CORREÇÃO DEFINITIVA DO MAPA E CAMADAS --- */

/* 1. Modal Ocupando a Tela e Fundo Preto */
#modalRastreamento .modal-content {
    display: block !important; /* Block para permitir absolute dentro */
    height: 90vh !important;
    width: 95% !important;
    max-width: 600px !important;
    background-color: #000 !important;
    padding: 0 !important;
    overflow: hidden !important;
    position: relative !important; /* Essencial para o mapa absoluto */
    border: 2px solid var(--cor-destaque);
}

/* 2. Mapa em Posição Absoluta (Força preenchimento) */
#mapaRastreamento {
    position: absolute !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100% !important;
    height: 100% !important;
    background-color: #1a1a1a; /* Cinza escuro de fundo */
    z-index: 1;
}

/* 3. Z-Index Corrigido: Mapa atrás, Popup na frente */
#modalRastreamento {
    z-index: 20000 !important; /* Mapa */
}

/* Popup de Aviso (Cliente Notificado) deve ser maior que o Mapa */
#modalPopupGenerico {
    z-index: 21000 !important; 
}

/* Esconde o painel branco de texto da rota */
.leaflet-routing-container {
    display: none !important;
}

/* --- CORREÇÃO FINAL: VISUAL CHAT E PERFIL --- */

/* 1. Wrapper no Chat (Pequeno) */
.avatar-wrapper.chat-size {
    width: 32px !important;
    height: 32px !important;
    margin-right: 8px;
    position: relative;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    vertical-align: middle;
    overflow: visible !important; /* Permite que a asa saia pra fora */
}

/* Foto no Chat */
.avatar-wrapper.chat-size .chat-user-photo {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50%;
    position: relative;
    z-index: 10; /* Foto na frente */
    margin: 0 !important;
    border: 1px solid rgba(255,255,255,0.2);
}

/* Coroa no Chat */
.avatar-wrapper.chat-size .coroa-topo {
    width: 16px !important;
    height: 10px !important;
    top: -10px !important;
    left: 50%;
    transform: translateX(-50%);
    position: absolute;
    z-index: 15;
}

/* Asas no Chat (Ajuste Fino) */
.avatar-wrapper.chat-size::before {
    content: '';
    display: block !important;
    position: absolute;
    width: 60px !important; /* Asa larga */
    height: 24px !important;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0; /* Atrás da foto */
    pointer-events: none;
}

/* 2. Wrapper no Popup de Perfil (Grande) */
.avatar-wrapper.popup-size {
    width: 120px; height: 120px;
    margin: 20px auto;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible !important;
}
.avatar-wrapper.popup-size .perfil-foto-grande {
    width: 100%; height: 100%;
    border-radius: 50%;
    position: relative;
    z-index: 10;
    border: 3px solid rgba(255,255,255,0.1);
}
.avatar-wrapper.popup-size .coroa-topo {
    width: 50px; height: 30px;
    top: -35px;
    position: absolute;
    z-index: 15;
}
.avatar-wrapper.popup-size::before {
    width: 280px; height: 120px; /* Asa bem grande no popup */
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0;
}

/* --- 3. CORREÇÃO ESPECÍFICA: BRILHO NA ASA E COROA PRETA --- */

/* Brilho Branco ao redor da Asa Preta (Chat e Popup) */
.avatar-wrapper.admin_black::before {
    /* Sombra branca sólida (outline) + Sombra difusa */
    filter: drop-shadow(0 0 1px rgba(255, 255, 255, 0.9)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.6)) !important;
    opacity: 1 !important;
}

/* Brilho Branco na Coroa Preta */
.avatar-wrapper.admin_black .coroa-topo {
    filter: drop-shadow(0 0 2px rgba(255, 255, 255, 1)) !important;
}

/* Borda brilhante na foto preta */
.avatar-wrapper.admin_black .chat-user-photo,
.avatar-wrapper.admin_black .perfil-foto-grande {
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
}

/* --- ESTILOS DO NOVO POPUP DE PERFIL COMPLETO --- */
.perfil-section-title {
    font-size: 12px;
    color: #888;
    text-transform: uppercase;
    margin: 15px 0 5px 0;
    text-align: left;
    border-bottom: 1px solid #333;
    padding-bottom: 2px;
}

.inventory-scroll-container {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 5px 0;
    /* Esconde barra de rolagem mas permite scroll */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
.inventory-scroll-container::-webkit-scrollbar {
    display: none;
}

.inventory-item-small {
    flex: 0 0 auto;
    width: 50px;
    height: 50px;
    background: #222;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #444;
    position: relative;
}

.inventory-item-small.equipped {
    border-color: var(--cor-destaque);
    box-shadow: 0 0 5px var(--cor-destaque);
}

/* Preview pequeno de moldura */
.mini-frame-preview {
    width: 40px; height: 40px;
    border-radius: 50%;
    background-color: #000;
}

/* Preview pequeno de balão */
.mini-bubble-preview {
    width: 40px; height: 30px;
    font-size: 8px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 5px;
}

.member-since {
    font-size: 11px;
    color: #aaa;
    margin-top: -5px;
    margin-bottom: 10px;
    display: block;
}

/* Estilo para o Toast de aviso de saída */
.toast-notification {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 50px;
    padding: 16px;
    position: fixed;
    z-index: 10000; /* Acima de tudo */
    left: 50%;
    bottom: 80px; /* Um pouco mais alto para não cobrir botões */
    transform: translateX(-50%);
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    opacity: 0;
    transition: opacity 0.3s, bottom 0.3s;
    border: 1px solid var(--cor-destaque); /* Destaque na borda */
}

.toast-notification.show {
    visibility: visible;
    opacity: 1;
    bottom: 100px; /* Leve animação para cima */
}

#mapaGeral {
        height: 100%;
        width: 100%;
        background: #242f3e; /* Fundo base se o mapa demorar */
        border-radius: 15px;
    }
    /* Filtro para deixar o mapa com aspecto "Noturno/Dark" */
    .leaflet-layer {
        filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
    }
    /* Estilo dos Marcadores (Bolinhas com Foto) */
    .custom-map-marker {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .marker-foto {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        border: 3px solid var(--cor-destaque);
        box-shadow: 0 0 15px var(--cor-destaque);
        animation: pulse-map 2s infinite;
    }
    .marker-foto.usuario-atual {
        border-color: #00c6ff; /* Azul para o usuário logado */
        box-shadow: 0 0 15px #00c6ff;
        z-index: 9999; /* Fica por cima */
    }
    @keyframes pulse-map {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    /* Popup do Mapa Escuro */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
        background: #1a1a1a;
        color: white;
        border: 1px solid var(--cor-destaque);
    }

  
/* --- ESTILOS NOVOS (FACHADA E GRÁFICOS) --- */

/* Classe aplicada ao Modal de Perfil quando tem fachada */
.fachada-bg {
    position: relative;
    background-color: var(--cor-card); /* Fallback */
    overflow: hidden;
}

/* Pseudo-elemento para a imagem de fundo com opacidade */
.fachada-bg::before {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    opacity: 0.15; /* Opacidade agradável (15%) */
    z-index: 0; /* Fica atrás do conteúdo */
    pointer-events: none;
}

/* Garante que o conteúdo do modal fique na frente da imagem */
.modal-content > * {
    position: relative;
    z-index: 1;
}

/* Container do Gráfico */
.chart-container {
    position: relative;
    height: 250px;
    width: 100%;
    margin-top: 20px;
}

/* --- CORREÇÃO MAPA RASTREAMENTO --- */
#modalRastreamento .modal-content {
    background-color: #000 !important; /* Garante fundo preto */
    display: flex;
    flex-direction: column;
}

/* Esconde painel de texto de direção (Vire a direita...) */

/* Estilo da Linha da Rota (Neon) */
.leaflet-routing-alt line {
    stroke: #00c6ff !important; /* Azul Neon */
    stroke-width: 6 !important;
    stroke-opacity: 0.8 !important;
}

/* Animação do Ícone */
.custom-map-marker {
    transition: all 0.5s ease;
}

/* Esconde o painel branco de instruções de rota */

/* --- CORREÇÃO VISUAL DO RASTREAMENTO --- */
#modalRastreamento .modal-content {
    background-color: #000 !important;
    display: flex;
    flex-direction: column;
}

/* Esconde o painel de texto da rota que polui a tela */
/* Estilo dos Marcadores com FOTO (Igual ao Mapa Geral) */
.marker-foto-rastreio {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 3px solid #00c6ff; /* Azul Neon */
    box-shadow: 0 0 15px #00c6ff;
    animation: pulse-map 2s infinite;
}
.marker-foto-rastreio.destino {
    border-color: #d4af37; /* Dourado para o destino */
    box-shadow: 0 0 15px #d4af37;
}

/* --- CORREÇÃO FORÇADA DO MAPA --- */
#modalRastreamento .modal-content {
    height: 90vh !important; /* Altura fixa de 90% da tela */
    display: flex !important;
    flex-direction: column !important;
    padding: 0 !important;
    background-color: #1a1a1a !important;
    overflow: hidden !important; /* Evita barras de rolagem extras */
}

/* Esconde painéis chatos do plugin */
.leaflet-routing-container, 
.leaflet-bottom.leaflet-right {
    display: none !important;
}

/* ========================================================================== */
/* === NOVO CSS: OBSIDIAN LUXURY THEME & CINEMATIC EFFECTS (HOLLYWOOD) === */
/* ========================================================================== */

:root {
    /* Paleta Obsidiana e Ouro (Luxo Moderno) */
    --cor-fundo: #050505; /* Preto Obsidiana Profundo */
    --cor-card: #0f0f0f; /* Cinza Carvão muito escuro */
    --cor-botoes: #1a1a1a; /* Botões discretos */
    --cor-texto-principal: #f0f0f0;
    
    /* Cores de Destaque Atualizadas */
    --cor-destaque-ouro: #d4af37; /* Mantido o Dourado Clássico */
    --cor-destaque-salmao: #FF8C69; /* Salmão Vibrante (Substitui Rosa) */
    --cor-destaque-prata: #e0e0e0;
    --cor-destaque-azul: #007BFF;
    
    --cor-borda: #333333;
    --cor-sombra: rgba(0, 0, 0, 0.9);
    
    /* Gradientes Futuristas */
    --gradiente-obsidiana: linear-gradient(145deg, #1a1a1a, #050505);
    --gradiente-ouro: linear-gradient(45deg, #d4af37, #f1c40f, #ffd700);
    --gradiente-salmao: linear-gradient(45deg, #FF8C69, #ff6b6b);
}

/* Background Geral Futurista */
body {
    background-color: var(--cor-fundo) !important;
    background-image: 
        radial-gradient(circle at 50% 0%, #1a1a1a 0%, transparent 70%),
        url('/icone.png') !important; /* Mantém sua imagem de fundo */
    background-blend-mode: screen, multiply;
}

/* Cards com Efeito de Vidro Negro (Obsidian Glass) */
.card {
    background: rgba(15, 15, 15, 0.85) !important;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8) !important;
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s !important;
}
.card:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 15px 40px rgba(0,0,0,1) !important;
    border-color: var(--cor-destaque) !important;
}

/* Botões Modernos e Robustos */
button {
    background: var(--gradiente-obsidiana) !important;
    border: 1px solid rgba(212, 175, 55, 0.3) !important; /* Borda dourada sutil */
    color: var(--cor-destaque-ouro) !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 13px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;
    transition: all 0.3s ease !important;
}
button:hover {
    background: var(--cor-destaque-ouro) !important;
    color: #000 !important;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.6) !important;
}

/* Ajuste específico para tema feminino (Salmão) */
body.tema-feminino {
    --cor-destaque: var(--cor-destaque-salmao);
}
body.tema-feminino button:hover {
    background: var(--cor-destaque-salmao) !important;
    box-shadow: 0 0 20px rgba(255, 140, 105, 0.6) !important;
}

@keyframes particleMove {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
}

@keyframes shineText { 0% { background-position: 200%; } 100% { background-position: 0%; } }

/* Checklist Terminal */
#splashChecklist {
    margin-top: 30px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #00ff00;
    text-align: left;
    width: 280px;
}
.check-item { opacity: 0; margin-bottom: 5px; }
.check-item.visible { opacity: 1; }
.check-item span { color: #fff; }
.check-item .status { color: #ffff00; margin-left: 5px; } /* Amarelo aguarde */
.check-item .status.success { color: #00ff00; text-shadow: 0 0 5px #00ff00; } /* Verde neon */

/* --- NOVOS ELEMENTOS DE PROPRIETÁRIO / FACHADA --- */
.fachada-container {
    position: relative;
    width: 100%;
    height: 180px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    border: 2px solid var(--cor-destaque);
}
.fachada-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.fachada-overlay {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 10px;
    color: #fff;
    text-align: center;
}

/* Filtros de Profissão (Cabelo, Unha, Olho) */
.niche-filters {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
    padding: 10px;
    background: var(--cor-card);
    border-radius: 12px;
    border: 1px solid var(--cor-borda);
}
.niche-filter-btn {
    font-size: 24px !important;
    background: transparent !important;
    border: 2px solid transparent !important;
    box-shadow: none !important;
    opacity: 0.5;
    transition: all 0.3s;
    padding: 5px !important;
    min-width: auto !important;
}
.niche-filter-btn.active {
    opacity: 1;
    transform: scale(1.2);
    border-color: var(--cor-destaque) !important;
    box-shadow: 0 0 15px var(--cor-destaque) !important;
    border-radius: 50% !important;
}

/* Efeito de Glitch (Correção Visual) */
.modal {
    transform: translateZ(0); /* Aceleração de hardware para evitar flicker */
    backface-visibility: hidden;
}

/* Estilo para imagem da fachada no fundo do modal de agendamento */
.fachada-bg::before {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    opacity: 0.25; /* Mais visível */
    filter: blur(2px);
    z-index: 0;
    pointer-events: none;
}

/* Nome da Barbearia no Card */
.nome-estabelecimento {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #aaa;
    margin-top: 2px;
}

/* CORREÇÃO: Cores para Salmão */
.avatar-frame-bronze, .bubble-bronze { border-color: #cd7f32 !important; color: #cd7f32 !important; }
.avatar-frame-prata, .bubble-prata { border-color: #c0c0c0 !important; color: #fff !important; }
.avatar-frame-ouro, .bubble-ouro { border-color: #d4af37 !important; color: #ffd700 !important; }
.avatar-frame-diamante, .bubble-diamante { border-color: #00c6ff !important; color: #00c6ff !important; }

/* Ajuste Geral de Layout */
.content-container {
    max-width: 100%; /* Ocupa largura em mobile */
    padding-bottom: 100px; /* Espaço pro footer */
}

/* Partículas/Faíscas Aleatórias */
@keyframes particleMove {
    0% { 
        transform: translate(0, 0) scale(0.5); 
        opacity: 0; 
    }
    10% {
        opacity: 1; /* Aparece rápido */
        transform: translate(0, 0) scale(1);
    }
    100% { 
        /* Move para o destino aleatório calculado no JS e some */
        transform: translate(var(--tx), var(--ty)) scale(0.2); 
        opacity: 0; 
    }
}

@keyframes particleMove {
    0% { 
        transform: translate(0, 0) scale(0); 
        opacity: 0; 
    }
    15% {
        /* Aparece suavemente já subindo um pouco */
        opacity: 1; 
        transform: translate(calc(var(--tx) * 0.1), -50px) scale(1);
    }
    100% { 
        /* O Grande Final: Sobe muito (ty) e desvia pouco (tx) */
        transform: translate(var(--tx), var(--ty)) scale(0.5); 
        opacity: 0; 
    }
}
/* --- ONBOARDING CINEMATOGRÁFICO --- */
.onboarding-screen-container {
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
    text-align: center;
    /* Fundo escuro com gradiente sutil */
    background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
    animation: fadeIn 1s ease-in-out;
}

.cine-title {
    font-size: 2.2em;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 20px;
    /* Efeito de Texto Metálico/Ouro */
    background: linear-gradient(to bottom, #fff, var(--cor-destaque-ouro));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
}

.cine-text {
    font-size: 1.1em;
    line-height: 1.6;
    color: #ccc;
    max-width: 400px;
    margin-bottom: 40px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}

.cine-highlight {
    color: var(--cor-destaque-ouro);
    font-weight: bold;
    text-shadow: 0 0 10px var(--cor-destaque-ouro);
}

/* Opções de Interesse (Cards Grandes) */
.interest-card-btn {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 25px !important;
    margin-bottom: 15px !important;
    width: 100%;
    text-align: left;
    transition: all 0.3s ease !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.interest-card-btn:hover, .interest-card-btn.selected {
    background: rgba(212, 175, 55, 0.1) !important;
    border-color: var(--cor-destaque-ouro) !important;
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.2) !important;
    transform: scale(1.02);
}
.interest-card-btn span {
    font-size: 1.5em;
}

/* Tema Feminino no Onboarding */
.theme-pink .cine-title {
    background: linear-gradient(to bottom, #fff, var(--cor-destaque-salmao));
    -webkit-background-clip: text;
    background-clip: text;
}
.theme-pink .interest-card-btn:hover, .theme-pink .interest-card-btn.selected {
    border-color: var(--cor-destaque-salmao) !important;
    box-shadow: 0 0 30px rgba(255, 140, 105, 0.3) !important;
    background: rgba(255, 140, 105, 0.1) !important;
}

/* Filtro de Nicho Feminino */
.niche-filter-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 15px;
    background: rgba(0,0,0,0.5);
    margin-bottom: 10px;
    border-radius: 15px;
    border: 1px solid var(--cor-destaque-salmao);
}
.niche-emoji {
    font-size: 28px;
    cursor: pointer;
    opacity: 0.4;
    transition: all 0.3s;
    filter: grayscale(100%);
}
.niche-emoji.active {
    opacity: 1;
    transform: scale(1.3);
    filter: grayscale(0%);
    text-shadow: 0 0 15px var(--cor-destaque-salmao);
}

/* ================================================================= */
/* === NOVO CSS: ONBOARDING HOLLYWOOD (LUXO & FUTURISMO) === */
/* ================================================================= */

/* Efeito de Luz de Fundo (Ambiente) */
.onboarding-luxury-container::before {
    content: '';
    position: absolute;
    top: -20%; left: 50%;
    transform: translateX(-50%);
    width: 150%; height: 60%;
    background: radial-gradient(circle, rgba(212, 175, 55, 0.15) 0%, transparent 70%);
    z-index: 0;
    pointer-events: none;
}

/* Elemento Ícone Gigante (Animado) */
.cine-icon-big {
    font-size: 5em;
    margin-bottom: 20px;
    filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.4));
    animation: float-icon 4s ease-in-out infinite;
    z-index: 1;
    position: relative;
}

/* Títulos de Cinema */
.cine-title-luxury {
    font-family: 'Poppins', sans-serif;
    font-size: 2.4em;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 15px;
    background: linear-gradient(to bottom, #ffffff 0%, #d4af37 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards 0.3s;
    position: relative;
    z-index: 1;
}

/* Texto Descritivo */
.cine-text-luxury {
    font-size: 1.1em;
    line-height: 1.6;
    color: #ccc;
    max-width: 90%;
    margin-bottom: 40px;
    font-weight: 300;
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards 0.5s;
    position: relative;
    z-index: 1;
}

/* Destaque no Texto */
.cine-text-luxury b {
    color: var(--cor-destaque-ouro);
    font-weight: 600;
    text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
}

.btn-luxury-action:hover {
    background: var(--cor-destaque-ouro);
    color: #000;
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
    transform: translateY(-2px) scale(1.02);
}

/* Cards de Seleção (Vidro Escuro) */
.luxury-card-option {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 16px;
    width: 100%;
    max-width: 320px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    opacity: 0;
    animation: fadeInUp 0.6s ease-out forwards;
}

.luxury-card-option:hover {
    border-color: var(--cor-destaque-ouro);
    background: rgba(212, 175, 55, 0.05);
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

/* Animações Keyframes */
@keyframes float-icon {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

#modalOnboarding {
    padding: 0 !important;
}
#modalOnboarding .modal-content {
    width: 100vw !important;
    height: 100vh !important;
    max-width: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    border: none !important;
    background: #000; /* Fundo base */
}

/* Container Principal com Imagem de Fundo */
.onboarding-full-screen {
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* Conteúdo em baixo */
    align-items: center;
    padding: 30px;
    box-sizing: border-box;
    text-align: center;
    
    /* Propriedades da Imagem de Fundo */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    
    position: relative;
    transition: opacity 0.5s ease-in-out; /* Transição Suave */
}

/* Overlay Escuro (Degradê para ler o texto) */
.onboarding-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.8) 60%, #000000 100%);
    z-index: 1;
}

/* Conteúdo (Texto e Botões) - Fica acima do overlay */
.onboarding-inner-content {
    position: relative;
    z-index: 2;
    width: 100%;
    max-width: 400px;
    padding-bottom: 40px; /* Espaço inferior */
    animation: slideUpFade 0.8s ease-out;
}

/* Títulos */
.cine-title-v2 {
    font-size: 2.8em;
    font-weight: 800;
    text-transform: uppercase;
    line-height: 1.1;
    margin-bottom: 15px;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.8);
}
.cine-title-v2 span {
    color: var(--cor-destaque-ouro);
    display: block; /* Quebra linha para destaque */
    font-size: 0.6em; /* Um pouco menor a parte complementar */
    font-weight: 300;
    letter-spacing: 3px;
    margin-top: 5px;
}

/* Texto */
.cine-text-v2 {
    font-size: 1.1em;
    color: #ddd;
    margin-bottom: 30px;
    text-shadow: 0 1px 3px rgba(0,0,0,1);
}

/* Botão de Ação (Estilo Vidro) */
.btn-cine-action {
    width: 100%;
    padding: 18px;
    font-size: 18px;
    font-weight: bold;
    text-transform: uppercase;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(212, 175, 55, 0.9); /* Dourado Sólido/Transparente */
    color: #000;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
    cursor: pointer;
    transition: all 0.3s;
}
.btn-cine-action:hover {
    transform: scale(1.02);
    background: #fff;
    box-shadow: 0 0 30px rgba(255,255,255,0.6);
}

/* Cards de Opção (Tela 3 e 4) */
.cine-option-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    text-align: left;
    cursor: pointer;
    transition: transform 0.2s;
}
.cine-option-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
    border-color: var(--cor-destaque-ouro);
}
.cine-option-card h4 { margin: 0; color: #fff; font-size: 1.2em; }
.cine-option-card p { margin: 0; color: #ccc; font-size: 0.8em; }
.cine-option-icon { font-size: 2em; }

/* Animação de Entrada */
@keyframes slideUpFade {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes particleAscend {
    0% { transform: translate(0, 0) scale(0); opacity: 0; }
    15% { opacity: 1; transform: translate(var(--tx), -50px) scale(1); }
    100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
}

/* Estilo do Onboarding (Imagens Reais) */
.onboarding-full-screen {
    height: 100%; width: 100%;
    display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
    padding: 30px; box-sizing: border-box; text-align: center;
    background-size: cover; background-position: center; background-repeat: no-repeat;
    position: relative; transition: opacity 0.5s ease-in-out;
}
.onboarding-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.9) 60%, #000);
    z-index: 1;
}
.onboarding-inner-content {
    position: relative; z-index: 2; width: 100%; max-width: 400px;
    padding-bottom: 50px; animation: slideUpFade 0.8s ease-out;
}
.cine-title-v2 {
    font-size: 2.5em; font-weight: 800; text-transform: uppercase;
    color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.8); margin: 0; line-height: 1;
}
.cine-title-v2 span {
    color: #d4af37; display: block; font-size: 0.5em; font-weight: 300; letter-spacing: 3px; margin-top: 5px;
}
.cine-text-v2 {
    font-size: 1.1em; color: #ddd; margin: 20px 0 30px 0;
    text-shadow: 0 1px 3px rgba(0,0,0,1);
}
.btn-cine-action {
    width: 100%; padding: 16px; font-size: 18px; font-weight: bold; text-transform: uppercase;
    border-radius: 50px; border: 1px solid rgba(255,255,255,0.3);
    background: rgba(212, 175, 55, 0.9); color: #000;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); cursor: pointer;
}
.cine-option-card {
    background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1); padding: 15px;
    border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;
    text-align: left; cursor: pointer;
}
.cine-option-icon { font-size: 2.5em; }
.cine-option-info h4 { margin: 0; color: #fff; font-size: 1.1em; }
.cine-option-info p { margin: 0; color: #aaa; font-size: 0.8em; }

@keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
/* --- CORREÇÃO MODAL CONFIGURAÇÕES --- */
#modalConfiguracoes .modal-content {
    max-height: 85vh !important; /* Altura máxima de 85% da tela */
    display: flex !important;
    flex-direction: column !important;
    padding: 20px !important;
    overflow: hidden !important; /* Impede que o modal todo role */
}

#modalConfiguracoes h3 {
    flex-shrink: 0; /* Título não encolhe */
    margin-top: 0;
}

/* Faz a lista do meio rolar sozinha */
#modalConfiguracoes .scrollable-list {
    flex-grow: 1; /* Ocupa todo espaço disponível */
    overflow-y: auto; /* Scroll apenas aqui */
    margin-bottom: 15px;
    padding-right: 5px; /* Espaço pro scroll */
}

/* Botão de fechar fixo no fundo */
#modalConfiguracoes button[data-modal-id="modalConfiguracoes"] {
    flex-shrink: 0; /* Botão não encolhe */
    margin-top: 0 !important;
    width: 100%;
    background: #444;
}
/* --- MELHORIA VISUAL DA AGENDA MANUAL --- */
.horario-btn {
    background: #222;
    color: #fff;
    border: 1px solid #555;
    border-radius: 8px; /* Mais arredondado */
    padding: 10px;
    margin: 5px;
    width: 80px; /* Um pouco mais largo */
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: bold;
    position: relative;
    overflow: hidden;
}

/* Efeito de Selecionado (Verde Neon ou Dourado) */
.horario-btn.selecionado {
    background: var(--cor-destaque);
    color: #000;
    border-color: var(--cor-destaque);
    box-shadow: 0 0 10px var(--cor-destaque);
    transform: scale(1.05);
}

/* Efeito de Bloqueado (Vermelho) */
.horario-btn.bloqueado {
    background: #3a1111;
    color: #888;
    border-color: #c0392b;
    text-decoration: line-through;
    opacity: 0.7;
}

/* --- ESTILOS DA FACHADA NO CARD DO PROFISSIONAL --- */
.fachada-bg {
    position: relative;
    background-color: var(--cor-card);
    overflow: hidden;
    z-index: 1;
}
.fachada-bg::before {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    opacity: 0.25; /* Opacidade leve solicitada */
    z-index: -1; /* Fica atrás do texto */
    filter: brightness(0.7); /* Escurece um pouco para o texto aparecer */
}

/* --- BOTÃO DE AVALIAÇÕES NO TOPO --- */
.btn-ver-avaliacoes {
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--cor-destaque);
    color: var(--cor-texto-principal);
    border-radius: 20px;
    padding: 5px 15px;
    font-size: 12px;
    cursor: pointer;
    margin-left: 10px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.btn-ver-avaliacoes:hover {
    background: var(--cor-destaque);
    color: #000;
}

/* Animação para o botão de alerta */
@keyframes pulse-red {
    0% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
    70% { transform: translateX(-50%) scale(1.05); box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); }
    100% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
}

/* --- BARRA DE TROCA DE VISÃO (ADMIN) --- */
#botaoExtra {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    margin: 10px auto;
    width: 95%;
    max-width: 480px;
    padding: 5px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 15px;
    border: 1px solid var(--cor-borda);
}

#botaoExtra button {
    font-size: 11px !important;
    padding: 8px 12px !important;
    width: auto !important;
    flex-grow: 1;
    margin: 0 !important;
    border-radius: 10px !important;
    background: var(--cor-botoes);
    border: 1px solid var(--cor-borda);
    opacity: 0.7;
    transition: all 0.3s;
}

#botaoExtra button:hover {
    opacity: 1;
    transform: translateY(-2px);
}

/* Estilo do botão ativo (Visão Atual) */
#botaoExtra button.active-view {
    background: var(--cor-destaque);
    color: #000;
    border-color: var(--cor-destaque);
    opacity: 1;
    font-weight: bold;
    box-shadow: 0 0 10px var(--cor-destaque);
    pointer-events: none; /* Não clica no que já está */
}

/* Animação de Atenção para o Botão Blog */
@keyframes pulse-gold-border {
    0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); border-color: #d4af37; transform: scale(1); }
    50% { box-shadow: 0 0 10px 5px rgba(212, 175, 55, 0); border-color: #fff; transform: scale(1.05); }
    100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); border-color: #d4af37; transform: scale(1); }
}

.btn-destaque-promo {
    animation: pulse-gold-border 1.5s infinite !important;
    background: linear-gradient(45deg, #333, #444) !important;
    border: 2px solid #d4af37 !important;
    color: #d4af37 !important;
    font-weight: bold !important;
}

/* --- ESTILO ANTES & DEPOIS --- */
.before-after-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    height: 250px; /* Altura fixa */
    margin: 10px auto;
    overflow: hidden;
    border-radius: 15px;
    border: 2px solid var(--cor-destaque);
    cursor: ew-resize; /* Cursor de arrastar */
}

.ba-img {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover;
}

/* A imagem de "Antes" fica por cima e será cortada */
.img-antes {
    z-index: 2;
    width: 50%; /* Começa na metade */
    border-right: 3px solid #fff; /* Linha divisória */
    box-shadow: 5px 0 15px rgba(0,0,0,0.5);
    overflow: hidden; /* Importante para o corte funcionar */
    position: absolute;
    left: 0;
}

/* A imagem de "Depois" fica no fundo */
.img-depois {
    z-index: 1;
}

/* Botão central deslizante */
.ba-slider-handle {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
    z-index: 10;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    pointer-events: none; /* O clique passa para o container */
}

.ba-label {
    position: absolute; bottom: 10px;
    background: rgba(0,0,0,0.6);
    color: white; padding: 4px 8px;
    border-radius: 4px; font-size: 10px;
    text-transform: uppercase;
    font-weight: bold;
    z-index: 5;
}
.lbl-antes { left: 10px; }
.lbl-depois { right: 10px; }

/* --- STORIES --- */
.stories-wrapper {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 10px 0;
    margin-bottom: 10px;
    scrollbar-width: none; /* Firefox */
}
.stories-wrapper::-webkit-scrollbar { display: none; }

.story-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    width: 70px;
    flex-shrink: 0;
}

.story-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    padding: 2px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    position: relative;
}

.story-circle img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #000; /* Borda interna para separar */
    object-fit: cover;
}

.story-name {
    font-size: 10px;
    color: #ccc;
    margin-top: 5px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

/* Barra de Progresso do Story */
.story-progress-bar {
    height: 3px;
    background: rgba(255,255,255,0.3);
    flex: 1;
    border-radius: 2px;
    overflow: hidden;
}
.story-progress-fill {
    height: 100%;
    background: #fff;
    width: 0%;
}

/* --- ESTILOS STORY INTERATIVO --- */
.story-actions-sidebar {
    position: absolute;
    bottom: 100px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    z-index: 15;
}

.story-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
    text-shadow: 0 2px 5px rgba(0,0,0,0.8);
    cursor: pointer;
}

.story-action-btn span:first-child {
    font-size: 32px;
    transition: transform 0.2s;
}

.story-action-btn:active span:first-child {
    transform: scale(0.8);
}

/* Animação do Like */
.heart-active {
    color: #e74c3c !important;
    animation: popHeart 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popHeart {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

/* Estilo do Comentário */
.comment-item {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    animation: fadeIn 0.3s;
}
.comment-avatar {
    width: 35px; height: 35px; border-radius: 50%; object-fit: cover;
}
.comment-body {
    background: #333;
    padding: 8px 12px;
    border-radius: 0 12px 12px 12px;
    font-size: 13px;
}
.comment-name {
    font-weight: bold;
    color: var(--cor-destaque);
    font-size: 12px;
    display: block;
    margin-bottom: 2px;
}

/* Animação de subida do modal de comentários */
@keyframes slideUpComment {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* Estilo dos itens de comentário */
.comment-item {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
    animation: fadeIn 0.3s;
}
.comment-avatar {
    width: 35px; 
    height: 35px; 
    border-radius: 50%; 
    object-fit: cover;
    border: 1px solid #333;
    flex-shrink: 0;
}
.comment-content {
    display: flex;
    flex-direction: column;
}
.comment-name {
    font-weight: 600;
    color: #fff;
    font-size: 12px;
    margin-right: 5px;
}
.comment-text {
    color: #ddd;
    font-size: 13px;
    line-height: 1.4;
}
.comment-time {
    font-size: 10px;
    color: #777;
    margin-top: 4px;
}

/* --- META FINANCEIRA (GAMIFICAÇÃO) --- */
.meta-container {
    background: #1a1a1a;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid var(--cor-borda);
    text-align: center;
}
.meta-barra-fundo {
    background: #333;
    height: 12px;
    border-radius: 6px;
    margin: 10px 0;
    overflow: hidden;
    position: relative;
}
.meta-barra-progresso {
    height: 100%;
    background: linear-gradient(90deg, #f1c40f, #d4af37, #f1c40f);
    background-size: 200% 100%;
    width: 0%;
    transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
    animation: shine-gold 2s infinite linear;
}
.meta-texto {
    font-size: 12px;
    color: #ccc;
    display: flex;
    justify-content: space-between;
}

/* --- ANIMAÇÃO RADAR (VAGA IMEDIATA) --- */
@keyframes radar-pulse {
    0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(46, 204, 113, 0); }
    100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
}
.radar-active {
    animation: radar-pulse 1.5s infinite;
    border: 2px solid #2ecc71 !important;
    background-color: rgba(46, 204, 113, 0.1) !important;
    color: #2ecc71 !important;
    font-weight: bold;
}

/* --- COMENTÁRIOS DELETÁVEIS --- */
.comment-item.deletable {
    cursor: pointer;
    border: 1px dashed rgba(231, 76, 60, 0.3);
    position: relative;
    transition: all 0.2s;
}
.comment-item.deletable:hover {
    background: rgba(231, 76, 60, 0.15);
    border-color: #e74c3c;
}
.comment-item.deletable::after {
    content: '🗑️ Toque para apagar';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: #e74c3c;
    opacity: 0;
    transition: opacity 0.2s;
}
.comment-item.deletable:hover::after {
    opacity: 1;
}

/* Efeito de Selecionado (PRATA LUXO) */
.horario-btn.selecionado {
    background: linear-gradient(135deg, #ffffff, #c0c0c0) !important; /* Degradê Prata */
    color: #000 !important; /* Texto Preto para contraste */
    border: 1px solid #a0a0a0 !important;
    box-shadow: 0 0 15px rgba(192, 192, 192, 0.6) !important; /* Brilho Prateado */
    transform: scale(1.05);
    font-weight: bold;
}

/* ================================================================= */
/* === SPLASH SCREEN: "THE KING'S ENTRANCE" (LUXO MÁXIMO) === */
/* ================================================================= */

@keyframes livingObsidian {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes particleAscend {
    0% { transform: translate(0, 100px) scale(0); opacity: 0; }
    20% { opacity: 1; transform: translate(var(--tx), 0px) scale(1); }
    80% { opacity: 0.8; transform: translate(var(--tx), var(--ty)) scale(0.8); }
    100% { transform: translate(var(--tx), calc(var(--ty) - 50px)) scale(0); opacity: 0; }
}

@keyframes logoHeartbeat {
    0% { filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.2)); transform: scale(1); }
    50% { filter: drop-shadow(0 0 30px rgba(212, 175, 55, 0.6)); transform: scale(1.05); }
    100% { filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.2)); transform: scale(1); }
}

@keyframes shinePass {
    0% { left: -100%; }
    20% { left: 200%; }
    100% { left: 200%; }
}

#cinematicSplash {
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
    overflow: hidden;
}

/* Wrapper para centralizar e alinhar a Aura com a Logo */
.logo-wrapper {
    position: relative;
    width: 180px;
    height: 180px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

/* A Luz Dourada atrás da Logo */
.logo-aura {
    position: absolute;
    width: 100%; height: 100%;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(212, 175, 55, 0.6) 0%, rgba(212, 175, 55, 0) 70%);
    opacity: 0;
    transform: scale(0.5);
    /* Animação que será ativada via JS */
    transition: all 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.logo-aura.active {
    opacity: 1;
    transform: scale(1.5); /* A luz expande */
    animation: auraPulse 3s infinite alternate;
}

/* A Logo Transparente */
#splashLogo {
    width: 140px; /* Tamanho base */
    height: auto;
    object-fit: contain;
    opacity: 0;
    transform: scale(0.8) translateY(20px);
    transition: all 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    /* Importante: Drop Shadow respeita a transparência do PNG */
    filter: drop-shadow(0 0 0px rgba(255, 215, 0, 0));
    position: relative;
    z-index: 2;
}

#splashLogo.emerge {
    opacity: 1;
    transform: scale(1) translateY(0);
    /* Brilho dourado contornando o desenho da logo */
    filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.8));
    animation: logoFloat 4s ease-in-out infinite;
}

/* Animações */
@keyframes auraPulse {
    0% { opacity: 0.5; transform: scale(1.2); }
    100% { opacity: 0.8; transform: scale(1.6); }
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* Partículas (Mantidas, mas ajustadas para ouro) */
.particle {
    position: absolute; 
    width: 3px; height: 3px; 
    background: #d4af37; /* Ouro */
    border-radius: 50%;
    box-shadow: 0 0 10px #d4af37;
    opacity: 0;
    animation: particleAscend linear infinite;
}

@keyframes particleAscend {
    0% { transform: translate(0, 50px) scale(0); opacity: 0; }
    20% { opacity: 1; transform: translate(var(--tx), 0px) scale(1); }
    80% { opacity: 0.6; transform: translate(var(--tx), var(--ty)) scale(0.5); }
    100% { transform: translate(var(--tx), calc(var(--ty) - 50px)) scale(0); opacity: 0; }
}

/* Texto Metálico (Mantido e Ajustado) */
#splashAppName { 
    font-family: 'Poppins', sans-serif; 
    font-size: 26px; 
    font-weight: 800; 
    letter-spacing: 5px;
    opacity: 0; 
    transform: translateY(10px);
    transition: all 1s ease;
    background: linear-gradient(to bottom, #fff 0%, #d4af37 100%); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    text-transform: uppercase;
    position: relative;
    z-index: 2;
}
#splashAppName.show { opacity: 1; transform: translateY(0); }

/* Checklist Terminal */
#splashChecklist { 
    margin-top: 50px; 
    text-align: center; 
    width: 100%;
    font-family: 'Courier New', monospace; 
    font-size: 11px;
    z-index: 2; 
}
.check-item { opacity: 0; margin-bottom: 8px; color: #555; transition: all 0.5s; letter-spacing: 1px; }
.check-item.visible { opacity: 1; }
.check-item .status { color: #d4af37; font-weight: bold; margin-left: 5px; } 
.check-item .status.success { color: #2ecc71; text-shadow: 0 0 5px #2ecc71; }

/* EFEITO ZOOM NA TELA INICIAL */
@keyframes slowZoom {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
}
.onboarding-full-screen {
    animation: slowZoom 20s ease-in-out infinite alternate;
}

/* PREÇOS CORTADOS (TIERS) */
.preco-cortado {
    text-decoration: line-through;
    color: #e74c3c;
    font-size: 12px;
    margin-right: 5px;
    opacity: 0.7;
}

/* BARRA DE BUSCA DA LOJA */
#searchLojaInput {
    width: 100%;
    padding: 12px 12px 12px 40px; /* Espaço para ícone */
    border-radius: 25px;
    border: 1px solid var(--cor-borda);
    background-color: var(--cor-botoes);
    color: var(--cor-texto-principal);
    margin-bottom: 15px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23777' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 12px center;
    background-size: 18px;
}

/* CONTROLES DO MAPA (TRANSPORTE) */
.transport-controls {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
    background: rgba(0,0,0,0.8);
    padding: 8px;
    border-radius: 12px;
    border: 1px solid var(--cor-destaque);
}
.transport-btn {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    opacity: 0.5;
    transition: 0.2s;
    padding: 5px;
}
.transport-btn.active {
    opacity: 1;
    transform: scale(1.2);
    filter: drop-shadow(0 0 5px var(--cor-destaque));
}
.eta-badge {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: rgba(0,0,0,0.9);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid #2ecc71;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

#modalMapaGeral {
    display: none; /* Garante que comece escondido */
    z-index: 10000; /* Acima de tudo */
    background: rgba(0,0,0,0.95);
}

/* Marcador do Mapa: Foto Redonda */
.map-photo-marker {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    background-size: cover;
    background-position: center;
    background-color: #333;
    position: relative;
}

/* Emoji flutuante em cima da foto */
.map-emoji-badge {
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    z-index: 10;
}

/* Animação de pulso para o cliente (em movimento) */
.pulse-animation {
    animation: pulse-ring 2s infinite;
}
@keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(0, 198, 255, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(0, 198, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 198, 255, 0); }
}

/* Animação de Agito/Notificação para o Chat do Mapa */
@keyframes shake-pulse {
    0% { transform: rotate(0deg) scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
    25% { transform: rotate(-10deg) scale(1.1); }
    50% { transform: rotate(10deg) scale(1.1); box-shadow: 0 0 20px 10px rgba(255, 0, 0, 0); }
    75% { transform: rotate(-5deg) scale(1.1); }
    100% { transform: rotate(0deg) scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
}

.chat-alert-anim {
    animation: shake-pulse 1s ease-in-out infinite !important;
    background-color: #ff4757 !important; /* Fundo Vermelho */
    border-color: #fff !important;
    z-index: 10000 !important;
}

/* Garante que o Modal de Planos fique bem alto */
#modalVipPro {
    z-index: 25000 !important; 
}

/* Garante que o Modal de Confirmação (Compra) fique MAIS ALTO que o de Planos */
#modalConfirmacaoGenerica {
    z-index: 30000 !important;
}

/* O fundo escuro desses modais também precisa acompanhar */
#modalVipPro.show, #modalConfirmacaoGenerica.show {
    background: rgba(0,0,0,0.95);
}

/* --- CSS: MISSÕES DIÁRIAS --- */
.missao-item {
    background: #222;
    border: 1px solid #444;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.missao-info { flex-grow: 1; }
.missao-titulo { font-size: 13px; color: #fff; font-weight: bold; }
.missao-barra-bg { height: 6px; background: #444; border-radius: 3px; margin-top: 5px; width: 90%; }
.missao-barra-fill { height: 100%; background: var(--cor-destaque); border-radius: 3px; width: 0%; transition: width 0.5s; }
.missao-check { font-size: 18px; color: #555; }
.missao-check.concluida { color: #2ecc71; animation: popIn 0.5s; }

/* --- CSS: PAINEL EM ALTA (PINTEREST STYLE) --- */
.em-alta-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 Colunas */
    gap: 10px;
    padding: 5px;
}
.em-alta-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition: transform 0.2s;
}
.em-alta-item:hover { transform: scale(1.02); }
.em-alta-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}
.em-alta-overlay {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 10px 5px;
    box-sizing: border-box;
}
.em-alta-stats { font-size: 10px; color: #fff; display: flex; gap: 10px; align-items: center; }
.em-alta-badge {
    position: absolute; top: 5px; right: 5px;
    background: linear-gradient(45deg, #00c6ff, #0072ff);
    color: white; font-size: 8px; font-weight: bold; padding: 2px 6px; border-radius: 4px;
    box-shadow: 0 0 10px #00c6ff;
}

/* Modal Detalhes Em Alta */
#modalDetalhesEmAlta .modal-content {
    background: #000;
    padding: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    border-radius: 0;
}

/* Grid "Pinterest" para o Em Alta */
.em-alta-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 Colunas */
    gap: 8px;
    padding: 8px;
}

.em-alta-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    aspect-ratio: 9/16; /* Formato vertical tipo story */
    transition: transform 0.2s;
}

.em-alta-item:hover { transform: scale(1.02); }

.em-alta-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.em-alta-overlay {
    position: absolute; 
    bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 10px 8px;
    box-sizing: border-box;
}

.em-alta-badge {
    position: absolute; top: 8px; right: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #00c6ff;
    color: #00c6ff; 
    font-size: 9px; font-weight: bold; padding: 3px 6px; border-radius: 4px;
    backdrop-filter: blur(4px);
}

/* --- SCROLL INVISÍVEL (Para Gestão) --- */
.scroll-invisivel {
    overflow-y: auto;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE and Edge */
}
.scroll-invisivel::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}

/* --- NOVO ESTILO EM ALTA (DETALHES) --- */
.interacao-barra {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #333;
    margin-bottom: 10px;
}

.action-icon-box {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    font-size: 14px;
    color: #ccc;
    transition: color 0.2s;
}
.action-icon-box:hover { color: #fff; }
.action-icon-box span { font-size: 20px; }
.heart-filled { color: #e74c3c !important; animation: popHeart 0.3s; }

/* Área de Comentários */
.area-comentarios {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 60px; /* Espaço para o input fixo ou botão */
}
.comentario-linha {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 12px;
}
.comentario-nome { font-weight: bold; color: var(--cor-destaque); margin-right: 5px; }
.comentario-texto { color: #ddd; }

/* Botão Agendar Pequeno (Rodapé) */
.btn-agendar-mini {
    width: auto !important;
    padding: 8px 20px !important;
    font-size: 12px !important;
    background: linear-gradient(45deg, #00c6ff, #0072ff) !important;
    border-radius: 20px !important;
    box-shadow: 0 0 10px rgba(0, 198, 255, 0.4) !important;
    position: absolute;
    bottom: 15px;
    right: 15px;
    z-index: 10;
}

/* Classe para permitir rolagem mas esconder a barra */
.scroll-invisivel {
    overflow-y: auto !important;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE */
}
.scroll-invisivel::-webkit-scrollbar {
    display: none; /* Chrome, Safari */
}

/* Garante que o modal de gestão ocupe a tela e role o conteúdo interno */
#modalFinanceiroProprietario .modal-content {
    max-height: 90vh !important;
    display: flex !important;
    flex-direction: column !important;
    padding: 0 !important; /* Remove padding do container pai */
    background: #000;
    overflow: hidden !important; /* Impede rolagem dupla */
}

/* O corpo do modal de gestão que vai rolar */
#gestaoBodyScroll {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto;
}

#emAltaView {
    /* MUDANÇA AQUI: Tiramos o !important para ele obedecer ocultação */
    display: block; 
    
    position: relative !important;
    width: 95% !important;
    max-width: 480px !important;
    margin: 15px auto !important;
    padding: 0 !important;
    
    background: #111 !important;
    border: 1px solid #333 !important;
    border-radius: 16px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6) !important;
    overflow: hidden !important;
    
    /* Reseta posições antigas */
    top: auto !important; left: auto !important; height: auto !important;
}

/* 2. REGRA DE SEGURANÇA (Para garantir que ele suma) */
#emAltaView.hidden {
    display: none !important;
}

/* 3. Cabeçalho */
#emAltaView > div:first-child {
    width: 100% !important;
    box-sizing: border-box !important;
    background: linear-gradient(to bottom, #1a1a1a, #0e0e0e) !important;
    padding: 15px !important;
    border-bottom: 1px solid #333 !important;
    text-align: center !important;
}

/* 4. Container Pai da Grade */
#gridEmAlta {
    display: block !important;
    width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    grid-template-columns: none !important;
    gap: 0 !important;
}

/* 5. A Grade REAL */
#gridEmAlta .em-alta-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important; /* 3 Colunas */
    gap: 2px !important;
    width: 100% !important;
    padding: 2px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    padding-bottom: 20px !important;
}

/* 6. Os Itens */
.em-alta-item {
    width: 100% !important;
    aspect-ratio: 1 / 1 !important;
    position: relative !important;
    margin: 0 !important;
    background: #222 !important;
    border-radius: 4px !important;
    overflow: hidden !important;
}

/* 7. A Imagem */
.em-alta-img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    display: block !important;
}

/* 8. Spinner */
#emAltaView .spinner {
    margin: 40px auto !important;
    display: block !important;
}

/* --- ESTILOS DO PLAYER EM ALTA (TIPO STORY) --- */
.em-alta-progress-container {
    position: absolute;
    top: 10px;
    left: 0;
    width: 100%;
    display: flex;
    gap: 4px;
    padding: 0 10px;
    box-sizing: border-box;
    z-index: 20;
}

.em-alta-progress-bar {
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    flex: 1;
    border-radius: 2px;
    overflow: hidden;
}

.em-alta-progress-fill {
    height: 100%;
    background: #fff;
    width: 0%;
    /* A transição será controlada via JS para ser suave */
}

/* Áreas de toque invisíveis para voltar/avançar */
.touch-nav-left, .touch-nav-right {
    position: absolute;
    top: 0;
    height: 100%;
    width: 40%; /* 40% da tela para cada lado */
    z-index: 15;
    /* background: rgba(255,0,0,0.2); Descomente para testar a área */
}
.touch-nav-left { left: 0; }
.touch-nav-right { right: 0; }

/* ================================================================= */
/* === CORREÇÃO: POPUP DE CONFIRMAÇÃO SUPREMO (ACIMA DE TUDO) === */
/* ================================================================= */

/* Força o Popup de Confirmação a ter o maior Z-Index possível */
#modalConfirmacaoGenerica {
    z-index: 99999 !important; /* Valor altíssimo para ganhar de qualquer modal */
}

/* Garante que o fundo escuro dele também cubra o modal de baixo */
#modalConfirmacaoGenerica.show {
    background: rgba(0, 0, 0, 0.95) !important; /* Fundo bem escuro para dar foco */
}

/* Mesma regra para o Popup de Alerta Genérico (Avisos de erro, etc) */
#modalPopupGenerico {
    z-index: 99999 !important;
}

/* Opcional: Garante que o modal de "Aguarde" fique logo abaixo da confirmação mas acima do resto */
#popupAguarde {
    z-index: 99990 !important;
}

#modalCarteira,
#modalDeposito,
#modalDepositoFormulario,
#modalPacotesMoedasTWA,
#modalTaxaCartao,
#modalExibirPixAprimorado,
#modalSaque {
    z-index: 30000 !important; /* Garante que fique na frente dos Planos */
}

/* Opcional: Se abrir um formulário de compra da loja direto dos planos */
#modalFormularioCompraLoja {
    z-index: 30000 !important;
}

/* --- HIERARQUIA DE CAMADAS (CAMADAS CORRIGIDAS) --- */

/* 1. Popups Comuns (Embaixo do Mapa) */
.modal, #modalPopupGenerico, #modalAvisoOnboarding {
    z-index: 15000 !important;
}

/* 2. O Mapa (No Meio) */
#modalRastreamento {
    z-index: 20000 !important;
    background: #000 !important; /* Garante que cubra os popups de baixo */
}

/* 3. O Alerta de Novo Agendamento (ACIMA DE TUDO - O Profissional PRECISA VER) */
#modalNovoAgendamento {
    z-index: 25000 !important;
    background: rgba(0,0,0,0.95);
}

/* 4. Chat do Mapa (Acima do Mapa) */
#janelaChat {
    z-index: 21000 !important;
}

/* 5. Splash Screen (Acima de tudo na inicialização) */
#cinematicSplash {
    z-index: 99999 !important;
}

.card-action-btn { /* Classe base para ações no card */
        position: absolute;
        bottom: 10px; /* Ficam na parte de baixo do card */
        background: rgba(0,0,0,0.6);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        z-index: 5;
        transition: transform 0.2s;
        color: var(--cor-texto-principal); 
    }
    .card-action-btn:hover {
        transform: scale(1.1);
    }
    
    /* --- CORAÇÃO NA DIREITA (MANTIDO) --- */
    .card-favorite-btn {
        right: 10px; 
    }
    
    /* --- COMPARTILHAR NA ESQUERDA (ALTERADO) --- */
    .card-share-btn {
        left: 10px;  /* Fixa na esquerda */
        right: auto; /* Remove qualquer alinhamento à direita anterior */
        font-size: 18px; 
    }

/* --- CSS BATALHA DE ESTILOS (CORRIGIDO E BLINDADO) --- */

/* 1. Modal Tela Cheia */
#modalBatalha .modal-content {
    width: 100vw !important;
    height: 100vh !important;
    max-width: none !important;
    padding: 0 !important;
    background: #000 !important;
    border: none !important;
    display: block !important; /* Importante para o posicionamento absoluto funcionar */
    position: relative !important;
    overflow: hidden !important;
}

/* 2. Container Principal */
.battle-arena {
    width: 100%;
    height: 100%;
    position: relative; /* Ocupa tudo */
}

/* 3. METADE DE CIMA (Fixa) */
#batalhaOpcaoA {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 50% !important; /* Exatos 50% */
    overflow: hidden;
    border-bottom: 2px solid #fff;
    z-index: 1;
}

/* 4. METADE DE BAIXO (Fixa) */
#batalhaOpcaoB {
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 50% !important; /* Exatos 50% */
    overflow: hidden;
    z-index: 1;
}

/* 5. A Imagem (Cobre tudo sem distorcer) */
.battle-img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    display: block;
}

/* Efeito de clique */
#batalhaOpcaoA:active .battle-img,
#batalhaOpcaoB:active .battle-img {
    opacity: 0.8;
    transform: scale(0.98);
    transition: 0.2s;
}

/* VS no meio (Flutuante) */
.battle-vs-badge {
    position: absolute;
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 20; /* Fica acima das imagens */
    width: 60px; 
    height: 60px;
    background: #ff0000;
    color: white;
    font-weight: bold;
    font-style: italic;
    font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    border: 4px solid #fff;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    pointer-events: none;
}

/* Informações sobre a foto */
.battle-info-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 20px 15px 10px 15px;
    pointer-events: none;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

/* Animação Coração */
.voto-animacao {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 100px; opacity: 0; z-index: 10;
    transition: 0.3s;
    text-shadow: 0 0 20px rgba(0,0,0,0.5);
}
.voto-animacao.show {
    opacity: 1; transform: translate(-50%, -50%) scale(1.5);
}

/* Loading e Botão Fechar */
#loadingBatalha {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: #000; z-index: 60;
    display: flex; justify-content: center; align-items: center;
}
.battle-close-btn {
    position: absolute; top: 15px; right: 15px; z-index: 50;
    background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.5);
    color: white; width: 40px; height: 40px; border-radius: 50%;
    font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.battle-counter {
    position: absolute; top: 15px; left: 15px; z-index: 50;
    background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px;
    border: 1px solid var(--cor-destaque); color: #fff; font-size: 12px; font-weight: bold;
}

/* CORREÇÃO: Modal de Perfil deve ficar ACIMA do Chat (que é 21000) */
#modalVisualizarPerfilChat {
    z-index: 22000 !important;
}

/* Garante que o fundo escuro do perfil também cubra o chat */
#modalVisualizarPerfilChat.show {
    background: rgba(0, 0, 0, 0.9) !important;
}

/* --- CSS BATALHA DE ESTILOS (LAYOUT 50/50 ABSOLUTO) --- */

#modalBatalha .modal-content {
    width: 100vw !important;
    height: 100vh !important;
    max-width: none !important;
    padding: 0 !important;
    margin: 0 !important;
    background: #000 !important;
    border: none !important;
    display: block !important; /* Importante para position absolute funcionar */
    position: relative !important;
    overflow: hidden !important;
}

/* Container da Arena */
.battle-arena {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* METADE DE CIMA (A) */
#batalhaOpcaoA {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100%;
    height: 50%; /* Exatos 50% da tela */
    overflow: hidden;
    border-bottom: 2px solid #fff;
    z-index: 1;
    cursor: pointer;
}

/* METADE DE BAIXO (B) */
#batalhaOpcaoB {
    position: absolute !important;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%; /* Exatos 50% da tela */
    overflow: hidden;
    z-index: 1;
    cursor: pointer;
}

/* A IMAGEM (Preenche o quadrado perfeitamente) */
.battle-img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Corta o excesso para não esticar */
    object-position: center;
    display: block;
    transition: transform 0.2s ease;
}

/* Efeito ao clicar */
#batalhaOpcaoA:active .battle-img, 
#batalhaOpcaoB:active .battle-img {
    transform: scale(0.96);
    filter: brightness(0.8);
}

/* VS (Flutuante no meio) */
.battle-vs-badge {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    width: 60px; height: 60px;
    background: #ff0000;
    color: white;
    font-weight: 900;
    font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    border: 4px solid #fff;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    pointer-events: none;
    font-style: italic;
}

/* Informações (Texto sobre a imagem) */
.battle-info-overlay {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 30px 15px 15px 15px;
    pointer-events: none;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

/* Animação do Coração */
.voto-animacao {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 100px; opacity: 0; z-index: 5;
    transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
    text-shadow: 0 0 20px rgba(0,0,0,0.5);
}
.voto-animacao.show { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }

/* Loading */
#loadingBatalha {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: #000; z-index: 50;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column;
}

/* --- CORREÇÃO DE CAMADAS (PRÊMIO DA ROLETA) --- */

/* Garante que o Popup de Prêmio (Bloqueante) fique ACIMA do Perfil */
#modalBloqueante {
    z-index: 99990 !important; /* Camada Altíssima */
    background: rgba(0,0,0,0.95) !important; /* Fundo bem escuro para destacar */
}

/* O conteúdo do popup */
#modalBloqueante .modal-content {
    border: 2px solid #ffd700; /* Borda dourada para dar ar de prêmio */
    box-shadow: 0 0 50px rgba(255, 215, 0, 0.5); /* Brilho dourado */
}

/* --- ESTILO KING OF THE DAY (REI DO DIA) --- */
@keyframes blink-gold-text {
    0%, 100% { color: #fff; text-shadow: 0 0 5px gold; border-color: gold; }
    50% { color: #ffd700; text-shadow: 0 0 20px gold; border-color: #fff; }
}

.bubble-king {
    background: #000 !important;
    border: 2px solid gold !important;
    animation: blink-gold-text 2s infinite;
    font-weight: bold;
}
/* Ícone do Troféu flutuando no balão */
.bubble-king::after {
    content: '🏆'; 
    position: absolute; 
    top: -15px; 
    right: -10px; 
    font-size: 20px; 
    filter: drop-shadow(0 0 5px gold);
    animation: float-crown 3s ease-in-out infinite;
}

/* Botão SOS (Vermelho Piscante) */
.btn-sos-glow {
    background: linear-gradient(45deg, #c0392b, #e74c3c) !important;
    border: 1px solid #fff !important;
    animation: pulse-red 1.5s infinite;
    color: white !important;
    font-weight: bold;
}

/* --- ESTILO PARA O NOVO BOTÃO SOS (NEON FIRE) --- */

/* Esta classe base será usada para o novo visual */
.btn-sos-neon {
    /* Fundo Escuro Metálico */
    background: linear-gradient(135deg, #111, #000) !important;
    border: 2px solid #ff4500 !important; /* Borda vermelha forte */
    color: #fff !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 1px;
    /* Brilho Vermelho / Laranja */
    box-shadow: 0 0 10px #ff4500, 0 0 30px rgba(255, 69, 0, 0.7); 
    animation: pulse-neon-red 1.2s infinite alternate;
}

/* Efeito de Sirene (O ícone "🚨" que se move no topo) */
.btn-sos-neon::before {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 38px; /* Ícone Grande */
    filter: drop-shadow(0 0 10px #ff0000);
    z-index: 5;
    animation: alert-shake 0.5s ease-in-out infinite alternate;
    pointer-events: none; /* Garante que o clique passe */
}
.btn-sos-neon:hover::before {
    animation: none;
    transform: translate(-50%, -50%) scale(1.1);
}

/* Move o texto para baixo para não ficar na frente do ícone */
.btn-sos-neon {
    padding-top: 25px !important; 
    padding-bottom: 5px !important;
    /* Ajusta a linha do texto que já existia */
    line-height: 1.2; 
}

/* Animações */
@keyframes pulse-neon-red {
    0% { box-shadow: 0 0 10px #ff4500, 0 0 20px rgba(255, 69, 0, 0.4); }
    100% { box-shadow: 0 0 25px #ff4500, 0 0 40px rgba(255, 69, 0, 0.8); }
}

@keyframes alert-shake {
    0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
    50% { transform: translate(-50%, -50%) rotate(2deg); }
}

/* --- ESTILO PARA O NOVO BOTÃO SOS (OPORTUNIDADE VERDE/OURO) --- */

/* 1. Botão Principal do Painel (SOS Cadeira Vazia) */
.btn-sos-opportunity {
    /* Fundo Verde Metálico */
    background: linear-gradient(135deg, #27ae60, #1e8449) !important; 
    border: 2px solid var(--cor-destaque-ouro) !important; /* Borda Dourada */
    color: #000 !important; 
    font-weight: bold;
    /* Brilho Verde Suave */
    box-shadow: 0 0 10px #2ecc71, 0 0 20px rgba(46, 204, 113, 0.4); 
    animation: pulse-opportunity 1.5s infinite alternate;
}

/* 2. Botão Lançar Oferta (Dentro do Modal) */
.btn-launch-offer {
    /* Cor Sólida Verde para a Ação */
    background: linear-gradient(45deg, #2ecc71, #27ae60) !important;
    color: #000 !important;
    border: 1px solid var(--cor-destaque-ouro) !important;
    font-weight: bold;
}

/* Animação do Pulso */
@keyframes pulse-opportunity {
    0% { box-shadow: 0 0 5px #2ecc71, 0 0 10px var(--cor-destaque-ouro); }
    100% { box-shadow: 0 0 15px #2ecc71, 0 0 30px var(--cor-destaque-ouro); }
}

/* Botão do Mapa Minimizado (Chiclete) */
#btnMinimizadoMapa {
    position: fixed;
    top: 40px; /* Logo abaixo da Topbar */
    left: 50%;
    transform: translateX(-50%);
    z-index: 21000; /* Acima de quase tudo */
    background: linear-gradient(45deg, #00c6ff, #0072ff);
    color: white;
    border: 2px solid white;
    padding: 10px 25px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 0 15px rgba(0, 198, 255, 0.6);
    display: none; /* Começa escondido */
    animation: pulse-blue 1.5s infinite;
    cursor: pointer;
}

@keyframes pulse-blue {
    0% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(0, 198, 255, 0.7); }
    70% { transform: translateX(-50%) scale(1.05); box-shadow: 0 0 0 10px rgba(0, 198, 255, 0); }
    100% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(0, 198, 255, 0); }
}

/* Adicione ou verifique se existe no seu CSS */
.chat-alert-anim {
    animation: shake-pulse 1s ease-in-out infinite !important;
    background-color: #ff4757 !important; /* Vermelho alerta */
    border-color: #fff !important;
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.8) !important;
}

@keyframes shake-pulse {
    0% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-10deg) scale(1.1); }
    50% { transform: rotate(10deg) scale(1.1); box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
    75% { transform: rotate(-5deg) scale(1.1); }
    100% { transform: rotate(0deg) scale(1); }
}

/* --- CORREÇÃO CSS PARA O ALERTA DO CHAT GLOBAL --- */
#btnChat.chat-alert-anim {
    background-color: #ff4757 !important; /* Vermelho alerta */
    border-color: #fff !important;
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.8) !important;
    animation: shake-pulse 1s ease-in-out infinite !important;
}

/* Animação de tremer/pulsar */
@keyframes shake-pulse {
    0% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.1) rotate(-10deg); }
    50% { transform: scale(1.1) rotate(10deg); box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
    75% { transform: scale(1.1) rotate(-5deg); }
    100% { transform: scale(1) rotate(0deg); }
}

/* --- ESTILOS GESTÃO FINANCEIRA E EQUIPE (PREMIUM) --- */

/* Modal Grande (Equipe e Financeiro) */
.modal-large .modal-content {
    max-width: 800px !important;
    width: 95% !important;
    height: 90vh !important;
    max-height: 90vh !important;
    display: flex;
    flex-direction: column;
    padding: 0 !important;
    background: #0f0f0f !important; /* Fundo escuro premium */
    border: 1px solid var(--cor-borda);
}

/* Cabeçalho do Modal */
.modal-header-premium {
    padding: 20px;
    background: linear-gradient(to bottom, #1a1a1a, #0f0f0f);
    border-bottom: 1px solid var(--cor-borda);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Card de Membro da Equipe */
.team-member-card {
    display: flex;
    align-items: center;
    background: linear-gradient(145deg, #1a1a1a, #111);
    border: 1px solid #333;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    transition: transform 0.2s, box-shadow 0.2s;
}
.team-member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border-color: var(--cor-destaque);
}

/* Valor a Pagar (Destaque) */
.valor-pagar-highlight {
    font-size: 18px;
    font-weight: 800;
    color: #2ecc71; /* Verde Dinheiro */
    text-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
}

/* Botão Pagar */
.btn-pagar-equipe {
    background: linear-gradient(45deg, #27ae60, #2ecc71);
    color: #000;
    font-weight: bold;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
    transition: all 0.3s;
}
.btn-pagar-equipe:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(46, 204, 113, 0.5);
}

/* Container de Busca (Não intrusivo) */
.search-container-top {
    padding: 10px 20px;
    background: #111;
    border-bottom: 1px solid #333;
}
.search-input-premium {
    width: 100%;
    background: #222;
    border: 1px solid #444;
    padding: 10px 15px 10px 40px; /* Espaço pro ícone */
    border-radius: 25px;
    color: #fff;
    font-size: 14px;
    transition: all 0.3s;
}
.search-input-premium:focus {
    border-color: var(--cor-destaque);
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
}

/* Gráficos em Cards */
.chart-card {
    background: #1a1a1a;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #333;
}

/* --- CSS: CHECK-IN DIÁRIO & FOGO --- */

/* O Badge de Fogo no Topo */
#badgeFogoStreak {
    font-size: 11px; 
    color: #ff4500; 
    font-weight: 800; 
    margin-left: 6px; 
    text-shadow: 0 0 8px rgba(255, 69, 0, 0.6);
    display: inline-flex;
    align-items: center;
    gap: 2px;
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 10px;
    border: 1px solid rgba(255, 69, 0, 0.3);
}

/* Modal de Check-in (Efeito Impactante) */
#modalCheckIn .modal-content {
    background: linear-gradient(135deg, #1a0b00, #000);
    border: 2px solid #ff4500;
    text-align: center;
    position: relative;
    overflow: hidden;
}

/* Efeito de brilho de fundo */
#modalCheckIn .modal-content::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255, 69, 0, 0.2) 0%, transparent 70%);
    animation: rotate-glow 10s linear infinite;
    z-index: 0;
    pointer-events: none;
}

@keyframes rotate-glow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.checkin-day-circle {
    width: 60px; height: 60px;
    border-radius: 50%;
    background: #333;
    color: #555;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold;
    margin: 0 5px;
    border: 2px solid #444;
}
.checkin-day-circle.active {
    background: #ff4500;
    color: white;
    border-color: #fff;
    box-shadow: 0 0 15px #ff4500;
    transform: scale(1.1);
}

/* --- ESTILOS DE PERFIL DE LUXO --- */

/* Fundo Brilhante atrás da Foto */
.luxury-avatar-bg {
    position: relative;
    display: inline-block;
    border-radius: 50%;
}
.luxury-avatar-bg::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 140%; height: 140%;
    background: radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, rgba(0,0,0,0) 70%);
    z-index: 0;
    animation: rotate-glow 10s linear infinite;
}

/* Nome com Brilho Dourado Animado */
.text-shine-gold {
    background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    background-size: 200% auto;
    color: transparent;
    -webkit-background-clip: text;
    background-clip: text;
    font-weight: 900;
    letter-spacing: 1px;
    animation: shineText 3s linear infinite;
    text-transform: uppercase;
}

/* Data em Prata Metálico */
.text-silver-date {
    background: linear-gradient(to bottom, #e0e0e0 0%, #999 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 5px;
    display: block;
}

/* Títulos das Seções (Elegantes) */
.luxury-section-title {
    font-size: 10px;
    text-transform: uppercase;
    color: #888;
    letter-spacing: 2px;
    margin: 20px 0 10px 0;
    text-align: left;
    border-bottom: 1px solid #333;
    padding-bottom: 5px;
}

/* Cards Pequenos para Coleções */
.mini-collection-item {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 8px;
    min-width: 60px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
}
.mini-collection-item span {
    font-size: 20px;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
}
.mini-collection-item p {
    font-size: 8px;
    color: #aaa;
    margin: 4px 0 0 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 55px;
}

/* Scroll Horizontal Invisível (Elegante) */
.luxury-scroll {
    display: flex;
    overflow-x: auto;
    padding-bottom: 5px;
    scrollbar-width: none;
}
.luxury-scroll::-webkit-scrollbar { display: none; }

/* --- ESTILOS DE PERFIL DE LUXO (CORRIGIDO) --- */

/* Wrapper que segura a foto e o brilho */
.luxury-avatar-bg {
    position: relative;
    display: flex;             /* Mudança: Flex para centralizar conteúdo */
    justify-content: center;   /* Centraliza horizontal */
    align-items: center;       /* Centraliza vertical */
    width: 120px;              /* Largura fixa igual à da foto */
    height: 120px;             /* Altura fixa igual à da foto */
    margin: 0 auto;            /* Centraliza a div na tela */
    border-radius: 50%;
}

/* O Brilho (Fica atrás) */
.luxury-avatar-bg::before {
    content: '';
    position: absolute;
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%); /* Centralização Perfeita */
    width: 160%; /* Um pouco maior que a foto (120px * 1.6) */
    height: 160%;
    background: radial-gradient(circle, rgba(212, 175, 55, 0.6) 0%, rgba(0,0,0,0) 70%);
    z-index: 0; /* Atrás da foto */
    animation: rotate-glow 10s linear infinite;
    pointer-events: none; /* Não atrapalha cliques */
}

/* A Foto em si (Fica na frente) */
.luxury-avatar-bg img.perfil-foto-grande {
    position: relative;
    z-index: 2; /* Garante que fique na frente do brilho */
    width: 100% !important;
    height: 100% !important;
    border-radius: 50%;
    object-fit: cover;
    display: block;
}

/* Ajuste caso tenha moldura */
.avatar-wrapper.popup-size .luxury-avatar-bg {
    width: 100%; height: 100%; /* Herda do wrapper */
}

@keyframes rotate-glow {
    0% { transform: translate(-50%, -50%) rotate(0deg); opacity: 0.8; }
    50% { transform: translate(-50%, -50%) rotate(180deg); opacity: 1; }
    100% { transform: translate(-50%, -50%) rotate(360deg); opacity: 0.8; }
}

/* Botão de Check-in Manual */
#btnCheckInManual {
    background: linear-gradient(45deg, #ff4500, #ff8c00);
    color: white;
    font-weight: 800;
    text-transform: uppercase;
    border: 2px solid #fff;
    border-radius: 30px;
    padding: 12px;
    margin-bottom: 10px; /* Espaço para o botão de baixo */
    box-shadow: 0 0 15px #ff4500;
    animation: pulse-fire 1.5s infinite;
    width: 200px; /* Mesmo tamanho do de baixo */
    cursor: pointer;
}

@keyframes pulse-fire {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
}

/* --- ESTILO OBSIDIAN AUTH (LOGIN/CADASTRO) --- */

/* Fontes Futuristas */
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Orbitron:wght@500;700&display=swap');

/* O Card de Login Principal */
#authView.obsidian-card {
    background: rgba(15, 15, 15, 0.85) !important; /* Vidro Escuro */
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(212, 175, 55, 0.3) !important; /* Borda Dourada Fina */
    box-shadow: 0 0 50px rgba(0,0,0,0.9), 0 0 15px rgba(212, 175, 55, 0.1) !important;
    border-radius: 20px !important;
    padding: 30px !important;
    max-width: 450px !important;
    width: 95% !important;
    position: relative;
    overflow: hidden;
    color: #fff;
    font-family: 'Montserrat', sans-serif;
}

/* Efeito de "Scanline" Dourado no topo (Animação) */
#authView.obsidian-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: #D4AF37;
    box-shadow: 0 0 15px #D4AF37;
    animation: scanAuth 6s infinite linear;
    opacity: 0.7;
    pointer-events: none;
}
@keyframes scanAuth { 0% { top: 0%; opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { top: 100%; opacity:0; } }

/* Título da Marca */
.auth-brand {
    font-family: 'Orbitron', sans-serif;
    color: #D4AF37;
    font-size: 1.8rem;
    text-align: center;
    margin-bottom: 5px;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
}
.auth-subtitle {
    text-align: center;
    color: #888;
    font-size: 0.8rem;
    margin-bottom: 25px;
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* Inputs com Aspecto de Vidro */
#authView input, #authView select {
    background: rgba(255, 255, 255, 0.03) !important; /* Fundo transparente */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #fff !important;
    border-radius: 12px !important;
    padding: 15px !important;
    font-size: 16px !important;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
    width: 100%;
    margin-bottom: 12px;
    font-family: 'Montserrat', sans-serif;
}

/* Foco no Input (Brilho Dourado) */
#authView input:focus, #authView select:focus {
    border-color: #D4AF37 !important;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.2), inset 0 0 20px rgba(0,0,0,0.5) !important;
    background: rgba(0, 0, 0, 0.6) !important;
    outline: none;
}

/* Placeholder cinza claro */
#authView input::placeholder { color: #666; font-weight: 300; }

/* Botões Principais (Entrar/Criar) - Estilo Ouro Sólido */
#authView button {
    background: linear-gradient(135deg, #D4AF37 0%, #F1C40F 50%, #B8860B 100%) !important;
    color: #000 !important;
    font-weight: 800 !important;
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    border: none !important;
    border-radius: 12px !important;
    padding: 16px !important;
    box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2) !important;
    text-transform: uppercase;
    transition: transform 0.2s, box-shadow 0.2s !important;
    margin-top: 10px;
}
#authView button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4) !important;
}

/* Botões Secundários (Voltar/Criar Conta Link) - Estilo Vidro/Outline */
#authView button.btn-secondary-auth {
    background: transparent !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #ccc !important;
    box-shadow: none !important;
    font-weight: normal !important;
    font-family: 'Montserrat', sans-serif !important;
    font-size: 0.9rem !important;
}
#authView button.btn-secondary-auth:hover {
    border-color: #D4AF37 !important;
    color: #D4AF37 !important;
    background: rgba(212, 175, 55, 0.05) !important;
}

/* Link de Esqueci Senha */
.auth-forgot-link {
    color: #D4AF37 !important;
    font-size: 0.85rem;
    text-decoration: none;
    opacity: 0.8;
    transition: 0.3s;
}
.auth-forgot-link:hover {
    opacity: 1;
    text-shadow: 0 0 5px #D4AF37;
}

/* Ajustes no Container de Show Password */
.show-password-container {
    background: transparent !important;
    border: none !important;
}
.show-password-toggle {
    color: #D4AF37 !important;
    opacity: 0.7;
}

#cinematicSplash {
    position: fixed; 
    top: 0; left: 0; 
    width: 100vw; /* Garante largura total da janela */
    height: 100vh; /* Garante altura total da janela */
    z-index: 100000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
    overflow: hidden !important; /* Força esconder qualquer barra interna */
    touch-action: none; /* Impede tentar rolar a tela no celular */
    overscroll-behavior: none; /* Impede o efeito "elástico" no iPhone */
}

/* Estilo dos Super Botões de Categoria */
.super-btn {
    width: 100%;
    text-align: left;
    padding: 15px;
    margin-bottom: 5px;
    background: linear-gradient(145deg, #1e1e1e, #141414);
    border: 1px solid #333;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}
.super-btn:hover {
    border-color: var(--cor-destaque);
    background: #252525;
}
.super-btn::after {
    content: '▼';
    font-size: 12px;
    transition: transform 0.3s;
}
.super-btn.open {
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    background: var(--cor-card);
    color: var(--cor-destaque);
}
.super-btn.open::after {
    transform: rotate(180deg);
}

/* Container dos Sub-botões */
.sub-menu-container {
    background: #111;
    border: 1px solid #333;
    border-top: none;
    border-radius: 0 0 12px 12px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* Esconde o container quando fechado */
.sub-menu-container.hidden {
    display: none;
}

/* Botão de Contratação (Exclusivo Proprietário) */
.card-invite-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: rgba(46, 204, 113, 0.2); /* Fundo verde transparente */
    border: 1px solid #2ecc71;
    color: #fff;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20; /* Fica acima de tudo */
    transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

.card-invite-btn:hover {
    background: #2ecc71;
    transform: scale(1.1);
}

/* Badge indicando que já é da equipe */
.card-team-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 10px;
    background: #2ecc71;
    color: #000;
    padding: 4px 8px;
    border-radius: 10px;
    font-weight: bold;
    z-index: 20;
}

/* Badge de Promoção Fixa (Topo Esquerdo) */
.promo-fixa-badge {
    position: absolute;
    top: 0;
    left: 0;
    background: linear-gradient(135deg, #d4af37, #f1c40f); /* Dourado */
    color: #000;
    font-weight: 800;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 8px 0 12px 0; /* Canto arredondado estiloso */
    z-index: 25; /* Acima da foto */
    box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Animação da Coroa King Points */
@keyframes crown-float-shine {
    0% { transform: translateY(0) scale(1); text-shadow: 0 0 5px #ffd700; }
    50% { transform: translateY(-5px) scale(1.1); text-shadow: 0 0 20px #ffeb3b, 0 0 30px #d4af37; }
    100% { transform: translateY(0) scale(1); text-shadow: 0 0 5px #ffd700; }
}

.king-points-icon {
    font-size: 40px;
    display: inline-block;
    animation: crown-float-shine 2s infinite ease-in-out;
    margin-bottom: 10px;
}

.king-balance-display {
    background: linear-gradient(135deg, #1a0b00, #000);
    border: 2px solid #d4af37;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    margin-bottom: 15px;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
}

/* --- ESTILOS DO SISTEMA DE ASSINATURAS --- */

/* Botão de Destaque no Perfil (Para ver os planos) */
.btn-plano-destaque {
    background: linear-gradient(135deg, #1a0b00, #000);
    border: 2px solid #d4af37;
    color: #d4af37;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 15px;
    border-radius: 12px;
    width: 100%;
    margin-bottom: 15px;
    animation: gold-pulse 2s infinite;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
}

/* Card do Plano (Lista) */
.plano-card {
    background: linear-gradient(145deg, #222, #111);
    border: 1px solid var(--cor-destaque);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
}
.plano-card::before {
    content: '👑';
    position: absolute;
    top: -10px; right: -10px;
    font-size: 80px;
    opacity: 0.1;
    transform: rotate(30deg);
}

/* Regras do Plano (Caixa de texto) */
.regras-box {
    background: rgba(255,0,0,0.1);
    border: 1px solid #e74c3c;
    padding: 15px;
    border-radius: 8px;
    font-size: 12px;
    color: #ccc;
    margin: 15px 0;
    text-align: left;
    max-height: 150px;
    overflow-y: auto;
}

/* Botão de Agendar (Quando usa o plano) */
.btn-agendar-plano {
    background: linear-gradient(45deg, #d4af37, #f1c40f) !important;
    color: #000 !important;
    font-weight: 900 !important;
    border: 2px solid #fff !important;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.6) !important;
    animation: pulse 1.5s infinite;
}

/* Badge de Assinatura Ativa (No perfil) */
.assinatura-ativa-badge {
    background: linear-gradient(45deg, #1a1a1a, #000);
    border: 1px solid #2ecc71;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    margin: 10px 0;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.2);
}

/* ============================================================ */
/* === VERSÃO DESKTOP: BORDERLESS & STORE FIX === */
/* ============================================================ */

@media (min-width: 1024px) {

    /* 1. MOLDURA DA TELA (O EFEITO DE MONITOR) */
    body::after {
        content: '';
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 999999; /* Acima de tudo absoluto */
        pointer-events: none; /* Permite clicar através dela */
        
        /* A Borda Prateada Fina */
        border: 4px solid #C0C0C0; 
        
        /* O Brilho Dourado Leve (Interno e Externo) */
        box-shadow: 
            inset 0 0 20px rgba(212, 175, 55, 0.4), /* Brilho para dentro */
            0 0 15px rgba(212, 175, 55, 0.2);       /* Brilho para fora */
            
        border-radius: 0; /* Cantos retos para parecer monitor */
    }

    /* 2. CORPO DA PÁGINA */
    body {
        overflow: hidden !important; 
        background-color: #050505 !important;
        /* Pequeno padding para o conteúdo não colar na borda prateada */
        padding: 5px !important; 
    }

    /* Esconde elementos Mobile */
    .topbar, .bottom-buttons-container, #btnMinimizadoMapa, .app-footer, #btnChat { 
        display: none !important; 
    }

    /* 3. SIDEBAR ESQUERDA */
    #desktopSidebar {
        width: 260px !important;
        z-index: 50;
        border-right: 1px solid #333;
        background: #0a0a0a !important;
        /* Ajuste para não colar na borda da tela */
        top: 5px !important; bottom: 5px !important; left: 5px !important;
        height: auto !important;
        border-radius: 10px 0 0 10px;
    }

    /* 4. CHAT FIXO NA DIREITA */
    #janelaChat {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: none !important;
        position: fixed !important;
        
        /* Ajuste para não colar na borda da tela */
        top: 5px !important; bottom: 5px !important; right: 5px !important; left: auto !important;
        height: auto !important;
        
        width: 340px !important; 
        background: #0a0a0a !important;
        border-left: 2px solid #333 !important;
        z-index: 40 !important;
        padding: 0 !important;
        border-radius: 0 10px 10px 0;
    }
    
    #janelaChat .modal-content {
        width: 100% !important; height: 100% !important;
        border: none !important; background: transparent !important; box-shadow: none !important;
    }
    #janelaChat button[data-modal-id="janelaChat"] { display: none !important; }
    #chatMessages { flex-grow: 1 !important; max-height: none !important; }
    
    /* Estilo para modo-mapa: chat ocupa 50vh e fica colado no fundo */
    #janelaChat.modo-mapa {
        height: 50vh !important;
        top: auto !important;
        bottom: 0 !important;
    }

    /* 5. CONTEÚDO CENTRAL (O PAINEL) */
    .content-container {
        position: fixed !important;
        
        /* Encaixa entre a Sidebar e o Chat, respeitando a borda da tela */
        top: 5px !important; 
        bottom: 5px !important;
        left: 265px !important; /* 260px sidebar + 5px espaço */
        right: 345px !important; /* 340px chat + 5px espaço */
        
        width: auto !important;
        max-width: none !important;
        height: auto !important;
        
        margin: 0 !important;
        padding: 30px !important;

        /* Borda Dourada Interna (Do Painel em si) */
        border: 1px solid #333 !important;
        /* box-shadow: 0 0 50px rgba(0,0,0,0.8); Removemos a sombra pesada para limpar */
        
        background: #000 !important;
        overflow-y: auto !important;
        display: block !important;
    }

    /* Corrige container interno */
    .content-container > div {
        margin: 0 auto !important;
        max-width: 1400px !important; /* Permite telas ultrawide */
    }

    /* 6. CORREÇÃO DA LOJA (PARA NÃO FICAR ESPREMIDA) */
    #lojaContainer, .loja-grid {
        display: grid !important;
        /* Cria colunas responsivas com largura mínima de 220px */
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
        gap: 25px !important; /* Mais espaço entre os produtos */
        width: 100% !important;
        padding-bottom: 50px;
    }

    /* Card do Produto na Loja */
    .produto-card {
        width: 100% !important;
        height: 100% !important;
        display: flex;
        flex-direction: column;
        background: #151515 !important;
        border: 1px solid #333;
        transition: transform 0.2s;
    }
    .produto-card:hover {
        transform: translateY(-5px);
        border-color: var(--cor-destaque);
    }
    
    /* Imagem do Produto (Tamanho fixo para alinhar) */
    .produto-card img {
        height: 200px !important; /* Altura fixa boa para PC */
        width: 100% !important;
        object-fit: cover !important;
    }

    /* 7. GRADE DOS BARBEIROS (Igual a loja) */
    #listaBarbeirosPrincipalCliente, 
    #listaBarbeirosPrincipalBarbeiro, 
    .barbeiro-list-container,
    #painelHistorico,
    #agendamentosPainel {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
        gap: 20px !important;
        width: 100% !important;
    }

    /* 8. STORIES (Espaço total) */
    .stories-wrapper {
        display: flex !important;
        justify-content: flex-start !important;
        gap: 15px !important;
        width: 100% !important;
        overflow-x: auto !important;
        padding: 10px 0 !important;
        margin-bottom: 30px !important;
    }
    .story-item { flex-shrink: 0 !important; }

    /* 9. MODAIS POPUP (Centralizados) */
    .modal:not(#janelaChat) {
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
        background: rgba(0,0,0,0.85) !important;
        z-index: 10000 !important;
    }
    .modal:not(#janelaChat) .modal-content {
        width: 600px !important;
        max-width: 90% !important;
        max-height: 85vh !important;
        border: 1px solid var(--cor-destaque) !important;
        box-shadow: 0 0 40px rgba(0,0,0,1) !important;
        border-radius: 12px !important;
        margin: auto !important;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--cor-destaque); }
}

/* --- VISUAL NOVO: GESTÃO DE EQUIPE (ESTILO GRID/CARDS) --- */

/* 1. O Painel Principal (Ocupa a tela) */
#profissionaisView {
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
    animation: fadeIn 0.5s ease;
}

/* 2. Grade Responsiva (Se adapta ao PC e Celular) */
#containerEquipeVisual {
    display: grid;
    /* Celular: 1 ou 2 por linha. PC: Vários por linha. Minimo 160px largura */
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap: 15px;
    width: 100%;
    margin-top: 15px;
}

/* 3. O Card do Profissional (Estilo Print) */
.card-equipe-grid {
    background: linear-gradient(145deg, #1e1e1e, #000000);
    border: 1px solid #333;
    border-radius: 16px;
    padding: 15px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition: transform 0.2s, border-color 0.2s;
}

/* Efeito Hover (Fica dourado ao passar mouse) */
.card-equipe-grid:hover {
    transform: translateY(-3px);
    border-color: #d4af37;
    box-shadow: 0 10px 20px rgba(212, 175, 55, 0.1);
}

/* Foto do Profissional */
.card-equipe-foto {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #d4af37; /* Borda Dourada */
    margin-bottom: 8px;
}

/* Badge "VOCÊ" */
.badge-voce {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #d4af37;
    color: #000;
    font-size: 9px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 4px;
}

/* Nome e Cargo */
.card-equipe-nome {
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 2px;
}
.card-equipe-cargo {
    font-size: 10px;
    color: #aaa;
    text-transform: uppercase;
    margin-bottom: 12px;
    letter-spacing: 1px;
}

/* 4. Grade de Horários (Slots Pequenos) */
.grid-horarios-mini {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 colunas de horário igual o print */
    gap: 6px;
    width: 100%;
}

.slot-time {
    font-size: 11px;
    padding: 4px 0;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid transparent;
}

/* Slot Livre (Verde Neon) */
.slot-livre {
    background: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
    border-color: #2ecc71;
}
.slot-livre:hover {
    background: #2ecc71;
    color: #000;
}

/* Slot Ocupado (Vermelho) */
.slot-ocupado {
    background: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
    border-color: #e74c3c;
    cursor: default; /* Não clicável */
}

/* Botão Criar Agendamento (Estilo do Print) */
.btn-criar-agendamento-top {
    width: 100%;
    padding: 15px;
    border-radius: 12px;
    background: transparent;
    border: 1px solid #d4af37;
    color: #d4af37;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s;
}
.btn-criar-agendamento-top:hover {
    background: #d4af37;
    color: #000;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
}

/* --- ESTILO DA GRADE DE AGENDA --- */
#containerMinhaAgendaGrid {
    padding: 0 10px;
    display: grid;
    /* Cria slots retangulares largos, ideais para ler o nome */
    grid-template-columns: 1fr; 
    gap: 10px;
    padding-bottom: 80px;
}

.agenda-slot-card {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s;
}

.agenda-slot-card:active { transform: scale(0.98); }

/* Variação: LIVRE */
.agenda-slot-card.livre {
    border-left: 5px solid #2ecc71;
    background: linear-gradient(90deg, rgba(46, 204, 113, 0.1), transparent);
}
.agenda-slot-card.livre .hora { color: #2ecc71; font-size: 18px; font-weight: bold; }
.agenda-slot-card.livre .info { color: #aaa; font-size: 12px; }

/* Variação: OCUPADO */
.agenda-slot-card.ocupado {
    border-left: 5px solid #e74c3c; /* Vermelho padrão */
    background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), transparent);
}
.agenda-slot-card.ocupado.concluido {
    border-left: 5px solid #aaa; /* Cinza se já acabou */
    opacity: 0.6;
}

.agenda-slot-card.ocupado .hora { color: #fff; font-size: 18px; font-weight: bold; }
.agenda-slot-card.ocupado .cliente { color: var(--cor-destaque); font-weight: bold; font-size: 14px; }
.agenda-slot-card.ocupado .servico { color: #ccc; font-size: 12px; }

/* --- CORREÇÃO: MODAL DE PLANOS SEMPRE NO TOPO --- */
#modalVipPro {
    z-index: 99999 !important; /* Valor altíssimo para ganhar de qualquer outro modal */
    background: rgba(0, 0, 0, 0.95) !important; /* Fundo bem escuro para focar nele */
}

/* --- BOTÃO VAGA IMEDIATA DESTAQUE --- */
.btn-vaga-destaque {
    width: 100%;
    padding: 15px;
    background: #222;
    border: 1px solid #555;
    color: #fff;
    font-weight: bold;
    border-radius: 12px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Estado Ativo (Verde Neon) */
.btn-vaga-destaque.ativo {
    background: rgba(46, 204, 113, 0.2);
    border: 2px solid #2ecc71;
    color: #2ecc71;
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
    animation: pulse-green 2s infinite;
}

/* --- CORREÇÃO FINAL: CENTRALIZAÇÃO + DESLOCAMENTO CONTROLÁVEL --- */
#footerMapContainer {
    position: fixed !important;
    bottom: 25px !important; /* Posição ajustada */
    
    /* 1. CENTRALIZAÇÃO BASE (LEFT: 50% = MEIO DA TELA) */
    left: 50% !important; 
    
    /* 2. DESLOCAMENTO (Use o calc() para mover o botão) */
    /* - Mova para a DIREITA adicionando um valor positivo (ex: +20px) */
    /* - Mova para a ESQUERDA adicionando um valor negativo (ex: -20px) */
    transform: translateX(calc(-50% + 35px)) !important; 
    
    /* Removido: width: 100% e display: flex para permitir o transform */
    width: auto !important;
    height: auto !important;
    
    z-index: 16000 !important;
    pointer-events: none !important; 
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* O estilo do botão em si (child) fica igual, pois ele é que obedece */
#footerMapContainer button {
    pointer-events: auto !important;
    width: 70px !important;
    padding: 12px !important;
    
    background: linear-gradient(45deg, #00c6ff, #0072ff) !important;
    color: white !important;
    font-weight: bold !important;
    font-size: 8px !important;
    
    border: 2px solid white !important;
    border-radius: 30px !important;
    box-shadow: 0 0 15px rgba(0,198,255,0.6) !important;
    
    animation: pulse-blue 3s infinite !important;
}

/* --- ESTILO PARA BUSCA DE EMPREGO (SECRETÁRIA) --- */

/* Container em Grade Responsiva (PC e Mobile automático) */
.grid-vagas-secretaria {
    display: grid !important;
    /* A mágica: cria colunas de no mínimo 300px. Se a tela for grande, cabem mais. Se pequena, cabe 1. */
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
    gap: 15px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    padding-bottom: 20px;
}

/* Card do Proprietário (Visual Bonito e Organizado) */
.card-dono-vaga {
    background: linear-gradient(145deg, #1e1e1e, #121212);
    border: 1px solid #333;
    border-radius: 16px;
    padding: 15px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%; /* Garante que todos tenham a mesma altura na linha */
}

.card-dono-vaga:hover {
    transform: translateY(-3px);
    border-color: var(--cor-destaque);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

/* Cabeçalho do Card (Foto e Textos) */
.dono-vaga-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.dono-vaga-foto {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--cor-destaque);
    flex-shrink: 0; /* Impede a foto de amassar */
}

.dono-vaga-info {
    flex-grow: 1;
    min-width: 0; /* Permite que o texto quebre linha corretamente */
}

.dono-vaga-titulo {
    font-size: 16px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dono-vaga-sub {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 2px;
}

/* Botão de Ação Destacado */
.btn-solicitar-vaga {
    background: rgba(46, 204, 113, 0.15);
    border: 1px solid #2ecc71;
    color: #2ecc71;
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-solicitar-vaga:hover {
    background: #2ecc71;
    color: #000;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.4);
}

/* --- ESTILO PARA LIKES EM COMENTÁRIOS --- */
.comment-item {
    align-items: flex-start; /* Alinha no topo caso o texto seja longo */
}

.comment-like-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-left: auto; /* Empurra para a direita */
    padding-left: 10px;
    cursor: pointer;
    min-width: 30px;
}

.comment-heart {
    font-size: 14px;
    color: #555; /* Cor desativado */
    transition: all 0.2s;
}

.comment-heart.liked {
    color: #e74c3c; /* Vermelho ativado */
    transform: scale(1.2);
    text-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}

.comment-count {
    font-size: 9px;
    color: #888;
    margin-top: 2px;
}

/* EFEITO DE VIDRO E MENSAGENS ANIMADAS */
#popupAguarde {
    background-color: rgba(0, 0, 0, 0.6); /* Fundo escuro leve */
    backdrop-filter: blur(8px); /* O desfoque do vidro */
    -webkit-backdrop-filter: blur(8px);
    z-index: 99999;
}

#popupAguarde .modal-content {
    background: rgba(30, 30, 30, 0.6) !important; /* Vidro escuro */
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    color: white;
    max-width: 80%;
    animation: pulse-glass 2s infinite alternate;
}

@keyframes pulse-glass {
    from { box-shadow: 0 0 10px rgba(212, 175, 55, 0.1); border-color: rgba(255,255,255,0.1); }
    to { box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); border-color: var(--cor-destaque); }
}

#popupAguardeTexto {
    font-size: 16px;
    font-weight: 300;
    letter-spacing: 1px;
    margin-top: 15px;
    display: block;
    min-height: 20px; /* Evita pulo se o texto mudar */
    transition: opacity 0.5s;
}

/* Esconde o painel de almoço global, pois agora ele será injetado via JS na agenda */
#painel-almoco {
    display: none !important;
}

/* --- LOJA DE DIAMANTES PREMIUM --- */
.loja-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 60000;
    display: flex;
    justify-content: center; /* Centraliza no PC */
    align-items: flex-start;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.loja-container {
    width: 100%;
    max-width: 500px; /* Largura de celular no PC */
    min-height: 100%;
    background: #0d0d0d;
    display: flex;
    flex-direction: column;
    position: relative;
    box-shadow: 0 0 50px rgba(0,0,0,1);
}

.loja-header {
    padding: 60px 20px 30px;
    text-align: center;
    background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
    border-bottom: 1px solid #222;
}

.loja-header h2 { 
    color: #fff; 
    font-size: 24px; 
    margin: 0; 
    letter-spacing: 1px;
}

.loja-header .subtitle {
    color: #00c6ff;
    font-size: 12px;
    text-transform: uppercase;
    font-weight: bold;
    margin-top: 5px;
    display: block;
}

.btn-fechar-topo {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #222;
    border: 1px solid #333;
    color: #fff;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
}

.loja-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 colunas no celular */
    gap: 15px;
    padding: 20px;
}

/* Card Estilo Game */
.card-diamante {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 20px;
    padding: 20px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease;
    position: relative;
}

.card-diamante:active { transform: scale(0.95); }

.card-diamante.destaque {
    border-color: #00c6ff;
    background: linear-gradient(145deg, #1a1a1a, #0d1b2a);
    box-shadow: 0 10px 20px rgba(0, 198, 255, 0.1);
}

.card-icon {
    font-size: 45px;
    margin-bottom: 10px;
    filter: drop-shadow(0 0 10px rgba(0,198,255,0.3));
}

.card-info { text-align: center; }

.card-qtd {
    display: block;
    color: #fff;
    font-size: 18px;
    font-weight: 600;
}

.card-nome {
    display: block;
    color: #00c6ff;
    font-size: 10px;
    text-transform: uppercase;
    margin-bottom: 15px;
}

.btn-comprar-item {
    background: linear-gradient(45deg, #00c6ff, #0072ff);
    color: #fff;
    border: none;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 12px;
    box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
}

.badge-pop {
    position: absolute;
    top: -10px;
    background: #ff3e3e;
    color: #fff;
    font-size: 9px;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: bold;
}

.loja-footer-fixo {
    margin-top: auto;
    padding: 20px;
    background: #0d0d0d;
    border-top: 1px solid #222;
}

.btn-sair-loja {
    width: 100%;
    background: transparent;
    border: 1px solid #444;
    color: #888;
    padding: 15px;
    border-radius: 15px;
    font-weight: bold;
}

/* Ajuste para PC (3 colunas se a tela for grande) */
@media (min-width: 800px) {
    .loja-container { max-width: 700px; border-left: 1px solid #333; border-right: 1px solid #333; }
    .loja-grid { grid-template-columns: 1fr 1fr 1fr; }
}

/* --- CSS DO OVERLAY DE RECOMPENSA --- */
.reward-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Fundo escuro */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Fica acima de tudo */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
}

.reward-overlay.show {
    opacity: 1;
    pointer-events: auto;
}

.reward-container {
    text-align: center;
    transform: scale(0.8);
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efeito elástico */
}
.reward-overlay.show .reward-container {
    transform: scale(1);
}

.reward-chest {
    font-size: 80px;
    margin-bottom: -20px;
    position: relative;
    z-index: 1;
}

.reward-content {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    padding: 20px 40px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
    position: relative;
    animation: floatUp 0.8s ease-out forwards; /* Sai de dentro do baú */
}

/* Animação do Coração pulsando lentamente */
.heart-pulse {
    font-size: 50px;
    animation: pulseSlow 2s infinite ease-in-out;
}

.points-text {
    font-size: 48px;
    font-weight: 900;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.points-label {
    color: #fff;
    font-weight: bold;
    text-transform: uppercase;
}

/* --- Keyframes das Animações --- */
@keyframes pulseSlow {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes floatUp {
    from { opacity: 0; transform: translateY(50px) scale(0.5); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.card-grafico-container {
    background: rgba(255, 255, 255, 0.05); /* Fundo sutil */
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.header-grafico {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    color: #fff;
}

.canvas-wrapper {
    position: relative;
    height: 300px; /* Define uma altura fixa para evitar o fundo preto */
    width: 100%;
}

.badge-fidelidade {
    background: linear-gradient(90deg, #FFD700, #FFA500);
    color: #000;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 12px;
    font-weight: bold;
}

/* --- ADICIONE ISTO FORA DO @MEDIA (NO CSS GERAL) --- */
.chart-card canvas {
    min-height: 220px !important;
    width: 100% !important;
    display: block;
}

/* Classe para esconder elementos no PC */
.mobile-view-only {
    display: block;
}

/* ============================================================ */
/* === VERSÃO DESKTOP: BORDERLESS & NOVA SIDEBAR === */
/* ============================================================ */
@media (min-width: 1024px) {

    /* ESCONDE ELEMENTOS DO MOBILE NO PC */
    .topbar, 
    .bottom-buttons-container, 
    #btnMinimizadoMapa, 
    .app-footer, 
    #btnChat,
    .mobile-view-only { 
        display: none !important; 
    }

    /* 1. MOLDURA DA TELA (MONITOR) */
    body::after {
        content: '';
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 999999;
        pointer-events: none;
        border: 4px solid #C0C0C0;
        box-shadow: inset 0 0 20px rgba(212, 175, 55, 0.4), 0 0 15px rgba(212, 175, 55, 0.2);
    }

    /* 2. CORPO DA PÁGINA */
    body {
        overflow: hidden !important;
        background-color: #050505 !important;
        padding: 0 !important;
    }

    /* 3. NOVA SIDEBAR ESQUERDA (ESTILO DASHBOARD) */
    #desktopSidebar {
        width: 280px !important;
        position: fixed !important;
        top: 4px !important; 
        left: 4px !important; 
        bottom: 4px !important;
        background: linear-gradient(180deg, #111 0%, #0a0a0a 100%) !important;
        border-right: 1px solid var(--cor-destaque);
        z-index: 50;
        border-radius: 0 15px 15px 0;
        padding: 20px !important;
        display: flex !important; 
        flex-direction: column !important;
        box-shadow: 5px 0 20px rgba(0,0,0,0.8) !important;
        overflow-y: auto !important;
    }

    #desktopSidebar::-webkit-scrollbar { width: 5px; }
    #desktopSidebar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* 4. ÁREA CENTRAL (PAINEL) */
    .content-container {
        position: fixed !important;
        top: 10px !important;
        bottom: 10px !important;
        left: 300px !important; /* Sidebar + Espaço */
        right: 360px !important; /* Chat + Espaço */
        
        width: auto !important;
        max-width: none !important;
        height: auto !important;
        
        margin: 0 !important;
        padding: 40px !important;
        
        border: 1px solid #333 !important;
        border-radius: 15px;
        background: #0d0d0d !important;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        overflow-y: auto !important;
        display: block !important;
    }

    /* 5. CHAT FIXO NA DIREITA */
    #janelaChat {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        position: fixed !important;
        top: 4px !important;
        bottom: 4px !important; 
        right: 4px !important; 
        left: auto !important;
        
        width: 340px !important;
        background: #0a0a0a !important;
        border-left: 1px solid #333 !important;
        z-index: 40 !important;
        padding: 0 !important;
        border-radius: 15px 0 0 15px;
    }
    #janelaChat .modal-content {
        width: 100% !important;
        height: 100% !important;
        border: none !important; 
        background: transparent !important; 
        box-shadow: none !important;
    }
    /* Esconde botão fechar do chat no PC */
    #janelaChat button[data-modal-id="janelaChat"] { display: none !important; }

    /* 6. MODAIS POPUP (Centralizados) */
    .modal:not(#janelaChat) {
        align-items: center !important;
        justify-content: center !important;
        z-index: 10000 !important;
    }
    .modal:not(#janelaChat) .modal-content {
        width: 600px !important;
        max-width: 90% !important;
        max-height: 85vh !important;
        border: 1px solid var(--cor-destaque) !important;
        box-shadow: 0 0 40px rgba(0,0,0,1) !important;
    }
    
    /* GRIDS PARA O PC */
    #lojaContainer, .loja-grid, #listaBarbeirosPrincipalCliente, 
    #listaBarbeirosPrincipalBarbeiro, .barbeiro-list-container {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)) !important;
        gap: 20px !important;
        width: 100% !important;
        padding-bottom: 50px;
    }
}

/* ======================================================= */
/* === ANIMAÇÕES MODERNAS (ESTILO FRAMER MOTION / GSAP) === */
/* ======================================================= */

/* 1. Efeito "Reveal on Scroll" (Elementos surgem ao rolar) */
.reveal-on-scroll {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
    transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1); /* Curva "Smooth" estilo Apple */
    will-change: transform, opacity;
}

.reveal-on-scroll.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* 2. Micro-interações em Botões (Feedback Elástico) */
button, .card, .selectable-item {
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), 
                background-color 0.3s ease, 
                box-shadow 0.3s ease !important;
}

button:active, .card:active {
    transform: scale(0.96) !important; /* Efeito de clique físico */
}

/* 3. Layout Transitions (FLIP simulado para listas) */
.card-agendamento-premium, .card-equipe-grid, .produto-card {
    animation: slideInStagger 0.5s ease-out forwards;
    opacity: 0;
}

@keyframes slideInStagger {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 4. Efeito de Foco "Glassmorphism" Avançado */
.modal-content {
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%);
    background-color: rgba(18, 18, 18, 0.85) !important;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
}

/* 5. Loader Estilo "Lottie" (CSS Puro de Alta Performance) */
.spinner-moderno {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, transparent 0%, var(--cor-destaque) 100%);
    animation: spin-modern 1s linear infinite;
    position: relative;
    margin: 20px auto;
}
.spinner-moderno::after {
    content: '';
    position: absolute;
    inset: 4px;
    background: #000;
    border-radius: 50%;
}
@keyframes spin-modern { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* 6. Efeito de Texto Gradiente Animado (Para Títulos Importantes) */
.texto-framer {
    background: linear-gradient(to right, #fff, #d4af37, #fff);
    background-size: 200% auto;
    color: transparent;
    -webkit-background-clip: text;
    background-clip: text;
    animation: shineText 5s linear infinite;
    font-weight: 800;
}

/* --- EFEITO 3D PROFUNDO EM TODOS OS CARDS --- */
.card, .produto-card, .em-alta-item, .card-equipe-grid, .agenda-slot-card {
    background: linear-gradient(145deg, #1e1e1e, #121212) !important; /* Degradê sutil */
    border: 1px solid rgba(255, 255, 255, 0.05) !important; /* Borda quase invisível */
    border-top: 1px solid rgba(255, 255, 255, 0.1) !important; /* Luz vindo de cima */
    border-bottom: 1px solid rgba(0, 0, 0, 0.5) !important; /* Sombra embaixo */
    
    /* Sombra 3D projetada */
    box-shadow: 
        0 10px 20px rgba(0, 0, 0, 0.5),      /* Sombra longe */
        0 4px 6px rgba(0, 0, 0, 0.3),       /* Sombra perto */
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important; /* Brilho interno no topo */
    
    border-radius: 16px !important;
    transform-style: preserve-3d; /* Prepara para animações 3D */
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease !important;
}

/* Efeito ao passar o mouse ou tocar */
.card:active, .produto-card:active, .card-equipe-grid:active {
    transform: translateY(2px) scale(0.98) !important; /* Afunda o card */
    box-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.4), 
        inset 0 2px 10px rgba(0,0,0,0.5) !important; /* Sombra interna ao apertar */
}

/* --- ANIMAÇÃO DE ROLAGEM VIVA (SCROLL REVEAL) --- */

/* Estado inicial (fora da tela ou invisível) */
.scroll-hidden {
    opacity: 0;
    filter: blur(5px);
    transform: translateY(50px) scale(0.9); /* Mais para baixo e menor */
    transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Estado visível (quando entra na tela) */
.scroll-visible {
    opacity: 1;
    filter: blur(0);
    transform: translateY(0) scale(1);
}

.card, .produto-card, .em-alta-item, .card-equipe-grid, .agenda-slot-card, .card-agendamento-premium {
        perspective: 1000px;
        transform-style: preserve-3d;
        will-change: transform, opacity, box-shadow;
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease;
        
        /* Vidro Escuro Profundo */
        background: linear-gradient(145deg, rgba(30, 30, 30, 0.9), rgba(10, 10, 10, 0.95)) !important;
        border: 1px solid rgba(255, 255, 255, 0.08) !important;
        border-top: 1px solid rgba(255, 255, 255, 0.15) !important;
        box-shadow: 
            0 15px 35px rgba(0, 0, 0, 0.6), 
            0 5px 15px rgba(0,0,0,0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    }

    .card:hover, .produto-card:hover, .card-agendamento-premium:hover {
        transform: translateY(-5px) rotateX(2deg) !important;
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.8), 
            0 0 20px rgba(212, 175, 55, 0.15) !important; /* Brilho dourado sutil */
        border-color: var(--cor-destaque) !important;
    }

    /* ANIMAÇÃO DE SHIMMER (CARREGAMENTO) */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    .loading-skeleton {
        background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite linear;
        border-radius: 8px;
    }

    /* SETUP INICIAL PARA ANIMAÇÕES DE ENTRADA */
    .gsap-reveal {
        opacity: 0; /* Começa invisível para o GSAP controlar */
    }

/* --- 1. ESTILO PRODUTO PREMIUM (OURO) --- */
.card-premium {
    background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c) !important;
    border: 1px solid #fff !important;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.6) !important;
    color: #000 !important;
    transform: scale(1.02);
    transition: transform 0.3s ease;
}
.card-premium * {
    color: #000 !important; /* Força texto preto para contraste no ouro */
    text-shadow: none !important;
}

/* --- 2. ANIMAÇÃO DE ENTRADA DE MODAL (LUXO) --- */
@keyframes modalEntradaLuxo {
    0% {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
        filter: blur(10px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0);
    }
}

.modal {
    /* Garante que o modal use a animação ao abrir */
    animation: modalEntradaLuxo 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    background: rgba(0, 0, 0, 0.85); /* Fundo um pouco mais escuro para o luxo */
    backdrop-filter: blur(8px); /* Efeito de vidro */
}

/* --- 3. CLASSE BASE PARA O SCROLL DOS EXTRATOS --- */
.gsap-feed-item {
    opacity: 0; /* Começa invisível para o GSAP animar */
    transform: translateY(50px); /* Começa 50px para baixo */
}

/* --- BRILHO DOURADO ATRÁS DOS POPUPS --- */
.modal.show .modal-content {
    animation: modalEntradaLuxo 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.4), 0 0 60px rgba(212, 175, 55, 0.2) !important;
    border: 1px solid rgba(212, 175, 55, 0.5) !important;
}

/* Garante que nada bloqueie as faíscas na frente */
canvas.confetti-canvas {
    z-index: 999999 !important;
    position: fixed !important;
}

/* ANIMAÇÃO DE SLIDE UP DOS EXTRATOS */
.gsap-feed-item {
    opacity: 0;
    transform: translateY(30px);
}

/* --- ANIMAÇÃO DE SAÍDA LUXUOSA --- */
@keyframes modalSaidaLuxo {
    0% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0);
    }
    100% {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
        filter: blur(10px);
    }
}

/* Classe que aplicaremos via JS na hora de fechar */
.modal.closing .modal-content {
    animation: modalSaidaLuxo 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

/* O fundo (overlay) também faz um fadeout */
.modal.closing {
    transition: opacity 0.3s ease;
    opacity: 0 !important;
}

/* Garante que o canvas das faíscas fique na frente de todos os popups */
.confetti-canvas {
    z-index: 999999 !important;
    pointer-events: none; /* Não atrapalha os cliques no app */
}

/* Brilho dourado discreto atrás do conteúdo do modal */
.modal.show .modal-content {
    border: 1px solid rgba(255, 215, 0, 0.3) !important;
    box-shadow: 0 0 40px rgba(212, 175, 55, 0.15) !important;
    animation: modalEntradaLuxo 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* Estado inicial bem escondido e mais abaixo para um efeito dramático */
.gsap-feed-item {
    opacity: 0;
    transform: translateY(80px) scale(0.9); /* Começa menor e mais baixo */
    transition: none; /* Garante que o GSAP controle tudo */
}

.perfil-acoes-container {
    display: flex;
    justify-content: space-between; /* Espalha eles igualmente */
    gap: 10px;
    margin: 15px 0;
    padding: 0 5px;
}

/* O Botão em si (Caixinha) */
.btn-perfil-acao {
    flex: 1; /* Faz todos terem a mesma largura */
    background: rgba(255, 255, 255, 0.05); /* Fundo cinza bem clarinho/transparente */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
}

.btn-perfil-acao:active {
    transform: scale(0.95);
    background: rgba(255, 255, 255, 0.1);
}

/* Texto abaixo do ícone */
.btn-perfil-acao span {
    margin-top: 8px;
    font-size: 11px;
    font-weight: 600;
    color: #ddd;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* O Círculo do Ícone */
.icone-perfil {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Cores dos Ícones */
.icone-perfil.fogo {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.icone-perfil.presente {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
}

.icone-perfil.mapa {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

/* Garante que o Check-in, Resgate e Mapa fiquem ACIMA do Perfil */
#modalCheckIn, 
#modalResgate, 
#modalRastreamento,
#modalPortaSecreta {
    z-index: 15000 !important;
}

/* O perfil fica em 10000, então 15000 garante a sobreposição sem fechar o de baixo */

 </style>
</head>
<body>

<div id="cinematicSplash">
    
    <div class="logo-wrapper">
        <div class="logo-aura"></div>
        <img id="splashLogo" src="/iconeinicial.png" alt="Logo King Agenda">
    </div>

    <div id="splashAppName">KING AGENDA</div>
    <div id="splashSlogan">Where Style Meets Royalty</div>
    
    <div id="splashChecklist">
        <div class="check-item" id="check1"><span>Procurando satélites...</span> <span class="status">Aguarde...</span></div>
        <div class="check-item" id="check2"><span>Conectando ao servidor King...</span> <span class="status">Aguarde...</span></div>
        <div class="check-item" id="check3"><span>Sincronizando dados globais...</span> <span class="status">Aguarde...</span></div>
        <div class="check-item" id="check4"><span>Carregando interface neural...</span> <span class="status">Aguarde...</span></div>
        <div class="check-item" id="check5"><span>Iniciando sistema...</span> <span class="status">Aguarde...</span></div>
    </div>
</div>

<button id="btnPararAlerta" onclick="pararAlertaManual()" class="hidden" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20000; background: #c0392b; color: white; border: 2px solid #fff; padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 0 15px #c0392b; animation: pulse-red 1s infinite;">
    🔕 PARAR ALERTA
</button>

<audio id="sndAlert" src="/alert.mp3" preload="auto"></audio>
<audio id="sndSuccess" src="/success.mp3" preload="auto"></audio>
<audio id="sndPing" src="/ping.mp3" preload="auto"></audio>
<audio id="sndChat" src="/chat.mp3" preload="auto"></audio>


<div id="popupAguarde" class="modal" onclick="fecharAguarde(event)">
  <div class="modal-content">
    <div class="spinner"></div>
    <span id="popupAguardeTexto">Aguarde...</span>
  </div>
</div>

<div id="modalOnboarding" class="modal modal-fullscreen" style="z-index: 99999; background: #000;">
  <div class="modal-content" style="width:100%; height:100%; background: #000; padding:0; border:none;">
    <div id="onboardingContent" style="width:100%; height:100%;"></div>
  </div>
</div>

<div class="topbar" id="topbar">
  <div class="logo" style="font-size: 16px; white-space: nowrap;">King Agenda</div>
  
  <div class="topbar-right">
    <button onclick="abrirModalPerfil()" style="background:none; border:none;">👤</button>
    
    <button id="btnTema" onclick="alternarTema()" style="background:none; border:none;">🌙</button>
    
    <button id="btnConfig" onclick="abrirModal('modalConfiguracoes')" style="background:none; border:none;">⚙️</button>
    
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModalCarteira()">💰 <span id="saldoHeader">0</span></button>
    
  </div>
</div>

<div class="content-container">
  <div id="chatPreview"></div> 
  
  <div id="botaoExtra" class="hidden"></div>
  
  <div id="authView" class="card hidden obsidian-card">
    <div class="auth-brand">KING AGENDA</div>
    <div class="auth-subtitle">Acesso Restrito ao Sistema</div>
    
    <input id="email" type="email" placeholder="E-mail de Acesso">
    <div class="show-password-container">
        <input id="senha" type="password" placeholder="Senha Mestra">
        <span class="show-password-toggle" onclick="togglePasswordVisibility('senha', this)">👁️</span>
    </div>
    
    <div id="cadastro-fields" class="hidden" style="animation: fadeIn 0.5s;">
      
      <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0;"></div>
      <p style="color:var(--cor-destaque); font-size:0.9rem; margin-bottom:10px;">Dados de Registro</p>

      <input id="nomeExibido" type="text" placeholder="Nome Exibido (obrigatório)">
      
      <div class="show-password-container">
        <input id="senha-cadastro" type="password" placeholder="Definir Senha">
      </div>
      <div class="show-password-container">
        <input id="senha-confirm" type="password" placeholder="Confirmar Senha">
      </div>

      <select id="tipo">
        <option value="cliente">🙋 Cliente</option>
        <option value="barbeiro">💈 Barbeiro</option>
        <option value="manicure_pedicure">💅 Manicure/Pedicure</option>
        <option value="designer_cilios">👁️ Designer de Cílios</option>
        <option value="cabelereira">💇 Cabeleireira</option>
        <option value="secretaria">👩‍💼 Secretária / Recepcionista</option>
      </select>

      <div id="proprietario-check-container" class="hidden" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px dashed rgba(212, 175, 55, 0.4); margin-bottom: 10px;">
        <label style="font-size: 13px; color: var(--cor-destaque); display:block; margin-bottom:5px;">VÍNCULO COM O LOCAL</label>
        <select id="isProprietario" style="margin-bottom:5px;">
            <option value="nao">Sou Colaborador / Autônomo</option>
            <option value="sim">Sou o Proprietário (Dono)</option>
        </select>
        <input id="nomeBarbeariaCadastro" type="text" class="hidden" placeholder="Nome do Estabelecimento" style="border-color: var(--cor-destaque);">
      </div>

      <input id="telefone" type="tel" placeholder="Whatsapp (DDD + Número)">
      
      <div id="endereco-container" class="hidden">
          <input id="rua" type="text" placeholder="Endereço (Rua)">
          <input id="numero" type="text" placeholder="Número">
      </div>
  
      <div style="display:flex; gap:10px;">
        <input id="estado" type="text" placeholder="Estado (UF)" oninput="this.value = formatarNomeProprio(this.value)" style="width:30%;">
        <input id="cidade" type="text" placeholder="Cidade" oninput="this.value = formatarNomeProprio(this.value)">
      </div>
      
      <input id="indicador" type="text" placeholder="E-mail de quem indicou (opcional)">
      
      <button onclick="obterLocalizacaoCadastro()" id="btnLocalizacaoCadastro" class="btn-secondary-auth" style="margin-top:5px;">📍 Usar GPS Atual</button>
      
      <button id="btnCriarConta" onclick="criarConta()" style="margin-top: 20px;">CONFIRMAR REGISTRO</button>
      <button id="btnVoltar" onclick="voltarParaLogin()" class="btn-secondary-auth" style="margin-top: 10px;">⬅️ Voltar ao Login</button>
    </div> 

    <div id="botoes-login-inicial">
        <button onclick="entrar()">ENTRAR</button>
        
        <button onclick="prepararCriarConta()" class="btn-secondary-auth" style="margin-top: 15px;">
            Novo aqui? Criar Conta
        </button>
    </div>
    
    <p style="text-align: center; margin-top: 20px;">
        <span onclick="abrirModal('modalEsqueciSenha')" class="auth-forgot-link" style="cursor: pointer;">Recuperar Acesso (Esqueci a Senha)</span>
    </p>
</div> 

<div id="clienteView" class="hidden card">
    <h2>🙋 Painel do Cliente</h2>
    
    <div id="storiesContainer" class="stories-wrapper">
        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
    </div>

    <div id="mapaBtnContainerCliente" style="width: 100%; margin-bottom: 10px;"></div> 
    
    <button onclick="toggleFuncoes('clienteFuncoesContainer')" class="blinking-button closed">⚙️ Funções do Cliente</button>
    
    <div id="clienteFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:45%">📜 Histórico</button>
          <button id="btnVip" onclick="abrirModalVip()" style="width:45%">💎 VIP</button>
          <button onclick="abrirModalCarteira()" style="width:45%">💰 Carteira</button>
          <button onclick="abrirModalFidelidade()" style="width:45%">💎 Meus Pontos</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">📰 Blog</button>
          <button onclick="abrirModalConquistas()" style="width:45%">🏅 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">📊 Ranking</button>
          <button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">🏪 Minha Loja</button>
          <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:45%">🛍️ Minhas Compras</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
    <h2>💈 Painel do Profissional</h2>
    
    <div id="storiesContainerBarbeiro" class="stories-wrapper">
        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
    </div>
    <button id="btnVagaRapida" onclick="toggleVagaImediata()" class="btn-vaga-destaque">
        ⚡ ATIVAR VAGA IMEDIATA
    </button>
    <div id="mapaBtnContainerBarbeiro" style="width: 100%; margin-bottom: 10px;"></div> 
    
    <button onclick="toggleFuncoes('barbeiroFuncoesContainer')" class="blinking-button closed">⚙️ Funções do Profissional</button>
    
    <div id="barbeiroFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button onclick="abrirServicos()" style="width:45%">✂️ Serviços</button>
          <button onclick="abrirAgenda()" style="width:45%">📅 Agenda</button>
          <button id="btnAgendamentosBarbeiro" onclick="abrirAgendamentosBarbeiro()" style="width:45%">⏰ Agendamentos</button>
          <button onclick="abrirClientesBarbeiro()" style="width:45%">🧑‍🤝‍🧑 Clientes</button>
          <button onclick="abrirPromocoes()" style="width:45%">🎁 Promoções</button>
          <button onclick="abrirModalCarteira()" style="width:45%">💰 Carteira</button>
          <button onclick="abrirModalFidelidade()" style="width:45%">💎 Meus Pontos</button>
          <button onclick="abrirHistoricoBarbeiro()" style="width:45%">📜 Histórico</button>
          <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:45%">⭐ Avaliações</button>
          <button onclick="abrirModalPortfolioBarbeiro()" style="width:45%">🖼️ Portfólio</button>
          <button onclick="abrirModal('modalLogomarca')" style="width:45%">🎨 Logomarca</button>
          <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:45%">📍 Alterar Endereço</button>
          <button onclick="abrirModalDashboardBarbeiro()" style="width:45%">🚀 Desempenho</button>
          <button onclick="abrirModalConquistasBarbeiro()" style="width:45%">🏅 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">📊 Ranking</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">📰 Blog</button>
          <button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">🏪 Gerenciar Loja</button>
          <button id="btnMinhasComprasBarbeiro" onclick="abrirMinhasCompras()" style="width:45%">🛍️ Minhas Compras</button>
          <button onclick="abrirModalTurbinar()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b);">🚀 Turbinar Perfil (R$ 9,99)</button>
          <button id="btnVipPro" onclick="abrirModalVipPro()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque-azul), #00c6ff);">🌟 Seja PRO (R$ 29,99/mês)</button>
        </div>
    </div>
     <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalBarbeiro" class="barbeiro-list-container"></div>
  </div>

<div id="emAltaView" class="hidden card" style="padding: 0; background: transparent; box-shadow: none; border: none;">
    <div style="padding: 15px; text-align: center; background: #111; border-bottom: 2px solid var(--cor-destaque); border-radius: 15px 15px 0 0; margin-bottom: 10px;">
        <h2 style="margin: 0; font-size: 20px; color: #fff; text-transform: uppercase; letter-spacing: 2px;">🔥 Em Alta</h2>
        <p style="font-size: 11px; color: var(--cor-destaque); margin: 5px 0 0 0;">As tendências mais votadas dos Profissionais Diamante 💎</p>
    </div>

    <div id="gridEmAlta" class="em-alta-grid" style="padding-bottom: 80px;">
        <div class="spinner" style="margin-top: 50px;"></div>
    </div>
</div>

<div id="modalMapaGeral" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="height: 85vh; width: 95%; max-width: 95%; padding: 0; background: #000; border: 1px solid #444;">
      <div id="mapaGeral"></div>
      
      <button onclick="fecharModalAtual()" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; width: auto; background: rgba(0,0,0,0.8); border: 1px solid var(--cor-destaque); color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; backdrop-filter: blur(5px);">
          ❌ Fechar Mapa
      </button>
    </div>
  </div>

  <div id="adminView" class="hidden card">
    <div id="onlineUserCount" class="online-counter hidden" style="margin: 0 auto 10px auto; cursor: pointer; width: fit-content; display:block;">🏆 0 Online</div>

<div class="card-grafico-container">
    <div class="header-grafico">
        <h3>🏆 Top Profissionais (Cortes)</h3>
        <span class="badge-fidelidade">King Agenda PRO</span>
    </div>
    <div class="canvas-wrapper">
        <canvas id="chartDesempenho"></canvas>
    </div>
</div>
<div class="card-grafico-container financeiro" style="margin-top: 20px; background: rgba(0, 255, 127, 0.05);">
    <div class="header-grafico">
        <h3>💰 Faturamento Play Store (BRL)</h3>
        <span class="badge-fidelidade" style="background: #00ff7f; color: #000;">Extrato Mensal</span>
    </div>
    <div class="canvas-wrapper">
        <canvas id="chartFinanceiro"></canvas>
    </div>
</div>
    <h2>🧠 Painel do Admin</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button onclick="abrirModalEstatisticas()" style="width:45%">📊 Estatísticas</button>
      <button id="btnAdminSolicitacoes" onclick="abrirModalSolicitacoes()" style="width:45%">📥 Solicitações</button>
      <button onclick="abrirModalUsuarios()" style="width:45%">👥 Usuários</button>
      <button id="btnAdminDenuncias" onclick="abrirDenuncias()" style="width:45%">🚨 Denúncias</button>
      <button onclick="abrirModalCarteira()" style="width:45%">💰 Carteira</button>
      <button onclick="abrirGerenciarLojaAdmin()" style="width:45%">🛍️ Gerenciar Loja</button>
      <button onclick="abrirModal('modalBlogAdmin')" style="width:45%">✍️ Publicar Blog</button>
      <button onclick="executarFaxinaGeral()" class="btn-admin-sync">
    🔄 Sincronizar e Limpar Banco
</button>
      
      <button onclick="adminRepopularEmAlta()" style="width:92%; background: linear-gradient(45deg, #00c6ff, #0072ff); margin-top: 10px; border: 1px solid white;">🔄 Forçar Sincronização Em Alta</button>
<button onclick="abrirModal('modalNotificacaoMarketing')" style="width:92%">📣 Enviar Notificação Geral</button>
    </div>
  </div>

<div id="secretariaView" class="hidden card">
    <h2>👩‍💼 Painel da Secretária</h2>
    
    <div id="mapaBtnContainerSecretaria" style="width: 100%; margin-bottom: 10px;"></div> 

    <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom: 20px;">
        <button onclick="switchView('profissionais')" style="width:45%; background: linear-gradient(45deg, #2c3e50, #4ca1af);">👥 Equipe</button>
        <button onclick="abrirAgendaSecretariaDetalhada()" style="width:45%">📅 Agenda Geral</button>
        <button onclick="abrirModalCarteira()" style="width:45%">💰 Carteira</button>
        <button onclick="switchView('emAlta')" style="width:45%">🔥 Em Alta & Stories</button>
        <button onclick="switchView('loja')" style="width:92%">🛍️ Loja</button>
    </div>

    <div id="statusVinculoSecretaria" style="text-align:center; padding:10px; border-radius:10px; background:#222; margin-top:10px;">
        <p style="font-size:12px; color:#aaa; margin:0;">Vinculada a:</p>
        <h3 id="nomeBarbeariaSecretaria" style="margin:5px 0; color:var(--cor-destaque);">Nenhuma Barbearia</h3>
    </div>
</div>

<div id="profissionaisView" class="hidden">
    <div style="text-align:center; margin-bottom: 15px;">
        <h2 style="color:#fff; margin:0;">👥 Gestão da Equipe</h2>
        <p style="font-size:12px; color:#aaa; margin-top:5px;">Toque no horário verde para agendar ou vermelho para ver detalhes.</p>
    </div>

    <button onclick="abrirModalCriarAgendamentoManual()" class="btn-criar-agendamento-top">
        ➕ CRIAR AGENDAMENTO
    </button>

    <div id="containerEquipeVisual">
        <div class="spinner"></div>
    </div>
</div>

<div id="horariosView" class="hidden">
    <h2 style="color:#d4af37; text-align:center;">📅 Meus Horários</h2>
    <div id="containerMeusHorariosVisual" style="margin-top:15px;"></div>
</div>

<div id="minhaAgendaView" class="hidden">
    <div style="text-align:center; margin-bottom: 15px;">
        <h2 style="color:#fff; margin:0;">📅 Agenda</h2>
        <p style="font-size:12px; color:#aaa; margin-top:5px;">Gerencie seus horários e atendimentos.</p>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:15px; padding:0 10px;">
        <div style="flex:1; background:#222; padding:10px; border-radius:10px; text-align:center; border:1px solid #333;">
            <span style="color:#2ecc71; font-weight:bold; font-size:18px;" id="contadorLivres">0</span>
            <div style="font-size:10px; color:#aaa;">Livres</div>
        </div>
        <div style="flex:1; background:#222; padding:10px; border-radius:10px; text-align:center; border:1px solid #333;">
            <span style="color:#e74c3c; font-weight:bold; font-size:18px;" id="contadorOcupados">0</span>
            <div style="font-size:10px; color:#aaa;">Agendados</div>
        </div>
    </div>

    <div id="containerMinhaAgendaGrid">
        <div class="spinner"></div>
    </div>
</div>

<div id="modalDetalhesAgendamento" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center; max-width: 350px;">
    
    <div style="position:relative; display:inline-block; margin-bottom:10px;">
        <img id="detalheClienteFoto" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--cor-destaque); background:#333;">
        <div id="detalheClienteBadge" style="position:absolute; bottom:0; right:0; background:#2ecc71; color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">CLIENTE</div>
    </div>

    <h3 id="detalheClienteNome" style="margin:0; color:#fff;">Carregando...</h3>
    <p id="detalheClienteFone" style="font-size:12px; color:#aaa; margin-bottom:15px;">(xx) xxxxx-xxxx</p>

    <div style="background:#1a1a1a; padding:15px; border-radius:12px; text-align:left; margin-bottom:15px; border:1px solid #333;">
        <p style="margin:5px 0;">💈 <b>Profissional:</b> <span id="detalheNomeProfissional" style="color:#fff;">...</span></p>
        <p style="margin:5px 0;">✂️ <b>Serviço:</b> <span id="detalheServico" style="color:var(--cor-destaque)">...</span></p>
        <p style="margin:5px 0;">⏰ <b>Horário:</b> <span id="detalheHorario" style="color:#fff;">...</span></p>
        <p style="margin:5px 0;">💰 <b>Valor:</b> <span id="detalheValor" style="color:#2ecc71;">...</span></p>
        <p style="margin:5px 0;">📝 <b>Status:</b> <span id="detalheStatus">...</span></p>
    </div>

    <div style="display:flex; flex-direction:column; gap:10px;">
        
        <button id="btnAbrirRotaDetalhe" style="background: linear-gradient(45deg, #00c6ff, #0072ff); color:white; font-weight:bold; width:100%; border:1px solid white; display:none;">
            🗺️ ABRIR ROTA / MAPA
        </button>

        <button id="btnConcluirAgenda" style="background: linear-gradient(45deg, #2ecc71, #27ae60); color:#000; font-weight:bold; width:100%; border:none;">
            ✅ CONCLUIR E RECEBER
        </button>
        
        <div style="display:flex; gap:10px;">
            <button id="btnChamarWpp" style="background:#25D366; flex:1; border:none;">💬 WhatsApp</button>
            <button id="btnCancelarAgenda" style="background:#c0392b; flex:1; border:none;">❌ Cancelar</button>
        </div>
    </div>
    
    <button onclick="fecharModalAtual()" style="margin-top:15px; background:transparent; color:#888; font-size:12px;">Fechar</button>

  </div>
</div>

<div id="modalCriarAgendamentoManual" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 90vh; overflow-y: auto;">
    <h3 style="color:var(--cor-destaque); text-align:center;">📝 Novo Agendamento (Balcão)</h3>
    
    <label style="font-size:12px; color:#aaa;">Profissional:</label>
    <select id="manualProfissionalUid" class="input-padrao" onchange="atualizarOpcoesAgendamentoManual(this.value); window.uidBarberBalcao = this.value;" style="background:#222; border:1px solid #444; color:#fff; padding:10px; border-radius:8px; width:100%; margin-bottom:10px;">
        <option value="">Carregando equipe...</option>
    </select>

    <label style="font-size:12px; color:#aaa;">Nome do Cliente:</label>
    <input type="text" id="manualClienteNome" placeholder="Ex: João da Silva" style="background:#222; border:1px solid #444; color:#fff;">

    <label style="font-size:12px; color:#aaa;">Telefone do Cliente (Obrigatório):</label>
    <input type="tel" id="manualClienteTelefone" placeholder="(XX) 9XXXX-XXXX" oninput="this.value = this.value.replace(/[^0-9]/g, '')" style="background:#222; border:1px solid #444; color:#fff;">

    <label style="font-size:12px; color:#aaa;">Serviço:</label>
    <select id="manualServico" class="input-padrao" style="background:#222; border:1px solid #444; color:#fff; padding:10px; border-radius:8px; width:100%; margin-bottom:10px;">
        <option value="">Aguarde...</option>
    </select>
    
    <label style="font-size:12px; color:#aaa; margin-top:10px; display:block;">Horário Selecionado:</label>
    
    <input type="hidden" id="manualHorarioHidden">
    <input type="text" id="manualHorarioVisual" readonly placeholder="Selecione abaixo ou na grade..." style="background:#111; border:1px solid var(--cor-destaque); color:var(--cor-destaque); font-weight:bold; text-align:center; margin-bottom:10px;">

    <div id="displayHorarioSelecionado" class="hidden"></div> 

    <div id="containerHorariosManual" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 150px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333;">
        <p style="grid-column: 1/-1; text-align:center; font-size:12px; color:#777;">Selecione um profissional acima.</p>
    </div>

    <button onclick="window.uidBarberBalcao = document.getElementById('manualProfissionalUid').value; salvarAgendamentoManual()" style="width:100%; margin-top:15px; background: linear-gradient(45deg, #2ecc71, #27ae60); font-weight:bold; color:#000; padding:15px; border-radius:8px; border:none;">
        ✅ CONFIRMAR AGENDAMENTO
    </button>
    <button onclick="fecharModalAtual()" style="width:100%; margin-top:10px; background:#333; color:#fff; border:none; padding:10px; border-radius:8px;">Cancelar</button>
  </div>
</div>

  <div id="lojaView" class="hidden card">
    <div class="card-header">
        <h3>🛍️ Loja King Agenda</h3>
    </div>
    <div id="lojaContainer" class="loja-grid">
    </div>
  </div>
</div>


</div>

<div class="bottom-buttons-container hidden" id="bottomButtons">
  <button id="btnSair" onclick="fazerLogout()">🚪</button>
  <button id="btnDenuncia" onclick="abrirModal('modalDenuncia')">🚨</button>
</div>
<button id="btnResetAudio" class="hidden" onclick="resetarAudioManual()" style="position: fixed; bottom: 80px; right: 20px; z-index: 1000; background: rgba(0,0,0,0.6); border: 1px solid var(--cor-destaque); border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
    🔔
</button>

<button id="btnChat" class="hidden" onclick="abrirChatGlobal()">
    <span>💬</span>
    <span class="notification-badge hidden">0</span>
</button>

<button id="btnSair" class="hidden" onclick="fazerLogout()">🚪 Sair</button>

<div id="modalConfiguracoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⚙️ Configurações</h3>

    <div class="scrollable-list"> 

        <div class="popup-section config-section">
          <h4>❤️ Meu Interesse Principal</h4>
          <p style="font-size: 12px; opacity: 0.7;">Ao mudar, o app será recarregado.</p>
          <div id="configInteresseContainer" style="display:flex; gap:10px; flex-wrap: wrap; justify-content: center;">
              <button data-interesse="barbeiro" style="flex: 1; min-width: 120px; padding: 15px;">
                  💈 Barbearias<br><span style="font-size:10px; opacity:0.7">Modo Masculino</span>
              </button>
              
              <button data-interesse="cabelereira" style="flex: 1; min-width: 120px; padding: 15px;">
                  💇 Cabelereira<br><span style="font-size:10px; opacity:0.7">Modo Feminino</span>
              </button>
          </div>
        </div>

        <div class="popup-section">
          <h4>Conta</h4>
          <button onclick="abrirModalAlterarSenha()">🔑 Alterar Senha</button>
          <button onclick="solicitarAlteracaoCidade()">🏙️ Solicitar Alteração de Cidade</button>
        </div>

        <div class="popup-section">
            <h4>🛍️ Loja de Vendedores</h4>
            <button id="btnSolicitarAcessoLoja" class="hidden" onclick="abrirModal('modalSolicitarLoja')">Quero Vender Meus Produtos</button>
            <p id="msgLojaJaLiberada" class="hidden" style="font-size: 14px; opacity: 0.8;">Você já tem acesso para gerenciar seus produtos na loja.</p>
        </div>

        <div class="popup-section">
          <h4>⚖️ Legal</h4>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="abrirModal('modalTermosUso')">Termos de Uso</button>
            <button onclick="abrirModal('modalTermosPrivacidade')">Termos de Privacidade</button>
            <button onclick="abrirModal('modalTermosCookies')">Termos de Cookies</button>
          </div>
        </div>

        <div class="popup-section hidden" id="secaoVirarProfissional">
          <h4>🚀 Evoluir Conta</h4>
          <button onclick="solicitarVirarProfissional()" style="background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b); color: var(--cor-fundo);">Quero ser um Profissional</button>
        </div>

        <div class="popup-section">
          <h4>🔒 Encerrar Conta</h4>
          <button onclick="prepararDeletarConta()" style="background-color: #c0392b; border: 1px solid #e74c3c;">Excluir Minha Conta Permanentemente</button>
        </div>
         
         <div class="popup-section footer-contact" style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-borda);">
            <p style="font-size: 12px; margin-bottom: 8px;">
                 <a href="https://wa.me/5527995003737" target="_blank" class="animated-contact-link">
                     <span class="animated-gradient-text">📞 (27) 99500-3737</span>
                 </a>
            </p>
            <p style="font-size: 12px; margin: 0;">
                 <a href="mailto:"kingagendamentossuporte@gmail.com" class="animated-contact-link">
                     <span class="animated-gradient-text">📧 kingagendamentossuporte@gmail.com</span>
                 </a>
            </p>
        </div>

    </div> 

    <button data-modal-id="modalConfiguracoes" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalTermosUso" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Termos de Uso</h3>
    <p class="scrollable-list">
      Bem-vindo ao King Agenda! Ao usar nosso aplicativo, você concorda em seguir nossas regras de conduta, respeitar outros usuários e profissionais, e usar a plataforma para os fins a que se destina. Violações podem resultar na suspensão da conta.
    </p>
    <button data-modal-id="modalTermosUso" onclick="fecharModal(event)">Fechar</button>
  </div>
</div>

<div id="modalTermosPrivacidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Termos de Privacidade</h3>
    <p class="scrollable-list">
      Sua privacidade é importante. Coletamos dados como nome, e-mail e localização para fornecer e melhorar nossos serviços. Não compartilhamos seus dados pessoais com terceiros sem seu consentimento, exceto quando exigido por lei.
    </p>
    
    <p style="margin-top: 15px; text-align: center;">
        <a href="/privacidade.html" target="_blank" style="color: var(--cor-destaque); text-decoration: underline; font-weight: bold; font-size: 14px;">
            Ler Política de Privacidade Completa
        </a>
    </p>

    <button data-modal-id="modalTermosPrivacidade" onclick="fecharModal(event)">Fechar</button>
  </div>
</div>

<div id="modalTermosCookies" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Termos de Cookies</h3>
    <p class="scrollable-list">
      Utilizamos cookies e tecnologias semelhantes para manter sua sessão ativa, lembrar suas preferências e garantir o funcionamento do aplicativo. Ao continuar usando o King Agenda, você concorda com nosso uso de cookies.
    </p>
    <button data-modal-id="modalTermosCookies" onclick="fecharModal(event)">Fechar</button>
  </div>
</div>

<div id="modalCarteira" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Minha Carteira</h3>
    <p>Seu saldo atual é: <b style="color: var(--cor-destaque);">R$ <span id="saldoModal">0,00</span></p>
    <button onclick="window.iniciarDeposito()">📥 Depositar</button>
    <button onclick="window.solicitarSaque()">📤 Sacar</button>
    <button onclick="modalCarteira" style="margin-top: 15px; background:#333; width:100%; padding:12px; border-radius:8px; font-weight:bold; color:#fff;">❌ Fechar </button>
  </div>
</div>

<div id="modalDepositoPlayStore" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Adicionar Saldo (Play Store)</h3>
    <p>Selecione um valor para adicionar à sua carteira com segurança através do Google Play.</p>
    
    <div class="metodos-grid" style="margin-top: 10px;">
        <button onclick="comprarComPlayStore('deposito_10', 10.00)">
            Adicionar R$ 10,00
        </button>
        <button onclick="comprarComPlayStore('deposito_25', 25.00)">
            Adicionar R$ 25,00
        </button>
        <button onclick="comprarComPlayStore('deposito_50', 50.00)">
            Adicionar R$ 50,00
        </button>
         <button onclick="comprarComPlayStore('deposito_100', 100.00)">
            Adicionar R$ 100,00
        </button>
    </div>
    
    <button data-modal-id="modalDepositoPlayStore" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Voltar</button>
  </div>
</div>

<div id="modalPacotesMoedasTWA" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="color: #00c6ff;">💎 Loja de Moedas</h3>
    <p style="font-size:12px; color:#aaa;">Compra segura via Google Play para itens digitais (VIP, Boost, etc).</p>
    
    <div class="metodos-grid" style="margin-top: 15px;">
        <button onclick="comprarComPlayStore('moedas_10', 10.00)" style="background: #222; border: 1px solid #00c6ff; color: #fff;">
            10 Moedas - R$ 10,00
        </button>
        <button onclick="comprarComPlayStore('moedas_50', 50.00)" style="background: #222; border: 1px solid #00c6ff; color: #fff;">
            50 Moedas - R$ 50,00
        </button>
        <button onclick="comprarComPlayStore('moedas_100', 100.00)" style="background: #222; border: 1px solid #00c6ff; color: #fff;">
            100 Moedas - R$ 100,00
        </button>
    </div>
    <p style="font-size:10px; margin-top:10px; opacity:0.6; text-align: center;">1 Moeda (R$) = R$ 1,00 em poder de compra digital.</p>
    <button data-modal-id="modalPacotesMoedasTWA" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDepositoFormulario" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📝 Informações para Depósito</h3>
    <p>Preencha seus dados para continuar.</p>
    <input id="depositoPrimeiroNome" type="text" placeholder="Primeiro Nome">
    <input id="depositoSegundoNome" type="text" placeholder="Segundo Nome">
    <input id="depositoCpf" type="text" placeholder="CPF">
    <input id="depositoTelefone" type="tel" placeholder="Telefone com DDD">
    <input id="depositoValor" type="number" placeholder="💰 Valor a depositar (Ex: 50.00)">
    <button id="btnContinuarDeposito" onclick="criarSolicitacaoDeposito()" disabled>Continuar</button>
    <button data-modal-id="modalDepositoFormulario" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Alterar Senha</h3>
    <p style="font-size: 14px;">Para sua segurança, digite sua senha atual e a nova senha desejada.</p>
    <div class="show-password-container">
      <input id="senhaAtual" type="password" placeholder="Senha Atual">
      <span class="show-password-toggle" onclick="togglePasswordVisibility('senhaAtual', this)">👁️</span>
    </div>
     <div class="show-password-container">
      <input id="novaSenha" type="password" placeholder="Nova Senha (mínimo 6 caracteres)">
       <span class="show-password-toggle" onclick="togglePasswordVisibility('novaSenha', this)">👁️</span>
    </div>
     <div class="show-password-container">
      <input id="confirmarNovaSenha" type="password" placeholder="Confirmar Nova Senha">
       <span class="show-password-toggle" onclick="togglePasswordVisibility('confirmarNovaSenha', this)">👁️</span>
    </div>
    <button onclick="executarAlteracaoSenha()">✅ Salvar Nova Senha</button>
    <button data-modal-id="modalAlterarSenha" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalDeposito" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Depósito de Créditos</h3>
    <p>Escolha um método de pagamento para adicionar saldo à sua carteira.</p>
    <div class="metodos-grid">
        <button id="btnPagarComPix" onclick="processarPagamentoPixAprimorado()">⚡ PIX (QR Code)</button>
        <button id="btnPagarComCartao" onclick="abrirModalTaxaCartao()">💳 Cartão de Crédito</button>
    </div>
    <button data-modal-id="modalDeposito" onclick="fecharModal(event)">❌ Voltar</button>
  </div>
</div>

<div id="modalCriarAntesDepois" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📸 Criar Antes & Depois</h3>
    <p>Selecione duas fotos para mostrar a transformação.</p>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div style="flex:1;">
            <label style="font-size:12px;">Foto ANTES</label>
            <input id="fileAntes" type="file" accept="image/*" onchange="previewBA(this, 'previewImgAntes')">
            <img id="previewImgAntes" src="https://placehold.co/150?text=Antes" style="width:100%; height:100px; object-fit:cover; border-radius:8px; margin-top:5px;">
        </div>
        <div style="flex:1;">
            <label style="font-size:12px;">Foto DEPOIS</label>
            <input id="fileDepois" type="file" accept="image/*" onchange="previewBA(this, 'previewImgDepois')">
            <img id="previewImgDepois" src="https://placehold.co/150?text=Depois" style="width:100%; height:100px; object-fit:cover; border-radius:8px; margin-top:5px;">
        </div>
    </div>

    <button onclick="salvarAntesDepois()">💾 Salvar no Portfólio</button>
    <button data-modal-id="modalCriarAntesDepois" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalTaxaCartao" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3>⚠️ Taxa de Plataforma</h3>
        <p style="font-size: 14px;">Para garantir a transparência e a segurança da sua transação com cartão de crédito, informamos que há uma taxa administrativa fixa cobrada pela plataforma de pagamentos.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
           <button onclick="fecharModalAtual()" style="background-color: #555;">Cancelar</button>
           <button onclick="processarPagamentoCartaoAprimorado()">Continuar</button>
        </div>
    </div>
</div>


<div id="modalGerandoQRCode" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: var(--cor-destaque);">Gerando QR CODE</h3>
        <p>Aguarde um instante...</p>
    </div>
</div>

<div id="modalCarregandoGenerico" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 id="carregandoGenericoTitulo" style="color: var(--cor-destaque);">Aguarde...</h3>
        <p id="carregandoGenericoTexto">Estamos processando sua solicitação.</p>
    </div>
</div>

<div id="modalExibirPixAprimorado" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h3 style="color:var(--cor-destaque)">Pague com PIX</h3>
      
      <p style="font-size:14px; margin-bottom:5px; color:#aaa;">Dados do Recebedor:</p>
      <p style="font-size:16px; margin-bottom:15px; color:#fff;">Josiel Lopes Azeredo</p>
      
      <img src="https://i.postimg.cc/fTZyFN6G/qrcode.jpg" id="pix-qrcode" alt="QR Code PIX" style="max-width:200px; border-radius:10px; border:5px solid #fff;">
      
      <div class="pix-copia-cola-container" style="margin-top:15px;">
          <textarea id="pixChaveAleatoria" style="position:absolute; left:-9999px;">18912553712</textarea>
          
          <p id="pixChaveDisplay" style="font-size:18px; font-weight:bold; letter-spacing:1px; background:#222; padding:10px; border-radius:8px; border:1px dashed #555; user-select: text;">18912553712</p>
          
          <button onclick="copiarCodigoPixAprimorado(event)" style="background:var(--cor-destaque); color:black; font-weight:bold; width:100%;">Copiar Chave PIX</button>
      </div>
      
      <p style="font-size: 14px; color: #ff9800; margin-top: 15px;">Expira em: <b id="pixTimer">10:00</p>

      <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
          <p style="font-size:12px; color:#aaa;">Já fez o pagamento? Avise o suporte:</p>
          <button onclick="window.open('https://wa.me/5527995003737?text=Ola%20fiz%20um%20deposito%20no%20app!', '_blank')" style="background:#25D366; width:100%; border:none;">💬 Enviar Comprovante</button>
      </div>
      
      <button onclick="fecharTodosOsModais()" style="margin-top:10px; background:#555;">Fechar Janela</button>
    </div>
</div>

<div id="modalPixExpirado" class="modal" style="z-index: 22;">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: #e74c3c;">Tempo Expirado!</h3>
        <p>O tempo para pagamento deste PIX acabou.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
            <button onclick="fecharTodosOsModais()" style="background: #555;">Fechar</button>
            <button onclick="tentarGerarPixNovamente()">Tentar Novamente</button>
        </div>
    </div>
</div>

<div id="modalSaque" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📤 Solicitar Saque</h3>
    <p>O valor será transferido após análise.</p>
    
    <input id="saqueNomeCompleto" type="text" placeholder="Nome Completo do Titular">
    <input id="saqueValor" type="number" placeholder="Valor do saque (R$)">
    
    <select id="saqueChavePixTipo">
      <option value="">Tipo de Chave PIX</option>
      <option value="cpf">CPF</option>
      <option value="email">E-mail</option>
      <option value="telefone">Telefone</option>
      <option value="aleatoria">Aleatória</option>
    </select>
    <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
    
    <button id="btnConfirmarSaque" onclick="confirmarSaque()">✅ Confirmar Saque</button>
    <button data-modal-id="modalSaque" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalSaqueConfirmado" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>✅ Solicitação Enviada!</h3>
    <p>Sua solicitação de saque foi enviada para análise.</p>
    <p style="font-size:14px; opacity: 0.8;">Para agilizar, entre em contato com o administrador.</p>
    <button onclick="contatarAdminSaque()">OK</button>
  </div>
</div>

<div id="janelaChat" class="modal fullscreen" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="chat-tabs">
        <div class="chat-tab active" id="tabChatGlobal" onclick="alternarChat('global')">🌎 Global</div>
        <div class="chat-tab" id="tabChatLocal" onclick="alternarChat('local')">📍 Local</div>
    </div>
    <button id="carregarMaisMsgBtn" onclick="carregarMensagensAnteriores()">Ver mensagens anteriores</button>
    <h3 id="chatTitle">💬 Chat Global</h3>
    <div id="chatMessages" class="chat-container"></div>
    <input id="chatInput" placeholder="Digite sua mensagem">
    <button onclick="enviarMensagem()">➡️ Enviar</button>
    <button data-modal-id="janelaChat" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="adminChatSelectorContainer" class="hidden" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 5px; background: var(--cor-botoes); border-radius: 8px;">
    <select id="adminChatEstado" onchange="adminCarregarCidadesChat()"></select>
    <select id="adminChatCidade" onchange="adminRecarregarChat()"></select>
</div>

<div id="modalDenuncia" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚨 Denunciar</h3>
    <p>Envie sua mensagem e o administrador responderá em breve!</p>
    <textarea id="textoDenuncia" placeholder="Descreva o problema em detalhes"></textarea>
    <button onclick="enviarDenuncia()">➡️ Enviar</button>
    <button data-modal-id="modalDenuncia" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDenunciaEnviada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✅ Denúncia Enviada!</h3>
    <p>Agradecemos a sua denúncia. Ela será analisada pela nossa equipe.</p>
    <p>💬 Se preferir, clique no botão abaixo para avisar o administrador diretamente no WhatsApp e agilizar o processo.</p>
    <a id="btnWhatsappDenuncia" href="#" target="_blank">
      <button>💬 Avisar no WhatsApp</button>
    </a>
    <button data-modal-id="modalDenunciaEnviada" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBlog" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📰 Blog</h3>
    <div id="listaBlog" class="scrollable-list"></div>
    <button data-modal-id="modalBlog" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalVip" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipContentContainer">
    </div>
    <button data-modal-id="modalVip" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalVipPro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipProContentContainer">
      </div>
    <button data-modal-id="modalVipPro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalFidelidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏆 Programa de Fidelidade</h3>
    <p>Seus pontos: <b id="pontosFidelidade">0</p>
    <p style="font-size: 14px; color: var(--cor-destaque-prata);">Acumule pontos em cada agendamento e troque por descontos!</p>
    <button onclick="resgatarPontos()">🎁 Resgatar 100 pontos por R$ 5,00</button>
    <button data-modal-id="modalFidelidade" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBarbeiroPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="barbeiroPerfilHeader">
      <h3 id="barbeiroPerfilNome"></h3>
      <p>Endereço: <span id="barbeiroPerfilEndereco"></span></p>
      <p>Reputação: <span id="barbeiroPerfilReputacao"></span></p>
      <img id="profissionalLogo" src="" alt="Logomarca" style="max-width: 100px; border-radius: 50%; display: none; margin: 10px auto;">
    </div>

    <div id="barbeiroPerfilServicos" class="popup-section">
      <h4>1. Escolha um Serviço</h4>
      <div id="barbeiroPerfilServicosList" class="scrollable-list" style="max-height: 150px;"></div>
    </div>

    <div id="barbeiroPerfilHorarios" class="popup-section">
      <h4>2. Escolha uma Opção</h4>
      <div id="barbeiroPerfilHorariosList"></div>
    </div>

    <div class="modal-footer">
      <button id="btnAcessarPortfolio" class="hidden" style="width: auto; background-color: var(--cor-botoes);">🖼️ Ver Portfólio</button>
      <button id="btnAbrirRota" class="hidden" style="width: auto; background-color: var(--cor-botoes);">🗺️ Rota</button>
      <button id="btnConfirmarAgendamento" disabled>🗓️ Agendar</button>
    </div>
    <button data-modal-id="modalBarbeiroPerfil" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>
<div id="modalVagaImediataAprovada" class="modal" style="z-index: 99;" onclick="fecharModal(event)">
  <div class="modal-content" style="background: #e74c3c; color: white;" onclick="event.stopPropagation()">
    <h3 style="color:white;text-shadow: 2px 2px 4px #000;">⚠️ VAGA IMEDIATA APROVADA!</h3>
    <p style="font-size: 1.2em; text-align: center;">Você tem 10 minutos para chegar ao local.</p>
    <p style="text-align: center;">Não se atrase para não perder a vaga e o seu dinheiro!</p>
    <div style="display:flex; gap: 10px; margin-top: 20px;">
      <button data-modal-id="modalVagaImediataAprovada" onclick="fecharModal(event)" style="background:white; color:#e74c3c; flex: 1;">✅ Entendi</button>
      <button id="btnCancelarVagaAprovada" style="background: #333; color: white; flex: 1;">❌ Cancelar Agendamento</button>
    </div>
  </div>
</div>

<div id="modalDetalhesEmAlta" class="modal" style="z-index: 14000;">
    <div class="modal-content" style="max-width: 500px; height: 100%; max-height: 100%; border-radius: 0; padding: 0; display: flex; flex-direction: column; background: #000;">
        
        <div style="flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000;">
             <img id="imgDetalheAlta" src="" style="width: 100%; max-height: 100%; object-fit: contain;">
             
             <button onclick="fecharModalAtual()" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 40px; height: 40px; border: none; font-size: 18px; z-index: 10;">✕</button>
        </div>

        <div style="background: #111; padding: 20px; border-top: 1px solid #333;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                
                <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" id="divInfoProfAlta">
                    <img id="fotoProfDetalheAlta" src="" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid #00c6ff; object-fit: cover;">
                    <div>
                        <b id="nomeProfDetalheAlta" style="color: #fff; font-size: 15px; display: block;">Nome
                        <span style="font-size: 11px; color: #00c6ff; background: rgba(0, 198, 255, 0.1); padding: 2px 6px; border-radius: 4px;">💎 Diamante</span>
                    </div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="text-align: center; cursor: pointer;" onclick="darLikeEmAlta()">
                        <span style="font-size: 24px;">❤️</span>
                        <span id="countLikesAlta" style="display: block; font-size: 10px; color: #fff;">0</span>
                    </div>
                    <div style="text-align: center; cursor: pointer;" onclick="compartilharEmAlta()">
                        <span style="font-size: 24px;">🚀</span>
                        <span style="display: block; font-size: 10px; color: #fff;">Share</span>
                    </div>
                </div>
            </div>

            <button id="btnAgendarAlta" style="width: 100%; background: linear-gradient(45deg, #00c6ff, #0072ff); color: white; font-weight: bold; padding: 15px; border-radius: 12px; font-size: 16px; border: none; box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);">
                📅 AGENDAR AGORA
            </button>
        </div>
    </div>
</div>

<div id="modalBarbeariasCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💈 Profissionais Disponíveis</h3>
    <input type="text" id="filtroBarbeiro" onkeyup="filtrarBarbeiros()" placeholder="🔎 Buscar por profissional ou cidade...">
    
    <button id="btnMostrarFavoritos" 
            onclick="alternarFiltroFavoritos()" 
            class="btn-favoritos-estilo estilo-gold" 
            style="width:100%; margin-bottom:10px;">
        ⭐ Mostrar Apenas Favoritos
    </button>

    <div id="listaBarbeirosPrincipalModal" class="barbeiro-list-container scrollable-list"></div>
    
    <button data-modal-id="modalBarbeariasCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalHistoricoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📜 Meu Histórico</h3>
    <div id="painelHistorico" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalConquistas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏅 Minhas Conquistas</h3>
    <div id="listaConquistas" class="scrollable-list"></div>
    <button data-modal-id="modalConquistas" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalRankingUnificado" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏆 Ranking Geral 🏆</h3>
    <p style="font-size: 12px; opacity: 0.7; text-align:center;">Top 100 com mais serviços concluídos.</p>
    <div id="listaRankingUnificado" class="scrollable-list"></div>
    <button data-modal-id="modalRankingUnificado" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Fechar</button>
  </div>
</div>

<div id="modalConfirmacaoGenerica" class="modal" style="z-index: 25;">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
    <h3 id="confirmacaoGenericaTitulo" style="margin-top: 0;"></h3>
    <p id="confirmacaoGenericaMensagem" style="margin-bottom: 20px;"></p>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="btnConfirmacaoGenericaNao" style="background-color: #555; flex-grow: 1;">Não</button>
        <button id="btnConfirmacaoGenericaSim" style="flex-grow: 1;">Sim</button>
    </div>
  </div>
</div>

<div id="modalCriarPromocao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🎁 Criar Promoção</h3>
    <input id="promocaoNome" placeholder="Nome da Promoção">
    <input id="promocaoDescricao" placeholder="Descrição curta">
    <input type="number" id="promocaoDesconto" placeholder="Desconto em % (ex: 15)">
    <button onclick="criarPromocao()">💾 Salvar Promoção</button>
    <button data-modal-id="modalCriarPromocao" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalLogomarca" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🎨 Adicionar Logomarca (1 Imagem)</h3>
    <p style="font-size: 12px; opacity: 0.8;">Selecione uma imagem ou GIF do seu dispositivo.</p>
    <input id="logomarcaFile" type="file" accept="image/*,image/gif">
    <img id="logomarcaPreview" src="#" alt="Preview" style="max-width: 100px; max-height: 100px; margin-top: 10px; display: none; border-radius: 50%; object-fit: cover;">
    <progress id="logoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 10px;"></progress>
    <button id="btnSalvarLogo" onclick="salvarLogomarca()" disabled>💾 Salvar Logomarca</button>
    <button data-modal-id="modalLogomarca" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarEnderecoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📍 Alterar Endereço</h3>
    <input id="novoEnderecoRua" type="text" placeholder="Nova Rua">
    <input id="novoEnderecoNumero" type="text" placeholder="Novo Número">
    <button onclick="obterLocalizacaoCadastro('barbeiro')">📍 Usar minha localização atual</button>
    <button onclick="alterarEnderecoBarbeiro(event)">💾 Salvar</button>
    <button data-modal-id="modalAlterarEnderecoBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAvaliacoes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>⭐ Minhas Avaliações</h3>
        <div id="listaAvaliacoesModal" class="scrollable-list"></div>
        <button data-modal-id="modalAvaliacoes" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalServicosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✂️ Meus Serviços</h3>
    <div id="listaServicosBarbeiro" class="scrollable-list"></div>
    <button onclick="adicionarServico()">➕ Adicionar novo serviço</button>
    <button data-modal-id="modalServicosBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAgendaBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div style="flex-shrink: 0; border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px; margin-bottom: 10px;">
        <h3 style="margin:0;">📅 Gerenciar Agenda</h3>
    </div>

    <div id="agendaScrollContent">
        <p style="font-size: 12px; margin-bottom: 15px;">Configure como você quer receber agendamentos.</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <button id="btnDisponibilidade" onclick="toggleDisponibilidade()">Carregando...</button>
            <button id="btnVagaImediata" onclick="toggleVagaImediata()">Carregando...</button>
            <button id="btnAgendaManual" onclick="toggleAgendaManual()">Carregando...</button>
            <button id="btnModoFerias" onclick="abrirModal('modalModoFerias')" style="background: linear-gradient(45deg, #e57373, #c0392b);">🏖️ Modo Férias / Ausência</button>
        </div>

        <div id="agendaManualPainel" class="hidden" style="border-top: 1px solid var(--cor-borda); padding-top: 10px;">
            <h4>Horários Fixos</h4>
            <p style="font-size: 12px;">Clique para liberar (Dourado) ou bloquear (Riscado).</p>
            <div id="horariosContainer"></div>
            <div class="horarios-actions" style="margin-top: 10px;">
                <button onclick="salvarAgendaManual()" style="width: 100%;">💾 Salvar Horários</button>
            </div>
        </div>
    </div>

    <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)" style="margin-top: 15px; background: #444; flex-shrink: 0;">❌ Fechar</button>
  </div>
</div>

<div id="modalOnboardingProfissionalServicos" class="modal"><div class="modal-content"><h3>1. Cadastre seus Serviços</h3><p>Adicione pelo menos um serviço para continuar.</p><div id="onboardingServicosList" class="scrollable-list"></div><input id="onboardingServicoNome" placeholder="Nome do Serviço"><input id="onboardingServicoValor" type="number" placeholder="Valor (R$)"><input id="onboardingServicoTempo" type="number" placeholder="Tempo (minutos)"><button onclick="adicionarServicoOnboarding()">Adicionar Serviço</button><button id="btnOnboardingNextServicos" disabled onclick="avancarOnboarding(2)">Próximo ➡️</button></div></div>


<div id="modalAgendamentosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⏰ Meus Agendamentos</h3>
    <div id="agendamentosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalAgendamentosBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalClientesBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🧑‍🤝‍🧑 Meus Clientes</h3>
    <p>Lista de clientes que já agendaram com você.</p>
    <div id="listaClientesBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalClientesBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDashboardBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Financeiro da Equipe</h3>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px; text-align: center;">
        <div style="flex: 1; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444;">
            <span style="font-size: 12px; color: #aaa;">Hoje</span>
            <div id="dashServicosHoje" style="font-size: 18px; font-weight: bold; color: var(--cor-destaque);">0</div>
            <span style="font-size: 10px;">Serviços</span>
        </div>
        <div style="flex: 1; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444;">
            <span style="font-size: 12px; color: #aaa;">Faturamento (Mês)</span>
            <div id="dashSaldoTotal" style="font-size: 18px; font-weight: bold; color: #2ecc71;">R$ 0,00</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="financeiroChart"></canvas>
    </div>

    <div id="metaContainer" class="meta-container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:14px; font-weight:bold; color:#fff;">🎯 Meta Mensal</span>
            <button onclick="definirMetaFinanceira()" style="width:auto; padding:4px 8px; font-size:10px; background:#444;">✏️ Editar</button>
        </div>
        
        <div class="meta-barra-fundo">
            <div id="metaBarraProgresso" class="meta-barra-progresso"></div>
        </div>
        
        <div class="meta-texto">
            <span id="metaAtual">R$ 0,00</span>
            <span id="metaAlvo">Alvo: R$ 0,00</span>
        </div>
        <p id="metaMensagem" style="font-size:11px; margin-top:5px; color:var(--cor-destaque);"></p>
    </div>

    <div id="dashboardConteudo" class="scrollable-list" style="margin-top: 15px; max-height: 100px;"></div>
    
    <button data-modal-id="modalDashboardBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalRastreamento" class="modal" style="z-index: 20000;">
  <div class="modal-content" style="height: 90vh; width: 95%; max-width: 600px; padding: 0; background: #000; border: 2px solid var(--cor-destaque); position: relative; display: flex; flex-direction: column;">
    
    <div id="mapaRastreamento" style="flex-grow: 1; width: 100%; background-color: #242f3e;"></div>
    
    <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--cor-destaque); text-align: center; width: 80%; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        <h4 style="margin:0; color: var(--cor-destaque); font-size: 16px;">📍 A Caminho</h4>
        <p id="statusRastreamentoTexto" style="margin:5px 0 0 0; font-size: 12px; color: #ccc;">Aguardando localização...</p>
    </div>

    <div id="botoesRastreamentoContainer" style="position: absolute; bottom: 30px; left: 0; width: 100%; z-index: 1000; display: flex; justify-content: center; gap: 10px; padding: 0 10px; box-sizing: border-box;">
        </div>

  </div>
</div>

<div id="modalHistoricoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📜 Histórico de Serviços</h3>
    <div id="painelHistoricoBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalConquistasBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏅 Minhas Conquistas de Profissional</h3>
    <div id="listaConquistasBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalConquistasBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBlogAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✍️ Novo Post</h3>
    <input id="blogTitulo" placeholder="Título">
    <textarea id="blogConteudo" placeholder="Conteúdo do post"></textarea>
    <button onclick="publicarBlog()">✍️ Publicar</button>
    <button data-modal-id="modalBlogAdmin" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalEstatisticas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📊 Estatísticas</h3>
    <div id="estatisticasPainel" class="scrollable-list"></div>
    <button data-modal-id="modalEstatisticas" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalSolicitacoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📥 Todas as Solicitações</h3>
    <div id="listaSolicitacoes" class="scrollable-list"></div>
    <button data-modal-id="modalSolicitacoes" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalUsuarios" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>👥 Todos os Usuários</h3>
    <div id="usuariosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalUsuarios" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalGerenciarUsuario" class="modal"><div class="modal-content"><h3>Gerenciar Usuário</h3><div id="adminGerenciarConteudo"></div></div></div>

<div id="modalGerenciarLojaAdmin" class="modal"><div class="modal-content"><h3>Gerenciar Loja</h3><div class="popup-section"><h4>Deletar Produto</h4><div id="adminDeletarProdutoList" class="scrollable-list"></div></div><div class="popup-section"><h4>Ativar/Desativar Loja de Vendedor</h4><div id="adminToggleLojaList" class="scrollable-list"></div></div><button data-modal-id="modalGerenciarLojaAdmin" onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalDenunciasAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚨 Denúncias</h3>
    <div id="listaDenuncias" class="scrollable-list"></div>
    <button data-modal-id="modalDenunciasAdmin" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalNotificacaoMarketing" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📣 Notificação para Todos</h3>
    <p>Esta mensagem será enviada como uma notificação push para todos os usuários do app.</p>
    <input id="marketingTitulo" placeholder="Título da Notificação">
    <textarea id="marketingCorpo" placeholder="Corpo da mensagem"></textarea>
    <button onclick="enviarNotificacaoMarketing()">🚀 Enviar para todos</button>
    <button data-modal-id="modalNotificacaoMarketing" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarCidadeInputs" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏙️ Alterar Localização</h3>
    <p>Digite o novo estado e cidade desejados.</p>
    <label for="novoEstadoInput">Novo Estado:</label>
    <input id="novoEstadoInput" type="text" placeholder="Ex: Espírito Santo" oninput="this.value = formatarNomeProprio(this.value)">
    <label for="novoCidadeInput">Nova Cidade:</label>
    <input id="novoCidadeInput" type="text" placeholder="Ex: Aracruz" oninput="this.value = formatarNomeProprio(this.value)">
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button data-modal-id="modalAlterarCidadeInputs" onclick="fecharModal(event)" style="background-color: #555;">Cancelar</button>
        <button id="btnConfirmarInputsCidade" onclick="processarInputsCidade()">Confirmar</button>
    </div>
  </div>
</div>

<div id="modalConfirmarAlteracaoCidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Confirmar Alteração?</h3>
    <p>Você confirma a solicitação para alterar sua cidade para <b id="confirmCidadeEstadoTexto">? Isso abrirá o WhatsApp para agilizar.</p>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button id="btnNaoConfirmarCidade" onclick="fecharModalAtual()" style="background-color: #555;">Não</button>
      <button id="btnSimConfirmarCidade">Sim, Solicitar</button> </div>
  </div>
</div>

<div id="modalAvisoPromo" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center; border: 2px solid #d4af37;">
    <div style="font-size: 50px;">🎁</div>
    <h3 style="color: var(--cor-destaque); margin-top: 10px;">Você ganhou um presente!</h3>
    <p>Liberamos códigos especiais na aba <strong>BLOG</strong> para você testar os benefícios Premium por 30 dias grátis!</p>
    <p style="font-size: 14px; color: #aaa;">Corra para resgatar antes que expire.</p>
    <button onclick="irParaBlogPromo()" style="background: linear-gradient(45deg, #d4af37, #f1c40f); color: #000; font-weight: bold; width: 100%; margin-top: 15px;">
        🏃 Ir para o Blog e Resgatar
    </button>
    <button onclick="fecharModalAtual()" style="background: transparent; border: none; color: #888; margin-top: 10px; font-size: 12px;">Ver depois</button>
  </div>
</div>

<div id="modalPortfolioBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🖼️ Gerenciar Portfólio (Máx. 30 Imagens/GIFs)</h3>
    <p style="font-size: 12px; opacity: 0.8;">Adicione novas imagens abaixo ou clique no '❌' sobre uma imagem existente para removê-la.</p>
    <p style="font-size: 14px; margin-bottom: 10px;">Imagens Atuais: <b id="portfolioContador">0/30</p>

    <div id="portfolioExistenteGrid" class="portfolio-grid" style="margin-bottom: 15px; border: 1px dashed var(--cor-borda); padding: 10px; min-height: 100px; max-height: 250px; overflow-y: auto;">
      </div>

    <label id="labelPortfolioFiles" for="portfolioFilesInput" style="cursor: pointer; background-color: var(--cor-botoes); padding: 10px; border-radius: 8px; text-align: center; display: block; margin-bottom: 10px;">Adicionar Novas Imagens</label>
    <input id="portfolioFilesInput" type="file" accept="image/*,image/gif" multiple style="display: none;">
    <progress id="portfolioUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-bottom: 10px;"></progress>
    <div id="portfolioPreviews" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; max-height: 100px; overflow-y: auto;"></div>

    <button id="btnSalvarPortfolio" onclick="salvarAlteracoesPortfolio()" disabled>💾 Salvar Alterações</button>
    <button data-modal-id="modalPortfolioBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalPortfolioCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="portfolioClienteNome">🖼️ Portfólio</h3>
    <div id="portfolioClienteGrid" class="portfolio-grid"></div>
    <button data-modal-id="modalPortfolioCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalLiberarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🛍️ Acesso à Loja de Vendedores</h3>
        <p>Você ainda não tem permissão pra cadastrar produtos na loja. Peça autorização pro administrador no WhatsApp.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-modal-id="modalLiberarLoja" onclick="fecharModal(event)" style="background-color: #555;">↩️ Cancelar</button>
            <button onclick="solicitarLiberacaoLoja()" style="flex-grow: 1;">
                💬 Pedir no WhatsApp
            </button>
        </div>
    </div>
</div>

<div id="modalTurbinar" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🚀 Turbinar seu Perfil</h3>
        <p>Destaque seu perfil no topo da lista de profissionais por <strong>24 horas</strong> e alcance mais clientes!</p>
        <p style="font-size: 22px; color: var(--cor-destaque); font-weight: bold; text-align: center;">Apenas R$ 9,99</p>
        <button onclick="confirmarTurbinar()">💥 Confirmar e Turbinar</button>
        <button data-modal-id="modalTurbinar" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalPermissaoNotificacao" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🔔 Fique por Dentro!</h3>
        <p>Ative as notificações para receber alertas importantes sobre seus agendamentos, promoções e novidades em tempo real.</p>
        <button onclick="pedirPermissaoEFechar()">👍 Ativar Notificações</button>
        <button data-modal-id="modalPermissaoNotificacao" onclick="fecharModal(event)">❌ Agora não</button>
    </div>
</div>

<div id="modalInstalarApp" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>📱 Leve o App com Você!</h3>
        <p>Instale nosso aplicativo na sua tela inicial para um acesso mais rápido e uma melhor experiência.</p>
        <button id="btnInstalarPWA">📲 Instalar Agora</button>
        <button data-modal-id="modalInstalarApp" onclick="fecharModal(event)">🤔 Depois</button>
    </div>
</div>

<div id="modalAtualizacao" class="modal" style="z-index: 100;" onclick="fecharModal(event)">
    <div class="modal-content" style="border: 2px solid var(--cor-destaque);" onclick="event.stopPropagation()">
        <h3>🚀 Nova Versão do App Disponível!</h3>
        <p>Uma nova versão do aplicativo está pronta. Clique no botão abaixo para atualizar e ter acesso às últimas novidades e melhorias.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
           <button data-modal-id="modalAtualizacao" onclick="fecharModal(event)" style="background: #555;">🤔 Depois</button>
           <button id="btnAtualizarApp" style="flex-grow: 1;">🔄 Atualize Agora</button>
        </div>
    </div>
</div>

<div id="modalPromocoesBarbeiro" class="modal">
  <div class="modal-content">
    <h2>🎁 Promoções Ativas</h2>
    <div id="listaPromocoes">
      </div>
    <div class="modal-botoes">
      <button onclick="abrirModalAddPromocao()">➕ Adicionar Promoção</button>
      <button data-modal-id="modalPromocoesBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
  </div>
</div>

<div id="modalAddPromocao" class="modal">
  <div class="modal-content">
    <h2>➕ Adicionar Nova Promoção</h2>

    <input type="text" id="addPromocaoNome" placeholder="Nome da Promoção (Ex: Combo Barba+Cabelo)" required>
    <textarea id="addPromocaoDescricao" placeholder="Descrição (Ex: Válido de segunda a quarta)" required></textarea>

    <div class="popup-section">
      <h4>✂️ Aplicar a quais serviços?</h4>
      <p style="font-size: 12px; opacity: 0.7;">Segure Ctrl (ou Cmd) para selecionar vários.</p>
      <select id="addPromocaoServicos" multiple style="height: 120px;"></select>
    </div>

    <div class="popup-section">
      <h4>⚙️ Condições da Promoção</h4>
      <label for="addPromocaoDesconto">Desconto (%):</label>
      <input type="number" id="addPromocaoDesconto" placeholder="Ex: 15" required>

      <label for="addPromocaoValidade">Válida até (opcional):</label>
      <input type="date" id="addPromocaoValidade">

      <label for="addPromocaoValorMinimo">Valor mínimo do serviço para aplicar (opcional):</label>
      <input type="number" id="addPromocaoValorMinimo" placeholder="Ex: 50">
    </div>

    <button onclick="salvarNovaPromocao()">💾 Salvar Promoção</button>
    <button data-modal-id="modalAddPromocao" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>
	
<div id="modalConfirmarFecharPopup" class="modal" style="z-index: 30;" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="confirmarFecharTitulo">🤔 Tem certeza?</h3>
    <p id="confirmarFecharMensagem">Você pode completar esta etapa mais tarde pelas configurações.</p>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="cancelarFechamentoPopup()" style="background-color: #555;">Não, continuar</button>
      <button onclick="confirmarFechamentoPopup()">Sim, fechar</button>
    </div>
  </div>
</div>

<div id="modalLoja" class="modal">
  <div class="modal-content">
    <h3>🛒 Produtos da Loja</h3>
    <div id="listaProdutos" class="loja-grid"></div>
    <button data-modal-id="modalLoja" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">

        
        <div id="detalhesProdutoImagensContainer" style="width: 100%; overflow-x: auto; display: flex; scroll-snap-type: x mandatory; margin-bottom: 5px; background-color: var(--cor-botoes); border-radius: 10px; min-height: 250px; align-items: center;">
            {/* Imagens serão carregadas aqui pelo JS */}
        </div>

        
        <div id="detalhesProdutoImagensIndicadores" style="text-align: center; margin-bottom: 15px;">
            {/* Indicadores (pontinhos) serão carregados aqui pelo JS */}
        </div>
        

        <h3 id="detalhesProdutoNome" style="margin: 0; color: var(--cor-destaque);"></h3>

        <p style="margin-top: 15px;"><strong>Tamanho:</strong></p>
        <div id="detalhesProdutoTamanhos" class="tamanho-options"></div>

        <p><strong>Preço:</strong> <span id="detalhesProdutoPreco" style="font-weight: bold; font-size: 1.2em;"></span></p>
        <p><strong>Descrição:</strong></p>
        <p id="detalhesProdutoDescricao" style="font-size: 14px; opacity: 0.9;"></p>

        <div id="detalhesProdutoAvaliacao"></div>

        <button id="btnComprarAgora">Continuar</button>
        <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">❌ Fechar</button>

    </div>
</div>

<div id="modalFormularioCompraLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-overlay-content hidden" id="overlayPagamento">
            <h3>Confirmar Pagamento</h3>
            <p>Debitar R$ <span id="valorDebito">0,00</span> do seu saldo da carteira?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; width: 80%;">
                <button id="btnNaoDebitar" style="background-color: #555;">Não</button>
                <button id="btnSimDebitar">Sim</button>
            </div>
        </div>
        <h3>📝 Detalhes para Entrega</h3>
        <input id="compraNomeCompleto" type="text" placeholder="Nome Completo">
        <input id="compraCpf" type="text" placeholder="CPF">
        <input id="compraTelefone" type="tel" placeholder="Telefone para Contato">
        <input id="compraEmail" type="email" placeholder="Email para confirmação">
        <input id="compraCep" type="text" placeholder="CEP">
        <input id="compraRua" type="text" placeholder="Endereço Completo (Rua, Bairro...)">
        <input id="compraNumeroCasa" type="text" placeholder="Número da Casa e Complemento">
        <button id="btnPagarCompraLoja">Pagar</button>
        <button data-modal-id="modalFormularioCompraLoja" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
        <h3>🏪 Gerenciar Minha Loja</h3>
        <div id="listaMeusProdutos" class="scrollable-list"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
          <button onclick="abrirFormularioProduto()">➕ Adicionar Produto</button>
          <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">🚚 Entregas</button>
          <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">❌ Fechar</button>
        </div>
    </div>
</div>

<div id="modalSolicitarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🛍️ Venda Seus Produtos na Loja!</h3>
        <p>Gostaria de se tornar um vendedor em nossa plataforma?</p>
        <p style="font-size: 14px; opacity: 0.8;">Ao clicar em "Enviar Solicitação", um pedido será enviado ao administrador para análise e você será redirecionado(a) ao WhatsApp para agilizar o contato.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button data-modal-id="modalSolicitarLoja" onclick="fecharModal(event)" style="background-color: #555;">Cancelar</button>
            <button id="btnConfirmarSolicitarLoja" onclick="confirmarSolicitacaoAcessoLoja()">➡️ Enviar Solicitação</button>
        </div>
    </div>
 </div>

<div id="modalEquipe" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>👥 Gerenciar Equipe</h3>
    <p>Adicione profissionais à sua barbearia.</p>
    
    <div style="margin-bottom: 10px;">
        <input id="buscaEquipeInputFuncionario" 
               oninput="buscarUsuarioEquipeInstantaneo(this.value)" 
               placeholder="Digite o nome para buscar..." 
               style="width: 100%; padding: 12px; border: 1px solid var(--cor-destaque); border-radius: 8px;">
    </div>
    
    <div id="resultadoBuscaEquipe" style="margin: 10px 0; max-height: 150px; overflow-y: auto;"></div>

    <hr style="border-color: #333;">
    <h4>Membros Atuais:</h4>
    <div id="listaEquipeAtual" class="scrollable-list"></div>
    
    <button data-modal-id="modalEquipe" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalStoryView" class="modal" style="background: #000; z-index: 20000;">
    <div class="modal-content" style="width:100%; height:100%; padding:0; background:black; border:none; display:flex; flex-direction:column;">
        
        <div id="storyProgressBarContainer" style="display:flex; gap:5px; padding:10px; position:absolute; top:0; width:100%; box-sizing:border-box; z-index:10;"></div>
        
        <div style="position:absolute; top:20px; left:10px; z-index:10; display:flex; align-items:center; gap:10px;">
            <img id="storyUserPhoto" src="" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--cor-destaque); object-fit:cover;">
            <span id="storyUserName" style="color:white; font-weight:bold; font-size:14px; text-shadow:0 0 5px black;"></span>
        </div>

        <button onclick="fecharModalAtual()" style="
            position: absolute; 
            top: 20px; 
            right: 15px; 
            z-index: 50; 
            background: rgba(0,0,0,0.3); /* Fundo leve para contraste */
            border: 1px solid rgba(255,255,255,0.3); 
            color: white; 
            width: 30px; /* Tamanho pequeno */
            height: 30px; 
            border-radius: 50%; /* Redondo */
            font-size: 14px; /* X menor */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            padding: 0;">
            ✕
        </button>

        <img id="storyImage" src="" style="width:100%; height:100%; object-fit:contain;">
        
        <div class="story-actions-sidebar">
            <div class="story-action-btn" onclick="toggleLikeStory()">
                <span id="storyLikeIcon">🤍</span>
                <span id="storyLikeCount" style="font-size: 12px;">0</span>
            </div>
            
            <div class="story-action-btn" onclick="abrirComentariosStory()">
                <span>💬</span>
                <span id="storyCommentCount" style="font-size: 12px;">0</span>
            </div>

            <div class="story-action-btn" onclick="compartilharStoryAtual()">
                <span>✈️</span> <span style="font-size: 10px;">Enviar</span>
            </div>
        </div>

        <div style="position:absolute; bottom:0; width:100%; padding:20px; background:linear-gradient(to top, rgba(0,0,0,0.9), transparent); z-index:9;">
            <button onclick="agendarPeloStory()" style="width:100%; background:var(--cor-destaque); color:#000; font-weight:bold; border-radius:30px;">✂️ Agendar</button>
        </div>
    </div>
</div>

<div id="modalComentariosStory" class="modal" style="z-index: 21000 !important; align-items: flex-end !important; background: rgba(0,0,0,0.5) !important;" onclick="fecharComentariosStory(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="width:100% !important; max-width: 100% !important; height: 60vh !important; border-radius: 20px 20px 0 0 !important; background: #1a1a1a !important; padding: 0 !important; display: flex; flex-direction: column; animation: slideUpComment 0.3s ease-out;">
        
        <div style="padding: 15px; border-bottom: 1px solid #333; display:flex; justify-content:center; align-items:center; position: relative;">
            <div style="width: 40px; height: 4px; background: #444; border-radius: 2px; position: absolute; top: 8px;"></div>
            <h3 style="margin:10px 0 0 0; font-size:14px; color: #fff;">Comentários</h3>
            <button onclick="fecharComentariosStory()" style="background:none; border:none; font-size:20px; color:#aaa; position: absolute; right: 15px; top: 15px;">✕</button>
        </div>

        <div id="listaComentariosStory" class="scrollable-list" style="flex-grow: 1; padding: 15px; overflow-y: auto; background: #111;">
            <div class="spinner" style="margin: 20px auto;"></div>
        </div>

        <div style="padding: 10px; background: #1a1a1a; display:flex; gap:10px; align-items:center; border-top: 1px solid #333;">
            <img id="minhaFotoComentario" src="" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #444;">
            <input id="inputComentarioStory" type="text" placeholder="Adicione um comentário..." style="flex-grow: 1; border-radius: 20px; background: #000; border: 1px solid #333; color:white; padding:12px; font-size: 14px;">
            <button onclick="enviarComentarioStory()" style="width:auto; padding: 10px; border-radius: 50%; background: transparent; color: var(--cor-destaque); font-weight: bold; font-size: 16px;">Enviar</button>
        </div>
    </div>
</div>

<div id="modalFachada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏢 Fachada do Estabelecimento</h3>
    <p>Essa imagem aparecerá no fundo do perfil para os clientes.</p>
    <input id="fachadaFile" type="file" accept="image/*">
    <button onclick="salvarFachada()">💾 Salvar Fachada</button>
    <button data-modal-id="modalFachada" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 85vh; overflow-y: auto;"> <h3 id="formProdutoTitulo">📦 Adicionar/Editar Produto</h3>

        <div class="popup-section">
            <h4>Imagens (1 a 5) *</h4>
            <p style="font-size: 12px; opacity: 0.8;">Selecione até 5 imagens ou GIFs. A primeira será a principal. Clique no '❌' para remover uma imagem existente.</p>
            <p style="font-size: 14px;">Imagens Atuais: <b id="produtoContadorImagens">0/5</p>
            <div id="produtoPreviewsExistentes" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; border: 1px dashed var(--cor-borda); padding: 5px; min-height: 70px;">
                </div>
            <label id="labelProdutoFiles" for="produtoFiles">Adicionar Novas Imagens</label>
            <input id="produtoFiles" type="file" accept="image/*,image/gif" multiple style="margin-bottom: 5px;" disabled>
            <progress id="produtoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-bottom: 5px;"></progress>
            <div id="produtoPreviewsNovas" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; max-height: 80px; overflow-y: auto;"></div>
        </div>

        <label for="produtoNome">Nome do Produto *</label>
        <input id="produtoNome" type="text" placeholder="Ex: Camiseta Básica Preta" required>

        <label for="produtoPreco">Preço (R$) *</label>
        <input id="produtoPreco" type="number" step="0.01" placeholder="Ex: 49.90" required>

        <label for="produtoDesconto">Desconto (%)</label>
        <input id="produtoDesconto" type="number" placeholder="Opcional, Ex: 10 (para 10%)">

        <label style="margin-top: 10px; display: block;">Tamanhos disponíveis *</label>
        <div id="produtoTamanhosGroup" class="checkbox-group" style="margin-bottom: 15px;">
            <label><input type="checkbox" name="tamanhos" value="Único"> Único</label>
            <label><input type="checkbox" name="tamanhos" value="P"> P</label>
            <label><input type="checkbox" name="tamanhos" value="M"> M</label>
            <label><input type="checkbox" name="tamanhos" value="G"> G</label>
            <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
            </div>

        <label for="produtoDescricao">Descrição *</label>
        <textarea id="produtoDescricao" placeholder="Descreva brevemente o produto..." rows="3" required></textarea>

        <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()" style="margin-top: 15px;">💾 Salvar Produto</button>
        <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>🚚 Minhas Entregas</h3>
        <div id="listaEntregas" class="scrollable-list"></div>
        <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>🛍️ Minhas Compras</h3>
        <div id="listaMinhasCompras" class="scrollable-list"></div>
        <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalAvaliarProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>⭐ Avaliar Produto</h3>
        <p>Como você avalia o produto <b id="avaliarProdutoNome">?</p>
        <div class="rating-stars" id="ratingStars">
            <span data-value="1">☆</span><span data-value="2">☆</span><span data-value="3">☆</span><span data-value="4">☆</span><span data-value="5">☆</span>
        </div>
        <textarea id="avaliarProdutoComentario" placeholder="Deixe um comentário..." rows="3"></textarea>
        <button id="btnSalvarAvaliacaoProduto">Enviar Avaliação</button>
        <button data-modal-id="modalAvaliarProduto" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalPopupGenerico" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
    <h3 id="popupGenericoTitulo" style="margin-top: 0;"></h3>
    <p id="popupGenericoMensagem" style="margin-bottom: 20px;"></p>
    <button data-modal-id="modalPopupGenerico" onclick="handlePopupGenericoOk(event)">OK</button>
  </div>
</div>

<style>
.rating-stars {
    text-align: center;
    font-size: 2.5em;
    cursor: pointer;
    margin: 10px 0;
    color: #444;
}
.rating-stars span {
    transition: color 0.2s;
}
.rating-stars span:hover,
.rating-stars span.hovered,
.rating-stars span.selected {
    color: var(--cor-destaque);
}

#modalGerenciarUsuario .modal-content {
    max-height: 80vh; /* Limita a altura máxima a 80% da altura da tela */
    overflow-y: auto;   /* Adiciona a barra de rolagem vertical APENAS quando necessário */
    /* Você pode ajustar o valor de max-height (ex: 75vh, 85vh) se preferir */
}

#modalVipPro .modal-content {
    max-height: 85vh; /* Define uma altura máxima */
    /* display: flex;  Removido ou ajustado para não interferir no scroll */
    /* flex-direction: column; Removido ou ajustado */
}
#vipProContentContainer {
     max-height: calc(85vh - 120px); /* Calcula altura máxima do conteúdo (85vh - paddings - altura botão fechar aprox) */
     overflow-y: auto; /* Adiciona scroll se necessário */
     padding-right: 10px; /* Espaço para a barra de rolagem não colar no conteúdo */
     box-sizing: border-box; /* Garante que o padding não aumente o tamanho */
}

</style>


<div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🎉 VENDA REALIZADA! 🎉</h3>
        <p style="font-size: 1.1em;">Parabéns, você vendeu um produto!</p>
        <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
        <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">✅ OK</button>
    </div>
</div>

<div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content">
        <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
        <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Você confirma o recebimento?</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
           <button id="btnRecusarEntrega" style="background: #c0392b;">❌ Negar</button>
           <button id="btnAceitarEntrega" style="background: #27ae60;">✅ Confirmar</button>
        </div>
    </div>
</div>

<div id="modalModoFerias" class="modal">
  <div class="modal-content">
    <h3>📅 Modo Férias/Ausência</h3>
    <p>Bloqueie um período na sua agenda. Seus clientes serão notificados.</p>
    <label for="feriasInicio">Data de Início:</label>
    <input type="date" id="feriasInicio">
    <label for="feriasFim">Data de Fim:</label>
    <input type="date" id="feriasFim">
    <button onclick="ativarModoFerias()">✅ Ativar e Notificar Clientes</button>
    <button data-modal-id="modalModoFerias" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalEsqueciSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Recuperar Acesso</h3>
    <p style="font-size: 14px;">Preencha seus dados para solicitar uma nova senha ao administrador.</p>
    <input id="recuperaEmail" type="email" placeholder="📧 Seu email de cadastro">
    <input id="recuperaTelefone" type="tel" placeholder="📞 Seu telefone com DDD">
    <button onclick="enviarSolicitacaoRecuperacaoSenha()">➡️ Enviar Solicitação</button>
    <button data-modal-id="modalEsqueciSenha" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- ===================================================================== -->
<!-- ====== INÍCIO: NOVOS MODAIS ONBOARDING PROFISSIONAL (COPIAR) ====== -->
<!-- ===================================================================== -->

<!-- Popup 2: Promoções (Onboarding) -->
<div id="modalOnboardingPromocoes" class="modal" style="z-index: 21;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-overlay-content hidden" id="overlayOnboardingPromocao">
        <h3 id="onboardingPromocaoTituloAviso">Atenção</h3>
        <p id="onboardingPromocaoMensagemAviso">É necessário adicionar pelo menos 1 promoção para concluir esta etapa.</p>
        <button onclick="document.getElementById('overlayOnboardingPromocao').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>

    <h3>2. Crie sua Primeira Promoção</h3>
    <p style="font-size: 14px; opacity: 0.8;">Atraia clientes com um desconto! (Ex: Combo Barba+Cabelo com 10% OFF).</p>

    <!-- Adicionado scrollable-list aqui -->
    <div class="scrollable-list" style="max-height: 55vh; padding-right: 10px;">
        <input type="text" id="onboardingPromocaoNome" placeholder="Nome da Promoção (Ex: Combo Barba+Cabelo)" required>
        <textarea id="onboardingPromocaoDescricao" placeholder="Descrição (Ex: Válido de segunda a quarta)" required></textarea>

        <div class="popup-section">
          <h4>✂️ Aplicar a quais serviços?</h4>
          <p style="font-size: 12px; opacity: 0.7;">Selecione os serviços que você acabou de cadastrar. Segure Ctrl (ou Cmd) para selecionar vários.</p>
          <select id="onboardingPromocaoServicos" multiple style="height: 120px;"></select>
        </div>

        <div class="popup-section">
          <h4>⚙️ Condições da Promoção</h4>
          <label for="onboardingPromocaoDesconto">Desconto (%):</label>
          <input type="number" id="onboardingPromocaoDesconto" placeholder="Ex: 15" required>

          <label for="onboardingPromocaoValidade">Válida até (opcional):</label>
          <input type="date" id="onboardingPromocaoValidade">
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(2)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextPromocoes" onclick="salvarOnboardingPromocao()">Concluir ➡️</button>
    </div>
  </div>
</div>

<!-- Popup 3: Agenda (Onboarding) - (Você já tem 'modalAgendaBarbeiro', vamos criar um clone para o onboarding) -->
<div id="modalOnboardingAgenda" class="modal" style="z-index: 22;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-overlay-content hidden" id="overlayOnboardingAgenda">
        <h3>Atenção</h3>
        <p>Você precisa ativar pelo menos uma forma de atendimento (Vaga Imediata ou Agenda Programada) para continuar.</p>
        <button onclick="document.getElementById('overlayOnboardingAgenda').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>
    
    <h3>3. Configure sua Agenda</h3>
    <p>Use os botões abaixo para gerenciar sua disponibilidade.</p>
    <button id="onboardingBtnDisponibilidade" onclick="toggleOnboardingDisponibilidade()"></button>
    <button id="onboardingBtnVagaImediata" onclick="toggleOnboardingVagaImediata()"></button>
    <button id="onboardingBtnAgendaManual" onclick="toggleOnboardingAgendaManual()"></button>
    
    <div id="onboardingAgendaManualPainel" class="hidden card">
        <h4>Horários Disponíveis Hoje</h4>
        <p>Selecione os horários para trabalhar.</p>
        <div id="onboardingHorariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(3)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextAgenda" onclick="salvarOnboardingAgenda()">Concluir ➡️</button>
    </div>
  </div>
</div>

<div id="modalOnboardingLogomarca" class="modal" style="z-index: 23;">
  <div class="modal-content" onclick="event.stopPropagation()">
     <div class="modal-overlay-content hidden" id="overlayOnboardingLogo">
        <h3>Atenção</h3>
        <p>É necessário adicionar uma foto de perfil para passar credibilidade aos clientes.</p>
        <button onclick="document.getElementById('overlayOnboardingLogo').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>

    <h3>4. Adicione sua Foto de Perfil</h3>
    <p style="font-size: 12px; opacity: 0.8;">Esta foto aparecerá no mapa e na lista de profissionais. Escolha uma foto sua ou da sua logo.</p>
    
    <div style="text-align: center; margin: 20px 0;">
        <img id="onboardingLogomarcaPreview" src="https://placehold.co/150?text=Sua+Foto" alt="Preview" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--cor-destaque); display: block; margin: 0 auto;">
        
        <label for="onboardingLogomarcaFile" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: var(--cor-botoes); border: 1px solid var(--cor-destaque); color: white; border-radius: 8px; cursor: pointer;">
            📷 Escolher Foto
        </label>
        <input id="onboardingLogomarcaFile" type="file" accept="image/*" style="display: none;">
    </div>

    <progress id="onboardingLogoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 10px;"></progress>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(4)" style="background-color: #555;">❌ Depois</button>
        <button id="btnOnboardingNextLogo" onclick="salvarOnboardingLogo()" disabled>Salvar e Continuar ➡️</button>
    </div>
  </div>
</div>

<!-- Popup 5: Portfólio (Onboarding) -->
<div id="modalOnboardingPortfolio" class="modal" style="z-index: 24;">
  <div class="modal-content" onclick="event.stopPropagation()">
     <div class="modal-overlay-content hidden" id="overlayOnboardingPortfolio">
        <h3>Atenção</h3>
        <p>É necessário enviar pelo menos uma imagem para seu portfólio para concluir.</p>
        <button onclick="document.getElementById('overlayOnboardingPortfolio').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>

    <h3>5. Mostre seu Trabalho (Portfólio)</h3>
    <p style="font-size: 12px; opacity: 0.8;">Envie pelo menos 1 imagem (Máx. 30) para que os clientes vejam sua qualidade.</p>
    
    <label for="onboardingPortfolioFilesInput" style="cursor: pointer; background-color: var(--cor-botoes); padding: 10px; border-radius: 8px; text-align: center; display: block; margin-bottom: 10px;">Adicionar Imagens</label>
    <input id="onboardingPortfolioFilesInput" type="file" accept="image/*,image/gif" multiple style="display: none;">
    
    <progress id="onboardingPortfolioUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-bottom: 10px;"></progress>
    <div id="onboardingPortfolioPreviews" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; max-height: 150px; overflow-y: auto;"></div>

    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(5)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextPortfolio" onclick="salvarOnboardingPortfolio()" disabled>🎉 Finalizar Configuração</button>
    </div>
  </div>
</div>

<!-- Popup de Aviso Genérico (Onboarding) -->
<div id="modalAvisoOnboarding" class="modal" style="z-index: 30;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="avisoOnboardingTitulo">Atenção</h3>
    <p id="avisoOnboardingMensagem">Você precisa concluir esta etapa mais tarde para que os clientes possam agendar com você.</p>
    <button onclick="confirmarFechamentoOnboarding()" style="margin-top: 15px;">OK, Entendi</button>
  </div>
</div>
<!-- ===================================================================== -->
<!-- ====== FIM: NOVOS MODAIS ONBOARDING PROFISSIONAL (COPIAR) ========= -->
<!-- ===================================================================== -->

<div id="modalLembretePendencia" class="modal" style="z-index: 30;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Configurações Pendentes</h3>
    <p>Faltam configurações essenciais para que os clientes possam encontrar e agendar com você. Recomendamos que conclua agora.</p>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="fecharModalAtual()" style="background-color: #555;">Deixar pra depois</button>
      <button id="btnLembreteOk" onclick="iniciarFluxoDeLembrete()">OK, Configurar</button>
    </div>
  </div>
</div>

<div id="modalAdminDetalhesCidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏙️ Aprovar Alteração de Cidade</h3>
    <p>Usuário: <b id="adminCidadeNomeUsuario"></p>
    <p>Cidade Atual: <span id="adminCidadeAtual"></span></p>

    
    <label for="adminNovoEstadoSolicitacao">Novo Estado:</label>
    <input id="adminNovoEstadoSolicitacao" type="text" placeholder="Digite o novo estado" oninput="this.value = formatarNomeProprio(this.value)">

    <label for="adminNovoCidadeSolicitacao">Nova Cidade:</label>
    <input id="adminNovoCidadeSolicitacao" type="text" placeholder="Digite a nova cidade" oninput="this.value = formatarNomeProprio(this.value)">
    

    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="recusarSolicitacaoAtual()" style="background-color: #e74c3c;">❌ Recusar</button>
        <button id="btnAprovarCidade" onclick="aprovarAlteracaoCidade()">✅ Aprovar Alteração</button>
    </div>
     <button data-modal-id="modalAdminDetalhesCidade" onclick="fecharModal(event)" style="margin-top: 10px;">Fechar Janela</button>
  </div>
</div>

<!-- Modal para Adicionar/Editar Serviço (Substitui o prompt) -->
<div id="modalAddServico" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="modalAddServicoTitulo">Adicionar Novo Serviço</h3>
    <input id="addServicoNome" type="text" placeholder="Nome do Serviço (Ex: Corte Masculino)">
    <input id="addServicoValor" type="number" placeholder="Preço (Ex: 25.50)">
    <input id="addServicoTempo" type="number" placeholder="Tempo Estimado (em minutos, Ex: 30)">
    <button id="btnSalvarServico" onclick="salvarServico()">💾 Salvar Serviço</button>
    <button data-modal-id="modalAddServico" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalEmAlta" class="modal" onclick="fecharModal(event)" style="z-index: 13000;">
    <div class="modal-content" onclick="event.stopPropagation()" style="background: #111; max-width: 500px; height: 90vh; display: flex; flex-direction: column;">
        <div style="padding: 15px; text-align: center; border-bottom: 1px solid #333;">
            <h3 style="margin: 0; color: #fff; text-transform: uppercase; letter-spacing: 1px;">🔥 Em Alta</h3>
            <p style="font-size: 11px; color: #00c6ff; margin: 2px 0;">Exclusivo: Os melhores cortes dos Profissionais Diamante</p>
        </div>
        <div id="gridEmAlta" class="scrollable-list" style="padding: 10px; flex-grow: 1;">
            <div class="spinner"></div>
        </div>
        <button onclick="fecharModalAtual()" style="margin: 10px; background: #333;">Fechar</button>
    </div>
</div>

<div id="modalDetalhesEmAlta" class="modal" style="z-index: 14000;">
    <div class="modal-content" style="display: flex; flex-direction: column;">
        
        <div style="flex-grow: 1; position: relative; background: #000; display:flex; align-items:center; justify-content:center;">
             <img id="imgDetalheAlta" src="" style="max-width:100%; max-height:100%; object-fit:contain;">
             <button onclick="fecharModalAtual()" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 40px; height: 40px; font-size: 20px;">✕</button>
        </div>

        <div style="background: #1a1a1a; padding: 20px; border-top: 1px solid #333;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img id="fotoProfDetalheAlta" src="" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00c6ff;">
                    <div>
                        <b id="nomeProfDetalheAlta" style="color: #fff; font-size: 14px;">Nome
                        <span style="display:block; font-size: 10px; color: #00c6ff;">💎 Profissional Diamante</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <button id="btnLikeAlta" onclick="darLikeEmAlta()" style="background: transparent; border: 1px solid #444; width: auto; padding: 5px 15px;">
                        ❤️ <span id="countLikesAlta">0</span>
                    </button>
                </div>
            </div>

            <button id="btnAgendarAlta" style="width: 100%; background: linear-gradient(45deg, #00c6ff, #0072ff); font-weight: bold; padding: 15px; font-size: 16px; box-shadow: 0 0 15px rgba(0, 198, 255, 0.4);">
                ✂️ AGENDAR COM ESTE PROFISSIONAL
            </button>
        </div>
    </div>
</div>

<!-- Modal para Resgatar Código (Substitui o prompt) -->
<div id="modalResgatarCodigo" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✨ Resgatar Código</h3>
    <p>Insira o código de resgate:</p>
    <input id="inputCodigoResgate" type="text" placeholder="Digite o código aqui...">
    <button onclick="executarResgateCodigo()">➡️ Resgatar</button>
    <button data-modal-id="modalResgatarCodigo" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- Modal para Avaliação do Cliente (Substitui os prompts) -->
<div id="modalAvaliacaoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⭐ Avaliar Serviço</h3>
    <p>Como foi sua experiência?</p>
    
    <input id="inputAvaliacaoNota" type="number" min="1" max="10" placeholder="Nota (1-10)" style="font-weight:bold; font-size:16px;">
    
    <textarea id="inputAvaliacaoComentario" placeholder="Deixe um comentário..." rows="3"></textarea>
    
    <div style="background: var(--cor-botoes); padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed var(--cor-borda);">
        <p style="font-size: 12px; margin: 0 0 5px 0;">📸 Mostre o resultado! (Opcional)</p>
        <input id="inputAvaliacaoFotoFile" type="file" accept="image/*">
        <progress id="avaliacaoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 5px; height: 5px;"></progress>
    </div>

    <button id="btnSalvarAvaliacao" onclick="executarAvaliacaoCliente()" style="margin-top: 15px;">Enviar Avaliação</button>
    <button data-modal-id="modalAvaliacaoCliente" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalConfirmarSenhaExclusao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🗑️ Excluir Conta Permanentemente</h3>
    <p style="color: #e74c3c; font-weight: bold;">Esta ação apagará todos os seus dados!</p>
    
    <label style="display:block; text-align:left; margin-top:10px; font-size:13px;">1. Confirme seu E-mail:</label>
    <input id="exclusaoEmailInput" type="email" placeholder="Digite seu e-mail cadastrado">

    <label style="display:block; text-align:left; margin-top:10px; font-size:13px;">2. Confirme sua Senha:</label>
    <div class="show-password-container">
      <input id="exclusaoSenhaInput" type="password" placeholder="🔑 Sua Senha">
      <span class="show-password-toggle" onclick="togglePasswordVisibility('exclusaoSenhaInput', this)">👁️</span>
    </div>

    <button onclick="deletarConta()" style="background-color: #c0392b; margin-top: 15px; border: 1px solid #e74c3c; width: 100%;">Confirmar Exclusão</button>
    <button data-modal-id="modalConfirmarSenhaExclusao" onclick="fecharModal(event)" style="margin-top: 10px;">❌ Cancelar</button>
  </div>
</div>

<!-- Modal POPUP PERSISTENTE Novo Agendamento (Profissional) -->
<div id="modalNovoAgendamento" class="modal" style="z-index: 9999; background: rgba(0,0,0,0.9);">
  <div class="modal-content" style="border: 3px solid var(--cor-destaque); pointer-events: auto;" onclick="event.stopPropagation()">
    <h3 style="color: var(--cor-destaque); animation: flash-red 2s infinite;">🔔 Novo Agendamento!</h3>
    <div id="modalNovoAgendamentoInfo" style="text-align: left; margin-bottom: 20px;">
      <p>Cliente: <span id="popupClienteNome"></span></p>
      <p>Serviço: <span id="popupServicoNome"></span></p>
      <p>Horário: <span id="popupHorario"></span></p>
      <p>Valor: R$ <span id="popupValor"></span></p>
    </div>
    <div style="display: flex; gap: 10px;">
      <button id="btnRecusarAgendamentoPopup" style="background-color: #c0392b; flex: 1;">❌ Recusar</button>
      <button id="btnAceitarAgendamentoPopup" style="background-color: #2ecc71; flex: 1;">✅ Aceitar</button>
    </div>
    <a id="btnWhatsAppPopup" href="#" target="_blank" style="margin-top: 10px; display: block;">
      <button style="background-color: #25D366; width: 100%;">💬 WhatsApp do Cliente</button>
    </a>
  </div>
</div>

<!-- Modal Admin: Lista de Usuários Online -->
<div id="modalUsuariosOnline" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Usuários Online (Últimos 5 min)</h3>
    <div id="listaUsuariosOnline" class="scrollable-list" style="max-height: 60vh;">
      <p>Carregando...</p>
    </div>
    <button data-modal-id="modalUsuariosOnline" onclick="fecharModal(event)" style="margin-top: 15px;">❌ Fechar</button>
  </div>
</div>

<!-- Modal Admin: Info Rápida do Chat -->
<div id="modalAdminInfoChat" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="adminInfoChatNome">Info do Usuário</h3>
    <div id="adminInfoChatConteudo" class="scrollable-list" style="max-height: 50vh; text-align: left;">
      <p>Carregando...</p>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button id="adminInfoChatBtnWpp" onclick="">💬 Chamar no WhatsApp</button>
      <button id="adminInfoChatBtnGerenciar" onclick="">⚙️ Gerenciamento Completo</button>
    </div>
    <button data-modal-id="modalAdminInfoChat" onclick="fecharModal(event)" style="margin-top: 10px;">❌ Fechar</button>
  </div>
</div>

<div id="modalMeuPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
    <h3>👤 Editar Perfil</h3>
    
    <div style="text-align: center; margin-bottom: 15px;">
        <div style="position: relative; display: inline-block;">
            <img id="perfilFotoPreview" src="https://placehold.co/100" class="perfil-foto-grande" style="width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333;">
            <label for="perfilFotoInput" style="position: absolute; bottom: 0; right: 0; background: var(--cor-destaque); color: #000; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">📷</label>
        </div>
        <input type="file" id="perfilFotoInput" accept="image/*" style="display: none;" onchange="previewFotoPerfil()">
    </div>

    <label>Nome de Exibição:</label>
    <input type="text" id="perfilNomeInput" placeholder="Seu nome">

    <div class="popup-section">
        <h4>🎰 Roleta Diária</h4>
        <p id="roletaInfoPremios" style="font-size: 12px; color: #aaa; margin-bottom: 5px;"></p>
        
        <div class="roleta-wrapper-externo">
            
            <div class="seta-externa topo"></div>

            <div id="roletaVisual" class="roleta-container" style="margin: 0;">
                <div class="roleta-faixa" id="roletaFaixa"></div>
            </div>

            <div class="seta-externa baixo"></div>
            
        </div>
        <button id="btnGirarRoleta" onclick="girarRoleta()" style="width: 100%; font-weight: bold; font-size: 16px;">🎲 GIRAR (0)</button>
    </div>

    <div class="popup-section">
        <h4>🖼️ Molduras de Perfil</h4>
        <p style="font-size: 12px; opacity: 0.8;">Selecione para usar (✅) ou clique para comprar.</p>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 10px;" id="listaMolduras">
            </div>
    </div>

    <div class="popup-section">
            <h4>🏅 Exibir Conquistas (Máx 3)</h4>
            <div id="listaSelecaoConquistas" class="scrollable-list" style="max-height: 120px;"></div>
        </div>

        <div class="popup-section" style="border-top: 1px solid var(--cor-borda); padding-top: 15px;">
            <h4>🎯 Missões de Hoje</h4>
            <div id="containerMissoesDiarias">
                <p style="font-size:12px; color:#aaa;">Carregando missões...</p>
            </div>
        </div>

    <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid var(--cor-borda); padding-top: 15px;">
        <button onclick="fecharModalAtual()" style="background-color: #555; flex: 1;">❌ Fechar</button>
        <button onclick="salvarNomePerfil()" style="flex: 1;">💾 Salvar Alterações</button>
    </div>
  </div>
</div>

<div id="modalVisualizarPerfilChat" class="modal" onclick="fecharModal(event)">
  <div class="modal-content perfil-visualizacao" onclick="event.stopPropagation()">
    <div class="perfil-visualizacao-content">
        <img id="visuPerfilFoto" src="" class="perfil-foto-grande">
        <h3 id="visuPerfilNome" style="margin: 5px 0; color: var(--cor-destaque);"></h3>
        <p id="visuPerfilTipo" style="font-size: 12px; opacity: 0.8; color: #fff;"></p>
        
        <div id="visuPerfilConquistas" style="display: flex; justify-content: center; gap: 10px; font-size: 24px; margin: 15px 0;"></div>
        
        <button data-modal-id="modalVisualizarPerfilChat" onclick="fecharModal(event)">Fechar</button>
    </div>
  </div>
</div>

<div id="modalBloqueante" class="modal" style="z-index: 9999; backdrop-filter: blur(5px);">
    <div class="modal-content" style="text-align: center; border: 2px solid var(--cor-destaque);">
        <h3 id="tituloBloqueante" style="color: var(--cor-destaque);">Atenção</h3>
        <p id="msgBloqueante" style="font-size: 1.1em; margin: 20px 0;"></p>
        <button id="btnOkBloqueante" style="width: 100%; padding: 12px; background: var(--cor-destaque); color: var(--cor-fundo); font-weight: bold;">OK</button>
    </div>
</div>

<div id="toastNotification" class="toast-notification">Pressione voltar novamente para sair</div>

<div id="modalGerenciarEquipe" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>👥 Gerenciar Equipe</h3>
    <p>Adicione profissionais ao seu time.</p>
    
    <input id="buscaEquipeInputProprietario" oninput="buscarUsuarioEquipeInstantaneo(this.value)" placeholder="Digite o nome para buscar..." style="margin-bottom: 10px;">
    <div id="resultadoBuscaEquipe" style="max-height: 150px; overflow-y: auto; margin-bottom: 15px; border-bottom: 1px solid #333;"></div>

    <h4>Sua Equipe:</h4>
    <div id="listaEquipeProprietario" class="scrollable-list"></div>
    
    <button data-modal-id="modalGerenciarEquipe" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalFinanceiroProprietario" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Financeiro</h3>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button onclick="carregarFinanceiro('dia')" style="flex:1;">Dia</button>
        <button onclick="carregarFinanceiro('semana')" style="flex:1;">Semana</button>
        <button onclick="carregarFinanceiro('mes')" style="flex:1;">Mês</button>
    </div>

    <div style="background: #fff; padding: 10px; border-radius: 8px;">
        <canvas id="graficoFinanceiro" width="300" height="200"></canvas>
    </div>
    
    <div id="detalhesFinanceiro" class="scrollable-list" style="margin-top: 15px;">
        <p>Selecione um período acima.</p>
    </div>

    <button data-modal-id="modalFinanceiroProprietario" onclick="fecharModal(event)" style="margin-top:15px;">❌ Fechar</button>
  </div>
</div>

<div id="modalCheckIn" class="modal" onclick="fecharModal(event)" style="z-index: 15000;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div style="position:relative; z-index:1;">
        <div style="font-size: 50px; animation: pulse-red 1s infinite;">🔥</div>
        <h3 style="color: #ff4500; font-size: 24px; margin: 10px 0; text-transform: uppercase; font-weight: 900;">Sequência Diária!</h3>
        
        <p style="font-size: 16px; color: white;">Dia <b id="txtDiasSeguidos" style="font-size: 22px; color: gold;">1</b></p>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">
            <p id="txtRecompensaCheckInTitulo" style="color: #2ecc71; font-weight: bold; font-size: 18px; margin: 0;">+5 Pontos</p>
            <p id="txtRecompensaCheckInDesc" style="color: #ccc; font-size: 12px; margin: 5px 0 0 0;">Fidelidade Adicionada</p>
        </div>

        <p style="font-size: 12px; color: #aaa; margin-bottom: 20px;">
            Continue entrando por <strong>7 dias</strong> para ganhar um prêmio ÉPICO!
            <br>(VIP ou Destaque Grátis)
        </p>
        
        <button onclick="fecharModalAtual()" style="background: linear-gradient(45deg, #ff4500, #ff8c00); color: white; width: 100%; border: none; font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);">
            🔥 MANTER O FOGO ACESO
        </button>
    </div>
  </div>
</div>

<div id="modalBatalha" class="modal" style="z-index: 15000;">
  <div class="modal-content" onclick="event.stopPropagation()" style="width: 100%; height: 100%; max-width: 100%; border-radius: 0; padding: 0; background: #000; border: none; display: flex; flex-direction: column;">
    
    <div style="position: absolute; top: 20px; left: 0; width: 100%; z-index: 100; padding: 0 20px; display: flex; justify-content: space-between; pointer-events: none; box-sizing: border-box;">
        <div style="background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--cor-destaque); color: white; font-weight: bold; pointer-events: auto;">
            Votos Hoje: <span id="contadorVotosSession" style="color: var(--cor-destaque);">0/75</span>
        </div>
        <button onclick="fecharModalAtual()" style="background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.5); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; pointer-events: auto; display:flex; align-items:center; justify-content:center;">✕</button>
    </div>

    <div id="loadingBatalha" class="hidden" style="position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index: 60; display: flex; justify-content: center; align-items: center;">
        <div class="spinner"></div>
    </div>

    <div class="battle-arena" style="flex-grow: 1; display: flex; flex-direction: column; height: 100%;">
        
        <div id="batalhaOpcaoA" onclick="votarBatalha('A')" style="flex: 1; position: relative; overflow: hidden; cursor: pointer; border-bottom: 2px solid #fff;">
            <img id="imgBatalhaA" src="" class="battle-img">
            
            <div class="voto-animacao">❤️</div>

            <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 15px;">
                <div style="display:flex; flex-direction: column; align-items: flex-start; text-shadow: 1px 1px 3px #000;">
                    
                    <span style="background: #ff4500; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: bold; text-transform:uppercase; margin-bottom: 4px;">Opção A</span>
                    
                    <b id="nomeBatalhaA" style="display:block; color: white; font-size: 18px; margin-bottom: 4px;">Carregando...

                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 22px;">❤️</span>
                        <span id="likesBatalhaA" style="font-size: 16px; color: #fff; font-weight: bold;">0</span>
                    </div>

                </div>
            </div>
        </div>

        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; background: #ff4500; color: white; font-weight: 900; font-size: 20px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.8); font-style: italic;">VS</div>

        <div id="batalhaOpcaoB" onclick="votarBatalha('B')" style="flex: 1; position: relative; overflow: hidden; cursor: pointer;">
            <img id="imgBatalhaB" src="" class="battle-img">
            
            <div class="voto-animacao">💙</div>

            <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 15px 15px 40px 15px;">
                <div style="display:flex; flex-direction: column; align-items: flex-start; text-shadow: 1px 1px 3px #000;">
                    
                    <span style="background: #00c6ff; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: bold; text-transform:uppercase; margin-bottom: 4px;">Opção B</span>
                    
                    <b id="nomeBatalhaB" style="display:block; color: white; font-size: 18px; margin-bottom: 4px;">Carregando...

                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 22px;">💙</span>
                        <span id="likesBatalhaB" style="font-size: 16px; color: #fff; font-weight: bold;">0</span>
                    </div>

                </div>
            </div>
        </div>

    </div>
  </div>
</div>

<div id="modalNovaTransacao" class="modal" onclick="fecharModal(event)" style="z-index: 26000;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="tituloNovaTransacao">💸 Nova Movimentação</h3>
        
        <label>Descrição:</label>
        <input id="transacaoDescricao" type="text" placeholder="Ex: Conta de Luz, Venda de Shampoo...">
        
        <label>Valor (R$):</label>
        <input id="transacaoValor" type="number" step="0.01" placeholder="0.00">
        
        <label>Data:</label>
        <input id="transacaoData" type="date">
        
        <input type="hidden" id="transacaoTipo">

        <button onclick="salvarTransacaoManual()" id="btnSalvarTransacao" style="margin-top: 15px; width: 100%;">💾 Salvar</button>
        <button onclick="fecharModalAtual()" style="margin-top: 10px; background: #555;">❌ Cancelar</button>
    </div>
</div>

<div id="modalBatalha" class="modal" style="z-index: 20000;">
  <div class="modal-content">
    
    <div style="position: absolute; top: 20px; left: 0; width: 100%; z-index: 100; padding: 0 20px; display: flex; justify-content: space-between; pointer-events: none; box-sizing: border-box;">
        <div style="background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--cor-destaque); color: white; font-weight: bold; pointer-events: auto;">
            Votos: <span id="contadorVotosSession" style="color: var(--cor-destaque);">0</span>
        </div>
        <button onclick="fecharModalAtual()" style="background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.5); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; pointer-events: auto; display:flex; align-items:center; justify-content:center;">✕</button>
    </div>

    <div id="loadingBatalha">
        <div class="spinner"></div>
        <p style="color:#aaa; margin-top:10px;">Buscando estilos...</p>
    </div>

    <div class="battle-container">
        
        <div id="batalhaOpcaoA" onclick="votarBatalha('A')" style="cursor: pointer; pointer-events: auto;">
            <img id="imgBatalhaA" src="" class="battle-img">
            <div class="voto-animacao">❤️</div>
            <div class="battle-info-overlay">
                <span style="background: var(--cor-destaque); color:black; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">OPÇÃO A</span>
                <b id="nomeBatalhaA" style="display:block; color:white; font-size:18px; margin-top:5px; text-shadow: 1px 1px 2px black;">...
            </div>
        </div>

        <div class="battle-vs-badge">VS</div>

        <div id="batalhaOpcaoB" onclick="votarBatalha('B')" style="cursor: pointer; pointer-events: auto;">
            <img id="imgBatalhaB" src="" class="battle-img">
            <div class="voto-animacao">💙</div>
            <div class="battle-info-overlay">
                <span style="background: #00c6ff; color:black; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">OPÇÃO B</span>
                <b id="nomeBatalhaB" style="display:block; color:white; font-size:18px; margin-top:5px; text-shadow: 1px 1px 2px black;">...
            </div>
        </div>

    </div>
  </div>
</div>

<div id="modalPermissoesEquipe" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Gerenciar Acessos</h3>
    <p>O que <b id="nomeMembroPermissao" style="color:var(--cor-destaque)">...</b> pode fazer?</p>
    
    <div style="background: #222; padding: 15px; border-radius: 10px; margin-top: 15px; text-align: left;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <span style="font-weight:bold; display:block;">🚨 SOS Cadeira Vazia</span>
                <span style="font-size:11px; color:#aaa;">Pode lançar ofertas relâmpago?</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="checkPermissaoSOS">
                <span class="slider round"></span>
            </label>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <span style="font-weight:bold; display:block;">🎁 Criar Promoções</span>
                <span style="font-size:11px; color:#aaa;">Pode criar descontos fixos?</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="checkPermissaoPromo">
                <span class="slider round"></span>
            </label>
        </div>

    </div>

    <div style="margin-top: 20px; display:flex; gap:10px;">
        <button onclick="fecharModalAtual()" style="background:#555; flex:1;">Cancelar</button>
        <button id="btnSalvarPermissoes" style="flex:1;">💾 Salvar Acessos</button>
    </div>
  </div>
</div>

<style>
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--cor-destaque); }
input:checked + .slider:before { transform: translateX(24px); }
</style>

<div id="modalAgendaSecretaria" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px; width: 95%; max-height: 90vh; display: flex; flex-direction: column;">
    <div class="modal-header-premium">
        <h3 style="margin:0; color:#fff;">📅 Agenda da Equipe</h3>
        <button onclick="fecharModalAtual()" style="background:transparent; border:none; color:#fff; font-size:20px;">✕</button>
    </div>
    <div id="containerAgendaDetalhada" class="scrollable-list" style="padding: 15px; flex-grow: 1; background: #111;">
        <div class="spinner"></div>
    </div>
  </div>
</div>

<div id="ios-install-prompt" style="
    display:none; 
    position: fixed; 
    bottom: 0; 
    left: 0; 
    right: 0; 
    background: linear-gradient(to right, #1a1a1a, #2c2c2c);
    border-top: 3px solid #d4af37; /* Cor da sua marca */
    padding: 15px 20px; 
    z-index: 99999; /* Prioridade máxima */
    box-shadow: 0 -5px 20px rgba(0,0,0,0.8); 
    font-family: 'Poppins', sans-serif; 
    color: white;
    text-align: center;
">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        
        <img src="https://img.icons8.com/ios-glyphs/30/ffffff/share--v1.png" style="width: 28px; height: 28px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));">

        <div style="flex: 1; margin: 0 15px; text-align: left;">
            <h4 style="margin: 0; color: #d4af37; font-size: 16px; font-weight: 600;">Instale o King Agenda!</h4>
            <p style="font-size: 13px; margin: 2px 0 0 0; line-height: 1.3; color: #ccc;">
                Toque no ícone **Compartilhar** abaixo e depois em **"Adicionar à Tela de Início"**.
            </p>
        </div>

        <button onclick="document.getElementById('ios-install-prompt').style.display='none'" style="background: #333; border: none; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: 600;">
            FECHAR
        </button>
    </div>
</div>

<div id="modal-pagamento" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: #121212; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid #d4af37;">
        <h3 style="color: #d4af37; text-align: center;">Concluir Agendamento</h3>
        <p style="color: #fff; text-align: center; font-size: 14px;">Selecione as formas de pagamento:</p>
        
        <div id="opcoes-pagamento" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <label style="color: white;"><input type="checkbox" onchange="toggleInput('dinheiro')" value="dinheiro"> Dinheiro</label>
            <label style="color: white;"><input type="checkbox" onchange="toggleInput('pix')" value="pix"> Pix</label>
            <label style="color: white;"><input type="checkbox" onchange="toggleInput('credito')" value="credito"> Crédito</label>
            <label style="color: white;"><input type="checkbox" onchange="toggleInput('debito')" value="debito"> Débito</label>
        </div>

        <div id="inputs-valores" style="display: flex; flex-direction: column; gap: 10px;">
            </div>

        <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; text-align: right;">
            <span style="color: #888;">Total:</span>
            <strong id="display-total" style="color: #00ff00; font-size: 20px;">R$ 0,00</strong>
        </div>

        <button onclick="salvarConclusao()" style="width: 100%; background: #d4af37; color: black; padding: 12px; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px;">CONFIRMAR PAGAMENTO</button>
        <button onclick="fecharModalPagamento()" style="width: 100%; background: transparent; color: #888; padding: 10px; border: none; margin-top: 5px;">Cancelar</button>
    </div>
</div>

<button id="btnMinimizadoMapa" onclick="maximizarMapa()">🗺️ ABRIR MAPA EM ANDAMENTO</button>

<div id="modalEntradaManualProfissional" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2147483647; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: #181818; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; color: white; border: 1px solid #d4af37; box-shadow: 0 0 50px rgba(0,0,0,1);">
        <h3 style="margin-top:0; color: #d4af37; text-align:center;">Entrada Manual (Balcão)</h3>
        <p style="color: #ccc; font-size: 13px; margin-bottom: 15px; text-align:center;">
            Marque o serviço realizado. O valor entra no bruto do salão e gera comissão para o barbeiro.
        </p>

        <div id="listaServicosManual" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #333; padding: 5px; border-radius: 8px; background: #111;">
            <p style="text-align:center; padding:10px; color:#666;">Carregando...</p>
        </div>

        <label style="display:block; text-align:left; color:#d4af37; margin-bottom:5px; font-size:12px;">Forma de Pagamento:</label>
        <select id="entradaManualPagamento" class="input-padrao" style="width:100%; padding:12px; margin-bottom:20px; background:#222; color:white; border:1px solid #444; border-radius:8px;">
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">Pix</option>
            <option value="cartao_credito">Cartão de Crédito</option>
            <option value="cartao_debito">Cartão de Débito</option>
        </select>

        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('modalEntradaManualProfissional').style.display='none'" style="flex:1; padding:12px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Cancelar</button>
            <button onclick="confirmarEntradaManual()" style="flex:1; padding:12px; background:linear-gradient(45deg, #d4af37, #f1c40f); color:black; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Confirmar</button>
        </div>
    </div>
</div>

<div id="modalCompraMoedas" class="loja-wrapper" style="display:none;">
    <div class="loja-container">
        <button class="btn-fechar-topo" onclick="fecharModalCompraMoedas()">✕</button>
        
        <div class="loja-header">
            <span class="subtitle">Recarregar Saldo Digital</span>
            <h2>Loja de Diamantes</h2>
            <div style="margin-top: 15px; color: #555; font-size: 11px;">
                💎 Use diamantes para VIP, Itens de Perfil e Impulsos.
            </div>
        </div>

        <div class="loja-content">
            <div id="gridLojaDiamantes" class="loja-grid">
                </div>
        </div>

        <div class="loja-footer-fixo">
            <div style="text-align: center; margin-bottom: 15px; color: #444; font-size: 10px;">
                Pagamento processado com segurança pela Google Play Store
            </div>
            <button class="btn-sair-loja" onclick="fecharModalCompraMoedas()">VOLTAR PARA O APP</button>
        </div>
    </div>
</div>

<div id="rewardOverlay" class="reward-overlay">
    <div class="reward-container">
        <div class="reward-chest">🎁</div>
        
        <div class="reward-content">
            <div class="heart-pulse">❤️</div>
            <div id="rewardPointsTotal" class="points-text">+0</div>
            <div class="points-label">KP Ganhos!</div>
        </div>
    </div>
</div>

<footer class="app-footer">
  <div id="appVersion"></div>
</footer>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script> 

<script>
// --- BLOQUEIOS DE INTERFACE ---
document.addEventListener('contextmenu', event => event.preventDefault()); // Bloqueia botão direito
document.addEventListener('dragstart', event => event.preventDefault());   // Bloqueia arrastar imagens
// Firebase e variáveis globais
const firebaseConfig = {
  apiKey: "AIzaSyDBt7NcU5rP-hsrBZ07ne_HbiMCHRyVcnY",
  authDomain: "navalha-de-ouro-v11.firebaseapp.com",
  projectId: "navalha-de-ouro-v11",
  storageBucket: "navalha-de-ouro-v11.firebasestorage.app",
  messagingSenderId: "434474263075",
  appId: "1:434474263075:web:163893d68a1b5dbe74c796"
};
firebase.initializeApp(firebaseConfig);
var onboardingData = { interesse: 'barbeiro', papel: 'cliente', tipoDetalhado: 'barbeiro' };
const auth = firebase.auth(), db = firebase.firestore();

let popupGenericoCallback = null;

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("Persistência de autenticação definida para 'local'. O usuário ficará logado.");
  })
  .catch((error) => {
    console.error("Erro ao definir a persistência de autenticação:", error);
  });
const storage = firebase.storage();

// --- SISTEMA DE SOM ---
const audioAlert = document.getElementById('sndAlert');
const audioChat = document.getElementById('sndChat');
const audioSuccess = document.getElementById('sndSuccess');
const audioPing = document.getElementById('sndPing');
let alertLoopInterval = null;

// URLs de Imagens (Alta Qualidade)
var IMG_ONBOARD_1 = "https://images.unsplash.com/photo-1503951914875-452162b0f3f1?q=80&w=2070&auto=format&fit=crop&q=80&w=1080";
var IMG_ONBOARD_2 = "https://images.unsplash.com/photo-1629198688000-71f23e745b6e?q=80&w=1080&auto=format&fit=crop&q=80&w=1080";
var IMG_ONBOARD_3 = "https://images.unsplash.com/photo-1534367610401-9f5ed68180aa?q=80&w=1080&auto=format&fit=crop&q=80&w=1080";  
var IMG_ONBOARD_4 = "https://images.unsplash.com/photo-1599351431202-1e0f0137899a?q=80&w=1998&auto=format&fit=crop"; 
// Imagem para a Tela 5 (Ambiente Feminino/Salão)
var IMG_ONBOARD_5 = "https://images.unsplash.com/photo-1560066984-138dadb4c035?q=80&w=1974&auto=format&fit=crop";

// --- LÓGICA DE REINÍCIO RÁPIDO (SKIP INTRO) ---
(function verificarReinicioRapido() {
    // Verifica se existe a "bandeira" de reinício rápido
    const isQuickRestart = sessionStorage.getItem('quickRestartV2');
    
    if (isQuickRestart === 'true') {
        console.log("⚡ Reinício Rápido Detectado: Pulando Intro...");
        
        // Cria um estilo forçado para esconder a intro imediatamente
        const style = document.createElement('style');
        style.innerHTML = `
            #introScreen, #telaSparks, .intro-container { 
                display: none !important; 
                opacity: 0 !important; 
                z-index: -999 !important;
            }
        `;
        document.head.appendChild(style);
        
        // Remove a bandeira para o próximo acesso ser normal
        sessionStorage.removeItem('quickRestartV2');
    }
})();

// Variável global para armazenar o almoço atual
let horarioAlmocoGlobal = null; 

async function definirHorarioAlmoco() {
    // Pergunta simples ou input time
    const novoHorario = prompt("Digite a hora de início do almoço (ex: 12:00):");
    
    if (novoHorario && novoHorario.includes(':')) {
        const user = firebase.auth().currentUser;
        if(user) {
            // Salva no perfil do usuário no Firestore
            await db.collection('usuarios').doc(user.uid).update({
                horarioAlmoco: novoHorario
            });
            alert("Horário de almoço definido para: " + novoHorario);
            verificarStatusAlmoco(novoHorario);
        }
    }
}

// Detecta se estamos num In-App Browser (muito comum em redes sociais)
function isInstagramBrowser() {
    const userAgent = navigator.userAgent;
    // O UA do Instagram iOS, Facebook e TikTok frequentemente contém "CriOS" (Chrome iOS) ou "FBAV" (Facebook App), mas o mais confiável é a ausência de "Safari"
    return userAgent.includes('Mobile') && !userAgent.includes('Safari');
}

function verificarInstalacaoIOS() {
    const promptElement = document.getElementById('ios-install-prompt');
    if (!promptElement || !isIOS() || isStandalone()) {
        return; // Não é iOS, já está instalado, ou elemento não existe
    }

    // --- Lógica de Forçar Safari ---
    if (isInstagramBrowser()) {
        // Se estiver num navegador interno, mostra um alerta e um botão para copiar o link
        const urlAtual = window.location.href;
        
        promptElement.innerHTML = `
            <div style="text-align: center; padding: 10px 0;">
                <h4 style="margin: 0; color: #d4af37; font-size: 18px; font-weight: 600;">Atenção, iPhone! 🚨</h4>
                <p style="font-size: 14px; margin: 10px 0 15px 0; color: #ccc;">
                    Para **INSTALAR** o app, você precisa abrir o site no **Safari**.
                </p>
                
                <button onclick="copiarLinkESair('${urlAtual}')" style="background: #d4af37; color: black; padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 10px;">
                    COPIAR LINK E ABRIR FORA
                </button>
                <p style="font-size: 12px; color: #888; margin: 5px 0 0 0;">(Cole no Safari para continuar)</p>
            </div>
        `;
        promptElement.style.display = 'block';

    } else {
        // Se estiver no Safari ou Chrome mobile normal, mostra o tutorial de instalação
        promptElement.style.display = 'block';
    }
    
    // Assegura prioridade máxima
    promptElement.style.zIndex = '99999';
}

function copiarLinkESair(link) {
    // Tenta copiar o link para a área de transferência
    navigator.clipboard.writeText(link).then(() => {
        alert("Link copiado! Por favor, cole o link agora no navegador Safari para prosseguir com a instalação.");
        // Oculta o prompt, mas o usuário deve fechar o navegador in-app manualmente.
        document.getElementById('ios-install-prompt').style.display = 'none';
    }).catch(err => {
        console.error('Erro ao copiar link:', err);
        alert("Não foi possível copiar o link automaticamente. Copie o endereço da barra de navegação e abra no Safari.");
    });
}

// ... Mantendo o seu DOMContentLoaded
document.addEventListener("DOMContentLoaded", function() {
    // Delay de 500ms para garantir que o Onboarding carregue primeiro
    setTimeout(verificarInstalacaoIOS, 500); 
});

function verificarStatusAlmoco(horarioDefinido) {
    if (!horarioDefinido) return;
    
    const agora = new Date();
    const horaAtual = agora.getHours();
    const [horaAlmoco, minAlmoco] = horarioDefinido.split(':').map(Number);
    
    // Regra: Consideramos "Almoçando" durante 1 hora a partir do horário definido
    if (horaAtual === horaAlmoco) {
        // BLOQUEIA TUDO
        const containerAgenda = document.getElementById('gradeHorarios'); // ID fictício, use o ID da sua div de horários
        if(containerAgenda) {
            containerAgenda.innerHTML = `
                <div class="card-almoco" style="background: #2a2a2a; color: white; padding: 20px; text-align: center; border-radius: 10px; border: 2px solid red;">
                    <h3>🍔 Profissional Almoçando</h3>
                    <p>Retorna às ${horaAlmoco + 1}:00</p>
                </div>
            `;
        }
    }
}

    // LÓGICA DE DETECÇÃO IOS
    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    
    // Verifica se já está em modo PWA (Tela cheia)
    function isStandalone() {
        return ('standalone' in window.navigator) && (window.navigator.standalone);
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Se for iOS E não estiver instalado
        if (isIOS() && !isStandalone()) {
            document.getElementById('ios-install-prompt').style.display = 'block';
        }
    });

function trocarConteudoOnboarding(html, bgImage) {
    const contentDiv = document.getElementById('onboardingContent');
    // Fade Out
    contentDiv.style.opacity = '0';
    
    setTimeout(() => {
        // Troca Conteúdo
        contentDiv.innerHTML = html;
        // Troca Fundo (aplica na div fullscreen interna)
        const fullScreenDiv = contentDiv.querySelector('.onboarding-full-screen');
        if (fullScreenDiv && bgImage) {
            fullScreenDiv.style.backgroundImage = `url('${bgImage}')`;
        }
        // Fade In
        contentDiv.style.opacity = '1';
    }, 400); 
}

function tocarSom(tipo) {
    // Para e reinicia qualquer som anterior para evitar sobreposição
    if (audioAlert) { audioAlert.pause(); audioAlert.currentTime = 0; }
    if (audioSuccess) { audioSuccess.pause(); audioSuccess.currentTime = 0; }
    if (audioPing) { audioPing.pause(); audioPing.currentTime = 0; }
    if (audioChat) { audioChat.pause(); audioChat.currentTime = 0; }


    try {
        if (tipo === 'sucesso') audioSuccess.play().catch(e=>{});
        if (tipo === 'ping') audioPing.play().catch(e=>{});
        if (tipo === 'Chat') audioChat.play().catch(e=>{});

        
        if (tipo === 'alerta') {
            // CORREÇÃO: Toca apenas UMA VEZ. O loop é controlado pelo listener.
            audioAlert.play().catch(e=>{}); 
        }
    } catch(e) { console.warn("Erro audio:", e); }
}

function pararSomAlerta() {
    if (audioAlert) { 
        audioAlert.pause(); 
        audioAlert.currentTime = 0; 
    }
}

// --- FUNÇÃO MÁGICA DE PRECARREGAMENTO ---
function preloadImages() {
    const urls = [IMG_ONBOARD_1, IMG_ONBOARD_2, IMG_ONBOARD_3, IMG_ONBOARD_4, IMG_ONBOARD_5];
    urls.forEach(url => {
        const img = new Image();
        img.src = url; // Isso força o navegador a baixar a imagem para o cache
    });
    console.log("Imagens de onboarding pré-carregadas.");
}

window.addEventListener('load', () => {
    // 1. Pré-carregamento (se existir a função)
    if (typeof preloadImages === 'function') preloadImages();

    // TRAVA A ROLAGEM NA ENTRADA (Para a tela não sambar)
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    // Arma histórico do botão voltar
    if (typeof armarHistorico === 'function') setTimeout(armarHistorico, 500);

    const splash = document.getElementById('cinematicSplash');
    
    // VERIFICAÇÃO DE RELOAD RÁPIDO (Ex: Trocar tema, comprar VIP)
    if (localStorage.getItem('pular_splash_inicial') === 'true') {
        console.log("Reinício rápido. Pulando splash.");
        localStorage.removeItem('pular_splash_inicial');
        
        if (splash) splash.style.display = 'none';
        
        // --- LIBERA O SCROLL IMEDIATAMENTE ---
        document.body.style.overflow = 'auto';
        document.body.style.overflowX = 'hidden';
        document.documentElement.style.overflow = 'auto';
        
        executarRoteamentoInicial();
    } 
    else {
        // APRESENTAÇÃO CINEMATOGRÁFICA (5 Segundos)
        if (splash) {
            // Animações visuais (Faíscas)
            for(let i=0; i<40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = (Math.random() * 100) + '%';
                p.style.top = (Math.random() * 100 + 50) + '%'; 
                p.style.setProperty('--tx', (Math.random() * 200 - 100) + 'px'); 
                p.style.setProperty('--ty', '-' + (Math.random() * 800 + 600) + 'px'); 
                p.style.animationDuration = (Math.random() * 3 + 3) + 's'; 
                splash.appendChild(p);
            }

            setTimeout(() => {
                const aura = document.querySelector('.logo-aura');
                if(aura) aura.classList.add('active'); 
                const logo = document.getElementById('splashLogo');
                if(logo) logo.classList.add('emerge'); 
            }, 300);

            setTimeout(() => {
                const appName = document.getElementById('splashAppName');
                if(appName) appName.classList.add('show');
            }, 1000);
            
            // Checklist estilo terminal
            const checks = ['check1', 'check2', 'check3', 'check4', 'check5'];
            let delay = 1500;
            checks.forEach(id => {
                setTimeout(() => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.classList.add('visible');
                        el.querySelector('.status').textContent = 'OK';
                        el.querySelector('.status').classList.add('success');
                    }
                }, delay);
                delay += 500;
            });

            // FINALIZA E ABRE O APP
            setTimeout(() => {
                splash.style.transition = 'opacity 0.8s';
                splash.style.opacity = '0';
                
                setTimeout(() => { 
                    splash.style.display = 'none'; 

                    // --- CORREÇÃO DO SCROLL AQUI ---
                    document.body.style.overflow = 'auto'; // Libera rolagem vertical
                    document.body.style.overflowX = 'hidden'; // Trava horizontal
                    document.documentElement.style.overflow = 'auto'; 
                    // ------------------------------

                    executarRoteamentoInicial(); 
                }, 800);
            }, delay + 800); 

        } else {
            // Fallback se não tiver splash
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
            executarRoteamentoInicial();
        }
    }
});

// --- FUNÇÃO DE ROTEAMENTO (CORRIGIDA) ---
function executarRoteamentoInicial() {
    auth.onAuthStateChanged(user => {
        if (user) {
            // CASO 1: Usuário Logado (Autologin)
            console.log("Usuário detectado:", user.uid);
            carregarPerfilUsuario(user.uid);
            
            // Garante que o onboarding suma visualmente
            const modal = document.getElementById('modalOnboarding');
            if(modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        } else {
            // CASO 2: Sem Usuário (Logout ou Primeira Vez)
            
            // VERIFICAÇÃO CRÍTICA: Já concluiu o onboarding neste navegador?
            const jaFezOnboarding = localStorage.getItem('onboarding_concluido');

            if (jaFezOnboarding === 'true') {
                console.log("Onboarding já feito. Forçando tela de LOGIN.");
                
                // 1. Esconde Onboarding explicitamente
                const modal = document.getElementById('modalOnboarding');
                if(modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
                
                // 2. Abre a tela de Login/Auth
                mostrar('authView');
                
                // 3. Limpa qualquer modal aberto residual
                fecharTodosOsModais();

            } else {
                console.log("Primeira vez ou dados limpos. Iniciando Onboarding.");
                iniciarNovoOnboarding(); 
            }
        }
    });
}

// --- LÓGICA MESTRE DO APP (SUBSTITUI LOGICA DE LOGIN ANTIGA) ---
function iniciarLogicaApp() {
    // Verifica se já existe um usuário (anonimo ou real)
    auth.onAuthStateChanged(user => {
        if (user) {
            console.log("Usuário detectado:", user.uid, "Anônimo:", user.isAnonymous);
            carregarPerfilUsuario(user.uid);
        } else {
            console.log("Nenhum usuário. Iniciando Onboarding.");
            iniciarNovoOnboarding();
        }
    });
}

// ==================================================================
// === NOVO FLUXO ONBOARDING (IMAGENS REAIS + TRANSIÇÃO SUAVE) ===
// ==================================================================

var onboardingDataTemp = {
    interesse: 'barbeiro', 
    papel: 'cliente'
};

function verificarEstadoInicial() {
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuário logado (anônimo ou real)
            console.log("Usuário detectado:", user.uid);
            carregarPerfilUsuario(user.uid);
            
            // Garante que o onboarding suma
            const modal = document.getElementById('modalOnboarding');
            if(modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        } else {
            // Sem usuário (Logout ou Primeira vez)
            
            // --- CORREÇÃO AQUI: Verifica se já concluiu o onboarding ---
            if (localStorage.getItem('onboarding_concluido') === 'true') {
                console.log("Onboarding já feito. Indo para login.");
                
                // Esconde o modal de onboarding explicitamente
                const modal = document.getElementById('modalOnboarding');
                if(modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
                
                // Mostra a tela de login
                mostrar('authView');
            } else {
                console.log("Primeira vez. Iniciando Onboarding.");
                iniciarNovoOnboarding(); 
            }
        }
    });
}

function iniciarNovoOnboarding() {
    const modal = document.getElementById('modalOnboarding');
    modal.style.display = 'block';
    modal.classList.add('show');
    renderOnboardingTela1();
}

// TELA 1: VAGA IMEDIATA
function renderOnboardingTela1() {
    const html = `
        <div class="onboarding-full-screen" style="background-image: url('${IMG_ONBOARD_1}');">
            <div class="onboarding-overlay"></div>
            <div class="onboarding-inner-content">
                <h1 class="cine-title-v2">Vaga<span>IMEDIATA</span></h1>
                <p class="cine-text-v2">Encontre profissionais disponíveis agora. Sem espera, apenas estilo.</p>
                <button class="btn-cine-action" onclick="renderOnboardingTela2()">Começar</button>
            </div>
        </div>`;
    // Renderização inicial direta (sem fade out se estiver vazio)
    const contentDiv = document.getElementById('onboardingContent');
    if(contentDiv.innerHTML.trim() === '') {
        contentDiv.innerHTML = html;
        contentDiv.style.opacity = '1';
    } else {
        trocarConteudoOnboarding(html, IMG_ONBOARD_1);
    }
}

// TELA 2: MARKETPLACE
function renderOnboardingTela2() {
    const html = `
        <div class="onboarding-full-screen">
            <div class="onboarding-overlay"></div>
            <div class="onboarding-inner-content">
                <h1 class="cine-title-v2" style="color:#FF8C69">Market<span>PLACE</span></h1>
                <p class="cine-text-v2">Compre produtos exclusivos diretamente da sua barbearia ou salão favorito.</p>
                <button class="btn-cine-action" onclick="renderOnboardingTela3()" style="background:rgba(255, 140, 105, 0.9); border-color:#FF8C69;">Continuar</button>
            </div>
        </div>`;
    trocarConteudoOnboarding(html, IMG_ONBOARD_2);
}

// TELA 3: ESCOLHA DE CATEGORIA (Barbearia ou Salão)
function renderOnboardingTela3() {
    const html = `
        <div class="onboarding-full-screen">
            <div class="onboarding-overlay"></div>
            <div class="onboarding-inner-content">
                <h1 class="cine-title-v2">Seu<span>ESTILO</span></h1>
                <p class="cine-text-v2">O que você procura?</p>
                
                <div class="cine-option-card" onclick="processarEscolhaTela3('barbeiro')">
                    <span class="cine-option-icon">💈</span>
                    <div class="cine-option-info"><h4>Barbearias</h4><p>Cortes, Barba e Estilo</p></div>
                </div>

                <div class="cine-option-card" onclick="processarEscolhaTela3('cabelereira')">
                    <span class="cine-option-icon">💇‍♀️</span>
                    <div class="cine-option-info"><h4>Cabeleireira / Estética</h4><p>Unhas, Cílios e Cabelo</p></div>
                </div>
            </div>
        </div>`;
    trocarConteudoOnboarding(html, IMG_ONBOARD_3);
}

// Lógica de Decisão da Tela 3
function processarEscolhaTela3(escolha) {
    tocarSom('ping');
    if (escolha === 'barbeiro') {
        // Se for barbeiro, já sabemos o tipo detalhado. Pula pra Tela 4.
        onboardingData.interesse = 'barbeiro';
        onboardingData.tipoDetalhado = 'barbeiro';
        renderOnboardingTela4();
    } else {
        // Se for Cabelereira/Estética, vamos para a Tela 5 escolher o sub-nicho
        onboardingData.interesse = 'cabelereira'; // Categoria macro
        renderOnboardingTela5();
    }
}

// TELA 5: SUB-NICHO FEMININO (NOVA TELA!)
function renderOnboardingTela5() {
    const html = `
        <div class="onboarding-full-screen">
            <div class="onboarding-overlay"></div>
            <div class="onboarding-inner-content">
                <h1 class="cine-title-v2" style="color:#FF8C69">Sua<span>ÁREA</span></h1>
                <p class="cine-text-v2">Especifique sua preferência:</p>
                
                <div class="cine-option-card" onclick="processarEscolhaTela5('cabelereira')">
                    <span class="cine-option-icon">💇‍♀️</span>
                    <div class="cine-option-info"><h4>Cabelereira</h4><p>Cortes, Química e Penteados</p></div>
                </div>

                <div class="cine-option-card" onclick="processarEscolhaTela5('manicure_pedicure')">
                    <span class="cine-option-icon">💅</span>
                    <div class="cine-option-info"><h4>Manicure/Pedicure</h4><p>Unhas e Cuidados</p></div>
                </div>

                <div class="cine-option-card" onclick="processarEscolhaTela5('designer_cilios')">
                    <span class="cine-option-icon">👁️</span>
                    <div class="cine-option-info"><h4>Designer de Cílios</h4><p>Extensão e Sobrancelhas</p></div>
                </div>
            </div>
        </div>`;
    trocarConteudoOnboarding(html, IMG_ONBOARD_5);
}

// Lógica de Decisão da Tela 5
function processarEscolhaTela5(subTipo) {
    tocarSom('ping');
    onboardingData.tipoDetalhado = subTipo; // Salva o tipo específico (ex: manicure_pedicure)
    renderOnboardingTela4(); // Agora vai para a escolha de Cliente/Profissional
}

function renderOnboardingTela4() {
    const html = `
        <div class="onboarding-full-screen">
            <div class="onboarding-overlay"></div>
            <div class="onboarding-inner-content">
                <h1 class="cine-title-v2">Você<span>É...</span></h1>
                <p class="cine-text-v2">Escolha seu perfil de acesso.</p>
                
                <div class="cine-option-card" onclick="finalizarOnboardingAnonimo('cliente')">
                    <span class="cine-option-icon">🙋</span>
                    <div class="cine-option-info"><h4>Sou Cliente</h4><p>Quero agendar e comprar</p></div>
                </div>

                <div class="cine-option-card" onclick="finalizarOnboardingAnonimo('profissional')">
                    <span class="cine-option-icon">💼</span>
                    <div class="cine-option-info"><h4>Sou Profissional</h4><p>Gerenciar meus serviços</p></div>
                </div>
            </div>
        </div>`;
    trocarConteudoOnboarding(html, IMG_ONBOARD_4);
}

// --- FINALIZAÇÃO E CRIAÇÃO DA CONTA ANÔNIMA ---
function finalizarOnboardingAnonimo(papel) {
    exibirAguarde("Configurando e reiniciando...");
    if (papel) onboardingData.papel = papel;

    // --- ALTERAÇÃO AQUI: Define que conta anônima NÃO salva no cache permanente ---
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION).then(() => {
        return auth.signInAnonymously();
    }).then(async (cred) => {
        const uid = cred.user.uid;
        let tipoFinal = 'cliente';

        // Lógica de Tipo Atualizada
        if (onboardingData.papel === 'profissional') {
            if (onboardingData.interesse === 'barbeiro') {
                tipoFinal = 'barbeiro';
            } else {
                tipoFinal = onboardingData.tipoDetalhado || 'cabelereira';
            }
        } else if (onboardingData.papel === 'secretaria') {
            // NOVA OPÇÃO
            tipoFinal = 'secretaria';
        } else {
            tipoFinal = 'cliente';
        }

        const dadosIniciais = {
            tipo: tipoFinal,
            interesse_principal: onboardingData.interesse || 'barbeiro',
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            isAnonymous: true,
            nome: 'Visitante',
            saldo: 0,
            reputacao: 100,
            vagaImediata: false,
            usaAgendaManual: false,
            lojaLiberada: false,
            vip: false,
            proAtivo: false
        };

        // 1. Salva no banco
        await db.collection('usuarios').doc(uid).set(dadosIniciais);
        
        // 2. Marca onboarding como concluído
        localStorage.setItem('onboarding_concluido', 'true');

        // 3. SETA A FLAG PARA PULAR O SPLASH NO PRÓXIMO LOAD
        localStorage.setItem('pular_splash_inicial', 'true');

        // 4. Fecha modais
        fecharTodosOsModais();

        // 5. REINICIA O APP
        location.reload();

    }).catch((error) => {
        fecharTodosOsModais();
        exibirPopup("Erro ao iniciar", error.message);
    });
}

function carregarPerfilUsuario(uid) {
  const ref = db.collection("usuarios").doc(uid);
  console.log("Iniciando listener do perfil para:", uid);

  perfilListenerUnsubscribe = ref.onSnapshot(s => {
    // CORREÇÃO: Em vez de deslogar na hora, apenas avisa que está preparando
    if (!s.exists) {
        console.log("Aguardando criação do documento do perfil...");
        return; // Não dê signOut() aqui! Deixe o Firestore tentar de novo.
    }
    
    const perfilAtual = s.data();
        const isInitialLoad = !perfil; 
        
        perfil = perfilAtual;
        perfil.uid = uid;

        // Atualiza visual do botão de vaga
        atualizarVisualBotaoVaga(); 

        // INICIA O MONITORAMENTO DE CONTINGÊNCIA
        if (perfil.isProprietario || perfil.tipo === 'secretaria') {
            // Verifica se a função existe antes de chamar
            if (typeof iniciarMonitoramentoEquipeGlobal === 'function') {
                iniciarMonitoramentoEquipeGlobal(uid);
            }
        }
        // ------------------------------------------------

        // INICIA O MONITORAMENTO DE CONTINGÊNCIA (BOTÃO RODAPÉ)
        if (perfil.tipo !== 'cliente') {
            iniciarMonitoramentoMapaAtivo(uid);
        }

        if (typeof verificarInterfaceDesktop === 'function') {
            verificarInterfaceDesktop();
        }

        atualizarVisibilidadeBotaoCheckin();
        verificarValidadePlano(perfil, uid);
        if (!isInitialLoad) verificarLimpezaItensExpirados(perfil);

        // Define cores do tema
        const body = document.body;
        if (perfil.interesse_principal === 'cabelereira' || perfil.tipo === 'manicure_pedicure') {
            body.classList.add('tema-feminino');
            document.documentElement.style.setProperty('--cor-destaque', 'var(--cor-destaque-salmao)');
        } else {
            body.classList.remove('tema-feminino');
            document.documentElement.style.setProperty('--cor-destaque', 'var(--cor-destaque-ouro)');
        }

        // --- LÓGICA EXECUTADA APENAS NO PRIMEIRO CARREGAMENTO ---
        if (isInitialLoad) {
            console.log("Carregamento inicial concluído. Tipo:", perfil.tipo);
           
            iniciarListenerConvites(uid);
            previousTipo = perfil.tipo;
            verificarCheckInDiario(perfilAtual);
            verificarRastreamentoPendente(); 

            if (perfil.tipo === 'cliente' && typeof verificarRetornoInteligente === 'function') {
                verificarRetornoInteligente();
            }

            // Define o tipo original
            if (!userView.originalType) {
                userView.originalType = perfil.tipo;
            }
            
            // --- ROTEAMENTO DE VIEWS (LÓGICA PRINCIPAL) ---
            // AQUI ESTAVA O ERRO: Definimos o currentType ANTES de chamar o render
            
            if (perfil.tipo === 'admin') {
                userView.currentType = 'admin';
                mostrar('adminView');
                carregarAdmin();
            } 
            else if (perfil.tipo === 'secretaria') {
                // SECRETÁRIA: Define explicitamente que a visão dela é 'profissionais'
                userView.currentType = 'profissionais';
                mostrar('profissionaisView');
                
                // Configura o painel dela
                if(typeof configurarPainelSecretaria === 'function') configurarPainelSecretaria();
                
                // Carrega a equipe
                setTimeout(() => carregarVisaoGeralEquipe(), 100);
            } 
            else if (perfil.tipo !== 'cliente') {
                // PROFISSIONAIS COMUNS
                userView.currentType = 'barbeiro'; // Ou o tipo específico
                mostrar('barbeiroView');
                carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
            } 
            else {
                // CLIENTE
                userView.currentType = 'cliente';
                mostrar('clienteView');
                if(typeof renderizarFiltrosNicho === 'function') renderizarFiltrosNicho();
                carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
            }
            
            // AGORA SIM chamamos o renderizador do menu/layout
            // Como userView.currentType já está certo ('profissionais'), ele não vai cair no default (Login)
            renderCurrentView(); 

            setupFCM(uid);
            checarParametrosURL();

            // Avaliação pendente
            const avaliacaoPendente = localStorage.getItem('abrir_avaliacao_pendente');
            if (avaliacaoPendente) {
                try {
                    const dados = JSON.parse(avaliacaoPendente);
                    localStorage.removeItem('abrir_avaliacao_pendente'); 
                    setTimeout(() => {
                        abrirModalAvaliacao(dados.agendamentoId, dados.barbeiroUid);
                    }, 1000);
                } catch (e) { console.error(e); }
            }
            
            if (!window.loginSoundPlayed) { tocarSom('sucesso'); window.loginSoundPlayed = true; }
        } 
        
        // Atualizações visuais de topo
        const saldoDigital = (perfil.saldoDigital || 0).toFixed(2);
        const elSaldo = document.getElementById("saldoHeader");
        if(elSaldo) elSaldo.textContent = saldoDigital;
        
        const btnVip = document.getElementById('btnVip');
        if (btnVip) {
            if (isVipAtivo(perfil)) {
                btnVip.textContent = '👑 Sou VIP'; btnVip.classList.add('vip-glow');
            } else {
                btnVip.textContent = '💎 VIP'; btnVip.classList.remove('vip-glow');
            }
        }
        
        // Reload forçado pelo admin
        if (perfilAtual.forceReloadTimestamp && lastReloadTimestamp && perfilAtual.forceReloadTimestamp.toMillis() > lastReloadTimestamp.toMillis()) {
            location.reload();
        }
        if (perfilAtual.forceReloadTimestamp) lastReloadTimestamp = perfilAtual.forceReloadTimestamp;

    }, error => { 
        console.error("Erro no perfil:", error);
    });
}

// --- FILTROS DE NICHO (Cabelo/Unha/Olho) ---
function renderizarFiltrosNicho() {
    // Só exibe se for tema feminino
    if (!document.body.classList.contains('tema-feminino')) return;

    const container = document.getElementById('listaBarbeirosPrincipalCliente'); // Ou o container correto
    // Cria a div de filtros antes da lista
    if (!document.getElementById('nicheFilters')) {
        const div = document.createElement('div');
        div.id = 'nicheFilters';
        div.className = 'niche-filters';
            }
}

function filtrarNicho(tipo, btnElement) {
    // Atualiza visual dos botões
    document.querySelectorAll('.niche-filter-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');

    // Mapeia emojis para tipos de usuário ou tags
    // No seu caso, você precisará adaptar a query do 'carregarBarbeirosPrincipal' para filtrar por isso
    // Exemplo: window.filtroAtualNicho = tipo; carregarBarbeirosPrincipal(...);
    
    // Por enquanto, apenas um feedback visual
    tocarSom('ping');
    console.log("Filtrando por:", tipo);
    // Aqui você chamaria carregarBarbeirosPrincipal passando o filtro
}

// --- GUARDIÃO DE VISITANTE (GUEST GUARD) ---
function checkGuestLimit() {
    if (auth.currentUser && auth.currentUser.isAnonymous) {
        tocarSom('alerta'); 
        
        exibirConfirmacao(
            "Crie sua conta!", 
            "Para finalizar essa ação e proteger seu saldo/agendamento, você precisa de um registro oficial. É rápido e gratuito!",
            () => {
                // Ação ao clicar em SIM:
                fecharTodosOsModais();
                
                // 1. Prepara a tela de Auth para modo CADASTRO
                prepararCriarConta(); 
                
                // 2. Se ele estava tentando agendar (tem dados salvos), 
                // podemos salvar um flag para tentar voltar depois (opcional avançado),
                // mas por enquanto, levamos ao cadastro.
                mostrar('authView');
            }
        );
        return true; // Bloqueia a ação original
    }
    return false; // Permite a ação
}

const messaging = firebase.messaging();

// --- CONTROLE DE VOLTAR (DUPLO CLIQUE PARA SAIR) ---
let ignoreNextPopstate = false; 
let backPressTime = 0; 

// Função que cria a "armadilha" no histórico
function armarHistorico() {
    // Só adiciona se já não estiver no estado 'home' para evitar duplicatas infinitas
    if (!history.state || history.state.page !== "home") {
        window.history.pushState({ page: "home" }, "", window.location.href);
    }
}

// Garante que o histórico seja armado assim que a página carregar
window.addEventListener('load', () => {
    setTimeout(armarHistorico, 500);
});

// Listener do Botão Voltar (Android)
window.addEventListener('popstate', (event) => {
    // 1. Se foi manipulação manual do JS (fechar modal), ignora a lógica de sair
    if (ignoreNextPopstate) {
        ignoreNextPopstate = false;
        return;
    }

    // 2. PRIORIDADE: Se tem modal aberto, fecha o modal e FICA no app
    if (modalStack.length > 0) {
        // Fecha o modal visualmente
        fecharModalAtual(false, true); 
        
        // REARMA O HISTÓRICO: Como o usuário clicou voltar, ele consumiu um estado.
        // Precisamos empurrar de novo para ele não sair na próxima.
        window.history.pushState({ page: "modal_closed" }, "", window.location.href);
        return;
    }

    // 3. Lógica de Sair (Tela Principal)
    const now = new Date().getTime();
    
    // Se o clique for rápido (menos de 2s do anterior)
    if (now - backPressTime < 2000) {
        // DEIXA SAIR: Não fazemos pushState aqui. 
        // O histórico esvazia e o navegador minimiza/fecha o app.
        return; 
    } else {
        // PRIMEIRO CLIQUE
        backPressTime = now;
        
        // Mostra o aviso "Pressione voltar novamente para sair"
        mostrarToastSair();
        
        // REARMA A ARMADILHA: Empurra o estado de volta imediatamente
        // Isso impede que o app feche neste primeiro clique
        window.history.pushState({ page: "home" }, "", window.location.href);
    }
}); 

// ADICIONE ESTAS LINHAS ABAIXO (Linha ~2241)
let isTwa = false; // Variável global para o ambiente
let avisoEntregaRealizadoSessao = false; // Controle para o popup de entrega

// --- CONFIGURAÇÕES GERAIS E FINANCEIRAS ---
const PIX_CODE_RAW = "00020126770014BR.GOV.BCB.PIX0136ac099e3b-e63e-402f-9d3e-6e20828470b90215Nova Versão APP5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510ERLNMtaT5r63040E73";

// Variável global para controlar o tipo de depósito atual (serviço ou digital)
let tipoDepositoAtual = 'servico'; 

// Função para detectar se está no App (TWA) ou Navegador
function detectarAmbiente() {
    const urlParams = new URLSearchParams(window.location.search);
    // Verifica parâmetro URL ou se o referer vem de um app android
    if (urlParams.get('source') === 'twa' || document.referrer.includes('android-app')) {
        isTwa = true;
        console.log("Ambiente detectado: TWA (Google Play)");
    } else {
        isTwa = false;
        console.log("Ambiente detectado: Web (Navegador)");
    }
}
detectarAmbiente();

// Chama a função para definir a variável 'isTwa' na inicialização
detectarAmbiente(); 
const ADMIN_EMAIL = "josiel70c@gmail.com";
const ADMIN_PASS = "Ja997640401";
const TAXA = 0.0; // Atualizado para 0%
const BONUS_INDICACAO = 100;
const PONTOS_POR_CORTE = 10;
const PONTOS_PARA_RESGATE = 100;
const VALOR_RESGATE = 5;
const PONTOS_POR_DEPOSITO_NORMAL = 4;
const PONTOS_POR_DEPOSITO_VIP = 8;
const WHATSAPP_ADM_PHONE = "5527995003737"; // Mantido
const PRECO_VIP = 29.90; 
const PRECO_TURBINAR = 9.99;

const PRECOS_PRO = { 
    tier1: { nome: 'Bronze', preco: 9.90, cortado: 19.90, giros: 2, desc: 'Libera Vaga Imediata.' }, 
    tier2: { nome: 'Prata', preco: 29.90, cortado: 59.90, giros: 3, desc: 'Vaga Imediata + Agenda Programada.' }, 
    tier3: { nome: 'Ouro', preco: 59.90, cortado: 119.90, giros: 4, desc: 'Tudo do Prata + Loja (5% taxa) + Fachada + Destaque.' }, 
    tier4: { nome: 'Diamante', preco: 99.90, cortado: 199.90, giros: 5, desc: '👑 SUPREMO: Loja 0% Taxa, Stories, Molduras/Balões, Gestão de Equipe, Topo da Lista!' }
};

function getTaxaLoja(perfilUsuario) {
    if (perfilUsuario.tipo === 'admin') return 0;
    if (!isProAtivo(perfilUsuario)) return 0.10; // Padrão 10%
    
    const tier = perfilUsuario.proTier;
    if (tier === 'tier3') return 0.05; // Ouro 5%
    if (tier === 'tier4') return 0.00; // Diamante 0%
    return 0.10; // Bronze/Prata mantém 10%
}

// Novas Molduras
const MOLDURAS = {
    bronze: { nome: 'Bronze', preco: 9.99, classe: 'avatar-frame-bronze' },
    prata: { nome: 'Prata', preco: 19.99, classe: 'avatar-frame-prata' },
    ouro: { nome: 'Ouro', preco: 29.99, classe: 'avatar-frame-ouro' },
    diamante: { nome: 'Diamante', preco: 39.99, classe: 'avatar-frame-diamante' },
    // NOVAS MOLDURAS ADMIN
    admin_black: { nome: 'Supreme Black', preco: 9999, classe: 'avatar-frame-admin-black', adminOnly: true },
    admin_red: { nome: 'Supreme Red', preco: 9999, classe: 'avatar-frame-admin-red', adminOnly: true }
};

// NOVOS BALÕES DE CHAT
const BALOES = {
    bronze: { nome: 'Chat Bronze', preco: 9.99, classe: 'bubble-bronze' },
    prata: { nome: 'Chat Prata', preco: 19.99, classe: 'bubble-prata' },
    ouro: { nome: 'Chat Ouro', preco: 29.99, classe: 'bubble-ouro' },
    diamante: { nome: 'Chat Diamante', preco: 39.99, classe: 'bubble-diamante' },
    // EXCLUSIVOS ADMIN
    admin_black: { nome: 'Supreme Black', preco: 9999, classe: 'bubble-admin-black', adminOnly: true },
    admin_red: { nome: 'Supreme Red', preco: 9999, classe: 'bubble-admin-red', adminOnly: true }
};

let fcmSetupDone = false;
let isSending = false;
let perfil = null;
let agendamentoListener = null;
let currentModal = null;
let chatListener = null;
let barbeirosListener = null;
let tempSelectedHorarios = {};
let onboardingState = {};
let tempOnboardingServicos = [];
const CHAT_GLOBAL_ID = "chatGlobal";
let newWorker;
let votosTemporariosBatalha = 0;
let pontosAcumuladosParaSalvar = 0;
let localizacaoCliente = null;
let cadastroCoords = null;
let dadosVagaImediataAtiva = null;
let vendaListener = null;
let produtoEmEdicaoId = null; 
let produtoParaCompra = null;
let pixTimerInterval = null; 
let pendenciasInterval = null; 
let pedidosVendedorListener = null;
let comprasClienteListener = null; 
let aguardeTimeoutId = null;
let portfolioListener = null; // Guarda a referência do listener
let imagensMarcadasParaExcluir = []; // Array global temporário para guardar URLs a excluir
let modalOriginalIdParaConfirmar = null;
let fluxoPosCadastroAtivo = false;
let lastReloadTimestamp = null; // Variável para controlar o reload forçado
let previousTipo = null;
let unsubscribeHorariosPerfil = null;
let listenersEquipe = {};
let onConfirmCallback = null;
let avaliacaoAgendamentoId = null;
let avaliacaoBarbeiroUid = null;
let popupAgendamentoAberto = false;
let unsubscribeCliente = null;
var unsubscribeFirebase = null;
var chatAgendamentoId = null;
let listaEmAltaGlobal = []; // Guarda todas as fotos para passar para a próxima
let indexEmAltaAtual = 0;   // Qual foto estamos vendo agora
let timerEmAlta = null;     // O relógio que conta o tempo
const TEMPO_POR_FOTO = 5000; // 5 segundos por foto
var autoMapTimers = []; // Lista para guardar os 3 verificadores (8s, 10s, 13s)
let userView = {
    originalType: null,
    currentType: null
};

let mostrarApenasFavoritos = false; // Estado do filtro
let agendamentoState = {
    barbeiroUid: null,
    barbeiroNome: null,
    servico: null,
    horario: null, 
    barbeiroLat: null,
    barbeiroLon: null,
};

let adminBalanceListener = null;
let adminUserBalances = {};
let globalChatListener = null;
let lastGlobalMessageTimestamp = null;
let newMessagesCount = 0;
let oldestMessageSnapshot = null; // Variável para paginação do chat

let deferredInstallPrompt = null;
let chatPreviewTimeout = null; 
let aguardeClickCount = 0;
let updateLastSeenInterval = null;
let onlineUsersListener = null;
const USER_ACTIVE_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutos
const BACKEND_API_URL = 'https://navalhabackend.onrender.com';
let currentStoryId = null; // ID do post atual sendo visto
let commentsListener = null; // Listener para fechar ao sair
let likesListener = null; // Listener para atualizar likes em tempo real


/* === Onboarding Tela 2 - Funções de Seleção === */
function toggleOnboardOption(element) {
    const parent = element.closest('.onboard-screen');
    // Remove 'selected' de todos os irmãos
    parent.querySelectorAll('.onboard-option').forEach(op => {
        op.classList.remove('selected');
    });
    // Adiciona 'selected' ao item clicado
    element.classList.add('selected');

    // Salva a seleção no localStorage
    const valor = element.getAttribute('data-value');
    localStorage.setItem('onboard_tipo_uso', valor);
    
    // Habilita o botão 'Continuar' (se houver)
    const btnContinuar = parent.querySelector('.btn-primary');
    if (btnContinuar) {
        btnContinuar.disabled = false;
    }
}

let searchInterval = null; // Variável global para controlar o intervalo

// --- FUNÇÃO DE FILTRO POR NICHO (CLIQUE NO EMOJI) ---
function mudarFiltroNicho(novoFiltro, containerId) {
    // Atualiza a variável global
    window.filtroNichoAtual = novoFiltro;
    
    // Feedback Visual e Sonoro
    tocarSom('ping');
    
    // Atualiza classes CSS dos botões (Visual de ativo)
    const emojis = document.querySelectorAll('.niche-emoji');
    emojis.forEach(el => {
        // Remove active de todos
        el.classList.remove('active');
        // Adiciona active se o onclick tiver o filtro atual
        if (el.getAttribute('onclick').includes(`'${novoFiltro}'`)) {
            el.classList.add('active');
        }
    });

    // Recarrega a lista aplicando o novo filtro na query
    carregarBarbeirosPrincipal(containerId, false);
} 

// SUBSTITUA A FUNÇÃO verificarInterfaceDesktop INTEIRA POR ESTA:
function verificarInterfaceDesktop() {
    if (window.innerWidth >= 1024) {
        
        // 1. Cria a Sidebar Esquerda (Se não existir)
        let sidebar = document.getElementById('desktopSidebar');
        if (!sidebar) {
            sidebar = document.createElement('div');
            sidebar.id = 'desktopSidebar';
            document.body.appendChild(sidebar);
        }

        // Dados do perfil com segurança
        const p = perfil || {};
        const foto = p.fotoPerfil || p.logo_url || '/icone.png';
        const nome = p.nome || 'Visitante';
        const saldo = (p.saldoDigital || 0).toFixed(2);
        const isProfissional = ['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira'].includes(p.tipo);
        const isDono = p.isProprietario;
        const isAdmin = p.tipo === 'admin';

        // Lógica do Botão de Foto (Aparece se não tiver foto)
        let btnFotoHtml = '';
        if (!p.fotoPerfil && !p.logo_url && p.tipo) {
            btnFotoHtml = `
            <div style="margin-bottom:15px; border:1px dashed #e74c3c; padding:10px; border-radius:10px; text-align:center;">
                <p style="font-size:10px; color:#e74c3c; margin:0 0 5px 0;">Sem foto de perfil</p>
                <button onclick="abrirModal('modalLogomarca')" style="width:100%; font-size:11px; padding:5px; background:#e74c3c; color:white;">📸 Adicionar Foto</button>
            </div>`;
        }

        // HTML da Sidebar (Com os novos botões solicitados)
        sidebar.innerHTML = `
            <div style="text-align:center; margin-bottom: 20px;">
                <img src="/icone.png" style="width: 50px; margin-bottom: 10px; filter: drop-shadow(0 0 5px gold);">
                <h2 style="color: var(--cor-destaque); margin: 0; font-family: 'Orbitron'; font-size: 18px; letter-spacing: 2px;">KING AGENDA</h2>
            </div>

            <div style="display:flex; align-items:center; gap:10px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; margin-bottom:15px; cursor:pointer; border: 1px solid #333; transition:0.3s;"
                 onclick="abrirModalPerfil()" onmouseover="this.style.borderColor='var(--cor-destaque)'" onmouseout="this.style.borderColor='#333'">
                <img src="${foto}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid var(--cor-destaque);">
                <div style="overflow:hidden;">
                    <div style="font-weight:bold; color:#fff; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${nome}</div>
                    <div style="font-size:11px; color:#00c6ff;">💎 ${saldo} Moedas</div>
                </div>
            </div>
            
            ${btnFotoHtml}

            <div style="flex-grow: 1; overflow-y: auto; padding-right: 5px;">
                
                <p style="font-size:10px; color:#666; text-transform:uppercase; margin-bottom:10px;">Principal</p>
                
                <button onclick="switchView('${p.tipo === 'cliente' ? 'cliente' : 'barbeiro'}')" 
                    style="text-align:left; background:transparent; border:none; color:#ddd; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; transition: 0.2s; font-size:14px; cursor:pointer;">
                    <span>🏠</span> Início
                </button>
                
                <button onclick="switchView('loja'); carregarProdutos();" 
                    style="text-align:left; background:transparent; border:none; color:#ddd; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; transition: 0.2s; font-size:14px; cursor:pointer;">
                    <span>🛍️</span> Loja & Produtos
                </button>

                <button onclick="switchView('emAlta')" 
                    style="text-align:left; background:transparent; border:none; color:#ddd; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; transition: 0.2s; font-size:14px; cursor:pointer;">
                    <span>🔥</span> Em Alta
                </button>

                ${ (isProfissional || isDono || isAdmin) ? `
                    <p style="font-size:10px; color:#d4af37; text-transform:uppercase; margin:15px 0 10px 0; border-top:1px solid #333; padding-top:15px;">Gestão Profissional</p>
                    
                    <button onclick="abrirServicos()" style="text-align:left; background:transparent; border:1px solid #444; color:#ccc; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>✂️</span> Meus Serviços
                    </button>

                    <button onclick="abrirConfiguracaoHorario()" style="text-align:left; background:transparent; border:1px solid #444; color:#ccc; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>⏰</span> Expediente & Almoço
                    </button>

                    <button onclick="abrirAgendamentosBarbeiro()" style="text-align:left; background:rgba(212, 175, 55, 0.1); border:1px solid #d4af37; color:#fff; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>🗓️</span> Meus Agendamentos
                    </button>

                    <button onclick="abrirModalCriarAgendamentoManual()" style="text-align:left; background:transparent; border:1px solid #444; color:#ccc; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>➕</span> Novo Agendamento
                    </button>

                    <button onclick="abrirModalDashboardBarbeiro()" style="text-align:left; background:transparent; border:1px solid #444; color:#ccc; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>📊</span> Relatórios & Metas
                    </button>
                ` : ''}

                ${ isDono ? `
                    <p style="font-size:10px; color:#00c6ff; text-transform:uppercase; margin:15px 0 10px 0; border-top:1px solid #333; padding-top:15px;">Administração</p>
                    <button onclick="abrirModalFinanceiroProprietario()" style="text-align:left; background:rgba(0, 198, 255, 0.1); border:1px solid #00c6ff; color:#fff; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>💰</span> Gestão Financeira
                    </button>
                    <button onclick="switchView('profissionais')" style="text-align:left; background:transparent; border:1px solid #444; color:#ccc; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <span>👥</span> Minha Equipe
                    </button>
                ` : ''}
                
                ${ isAdmin ? `
                    <p style="font-size:10px; color:red; text-transform:uppercase; margin:15px 0 10px 0;">Super Admin</p>
                    <button onclick="switchView('admin')" style="text-align:left; background:transparent; border:1px solid red; color:#fff; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px;">
                        <span>🧠</span> Painel Geral
                    </button>
                ` : ''}

                <p style="font-size:10px; color:#666; text-transform:uppercase; margin:15px 0 10px 0; border-top:1px solid #333; padding-top:15px;">Conta</p>
                <button onclick="abrirModal('modalConfiguracoes')" style="text-align:left; background:transparent; border:none; color:#aaa; padding:10px; width:100%; border-radius:8px; display:flex; align-items:center; gap:10px;">
                    <span>⚙️</span> Configurações
                </button>

            </div>

            <div style="margin-top:10px;">
                <button onclick="fazerLogout()" style="width:100%; background:#222; color:#aaa; border: 1px solid #444; padding:10px; border-radius:8px; cursor:pointer;">🚪 Sair</button>
            </div>
        `;

        // 2. FORÇA A ABERTURA DO CHAT (Barra Direita)
        const chatModal = document.getElementById('janelaChat');
        if (chatModal && !chatModal.classList.contains('desktop-initialized')) {
            console.log("🖥️ Inicializando Chat Desktop na direita...");
            chatModal.classList.add('desktop-initialized');
            chatModal.classList.add('show'); 
            alternarChat('global');
        }

    } else {
        // MODO MOBILE: Limpeza
        const sidebar = document.getElementById('desktopSidebar');
        if (sidebar) sidebar.remove();
        
        const chatModal = document.getElementById('janelaChat');
        if (chatModal) {
            chatModal.classList.remove('desktop-initialized');
            chatModal.classList.remove('show');
        }
    }
}

let equipeListener = null;

let equipeGlobalListener = null;

// SUBSTITUA A FUNÇÃO iniciarMonitoramentoEquipeGlobal POR ESTA:
function iniciarMonitoramentoEquipeGlobal(uid) {
    if (equipeGlobalListener) { equipeGlobalListener(); equipeGlobalListener = null; }

    // Identifica o ID do "Patrão" (Dono da Barbearia)
    let idDonoParaMonitorar = null;

    if (perfil.isProprietario) {
        idDonoParaMonitorar = uid; // Eu sou o dono
    } else if (perfil.tipo === 'secretaria' && perfil.pertenceABarbearia) {
        idDonoParaMonitorar = perfil.pertenceABarbearia.uid; // Meu patrão
    }

    if (!idDonoParaMonitorar) return; 

    console.log(`📡 Radar Ativado (Dono: ${idDonoParaMonitorar})`);

    // Escuta agendamentos IMEDIATOS vinculados a esse Dono
    // Agenda programada NÃO cai aqui (pois status é 'confirmado'), então não toca alarme
    equipeGlobalListener = db.collection('agendamentos')
        .where('donoUid', '==', idDonoParaMonitorar)
        .where('status', '==', 'imediato') 
        .onSnapshot(snap => {
            // Se não tem pendências, fecha popup e para som
            if (snap.empty) {
                const modal = document.getElementById('modalNovoAgendamento');
                if (modal && modal.style.display === 'flex' && popupAgendamentoAberto) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    popupAgendamentoAberto = false;
                    if(typeof pararAlertaManual === 'function') pararAlertaManual();
                }
                return;
            }

            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const ag = change.doc.data();
                    
                    // 1. Dispara o Alerta Máximo (Som 10x)
                    if (typeof dispararAlertaMaximo === 'function') {
                        dispararAlertaMaximo(); 
                    }

                    // 2. Abre o Popup com Detalhes (Nome Cliente + Profissional)
                    exibirPopupNovoAgendamento(change.doc);
                    
                    // 3. Notificação de Sistema
                    if (Notification.permission === "granted") {
                        new Notification("🚨 VAGA IMEDIATA!", {
                            body: `${ag.clienteNome} pede vaga para ${ag.barbeiroNome}!`
                        });
                    }
                }
            });
        });
}

async function carregarBarbeirosPrincipal(containerId, isGuest = false) {
    const lista = document.getElementById(containerId);
    if (!lista) return; 

    // Filtros de Nicho
    if (typeof window.filtroNichoAtual === 'undefined') window.filtroNichoAtual = 'cabelo';
    const tiposFemininos = ['cabelereira', 'manicure_pedicure', 'designer_cilios'];
    let ehPainelFeminino = false;
    
    if (perfil) {
        if (tiposFemininos.includes(perfil.interesse_principal) || tiposFemininos.includes(perfil.tipo)) ehPainelFeminino = true;
    }

    let tipoParaBuscar = 'barbeiro'; 
    const filterDivId = 'nicheFilterDiv_' + containerId;
    const filtroExistente = document.getElementById(filterDivId);

    if (ehPainelFeminino) {
        switch (window.filtroNichoAtual) {
            case 'cabelo': tipoParaBuscar = 'cabelereira'; break;
            case 'unha': tipoParaBuscar = 'manicure_pedicure'; break;
            case 'olho': tipoParaBuscar = 'designer_cilios'; break;
            default: tipoParaBuscar = 'cabelereira';
        }
        if (!filtroExistente) {
            const filterDiv = document.createElement('div');
            filterDiv.id = filterDivId;
            filterDiv.className = 'niche-filter-container';
            filterDiv.innerHTML = `
                <span class="niche-emoji ${window.filtroNichoAtual === 'cabelo' ? 'active' : ''}" onclick="mudarFiltroNicho('cabelo', '${containerId}')">💇‍♀️</span>
                <span class="niche-emoji ${window.filtroNichoAtual === 'unha' ? 'active' : ''}" onclick="mudarFiltroNicho('unha', '${containerId}')">💅</span>
                <span class="niche-emoji ${window.filtroNichoAtual === 'olho' ? 'active' : ''}" onclick="mudarFiltroNicho('olho', '${containerId}')">👁️</span>`;
            if (lista.parentNode) lista.parentNode.insertBefore(filterDiv, lista);
            filterDiv.style.display = 'flex';
        }
    } else {
        tipoParaBuscar = 'barbeiro';
        if (filtroExistente) filtroExistente.remove();
    }
    
    if(lista.innerHTML === '') lista.innerHTML = `<div style='text-align:center; margin-top:20px;'><div class="spinner"></div></div>`;
    if (!localizacaoCliente) { obterLocalizacaoAtual().catch(()=>{}); }
    if (barbeirosListener) barbeirosListener(); 

    // Busca principal
    let query = db.collection("usuarios").where("tipo", "==", tipoParaBuscar).limit(50);
    
    barbeirosListener = query.onSnapshot(snap => {
        if (snap.empty) {
             lista.innerHTML = `<div style="text-align:center; padding:20px; margin-top: 20px; opacity:0.6;"><p>Nenhum profissional encontrado.</p></div>`;
             return;
        }

        let barbeiros = [];
        const favoritos = (perfil && perfil.favoritos) ? perfil.favoritos : [];
        const agora = Date.now();

        const getSafeDate = (field) => {
            if (!field) return 0;
            try {
                if (typeof field.toDate === 'function') return field.toDate().getTime();
                if (field instanceof Date) return field.getTime();
                if (field.seconds) return field.seconds * 1000;
                if (typeof field === 'string') return new Date(field).getTime();
            } catch (e) { return 0; }
            return 0;
        };

        snap.forEach(doc => {
            const b = doc.data();
            b.uid = doc.id;
            if (b.isAnonymous === true) return; 
            if (mostrarApenasFavoritos && !favoritos.includes(b.uid)) return;
            if (b.tipo === 'cliente' || b.tipo === 'admin') return;

            b.isFavorito = favoritos.includes(b.uid);

            if (localizacaoCliente && b.latitude && b.longitude) {
                b.distancia = calcularDistancia(localizacaoCliente.latitude, localizacaoCliente.longitude, b.latitude, b.longitude);
            } else {
                b.distancia = Infinity;
            }
            barbeiros.push(b);
        });

        // Ordenação
        barbeiros.sort((a, b) => {
            if (a.isFavorito && !b.isFavorito) return -1;
            if (!a.isFavorito && b.isFavorito) return 1;
            
            const sosA = (a.sosConfig && a.sosConfig.ativo && getSafeDate(a.sosConfig.expiraEm) > agora) ? 1 : 0;
            const sosB = (b.sosConfig && b.sosConfig.ativo && getSafeDate(b.sosConfig.expiraEm) > agora) ? 1 : 0;
            if (sosA !== sosB) return sosB - sosA;

            const aDisp = a.vagaImediata || (a.usaAgendaManual && Object.values(a.agenda || {}).some(v => v === true));
            const bDisp = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            if (aDisp !== bDisp) return aDisp ? -1 : 1; 

            const timeA = getSafeDate(a.boostExpiracao);
            const timeB = getSafeDate(b.boostExpiracao);
            const aIsBoosted = timeA > agora;
            const bIsBoosted = timeB > agora;

            if (aIsBoosted && !bIsBoosted) return -1;
            if (!aIsBoosted && bIsBoosted) return 1;

            return (a.distancia || Infinity) - (b.distancia || Infinity);
        });
        
        let htmlBuffer = "";

        barbeiros.forEach(b => {
            // --- CORREÇÃO DAS ESTRELAS AQUI ---
            // 1. Calcula a média (0 a 10)
            const notaMedia = (b.numAvaliacoes > 0) ? (b.somaAvaliacoes / b.numAvaliacoes) : 5;
            
            // 2. Converte para 0 a 5 estrelas
            let qtdEstrelas = Math.round(notaMedia / 2);
            
            // 3. TRAVA ABSOLUTA: Nunca passa de 5
            if (qtdEstrelas > 5) qtdEstrelas = 5;
            if (qtdEstrelas < 0) qtdEstrelas = 0;

            const reputacaoEstrelas = '⭐'.repeat(qtdEstrelas);
            // ----------------------------------

            const fotoExibicao = b.fotoPerfil || b.logo_url || 'https://placehold.co/60x60?text=Foto';
            
            let statusHtml = '';
            const isDisponivel = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));

            if (!isDisponivel) statusHtml = `<div class="card-status status-indisponivel">🔴 Indisponível</div>`;
            else if (b.vagaImediata) statusHtml = `<div class="card-status status-imediato">⚡ Vaga Imediata</div>`;
            else statusHtml = `<div class="card-status status-manual">📅 Agenda Programada</div>`; 

            const distanciaTexto = b.distancia !== Infinity ? `<p>📍 ~${b.distancia.toFixed(1)} km</p>` : `<p>🏙️ ${b.cidade || 'N/A'}</p>`;
            const heartColor = b.isFavorito ? 'var(--cor-destaque)' : 'white';
            const heartIcon = b.isFavorito ? '❤️' : '♡';
            
            const dateBoost = getSafeDate(b.boostExpiracao);
            const isBoosted = dateBoost > agora;
            const classeBoost = isBoosted ? 'boosted-card' : '';
            const iconeBoost = isBoosted ? '<span class="boost-icon">🚀</span>' : '';
            const actionClick = isGuest ? `exibirPopup('Faça login', 'Crie uma conta para favoritar!'); mostrar('authView');` : `toggleFavorito('${b.uid}')`;

            let classeSOS = '';
            let badgeSOS = '';
            
            if (b.sosConfig && b.sosConfig.ativo) {
                const dataExp = getSafeDate(b.sosConfig.expiraEm);
                if (dataExp > agora) {
                    classeSOS = 'radar-active';
                    badgeSOS = `<div style="position:absolute; top:-10px; right:-10px; background:#e74c3c; color:white; font-weight:bold; font-size:12px; padding:4px 8px; border-radius:10px; border:2px solid white; z-index:10; animation:pulse-red 1s infinite; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">🔥 ${b.sosConfig.desconto}% OFF</div>`;
                }
            }

            // Lógica Promo Fixa
            let badgePromoFixa = '';
            if (b.promocoes && b.promocoes.length > 0) {
                let melhorDesconto = 0;
                b.promocoes.forEach(p => {
                    let valida = true;
                    if (p.validade) {
                        const dataVal = getSafeDate(p.validade);
                        if (dataVal < agora) valida = false;
                    }
                    if (valida && p.desconto > melhorDesconto) {
                        melhorDesconto = p.desconto;
                    }
                });

                if (melhorDesconto > 0) {
                    badgePromoFixa = `<div class="promo-fixa-badge">🏷️ ${melhorDesconto}% OFF</div>`;
                }
            }

            // Botão de Contratar (Dono)
            let botaoContratar = '';
            if (perfil && perfil.isProprietario && b.uid !== auth.currentUser.uid) {
                const jaNaMinhaEquipe = perfil.equipe && perfil.equipe.some(m => (m.uid === b.uid || m === b.uid));
                const jaTemPatrao = b.pertenceABarbearia && b.pertenceABarbearia.uid;

                if (jaNaMinhaEquipe) {
                    botaoContratar = `<div class="card-team-badge">✅ Equipe</div>`;
                } else if (jaTemPatrao) {
                    botaoContratar = `<div class="card-team-badge" style="background:#555; color:#aaa; border:1px solid #777;">🚫</div>`;
                } else {
                    botaoContratar = `
                    <button class="card-invite-btn" onclick="event.stopPropagation(); solicitarComissaoEAdicionar('${b.uid}', '${b.nome}')" title="Convidar para Equipe">
                        🤝
                    </button>`;
                }
            }

            htmlBuffer += `
              <div class="card barbeiro-card ${classeBoost} ${classeSOS}" onclick="abrirBarbeiroPerfil('${b.uid}', ${isGuest})" style="position:relative;">
                  ${iconeBoost}
                  ${badgeSOS}
                  ${badgePromoFixa}
                  ${botaoContratar}

                  <button class="card-action-btn card-favorite-btn" style="color:${heartColor}" onclick="event.stopPropagation(); ${actionClick}">
                      ${heartIcon}
                  </button>
                  <button class="card-action-btn card-share-btn" onclick="event.stopPropagation(); compartilharPerfil('${b.nome}', '${b.uid}')">🔗</button>
                  
                  <div class="card-header">
                      <img src="${fotoExibicao}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--cor-destaque);">
                      <div class="card-header-info">
                          <h4 class="professional-name-card">${b.nome}</h4>
                          <p class="nome-estabelecimento">🏢 ${b.nomeBarbearia || (b.pertenceABarbearia ? b.pertenceABarbearia.nome : '') || 'Autônomo'}</p>
                          ${distanciaTexto}
                          
                          <p class="card-reputacao-info">${reputacaoEstrelas} (${b.numAvaliacoes || 0})</p> 
                      </div>
                  </div>
                  ${statusHtml}
              </div>`;
        });

        lista.innerHTML = htmlBuffer;
    });
}

// --- FUNÇÃO DE RESET DE ÁUDIO (SINO) ---
function resetarAudioManual() {
    // 1. Tenta destravar o contexto de áudio (se houver)
    const audios = [audioAlert, audioSuccess, audioPing];
    
    audios.forEach(audio => {
        if(audio) {
            audio.pause();
            audio.currentTime = 0;
            // Tenta dar um play/pause rápido para "acordar" o navegador
            audio.play().then(() => audio.pause()).catch(() => {});
        }
    });

    // 2. Para qualquer loop de alerta ativo
    pararSomAlerta(); // Sua função existente

    // 3. Feedback Visual e Sonoro
    // Tenta tocar um som de teste curto
    if(audioPing) {
        audioPing.volume = 1.0;
        audioPing.play().catch(e => console.warn("Erro ao testar som:", e));
    }

    // Animação no botão para dar feedback
    const btn = document.getElementById('btnResetAudio');
    if(btn) {
        btn.style.transform = 'scale(1.2)';
        setTimeout(() => btn.style.transform = 'scale(1)', 200);
    }

    exibirPopup("Áudio Reiniciado", "O sistema de som foi resetado com sucesso.");
}

function fecharAguarde(event) {
    // Permite fechar com 2 cliques fora
    if (event && event.target.id === 'popupAguarde') {
        aguardeClickCount++;
        if (aguardeClickCount >= 2) {
            fecharModalAtual(true); // Força o fechamento do popupAguarde
            aguardeClickCount = 0;
        }
    }
}

let modalStack = [];

// SUBSTITUA A FUNÇÃO 'exibirPopup'
// SUBSTITUA A FUNÇÃO 'exibirPopup'
function exibirPopup(titulo, mensagem, tipo = 'info', onOkCallback = null) { // Adiciona 'onOkCallback'
    // Fecha qualquer popup de aguarde que possa estar aberto
    const aguardePopup = document.getElementById('popupAguarde');
    if (aguardePopup.classList.contains('show')) {
        fecharAguarde(null, true);
    }

    const tituloEl = document.getElementById('popupGenericoTitulo');
    const mensagemEl = document.getElementById('popupGenericoMensagem');
    const modalContent = document.querySelector('#modalPopupGenerico .modal-content');

    // Define o título e a mensagem
    tituloEl.textContent = titulo;
    mensagemEl.textContent = mensagem;

    // Ajusta a cor do título com base no tipo (opcional)
    let corTitulo = 'var(--cor-destaque)'; // Padrão dourado
    if (tipo === 'sucesso') corTitulo = '#2ecc71'; // Verde
    else if (tipo === 'erro') corTitulo = '#e74c3c'; // Vermelho
    else if (tipo === 'aviso') corTitulo = '#f1c40f'; // Amarelo

    tituloEl.style.color = corTitulo;
    // Reset border style
    modalContent.style.border = '1px solid var(--cor-borda)';

    // Armazena o callback para a função handlePopupGenericoOk usar
    popupGenericoCallback = onOkCallback;

    // Abre o modal genérico
    abrirModal('modalPopupGenerico');
}

// 1. A FUNÇÃO DO BOTÃO "AGENDAR" (COM O AVISO DO CAFÉ E SEM CUSTO)
function confirmarAgendamento() {
    if (checkGuestLimit()) return;
    
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    if (!servico || !horario) {
        fecharModalAtual();
        return;
    }

    // Mantemos as variáveis de valor para passar para as métricas depois
    const valorOriginalServico = servico.valor; 
    const valorFinalCliente = valorOriginalServico; 
    
    // --- ALTERAÇÃO SENIOR: REMOVIDA A TRAVA DE SALDO ---
    // O bloco que verificava (perfil.saldo < valorFinalCliente) foi removido.
    // Agora o agendamento prossegue mesmo com saldo 0.

    // --- PASSO 1: PREPARA O POPUP DO CAFÉ MANUALMENTE (MANTIDO) ---
    const modal = document.getElementById('modalConfirmacaoGenerica');
    const tituloEl = document.getElementById('confirmacaoGenericaTitulo');
    const msgEl = document.getElementById('confirmacaoGenericaMensagem');
    const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
    const btnNao = document.getElementById('btnConfirmacaoGenericaNao');

    // Define o conteúdo do Aviso
    tituloEl.textContent = "⚠️ ATENÇÃO NECESSÁRIA";
    tituloEl.style.color = "#f1c40f"; // Amarelo alerta
    msgEl.innerHTML = `<div style="text-align:left; font-size:15px; line-height: 1.6;">
        Por favor, mantenha o <b>APP ABERTO</b> e os <b>DADOS LIGADOS</b> durante o trajeto.<br><br>
        📍 O profissional precisa acompanhar sua localização para se preparar e deixar o <b>café pronto</b> para sua chegada! ☕
    </div>`;

    // Esconde o botão Cancelar (Obriga a ler)
    btnNao.style.display = 'none';

    // Configura o botão de avançar
    btnSim.textContent = "✅ ENTENDI, VOU DEIXAR ABERTO";
    btnSim.style.width = "100%";
    btnSim.style.background = "#2ecc71";
    
    // AQUI É O SEGREDO: Ao clicar, mudamos o conteúdo do MESMO popup para os detalhes
    // Passamos os valores para que as métricas funcionem na próxima etapa
    btnSim.onclick = function() {
        mostrarDetalhesFinaisNoMesmoPopup(valorFinalCliente, valorOriginalServico);
    };

    // Abre o modal
    modal.style.zIndex = '30000';
    abrirModal('modalConfirmacaoGenerica');
}

// Função auxiliar que transforma o aviso na confirmação final
function mostrarDetalhesFinaisNoMesmoPopup(valorFinal, valorOriginal) {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
    const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
    const tituloEl = document.getElementById('confirmacaoGenericaTitulo');
    const msgEl = document.getElementById('confirmacaoGenericaMensagem');

    // 1. Atualiza os Textos para a Confirmação Final
    tituloEl.textContent = "Confirmar Agendamento?";
    tituloEl.style.color = "var(--cor-destaque)"; // Volta cor padrão
    
    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o horário das ${horario}`;
    const isVip = isVipAtivo(perfil);
    const textoVip = isVip ? `<br><br><b style="color:#00c6ff">💎 VIP Ativo: Cashback garantido!</b>` : '';

    msgEl.innerHTML = `<div style="text-align:center;">
        Profissional: <b>${barbeiroNome}</b><br>
        Serviço: <b>${servico.nome}</b><br>
        Horário: <b>${horarioTexto}</b><br>
        Valor: <b style="font-size:18px; color:#2ecc71;">R$ ${valorFinal.toFixed(2)}</b>
        ${textoVip}
    </div>`;

    // 2. Restaura os botões normais (Cancelar e Confirmar)
    btnNao.style.display = 'block'; // Mostra o botão cancelar de volta
    btnNao.textContent = "Cancelar";
    btnNao.onclick = () => fecharModalAtual();

    btnSim.textContent = "Sim, Confirmar";
    btnSim.style.width = ""; // Tira largura 100%
    btnSim.style.background = ""; // Volta cor padrão (ou definida no CSS)
    
    // 3. Define a ação final: SALVAR NO BANCO
    btnSim.onclick = () => {
        executarAgendamentoNoBanco(valorFinal, valorOriginal);
    };
}

function abrirConfirmacaoFinalAgendamento(valorFinalCliente, valorOriginalServico) {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    const isVip = isVipAtivo(perfil);
    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o horário das ${horario}`;
    
    let textoVip = isVip ? `<br><br><b style="color:#00c6ff">💎 VIP Ativo: Você ganhará 10% de Cashback (Moedas) ao concluir!` : '';
    
    let detalhes = `Profissional: ${barbeiroNome}\nServiço: ${servico.nome}\n`;
    if (servico.duracao) detalhes += `Duração Estimada: ${servico.duracao} minutos\n`;
    detalhes += `Horário: ${horarioTexto}\nValor: R$ ${valorFinalCliente.toFixed(2)}${textoVip}`;

    // RESTAURA OS BOTÕES (Porque a gente escondeu no passo anterior)
    const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
    const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
    if(btnNao) {
        btnNao.style.display = 'block'; 
        btnNao.textContent = "Cancelar";
    }
    if(btnSim) {
        btnSim.style.width = ""; 
        btnSim.style.background = ""; 
        btnSim.textContent = "Sim, Confirmar";
    }

    // Configura o texto do Popup Final
    document.getElementById('confirmacaoGenericaTitulo').textContent = "Confirmar Agendamento?";
    document.getElementById('confirmacaoGenericaMensagem').innerHTML = detalhes.replace(/\n/g, '<br>');

    // Define o que acontece ao confirmar (Salvar no Banco)
    onConfirmCallback = () => {
        executarAgendamentoNoBanco(valorFinalCliente, valorOriginalServico);
    };

    // Abre o modal novamente (agora com os dados novos)
    abrirModal('modalConfirmacaoGenerica');
}

// --- NOVA FUNÇÃO: MONITORAR NOTIFICAÇÕES DO CHAT NO MAPA ---
function monitorarNotificacoesChatMapa(agendamentoId) {
    const chatId = 'temp_' + agendamentoId;
    
    // Limpa listener anterior se existir para não duplicar
    if (unsubscribeChatNotif) unsubscribeChatNotif();

    let isFirstLoad = true;

    // Escuta a coleção de mensagens desse agendamento
    unsubscribeChatNotif = db.collection("chats").doc(chatId).collection("mensagens")
        .orderBy("ts", "desc")
        .limit(1)
        .onSnapshot(snapshot => {
            // Ignora a primeira carga (mensagens antigas)
            if (isFirstLoad) { 
                isFirstLoad = false; 
                return; 
            }

            if (!snapshot.empty) {
                const msg = snapshot.docs[0].data();
                
                // 1. Se fui EU que mandei, ignora
                if (msg.remetenteUid === auth.currentUser.uid) return;

                // 2. Verifica se a janela do chat está FECHADA
                const chatModal = document.getElementById('janelaChat');
                // Se o modal não tem a classe 'show', ele está minimizado/fechado
                if (!chatModal || !chatModal.classList.contains('show')) {
                    
                    // --- AQUI ACONTECE A MÁGICA ---
                    acionarAlertaChatMapa();
                }
            }
        });
}

function acionarAlertaChatMapa() {
    const btn = document.getElementById('btnChatTemporario');
    if (!btn) return;

    // 1. Toca o Som
    tocarSom('ping');

    // 2. Adiciona/Incrementa a Bolinha Vermelha (Badge)
    let badge = btn.querySelector('.map-chat-badge');
    if (!badge) {
        badge = document.createElement('span');
        badge.className = 'notification-badge map-chat-badge visible';
        // Estilo forçado para garantir que apareça em cima do botão redondo
        badge.style.cssText = "position: absolute; top: 0px; right: 0px; background: #e74c3c; color: white; border-radius: 50%; padding: 4px 7px; min-width: 20px; text-align: center; font-size: 12px; border: 2px solid white; z-index: 1002; font-weight: bold;";
        badge.textContent = '0';
        btn.appendChild(badge);
    }
    
    const count = parseInt(badge.textContent) + 1;
    badge.textContent = count;

    // 3. Adiciona Animação de Agito/Brilho (Classe CSS já existente no seu arquivo)
    btn.classList.add('chat-alert-anim');
}

function limparAlertaChatMapa() {
    const btn = document.getElementById('btnChatTemporario');
    if (!btn) return;

    // Remove a bolinha
    const badge = btn.querySelector('.map-chat-badge');
    if (badge) badge.remove();

    // Remove a animação
    btn.classList.remove('chat-alert-anim');
}

function handlePopupGenericoOk(event) {
    // Fecha o modal genérico
    fecharModal(event); 
    
    // Executa o callback se ele existir
    if (popupGenericoCallback) {
        popupGenericoCallback(); // Executa a ação (ex: abrirModalEtapa1)
        popupGenericoCallback = null; // Limpa o callback
    }
}

// Modificar fecharAguarde para aceitar um segundo argumento para forçar fechamento
function fecharAguarde(event, force = false) {
    const popup = document.getElementById('popupAguarde');
    // Permite fechar com 2 cliques fora OU se force for true
    if (force || (event && event.target.id === 'popupAguarde')) {
        if (!force) {
            aguardeClickCount++;
        }
        if (force || aguardeClickCount >= 2) {
             // Verifica se o modal está na pilha antes de tentar removê-lo
             const indexNaPilha = modalStack.indexOf(popup);
             if (indexNaPilha > -1) {
                 modalStack.splice(indexNaPilha, 1); // Remove da pilha se estiver lá
             }
            popup.classList.remove('show');
            setTimeout(() => popup.style.display = 'none', 300);
            aguardeClickCount = 0;
        }
    }
}

function abrirModal(modalId) {
    const novoModal = document.getElementById(modalId);

    if (novoModal && !novoModal.classList.contains('show')) {
        
        const baseZIndex = 2000;
        const incremento = modalStack.length * 10;
        const zIndexFinal = baseZIndex + incremento;
        
        novoModal.style.zIndex = zIndexFinal;
        novoModal.style.display = 'flex';

        setTimeout(() => {
            novoModal.classList.add('show');
            modalStack.push(novoModal);
            
            // Disparar faíscas NA FRENTE do modal
            if (typeof soltarFaiscasDeLuxo === 'function') {
                soltarFaiscasDeLuxo();
            }

            window.history.pushState({ modalOpen: true, modalId: modalId }, "");
        }, 10);
    }
}

function fecharModal(event) {
    let modalElement = null;
    
    // Identifica o modal clicado (clique no fundo)
    if (event.target.classList.contains('modal')) {
        modalElement = event.target;
    } 
    // Identifica o modal pelo ID do botão de cancelamento
    else if (event.target.dataset.modalId) {
        modalElement = document.getElementById(event.target.dataset.modalId);
    } 
    // Identifica o modal se o clique foi no ícone ou span dentro do botão
    else if (event.target.closest('.modal-content button[data-modal-id]')) {
        modalElement = document.getElementById(event.target.closest('.modal-content button[data-modal-id]').dataset.modalId);
    }

    // Se identificamos um modal E a pilha de modais não está vazia
    if (modalElement && modalStack.length > 0) {
        // Chama a função principal que agora tem o fadeout luxuoso
        fecharModalAtual(); 
        
    } else if (modalElement) {
        // Fallback para modais fora da pilha (Ex: Popup Aguarde se for clicável)
        modalElement.classList.add('closing');
        setTimeout(() => {
            modalElement.classList.remove('show', 'closing');
            modalElement.style.display = 'none';
        }, 300);
    }
}

async function fecharModalAtual(forcePopupAguarde = false, fromHistory = false) {
    // 1. IMPLEMENTAÇÃO DO BATIMENTO CARDÍACO E ANIMAÇÃO (MANTIDO)
    if (typeof pontosAcumuladosBatalha !== 'undefined' && pontosAcumuladosBatalha > 0 && auth.currentUser) {
        exibirAnimacaoRecompensaFinal(pontosAcumuladosBatalha);
        try {
            const userRef = db.collection('usuarios').doc(auth.currentUser.uid);
            await userRef.update({
                pontosFidelidade: firebase.firestore.FieldValue.increment(pontosAcumuladosBatalha)
            });
            pontosAcumuladosBatalha = 0; 
            console.log("✅ Batimento e Animação concluídos!");
        } catch (e) {
            console.error("Erro ao sincronizar batimento na saída:", e);
        }
    }

    // 2. LÓGICA PARA POPUP AGUARDE (COM FADEOUT)
    if (forcePopupAguarde) {
        const popup = document.getElementById('popupAguarde');
        if (popup) {
            popup.classList.add('closing'); // Inicia animação de saída
            await new Promise(resolve => setTimeout(resolve, 300)); // Aguarda 0.3s
            popup.classList.remove('show', 'closing');
            popup.style.display = 'none';
        }
        return;
    }
    
    // 3. LIMPEZA DE INTERVALOS (MANTIDO)
    if (intervaloRelogiosPerfil) {
        clearInterval(intervaloRelogiosPerfil);
        intervaloRelogiosPerfil = null;
    }

    // 4. FECHAMENTO DA PILHA DE MODAIS (LUXO)
    if (modalStack && modalStack.length > 0) {
        const modalParaFechar = modalStack.pop();
        
        // Dispara o FadeOut Fluído
        modalParaFechar.classList.add('closing');
        
        // Aguarda a animação terminar antes de remover do DOM visual
        await new Promise(resolve => setTimeout(resolve, 300));
        
        modalParaFechar.classList.remove('show', 'closing');
        modalParaFechar.style.display = 'none';

        // Lógica de Histórico (MANTIDO)
        if (!fromHistory) {
            ignoreNextPopstate = true;
            window.history.back();
        }
    }
}

// --- FUNÇÃO: FECHAR TODOS OS MODAIS (COM FADEOUT COLETIVO) ---
async function fecharTodosOsModais(manterAberto = false) {
    const modais = document.querySelectorAll('.modal, .modal-overlay, #modal-pagamento');
    const modaisParaFechar = [];

    modais.forEach(m => {
        // PROTEÇÃO: Não fecha o Chat nem o Perfil se for atualização automática (MANTIDO)
        if (manterAberto && (m.id === 'janelaChat' || m.id === 'modalMeuPerfil')) {
            return; 
        }
        if (m.style.display === 'flex' || m.classList.contains('show')) {
            m.classList.add('closing');
            modaisParaFechar.push(m);
        }
    });

    // Se houver modais abertos, aguarda o fadeout de todos
    if (modaisParaFechar.length > 0) {
        await new Promise(resolve => setTimeout(resolve, 300));
        modaisParaFechar.forEach(m => {
            m.style.display = 'none';
            m.classList.remove('show', 'closing');
        });
    }

    modalStack = []; // Limpa a pilha
}

function mostrar(id) {
    console.log(`[Navegação] Tentando mostrar: ${id}`);
    
    // === BLINDAGEM: Verifica se o chat está aberto antes de mexer em tudo ===
    const chat = document.getElementById('janelaChat');
    const chatEstavaAberto = chat && (chat.style.display === 'flex' || chat.classList.contains('show'));
    
    // Lista completa de telas (Mantive as suas)
    const views = [
        "authView", "clienteView", "barbeiroView", "adminView", 
        "lojaView", "emAltaView", "profissionaisView", 
        "minhaAgendaView", "secretariaView"     
    ];
    
    // 1. Esconde as telas da lista (Menos o Chat, que não está na lista)
    views.forEach(v => {
        const el = document.getElementById(v);
        if (el) {
            el.classList.add("hidden");
            el.style.display = 'none';
        }
    });

    // 2. Mostra APENAS a tela desejada
    const viewNova = document.getElementById(id);
    if (viewNova) {
        viewNova.classList.remove("hidden");
        viewNova.style.display = 'block'; 
        
        viewNova.classList.add("entering");
        setTimeout(() => viewNova.classList.remove("entering"), 300);
    }

    // === RE-APLICAÇÃO DA BLINDAGEM ===
    // Se o chat estava aberto, garantimos que ele CONTINUE aberto e no topo
    if (chatEstavaAberto && chat) {
        chat.style.display = 'flex';
        chat.style.zIndex = '25000'; // Garante que fique acima da nova tela
    }

    // 3. Configura Menus Globais (Sua lógica original)
    const isAuth = (id === 'authView');
    const elementosGlobais = ["topbar", "bottomButtons", "btnTema", "btnConfig", "btnCarteiraTop", "botaoExtra"];
    
    elementosGlobais.forEach(elId => {
        const el = document.getElementById(elId);
        if(el) {
            if(isAuth) el.classList.add("hidden");
            else el.classList.remove("hidden");
        }
    });
    
    // Regra do resgate
    const redeem = document.getElementById("redeemContainer");
    if(redeem) {
        const dashboards = ['clienteView', 'barbeiroView', 'adminView', 'secretariaView', 'profissionaisView'];
        redeem.classList.toggle("hidden", !dashboards.includes(id));
    }
}

// --- INÍCIO DA PARTE 2: CONTINUAÇÃO DO JAVASCRIPT DO index.html ---
function configurarBotoesGuest() {
    const guestView = document.getElementById('guestView');
    const buttons = guestView.querySelectorAll('#guestFuncoesContainer button');
    buttons.forEach(btn => {
        const originalText = btn.textContent.trim();
        // Mantém a funcionalidade original do botão "Loja"
        if (originalText === 'Loja') {
            btn.onclick = () => { mostrar('lojaView'); carregarProdutos(); };
            return;
        }
        
        // Para todos os outros botões, exibe um alerta para o usuário se logar
        btn.onclick = () => {
            exibirPopup("Para acessar esta função, por favor, crie uma conta ou faça login.");
            mostrar('authView'); // Direciona para a tela de login
        };
    });
}

function mostrarPainelAtual() {
    mostrar(`${userView.currentType}View`);
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window && Notification.permission === 'default') {
        abrirModal('modalPermissaoNotificacao');
    }
}

function pedirPermissaoEFechar() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            const user = auth.currentUser;
            if (user) {
                setupFCM(user.uid);
            }
        }
    });
    fecharModalAtual();
}

async function garantirTokenAtualizadoNoPerfil(uid) {
    try {
        const currentToken = await messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' });
        if (currentToken) {
            const userRef = db.collection('usuarios').doc(uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const tokens = userDoc.data().fcmTokens || [];
                if (!tokens.includes(currentToken)) {
                    await userRef.update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                }
            }
        }
    } catch(err) {
        console.error('Erro ao garantir token atualizado:', err);
    }
}


// SUBSTITUA a função setupFCM inteira por esta
function setupFCM(uid) {
    if (fcmSetupDone || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
        console.log("FCM não suportado ou já configurado.");
        return;
    }

    // Garante que a permissão seja solicitada
    Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
            console.log('Permissão de notificação concedida.');
            fcmSetupDone = true;

            // Obtém o token do dispositivo
            messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' })
            .then((currentToken) => {
                if (currentToken) {
                    console.log('Token FCM obtido:', currentToken);
                    // Salva o token no perfil do usuário no Firestore
                    db.collection('usuarios').doc(uid).update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                } else {
                    console.warn('Não foi possível obter o token de notificação. A permissão foi concedida, mas o token está vazio.');
                }
            }).catch((err) => {
                console.error('Ocorreu um erro ao obter o token.', err);
            });
        } else {
            console.warn('Permissão de notificação negada.');
        }
    });
}

function alternarTema() {
  const body = document.body;
  const isLight = body.classList.toggle('tema-claro');
  document.getElementById('btnTema').textContent = isLight ? '☀️' : '🌙';
}

function setupViewSwitcher() {
    const container = document.getElementById("botaoExtra");
    if (!container) return;
    
    // DETECTA SE É DESKTOP (Largura > 1024px)
    const isDesktop = window.innerWidth >= 1024;
    const larguraMax = isDesktop ? "100%" : "500px"; 
    
    container.innerHTML = "";
    container.style.cssText = `display: flex; gap: 5px; overflow-x: auto; padding: 5px; background: rgba(0,0,0,0.9); border-radius: 15px; border: 1px solid var(--cor-borda); width: 95%; max-width: ${larguraMax}; margin: 10px auto; white-space: nowrap; position: sticky; top: 0; z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.5);`;
    container.classList.remove('hidden');
    
    if (!perfil) return; 

    let views = [];
    const isProfissional = ['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira'].includes(perfil.tipo);

    if (perfil.tipo === 'admin') {
        views = [
            { id: 'admin', icon: '🧠', label: 'Admin' },
            { id: 'profissionais', icon: '👥', label: 'Staff' },
            { id: 'emAlta', icon: '🔥', label: 'Em Alta' },
            { id: 'barbeiro', icon: '💈', label: 'Painel' },
            { id: 'cliente', icon: '🙋', label: 'Cliente' },
            { id: 'loja', icon: '🛍️', label: 'Loja' }
        ];
    } else if (perfil.tipo === 'secretaria') {
        // --- ALTERAÇÃO AQUI: REMOVIDA A AGENDA E DIRECIONA INÍCIO PARA O PAINEL DELA ---
        views = [
            { id: 'secretaria', icon: '👩‍💼', label: 'Início' }, // Vai para o Dashboard dela
            { id: 'profissionais', icon: '👥', label: 'Equipe' }, // Atalho direto pra equipe
            { id: 'emAlta', icon: '🔥', label: 'Em Alta' },
            { id: 'loja', icon: '🛍️', label: 'Loja' }
        ];
    } else if (perfil.isProprietario) {
        views = [
            { id: 'barbeiro', icon: '🏠', label: 'Início' },
            { id: 'profissionais', icon: '👥', label: 'Equipe' }, 
            { id: 'minhaAgenda', icon: '📅', label: 'Agenda' },
            { id: 'emAlta', icon: '🔥', label: 'Em Alta' },
            { id: 'loja', icon: '🛍️', label: 'Loja' }
        ];
    } else if (isProfissional) {
        views = [
            { id: 'barbeiro', icon: '🏠', label: 'Início' },
            { id: 'minhaAgenda', icon: '📅', label: 'Agenda' },
            { id: 'emAlta', icon: '🔥', label: 'Em Alta' },
            { id: 'loja', icon: '🛍️', label: 'Loja' }
        ];
    } else {
        views = [
            { id: 'cliente', icon: '🏠', label: 'Início' },
            { id: 'emAlta', icon: '🔥', label: 'Em Alta' },
            { id: 'loja', icon: '🛍️', label: 'Loja' }
        ];
    }

    views.forEach(v => {
        const btn = document.createElement("button");
        btn.innerHTML = `<span style="font-size:16px; display:block;">${v.icon}</span><span style="font-size:9px;">${v.label}</span>`;
        btn.style.cssText = "flex: 1; min-width: 60px; background: transparent; border: none; padding: 6px 0; opacity: 0.5; transition: all 0.2s; color: #fff; border-radius: 8px;";
        
        if (userView.currentType === v.id) {
            btn.style.opacity = "1";
            btn.style.color = "var(--cor-destaque)";
            btn.style.borderBottom = "2px solid var(--cor-destaque)";
            btn.style.fontWeight = "bold";
        }

        btn.onclick = () => { 
            if (v.isAction && v.action) {
                v.action();
            } else {
                switchView(v.id); 
            }
        };
        container.appendChild(btn);
    });
}

// Função auxiliar para executar a troca
function switchView(view) {
    console.log(`[Admin] Trocando visão para: ${view}`);
    
    // --- LIMPEZA DE LISTENERS DA EQUIPE ---
    // Se estiver saindo da tela de profissionais, limpa os ouvintes
    if (userView.currentType === 'profissionais' && view !== 'profissionais') {
        Object.values(listenersEquipe).forEach(func => func());
        listenersEquipe = {};
        console.log("Listeners de equipe limpos.");
    }
    // --------------------------------------

    userView.currentType = view;
    renderCurrentView(); 
}


function switchView(view) {
    userView.currentType = view;
    renderCurrentView();
}

function renderCurrentView() {
    console.log("Iniciando renderCurrentView para:", userView.currentType); 

    // === ADICIONE ISSO AQUI: ===
    const chat = document.getElementById('janelaChat');
    const chatEstavaAberto = chat && (window.getComputedStyle(chat).display !== 'none');
    // ===========================

    try {
        armarHistorico();
        setupViewSwitcher(); 
        
        if (adminBalanceListener) { adminBalanceListener(); adminBalanceListener = null; }
        
        const btnLojaCli = document.getElementById('btnGerenciarLojaCliente');
        const btnLojaBarb = document.getElementById('btnGerenciarLojaBarbeiro');
        if(btnLojaCli) btnLojaCli.classList.add('hidden');
        if(btnLojaBarb) btnLojaBarb.classList.add('hidden');

        if(perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
          if(userView.currentType === 'cliente' && btnLojaCli) btnLojaCli.classList.remove('hidden');
          if(['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira'].includes(userView.currentType) && btnLojaBarb) {
              btnLojaBarb.classList.remove('hidden');
          }
        }

        const countElement = document.getElementById('onlineUserCount');
        if (countElement) {
            countElement.classList.toggle('hidden', !(perfil && perfil.tipo === 'admin' && userView.currentType === 'admin'));
        }

        if (perfil) {
            
            // ===============================================
            // ===  PAINEL DA SECRETÁRIA (ATUALIZADO)  ===
            // ===============================================
            if (userView.currentType === 'secretaria') {
                const secretView = document.getElementById('secretariaView');
                
                // INJEÇÃO DO HTML COM STORIES NO TOPO
                secretView.innerHTML = `
                    <h2>👩‍💼 Painel da Secretária</h2>
                    
                    <div id="storiesContainerSecretaria" class="stories-wrapper" style="margin-bottom: 15px; min-height: 80px;">
                        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
                        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
                        <div class="story-item loading"><div class="story-circle skeleton"></div></div>
                    </div>

                    <div id="mapaBtnContainerSecretaria" style="width: 100%; margin-bottom: 10px;"></div> 
                    <div id="secretariaDynamicContent"></div>
                `;
                
                // Carrega os Stories
                carregarStories('storiesContainerSecretaria');
                
                const contentDiv = document.getElementById('secretariaDynamicContent');
                
                // Botão Mapa 3D
                const containerMapa = document.getElementById('mapaBtnContainerSecretaria');
                containerMapa.innerHTML = ''; 
                const btnMapa = document.createElement('button');
                btnMapa.innerHTML = '🗺️ Mapa da Beleza (3D)';
                btnMapa.style.cssText = "width: 100%; margin-bottom: 10px; background: linear-gradient(45deg, #d4af37, #f1c40f); color: white; font-weight: bold; border-radius: 12px;";
                btnMapa.onclick = abrirMapaGeral;
                containerMapa.appendChild(btnMapa);

                // Botões Principais
                let htmlBotoes = `
                    <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom: 20px;">
                        <button onclick="switchView('profissionais')" style="width:45%; background: linear-gradient(45deg, #2c3e50, #4ca1af);">👥 Equipe</button>
                        <button onclick="abrirModalCarteira()" style="width:45%">💰 Carteira</button>
                        <button onclick="switchView('emAlta')" style="width:45%">🔥 Em Alta</button>
                        <button onclick="switchView('loja')" style="width:45%">🛍️ Loja</button>
                    </div>
                `;
                
                const nomeVinc = (perfil.pertenceABarbearia && perfil.pertenceABarbearia.nome) ? perfil.pertenceABarbearia.nome : "Nenhuma Barbearia";
                htmlBotoes += `
                    <div id="statusVinculoSecretaria" style="text-align:center; padding:10px; border-radius:10px; background:#222; margin-bottom:15px; border:1px solid #333;">
                        <p style="font-size:12px; color:#aaa; margin:0;">Vinculada a:</p>
                        <h3 style="margin:5px 0; color:var(--cor-destaque);">${nomeVinc}</h3>
                    </div>
                `;

                // Gaveta Carreira
                let htmlCarreira = `
                    <button class="super-btn" onclick="toggleSubMenu('menu_sec_carreira', this)" style="border-top:1px solid #444;">🏆 Carreira & Comunidade</button>
                    <div id="menu_sec_carreira" class="sub-menu-container hidden">
                        <button id="btnVipPro" onclick="abrirModalVipPro()" style="width:100%; background: linear-gradient(45deg, var(--cor-destaque-azul), #00c6ff); color:white; font-weight:bold; margin-bottom:5px;">🌟 Assinar Plano PRO</button>
                        ${(typeof gerarBotaoPro === 'function') ? gerarBotaoPro("📸 Stories", "postarStory()", "tier4", perfil).replace('width:45%', 'width:48%') : ''}
                        <button onclick="abrirModalBatalha()" style="width:48%">⚔️ Batalha</button>
                        <button onclick="abrirModalConquistasBarbeiro()" style="width:48%">🏅 Conquistas</button>
                        <button onclick="abrirModalRankingUnificado()" style="width:48%">📊 Ranking</button>
                        <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:48%">📰 Blog</button>
                        <button onclick="abrirModalFidelidade()" style="width:48%">💎 Meus Pontos</button>
                        <button id="btnMinhasComprasSec" onclick="abrirMinhasCompras()" style="width:98%; margin-top:5px;">🛍️ Minhas Compras</button>
                    </div>
                `;

                contentDiv.innerHTML = htmlBotoes + htmlCarreira;
            }

            // ===  PAINEL DO PROFISSIONAL (GAVETAS) ===
            if (['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira'].includes(userView.currentType)) {
                 if (typeof renderizarPainelProfissionalPadrao === 'function') {
                     renderizarPainelProfissionalPadrao(); 
                 }
            }
            
            // ===  PAINEL DO CLIENTE ===
             if (userView.currentType === 'cliente') {
                 if (typeof renderizarPainelClientePadrao === 'function') {
                     renderizarPainelClientePadrao();
                 }
             }
            
            // === SWITCH DE VIEWS ===
            switch (userView.currentType) {
                case 'admin': 
                    mostrar("adminView"); 
                    if(typeof carregarAdmin === 'function') carregarAdmin(); 
                    break;

                case 'profissionais': 
                    mostrar("profissionaisView");
                    if(typeof carregarVisaoGeralEquipe === 'function') carregarVisaoGeralEquipe();
                    break;

                case 'secretaria':
                    mostrar("secretariaView");
                    break;

                case 'minhaAgenda': 
                    mostrar("minhaAgendaView");
                    if(typeof carregarMinhaAgendaInterativa === 'function') carregarMinhaAgendaInterativa();
                    break;

                case 'barbeiro':
                case 'manicure_pedicure':
                case 'designer_cilios':
                case 'cabelereira':
                    mostrar("barbeiroView"); 
                    if(typeof carregarBarbeirosPrincipal === 'function') carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
                    carregarStories('storiesContainerBarbeiro');
                    break;
                case 'cliente':
                    mostrar("clienteView");
                    if(typeof carregarBarbeirosPrincipal === 'function') carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
                    carregarStories('storiesContainer'); 
                    if(typeof renderizarFiltrosNicho === 'function') renderizarFiltrosNicho();
                    break;
                case 'emAlta': mostrar("emAltaView"); carregarFeedEmAlta(); break;
                case 'loja': mostrar("lojaView"); if(typeof carregarProdutos === 'function') carregarProdutos(); break;
                
                default: mostrar("authView");
            }

            if(perfil) {
                setTimeout(verificarAvisosPromocionais, 1000);
            }
        }
    } catch (erro) {
        console.error("ERRO CRÍTICO EM renderCurrentView:", erro);
    }
}

const cidadesPorEstado = {
  "ES": ["Aracruz", "Vitória", "Serra", "Linhares", "Colatina", "Cachoeiro de Itapemirim", "Guarapari", "Vila Velha", "São Mateus", "Barra de São Francisco"], "SP": ["São Paulo", "Campinas", "Santos", "Ribeirão Preto", "Sorocaba"], "RJ": ["Rio de Janeiro", "Niterói", "Petrópolis", "Volta Redonda", "Campos dos Goytacazes"], "MG": ["Belo Horizonte", "Uberlândia", "Contagem", "Juiz de Fora", "Montes Claros"], "BA": ["Salvador", "Feira de Santana", "Vitória da Conquista", "Ilhéus", "Barreiras"], "PR": ["Curitiba", "Londrina", "Maringá", "Cascavel", "Ponta Grossa"], "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas", "Santa Maria", "Novo Hamburgo"], "SC": ["Florópolis", "Joinville", "Blumenau", "Chapecó", "Criciúma"], "PE": ["Recife", "Olinda", "Caruaru", "Petrolina", "Garanhuns"], "CE": ["Fortaleza", "Juazeiro do Norte", "Sobral", "Crato", "Iguatu"], "DF": ["Brasília"]
};

// --- LÓGICA DE EQUIPE (BUSCA INSTANTÂNEA) ---

let searchDebounceTimeout = null; // Variável para controlar o tempo de digitação

async function abrirModalEquipe() {
    abrirModal('modalEquipe');
    carregarEquipeAtual();
    // Limpa a busca anterior visualmente
    document.getElementById('buscaEquipeInputFuncionario').value = '';
    document.getElementById('resultadoBuscaEquipe').innerHTML = '';
}

// Função gatilho que espera o usuário parar de digitar (300ms)
function buscarUsuarioEquipeInstantaneo(termo) {
    const container = document.getElementById('resultadoBuscaEquipe');
    
    // Se limpar o campo, limpa os resultados
    if (!termo || termo.trim() === '') {
        container.innerHTML = '';
        return;
    }

    // Mostra "Buscando..." apenas se não tiver resultados ainda
    if (container.innerHTML === '') {
        container.innerHTML = '<p style="font-size:12px; opacity:0.7;">🔎 Procurando...</p>';
    }

    // Cancela a busca anterior se o usuário ainda estiver digitando
    if (searchDebounceTimeout) {
        clearTimeout(searchDebounceTimeout);
    }

    // Agenda a nova busca para daqui a 500ms
    searchDebounceTimeout = setTimeout(() => {
        executarBuscaEquipe(termo.trim());
    }, 500);
}

async function executarBuscaEquipe(termo) {
    const container = document.getElementById('resultadoBuscaEquipe');
    // Loader local
    container.innerHTML = '<div class="spinner" style="width:20px; height:20px; border-width:2px; margin: 0 auto;"></div>';

    try {
        let query = db.collection('usuarios')
            .where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira']);

        // Busca por prefixo (Começa com...)
        query = query.orderBy('nome')
                     .startAt(termo)
                     .endAt(termo + '\uf8ff')
                     .limit(10); 

        const snap = await query.get();

        if (snap.empty) {
            container.innerHTML = '<p style="font-size:12px; padding:10px; text-align:center;">Nenhum profissional encontrado com esse nome.</p>';
            return;
        }

        let profissionais = [];
        
        snap.forEach(doc => {
            const u = doc.data(); // AQUI: A variável é 'u'
            if (doc.id === auth.currentUser.uid) return; 
            
            // --- CORREÇÃO DO ERRO AQUI ---
            // Antes estava usando 'b.nome', agora usa 'u.nome'
            if (window.filtroNichoAtual && (perfil.interesse_principal === 'cabelereira' || perfil.tipo === 'manicure_pedicure')) {
                const nomeProf = (u.nome || "").toLowerCase(); 
                const servicosProf = (u.listaServicos || []).map(s => s.nome.toLowerCase()).join(' ');
                
                let corresponde = true;
                if (window.filtroNichoAtual === 'unha') {
                    corresponde = nomeProf.includes('unha') || nomeProf.includes('manicure') || servicosProf.includes('unha') || servicosProf.includes('pé') || servicosProf.includes('mão');
                } else if (window.filtroNichoAtual === 'olho') {
                    corresponde = nomeProf.includes('cilio') || nomeProf.includes('lash') || servicosProf.includes('cilio');
                } else { // Cabelo
                    corresponde = !nomeProf.includes('unha') && !nomeProf.includes('cilio');
                }
                
                if (!corresponde) return; 
            }
            // -----------------------------

            // Verifica se já está na equipe
            const jaNaEquipe = perfil.equipe && perfil.equipe.some(m => m.uid === doc.id);
            if (jaNaEquipe) return;

            let distancia = Infinity;
            if (perfil.latitude && perfil.longitude && u.latitude && u.longitude) {
                distancia = calcularDistancia(perfil.latitude, perfil.longitude, u.latitude, u.longitude);
            }
            
            profissionais.push({ id: doc.id, ...u, distancia });
        });

        if (profissionais.length === 0) {
            container.innerHTML = '<p style="font-size:12px; padding:10px; text-align:center;">Nenhum resultado relevante encontrado.</p>';
            return;
        }

        // Ordena por distância
        profissionais.sort((a, b) => a.distancia - b.distancia);

        // Renderiza
        container.innerHTML = '';
        profissionais.forEach(p => {
            const distTexto = p.distancia !== Infinity ? `📍 ${p.distancia.toFixed(1)} km` : '';
            const foto = p.fotoPerfil || p.logo_url || '/icone.png';
            
            container.innerHTML += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 8px; margin-bottom: 5px; background: #2a2a2a;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${foto}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                        <div>
                            <b style="font-size: 14px;">${p.nome}
                            <div style="font-size:10px; opacity:0.8;">${distTexto}</div>
                        </div>
                    </div>
                    <button onclick="solicitarComissaoEAdicionar('${p.id}', '${p.nome}')" style="width:auto; padding:5px 10px; font-size: 12px; background: var(--cor-destaque); color: #000;">➕ Add</button>
                </div>
            `;
        });

    } catch (e) {
        console.error(e);
        container.innerHTML = '<p style="color:red; font-size:12px; padding:10px;">Erro na busca.</p>';
    }
}

async function buscarUsuarioParaEquipe() {
    const termo = document.getElementById('buscaEquipeInput').value.trim();
    // Se vazio, busca os mais próximos (0km a 10km)
    
    exibirAguarde("Buscando profissionais...");
    const container = document.getElementById('resultadoBuscaEquipe');
    container.innerHTML = '';

    try {
        let query = db.collection('usuarios')
            .where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios']);

        // Se tiver termo, usa 'startAt' e 'endAt' para simular "começa com"
        if (termo) {
            // Dica do Firebase para busca textual simples
            query = query.orderBy('nome')
                         .startAt(termo)
                         .endAt(termo + '\uf8ff');
        } else {
            // Se não tiver termo, ordena por nome padrão (ou geo se tivéssemos GeoFire, mas faremos filtro no front)
            query = query.limit(20);
        }

        const snap = await query.get();
        fecharAguarde(null, true);

        if (snap.empty) {
            container.innerHTML = '<p>Nenhum profissional encontrado.</p>';
            return;
        }

        let profissionais = [];
        
        // Processa os resultados
        snap.forEach(doc => {
            const u = doc.data();
            if (doc.id === auth.currentUser.uid) return; // Não mostrar a si mesmo
            
            // Calcula distância se possível
            let distancia = Infinity;
            if (perfil.latitude && perfil.longitude && u.latitude && u.longitude) {
                distancia = calcularDistancia(perfil.latitude, perfil.longitude, u.latitude, u.longitude);
            }
            
            profissionais.push({ id: doc.id, ...u, distancia });
        });

        // Ordena por distância (menor primeiro - os de 0km/equipe aparecem no topo)
        profissionais.sort((a, b) => a.distancia - b.distancia);

        profissionais.forEach(p => {
            const distTexto = p.distancia !== Infinity ? `📍 ${p.distancia.toFixed(1)} km` : '';
            const foto = p.fotoPerfil || p.logo_url || '/icone.png';
            
            container.innerHTML += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${foto}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div>
                            ${p.nome}
                            <div style="font-size:11px; opacity:0.8;">${distTexto}</div>
                        </div>
                    </div>
                    <button onclick="solicitarComissaoEAdicionar('${p.id}', '${p.nome}')" style="width:auto; padding:5px 10px;">➕ Add</button>
                </div>
            `;
        });

    } catch (e) {
        fecharAguarde(null, true);
        console.error(e);
        container.innerHTML = '<p>Erro na busca.</p>';
    }
}

// Substitua a função solicitarComissaoEAdicionar existente por esta:
function solicitarComissaoEAdicionar(membroUid, membroNome) {
    // Pergunta a comissão
    const comissao = prompt(`Qual a porcentagem de comissão para ${membroNome}?\n(O profissional receberá um convite para confirmar)\nDigite apenas o número (ex: 50):`, "50");
    
    if (comissao === null) return; // Cancelou
    
    const valorComissao = parseInt(comissao);
    if (isNaN(valorComissao) || valorComissao < 0 || valorComissao > 100) {
        return exibirPopup("Valor inválido", "A comissão deve ser entre 0 e 100.");
    }

    enviarConviteEquipe(membroUid, membroNome, valorComissao);
}

async function enviarConviteEquipe(membroUid, membroNome, comissao) {
    exibirAguarde("Enviando convite...");
    
    try {
        // Verifica se já não mandou convite antes
        const check = await db.collection("solicitacoes")
            .where("tipo", "==", "convite_equipe")
            .where("remetenteUid", "==", auth.currentUser.uid)
            .where("destinatarioUid", "==", membroUid)
            .where("status", "==", "pendente")
            .get();

        if (!check.empty) {
            fecharTodosOsModais();
            return exibirPopup("Convite Já Enviado", `Você já tem um convite pendente para ${membroNome}. Aguarde a resposta.`);
        }

        // Cria a solicitação
        await db.collection("solicitacoes").add({
            tipo: "convite_equipe",
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nomeBarbearia || perfil.nome, // Nome da Barbearia
            destinatarioUid: membroUid,
            destinatarioNome: membroNome,
            comissaoProposta: comissao,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Notifica o profissional (Push Notification)
        notifyUser(membroUid, "📩 Novo Convite!", `${perfil.nome} quer te adicionar à equipe.`, { link: '#convites' });

        fecharTodosOsModais();
        
        // --- POPUP PERSONALIZADO PROPRIETÁRIO ---
        exibirConfirmacao(
            "📨 Convite Enviado!", 
            `O convite foi enviado para ${membroNome} com proposta de ${comissao}%.<br><br>Status: <b style="color:#f1c40f">Aguardando Confirmação...`,
            () => { fecharModalAtual(); } // Botão OK apenas fecha
        );
        // Esconde o botão "Não/Cancelar" do popup de confirmação para virar apenas um alerta informativo
        setTimeout(() => {
            const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
            if(btnNao) btnNao.style.display = 'none';
            const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
            if(btnSim) btnSim.textContent = "OK, Entendi";
        }, 50);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao enviar convite: " + e.message);
    }
}

// Adicione esta função para listar convites (Pode colocar um botão no painel do profissional)
function abrirModalConvitesEquipe() {
    abrirModal('modalSolicitacoes'); 
    const titulo = document.querySelector('#modalSolicitacoes h3');
    if(titulo) titulo.textContent = "📩 Convites";
    
    const lista = document.getElementById("listaSolicitacoes");
    lista.innerHTML = "<div class='spinner'></div>";

    // Busca convites normais E de recepcionista
    db.collection("solicitacoes")
        .where("destinatarioUid", "==", auth.currentUser.uid)
        .where("tipo", "in", ["convite_equipe", "convite_recepcionista"])
        .where("status", "==", "pendente")
        .onSnapshot(snap => {
            lista.innerHTML = "";
            if (snap.empty) {
                lista.innerHTML = "<p style='text-align:center; padding:20px;'>Nenhum convite pendente.</p>";
                return;
            }

            snap.forEach(doc => {
                const s = doc.data();
                let texto = "";
                let funcaoAceitar = "";
                
                if (s.tipo === 'convite_recepcionista') {
                    texto = `<p style="color:#9b59b6; font-weight:bold;">👑 Convite para RECEPCIONISTA</p>
                             <p style="font-size:12px;">Você terá acesso total à gestão da agenda.</p>`;
                    funcaoAceitar = `responderConviteRecepcionista('${doc.id}', true)`;
                } else {
                    texto = `<p>Comissão Proposta: <b style="color:#2ecc71;">${s.comissaoProposta}%</b></p>`;
                    funcaoAceitar = `responderConviteEquipe('${doc.id}', true)`;
                }

                lista.innerHTML += `
                <div class="card" style="border-left: 4px solid #00c6ff;">
                    Convite de: <b>${s.remetenteNome}</b>
                    ${texto}
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="responderConviteEquipe('${doc.id}', false)" style="background:#c0392b; flex:1;">Recusar</button>
                        <button onclick="${funcaoAceitar}" style="background:#2ecc71; flex:1;">✅ Aceitar</button>
                    </div>
                </div>`;
            });
        });
}

async function responderConviteRecepcionista(solicitacaoId, aceito) {
    exibirAguarde("Processando...");
    
    try {
        const solRef = db.collection("solicitacoes").doc(solicitacaoId);
        const doc = await solRef.get();
        const s = doc.data();
        
        const batch = db.batch();
        
        // 1. Atualiza Perfil da Secretária
        const euRef = db.collection('usuarios').doc(auth.currentUser.uid);
        batch.update(euRef, {
            tipo: 'secretaria',
            pertenceABarbearia: {
                uid: s.remetenteUid,
                nome: s.remetenteNome
            },
            // Salva os dados no perfil dela também para referência
            salario: s.salarioCombinado,
            diaPagamento: s.diaPagamento,
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Adiciona à Equipe do Dono (IMPORTANTE: SALVAR COMO MEMBRO DA EQUIPE)
        const donoRef = db.collection('usuarios').doc(s.remetenteUid);
        const donoDoc = await donoRef.get();
        let equipeAtual = donoDoc.data().equipe || [];
        
        // Remove se já existir
        equipeAtual = equipeAtual.filter(m => (typeof m === 'string' ? m !== auth.currentUser.uid : m.uid !== auth.currentUser.uid));
        
        // Adiciona objeto específico de secretária
        equipeAtual.push({
            uid: auth.currentUser.uid,
            nome: perfil.nome,
            tipo: 'secretaria',
            salario: s.salarioCombinado,
            diaPagamento: s.diaPagamento
        });
        
        batch.update(donoRef, { equipe: equipeAtual });
        
        // 3. Marca solicitação
        batch.update(solRef, { status: "aprovado" });
        
        await batch.commit();
        
        fecharTodosOsModais();
        exibirPopup("Parabéns!", "Você agora é Recepcionista! O app será reiniciado.", "sucesso");
        
        setTimeout(() => location.reload(), 2000);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// Função para processar a resposta (Aceitar/Recusar)
async function responderConviteEquipe(solicitacaoId, aceito) {
    exibirAguarde("Processando...");
    
    try {
        const solRef = db.collection("solicitacoes").doc(solicitacaoId);
        const doc = await solRef.get();
        if (!doc.exists) throw new Error("Convite não encontrado.");
        
        const s = doc.data();
        
        if (!aceito) {
            await solRef.update({ status: "recusado" });
            fecharTodosOsModais();
            exibirPopup("Convite recusado.");
            return;
        }

        // SE ACEITOU: Executa a lógica de adicionar à equipe
        const batch = db.batch();
        
        // 1. Adiciona na lista do Dono (Remetente)
        const donoRef = db.collection('usuarios').doc(s.remetenteUid);
        const docDono = await donoRef.get();
        let equipeAtual = docDono.data().equipe || [];
        
        // Remove duplicatas se houver
        equipeAtual = equipeAtual.filter(m => m.uid !== auth.currentUser.uid);
        
        // Adiciona com a comissão acordada
        equipeAtual.push({
            uid: auth.currentUser.uid,
            nome: perfil.nome,
            comissao: s.comissaoProposta
        });
        
        batch.update(donoRef, { equipe: equipeAtual });

        // 2. Vincula o Profissional (Eu) ao Dono
        const euRef = db.collection('usuarios').doc(auth.currentUser.uid);
        const updateDataMembro = {
            pertenceABarbearia: {
                uid: s.remetenteUid,
                nome: s.remetenteNome
            }
        };
        // Se o dono tem fachada, copia
        if(docDono.data().fachada_url) {
            updateDataMembro.fachada_url = docDono.data().fachada_url;
        }

        batch.update(euRef, updateDataMembro);
        
        // 3. Marca convite como aprovado
        batch.update(solRef, { status: "aprovado" });

        await batch.commit();
        
        fecharTodosOsModais();
        exibirPopup("Parabéns!", `Você agora faz parte da equipe de ${s.remetenteNome}!`);
        location.reload(); // Recarrega para atualizar o painel

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

async function carregarEquipeAtual() {
    const list = document.getElementById('listaEquipeAtual');
    if(!list) return; // Proteção
    list.innerHTML = '<div class="spinner"></div>';
    
    const doc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
    perfil = doc.data(); 
    
    // Suporta formato antigo (array de strings) e novo (array de objetos)
    const equipe = perfil.equipe || [];
    
    if (equipe.length === 0) {
        list.innerHTML = '<p>Sua equipe está vazia.</p>';
        return;
    }
    
    list.innerHTML = '';
    
    // Função auxiliar para renderizar item
    const renderItem = (uid, comissao, nomeCache) => {
        db.collection('usuarios').doc(uid).get().then(mDoc => {
            if (mDoc.exists) {
                const m = mDoc.data();
                const foto = m.fotoPerfil || m.logo_url || '/icone.png';
                const comissaoTexto = comissao !== undefined ? `${comissao}%` : 'Não definida';
                
                list.innerHTML += `
                    <div class="membro-equipe-card" style="display:flex; align-items:center; background:var(--cor-botoes); padding:10px; margin-bottom:5px; border-radius:8px; border:1px solid var(--cor-borda);">
                        <img src="${foto}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover;">
                        <div style="flex-grow:1;">
                            ${m.nome}<br>
                            <small style="color:#aaa;">Comissão: <b style="color:var(--cor-destaque)">${comissaoTexto}</small>
                        </div>
                        <button onclick="solicitarComissaoEAdicionar('${uid}', '${m.nome}')" style="font-size:12px; padding:5px; width:auto;">✏️</button>
                    </div>`;
            }
        });
    };

    equipe.forEach(membro => {
        if (typeof membro === 'string') {
            // Formato antigo (apenas UID)
            renderItem(membro, undefined, '');
        } else {
            // Formato novo (Objeto)
            renderItem(membro.uid, membro.comissao, membro.nome);
        }
    });
}

// --- LÓGICA DE FACHADA ---
function abrirModalFachada() {
    abrirModal('modalFachada');
    const content = document.querySelector('#modalFachada .modal-content');
    
    // Verifica se já tem fachada
    const fachadaAtual = perfil.fachada_url ? perfil.fachada_url : 'https://placehold.co/600x300?text=Sem+Fachada';

    content.innerHTML = `
        <h3>🏢 Fachada do Estabelecimento</h3>
        <p style="font-size:12px; color:#aaa; margin-bottom:15px;">Essa imagem aparecerá no fundo do seu perfil para dar identidade ao seu negócio.</p>
        
        <div style="position: relative; width: 100%; height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid var(--cor-destaque); background-image: url('${fachadaAtual}'); background-size: cover; background-position: center;">
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); padding: 10px; text-align: center;">
                <span style="color: #fff; font-size: 12px;">Visualização Atual</span>
            </div>
        </div>

        <label for="fachadaFile" style="display: block; margin-top: 20px; background: var(--cor-botoes); padding: 15px; border-radius: 10px; border: 1px dashed #555; text-align: center; cursor: pointer;">
            📷 Clique para escolher nova foto
        </label>
        <input id="fachadaFile" type="file" accept="image/*" style="display: none;" onchange="document.querySelector('#modalFachada button').disabled = false; alert('Imagem selecionada! Clique em Salvar.');">
        
        <button onclick="salvarFachada()" disabled style="width: 100%; margin-top: 15px;">💾 Salvar Fachada</button>
        <button onclick="fecharModalAtual()" style="margin-top: 10px; background: #555; width: 100%;">Cancelar</button>
    `;
}

async function salvarFachada() {
    const file = document.getElementById('fachadaFile').files[0];
    if (!file) return exibirPopup("Selecione uma imagem.");
    exibirAguarde("Enviando...");
    try {
        const url = await uploadImage(file, `fachadas/${auth.currentUser.uid}_${Date.now()}`);
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ fachada_url: url });
        fecharTodosOsModais();
        exibirPopup("Fachada salva!");
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// --- LÓGICA DO MAPA DE RASTREAMENTO EM TEMPO REAL ---
let watchIdRastreamento = null;


function tracarRotaInteligente(minhaLat, minhaLon, outraLat, outraLon) {
    // Se sou CLIENTE: Origem = Eu, Destino = Profissional
    if (userRoleMap === 'cliente') {
        atualizarRotaReal(minhaLat, minhaLon, outraLat, outraLon);
    } 
    // Se sou PROFISSIONAL: Origem = Cliente (Outro), Destino = Eu (Minha Lat)
    else {
        atualizarRotaReal(outraLat, outraLon, minhaLat, minhaLon);
    }
}

function limparMapaRastreamento() {
    try {
        if (routingControl && mapRastreamento) {
            try { mapRastreamento.removeControl(routingControl); } catch(e) {}
        }
        routingControl = null;

        if (mapRastreamento) {
            mapRastreamento.off();
            mapRastreamento.remove();
            mapRastreamento = null;
        }
        
        const container = document.getElementById('mapaRastreamento');
        if (container) {
            container._leaflet_id = null; 
            container.innerHTML = ""; 
        }
    } catch (e) { console.warn("Erro ao limpar mapa:", e); }
}

function pararRastreamentoEFechar() {
    if (watchIdRastreamento) navigator.geolocation.clearWatch(watchIdRastreamento);
    fecharModalAtual();
}

function carregarEstados(prefix = '') {
  // Constrói o ID específico para o select de estado baseado no prefixo
  const estadoSelectId = prefix ? `${prefix}Estado` : 'estado';
  const estadoSelect = document.getElementById(estadoSelectId);

  // Se o elemento select específico não for encontrado, loga um erro e sai
  if (!estadoSelect) {
      console.error(`Erro em carregarEstados: Elemento select com ID "${estadoSelectId}" não encontrado.`);
      // Tenta um fallback apenas se o prefixo falhou
      const fallbackSelect = prefix ? document.getElementById('estado') : null;
      if (fallbackSelect) {
           console.warn(`Usando fallback para o select de estado ID "estado" pois "${estadoSelectId}" não foi encontrado.`);
           // Poderia continuar com o fallbackSelect aqui, mas vamos retornar para focar no problema do prefixo
           return;
      } else {
           return; // Sai se nenhum select for encontrado
      }
  }

  console.log(`[Debug] Carregando estados para o select ID: "${estadoSelectId}"`); // Log de depuração

  const valorAtual = estadoSelect.value; // Guarda o valor atual antes de limpar
  estadoSelect.innerHTML = '<option value="">🌎 Selecione o estado</option>'; // Limpa opções existentes

  // Preenche com os estados
  Object.keys(cidadesPorEstado).sort().forEach(sigla => {
    const option = document.createElement('option');
    option.value = sigla;
    option.textContent = sigla;
    if (sigla === valorAtual) {
      option.selected = true; // Tenta re-selecionar o valor anterior
    }
    estadoSelect.appendChild(option);
  });
  console.log(`[Debug] Estados carregados para "${estadoSelectId}". Opções:`, estadoSelect.options.length); // Log de depuração
}

function carregarCidades(prefix = '') {
  // Constrói os IDs específicos baseados no prefixo
  const estadoSelectId = prefix ? `${prefix}Estado` : 'estado';
  const cidadeSelectId = prefix ? `${prefix}Cidade` : 'cidade';

  const estadoSelect = document.getElementById(estadoSelectId);
  const cidadeSelect = document.getElementById(cidadeSelectId);

  // Se os elementos não forem encontrados, loga um erro e sai
  if (!estadoSelect) {
      console.error(`Erro em carregarCidades: Elemento select de estado com ID "${estadoSelectId}" não encontrado.`);
      return;
  }
  if (!cidadeSelect) {
      console.error(`Erro em carregarCidades: Elemento select de cidade com ID "${cidadeSelectId}" não encontrado.`);
      return;
  }

  console.log(`[Debug] Carregando cidades para "${cidadeSelectId}" baseado no estado de "${estadoSelectId}"`); // Log de depuração

  const estado = estadoSelect.value;
  const valorAtual = cidadeSelect.value; // Guarda o valor atual da cidade

  // Limpa opções da cidade e desabilita
  cidadeSelect.innerHTML = '<option value="">🏙️ Selecione a cidade</option>';
  cidadeSelect.disabled = true;

  if (!estado) {
    console.log(`[Debug] Nenhum estado selecionado em "${estadoSelectId}", cidades não carregadas.`);
    return; // Nenhum estado selecionado, não faz mais nada
  }

  const cidades = cidadesPorEstado[estado] || [];

  if (cidades.length > 0) {
      cidades.sort().forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        // Não precisa setar 'selected' aqui, faremos isso depois se necessário
        cidadeSelect.appendChild(option);
      });
      cidadeSelect.disabled = false; // Habilita o select de cidade
      console.log(`[Debug] ${cidades.length} cidades carregadas para "${cidadeSelectId}".`); // Log de depuração
  } else {
       console.log(`[Debug] Nenhuma cidade encontrada para o estado "${estado}"`);
       // Mantém o select de cidade desabilitado
  }

  // Tenta re-selecionar o valor original da cidade DEPOIS de popular as opções
  // Isso é importante caso o valorAtual fosse de um estado diferente
  if (valorAtual && cidadeSelect.querySelector(`option[value="${valorAtual}"]`)) {
      cidadeSelect.value = valorAtual;
      console.log(`[Debug] Cidade "${valorAtual}" re-selecionada em "${cidadeSelectId}".`)
  } else if (cidades.length > 0) {
      // Se não conseguiu re-selecionar o valor antigo (ou não tinha um), e há cidades,
      // seleciona a primeira opção (que é "Selecione a cidade")
      cidadeSelect.value = "";
  }
}


function entrar() {
  // VERIFICA SE O FORMULÁRIO DE CADASTRO ESTÁ VISÍVEL
  const cadastroFields = document.getElementById("cadastro-fields");
  if (!cadastroFields.classList.contains('hidden')) {
    criarConta(); // Se estiver visível, chama a função de criar conta
    return;
  }

  // Lógica original de login
  exibirAguarde("Entrando...");
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  if (!email || !senha) {
    fecharTodosOsModais();
    return exibirPopup("Preencha os campos corretamente.");
  }
  auth.signInWithEmailAndPassword(email, senha)
    .then(() => {
        console.log("Login OK");
        fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        exibirPopup("Erro ao entrar: email ou senha incorreta");
    });
}

function prepararCriarConta() {
    obterLocalizacaoCadastro(); 
    
    // 1. Esconde a senha de login (pois vai criar nova)
    document.getElementById("senha").classList.add("hidden");
    
    // 2. Esconde o GRUPO de botões iniciais (Entrar e Criar Conta)
    // Isso resolve o erro "Cannot read properties of null"
    const botoesIniciais = document.getElementById("botoes-login-inicial");
    if (botoesIniciais) botoesIniciais.classList.add("hidden");

    // 3. Mostra o formulário de cadastro
    document.getElementById("cadastro-fields").classList.remove("hidden");
    
    // Mantém a senha se já digitada no campo de login
    const senhaLogin = document.getElementById("senha").value;
    if(senhaLogin) document.getElementById("senha-cadastro").value = senhaLogin;

    // Lógica do Select (Mantida)
    const tipoSelect = document.getElementById("tipo");
    const perfilBasico = onboardingState ? onboardingState.perfil_basico : null;

    if (perfilBasico === 'profissional') {
        tipoSelect.classList.remove('hidden');
        const optionCliente = tipoSelect.querySelector('option[value="cliente"]');
        if (optionCliente) optionCliente.remove();
        if (tipoSelect.options.length > 0) tipoSelect.selectedIndex = 0;
    } else if (perfilBasico === 'cliente') {
        tipoSelect.classList.add('hidden');
        if (!tipoSelect.querySelector('option[value="cliente"]')) {
            const opt = document.createElement('option');
            opt.value = 'cliente'; opt.text = '🙋 Cliente';
            tipoSelect.insertBefore(opt, tipoSelect.firstChild);
        }
        tipoSelect.value = 'cliente';
    } else {
        tipoSelect.classList.remove('hidden');
        if (!tipoSelect.querySelector('option[value="cliente"]')) {
             const opt = document.createElement('option');
             opt.value = 'cliente'; opt.text = '🙋 Cliente';
             tipoSelect.insertBefore(opt, tipoSelect.firstChild);
        }
    }

    document.getElementById("senha-cadastro").type = "text";
    document.getElementById("senha-confirm").type = "text";
    
    const event = new Event('change');
    tipoSelect.dispatchEvent(event);
}

function voltarParaLogin() {
    // 1. Esconde a área de cadastro
    document.getElementById("cadastro-fields").classList.add("hidden");
    
    // 2. Mostra os campos de login
    document.getElementById("email").classList.remove("hidden");
    document.getElementById("senha").classList.remove("hidden");
    
    // 3. MOSTRA O GRUPO DE BOTÕES INICIAIS DE VOLTA
    const botoesIniciais = document.getElementById("botoes-login-inicial");
    if (botoesIniciais) botoesIniciais.classList.remove("hidden");

    // Reseta campos
    document.getElementById("senha-cadastro").value = "";
    document.getElementById("senha-confirm").value = "";
    document.getElementById("senha-cadastro").type = "password";
    document.getElementById("senha-confirm").type = "password";
    cadastroCoords = null;
}

// ADICIONE ESTA FUNÇÃO NO INDEX.HTML
async function enviarSolicitacaoRecuperacaoSenha() {
    const email = document.getElementById('recuperaEmail').value.trim();
    const telefone = document.getElementById('recuperaTelefone').value.trim();

    if (!email || !telefone) {
        return exibirPopup("Por favor, preencha seu email e telefone.");
    }

    exibirAguarde("Enviando solicitação...");

    try {
        await db.collection("solicitacoes").add({
            tipo: "recuperacao_senha",
            email: email,
            telefone: telefone,
            usuarioNome: `(Solicitante: ${email})`, // Nome temporário
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        const mensagem = encodeURIComponent(`Olá, esqueci minha senha no app King Agenda.\n\nEmail: ${email}\nTelefone: ${telefone}\n\nAguardo o contato para redefinir.`);
        window.open(`https://wa.me/5527995003737?text=${mensagem}`, '_blank');
        
        fecharTodosOsModais();
        exibirPopup("✅ Solicitação enviada! Você foi redirecionado para o WhatsApp para agilizar o atendimento. O administrador entrará em contato em breve.");
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao enviar solicitação: " + error.message);
    }
}

async function criarConta() {
    // 1. Inicia o Popup de Aguarde e bloqueia a tela
    exibirAguarde("Criando sua conta... por favor, não feche o app.");
    
    // Captura de dados dos campos
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha-cadastro").value;
    const senhaConfirm = document.getElementById("senha-confirm").value;
    const tipo = document.getElementById("tipo").value;
    const telefone = document.getElementById("telefone").value.trim();
    const nome = document.getElementById("nomeExibido").value.trim();
    const emailIndicador = document.getElementById("indicador").value.trim();
    const isProprietario = document.getElementById("isProprietario").value === 'sim';
    const nomeBarbearia = document.getElementById("nomeBarbeariaCadastro").value.trim();
    const cidade = document.getElementById('cidade').value || 'Não informada';
    const estado = document.getElementById('estado').value || '';

    // Validações básicas antes de prosseguir
    if (senha !== senhaConfirm) { 
        fecharAguarde(null, true); 
        return exibirPopup("Erro", "As senhas não coincidem."); 
    }
    if (!email || !senha || !nome) { 
        fecharAguarde(null, true); 
        return exibirPopup("Atenção", "Preencha todos os campos obrigatórios."); 
    }
    if (tipo !== 'cliente' && isProprietario && !nomeBarbearia) {
        fecharAguarde(null, true); 
        return exibirPopup("Atenção", "Como proprietário, você deve informar o nome do estabelecimento.");
    }

    try {
        // --- BLINDAGEM PARA CELULAR ---
        // 2. Força a persistência a ser LOCAL para contas reais (E-mail/Senha)
        // Isso garante que o celular mantenha a sessão mesmo após falhas de rede iniciais
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // 3. Cria o usuário no Firebase Auth (Isso gera o login automático)
        const cred = await auth.createUserWithEmailAndPassword(email, senha);
        const uid = cred.user.uid;

        // Lógica de Indicação (Processamento)
        let dadosIndicacao = {};
        if (emailIndicador) {
            try {
                const snapshot = await db.collection('usuarios').where('email', '==', emailIndicador).limit(1).get();
                if (!snapshot.empty) {
                    const indicadorDoc = snapshot.docs[0];
                    dadosIndicacao = {
                        indicadoPorUid: indicadorDoc.id,
                        indicadoPorNome: indicadorDoc.data().nome,
                        indicacaoStatus: 'pendente' 
                    };
                }
            } catch (err) { console.warn("Erro indicação:", err); }
        }

        // Lógica 7 dias PRO para profissionais
        let dadosProInicial = { proAtivo: false, vip: false };
        if (tipo !== 'cliente') {
            const hoje = new Date();
            const validadeInicial = new Date();
            validadeInicial.setDate(hoje.getDate() + 7);
            dadosProInicial = {
                proAtivo: true,
                proTier: 'tier1',
                proExpirationDate: firebase.firestore.Timestamp.fromDate(validadeInicial),
                trialIniciado: true
            };
        }

        // Montagem do objeto final para o Firestore
        const data = {
            email, nome, tipo, telefone,
            saldo: 0, saldoDigital: 0, reputacao: 100,
            isProprietario: isProprietario,
            nomeBarbearia: isProprietario ? nomeBarbearia : null,
            equipe: [], 
            fachada_url: null,
            vagaImediata: false, 
            usaAgendaManual: false,
            lojaLiberada: false,
            cidade: cidade,
            estado: estado,
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            ...dadosProInicial,
            ...dadosIndicacao 
        };

        // 4. SALVA NO FIRESTORE E AGUARDA A CONFIRMAÇÃO DO SERVIDOR (Crucial no Mobile)
        // O Popup de "Aguarde" continua na tela segurando a interface
        await db.collection("usuarios").doc(uid).set(data);

        localStorage.setItem('primeiro_acesso_pos_cadastro', 'true');

        console.log("Perfil criado no banco para o usuário:", uid);

        // 5. TRANSIÇÃO DE TELAS: Agora que o dado existe no banco, limpamos a interface
        fecharTodosOsModais(true); // Remove o 'Aguarde' e outros modais
        
        // Esconde a tela de Login/Cadastro e revela o App
        document.getElementById('authView').classList.add('hidden');
        document.getElementById("topbar")?.classList.remove("hidden");
        document.getElementById("bottomButtons")?.classList.remove("hidden");

        // Chama a função que renderiza a visão principal (Cliente ou Barbeiro)
        if (typeof renderCurrentView === 'function') {
            renderCurrentView(); 
        }

        // Mensagem final de boas-vindas
        let msgSucesso = (tipo !== 'cliente') 
            ? "Bem-vindo! Você ganhou 7 dias de Plano Bronze grátis para começar!" 
            : "Sua conta foi criada com sucesso! Aproveite o King Agenda.";
        
        exibirPopup("🎉 Bem-vindo!", msgSucesso);

    } catch (error) {
        console.error("Erro completo no registro:", error);
        fecharAguarde(null, true); // Libera o popup de carregamento para mostrar o erro
        
        let mensagemErro = "Não foi possível criar sua conta.";
        
        // Tratamento de erros comuns do Firebase Auth
        if (error.code === 'auth/email-already-in-use') {
            mensagemErro = "⚠️ Este e-mail já está sendo usado por outra conta.";
        } else if (error.code === 'auth/weak-password') {
            mensagemErro = "⚠️ A senha deve ter pelo menos 6 caracteres.";
        } else if (error.code === 'auth/invalid-email') {
            mensagemErro = "⚠️ O e-mail digitado é inválido.";
        } else if (error.code === 'auth/network-request-failed') {
            mensagemErro = "⚠️ Falha na conexão. Verifique sua internet.";
        }
        
        exibirPopup("Erro ao registrar", mensagemErro);
    }
}

// --- FUNÇÃO PARA PROCESSAR RECOMPENSA DE INDICAÇÃO (CORRIGIDA) ---
async function processarBonusIndicacao(clienteUid) {
    try {
        const clienteRef = db.collection('usuarios').doc(clienteUid);
        const clienteDoc = await clienteRef.get();
        const clienteData = clienteDoc.data();

        // Só processa se tiver indicação pendente
        if (clienteData.indicadoPorUid && clienteData.indicacaoStatus === 'pendente') {
            
            const indicadorUid = clienteData.indicadoPorUid;
            const indicadorRef = db.collection('usuarios').doc(indicadorUid);
            const indicadorDoc = await indicadorRef.get();

            if (!indicadorDoc.exists) return; 
            const indicadorData = indicadorDoc.data();

            const batch = db.batch();

            // 1. RECOMPENSA PARA O NOVO CLIENTE (Mantido: 50 Pontos)
            batch.update(clienteRef, {
                indicacaoStatus: 'concluido', 
                pontosFidelidade: firebase.firestore.FieldValue.increment(50)
            });
            notifyUser(clienteUid, "🎁 Bônus de Boas-vindas!", "Você ganhou +50 pontos por concluir seu primeiro serviço!", {link:'#fidelidade'});

            // 2. RECOMPENSA PARA QUEM INDICOU (O Padrinho)
            
            if (indicadorData.tipo === 'cliente') {
                // SE QUEM INDICOU É CLIENTE: Ganha Pontos
                batch.update(indicadorRef, {
                    pontosFidelidade: firebase.firestore.FieldValue.increment(50) 
                });
                notifyUser(indicadorUid, "💎 Indicação Concluída!", `${clienteData.nome} usou o app! Você ganhou +50 Pontos.`, {link:'#fidelidade'});
            
            } else {
                // SE QUEM INDICOU É PROFISSIONAL: Ganha Dias (Com Regra de Teto 30 Dias)
                
                const agora = new Date();
                
                // Data Limite (Teto): Hoje + 30 Dias
                const dataTetoMaximo = new Date();
                dataTetoMaximo.setDate(dataTetoMaximo.getDate() + 30);

                // Define a data base para somar
                let baseDate = agora;
                
                // Se ele já é PRO e a data de vencimento é no futuro, usamos a data de vencimento como base
                if (indicadorData.proAtivo && indicadorData.proExpirationDate) {
                    const expAtual = indicadorData.proExpirationDate.toDate ? indicadorData.proExpirationDate.toDate() : new Date(indicadorData.proExpirationDate);
                    if (expAtual > agora) {
                        baseDate = expAtual;
                    }
                }

                // Adiciona +7 dias (1 semana)
                let novaDataExpiracao = new Date(baseDate);
                novaDataExpiracao.setDate(novaDataExpiracao.getDate() + 7);

                // APLICA O TETO: Se a nova data for maior que (Hoje + 30), corta para (Hoje + 30)
                if (novaDataExpiracao > dataTetoMaximo) {
                    novaDataExpiracao = dataTetoMaximo;
                    console.log("Indicação limitada pelo teto de 30 dias.");
                }

                const updateIndicador = {
                    proAtivo: true,
                    proExpirationDate: firebase.firestore.Timestamp.fromDate(novaDataExpiracao)
                };

                // Se não tinha Tier, ganha Tier 1. Se já tinha (ex: Ouro), mantém o Ouro por mais tempo!
                if (!indicadorData.proTier) {
                    updateIndicador.proTier = 'tier1';
                }

                batch.update(indicadorRef, updateIndicador);
                
                // Calcula quantos dias ele realmente ganhou (para notificar corretamente)
                const diasGanhosReais = Math.ceil((novaDataExpiracao - baseDate) / (1000 * 60 * 60 * 24));
                
                if (diasGanhosReais > 0) {
                    notifyUser(indicadorUid, "🚀 Bônus de Indicação!", `${clienteData.nome} completou o serviço! Você ganhou +${diasGanhosReais} dias de Plano PRO.`, {link:'#vip'});
                } else {
                    notifyUser(indicadorUid, "🚀 Indicação Concluída!", `${clienteData.nome} completou o serviço! (Seu plano já está no limite máximo de acúmulo).`, {link:'#vip'});
                }
            }

            await batch.commit();
            console.log("Bônus de indicação processado.");
        }
    } catch (e) {
        console.error("Erro ao processar indicação:", e);
    }
}

// Listeners para mostrar/esconder campos no cadastro
document.getElementById('tipo').addEventListener('change', (e) => {
    const val = e.target.value;
    const divProp = document.getElementById('proprietario-check-container');
    if(val !== 'cliente') {
        divProp.classList.remove('hidden');
    } else {
        divProp.classList.add('hidden');
    }
});

document.getElementById('isProprietario').addEventListener('change', (e) => {
    const isProp = e.target.value === 'sim';
    const inputNome = document.getElementById('nomeBarbeariaCadastro');
    if(isProp) inputNome.classList.remove('hidden');
    else inputNome.classList.add('hidden');
});

document.getElementById('tipo').addEventListener('change', (e) => {
  const isProfissional = e.target.value !== 'cliente';
  document.getElementById('rua').classList.toggle('hidden', !isProfissional);
  document.getElementById('numero').classList.toggle('hidden', !isProfissional);
  cadastroCoords = null; 
});

auth.onAuthStateChanged(async user => {
  // --- 1. LÓGICA PARA USUÁRIO DESLOGADO ---
  if (!user) {
    console.log("Nenhum usuário detectado. Limpando sistema...");
    
    // Para todos os processos ativos
    if (typeof cleanupListeners === 'function') cleanupListeners();

    lastReloadTimestamp = null; 
    previousTipo = null; 

    // Define qual tela mostrar (Login ou Onboarding)
    if (localStorage.getItem('onboarding_concluido') === 'true') {
        mostrar('authView');
    } else {
        if (typeof iniciarOnboarding === 'function') iniciarOnboarding();
    }

    // Esconde elementos restritos
    document.getElementById("btnSair")?.classList.add("hidden");
    document.getElementById("redeemContainer")?.classList.add("hidden");
    document.getElementById("topbar")?.classList.add("hidden");
    document.getElementById("bottomButtons")?.classList.add("hidden");

    perfil = null;
    userView = { originalType: null, currentType: null };
    return; // Para a execução aqui
  }

  // --- 2. LÓGICA PARA USUÁRIO LOGADO (ANÔNIMO OU REAL) ---
  console.log("Usuário detectado:", user.uid, user.isAnonymous ? "(Visitante)" : "(Real)");

  // Se for usuário REAL (e-mail), já esconde a tela de login de imediato
  if (!user.isAnonymous) {
      document.getElementById('authView')?.classList.add('hidden');
      document.getElementById("topbar")?.classList.remove("hidden");
      document.getElementById("bottomButtons")?.classList.remove("hidden");
  }

  // --- LÓGICA DE REINÍCIO AUTOMÁTICO (SÓ NA 1ª VEZ APÓS CRIAR CONTA) ---
  if (localStorage.getItem('primeiro_acesso_pos_cadastro') === 'true') {
      console.log("🚀 Primeiro acesso detectado! O app reiniciará em 50 segundos para aplicar configurações críticas.");
      
      setTimeout(() => {
          // Remove o marcador antes de reiniciar para não entrar em loop
          localStorage.removeItem('primeiro_acesso_pos_cadastro');
          
          exibirAguarde("Finalizando configurações de segurança...");
          
          setTimeout(() => {
              location.reload();
          }, 2000); 

      }, 50000); // 50 segundos
  }

  // Popup de aviso para Visitantes (após 30 segundos)
  if (user.isAnonymous) {
      setTimeout(() => {
          if (auth.currentUser && auth.currentUser.isAnonymous) {
              exibirConfirmacao(
                  "⚠️ Conta Limitada", 
                  "Você está visitando como anônimo. Profissionais não podem ver seu perfil e você pode perder seu histórico.\n\nCrie uma conta gratuita agora para desbloquear todos os recursos!",
                  () => {
                      fecharTodosOsModais();
                      prepararCriarConta();
                      mostrar('authView');
                  }
              );
          }
      }, 30000);
  }

  // Inicializações básicas de login
  armarHistorico();
  if (typeof setupPlayStoreBilling === 'function') setupPlayStoreBilling();
  solicitarPermissaoNotificacao();
  obterLocalizacaoAtual();
  if (typeof handleDeepLink === 'function') handleDeepLink();

  // --- 3. CONFIGURAÇÃO DO LISTENER DO PERFIL (FIRESTORE) ---
  const ref = db.collection("usuarios").doc(user.uid);
  let perfilListenerUnsubscribe = null;

  // Função para limpar listeners (agora acessível dentro do escopo)
  const cleanupListeners = () => {
      console.log("Executando limpeza de listeners ativos...");
      if (perfilListenerUnsubscribe) { perfilListenerUnsubscribe(); perfilListenerUnsubscribe = null; }
      if (typeof updateLastSeenInterval !== 'undefined' && updateLastSeenInterval) { clearInterval(updateLastSeenInterval); updateLastSeenInterval = null; }
      if (typeof onlineUsersListener === 'function') { onlineUsersListener(); onlineUsersListener = null; }
      if (typeof globalChatListener === 'function') { globalChatListener(); globalChatListener = null; }
      if (typeof vendaListener === 'function') { vendaListener(); vendaListener = null; }
      if (typeof comprasClienteListener === 'function') { comprasClienteListener(); comprasClienteListener = null; }
      if (typeof pedidosVendedorListener === 'function') { pedidosVendedorListener(); pedidosVendedorListener = null; }
      if (typeof barbeirosListener === 'function') { barbeirosListener(); barbeirosListener = null; }
      if (typeof agendamentoListener === 'function') { agendamentoListener(); agendamentoListener = null; }
      if (typeof chatListener === 'function') { chatListener(); chatListener = null; }
      if (typeof portfolioListener === 'function') { portfolioListener(); portfolioListener = null; }
      if (typeof adminBalanceListener === 'function') { adminBalanceListener(); adminBalanceListener = null; }
  };

  console.log("Iniciando listener do perfil para:", user.uid);

  perfilListenerUnsubscribe = ref.onSnapshot(s => {
    console.log("Snapshot do perfil recebido.");

    // Blindagem visual do Lopes
    if (typeof fecharTodosOsModais === 'function') {
        fecharTodosOsModais(true); 
    }

    // --- BLINDAGEM MOBILE: CORREÇÃO "CARREGA E SOME" ---
    if (!s.exists) {
        console.log("Aguardando criação do documento no Firestore...");
        // Se 'perfil' já existia antes e sumiu agora, significa que a conta foi deletada.
        if (perfil) {
            console.warn("Perfil não encontrado no banco. Deslogando...");
            cleanupListeners();
            auth.signOut();
        }
        return; // Espera o próximo disparo sem deslogar (Crucial para o celular)
    }

    const perfilAtual = s.data();
    const isInitialLoad = !perfil;
    
    console.log("Snapshot data:", perfilAtual);
    console.log("É carregamento inicial?", isInitialLoad);
    console.log("Tipo anterior:", previousTipo);
    console.log("Tipo atual do snapshot:", perfilAtual.tipo);

    // --- LÓGICA DE RELOAD FORÇADO (Timestamp do Admin) ---
    const newReloadTimestamp = perfilAtual.forceReloadTimestamp;
    if (newReloadTimestamp && lastReloadTimestamp && newReloadTimestamp.toMillis() > lastReloadTimestamp.toMillis()) {
        console.log("Detectada alteração de admin (timestamp), recarregando a página...");
        lastReloadTimestamp = newReloadTimestamp;
        cleanupListeners(); // Limpa listeners ANTES de recarregar
        location.reload();
        return; // Interrompe o processamento deste snapshot
    }
    if (newReloadTimestamp && !lastReloadTimestamp) {
       lastReloadTimestamp = newReloadTimestamp;
    }
    // --- FIM DA LÓGICA DE RELOAD FORÇADO ---
    
    // --- LÓGICA DE RELOAD POR MUDANÇA DE TIPO ---
    const currentTipo = perfilAtual.tipo;

    // Atualiza o perfil global *APÓS* a verificação do timestamp, *ANTES* da verificação de tipo
    perfil = perfilAtual; // Atualiza o perfil global *AGORA*
    perfil.uid = user.uid; // Garante UID no objeto para funções auxiliares

    // === NOVA LINHA: VERIFICA SE PLANO VENCEU OU MUDOU ===
    verificarValidadePlano(perfil, user.uid);
    // =====================================================

    if (!isInitialLoad) {
        // Verifica periodicamente ou quando o perfil muda (ex: data de expiração chega)
        verificarLimpezaItensExpirados(perfil);
    }

    // Verifica a mudança de tipo
    if (!isInitialLoad && previousTipo !== null && currentTipo !== previousTipo) {
        console.log(`Tipo de conta alterado de "${previousTipo}" para "${currentTipo}". Recarregando em 3 segundos...`);
        exibirPopup("Seu tipo de conta foi alterado!", "O aplicativo será reiniciado em 3 segundos para aplicar as mudanças.", "aviso");

        cleanupListeners(); // Limpa TODOS os listeners ANTES de agendar o reload

        setTimeout(() => {
            console.log("Recarregando a página agora devido à mudança de tipo...");
            location.reload();
        }, 3000);
        return; // IMPORTANTE: Para a execução deste snapshot
    }
    // Atualiza o tipo anterior para a próxima verificação, apenas se não for recarregar
    previousTipo = currentTipo;
    // --- FIM DA LÓGICA DE RELOAD POR MUDANÇA DE TIPO ---


    // --- Atualização normal da UI ---
    console.log("Atualizando UI com dados do perfil...");
    const saldoDigital = (perfil.saldoDigital || 0).toFixed(2);
    document.getElementById("saldoHeader").textContent = saldoDigital;
    
    // Atualiza o ícone para Diamante/Moeda
    const btnCarteiraTop = document.getElementById("btnCarteiraTop");
    if(btnCarteiraTop) {
        btnCarteiraTop.innerHTML = `💎 <span id="saldoHeader">${saldoDigital}</span>`;
        // Ao clicar, abre a compra de moedas direto, se preferir, ou a carteira geral
        btnCarteiraTop.onclick = () => abrirModalCarteira(); 
    }

    // (O restante da lógica de atualização da UI permanece igual...)
    const btnVip = document.getElementById('btnVip');
    if (btnVip) {
      if (isVipAtivo(perfil)) {
          btnVip.textContent = '👑 Sou VIP'; btnVip.classList.add('vip-glow');
      } else {
          btnVip.textContent = '💎 VIP'; btnVip.classList.remove('vip-glow');
      }
    }
    const btnVipPro = document.getElementById('btnVipPro');
    if (btnVipPro) {
        if (isProAtivo(perfil)) {
            btnVipPro.textContent = '🌟 Sou PRO'; btnVipPro.classList.add('pro-glow');
        } else {
            btnVipPro.textContent = '🌟 Seja PRO';
            btnVipPro.classList.remove('pro-glow');
        }
    }
    aplicarTemaPorProfissao(perfil.interesse_principal);
    const btnSolicitarLoja = document.getElementById('btnSolicitarAcessoLoja');
    const msgLojaLiberada = document.getElementById('msgLojaJaLiberada');
    if (btnSolicitarLoja && msgLojaLiberada) {
       const mostrarBotao = !perfil.lojaLiberada && perfil.tipo !== 'admin';
       btnSolicitarLoja.classList.toggle('hidden', !mostrarBotao);
       msgLojaLiberada.classList.toggle('hidden', mostrarBotao);
    }

    // --- LÓGICA EXECUTADA APENAS NO PRIMEIRO CARREGAMENTO DO LISTENER ---
    if (isInitialLoad) {
        console.log("Carregamento inicial do perfil via listener concluído.");
        previousTipo = perfil.tipo; // Define o tipo inicial para a próxima comparação
        verificarRastreamentoPendente();

        // Define a view inicial
        if (!userView.originalType) {
            userView.originalType = perfil.tipo;
            userView.currentType = perfil.tipo;
        }
        renderCurrentView(); // Renderiza a view correta

        checarParametrosURL();

if (!perfil.latitude || !perfil.longitude) {
    obterLocalizacaoAtual().then(coords => {
        if(coords) {
            db.collection('usuarios').doc(user.uid).update({
                latitude: coords.latitude,
                longitude: coords.longitude
            });
        }
    }).catch(() => {
        // Se falhar, inicia o intervalo de 45s (O "Vigilante")
        setInterval(() => {
            // Pegamos o chat e verificamos se ele está na tela
            const chat = document.getElementById('janelaChat');
            const chatAberto = chat && (window.getComputedStyle(chat).display !== 'none');
            
            // Só dispara se NÃO houver chat aberto E não houver outro modal na tela
            if (!chatAberto && !document.querySelector('.modal.show')) {
                console.log("Sistema: Solicitando GPS via vigilante...");
                
                exibirConfirmacao(
                    "📍 Localização Necessária", 
                    "Para ver os profissionais mais próximos e usar o app corretamente, precisamos da sua localização. Deseja ativar agora?", 
                    () => {
                        obterLocalizacaoAtual().then(c => {
                            if(c) {
                                db.collection('usuarios').doc(user.uid).update({
                                    latitude: c.latitude,
                                    longitude: c.longitude
                                });
                                exibirPopup("Sucesso", "Localização atualizada!");
                            }
                        }).catch(e => console.warn("GPS recusado."));
                    }
                );
            }
        }, 86400000);
    });
}
        // --- FIM VERIFICAÇÃO ---

        // --- VERIFICAÇÃO AUTOMÁTICA DE HORÁRIO (REGRA 20 MINUTOS - CORRIGIDA) ---
setInterval(async () => {
    if (!auth.currentUser || !perfil) return;
    
    // Só roda se for cliente (quem precisa ver o mapa abrir)
    if (perfil.tipo !== 'cliente') return;

    const agora = new Date();
    const horasAtual = agora.getHours();
    const minutosAtual = agora.getMinutes();
    const tempoAtualEmMinutos = horasAtual * 60 + minutosAtual;

    // Busca agendamentos aprovados/pendentes de conclusão
    db.collection('agendamentos')
      .where('clienteUid', '==', auth.currentUser.uid)
      .where('status', 'in', ['confirmado', 'conclusão pendente'])
      .where('mapaAbertoAutomaticamente', '==', false) // Evita abrir repetidamente
      .get().then(async snap => {
          
          for (const doc of snap.docs) {
              const ag = doc.data();
              
              if (ag.horario && ag.horario.includes(':')) {
                  const [h, m] = ag.horario.split(':').map(Number);
                  const tempoAgendamentoEmMinutos = h * 60 + m;
                  const diff = tempoAgendamentoEmMinutos - tempoAtualEmMinutos;

                  // SE FALTAR 20 MINUTOS OU MENOS (e não for algo de horas atrás)
                  if (diff <= 20 && diff > -60) {
                      
                      console.log("⏰ Hora do mapa! Buscando localização fixa do barbeiro...");
                      
                      // --- AQUI ESTÁ O SEGREDO DO LOCAL FIXO ---
                      // Buscamos o perfil ATUAL do barbeiro para pegar o endereço fixo dele.
                      try {
                          const barberDoc = await db.collection('usuarios').doc(ag.barbeiroUid).get();
                          if (barberDoc.exists) {
                              const bData = barberDoc.data();
                              
                              if (bData.latitude && bData.longitude) {
                                  // Abre o mapa com a localização FIXA do cadastro do barbeiro
                                  iniciarRastreamento(
                                      ag.barbeiroUid, 
                                      bData.latitude, 
                                      bData.longitude, 
                                      'cliente', 
                                      doc.id
                                  );
                                  
                                  // Marca como aberto e toca o som
                                  doc.ref.update({ mapaAbertoAutomaticamente: true });
                                  tocarSom('alerta');
                                  
                                  // Notifica visualmente
                                  if (document.visibilityState === 'visible') {
                                      exibirPopup("⏰ Está na hora!", `Faltam 20 minutos para seu corte. O mapa abriu com a rota até o estabelecimento.`);
                                  } else if (Notification.permission === 'granted') {
                                      new Notification("⏰ Está na hora!", { body: "O mapa abriu! Siga a rota até o barbeiro." });
                                  }
                              } else {
                                  console.warn("Barbeiro sem localização fixa cadastrada.");
                              }
                          }
                      } catch (e) {
                          console.error("Erro ao abrir mapa automático:", e);
                      }
                  } // Fim do if (diff <= 20)
              } // Fim do if (ag.horario)
          } // Fim do for loop
      }); // Fim do .then() do banco
}, 30000); // <--- IMPORTANTE: ESTE É O FECHAMENTO DO setInterval. NÃO APAGUE!

        // --- VERIFICAÇÃO AGENDAMENTO EXATO (HORA DO SERVIÇO) ---
        // Backup para garantir que abra na hora exata se a regra de 20min falhar ou for ignorada
        setInterval(() => {
            if (!perfil || perfil.tipo !== 'cliente') return;
            
            const agora = new Date();
            const horaAtual = agora.getHours().toString().padStart(2,'0') + ':' + agora.getMinutes().toString().padStart(2,'0');
            
            db.collection('agendamentos')
              .where('clienteUid', '==', auth.currentUser.uid)
              .where('status', '==', 'confirmado') // Aprovado
              .where('horario', '==', horaAtual)
              .where('mapaAbertoAutomaticamente', '==', false)
              .get().then(snap => {
                  snap.forEach(doc => {
                      const ag = doc.data();
                      if(ag.barbeiroLat && ag.barbeiroLon) {
                          iniciarRastreamento(ag.barbeiroUid, ag.barbeiroLat, ag.barbeiroLon, 'cliente', doc.id);
                          doc.ref.update({ mapaAbertoAutomaticamente: true });
                          tocarSom('alerta');
                          exibirPopup("⏰ Hora do Serviço!", `Seu horário das ${ag.horario} chegou. O mapa foi aberto.`);
                      }
                  });
              });
        }, 60000);// --- !! BLOCO DE ONBOARDING ATUALIZADO !! ---
        if (perfil.tipo !== 'cliente' && perfil.precisaConfiguracaoInicial === true) {
            setTimeout(() => {
                const onboardingAberto = document.querySelector('#modalOnboardingServicos, #modalOnboardingPromocoes, #modalOnboardingAgenda, #modalOnboardingLogomarca, #modalOnboardingPortfolio');
                if (!onboardingAberto || !onboardingAberto.classList.contains('show')) {
                   console.log("Iniciando fluxo de configuração inicial do profissional...");
                   iniciarFluxoDeConfiguracaoProfissional(); 
                }
            }, 2000);
        } else if (perfil.tipo !== 'cliente' && perfil.precisaConfiguracaoInicial === false) {
             setTimeout(() => {
                verificarPendenciasEssenciaisProfissional(user.uid);
             }, 3000); 
        }
        // --- !! FIM DO BLOCO DE ONBOARDING ATUALIZADO !! ---

        // --- Demais inicializações ---
        if (!updateLastSeenInterval) {
            const updateFn = () => {
                if(auth.currentUser) {
                    db.collection('usuarios').doc(auth.currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(err => console.warn("Falha ao atualizar lastSeen:", err.code));
                }
            };
            updateFn(); 
            updateLastSeenInterval = setInterval(updateFn, 60 * 60 * 1000);
        }
        setupFCM(user.uid);
        exibirVersaoApp();
        iniciarVerificacaoDePendencias(user.uid);
        setTimeout(() => { document.getElementById("btnSair")?.classList.remove("hidden"); }, 15000); 

        // --- Listeners adicionais ---

        // Listener de Avisos (Sininho, Gift Card e SOS)
        db.collection("avisos").where("usuarioUid", "==", user.uid).where("lido", "==", false)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const aviso = change.doc.data();
                        const docId = change.doc.id;

                        // --- LÓGICA GIFT CARD ---
                        if (aviso.tipo === 'gift_received') {
                            if (typeof confetti === 'function') confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 }, zIndex: 99999 });

                            exibirPopup(
                                "🎁 Presente Recebido!",
                                `Seu amigo ${aviso.remetenteNome} te enviou ${aviso.moeda} no valor de R$ ${aviso.valor.toFixed(2)}!`,
                                'sucesso'
                            );

                            db.collection("avisos").doc(docId).update({ lido: true });
                            return;
                        }

                        // --- LÓGICA RADAR SOS PROXIMIDADE ---
                        if (aviso.tipo === 'oferta_relampago') {
                            const jaViu = localStorage.getItem(`sos_visto_${docId}`);
                            if (jaViu) return;

                            if (localizacaoCliente && aviso.latOrigem && aviso.lonOrigem) {
                                const dist = calcularDistancia(localizacaoCliente.latitude, localizacaoCliente.longitude, aviso.latOrigem, aviso.lonOrigem);

                                if (dist <= 3) {
                                    tocarSom('alerta');
                                    localStorage.setItem(`sos_visto_${docId}`, 'true');

                                    exibirConfirmacao(
                                        "🚨 OFERTA PRÓXIMA!",
                                        `<div style="text-align:center;">
                                     <img src="${aviso.remetenteFoto}" style="width:50px; height:50px; border-radius:50%; margin-bottom:10px; border:2px solid red;">
                                     <br>
                                     <strong>${aviso.remetenteNome}</strong> está a <strong>${dist.toFixed(1)}km</strong> de você.<br><br>
                                     <span style="font-size:18px; color:#e74c3c; font-weight:bold;">${aviso.desconto}% DE DESCONTO AGORA!</span>
                                     <br><br>Deseja ver o perfil e agendar?
                                 </div>`,
                                        () => { abrirBarbeiroPerfil(aviso.remetenteUid); }
                                    );
                                }
                            }
                        }
                    }
                });
            });

        // Listener do Chat Global (Com contador de mensagens não lidas)
        if (globalChatListener) globalChatListener();
        
        let mensagensNaoLidasChat = 0; 
        let isFirstLoadGlobal = true; // Impede alerta na abertura do app
        
        // Garante que o botão apareça se o usuário não for anônimo
        const btnChatGlobalEl = document.getElementById('btnChat');
        if (btnChatGlobalEl && !user.isAnonymous) {
            btnChatGlobalEl.classList.remove('hidden');
        }

        globalChatListener = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
            .orderBy("ts", "desc")
            .limit(1)
            .onSnapshot(snapshot => {
                 // Ignora a primeira carga para não tocar som ao abrir o app
                 if (isFirstLoadGlobal) {
                     isFirstLoadGlobal = false;
                     return;
                 }

                 if (!snapshot.empty) {
                     // Verifica alterações reais no banco (Novas mensagens)
                     snapshot.docChanges().forEach(change => {
                         if (change.type === 'added') {
                             const msg = change.doc.data();
                             const usuarioLogado = auth.currentUser ? auth.currentUser.uid : null;

                             // Lógica de Preview (Texto flutuante)
                             const chatPreview = document.getElementById('chatPreview');
                             if (chatPreview) {
                                 const textoPreview = `${msg.remetenteNome}: ${msg.texto.substring(0, 30)}${msg.texto.length > 30 ? '...' : ''}`;
                                 chatPreview.textContent = textoPreview;
                                 chatPreview.classList.add('show');
                                 if (chatPreviewTimeout) clearTimeout(chatPreviewTimeout);
                                 chatPreviewTimeout = setTimeout(() => {
                                     chatPreview.classList.remove('show');
                                 }, 4000);
                             }

                             // --- LÓGICA DE ALERTA (SOM + ANIMAÇÃO) ---
                             const janelaChat = document.getElementById('janelaChat');
                             const btnChat = document.getElementById('btnChat');

                             // Se a janela está FECHADA e NÃO fui eu que mandei
                             if (janelaChat && !janelaChat.classList.contains('show') && msg.remetenteUid !== usuarioLogado) {
                                 
                                 console.log("🔔 Nova mensagem no global! Disparando alerta...");

                                 // 1. Toca o Som (Volume 0.90= 90)
                                 tocarSom('chat', 0.25);

                                 // 2. Animação no Botão
                                 if (btnChat) {
                                     btnChat.classList.add('chat-alert-anim');
                                     
                                     // 3. Atualiza Contador (Badge)
                                     mensagensNaoLidasChat++;
                                     const badge = btnChat.querySelector('.notification-badge');
                                     if (badge) {
                                         badge.textContent = mensagensNaoLidasChat;
                                         badge.classList.remove('hidden');
                                         badge.classList.add('visible');
                                         badge.style.display = 'block'; // Força display
                                     }
                                 }
                             }
                         }
                     });
                 }
            });

        // Listener de Vendas para Vendedores
        if (vendaListener) vendaListener();
        if (perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
            vendaListener = db.collection("loja_pedidos")
                .where("vendedorUid", "==", user.uid)
                .where("vendedorNotificado", "==", false)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        // Verifica se é um pedido NOVO (added)
                        if (change.type === 'added') {
                            // Exibe o popup visual na tela
                            abrirModal('modalVendaRealizada');
                            
                            // Toca um som de notificação (opcional)
                            // const audio = new Audio('/som_venda.mp3'); audio.play().catch(()=>{});

                            // IMPORTANTE: Marca como notificado no banco para que o popup
                            // não abra novamente se a página for recarregada.
                            db.collection("loja_pedidos").doc(change.doc.id).update({ vendedorNotificado: true });
                        }
                    });
                });
        }

        // Listener de Confirmação para Compradores
        if (comprasClienteListener) comprasClienteListener();
        comprasClienteListener = db.collection('loja_pedidos')
            .where('clienteUid', '==', user.uid)
            .where('status', '==', 'entregue_pendente_confirmacao')
            .onSnapshot(snapshot => {
                // (lógica modal confirmação comprador existente)
            });
            
        // --- INÍCIO DOS LISTENERS DA SOLICITAÇÃO ATUAL ---
            
            // LÓGICA DO PROFISSIONAL
        if (perfil.tipo !== 'cliente') {
            
            // 1. LISTENER DE AGENDAMENTOS (ATUALIZADO: ALARME + MONITORAMENTO DE VAGA ATIVA)
            if (agendamentoListener) {
                agendamentoListener();
                agendamentoListener = null;
            }

            // Variável para evitar disparar o som repetidamente para o mesmo pedido
            let ultimoAgendamentoIdAlertado = null;

            setTimeout(() => {
                console.log("Iniciando listener ÚNICO de agendamentos...");
                
                // ATUALIZAÇÃO: Agora escutamos também 'conclusão pendente' e 'confirmado'
                // Isso é necessário para saber se existe uma Vaga Imediata em andamento
                agendamentoListener = db.collection("agendamentos")
                  .where("barbeiroUid", "==", user.uid)
                  .where("status", "in", ["pendente", "imediato", "conclusão pendente", "confirmado"])
                  .orderBy("ts", "asc")
                  .onSnapshot(snapshot => {
                      const modal = document.getElementById('modalNovoAgendamento');
                      
                      // Variáveis de controle para esta execução do snapshot
                      let encontrouVagaAtiva = false;
                      let encontrouPendente = false;

                      if (!snapshot.empty) {
                          snapshot.forEach(doc => {
                              const ag = doc.data();

                              // --- A. LÓGICA DA VAGA IMEDIATA EM ANDAMENTO ---
                              // Se o status indica que está rolando (aprovado) E o horário é imediato
                              if ((ag.status === 'conclusão pendente' || ag.status === 'confirmado') && 
                                  (ag.horario === 'imediato' || !ag.horario)) {
                                  
                                  // Salva na variável global para o botão "Concluir" usar
                                  dadosVagaImediataAtiva = {
                                      id: doc.id,
                                      clienteUid: ag.clienteUid
                                  };
                                  encontrouVagaAtiva = true;
                              }

                              // --- B. LÓGICA DO ALARME / PENDENTES (Mantida) ---
                              if (ag.status === 'pendente' || ag.status === 'imediato') {
                                  encontrouPendente = true; // Marca que tem pendência para não fechar o modal

                                  // Abre o popup visual com os dados
                                  exibirPopupNovoAgendamento(doc);

                                  // Toca o alarme se for um ID novo
                                  if (doc.id !== ultimoAgendamentoIdAlertado) {
                                      if (typeof dispararAlertaMaximo === 'function') {
                                          dispararAlertaMaximo(); 
                                      }
                                      ultimoAgendamentoIdAlertado = doc.id;
                                  }
                              }
                          });
                      }

                      // LIMPEZA: Se não encontrou nenhuma pendência (ou snapshot vazio)
                      if (!encontrouPendente) {
                          // Fecha o modal se estiver aberto
                          if (popupAgendamentoAberto) {
                              if(modal) {
                                  modal.style.display = 'none';
                                  modal.classList.remove('show');
                              }
                              popupAgendamentoAberto = false;
                              ultimoAgendamentoIdAlertado = null;
                          }
                          // Para o som imediatamente
                          if (typeof pararAlertaManual === 'function') {
                              pararAlertaManual();
                          }
                      }

                      // LIMPEZA: Se não encontrou nenhuma vaga ativa no loop, zera a variável global
                      if (!encontrouVagaAtiva) {
                          dadosVagaImediataAtiva = null;
                      }

                      // IMPORTANTE: Chama a atualização visual do botão
                      if (typeof atualizarVisualBotaoVaga === 'function') {
                          atualizarVisualBotaoVaga();
                      }
                  });
            }, 3000);

            // 2. LISTENER PARA LEMBRETE DE CONCLUSÃO (Verificação a cada 1 min)
            setInterval(() => {
                checkLembretesConclusao(user.uid);
            }, 60000); 

            // 3. NOVO LISTENER: DETECTAR CONVITE DE EQUIPE (POPUP AUTOMÁTICO)
            db.collection("solicitacoes")
                .where("destinatarioUid", "==", user.uid)
                .where("tipo", "==", "convite_equipe") // Pega tanto profissional quanto secretaria
                .where("status", "==", "pendente")
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const convite = change.doc.data();
                            
                            // Toca som de alerta
                            tocarSom('alerta');

                            let titulo = "";
                            let mensagem = "";
                            let textoBotao = "Ver Detalhes";

                            // --- VERIFICAÇÃO: É SECRETÁRIA OU PROFISSIONAL? ---
                            if (convite.subtipo === "secretaria_pede_emprego") {
                                // === CASO SECRETÁRIA ===
                                titulo = "👩‍💼 Candidata à Vaga!";
                                const sobreMim = convite.sobreMim ? `"${convite.sobreMim}"` : "Sem apresentação.";
                                mensagem = `
                                    <div style="text-align:center;">
                                        <strong>${convite.remetenteNome}</strong> quer entrar para sua equipe.<br><br>
                                        <span style="font-size:12px; color:#aaa;">Sobre a candidata:</span><br>
                                        <em style="color:#fff; font-style:italic;">${sobreMim}</em>
                                    </div>
                                `;
                                textoBotao = "📋 Analisar e Contratar";

                            } else {
                                // === CASO PROFISSIONAL (COMISSÃO) ===
                                titulo = "📩 Convite de Equipe!";
                                mensagem = `${convite.remetenteNome} quer adicionar você à equipe.<br><br>Comissão Proposta: <b style="color:#2ecc71; font-size:18px;">${convite.comissaoProposta}%</b>`;
                                textoBotao = "Ver Detalhes e Responder";
                            }

                            // Abre o Popup Bloqueante Personalizado com o texto correto
                            exibirPopupBloqueante(titulo, mensagem, () => {
                                // Ação ao clicar no botão do popup
                                if (convite.subtipo === "secretaria_pede_emprego") {
                                    abrirModalSolicitacoes(); // Abre a lista onde estará o card roxo
                                } else {
                                    abrirModalConvitesEquipe();
                                }
                            });
                            
                            // Ajusta o texto do botão do popup dinamicamente
                            setTimeout(() => {
                                const btn = document.getElementById('btnOkBloqueante');
                                if(btn) {
                                    btn.textContent = textoBotao;
                                    btn.style.background = "linear-gradient(45deg, #00c6ff, #0072ff)";
                                }
                            }, 100);

                        }

                    });

                });

        }

        // LÓGICA DO CLIENTE
        if (perfil.tipo === 'cliente') {
            
            // --- LISTENER MESTRE DE AGENDAMENTOS (DETECTA TUDO) ---
            if (unsubscribeCliente) unsubscribeCliente();
            
            console.log("Iniciando monitoramento de agendamentos para o cliente...");

            unsubscribeCliente = db.collection("agendamentos")
              .where("clienteUid", "==", user.uid)
              // Monitoramos status relevantes. Tiramos 'clienteNotificado' da query para filtrar manualmente e garantir que pegue tudo.
              .where("status", "in", ["conclusão pendente", "confirmado", "cancelado"])
              .onSnapshot(snapshot => {
                  snapshot.docChanges().forEach(change => {
                      // Só nos importamos se foi ADICIONADO (novo status) ou MODIFICADO (profissional aprovou)
                      if (change.type === 'added' || change.type === 'modified') {
                          const ag = change.doc.data();
                          const agId = change.doc.id;

                          // Se já foi notificado/visto, ignora para não repetir
                          if (ag.clienteNotificado === true) return;

                          // === CENÁRIO 1: VAGA IMEDIATA APROVADA ===
                          // (Status é 'conclusão pendente' E não tem horário fixo ou é 'imediato')
                          if (ag.status === "conclusão pendente" && (!ag.horario || ag.horario === 'imediato')) {
                              console.log("Detectada aprovação de Vaga Imediata!");
                              tocarSom('sucesso');
                              
                              // Abre o modal vermelho que inicia o countdown de 5s para o mapa
                              // (Não marcamos 'clienteNotificado' aqui, a função do modal faz isso ao abrir o mapa)
                              abrirModalVagaAprovada(agId);
                          }

                          // === CENÁRIO 2: AGENDAMENTO PROGRAMADO APROVADO ===
                          // (Status é 'conclusão pendente' E tem horário HH:MM)
                          else if (ag.status === "conclusão pendente" && ag.horario && ag.horario.includes(':')) {
                              console.log("Detectada aprovação de Agendamento Programado!");
                              tocarSom('sucesso');

                              // POPUP COM A DICA (Como você pediu)
                              exibirPopup(
                                  "✅ Agendamento Aprovado!", 
                                  `Seu horário das ${ag.horario} foi confirmado por ${ag.barbeiroNome}!\n\n💡 DICA: Vá em "Histórico" para ver detalhes.\n🗺️ O mapa abrirá automaticamente 20 minutos antes do horário.`
                              );

                              // Marca como notificado para não aparecer de novo
                              db.collection('agendamentos').doc(agId).update({ clienteNotificado: true });
                          }

                          // === CENÁRIO 3: CANCELADO/RECUSADO ===
                          else if (ag.status === "cancelado") {
                              tocarSom('erro'); // ou alerta
                              exibirPopup("❌ Cancelado", `O agendamento com ${ag.barbeiroNome} foi cancelado ou recusado. O valor foi estornado.`);
                              
                              // Marca como notificado
                              db.collection('agendamentos').doc(agId).update({ clienteNotificado: true });
                          }
                      }
                  });
              });

                // --- NOVO: RADAR DE SOS (OFERTAS EM 3KM) ---
            // Escuta ofertas ativas que ainda não expiraram
            db.collection('avisos')
                .where('tipo', '==', 'oferta_relampago')
                .where('expiraEm', '>', new Date())
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const aviso = change.doc.data();
                            const idAviso = change.doc.id;

                            // 1. Verifica se já viu esse aviso hoje (para não repetir)
                            const jaViu = localStorage.getItem(`sos_visto_${idAviso}`);
                            if (jaViu) return;

                            // 2. Verifica se o cliente tem localização
                            if (localizacaoCliente && aviso.latOrigem && aviso.lonOrigem) {
                                
                                // 3. CALCULA A DISTÂNCIA
                                const dist = calcularDistancia(
                                    localizacaoCliente.latitude, 
                                    localizacaoCliente.longitude, 
                                    aviso.latOrigem, 
                                    aviso.lonOrigem
                                );

                                // 4. SE FOR MENOR QUE 3KM, MOSTRA O POPUP
                                if (dist <= 3) {
                                    tocarSom('alerta'); // Som de oportunidade
                                    
                                    // Marca como visto
                                    localStorage.setItem(`sos_visto_${idAviso}`, 'true');

                                    // Formata a lista de serviços para exibição
                                    const listaServicosHtml = (aviso.servicos || []).map(s => `<span style="background:#333; padding:2px 6px; border-radius:4px; font-size:11px; margin:2px;">${s}</span>`).join(' ');

                                    // Exibe Popup Personalizado Vermelho
                                    exibirConfirmacao(
                                        "🚨 SOS OFERTA PRÓXIMA!", 
                                        `<div style="text-align:center;">
                                            <div style="position:relative; display:inline-block;">
                                                <img src="${aviso.remetenteFoto}" style="width:60px; height:60px; border-radius:50%; margin-bottom:10px; border:3px solid red; object-fit:cover;">
                                                <div style="position:absolute; bottom:0; right:0; background:red; color:white; font-size:10px; padding:2px 5px; border-radius:10px; font-weight:bold;">${dist.toFixed(1)}km</div>
                                            </div>
                                            <br>
                                            <strong style="font-size:16px;">${aviso.remetenteNome}</strong>
                                            <p style="font-size:13px; color:#ccc; margin:5px 0;">"${aviso.mensagem}"</p>
                                            
                                            <div style="margin:10px 0; display:flex; flex-wrap:wrap; justify-content:center; gap:5px;">
                                                ${listaServicosHtml}
                                            </div>

                                            <div style="background:rgba(231, 76, 60, 0.2); border:1px solid #e74c3c; padding:10px; border-radius:8px; margin-top:10px;">
                                                <span style="font-size:20px; color:#e74c3c; font-weight:bold;">${aviso.desconto}% DE DESCONTO</span>
                                                <br><span style="font-size:10px; color:#fff;">Corra! A oferta expira em breve.</span>
                                            </div>
                                            <br>Deseja ver o perfil e agendar?
                                        </div>`, 
                                        () => {
                                            // Se clicar em Sim, abre o perfil do barbeiro
                                            abrirBarbeiroPerfil(aviso.remetenteUid);
                                        }
                                    );
                                    
                                    // Ajusta botão do popup para ficar vermelho (urgência)
                                    setTimeout(() => {
                                        const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
                                        if(btnSim) {
                                            btnSim.style.background = "linear-gradient(45deg, #c0392b, #e74c3c)";
                                            btnSim.textContent = "🔥 PEGAR VAGA";
                                            btnSim.style.border = "1px solid white";
                                            btnSim.style.fontWeight = "bold";
                                        }
                                    }, 50);
                                }
                            }
                        }
                    });
                });

            // Listener para POPUP DE AVALIAÇÃO (Concluído)
db.collection("agendamentos")
  .where("clienteUid", "==", user.uid)
  .where("status", "==", "concluido")
  .where("avisoAvaliacaoEnviado", "==", false) // Flag de controle
  .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
          if (change.type === 'added' || change.type === 'modified') {
              const ag = change.doc.data();
              
              // POPUP BLOQUEANTE
              exibirPopupBloqueante(
                "✅ Serviço Concluído!", 
                `O serviço ${ag.servico} com ${ag.barbeiroNome} foi finalizado.\n\nAjude a comunidade e ganhe pontos avaliando agora!`,
                () => {
                    // Ação ao clicar em OK:
change.doc.ref.update({ avisoAvaliacaoEnviado: true });

// Salva o ID da avaliação no LocalStorage para abrir o modal APÓS o reinício (Opcional, mas recomendado)
localStorage.setItem('abrir_avaliacao_pendente', JSON.stringify({
    agendamentoId: change.doc.id,
    barbeiroUid: ag.barbeiroUid
}));

// --- REINÍCIO RÁPIDO (SEM SPLASH) ---
localStorage.setItem('pular_splash_inicial', 'true');
location.reload();
                }
              );
          }
      });
  });

            // 4. Verificação de AVALIAÇÃO PENDENTE (Uma vez por dia)
            const hoje = new Date().toISOString().split('T')[0]; // Formato 'AAAA-MM-DD'
            const ultimoAvisoAvaliacao = localStorage.getItem('ultimoAvisoAvaliacao');
            
            if (ultimoAvisoAvaliacao !== hoje) {
                console.log("Verificando avaliações pendentes (primeiro login do dia)...");
                db.collection('agendamentos')
                    .where('clienteUid', '==', user.uid)
                    .where('status', '==', 'concluido')
                    .where('avaliado', '==', false)
                    .limit(1)
                    .get()
                    .then(snap => {
                        if (!snap.empty) {
                            // Encontrou avaliação pendente
                            // Usamos um timeout para não sobrepor outros popups de login
                            setTimeout(() => {
                               exibirPopup("Avaliação Pendente", 
                                "Olá! Vimos que você tem um ou mais serviços concluídos que ainda não foram avaliados. Por favor, vá ao seu Histórico e deixe sua avaliação para ganhar King Points!");
                            }, 5000); // Mostra 5 segundos após o login
                        }
                        // Marca como checado para hoje, mesmo se não houver pendências
                        localStorage.setItem('ultimoAvisoAvaliacao', hoje);
                    })
                    .catch(err => {
                        console.error("Erro ao checar avaliações pendentes:", err);
                    });
            }
        }
        
        // --- FIM DOS LISTENERS DA SOLICITAÇÃO ATUAL ---
        
        console.log("Inicialização no primeiro load concluída.");
    }
    // --- FIM DA LÓGICA DO PRIMEIRO CARREGAMENTO ---

else {
        // Este é um update subsequente (não o primeiro load)
        // O perfil (global 'perfil') já foi atualizado no início deste listener
        
        // Verifica se a view atual é a do cliente ou do profissional e recarrega a lista
        if (userView.currentType === 'cliente') {
            console.log("Perfil atualizado (favorito?), recarregando lista de clientes.");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
        } else if (userView.currentType === 'barbeiro') {
            console.log("Perfil atualizado, recarregando lista de profissionais.");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
        }
    }

  }, error => { 
      console.error("Erro CRÍTICO no listener do perfil:", error);
      exibirPopup("Até a Próxima", "Volte sempre e resgate seus benefícios!!", "erro");
      cleanupListeners(); 
      auth.signOut(); 
  });
  // --- Fim do Listener Principal ---

  // --- Verificação inicial de manutenção ---
  try {
      const config = await db.collection("config").doc("sistema").get();
      const initialProfileSnap = await ref.get();
      if (!initialProfileSnap.exists) throw new Error("Perfil não encontrado na verificação inicial.");
      if (config.exists && config.data().ativo === false && initialProfileSnap.data().tipo !== "admin") {
          exibirPopup("🚧 Sistema em manutenção");
          cleanupListeners(); // Limpa listeners se estiver em manutenção
          auth.signOut();
          return;
      }
  } catch (configError) { 
      console.warn("Não foi possível verificar config/sistema:", configError);
  }
  // --- Fim da verificação inicial de manutenção ---

}); // Fim do onAuthStateChanged

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    const modalInstalar = document.getElementById('modalInstalarApp');
    if (modalInstalar) {
        abrirModal('modalInstalarApp');
        const btnInstalar = document.getElementById('btnInstalarPWA');
        btnInstalar.onclick = async () => {
            deferredInstallPrompt.prompt();
            await deferredInstallPrompt.userChoice;
            deferredInstallPrompt = null;
            fecharModalAtual();
        };
    }
});

// ESTA É A FUNÇÃO QUE SALVA NO BANCO (Verifique se a sua está assim):
async function confirmarPagamentoEConcluir() {
    const agId = window.agendamentoIdParaConcluir;
    const metodos = {
        pix: parseFloat(document.getElementById('pag-pix').value) || 0,
        dinheiro: parseFloat(document.getElementById('pag-dinheiro').value) || 0,
        debito: parseFloat(document.getElementById('pag-debito').value) || 0,
        credito: parseFloat(document.getElementById('pag-credito').value) || 0
    };
    const valorTotal = metodos.pix + metodos.dinheiro + metodos.debito + metodos.credito;

    try {
        const batch = db.batch();
        const agRef = db.collection('agendamentos').doc(agId);
        const agDoc = await agRef.get();
        const agData = agDoc.data();

        // 1. Atualiza o agendamento
        batch.update(agRef, {
            status: 'concluido',
            metodosPagamento: metodos,
            valorFinal: valorTotal,
            dataConclusao: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. GRAVA O EXTRATO COM O ID DO AGENDAMENTO (O SEGREDO ESTÁ AQUI)
        const extratoRef = db.collection('extrato_financeiro').doc();
        batch.set(extratoRef, {
            agendamentoId: agId, // <--- ISSO VAI IMPEDIR A DUPLICIDADE NA GESTÃO
            donoUid: agData.donoUid || auth.currentUser.uid,
            usuarioUid: agData.barbeiroUid,
            tipo: 'receita_servico',
            descricao: `Serviço: ${agData.servico}`,
            valor: valorTotal,
            metodos: metodos,
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();
        exibirPopup("Sucesso!", "Agendamento concluído com sucesso.");
        fecharModal('modal-pagamento');
        carregarFinanceiro(); // Recarrega a lista sem duplicados

    } catch (e) {
        console.error("Erro ao concluir:", e);
        exibirPopup("Erro", "Não foi possível concluir o agendamento.");
    }
}

// ======================================================
// ❌ FUNÇÃO FECHAR MODAL ATUAL (Completa e Blindada)
// ======================================================
function fecharModalAtual(veioDoHistorico = false) {
    // 1. Proteção: Se a pilha de modais não existir ou estiver vazia
    if (typeof modalStack === 'undefined' || modalStack.length === 0) {
        // Fallback: Tenta encontrar qualquer modal aberto na marra e fechar
        const modalsPerdidos = document.querySelectorAll('.modal.show');
        if (modalsPerdidos.length > 0) {
            modalsPerdidos.forEach(m => {
                m.classList.remove('show');
                setTimeout(() => m.style.display = 'none', 300);
            });
        }
        return; 
    }

    // 2. Remove o último ID da pilha (LIFO - Last In, First Out)
    const modalId = modalStack.pop(); 
    const modal = document.getElementById(modalId);

    if (modal) {
        // 3. Efeito Visual (Remove classe e aguarda animação)
        modal.classList.remove('show');
        
        // Pequeno delay para garantir que a animação CSS (opacity/transform) rode
        setTimeout(() => {
            modal.style.display = 'none';
            
            // Limpezas específicas (Opcional: reseta iframes ou vídeos se houver)
            const iframes = modal.querySelectorAll('iframe');
            iframes.forEach(i => { const src = i.src; i.src = ''; i.src = src; });
        }, 300); // 300ms deve bater com o transition do seu CSS

        // 4. Feedback Sonoro (Seu sistema de som)
        if (typeof tocarSom === 'function') {
            tocarSom('pop'); // Ou o som que você usa para fechar
        }
    }

    // 5. Lógica Crítica do Botão Voltar (Android/iOS)
    // Se o usuário clicou no "X" ou "Cancelar" (veioDoHistorico = false),
    // nós precisamos remover o estado do navegador manualmente.
    if (!veioDoHistorico) {
        // Define flag para que o evento 'popstate' (arquivo 3.txt) não tente fechar de novo
        window.ignoreNextPopstate = true; 
        
        // Volta um nível no histórico do navegador
        if (window.history.state && window.history.state.page !== 'home') {
            window.history.back();
        }
    }
}

// Substitua a função abrirModalCarteira inteira por esta:
async function abrirModalCarteira() {
    const modalId = 'modalCarteira';
    const modal = document.getElementById(modalId);
    
    // 1. SEGURANÇA: Se o modal não existe no HTML, para tudo.
    if (!modal) {
        console.error("Erro: #modalCarteira não encontrado no HTML.");
        return;
    }

    // 2. O PULO DO GATO (CORREÇÃO DO BUG):
    // Antes de abrir, nós removemos qualquer classe antiga que possa estar travando
    // e forçamos o navegador a entender que ele estava fechado.
    modal.classList.remove('active');
    modal.classList.remove('show');
    modal.style.display = 'none';
    
    // Pequeno truque para forçar o navegador a processar a limpeza (Reflow)
    void modal.offsetWidth; 

    // 3. AGORA SIM, ABRIMOS O MODAL LIMPO
    // Chama a função global (se existir) ou abre na força
    if (typeof abrirModal === 'function') {
        abrirModal(modalId);
    } else {
        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('active'), 10);
        // Adiciona à pilha se a variável global existir
        if (typeof modalStack !== 'undefined') modalStack.push(modal);
    }

    // 4. PREPARA O CONTEÚDO (Mantendo seu layout preferido)
    const container = modal.querySelector(".modal-content");
    if(!container) return; // Segurança extra

    container.innerHTML = `
        <div style="text-align:center; padding:20px;">
            <h3>💰 Minha Carteira</h3>
            <p>🔄 Carregando saldos...</p>
        </div>
    `;

    try {
        // --- LEITURA DOS SALDOS ---
        // Garante que perfil existe
        const p = (typeof perfil !== 'undefined') ? perfil : {};
        
        const saldoReal = (p.saldoReal !== undefined) ? p.saldoReal : (p.saldo || 0);
        const saldoBonus = p.saldoBonus || 0;
        const saldoTotalVirtual = saldoReal + saldoBonus;
        const saldoDigital = p.saldoDigital || 0; 
        
        // Botão Gift Card
        const btnGiftCardHtml = `<button onclick="abrirModalGiftCard()" style="width:100%; margin-top:5px; background: #9b59b6; border: 1px solid #fff;">🎁 Enviar Presente (Gift Card)</button>`;
        
        // HTML dos Saldos Detalhados
        const detalheSaldosHtml = `
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1; background:#222; padding:8px; border-radius:8px; border:1px solid #27ae60;">
                    <span style="font-size:10px; color:#aaa;">💵 Depositado/Ganhos</span>
                    <div style="color:#2ecc71; font-weight:bold;">R$ ${saldoReal.toFixed(2)}</div>
                </div>
                <div style="flex:1; background:#222; padding:8px; border-radius:8px; border:1px solid #f1c40f;">
                    <span style="font-size:10px; color:#aaa;">🎁 Bônus/Fidelidade</span>
                    <div style="color:#f1c40f; font-weight:bold;">R$ ${saldoBonus.toFixed(2)}</div>
                </div>
            </div>
            <p style="font-size:10px; color:#777; margin-top:5px; text-align:center;">
                *Regra: Bônus só pode ser sacado proporcionalmente ao Saldo Real.<br>
                *Loja: Use bônus para descontos em produtos.
            </p>
        `;

        // Bloco Principal (Saldo Real + Botões de Ação)
        // Nota: Adicionei a verificação de 'acaoCarteira' para garantir que ela existe
        const htmlPrincipal = `
        <div style="background: linear-gradient(135deg, #1e1e1e, #2a2a2a); padding: 15px; border-radius: 12px; border: 1px solid #d4af37; margin-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <span style="font-size:14px; display:block;">💶 Saldo Total</span>
                </div>
                <span style="font-size:20px; font-weight:bold; color:#fff;">R$ ${saldoTotalVirtual.toFixed(2)}</span>
            </div>
            
            ${detalheSaldosHtml}
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="if(typeof acaoCarteira === 'function') { acaoCarteira('deposito') } else { iniciarDeposito() }" 
                        style="flex:1; font-size:12px; background:transparent; border:1px dashed #555;">📥 Depositar</button>
                        
                <button onclick="if(typeof acaoCarteira === 'function') { acaoCarteira('saque') } else { iniciarSaque() }" 
                        style="flex:1; font-size:12px; background:#27ae60;">📤 Sacar</button>
            </div>
            
            ${btnGiftCardHtml}
        </div>`;

        // Bloco Carteira Digital (Moedas)
        const htmlDigital = `
            <div style="background: linear-gradient(135deg, #1a2530, #000); padding: 15px; border-radius: 12px; border: 1px solid #00c6ff;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align:left;">
                        <span style="font-size:14px; color: #00c6ff; display:block;">💎 Carteira Digital</span>
                        <span style="font-size:11px; color:#aaa;">VIP, Boost, Itens</span>
                    </div>
                    <span style="font-size:20px; font-weight:bold; color:#00c6ff;">${saldoDigital.toFixed(2)}</span>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="iniciarCompraMoedas()" style="flex:1; background: linear-gradient(45deg, #00c6ff, #0072ff); font-weight:bold;">💎 Comprar Moedas</button>
                </div>
            </div>
        `;

        // Renderiza tudo e garante o botão de fechar correto
        container.innerHTML = `
            <h3>💰 Minha Carteira</h3>
            ${htmlPrincipal}
            ${htmlDigital}
            <button onclick="fecharTodosOsModais()" style="margin-top: 15px; background:#333; width:100%; padding:12px; border-radius:8px;">❌ Fechar Carteira</button>
        `;
        
    } catch (erro) {
        console.error("Erro ao renderizar carteira:", erro);
        container.innerHTML = `<p style="color:red">Erro ao carregar dados da carteira.</p><button onclick="fecharTodosOsModais()">Fechar</button>`;
    }
}

// --- FUNÇÕES AUXILIARES DE FECHAMENTO (Adicione logo abaixo da função acima) ---

// Essa função fecha a carteira FORÇADO e chama a próxima
window.acaoCarteira = function(tipo) {
    const m = document.getElementById('modalCarteira');
    if(m) {
        m.style.display = 'none'; // Some na hora
        m.classList.remove('active');
    }
    
    // Chama as funções de formulário que criamos antes
    if(tipo === 'deposito') iniciarDeposito();
    if(tipo === 'saque') iniciarSaque();
}

window.fecharModalCarteiraForcado = function() {
    const m = document.getElementById('modalCarteira');
    if(m) {
        m.style.display = 'none';
        m.classList.remove('active');
    }
}

async function criarSolicitacaoDeposito() {
    const primeiroNome = document.getElementById('depositoPrimeiroNome').value.trim();
    const segundoNome = document.getElementById('depositoSegundoNome').value.trim();
    const cpf = document.getElementById('depositoCpf').value.trim();
    const telefone = document.getElementById('depositoTelefone').value.trim();
    const valor = parseFloat(document.getElementById('depositoValor').value);

    if (!primeiroNome || !segundoNome || !cpf || !telefone || isNaN(valor) || valor <= 0) {
        return exibirPopup("Por favor, preencha todos os campos corretamente.");
    }

    const nomeCompleto = `${primeiroNome} ${segundoNome}`;
    
    // Define o tipo de saldo para descrição
    const tipoSaldoDesc = tipoDepositoAtual === 'digital' ? 'Moedas Digitais' : 'Saldo de Serviços';

    exibirAguarde("Criando solicitação...");

    try {
        // 1. Cria a solicitação no painel do Admin
        await db.collection("solicitacoes").add({
            tipo: "deposito",
            subtipo: tipoDepositoAtual, // 'servico' ou 'digital'
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            dadosDeposito: { nomeCompleto, cpf, telefone },
            valor: valor,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Notifica Admin
        notifyAdmins("📥 Novo Depósito Pendente", `${perfil.nome} quer depositar R$${valor.toFixed(2)} em ${tipoSaldoDesc}.`, { link: '#solicitacoes' });

        fecharTodosOsModais();
        
        // 3. ABRE O MODAL DE PAGAMENTO IMEDIATAMENTE
        abrirModal('modalDeposito');

    } catch (error) {
        console.error("Erro ao criar solicitação:", error);
        fecharTodosOsModais();
        exibirPopup("Erro ao processar solicitação.");
    }
}

async function checkLembretesConclusao(uid) {
    if (!perfil || perfil.tipo === 'cliente') return; // Só para profissionais

    try {
        const query = db.collection("agendamentos")
            .where("barbeiroUid", "==", uid)
            .where("status", "==", "conclusão pendente")
            .where("lembreteConcluirEnviado", "==", false);
            
        const snapshot = await query.get();
        if (snapshot.empty) return; // Sem lembretes

        const agora = new Date();
        const batch = db.batch(); // Para atualizar os lembretes enviados

        for (const doc of snapshot.docs) {
            const ag = doc.data();
            
            // Tenta encontrar o serviço na lista de perfil para pegar a duração
            const servicoNome = ag.servico;
            const servico = perfil.listaServicos.find(s => s.nome === servicoNome);

            if (!servico || !servico.duracao || !ag.confirmadoEm) {
                // Se não achar o serviço ou a duração, marca como enviado para não checar de novo
                batch.update(doc.ref, { lembreteConcluirEnviado: true });
                continue;
            }

            const duracaoMs = servico.duracao * 60 * 1000;
            const horaConfirmacao = ag.confirmadoEm.toDate();
            const horaLembrete = new Date(horaConfirmacao.getTime() + duracaoMs);

            // Se o tempo já passou
            if (agora > horaLembrete) {
                exibirPopup("Lembrete de Conclusão", `O tempo estimado para o serviço '${servicoNome}' com ${ag.clienteNome} já passou. Não se esqueça de ir em 'Agendamentos' e clicar em 'Concluir' para liberar a avaliação do cliente e ambos ganharem pontos.`);
                
                // Marca para não notificar de novo
                batch.update(doc.ref, { lembreteConcluirEnviado: true });
            }
        }
        
        await batch.commit(); // Atualiza todos os lembretes enviados

    } catch (error) {
        console.error("Erro ao checar lembretes de conclusão:", error);
    }
}

// --- VARIÁVEIS PARA O EFEITO DE "ENROLAR" (LOADING DIVERTIDO) ---
let frasesEngracadas = [
    "📡 Buscando satélites...",
    "☁️ Conectando às nuvens...",
    "💈 Afiando as tesouras...",
    "🚀 Calculando a melhor rota...",
    "✨ Quase lá...",
    "📩 Notificando o profissional...",
    "⏳ Só mais um instante...",
    "💎 Polindo os diamantes...",
    "🔄 Tentando conexão..."
];
let intervaloFrases = null;

// --- FUNÇÃO DE AGUARDE (COM ANIMAÇÃO DE TEXTO) ---
function exibirAguarde(textoInicial = "Carregando...") {
    const popup = document.getElementById('popupAguarde');
    const textoEl = document.getElementById('popupAguardeTexto');

    // Limpa qualquer animação anterior para não encavalar
    if (intervaloFrases) clearInterval(intervaloFrases);
    
    // Limpa timeout de erro antigo se houver
    if (typeof aguardeTimeoutId !== 'undefined' && aguardeTimeoutId) {
        clearTimeout(aguardeTimeoutId);
        aguardeTimeoutId = null;
    }

    // Configuração Inicial
    textoEl.textContent = textoInicial;
    textoEl.style.opacity = 1;
    popup.style.display = 'flex';
    
    // Pequeno delay para a classe CSS de entrada
    setTimeout(() => popup.classList.add('show'), 10);
    
    // INICIA O LOOP DE FRASES (A MÁGICA DA ENROLAÇÃO)
    intervaloFrases = setInterval(() => {
        // 1. Fade Out (Texto some)
        textoEl.style.opacity = 0;

        setTimeout(() => {
            // 2. Troca o texto por uma frase aleatória
            const fraseAleatoria = frasesEngracadas[Math.floor(Math.random() * frasesEngracadas.length)];
            textoEl.textContent = fraseAleatoria;
            
            // 3. Fade In (Texto aparece)
            textoEl.style.opacity = 1;
        }, 500); // Meio segundo para a troca suave

    }, 3000); // Troca a frase a cada 3 segundos
}

// --- FUNÇÃO PARA FECHAR O AGUARDE (E LIMPAR A ANIMAÇÃO) ---
function fecharAguarde(event, force = false) {
    // Para o loop de frases
    if (intervaloFrases) {
        clearInterval(intervaloFrases);
        intervaloFrases = null;
    }

    const popup = document.getElementById('popupAguarde');
    
    // Lógica original de fechar com clique ou forçado
    if (force || (event && event.target.id === 'popupAguarde')) {
        if (!force && typeof aguardeClickCount !== 'undefined') {
            aguardeClickCount++;
            if (aguardeClickCount < 2) return;
            aguardeClickCount = 0;
        }
        
        // Remove da pilha de modais se estiver lá
        if (typeof modalStack !== 'undefined') {
             const index = modalStack.indexOf(popup);
             if (index > -1) modalStack.splice(index, 1);
        }

        popup.classList.remove('show');
        setTimeout(() => popup.style.display = 'none', 300);
    }
}

// --- FUNÇÃO DE NOTIFICAÇÃO BLINDADA (RETRY AUTOMÁTICO SEM ERRO) ---
async function enviarNotificacaoParaBackend(uid, title, body, data = {}, tentativas = 0) {
  const backendUrl = "https://navalhabackend.onrender.com/enviar-notificacao";
  
  if (!uid) {
      console.log("[NOTIFICAÇÃO] Ignorada: Sem UID.");
      return;
  }

  // Se for a primeira tentativa, loga.
  if (tentativas === 0) console.log(`[NOTIFICAÇÃO] Enviando: "${title}"...`);
  
  try {
    // Define um timeout de 15s para considerar internet muito lenta
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000);

    const response = await fetch(backendUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, title, body, data }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);

    if (response.ok) {
      console.log('✅ Notificação entregue com sucesso!');
    } else {
      throw new Error(`Erro status: ${response.status}`);
    }

  } catch (error) {
    // AQUI É A MUDANÇA: Em vez de mostrar popup de erro, tentamos de novo silenciosamente
    console.warn(`⚠️ Falha na notificação (Tentativa ${tentativas + 1}):`, error);

    if (tentativas < 3) {
        // Espera 3 segundos e tenta de novo (Recursividade)
        setTimeout(() => {
            enviarNotificacaoParaBackend(uid, title, body, data, tentativas + 1);
        }, 3000);
    } else {
        // Se falhar 4 vezes, apenas loga no console.
        // NÃO mostramos popup de erro para não assustar o usuário, já que a ação principal (ex: agendar) provavelmente funcionou localmente.
        console.error('❌ Desistindo da notificação após várias tentativas (Internet instável).');
    }
  }
}

function notifyUser(uid, title, body, data = {}) {
    // Esta função simplesmente "chama" a outra que já existe.
    // Assim, você não precisa trocar todas as chamadas no código.
    enviarNotificacaoParaBackend(uid, title, body, data);
}

// FUNÇÃO ESSENCIAL QUE ESTAVA FALTANDO
async function notifyAdmins(title, body, data = {}) {
    try {
        console.log(`[notifyAdmins] Notificando admins: "${title}"`);
        const adminSnapshot = await db.collection('usuarios').where('tipo', '==', 'admin').get();
        if (adminSnapshot.empty) {
            console.warn("[notifyAdmins] Nenhum administrador encontrado para notificar.");
            return;
        }
        
        adminSnapshot.forEach(doc => {
            console.log(`[notifyAdmins] Enviando para o admin: ${doc.data().nome}`);
            enviarNotificacaoParaBackend(doc.id, title, body, data);
        });

    } catch (error) {
        console.error("Erro crítico ao tentar notificar os administradores:", error);
    }
}

async function abrirPortaSecreta() {
  document.getElementById('inputCodigoResgate').value = ''; // Limpa o input
  fecharModalAtual();
  abrirModal('modalResgatarCodigo');
}

async function executarResgateCodigo() {
  const input = document.getElementById('inputCodigoResgate');
  const codigoOriginal = input.value.trim(); // Mantém com maiúsculas/minúsculas e parênteses
  
  if (!codigoOriginal) return;

  // Prepara versão limpa para verificar VIP/TIER (remove parenteses e põe em maiúsculo)
  // Assim funciona se digitar "VIP", "(VIP)", "vip" ou "(vip)"
  const codigoLimpo = codigoOriginal.replace(/[()]/g, '').toUpperCase(); 

  fecharModalAtual();
  exibirAguarde("Verificando código...");

  // ============================================================
  // 1. RESGATE PROMOÇÃO: VIP (30 DIAS GRÁTIS PARA CLIENTES)
  // ============================================================
  if (codigoLimpo === "VIP") {
      if (perfil.tipo !== 'cliente') {
          fecharTodosOsModais();
          return exibirPopup("Código Inválido", "Este código é exclusivo para Clientes.");
      }
      
      // Verifica se já resgatou
      if (perfil.codigosResgatados && perfil.codigosResgatados['PROMO_VIP_30DIAS']) {
           fecharTodosOsModais();
           return exibirPopup("Já Usado", "Você já resgatou este presente de boas-vindas!");
      }

      const expiracao = new Date();
      expiracao.setDate(expiracao.getDate() + 30); // +30 dias

      // Atualiza para VIP
      const updates = {
          vip: true,
          vipExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao),
          [`codigosResgatados.PROMO_VIP_30DIAS`]: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
          await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
          fecharTodosOsModais();
          tocarSom('sucesso');
          exibirPopup("🎁 PARABÉNS!", "Você ganhou 30 Dias de VIP Grátis! Aproveite Cashback e Taxa Zero.", "sucesso");
          
          // Atualiza visual do botão blog (para parar de piscar)
          if(typeof verificarAvisosPromocionais === 'function') verificarAvisosPromocionais();
          
      } catch(e) {
          fecharTodosOsModais();
          exibirPopup("Erro", e.message);
      }
      return;
  }

  // ============================================================
  // 2. RESGATE PROMOÇÃO: TIER 1 (30 DIAS GRÁTIS PARA PROFISSIONAIS)
  // ============================================================
  if (codigoLimpo === "TIER1") {
      if (perfil.tipo === 'cliente' || perfil.tipo === 'admin') {
          fecharTodosOsModais();
          return exibirPopup("Código Inválido", "Este código é exclusivo para Profissionais.");
      }

      // Verifica se já resgatou
      if (perfil.codigosResgatados && perfil.codigosResgatados['PROMO_TIER1_30DIAS']) {
           fecharTodosOsModais();
           return exibirPopup("Já Usado", "Você já resgatou este presente de boas-vindas!");
      }

      const expiracao = new Date();
      expiracao.setDate(expiracao.getDate() + 30); // +30 dias

      // Atualiza para PRO Tier 1
      const updates = {
          proAtivo: true,
          proTier: 'tier1', // Bronze
          proExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao),
          [`codigosResgatados.PROMO_TIER1_30DIAS`]: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
          await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
          fecharTodosOsModais();
          tocarSom('sucesso');
          exibirPopup("🎁 PARABÉNS!", "Você ganhou 30 Dias de TIER 1 (Bronze)! Vaga Imediata liberada.", "sucesso");
          
          // Atualiza visual do botão blog
          if(typeof verificarAvisosPromocionais === 'function') verificarAvisosPromocionais();

      } catch(e) {
          fecharTodosOsModais();
          exibirPopup("Erro", e.message);
      }
      return;
  }

  // ============================================================
  // 3. CÓDIGO DE ADMINISTRADOR
  // ============================================================
  if (codigoOriginal === "Ja997640401") {
    if (perfil.tipo === "admin") {
        fecharTodosOsModais();
        return exibirPopup("Aviso", "Sua conta já é de administrador.");
    }
    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({ tipo: "admin" });
        fecharTodosOsModais();
        exibirPopup("Sucesso!", "🔑 Sua conta agora é de Administrador! A página será recarregada.");
        setTimeout(() => location.reload(), 4000);
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro", e.message);
    }
    return;
  }

  // ============================================================
  // 4. CÓDIGOS DO BLOG (PONTOS DE FIDELIDADE)
  // ============================================================
  // Verifica se começa e termina com parênteses ex: (CODIGO123)
  if (codigoOriginal.startsWith("(") && codigoOriginal.endsWith(")")) {
    
    const quarentaHorasAtras_Blog = new Date(Date.now() - 40 * 60 * 60 * 1000);
    const blogQuery = db.collection("blog")
        .where('ts', '>', firebase.firestore.Timestamp.fromDate(quarentaHorasAtras_Blog));
    
    const blogPosts = await blogQuery.get();
    let codigoValidoNoBlog = false;
    blogPosts.forEach(doc => {
        if (doc.data().conteudo?.includes(codigoOriginal)) {
            codigoValidoNoBlog = true;
        }
    });

    if (!codigoValidoNoBlog) {
        fecharTodosOsModais();
        return exibirPopup("Erro", "Código inválido ou expirado. (Não encontrado no blog recente)");
    }

    const limiteCooldown = new Date(Date.now() - 40 * 60 * 60 * 1000);
    let redemptionMap = {};
    if (perfil.codigosResgatados && typeof perfil.codigosResgatados === 'object' && !Array.isArray(perfil.codigosResgatados)) {
        redemptionMap = perfil.codigosResgatados;
    } 
    
    const ultimoResgateDesteCodigo_TS = redemptionMap[codigoOriginal];

    if (ultimoResgateDesteCodigo_TS) {
        const ultimoResgateDate = (typeof ultimoResgateDesteCodigo_TS.toDate === 'function') 
            ? ultimoResgateDesteCodigo_TS.toDate() 
            : new Date(ultimoResgateDesteCodigo_TS);

        if (ultimoResgateDate > limiteCooldown) {
            const horasRestantes = Math.ceil((ultimoResgateDate.getTime() - limiteCooldown.getTime()) / (1000 * 60 * 60));
            fecharTodosOsModais();
            return exibirPopup("Aguarde", `Você já resgatou este código recentemente. Tente novamente em aproximadamente ${horasRestantes} hora(s).`);
        }
    }
    
    redemptionMap[codigoOriginal] = new Date();
    const updateData = {
        pontosFidelidade: firebase.firestore.FieldValue.increment(5),
        codigosResgatados: redemptionMap
    };
    // Limpeza de campo legado se existir
    if (perfil.hasOwnProperty('ultimo_resgate_ts')) {
        updateData.ultimo_resgate_ts = firebase.firestore.FieldValue.delete();
    }

    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update(updateData);
        fecharTodosOsModais();
        exibirPopup("Sucesso!", "🎉 Código válido! Você ganhou 5 King Points.");
        notifyUser(auth.currentUser.uid, "🏆 King Points!", "Você ganhou 5 pontos por resgatar um código do blog!", { link: '#fidelidade' });
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao resgatar código: " + e.message);
    }

  } else {
    // ============================================================
    // 5. CÓDIGO INVÁLIDO
    // ============================================================
    fecharTodosOsModais();
    exibirPopup("Erro", "Código inválido!");
  }
}

// Função chamada pelo botão de busca do cliente
function abrirBarbeiros() {
  abrirModal('modalBarbeariasCliente');
  
  // Reseta o filtro para mostrar todos ao abrir
  mostrarApenasFavoritos = false;
  const btn = document.getElementById('btnMostrarFavoritos');
  if(btn) btn.textContent = "⭐ Mostrar Apenas Favoritos";

  // Carrega a lista no novo ID correto
  carregarBarbeirosPrincipal('listaBarbeirosPrincipalModal', false);
}

function verificarAvisosPromocionais() {
    if (!perfil) return;

    // Identifica qual código o usuário deveria pegar
    const codigoAlvo = perfil.tipo === 'cliente' ? 'PROMO_VIP_30DIAS' : 'PROMO_TIER1_30DIAS';
    const jaResgatou = perfil.codigosResgatados && perfil.codigosResgatados[codigoAlvo];
    
    // Encontra o botão do Blog (Procura nos painéis de funções)
    // O seletor pega qualquer botão que tenha "Blog" no texto
    const botoes = Array.from(document.querySelectorAll("button"));
    const btnBlog = botoes.find(b => b.textContent.includes("Blog") || b.textContent.includes("📰"));

    if (!jaResgatou && perfil.tipo !== 'admin') {
        // 1. Faz o botão piscar
        if (btnBlog) btnBlog.classList.add('btn-destaque-promo');

        // 2. Mostra Popup (Apenas uma vez por dispositivo)
        const jaViuAviso = localStorage.getItem('aviso_promo_visto');
        if (!jaViuAviso) {
            setTimeout(() => {
                // Só abre se não tiver outro modal aberto
                if (modalStack.length === 0) {
                    abrirModal('modalAvisoPromo');
                    tocarSom('sucesso'); // Som feliz
                    localStorage.setItem('aviso_promo_visto', 'true');
                }
            }, 2000); // Espera 2s após entrar
        }
    } else {
        // Se já resgatou, remove o destaque
        if (btnBlog) btnBlog.classList.remove('btn-destaque-promo');
    }
}

function filtrarBarbeiros() {
  const termo = document.getElementById("filtroBarbeiro").value.toLowerCase();
  const barbeiros = document.querySelectorAll("#listaBarbeiros .card");
  barbeiros.forEach(card => {
    const nome = card.querySelector("h4").textContent.toLowerCase();
    const cidade = card.querySelector(".card-header-info p").textContent.toLowerCase();
    if (nome.includes(termo) || cidade.includes(termo)) {
      card.style.display = "flex";
    } else {
      card.style.display = "none";
    }
  });
}

function resetAgendamentoState() {
    agendamentoState = { barbeiroUid: null, barbeiroNome: null, servico: null, horario: null, barbeiroLat: null, barbeiroLon: null };
}

function selecionarServico(element, servico) {
    document.querySelectorAll('#barbeiroPerfilServicosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.servico = servico;
    verificarEstadoBotaoAgendar();
}

function selecionarHorario(element, horario) {
    document.querySelectorAll('#barbeiroPerfilHorariosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.horario = horario;
    verificarEstadoBotaoAgendar();
}

function verificarEstadoBotaoAgendar() {
    document.getElementById('btnConfirmarAgendamento').disabled = !(agendamentoState.servico && agendamentoState.horario);
}

async function abrirBarbeiroPerfil(barbeiroUid, isGuest = false) {
    try {
        // Reseta o estado do agendamento
        resetAgendamentoState();
        
        const barbeiroDoc = await db.collection("usuarios").doc(barbeiroUid).get();
        if (!barbeiroDoc.exists) throw new Error("Profissional não encontrado.");
        const b = barbeiroDoc.data();

        // Atualiza missão diária se existir
        if (typeof atualizarProgressoMissao === 'function') atualizarProgressoMissao('abrir_perfil_pro');

        const agora = new Date();
        const getSafeDate = (field) => {
            if(!field) return null;
            if(typeof field.toDate === 'function') return field.toDate();
            if(field.seconds) return new Date(field.seconds * 1000);
            return new Date(field);
        };

        // --- PREPARAÇÃO DO ESTADO ---
        agendamentoState.barbeiroUid = barbeiroUid;
        agendamentoState.barbeiroNome = b.nome;
        agendamentoState.barbeiroLat = b.latitude;
        agendamentoState.barbeiroLon = b.longitude;
        agendamentoState.barbeiroTelefone = b.telefone; 

        // Define o Dono (Para a Contingência/Secretária saberem)
        if (b.pertenceABarbearia && b.pertenceABarbearia.uid) {
            agendamentoState.donoUid = b.pertenceABarbearia.uid;
        } else {
            agendamentoState.donoUid = barbeiroUid;
        }

        // --- LÓGICA DE SOS ---
        let sosAtivo = false;
        let sosDados = null;
        if (b.sosConfig && b.sosConfig.ativo) {
            const expiracao = getSafeDate(b.sosConfig.expiraEm);
            if (expiracao && expiracao > agora) {
                sosAtivo = true;
                sosDados = b.sosConfig;
            }
        }

        // --- LÓGICA DE PROMOÇÃO FIXA ---
        let mapaPromoFixa = {}; 
        if (b.promocoes && Array.isArray(b.promocoes)) {
            b.promocoes.forEach(p => {
                let valida = true;
                if (p.validade) {
                    const dataVal = getSafeDate(p.validade);
                    if (dataVal < agora) valida = false;
                }
                if (valida && p.servicosAplicaveis) {
                    p.servicosAplicaveis.forEach(servicoNome => {
                        const descAtual = mapaPromoFixa[servicoNome] || 0;
                        if (p.desconto > descAtual) {
                            mapaPromoFixa[servicoNome] = p.desconto;
                        }
                    });
                }
            });
        }

        // --- LÓGICA DA FACHADA (IMAGEM DE FUNDO) ---
        const modalEl = document.getElementById('modalBarbeiroPerfil');
        const contentEl = modalEl.querySelector('.modal-content');
        contentEl.classList.remove('fachada-bg');
        let styleTag = document.getElementById('fachada-dynamic-style');
        if(styleTag) styleTag.remove();

        let fachadaUrl = null;
        // Tenta pegar fachada do dono se for funcionário
        if (b.pertenceABarbearia && b.pertenceABarbearia.uid) {
            try {
                const donoDoc = await db.collection("usuarios").doc(b.pertenceABarbearia.uid).get();
                if (donoDoc.exists && donoDoc.data().fachada_url) fachadaUrl = donoDoc.data().fachada_url;
            } catch (err) {}
        }
        // Se não achou do dono ou é autônomo, tenta a própria
        if (!fachadaUrl && b.fachada_url) fachadaUrl = b.fachada_url;

        if (fachadaUrl) {
            contentEl.classList.add('fachada-bg');
            styleTag = document.createElement('style');
            styleTag.id = 'fachada-dynamic-style';
            styleTag.innerHTML = `.fachada-bg::before { background-image: url('${fachadaUrl}'); }`;
            document.head.appendChild(styleTag);
        }

        // --- RENDERIZAÇÃO DO CABEÇALHO ---
        const badgeSOS = sosAtivo ? `<span style="background:#c0392b; color:white; font-size:10px; padding:2px 6px; border-radius:4px; margin-left:5px; border:1px solid white; animation: pulse-red 1.5s infinite;">🔥 ${sosDados.desconto}% OFF</span>` : '';

        const notaMedia = (b.numAvaliacoes > 0) ? (b.somaAvaliacoes / b.numAvaliacoes) : 5;
        let qtdEstrelas = Math.round(notaMedia / 2);
        if (qtdEstrelas > 5) qtdEstrelas = 5;
        const estrelasVisual = '⭐'.repeat(qtdEstrelas);

        const containerHeader = document.getElementById("barbeiroPerfilHeader");
        containerHeader.innerHTML = `
            <h3 id="barbeiroPerfilNome">💈 ${b.nome} ${badgeSOS}</h3>
            <p>Endereço: <span id="barbeiroPerfilEndereco">${(b.rua && b.numero) ? `${b.rua}, ${b.numero} - ${b.cidade}` : b.cidade}</span></p>
            <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:5px;">
                <span id="barbeiroPerfilReputacao">${estrelasVisual} (${b.reputacao || 0} pts)</span>
                <button onclick="verAvaliacoesPublicas('${barbeiroUid}')" style="font-size: 11px; padding: 4px 8px; background: var(--cor-destaque); color: #000; border: none; border-radius: 15px; cursor: pointer;">
                    📋 Ver Avaliações
                </button>
            </div>
            <img id="profissionalLogo" src="${b.fotoPerfil || b.logo_url || ''}" style="max-width: 100px; border-radius: 50%; display: ${b.fotoPerfil || b.logo_url ? 'block' : 'none'}; margin: 10px auto; border: 2px solid var(--cor-destaque);">
            ${sosAtivo ? `<p style="color:#e74c3c; font-size:13px; text-align:center; margin-top:5px; font-weight:bold; background:rgba(231, 76, 60, 0.1); padding:5px; border-radius:5px;">📢 "${sosDados.mensagem}"</p>` : ''}
        `;

        // --- RENDERIZAÇÃO DOS SERVIÇOS ---
        const servicosList = document.getElementById("barbeiroPerfilServicosList");
        servicosList.innerHTML = "";
        
        if (b.listaServicos?.length > 0) {
            b.listaServicos.forEach(s => {
                let nomeExibicao = s.nome;
                let valorFinal = s.valor;
                let htmlPreco = `R$ ${s.valor.toFixed(2)}`;
                let temDesconto = false;
                let estiloExtra = '';

                if (sosAtivo && sosDados.servicos && sosDados.servicos.includes(s.nome)) {
                    temDesconto = true;
                    const descontoDecimal = sosDados.desconto / 100;
                    valorFinal = s.valor * (1 - descontoDecimal);
                    htmlPreco = `<span style="text-decoration:line-through; opacity:0.6; font-size:11px; margin-right:5px;">R$ ${s.valor.toFixed(2)}</span> <b style="color:#e74c3c; font-size:15px;">🔥 R$ ${valorFinal.toFixed(2)}</b>`;
                    nomeExibicao = `🔥 ${s.nome}`;
                    estiloExtra = 'border: 1px solid #e74c3c; background: rgba(231, 76, 60, 0.05);';
                }
                else if (mapaPromoFixa[s.nome]) {
                    temDesconto = true;
                    const descPercent = mapaPromoFixa[s.nome];
                    const descontoDecimal = descPercent / 100;
                    valorFinal = s.valor * (1 - descontoDecimal);
                    htmlPreco = `<span style="text-decoration:line-through; opacity:0.6; font-size:11px; margin-right:5px;">R$ ${s.valor.toFixed(2)}</span> <b style="color:#FFD700; font-size:15px;">🏷️ R$ ${valorFinal.toFixed(2)}</b>`;
                    nomeExibicao = `🏷️ ${s.nome} (${descPercent}%)`;
                    estiloExtra = 'border: 1px solid #FFD700; background: rgba(255, 215, 0, 0.05);';
                }

                const servicoParaAgendar = { ...s, valor: valorFinal, valorOriginal: s.valor, isOfertaRelampago: temDesconto };
                const servicoJSON = JSON.stringify(servicoParaAgendar).replace(/"/g, '"');

                servicosList.innerHTML += `
                    <div class="selectable-item" onclick='selecionarServico(this, ${servicoJSON})' style="${estiloExtra}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>${nomeExibicao}</span>
                            <span>${htmlPreco}</span>
                        </div>
                        ${s.duracao ? `<small style="opacity:0.7">${s.duracao} min</small>` : ''}
                    </div>`;
            });
        } else {
            servicosList.innerHTML = "<p>Nenhum serviço cadastrado.</p>";
        }

        // --- HORÁRIOS EM TEMPO REAL (REAL-TIME) ---
        
        // 1. Limpa listener anterior se houver
        if (unsubscribeHorariosPerfil) {
            unsubscribeHorariosPerfil();
            unsubscribeHorariosPerfil = null;
        }

        // 2. Prepara o container
        const horariosList = document.getElementById("barbeiroPerfilHorariosList");
        horariosList.innerHTML = '<div class="spinner"></div>';

        // 3. Inicia o Monitoramento
        // Isso vai preencher a lista e manter atualizado (sumindo com os ocupados)
        monitorarHorariosRealTime(barbeiroUid, "barbeiroPerfilHorariosList", "cliente");

        // --- BOTÃO DE ASSINATURA/PLANOS ---
        let htmlPlanosBtn = '';
        if (b.planosConfig && b.planosConfig.length > 0) {
            const minhaAssinatura = (perfil.assinaturasAtivas || []).find(a => a.profissionalUid === barbeiroUid && a.status === 'ativa');
            if (minhaAssinatura) {
                let dataValidade = "Indefinida";
                if(minhaAssinatura.validade) {
                     const d = minhaAssinatura.validade.toDate ? minhaAssinatura.validade.toDate() : new Date(minhaAssinatura.validade);
                     dataValidade = d.toLocaleDateString();
                }
                htmlPlanosBtn = `
                <div class="assinatura-ativa-badge">
                    <p style="color:#2ecc71; font-weight:bold; margin:0;">✅ Assinatura Ativa: ${minhaAssinatura.nomePlano}</p>
                    <p style="font-size:10px; color:#aaa;">Expira em: ${dataValidade}</p>
                </div>`;
            } else {
                htmlPlanosBtn = `
                <button onclick="abrirListaPlanos('${barbeiroUid}', '${b.nome}')" class="btn-plano-destaque">
                    💎 VER PLANOS MENSAIS 💎
                </button>`;
            }
        }
        const btnPlanoAntigo = document.getElementById('btnPlanoDinamico');
        if(btnPlanoAntigo) btnPlanoAntigo.remove();
        const divAssinaturaAntiga = document.getElementById('divAssinaturaAtivaDinamica');
        if(divAssinaturaAntiga) divAssinaturaAntiga.remove();

        if(htmlPlanosBtn) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlPlanosBtn;
            const el = tempDiv.firstElementChild;
            if(el.tagName === 'BUTTON') el.id = 'btnPlanoDinamico';
            else el.id = 'divAssinaturaAtivaDinamica';
            const containerHorarios = document.getElementById("barbeiroPerfilHorarios");
            containerHorarios.parentNode.insertBefore(el, containerHorarios);
        }

        // --- BOTÕES DE AÇÃO (PORTFOLIO, ROTA, FECHAR) ---
        const btnPortfolio = document.getElementById('btnAcessarPortfolio');
        const btnRota = document.getElementById('btnAbrirRota');
        
        if (b.portfolio && b.portfolio.length > 0) {
            btnPortfolio.classList.remove('hidden');
            btnPortfolio.onclick = () => abrirPortfolioCliente(barbeiroUid, b.nome);
        } else { btnPortfolio.classList.add('hidden'); }
        
        if (b.latitude && b.longitude) {
            btnRota.classList.remove('hidden');
            btnRota.onclick = () => abrirRota(b.latitude, b.longitude);
        } else { btnRota.classList.add('hidden'); }

        document.getElementById('btnConfirmarAgendamento').onclick = confirmarAgendamento;
        verificarEstadoBotaoAgendar();

        // --- IMPORTANTE: CONFIGURA O BOTÃO FECHAR PARA MATAR O LISTENER ---
        const btnFechar = document.querySelector('button[data-modal-id="modalBarbeiroPerfil"]');
        const novoBtn = btnFechar.cloneNode(true);
        btnFechar.parentNode.replaceChild(novoBtn, btnFechar);
        
        novoBtn.onclick = (e) => {
            if (unsubscribeHorariosPerfil) {
                unsubscribeHorariosPerfil(); // Para de ouvir
                unsubscribeHorariosPerfil = null;
            }
            fecharModal(e);
        };

        abrirModal('modalBarbeiroPerfil');

    } catch (error) {
        console.error("Erro perfil:", error);
        exibirPopup("Erro", "Detalhe: " + error.message);
    }
}

async function abrirCriarPlano() {
    // 1. Garante que o Modal Exista (Cria se não existir)
    const modalId = 'modalCriarPlano';
    let modal = document.getElementById(modalId);
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.onclick = (e) => fecharModal(e);
        document.body.appendChild(modal);
    }

    // 2. Prepara as opções de membros (Se for dono)
    let selectMembro = '';
    
    if (perfil.isProprietario && perfil.equipe && perfil.equipe.length > 0) {
        let options = `<option value="${auth.currentUser.uid}">Para Mim Mesmo</option>`;
        perfil.equipe.forEach(m => {
            const uid = typeof m === 'string' ? m : m.uid;
            const nome = typeof m === 'object' ? m.nome : 'Membro';
            options += `<option value="${uid}">Para: ${nome}</option>`;
        });
        selectMembro = `
            <div id="containerSelectMembroPlano" style="margin-bottom: 15px; background: #222; padding: 10px; border-radius: 8px;">
                <label style="font-size:12px; color:#aaa;">Criar este plano para:</label>
                <select id="planoTargetUid" style="width:100%; margin-top:5px; padding:8px;">${options}</select>
            </div>`;
    } else {
        selectMembro = `<input type="hidden" id="planoTargetUid" value="${auth.currentUser.uid}">`;
    }

    // 3. Prepara a lista de serviços (Checkboxes)
    let htmlServicos = '<div style="max-height:150px; overflow-y:auto; background:#222; padding:10px; margin-bottom:10px; border:1px solid #444; border-radius:8px;">';
    if(perfil.listaServicos && perfil.listaServicos.length > 0) {
        perfil.listaServicos.forEach(s => {
            htmlServicos += `
            <label style="display:flex; align-items:center; gap:10px; margin-bottom:5px; cursor:pointer;">
                <input type="checkbox" class="check-servico-plano" value="${s.nome}" style="width:auto; margin:0;"> 
                <span style="font-size:13px; color:#ddd;">${s.nome} (R$ ${s.valor.toFixed(2)})</span>
            </label>`;
        });
    } else {
        htmlServicos += '<p style="color:#e74c3c; font-size:12px;">Cadastre serviços no seu perfil primeiro.</p>';
    }
    htmlServicos += '</div>';

    // 4. INJETA O HTML (Com o novo campo de limite)
    modal.innerHTML = `
    <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 90vh; overflow-y: auto;">
        <h3 style="color:#d4af37; text-align:center;">👑 Novo Plano de Assinatura</h3>
        
        <div id="planoCriarScroll" class="scrollable-list" style="padding-right: 5px;">
            
            ${selectMembro}

            <label>Nome do Plano:</label>
            <input id="planoNome" type="text" placeholder="Ex: Rei do Corte (4x Mês)">
            
            <label>Período de Cobrança:</label>
            <select id="planoPeriodo">
                <option value="mensal">Mensal (30 Dias)</option>
                <option value="semanal">Semanal (7 Dias)</option>
                <option value="anual">Anual (365 Dias)</option>
            </select>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Valor (R$):</label>
                    <input type="number" id="planoValor" placeholder="0.00" step="0.01">
                </div>
                <div style="flex:1">
                    <label>Limite de Usos:</label>
                    <input type="number" id="planoLimite" placeholder="0 = Ilimitado" title="Quantas vezes o cliente pode usar neste período">
                </div>
            </div>
            <p style="font-size:10px; color:#aaa; margin-top:-5px; margin-bottom:10px;">*Digite 0 ou deixe vazio para uso ILIMITADO.</p>

            <label style="margin-top:10px;">Serviços Inclusos:</label>
            ${htmlServicos}

            <label style="color:#e74c3c; font-weight:bold; margin-top:10px;">📜 Regras de Uso (OBRIGATÓRIO):</label>
            <p style="font-size:11px; color:#ccc; margin-bottom:5px;">Seja específico! O cliente deve aceitar isso antes de assinar.</p>
            <textarea id="planoRegras" rows="6" placeholder="Ex: Máximo de 4 cortes por mês. Válido de Terça a Quinta. Agendamento com 2h de antecedência."></textarea>
        </div>

        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="fecharModalAtual()" style="background:#555; flex:1;">Cancelar</button>
            <button onclick="salvarNovoPlano()" style="background: linear-gradient(45deg, #d4af37, #f1c40f); color:black; font-weight:bold; flex:1;">💾 CRIAR PLANO</button>
        </div>
    </div>`;
    
    abrirModal(modalId);
}

async function salvarNovoPlano() {
    const targetUid = document.getElementById('planoTargetUid').value;
    const nome = document.getElementById('planoNome').value.trim();
    const periodo = document.getElementById('planoPeriodo').value;
    const valor = parseFloat(document.getElementById('planoValor').value);
    const regras = document.getElementById('planoRegras').value.trim();
    
    // NOVO: Captura o limite
    const limiteInput = document.getElementById('planoLimite').value;
    // Se estiver vazio ou 0, consideramos 0 (que significará ilimitado na lógica futura)
    const limiteUso = limiteInput ? parseInt(limiteInput) : 0;

    const checkboxes = document.querySelectorAll('.check-servico-plano:checked');
    const servicos = Array.from(checkboxes).map(c => c.value);

    if (!nome || isNaN(valor) || valor <= 0 || !regras || servicos.length === 0) {
        return exibirPopup("Dados Incompletos", "Preencha Nome, Valor, Regras e selecione ao menos 1 serviço.");
    }

    exibirAguarde("Criando plano...");

    try {
        const planoData = {
            id: `plano_${Date.now()}_${Math.floor(Math.random()*1000)}`, // ID Único
            nome,
            periodo, // 'mensal', 'semanal', 'anual'
            valor,
            limiteUso: limiteUso, // <--- CAMPO SALVO AQUI
            regras,
            servicosInclusos: servicos,
            criadoPor: auth.currentUser.uid,
            ativo: true,
            criadoEm: firebase.firestore.Timestamp.now()
        };

        // Salva no array 'planosConfig' do usuário alvo
        await db.collection('usuarios').doc(targetUid).update({
            planosConfig: firebase.firestore.FieldValue.arrayUnion(planoData)
        });

        fecharTodosOsModais();
        exibirPopup("Sucesso", "Plano criado e disponível para os clientes!");

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao criar plano: " + e.message);
    }
}

async function abrirListaPlanos(barbeiroUid, nomeBarbeiro) {
    exibirAguarde("Buscando planos...");
    
    let modal = document.getElementById('modalVisualizarPlanos');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalVisualizarPlanos';
        modal.className = 'modal';
        modal.onclick = (e) => fecharModal(e);
        
        modal.innerHTML = `
            <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 85vh; display: flex; flex-direction: column;">
                <div style="flex-shrink: 0; padding-bottom: 10px; border-bottom: 1px solid var(--cor-borda);">
                    <h3 id="tituloListaPlanos" style="margin: 0; color: var(--cor-destaque);">💎 Planos</h3>
                </div>
                
                <div id="containerListaPlanos" class="scrollable-list" style="flex-grow: 1; overflow-y: auto; padding: 10px 0;">
                </div>

                <button onclick="fecharModalAtual()" style="margin-top: 15px; background: #555; flex-shrink: 0;">❌ Fechar</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    try {
        const doc = await db.collection('usuarios').doc(barbeiroUid).get();
        if (!doc.exists) throw new Error("Profissional não encontrado");
        
        const b = doc.data();
        const planos = b.planosConfig || [];
        const planosAtivos = planos.filter(p => p.ativo);

        fecharTodosOsModais(); 

        if (planosAtivos.length === 0) {
            return exibirPopup("Sem Planos", "Este profissional não tem planos ativos no momento.");
        }

        const container = document.getElementById('containerListaPlanos');
        document.getElementById('tituloListaPlanos').textContent = `💎 Planos de ${nomeBarbeiro}`;
        
        container.innerHTML = ''; 

        planosAtivos.forEach(p => {
            const servicosUl = p.servicosInclusos.map(s => `<li>✂️ ${s}</li>`).join('');
            
            // LÓGICA DE EXIBIÇÃO DO LIMITE
            let textoLimite = "USO ILIMITADO ♾️";
            if (p.limiteUso && p.limiteUso > 0) {
                textoLimite = `${p.limiteUso} VEZES / ${p.periodo.toUpperCase()}`;
            }

            container.innerHTML += `
            <div class="plano-card">
                <h2 style="color:#fff; margin:0 0 5px 0;">${p.nome}</h2>
                <p style="color:#d4af37; font-size:26px; font-weight:bold; margin:0;">
                    R$ ${p.valor.toFixed(2)} 
                    <span style="font-size:12px; color:#aaa; font-weight:normal;">/${p.periodo}</span>
                </p>
                
                <div style="margin: 10px 0; background: rgba(255, 255, 255, 0.1); padding: 5px; border-radius: 5px; text-align: center;">
                    <span style="color: #fff; font-weight: bold; font-size: 13px;">${textoLimite}</span>
                </div>
                
                <div style="background:#111; padding:10px; border-radius:8px; margin:15px 0; border:1px dashed #444;">
                    <ul style="text-align:left; color:#ccc; font-size:14px; margin:0; padding-left:20px; line-height:1.6;">
                        ${servicosUl}
                    </ul>
                </div>

                <div class="regras-box">
                    <strong style="color:#e74c3c;">📜 REGRAS DE USO:</strong><br>
                    ${p.regras.replace(/\n/g, '<br>')}
                </div>

                <label style="display:flex; align-items:center; gap:10px; margin:15px 0; font-size:13px; cursor:pointer; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <input type="checkbox" id="check_agree_${p.id}" style="width:20px; height:20px;">
                    Li e concordo com todas as regras acima.
                </label>

                <button onclick="solicitarAssinatura('${p.id}', '${barbeiroUid}', ${p.valor}, '${p.nome}', '${p.periodo}')" 
                        class="btn-agendar-plano" style="margin-top:0;">
                    ✍️ ASSINAR PLANO
                </button>
            </div>`;
        });

        abrirModal('modalVisualizarPlanos');

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", e.message);
    }
}

let valoresPagamento = { dinheiro: 0, pix: 0, credito: 0, debito: 0 };

// --- CORREÇÃO 1: GARANTIR QUE O ID SEJA SALVO AO ABRIR O PAGAMENTO ---
function abrirModalPagamento(id) {
    console.log("Abrindo pagamento para o ID:", id); // Para debug

    if (!id) {
        // Se o ID não veio direto, tenta pegar da variável global (caso tenha vindo dos Detalhes)
        if (window.agendamentoAtualId) {
            id = window.agendamentoAtualId;
        } else {
            console.error("Tentativa de abrir pagamento sem ID!");
            return;
        }
    }

    // AQUI É O SEGREDO: Grava o ID na memória global
    window.agendamentoAtualId = id; 

    // Abre o modal visualmente
    const modal = document.getElementById('modalPagamento'); // ou modalConclusao
    if (modal) {
        modal.classList.remove('hidden');
    }
    
    // Zera o valor anterior do input
    const inputValor = document.getElementById('inputValorCobrado');
    if(inputValor) inputValor.value = '';
}

function fecharModalPagamento() {
    const modal = document.getElementById('modal-pagamento');
    if (modal) ocultarModalVisualmente(modal);
}

function toggleInput(tipo) {
    const container = document.getElementById('inputs-valores');
    const check = document.querySelector(`input[value="${tipo}"]`);
    const idInput = `input-valor-${tipo}`;

    if (check.checked) {
        // Cria o input
        const div = document.createElement('div');
        div.id = `div-${tipo}`;
        div.innerHTML = `
            <label style="color: #d4af37; font-size: 12px;">Valor em ${tipo.toUpperCase()}</label>
            <input type="tel" id="${idInput}" placeholder="0,00" 
            oninput="formatarMoeda(this); atualizarTotal()"
            style="width: 100%; background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 5px;">
        `;
        container.appendChild(div);
    } else {
        // Remove input e valor
        const div = document.getElementById(`div-${tipo}`);
        if(div) div.remove();
        valoresPagamento[tipo] = 0;
        atualizarTotal();
    }
}

function formatarMoeda(input) {
    let v = input.value.replace(/\D/g, ""); // Remove tudo que não é dígito
    v = (v / 100).toFixed(2) + "";
    v = v.replace(".", ",");
    v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    input.value = v;
}

function atualizarTotal() {
    let soma = 0;
    ['dinheiro', 'pix', 'credito', 'debito'].forEach(tipo => {
        const input = document.getElementById(`input-valor-${tipo}`);
        if (input) {
            // Converte "1.200,50" para float 1200.50
            let rawValue = input.value.replace(/\./g, "").replace(",", ".");
            valoresPagamento[tipo] = parseFloat(rawValue) || 0;
            soma += valoresPagamento[tipo];
        }
    });
    
    document.getElementById('display-total').innerText = soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function resetarModal() {
    document.getElementById('inputs-valores').innerHTML = '';
    document.querySelectorAll('#opcoes-pagamento input').forEach(c => c.checked = false);
    document.getElementById('display-total').innerText = 'R$ 0,00';
    valoresPagamento = { dinheiro: 0, pix: 0, credito: 0, debito: 0 };
}

function solicitarAssinatura(planoId, barbeiroUid, valor, nomePlano, periodo) {
    const check = document.getElementById(`check_agree_${planoId}`);
    
    // Função auxiliar para camadas
    const garantirTopoSupremo = (idModalAlvo) => {
        const modalAlvo = document.getElementById(idModalAlvo);
        if (!modalAlvo) return;
        let maiorZ = 0;
        document.querySelectorAll('body *').forEach(el => {
            const z = parseInt(window.getComputedStyle(el).zIndex);
            if (!isNaN(z) && z > maiorZ) maiorZ = z;
        });
        modalAlvo.style.setProperty('z-index', (maiorZ + 100).toString(), 'important');
    };

    if (!check.checked) {
        exibirPopup("Atenção", "Você precisa concordar com as regras para continuar.", "aviso");
        setTimeout(() => garantirTopoSupremo('modalPopupGenerico'), 50);
        return;
    }

    // --- MUDANÇA: REMOVIDA A VERIFICAÇÃO DE SALDO ---
    // O app agora entende que o pagamento é externo.

    // 1. Configura o popup de confirmação com texto correto
    exibirConfirmacao(
        "Solicitar Assinatura", 
        `Deseja solicitar o plano <b>"${nomePlano}"</b>?<br><br>
        valor: <b style="color:#2ecc71">R$ ${valor.toFixed(2)}</b><br>
        <small style="color:#f1c40f">ℹ️ O pagamento deverá ser feito diretamente ao profissional/estabelecimento.</small>`,
        async () => {
            
            const aguarde = document.getElementById('popupAguarde');
            if(aguarde) aguarde.style.setProperty('z-index', '2147483647', 'important');
            
            exibirAguarde("Enviando solicitação...");
            
            try {
                // Cria a solicitação
                await db.collection('solicitacoes').add({
                    tipo: 'assinatura_plano',
                    clienteUid: auth.currentUser.uid,
                    clienteNome: perfil.nome,
                    clienteTelefone: perfil.telefone || '',
                    profissionalUid: barbeiroUid,
                    planoId: planoId,
                    nomePlano: nomePlano,
                    valor: valor, // Valor apenas para registro/métrica
                    periodo: periodo,
                    status: 'pendente',
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });

                notifyUser(barbeiroUid, "💎 Nova Solicitação de Plano!", `${perfil.nome} quer assinar o plano ${nomePlano}.`, { link: '#solicitacoes' });

                fecharTodosOsModais();
                
                exibirPopup("Solicitação Enviada!", "Combine o pagamento presencialmente com o profissional para ativar seu plano.", "sucesso");
                setTimeout(() => garantirTopoSupremo('modalPopupGenerico'), 50);

            } catch (e) {
                fecharTodosOsModais();
                exibirPopup("Erro", "Falha ao enviar: " + e.message);
                setTimeout(() => garantirTopoSupremo('modalPopupGenerico'), 50);
            }
        }
    );

    setTimeout(() => {
        garantirTopoSupremo('modalConfirmacaoGenerica');
    }, 50);
}

async function aprovarAssinatura(solicitacaoId, s) {
    // s = dados da solicitação (vindos do parâmetro da função verDetalhesSolicitacao)
    
    exibirAguarde("Ativando plano e calculando métricas...");

    try {
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(s.clienteUid);
            const profRef = db.collection("usuarios").doc(s.profissionalUid);
            const solicitacaoRef = db.collection("solicitacoes").doc(solicitacaoId);
            
            const profDoc = await t.get(profRef);
            if (!profDoc.exists) throw "Profissional não encontrado.";
            const profData = profDoc.data();

            // 1. Busca detalhes do Plano (para pegar os serviços inclusos)
            // Precisamos procurar no array de planos do profissional
            const planosConfig = profData.planosConfig || [];
            const planoOriginal = planosConfig.find(p => p.id === s.planoId);
            
            // Fallback se o plano tiver sido deletado, usa string vazia
            const servicosInclusos = planoOriginal ? planoOriginal.servicosInclusos : [];

            // 2. Calcula a Comissão (MÉTRICA)
            let comissaoPorcentagem = 100; // Se for dono/autônomo, ganha 100% da métrica
            let valorParaProfissional = s.valor;
            let isFuncionario = false;

            // Verifica se o profissional pertence a uma barbearia (e não é o dono dela)
            if (profData.pertenceABarbearia && profData.pertenceABarbearia.uid && profData.pertenceABarbearia.uid !== s.profissionalUid) {
                isFuncionario = true;
                const donoUid = profData.pertenceABarbearia.uid;
                
                // Busca o Dono para ver a % exata deste funcionário
                const donoRef = db.collection('usuarios').doc(donoUid);
                const donoDoc = await t.get(donoRef);
                
                if (donoDoc.exists) {
                    const equipe = donoDoc.data().equipe || [];
                    const membro = equipe.find(m => m.uid === s.profissionalUid || m === s.profissionalUid);
                    
                    if (membro && typeof membro === 'object' && membro.comissao !== undefined) {
                        comissaoPorcentagem = membro.comissao;
                    } else {
                        comissaoPorcentagem = 50; // Padrão se não achar
                    }
                }
                
                // Aplica a %
                valorParaProfissional = s.valor * (comissaoPorcentagem / 100);
            }

            // 3. Atualiza o Profissional (MÉTRICAS APENAS)
            // Incrementa o faturamento histórico e o pendente (se for funcionário)
            const updatesProf = {
                faturamentoTotalHistorico: firebase.firestore.FieldValue.increment(valorParaProfissional)
            };
            
            if (isFuncionario) {
                // Se é funcionário, o dono recebeu o dinheiro (presumivelmente), então entra como pendente pro funcionário receber
                updatesProf.faturamentoPendente = firebase.firestore.FieldValue.increment(valorParaProfissional);
            }
            
            t.update(profRef, updatesProf);

            // 4. Ativa o Plano no Cliente
            // Calcula validade
            const agora = new Date();
            let dataValidade = new Date();
            if (s.periodo === 'semanal') dataValidade.setDate(agora.getDate() + 7);
            else if (s.periodo === 'anual') dataValidade.setFullYear(agora.getFullYear() + 1);
            else dataValidade.setDate(agora.getDate() + 30); // Mensal (padrão)

            const novaAssinatura = {
                planoId: s.planoId,
                nomePlano: s.nomePlano,
                profissionalUid: s.profissionalUid,
                profissionalNome: profData.nome,
                valorPago: s.valor,
                dataInicio: firebase.firestore.Timestamp.fromDate(agora),
                validade: firebase.firestore.Timestamp.fromDate(dataValidade),
                servicosInclusos: servicosInclusos,
                status: 'ativa'
            };

            // Remove assinaturas antigas desse mesmo profissional para não acumular lixo
            // (Lógica simples: arrayUnion adiciona. Para substituir idealmente teríamos que ler e filtrar, 
            // mas arrayUnion é seguro para adicionar. Na leitura filtramos pela validade).
            t.update(clienteRef, {
                assinaturasAtivas: firebase.firestore.FieldValue.arrayUnion(novaAssinatura)
            });

            // 5. Finaliza a solicitação
            t.update(solicitacaoRef, { status: 'aprovado' });
            
            // 6. Registro no Extrato Financeiro (Apenas para gráficos do Dono)
            if (isFuncionario) {
                // O dono recebe o valor cheio no gráfico
                const extratoRef = db.collection('extrato_financeiro').doc();
                t.set(extratoRef, {
                    donoUid: profData.pertenceABarbearia.uid,
                    usuarioUid: s.profissionalUid, // Quem vendeu
                    tipo: "receita_servico", // Usamos o mesmo tipo para aparecer no gráfico verde
                    descricao: `Venda Plano: ${s.nomePlano}`,
                    valor: s.valor, // Valor Cheio no gráfico do dono
                    dataEvento: firebase.firestore.Timestamp.now(),
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Autônomo
                const extratoRef = db.collection('extrato_financeiro').doc();
                t.set(extratoRef, {
                    donoUid: s.profissionalUid,
                    usuarioUid: s.profissionalUid,
                    tipo: "receita_servico",
                    tipo_secundario: "ganho_pessoal",
                    descricao: `Venda Plano: ${s.nomePlano}`,
                    valor: s.valor,
                    dataEvento: firebase.firestore.Timestamp.now(),
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

        });

        fecharTodosOsModais();
        exibirPopup("Sucesso", "Plano ativado! As métricas de desempenho foram atualizadas.");
        notifyUser(s.clienteUid, "💎 Plano Ativado!", `Seu plano "${s.nomePlano}" está ativo e válido até o próximo vencimento.`, {link: '#perfil'});

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao aprovar: " + e.message);
    }
}

function selecionarServico(element, servico) {
    // Limpa seleção anterior visual
    document.querySelectorAll('#barbeiroPerfilServicosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    
    // Reseta estado
    agendamentoState.servico = servico;
    agendamentoState.isPeloPlano = false; // Flag nova padrão false
    
    // VERIFICAÇÃO DE PLANO (A MÁGICA)
    const btnAgendar = document.getElementById('btnConfirmarAgendamento');
    const barbeiroUid = agendamentoState.barbeiroUid;

    // Busca nas assinaturas ativas do cliente
    const planoAtivo = (perfil.assinaturasAtivas || []).find(a => {
        // Converte data para verificar validade
        let dataValidade = new Date();
        if(a.validade && a.validade.seconds) dataValidade = new Date(a.validade.seconds * 1000);
        else if(a.validade && a.validade.toDate) dataValidade = a.validade.toDate();

        return a.profissionalUid === barbeiroUid && 
               a.status === 'ativa' && 
               a.servicosInclusos.includes(servico.nome) && // O serviço tem que estar no plano
               dataValidade > new Date(); // E não pode estar vencido
    });

    if (planoAtivo) {
        // MODO PLANO ATIVADO
        btnAgendar.innerHTML = `💎 AGENDAR PELO PLANO (${planoAtivo.nomePlano})`;
        btnAgendar.className = 'btn-agendar-plano'; // Classe CSS dourada
        
        // Marca flags no estado para usar na hora de salvar
        agendamentoState.isPeloPlano = true;
        agendamentoState.planoId = planoAtivo.planoId;
        
        console.log("Serviço coberto pelo plano:", planoAtivo.nomePlano);
    } else {
        // MODO NORMAL
        btnAgendar.innerHTML = '🗓️ Agendar';
        btnAgendar.className = ''; // Remove classe especial
        btnAgendar.style.background = ''; // Reseta estilo inline se houver
    }

    verificarEstadoBotaoAgendar();
}

function executarAgendamentoNoBanco(valorFinalCliente, valorOriginalServico) {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    const barbeiroTelefone = agendamentoState.barbeiroTelefone;
    
    // CORREÇÃO DE DONO UID (Recupera do estado salvo ao abrir o perfil ou define agora)
    let donoUid = agendamentoState.donoUid || barbeiroUid;

    exibirAguarde("Processando...");
    
    const isImediato = (horario === 'imediato');
    
    // FLUXO: Se for imediato, status 'imediato'. Se for programado, status 'confirmado' DIRETO.
    const statusInicial = isImediato ? 'imediato' : 'confirmado';
    const dataConfirmacao = isImediato ? null : firebase.firestore.FieldValue.serverTimestamp();

    const agendamentoData = {
        clienteUid: auth.currentUser.uid, 
        clienteNome: perfil.nome, 
        clienteTelefone: perfil.telefone || '', 
        barbeiroUid, 
        barbeiroNome, 
        servico: servico.nome, 
        valor: valorFinalCliente,          
        valorOriginal: valorOriginalServico, 
        descontoVipAplicado: false, 
        donoUid: donoUid, // USA O ID DO DONO CORRETO
        status: statusInicial,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        confirmadoEm: dataConfirmacao, // Data de confirmação para Programados
        avaliado: false, 
        clienteNotificado: false, 
        lembreteConcluirEnviado: false, 
        avisoAvaliacaoEnviado: false,
        lembrete1hEnviado: false,    
        lembrete10minEnviado: false  
    };

    if (!isImediato) agendamentoData.horario = horario;

    db.collection("agendamentos").add(agendamentoData).then((docRef) => {
        fecharTodosOsModais();

        if (isImediato) {
            // === CENÁRIO VAGA IMEDIATA (ALARME 10X PARA TODOS) ===
            criarAviso(barbeiroUid, `🔔 Vaga Imediata: ${perfil.nome} solicitou!`, 'novo-agendamento', docRef.id);
            if (donoUid !== barbeiroUid) {
                 notifyUser(donoUid, "⚡ Vaga Imediata!", `${perfil.nome} solicitou para ${barbeiroNome}.`);
            }
            exibirPopup("Solicitação Enviada!", "Aguardando aprovação da equipe (alarme ativado).");
            
        } else {
            // === CENÁRIO AGENDA PROGRAMADA (AUTO APROVADO - AVISO SIMPLES) ===
            criarAviso(barbeiroUid, `🗓️ Novo Agendamento Confirmado: ${perfil.nome} às ${horario}.`, 'agendamento-auto', docRef.id);
            
            // Notificação informativa (sem alarme 10x) para Profissional e Equipe
            notifyUser(barbeiroUid, "📅 Agenda Nova!", `Agendamento: ${perfil.nome} com ${barbeiroNome} às ${horario}.`);
            if (donoUid !== barbeiroUid) notifyUser(donoUid, "📅 Agenda Nova na Equipe!", `${perfil.nome} marcou com ${barbeiroNome} às ${horario}.`);

            // Sucesso para o cliente
            exibirPopup("✅ Agendamento Confirmado!", `Seu horário das ${horario} está garantido!\nProfissional: ${barbeiroNome}\n\nNão se atrase!`, 'sucesso');
        }

    }).catch(e => {
        fecharTodosOsModais();
        exibirPopup("Erro ao agendar: " + e.message, 'erro');
    });
}

// Função auxiliar para ver avaliações (ATUALIZADA COM FOTO)
function verAvaliacoesPublicas(uid) {
    // Reutiliza o modal de avaliações
    abrirModal('modalAvaliacoes');
    const lista = document.getElementById("listaAvaliacoesModal");
    lista.innerHTML = "<p>⏳ Carregando avaliações...</p>";
    
    db.collection("avaliacoes")
        .where("barbeiroUid", "==", uid)
        .orderBy("ts", "desc")
        .limit(20)
        .get()
        .then(snap => {
            lista.innerHTML = snap.empty ? "<p>Nenhuma avaliação encontrada.</p>" : "";
            
            snap.forEach(doc => {
                const a = doc.data();
                const dataStr = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString() : '';
                
                // --- EXIBE FOTO SE HOUVER ---
                let fotoHtml = '';
                if (a.fotoUrl) {
                    fotoHtml = `<img src="${a.fotoUrl}" style="width:100%; height:150px; object-fit:cover; border-radius:8px; margin-top:10px; border:1px solid #444; cursor:pointer;" onclick="window.open(this.src)">`;
                }

                lista.innerHTML += `
                    <div class="card" style="margin-bottom:10px; background: #222;">
                        <div style="display:flex; justify-content:space-between;">
                            <b style="color:var(--cor-destaque)">Nota: ${a.nota}/10 ⭐
                            <small>${dataStr}</small>
                        </div>
                        <p style="margin-top:5px; font-style:italic;">"${a.comentario}"</p>
                        ${fotoHtml}
                    </div>`;
            });
        });
}

// Função auxiliar que transforma o aviso na confirmação final
function mostrarDetalhesFinaisNoMesmoPopup(valorFinal, valorOriginal) {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
    const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
    const tituloEl = document.getElementById('confirmacaoGenericaTitulo');
    const msgEl = document.getElementById('confirmacaoGenericaMensagem');

    // 1. Atualiza os Textos para a Confirmação Final
    tituloEl.textContent = "Confirmar Agendamento?";
    tituloEl.style.color = "var(--cor-destaque)"; // Volta cor padrão
    
    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o horário das ${horario}`;
    const isVip = isVipAtivo(perfil);
    const textoVip = isVip ? `<br><br><b style="color:#00c6ff">💎 VIP Ativo: Cashback garantido!</b>` : '';

    msgEl.innerHTML = `<div style="text-align:center;">
        Profissional: <b>${barbeiroNome}</b><br>
        Serviço: <b>${servico.nome}</b><br>
        Horário: <b>${horarioTexto}</b><br>
        Valor: <b style="font-size:18px; color:#2ecc71;">R$ ${valorFinal.toFixed(2)}</b>
        ${textoVip}
    </div>`;

    // 2. Restaura os botões normais (Cancelar e Confirmar)
    btnNao.style.display = 'block'; // Mostra o botão cancelar de volta
    btnNao.textContent = "Cancelar";
    btnNao.onclick = () => fecharModalAtual();

    btnSim.textContent = "Sim, Confirmar";
    btnSim.style.width = ""; // Tira largura 100%
    btnSim.style.background = ""; // Volta cor padrão (ou definida no CSS)
    
    // 3. Define a ação final: SALVAR NO BANCO
    btnSim.onclick = () => {
        executarAgendamentoNoBanco(valorFinal, valorOriginal);
    };
}

function abrirModalVagaAprovada(agendamentoId) {
    const modal = document.getElementById('modalVagaImediataAprovada');
    
    // 1. Limpa timers antigos para não acumular
    limparTodosTimersMapa();

    // Configura o botão "Entendi"
    const btnEntendi = modal.querySelector('button[data-modal-id="modalVagaImediataAprovada"]');
    const novoBtnEntendi = btnEntendi.cloneNode(true);
    btnEntendi.parentNode.replaceChild(novoBtnEntendi, btnEntendi);
    
    novoBtnEntendi.onclick = () => {
        limparTodosTimersMapa(); // Cancela verificações futuras
        confirmarVagaImediataEAbriMapa(agendamentoId);
    };
    
    // Configura o botão Cancelar
    const btnCancelar = document.getElementById('btnCancelarVagaAprovada');
    const novoBtnCancelar = btnCancelar.cloneNode(true);
    btnCancelar.parentNode.replaceChild(novoBtnCancelar, btnCancelar);
    
    novoBtnCancelar.onclick = () => {
        limparTodosTimersMapa(); // CANCELA TUDO IMEDIATAMENTE
        cancelarAgendamentoAposAprovacao(agendamentoId);
    };
    
    // Abre o modal
    abrirModal('modalVagaImediataAprovada');

    console.log("⏳ Iniciando tripla verificação de abertura de mapa (8s, 10s, 13s)...");

    // Função interna que verifica se precisa abrir
    const forcarAberturaSeFechado = (tempo) => {
        const modalMapa = document.getElementById('modalRastreamento');
        const modalAviso = document.getElementById('modalVagaImediataAprovada');
        
        // Se o mapa NÃO está visível E o aviso AINDA está visível (não cancelou)
        if (!modalMapa.classList.contains('show') && modalAviso.classList.contains('show')) {
            console.log(`⏰ Verificação de ${tempo}s: Mapa fechado. Forçando abertura...`);
            confirmarVagaImediataEAbriMapa(agendamentoId);
        } else {
            console.log(`✅ Verificação de ${tempo}s: Mapa já está aberto ou serviço cancelado.`);
        }
    };

    // --- AGENDA AS 3 VERIFICAÇÕES ---
    
    // 1. Verificação aos 8 segundos
    autoMapTimers.push(setTimeout(() => forcarAberturaSeFechado(8), 8000));

    // 2. Verificação aos 10 segundos
    autoMapTimers.push(setTimeout(() => forcarAberturaSeFechado(10), 10000));

    // 3. Verificação aos 13 segundos (Segurança Final)
    autoMapTimers.push(setTimeout(() => forcarAberturaSeFechado(13), 13000));
}

function limparTodosTimersMapa() {
    // Percorre a lista e cancela todos os relógios pendentes
    autoMapTimers.forEach(timer => clearTimeout(timer));
    autoMapTimers = [];
    console.log("🛑 Verificações automáticas de mapa canceladas/limpas.");
}

// Nova função chamada ao clicar em "Entendi"
async function confirmarVagaImediataEAbriMapa(agendamentoId) {
    // MATA AS VERIFICAÇÕES RESTANTES (Pois já vamos abrir agora)
    limparTodosTimersMapa();

    exibirAguarde("Carregando rota...");
    
    try {
        const doc = await db.collection('agendamentos').doc(agendamentoId).get();
        if (!doc.exists) throw new Error("Agendamento não encontrado.");
        
        const ag = doc.data();
        
        // Marca notificado
        await db.collection('agendamentos').doc(agendamentoId).update({ clienteNotificado: true });
        
        // Fecha os modais (incluindo o vermelho de aviso)
        fecharTodosOsModais();
        
        // Abre o Mapa
        if (ag.barbeiroLat && ag.barbeiroLon) {
            iniciarRastreamento(ag.barbeiroUid, ag.barbeiroLat, ag.barbeiroLon, 'cliente', agendamentoId);
        } else {
            exibirPopup("Erro", "Localização do profissional não disponível.");
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

async function cancelarAgendamentoAposAprovacao(agendamentoId) {
    // 1. MATA TODAS AS 3 VERIFICAÇÕES
    limparTodosTimersMapa();

    if (!confirm("Tem certeza que deseja cancelar? O valor será reembolsado.")) return;
    
    exibirAguarde("Cancelando...");
    
    // Para o efeito chiclete do mapa
    pararChicleteDefinitivo();

    try {
        const agendamentoDoc = await db.collection("agendamentos").doc(agendamentoId).get();
        if (!agendamentoDoc.exists) throw new Error("Agendamento não encontrado.");
        
        const { valor, barbeiroUid, clienteUid } = agendamentoDoc.data();
        
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(clienteUid);
            const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
            
            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
            t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-(valor * (1 - TAXA))) });
            
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            if (!adminSnap.empty) {
                t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-(valor * TAXA)) });
            }
            
            t.update(agendamentoRef, { status: "cancelado" });
        });

        criarAviso(barbeiroUid, `❌ O cliente ${perfil.nome} cancelou a vaga imediata. O valor foi estornado.`);
        notifyUser(barbeiroUid, "❌ Agendamento Cancelado", `${perfil.nome} cancelou a vaga imediata.`);
        
        fecharTodosOsModais();
        exibirPopup("Agendamento cancelado e valor reembolsado com sucesso.");
        
        // Fecha o modal vermelho se ainda estiver aberto
        const modalVaga = document.getElementById('modalVagaImediataAprovada');
        if(modalVaga) {
            modalVaga.classList.remove('show');
            modalVaga.style.display = 'none';
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao cancelar agendamento: " + e.message);
    }
}

function abrirHistoricoCliente() {
  abrirModal('modalHistoricoCliente');
  const painelHistorico = document.getElementById("painelHistorico");
  painelHistorico.innerHTML = "<div style='text-align:center; margin-top:20px;'><div class='spinner'></div><p>Carregando histórico...</p></div>";
  
  db.collection("agendamentos")
    .where("clienteUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado", "conclusão pendente", "confirmado"]) 
    .orderBy("ts", "desc")
    .limit(20)
    .onSnapshot(snap => {
      painelHistorico.innerHTML = "";
      
      if(snap.empty) {
          painelHistorico.innerHTML = "<p style='text-align:center; opacity:0.7;'>Nenhum histórico recente.</p>";
          return;
      }
      
      snap.forEach(doc => {
        const a = doc.data();
        const docId = doc.id; // ID do Agendamento
        let statusTexto = "";
        let corStatus = "#fff";
        let botoes = "";

        if (a.status === "concluido") {
            statusTexto = "✅ Concluído";
            corStatus = "#2ecc71";
            botoes = (a.avaliado === false) 
                ? `<button onclick="abrirModalAvaliacao('${docId}', '${a.barbeiroUid}')" style="width:100%; margin-top:10px;">⭐ Avaliar Profissional</button>` 
                : `<p style="text-align:center; font-size:12px; color:#aaa; margin-top:5px;">✅ Você já avaliou este serviço.</p>`;
        
        } else if (a.status === "cancelado") {
            statusTexto = "❌ Cancelado";
            corStatus = "#e74c3c";
        
        } else if (a.status === "conclusão pendente" || a.status === "confirmado") {
            statusTexto = "🏃 Em Andamento / Aprovado";
            corStatus = "#00c6ff";
            
            // CORREÇÃO AQUI: Passamos docId corretamente nas duas opções
            if (a.barbeiroLat && a.barbeiroLon) {
                // Se já tem coordenadas salvas, chama direto (passando docId no final)
                botoes = `<button onclick="iniciarRastreamento('${a.barbeiroUid}', ${a.barbeiroLat}, ${a.barbeiroLon}, 'cliente', '${docId}')" style="background: linear-gradient(45deg, #00c6ff, #0072ff); width:100%; margin-top:10px; border:1px solid #fff; box-shadow:0 0 10px #00c6ff;">🗺️ Ver Rota (Reabrir Mapa)</button>`;
            } else {
                // Se precisa buscar, passa docId para a busca
                botoes = `<button onclick="iniciarRastreamentoBusca('${a.barbeiroUid}', '${a.barbeiroNome}', '${docId}')" style="background: linear-gradient(45deg, #00c6ff, #0072ff); width:100%; margin-top:10px; border:1px solid #fff; box-shadow:0 0 10px #00c6ff;">🗺️ Ver Rota (Reabrir Mapa)</button>`;
            }
        }

        painelHistorico.innerHTML += `
            <div class="card" style="border-left: 4px solid ${corStatus};">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${a.servico}
                    <span style="color:${corStatus}; font-size:12px; font-weight:bold;">${statusTexto}</span>
                </div>
                <p style="margin:5px 0;">Profissional: ${a.barbeiroNome}</p>
                <p style="margin:0;">Valor: R$ ${a.valor.toFixed(2)}</p>
                ${botoes}
            </div>`;
      });
    });
}

function soltarFaiscasDeLuxo() {
    if (typeof confetti === 'undefined') return;

    const duracao = 1000; // Tempo total das faíscas subindo
    const finalDaAnimacao = Date.now() + duracao;

    // Função interna para criar o fluxo ascendente
    (function frame() {
        // Dispara pequenas partículas de pontos aleatórios no fundo da tela
        confetti({
            particleCount: 3,
            angle: 90,        // Direção: para cima
            spread: 100,      // Espalha um pouco na largura
            origin: { x: Math.random(), y: 1.1 }, // Começa um pouco abaixo do rodapé
            colors: ['#FFD700', '#fcf6ba', '#aa771c'], // Tons de ouro
            ticks: 300,       // Quanto tempo a partícula vive (o suficiente para subir a tela)
            gravity: -0.4,    // GRAVIDADE NEGATIVA: Faz as faíscas subirem!
            scalar: 0.1,      // Tamanho bem pequeno e discreto
            drift: Math.random() - 0.5, // Movimento lateral aleatório (fluidez)
            velocity: 15,     // Velocidade inicial de subida
            zIndex: 999999
        });

        // Continua disparando enquanto o tempo não acabar
        if (Date.now() < finalDaAnimacao) {
            requestAnimationFrame(frame);
        }
    }());
}

// --- FUNÇÃO AUXILIAR PARA GERAR BOTÕES COM BLOQUEIO DE TIER (CORRIGIDA) ---
function gerarBotaoPro(label, onclickOriginal, tierNecessario, perfilUsuario) {
    const niveis = { 'tier1': 1, 'tier2': 2, 'tier3': 3, 'tier4': 4 };
    const nivelUsuario = (perfilUsuario.proAtivo && perfilUsuario.proTier) ? niveis[perfilUsuario.proTier] : 0;
    const nivelReq = niveis[tierNecessario] || 0;
    const nomesTier = { 'tier1': 'Bronze', 'tier2': 'Prata', 'tier3': 'Ouro', 'tier4': 'Diamante' };

    // Se tiver o nível ou for Admin, libera o botão normal
    if (nivelUsuario >= nivelReq || perfilUsuario.tipo === 'admin') {
        return `<button onclick="${onclickOriginal}" style="width:45%; position:relative;">${label}</button>`;
    } else {
        // Se estiver bloqueado, chama a nova função limpa
        const cor = varCorPorTier(tierNecessario);
        const nomeTier = nomesTier[tierNecessario];
        
        return `<button onclick="cliqueBloqueado('${tierNecessario}')" 
                style="width:45%; background: #222; color: #888; border: 1px solid #444; position:relative; opacity:0.8;">
                🔒 ${label} <br><span style="font-size:9px; color:${cor}; font-weight:bold;">Requer ${nomeTier}</span>
                </button>`;
    }
}

function varCorPorTier(tier) {
    if(tier === 'tier1') return '#cd7f32'; // Bronze
    if(tier === 'tier2') return '#c0c0c0'; // Prata
    if(tier === 'tier3') return '#ffd700'; // Ouro
    if(tier === 'tier4') return '#00c6ff'; // Diamante
    return '#fff';
}

function abrirModalAvaliacao(agendamentoId, barbeiroUid) {
  // Guarda os IDs para a função de salvar
  avaliacaoAgendamentoId = agendamentoId;
  avaliacaoBarbeiroUid = barbeiroUid;

  // Limpa os campos do modal
  document.getElementById('inputAvaliacaoNota').value = '';
  document.getElementById('inputAvaliacaoComentario').value = '';
  document.getElementById('inputAvaliacaoFotoFile').value = ''; // Limpa o input de arquivo
  document.getElementById('avaliacaoUploadProgress').style.display = 'none'; // Esconde a barra
  
  soltarFaiscasDeLuxo();
  abrirModal('modalAvaliacaoCliente');
}

async function executarAvaliacaoCliente() {
  const nota = parseInt(document.getElementById('inputAvaliacaoNota').value);
  const comentario = document.getElementById('inputAvaliacaoComentario').value.trim();
  const fileInput = document.getElementById('inputAvaliacaoFotoFile');
  let fotoUrl = null;

  if (isNaN(nota) || nota < 1 || nota > 10) {
      return exibirPopup("Avaliação inválida.", "Use um número de 1 a 10.");
  }
  
  // Fecha o modal atual mas mantém o overlay se precisar
  // fecharModalAtual(); 
  // Mostra aguarde (o botão ficará desativado pelo overlay do aguarde)
  exibirAguarde("Processando avaliação...");

  try {
      // Lógica de Upload de Imagem (se houver arquivo)
      if (fileInput.files && fileInput.files.length > 0) {
          const progressBar = document.getElementById('avaliacaoUploadProgress');
          progressBar.style.display = 'block';
          document.getElementById('popupAguardeTexto').textContent = "Enviando foto..."; // Atualiza texto do aguarde

          const file = fileInput.files[0];
          // Caminho: avaliacoes/UID_DO_USUARIO/TIMESTAMP_NOME
          const filePath = `avaliacoes/${auth.currentUser.uid}/${Date.now()}_${file.name}`;
          
          // Usa a sua função auxiliar uploadImage que já existe no código
          fotoUrl = await uploadImage(file, filePath, (progress) => {
              progressBar.value = progress;
          });
      }

      // Chama a função de avaliar serviço passando a URL (se houver) ou null
      document.getElementById('popupAguardeTexto').textContent = "Finalizando...";
      await avaliarServico(avaliacaoAgendamentoId, avaliacaoBarbeiroUid, nota, comentario, fotoUrl);
      
      // Limpa as variáveis globais
      avaliacaoAgendamentoId = null;
      avaliacaoBarbeiroUid = null;

      fecharTodosOsModais(); // Fecha tudo no final

  } catch (error) {
      fecharTodosOsModais();
      console.error("Erro na avaliação:", error);
      exibirPopup("Erro", "Falha ao enviar avaliação: " + (error.message || error));
  }
}

async function avaliarServico(agendamentoId, barbeiroUid, nota, comentario, fotoUrl = null) {
  const reputacaoGanho = nota >= 7 ? 10 : (nota <= 4 ? -10 : 0);
  
  db.runTransaction(async t => {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
    const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
    
    const [agendamentoDoc, barbeiroDoc] = await Promise.all([
        t.get(agendamentoRef),
        t.get(barbeiroRef) 
    ]);
    
    if (!barbeiroDoc.exists) throw "Profissional não encontrado.";
    if (agendamentoDoc.data().avaliado) throw "Já avaliado.";
    
    const barbeiroData = barbeiroDoc.data();
    const valor = agendamentoDoc.data().valor;
    const pontosGanhos = Math.floor(valor / 10) * (isVipAtivo(perfil) ? 2 : 1);
    
    t.update(agendamentoRef, { avaliado: true });

    const barbeiroUpdates = {
        reputacao: firebase.firestore.FieldValue.increment(reputacaoGanho),
        somaAvaliacoes: firebase.firestore.FieldValue.increment(nota),
        numAvaliacoes: firebase.firestore.FieldValue.increment(1)
    };

    if (fotoUrl) {
        const portfolioAtual = barbeiroData.portfolio || [];
        if (portfolioAtual.length < 30) {
            barbeiroUpdates.portfolio = firebase.firestore.FieldValue.arrayUnion(fotoUrl);
        }
    }
    
    t.update(barbeiroRef, barbeiroUpdates); 

    t.set(db.collection("avaliacoes").doc(), {
      barbeiroUid, clienteUid: auth.currentUser.uid, nota,
      comentario: comentario || "Sem comentário",
      fotoUrl: fotoUrl,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    if (pontosGanhos > 0) {
        t.update(clienteRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(pontosGanhos) });
    }
    return pontosGanhos;

  }).then((pontosGanhos) => {
    exibirPopup(`Avaliação enviada com sucesso! Você ganhou ${pontosGanhos} King Points.`);
    criarAviso(barbeiroUid, `⭐ Você recebeu uma nova avaliação de ${perfil.nome}.`);
    notifyUser(barbeiroUid, "⭐ Nova Avaliação!", `${perfil.nome} deixou uma avaliação de nota ${nota} para você.`, { link: '#avaliacoes' });
    
    // --- AUTOMAÇÃO: Se tiver foto, verifica se o BARBEIRO é Diamante e manda pro Em Alta ---
    if (fotoUrl) {
        // Passamos null no nome, a função busca o nome do barbeiro no banco
        sincronizarComEmAlta(fotoUrl, barbeiroUid, null);
    }

  }).catch(e => {
    console.error("Erro detalhado ao avaliar:", e); 
    exibirPopup("Erro ao avaliar: " + e); 
  });
}

function resgatarPontos() {
    const PONTOS_NECESSARIOS = 100;
    const VALOR_REAIS = 5.00;

    if ((perfil.pontosFidelidade || 0) < PONTOS_NECESSARIOS) {
        return exibirPopup("Pontos Insuficientes", `Você precisa de ${PONTOS_NECESSARIOS} pontos para resgatar.`);
    }

    const servicosConcluidos = (perfil.cortesRealizados || perfil.clientesAtendidos || 0);
    const resgatesFeitos = (perfil.totalResgates || 0);

    if (resgatesFeitos >= servicosConcluidos) {
        return exibirPopup("Resgate Bloqueado 🔒", "Conclua mais um agendamento para liberar um novo resgate!");
    }

    if (!confirm(`Deseja trocar ${PONTOS_NECESSARIOS} pontos por R$ ${VALOR_REAIS.toFixed(2)} em BÔNUS?`)) return;

    exibirAguarde("Processando resgate...");

    db.runTransaction(async t => {
        const ref = db.collection("usuarios").doc(auth.currentUser.uid);
        const doc = await t.get(ref);
        const data = doc.data();

        if ((data.pontosFidelidade || 0) < PONTOS_NECESSARIOS) throw "Pontos insuficientes.";
        if ((data.totalResgates || 0) >= (data.cortesRealizados || data.clientesAtendidos || 0)) throw "Bloqueado.";

        // --- MUDANÇA: Incrementa saldoBonus ---
        t.update(ref, {
            pontosFidelidade: firebase.firestore.FieldValue.increment(-PONTOS_NECESSARIOS),
            saldoBonus: firebase.firestore.FieldValue.increment(VALOR_REAIS), // Vai para Bônus!
            totalResgates: firebase.firestore.FieldValue.increment(1)
        });

    }).then(() => {
        fecharTodosOsModais();
        exibirPopup("Sucesso!", `🎉 Resgate realizado! R$ ${VALOR_REAIS.toFixed(2)} adicionados ao seu SALDO BÔNUS.`);
    }).catch(e => {
        fecharTodosOsModais();
        exibirPopup("Erro", e.message || e);
    });
}

// --- FUNÇÃO DO POPUP VIP (CLIENTE) CORRIGIDA ---
function abrirModalVip() {
    const container = document.getElementById('vipContentContainer');
    
    // Verifica se é VIP
    if (isVipAtivo(perfil)) {
        // --- VISÃO: JÁ É VIP ---
        let dataFormatada = "Indefinido";
        if (perfil.vipExpirationDate) {
             try {
                 const dateObj = typeof perfil.vipExpirationDate.toDate === 'function' 
                    ? perfil.vipExpirationDate.toDate() 
                    : new Date(perfil.vipExpirationDate);
                 dataFormatada = dateObj.toLocaleDateString('pt-BR');
             } catch (e) { console.log(e); }
        }

        container.innerHTML = `
            <div class="vip-glow" style="padding: 20px; border-radius: 15px; text-align: center; background: linear-gradient(135deg, #1a0b00, #2a1a0a); border: 1px solid #d4af37;">
                <h3 style="color: var(--cor-destaque); text-shadow: 0 0 10px #d4af37;">👑 Você é um Membro VIP!</h3>
                <p style="color: #ccc;">Sua assinatura é válida até: <strong style="color: #fff;">${dataFormatada}</strong>.</p>
                
                <div class="vantagens" style="text-align: left; margin-top: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    <h4 style="margin-top:0; color: #d4af37;">Seus Benefícios Ativos:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;">💰 <strong>10% de Cashback</strong> em todos os serviços (Moeda Digital).</li>
                        <li style="margin-bottom: 8px;">🏆 <strong>Dobro de Pontos</strong> de fidelidade.</li>
                        <li style="margin-bottom: 8px;">💬 <strong>Ícone de Coroa</strong> e destaque no chat.</li>
                        <li style="margin-bottom: 8px;">🎰 <strong>4 Giros Diários</strong> na Roleta!</li> 
                        <li>🚫 <strong>Isenção Total</strong> de taxas na Loja.</li>
                    </ul>
                </div>
                <button disabled style="margin-top: 15px; background: #333; color: #aaa; border: 1px solid #555; cursor: default;">✅ Assinatura Ativa</button>
            </div>
        `;
    } else {
        // --- VISÃO: NÃO É VIP (OFERTA) ---
        container.innerHTML = `
            <div style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque); font-size: 22px;">💎 Torne-se um Membro VIP!</h3>
                <p style="color: #ccc; font-size: 13px;">A experiência suprema para clientes.</p>
                
                <div style="margin: 20px 0; background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--cor-destaque);">
                    <p style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin: 0;">Investimento</p>
                    <p style="font-size: 28px; font-weight: 800; margin: 5px 0; color: #fff;">R$ ${PRECO_VIP.toFixed(2)} <span style="font-size: 14px; font-weight: normal;">/ mês</span></p>
                </div>

                <div class="vantagens" style="text-align: left; margin-top: 10px;">
                    <h4 style="color: #fff;">Vantagens Exclusivas:</h4>
                    <ul style="list-style: none; padding: 0; color: #ddd;">
                        <li style="margin-bottom: 8px;">💰 <strong>10% de Cashback</strong>: Receba moedas de volta em todo serviço!</li>
                        <li style="margin-bottom: 8px;">🏆 <strong>Pontos em Dobro</strong>: Suba no ranking 2x mais rápido.</li>
                        <li style="margin-bottom: 8px;">👑 <strong>Destaque VIP</strong> no chat global e perfil.</li>
                        <li style="margin-bottom: 8px;">🎰 <strong>4 Giros</strong> na Roleta Diária (o dobro do normal).</li> 
                    </ul>
                </div>
                
                <button onclick="assinarVip()" style="margin-top: 15px; width: 100%; background: linear-gradient(45deg, #d4af37, #f1c40f); color: #000; font-weight: bold; padding: 12px; border: none; border-radius: 8px; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);">
                    💎 ASSINAR AGORA
                </button>
            </div>
        `;
    }
    abrirModal('modalVip');
    soltarFaiscasDeLuxo();
}

const SKUS = {
    VIP: 'adesao_vip_1_mes',
    PRO: 'assinatura_pro_mensal',
    TURBINAR: 'turbinar_perfil_24h'
};

let playStoreService = null;

// Função para iniciar o serviço de pagamento da Play Store
async function setupPlayStoreBilling() {
    if ('getDigitalGoodsService' in window) {
        try {
            playStoreService = await window.getDigitalGoodsService("https://play.google.com/billing");
            if (playStoreService) {
                console.log("✅ Serviço de cobrança da Google Play conectado com sucesso!");
            }
        } catch (error) {
            console.error("Falha ao conectar com o serviço da Play Store:", error);
            playStoreService = null;
        }
    }
}

// Chama a configuração assim que o perfil do usuário é carregado
// (Você pode adicionar essa chamada dentro do 'auth.onAuthStateChanged')

// Função principal para iniciar uma compra
async function comprarComPlayStore(sku, precoEstimado) {
    if (!playStoreService) {
        exibirPopup("O serviço de pagamento da Play Store não está disponível. Isso é esperado se você estiver acessando pelo navegador comum.");
        return;
    }

    try {
        console.log(`Iniciando compra para SKU: ${sku}`);
        const paymentMethodData = [{
            supportedMethods: "https://play.google.com/billing",
            data: { sku: sku }
        }];

        // Detalhes do pagamento (informativo)
        const paymentDetails = {
            total: {
                label: `Total`,
                amount: { currency: "BRL", value: precoEstimado.toString() }
            }
        };

        const request = new PaymentRequest(paymentMethodData, paymentDetails);
        const response = await request.show();
        
        const { purchaseToken } = response.details;
        
        // **MUITO IMPORTANTE:** AQUI VOCÊ DEVE ENVIAR O 'purchaseToken' PARA O SEU BACKEND
        // PARA VALIDAÇÃO E ATIVAÇÃO DO PRODUTO.
        
        // Exemplo de como seria a chamada para o backend:
        // await validarCompraNoBackend(purchaseToken, sku);

        await response.complete('success');
        
        // Simulação de sucesso (REMOVA APÓS IMPLEMENTAR O BACKEND)
        exibirPopup("Compra via Play Store concluída com sucesso (Simulação)! A ativação real requer validação no backend.");
        // Exemplo: ativarBeneficioLocalmente(sku); // Função para atualizar a UI
        location.reload();


    } catch (error) {
        console.error("Erro durante a compra na Play Store:", error);
        if (error.name !== 'AbortError') {
             exibirPopup("Ocorreu um erro ao processar seu pagamento na Play Store.");
        }
    }
}

// --- FUNÇÃO VIP COM FLASH RELOAD ---
function assinarVip() {
    if (playStoreService) {
        comprarComPlayStore('assinatura_vip_mensal', 29.90);
        return;
    }

    const saldoDigital = perfil.saldoDigital || 0;

    if (saldoDigital < PRECO_VIP) {
        exibirPopup("Moedas Insuficientes", "Você precisa de mais Saldo Digital para assinar o VIP.", "aviso", () => {
            iniciarCompraMoedas();
        });
        return;
    }

    const titulo = `Confirmar Assinatura VIP`;
    const mensagem = `Deseja assinar o VIP por R$ ${PRECO_VIP.toFixed(2)}? Será descontado do seu Saldo Digital.`;
    
    exibirConfirmacao(titulo, mensagem, () => {
        exibirAguarde("Ativando VIP...");
        db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const financeiroRef = db.collection("config").doc("financeiro");
            const clienteDoc = await t.get(clienteRef);
            
            if (isVipAtivo(clienteDoc.data())) throw "Você já é VIP.";
            if ((clienteDoc.data().saldoDigital || 0) < PRECO_VIP) throw "Saldo digital insuficiente.";

            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 30);

            t.update(clienteRef, {
                saldoDigital: firebase.firestore.FieldValue.increment(-PRECO_VIP),
                vip: true,
                vipExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
            });
            t.set(financeiroRef, { arrecadadoVip: firebase.firestore.FieldValue.increment(PRECO_VIP) }, { merge: true });
        }).then(() => {
            fecharTodosOsModais();

            // --- O SEGREDO DO PISCAR DE TELA ---
            localStorage.setItem('pular_splash_inicial', 'true');
            tocarSom('sucesso');
            
            // Reinicia quase instantaneamente
            setTimeout(() => {
                location.reload();
            }, 50);
            // -----------------------------------

        }).catch(e => {
            fecharTodosOsModais();
            exibirPopup("Erro ao assinar VIP", e.message || e, "erro");
        });
    });
}

// --- FUNÇÃO DE ASSINATURA/UPGRADE INSTANTÂNEO (FLASH RELOAD) ---
function assinarPro(tier) {
    const plano = PRECOS_PRO[tier];
    if (!plano) return exibirPopup("Plano inválido.");
    const sku = `pro_${tier}`;

    // Compra via Google Play (TWA)
    if (playStoreService) {
        comprarComPlayStore(sku, plano.preco);
        return;
    }

    // Compra via Saldo Digital (Web)
    const saldoDigital = perfil.saldoDigital || 0;

    if (saldoDigital < plano.preco) {
        exibirPopup("Moedas Insuficientes", "Saldo digital insuficiente para este plano.", "aviso", () => {
            iniciarCompraMoedas();
        });
        return;
    }
    
    // Verifica se já possui
    if (perfil.proAtivo && perfil.proTier === tier) {
        return exibirPopup("Já Ativo", `Você já possui o plano ${plano.nome}.`);
    }

    const isUpgrade = perfil.proAtivo; 
    const textoAcao = isUpgrade ? "FAZER UPGRADE" : "ASSINAR";
    const titulo = `Confirmar ${textoAcao} (${plano.nome})`;
    const mensagem = `Deseja assinar o plano ${plano.nome} por ${plano.preco.toFixed(2)} Moedas?`;
    
    exibirConfirmacao(titulo, mensagem, () => {
        exibirAguarde("Atualizando Plano...");
        db.runTransaction(async t => {
            const proRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const financeiroRef = db.collection("config").doc("financeiro");
            const proDoc = await t.get(proRef);
            
            if ((proDoc.data().saldoDigital || 0) < plano.preco) throw "Saldo insuficiente durante transação.";

            const novaExpiracao = new Date();
            novaExpiracao.setDate(novaExpiracao.getDate() + 30);

            t.update(proRef, {
                saldoDigital: firebase.firestore.FieldValue.increment(-plano.preco),
                proAtivo: true,
                proTier: tier,
                proExpirationDate: firebase.firestore.Timestamp.fromDate(novaExpiracao)
            });
            
            t.set(financeiroRef, { arrecadadoPro: firebase.firestore.FieldValue.increment(plano.preco) }, { merge: true });

        }).then(() => {
            fecharTodosOsModais();
            
            // --- O SEGREDO DO PISCAR DE TELA ---
            // 1. Marca para pular a abertura cinematográfica
            localStorage.setItem('pular_splash_inicial', 'true');
            
            // 2. Feedback sonoro rápido
            tocarSom('sucesso');
            
            // 3. Reinicia em 50ms (Piscou, voltou!)
            setTimeout(() => {
                location.reload();
            }, 50);
            // -----------------------------------

        }).catch(e => {
            fecharTodosOsModais();
            exibirPopup("Erro ao assinar", e.message || e, "erro");
        });
    });
}

function cliqueBloqueado(tier) {
    const nomesTier = { 'tier1': 'Bronze', 'tier2': 'Prata', 'tier3': 'Ouro', 'tier4': 'Diamante' };
    const nomeTier = nomesTier[tier] || tier;
    
    // 1. Exibe o aviso imediatamente (usando o popup genérico com z-index alto)
    // Força o popup de aviso para o topo também
    const popupAviso = document.getElementById('modalPopupGenerico');
    if(popupAviso) popupAviso.style.zIndex = '100000'; 
    
    exibirPopup('🔒 Recurso Bloqueado', `Este recurso é exclusivo do plano ${nomeTier.toUpperCase()}. Você será redirecionado para os planos em 3 segundos.`, 'aviso');
    
    // 2. Espera 3 segundos e abre a loja PRO
    setTimeout(() => {
        // Fecha o popup de aviso anterior para limpar a tela
        if(popupAviso) popupAviso.classList.remove('show');

        // Abre o modal PRO
        abrirModalVipPro();
        
        // --- SEGURANÇA FINAL: Força o Z-Index via JS na hora de abrir ---
        const modalPro = document.getElementById('modalVipPro');
        if(modalPro) {
            modalPro.style.setProperty('z-index', '99999', 'important');
            modalPro.style.display = 'flex'; // Garante display
        }
    }, 3000);
}

function confirmarTurbinar() {
    if (playStoreService) {
        comprarComPlayStore(SKUS.TURBINAR, PRECO_TURBINAR);
        return;
    }

    // CORREÇÃO: Verifica Saldo Digital
    const saldoDigital = perfil.saldoDigital || 0;

    if (saldoDigital < PRECO_TURBINAR) {
        return exibirPopup("Moedas Insuficientes", `Você precisa de ${PRECO_TURBINAR.toFixed(2)} em Moedas Digitais.`, "aviso", () => {
            iniciarCompraMoedas();
        });
    }
    
    if (perfil.ultimoBoostComprado) {
        const vinteQuatroHorasAtras = new Date(Date.now() - 24 * 60 * 60 * 1000);
        if (perfil.ultimoBoostComprado.toDate() > vinteQuatroHorasAtras) {
            return exibirPopup("Você só pode turbinar o perfil uma vez a cada 24 horas.");
        }
    }

    const titulo = "Turbinar Perfil (24h)";
    const msg = `Confirmar o boost por ${PRECO_TURBINAR.toFixed(2)} Moedas?`;

    exibirConfirmacao(titulo, msg, () => {
        const expiracao = new Date(Date.now() + 24 * 60 * 60 * 1000);
        db.collection('usuarios').doc(auth.currentUser.uid).update({
            saldoDigital: firebase.firestore.FieldValue.increment(-PRECO_TURBINAR), // CORREÇÃO: Desconta do Digital
            boostExpiracao: firebase.firestore.Timestamp.fromDate(expiracao),
            ultimoBoostComprado: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            exibirPopup('Perfil turbinado com sucesso! Você está no topo da lista por 24 horas.');
            fecharModalAtual();
        }).catch(e => exibirPopup('Erro ao turbinar perfil: ' + e.message));
    });
}

function isVipAtivo(perfilUsuario) {
    // Se não tiver a flag vip ou a data, retorna falso
    if (!perfilUsuario || !perfilUsuario.vip || !perfilUsuario.vipExpirationDate) {
        return false;
    }
    
    let expiracao;
    const dateData = perfilUsuario.vipExpirationDate;

    try {
        // Caso 1: É um Timestamp do Firebase (tem a função toDate)
        if (typeof dateData.toDate === 'function') {
            expiracao = dateData.toDate();
        }
        // Caso 2: Já é um objeto Date do JS
        else if (dateData instanceof Date) {
            expiracao = dateData;
        }
        // Caso 3: É uma String (formato ISO vindo do JSON da API)
        else if (typeof dateData === 'string') {
            expiracao = new Date(dateData);
        }
        // Caso 4: É um objeto Timestamp serializado (tem seconds/nanoseconds mas não a função)
        else if (dateData.seconds || dateData._seconds) {
            expiracao = new Date((dateData.seconds || dateData._seconds) * 1000);
        } else {
            return false; // Formato desconhecido
        }

        // Verifica se a data de expiração é maior que agora
        return expiracao > new Date();

    } catch (e) {
        console.error("Erro ao verificar VIP:", e);
        return false;
    }
}

// FUNÇÃO GLOBAL PARA IDENTIFICAR O PROPRIETÁRIO REAL
async function obterDonoUidReal(profissionalUid) {
    try {
        const docProf = await db.collection('usuarios').doc(profissionalUid).get();
        if (!docProf.exists) return profissionalUid;

        const dados = docProf.data();
        // Se o profissional pertence a uma barbearia, o dono é o UID do patrão
        if (dados.pertenceABarbearia && dados.pertenceABarbearia.uid) {
            console.log("Vínculo encontrado: Dono é " + dados.pertenceABarbearia.uid);
            return dados.pertenceABarbearia.uid;
        }
        // Se não tem vínculo, ele é o próprio dono
        return profissionalUid;
    } catch (e) {
        console.error("Erro ao identificar dono:", e);
        return profissionalUid;
    }
}

// ADICIONE ESTA ÚNICA VERSÃO CORRETA (e delete as 3 antigas)

function isProAtivo(perfilUsuario) {
    // Se não tiver a flag proAtivo ou a data, retorna falso
    if (!perfilUsuario || !perfilUsuario.proAtivo || !perfilUsuario.proExpirationDate) {
        return false;
    }

    let expiracao;
    const dateData = perfilUsuario.proExpirationDate;

    try {
        // Caso 1: Timestamp do Firebase (tem a função toDate)
        if (typeof dateData.toDate === 'function') {
            expiracao = dateData.toDate();
        }
        // Caso 2: Objeto Date do JS
        else if (dateData instanceof Date) {
            expiracao = dateData;
        }
        // Caso 3: String ISO (formato que o admin envia)
        else if (typeof dateData === 'string') {
            expiracao = new Date(dateData);
        }
        // Caso 4: Objeto Timestamp serializado (pode vir de algum cache)
        else if (dateData.seconds || dateData._seconds) {
            expiracao = new Date((dateData.seconds || dateData._seconds) * 1000);
        } else {
            return false; // Formato desconhecido
        }

        // Verifica se a data de expiração é maior que agora
        return expiracao > new Date();

    } catch (e) {
        console.error("Erro ao verificar PRO:", e);
        return false;
    }
}


// FUNÇÃO DO CHAT ATUALIZADA
let chatAtual = 'global';
function abrirChatGlobal() {
    // 1. Limpa os alertas visuais
    const btnChat = document.getElementById('btnChat');
    const badge = btnChat.querySelector('.notification-badge');
    
    if(badge) {
        badge.textContent = '0';
        badge.classList.remove('visible'); // Esconde a bolinha
        badge.style.display = 'none'; // Garante que suma
    }
    
    // Remove a animação de pulso/brilho
    btnChat.classList.remove('chat-alert-anim');
    
    // Zera o contador global
    mensagensNaoLidasChat = 0;
    
    // 2. Abre o modal
    abrirModal('janelaChat');
    alternarChat('global'); // Começa sempre no global
}

// --- FUNÇÃO DO CHAT GLOBAL E LOCAL (CORRIGIDA E BLINDADA) ---
function alternarChat(tipo) {
    chatAtual = tipo; // Atualiza variável global para o envio saber onde mandar
    
    // Atualiza Visual das Abas
    document.getElementById('tabChatGlobal').classList.toggle('active', tipo === 'global');
    document.getElementById('tabChatLocal').classList.toggle('active', tipo === 'local');

    // Controle do seletor de cidade (Apenas para Admin)
    const adminSelector = document.getElementById('adminChatSelectorContainer');
    if (adminSelector) adminSelector.classList.add('hidden'); 

    const chatContainer = document.getElementById("chatMessages");
    // Loading inicial para dar feedback
    chatContainer.innerHTML = "<div class='spinner' style='margin-top:20px;'></div>"; 
    
    // Esconde botão de carregar mais temporariamente
    const btnCarregarMais = document.getElementById('carregarMaisMsgBtn');
    if(btnCarregarMais) btnCarregarMais.style.display = 'none';

    oldestMessageSnapshot = null; // Reseta paginação
    
    // Limpa qualquer listener anterior para não duplicar mensagens
    if (chatListener) chatListener(); 

    // --- CONSTRUÇÃO DA QUERY ---
    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
    const agora = new Date();

    // Filtra pelo tipo da aba atual
    query = query.where("tipoChat", "==", tipo);

    if (tipo === 'local') {
        if (perfil.tipo === 'admin') {
            // Se for admin, mostra o seletor e filtra pela cidade escolhida
            if (adminSelector) adminSelector.classList.remove('hidden');
            const cidadeSel = document.getElementById('adminChatCidade').value;
            
            if (cidadeSel) {
                query = query.where("cidade", "==", cidadeSel);
                document.getElementById("chatTitle").textContent = `📍 Chat Local (${cidadeSel})`;
            } else {
                document.getElementById("chatTitle").textContent = `📍 Selecione uma Cidade`;
                chatContainer.innerHTML = "<p style='text-align:center; padding:20px;'>Selecione uma cidade acima para ver as mensagens.</p>";
                return; // Para aqui até o admin selecionar
            }
        } else {
            // Se for usuário comum, filtra pela cidade dele
            query = query.where("cidade", "==", perfil.cidade); 
            document.getElementById("chatTitle").textContent = `📍 Chat Local (${perfil.cidade})`;
        }
    } else {
        document.getElementById("chatTitle").textContent = '💬 Chat Global';
    }

    // --- CORREÇÃO DO BANCO DE DADOS (CRÍTICO) ---
    // Usamos 'deleteAt' tanto no filtro quanto na ordenação para o Firebase não bloquear.
    // Isso mantém a ordem cronológica porque deleteAt é sempre (Data Envio + 24h).
    query = query.where("deleteAt", ">", agora) 
                 .orderBy("deleteAt", "desc") 
                 .limit(20);                     

    // --- LISTENER EM TEMPO REAL ---
    chatListener = query.onSnapshot(async snapshot => {
        
        // Verifica se é a primeira carga (ainda tem spinner)
        const isFirstLoad = chatContainer.querySelector('.spinner') !== null;
        
        if (snapshot.empty) {
            chatContainer.innerHTML = `<p style='text-align:center; opacity:0.6; margin-top:20px;'>Nenhuma mensagem recente.<br>Diga olá!</p>`;
            if(btnCarregarMais) btnCarregarMais.style.display = 'none';
            return;
        }
        
        if (isFirstLoad) {
            chatContainer.innerHTML = ""; // Remove o spinner
            if(btnCarregarMais) {
                btnCarregarMais.style.display = 'block';
                btnCarregarMais.disabled = false;
                btnCarregarMais.textContent = "Ver mensagens anteriores";
            }
            
            // Salva referência para carregar mais depois
            oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1]; 

            // Processa as mensagens iniciais
            // O Firebase devolve da mais nova para a mais velha (desc), então invertemos
            const docsInvertidos = snapshot.docs.reverse(); 
            
            // AQUI ESTÁ A MÁGICA: Espera carregar os visuais (molduras) antes de mostrar
            const divs = await Promise.all(docsInvertidos.map(doc => createMessageDiv(doc.data(), doc.id)));
            
            divs.forEach(div => chatContainer.appendChild(div));
            
            // Rola para o final
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 100);

        } else {
            // Atualização em Tempo Real (Mensagem Nova Chegando)
            const changes = snapshot.docChanges();
            
            for (const change of changes) {
                if (change.type === 'added') {
                    // Só adiciona se já não estiver na tela (evita duplicação)
                    const jaExiste = chatContainer.querySelector(`[data-doc-id="${change.doc.id}"]`);
                    if (!jaExiste) {
                        const div = await createMessageDiv(change.doc.data(), change.doc.id);
                        chatContainer.appendChild(div);
                        chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll
                    }
                }
                if (change.type === 'removed') {
                    const el = chatContainer.querySelector(`[data-doc-id="${change.doc.id}"]`);
                    if (el) el.remove();
                }
            }
        }

    }, error => { 
        console.error("Erro no chat:", error);
        // Evita travar a tela em caso de erro de conexão
        if (chatContainer.innerHTML.includes('spinner')) {
             chatContainer.innerHTML = `<p style="color: red; text-align:center;">Conectando...</p>`;
        }
    });
    
    // Garante que o Enter funcione neste chat também
    const chatInput = document.getElementById('chatInput');
    // Remove listener antigo para não duplicar envios
    const novoInput = chatInput.cloneNode(true);
    chatInput.parentNode.replaceChild(novoInput, chatInput);
    
    novoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') enviarMensagem();
    });
}

async function carregarVisaoGeralEquipe() {
    // 1. Lógica de Secretária sem vínculo (busca emprego)
    if (perfil.tipo === 'secretaria' && (!perfil.pertenceABarbearia || !perfil.pertenceABarbearia.uid)) {
        return carregarListaProprietariosParaSecretaria();
    }

    const painel = document.getElementById('profissionaisView');

    // --- HTML DO PAINEL ---
    painel.innerHTML = `
        <div style="text-align:center; margin-bottom: 15px;">
            <h2 style="color:#fff; margin:0;">👥 Gestão da Equipe</h2>
            <p style="font-size:12px; color:#aaa; margin-top:5px;">Toque no horário verde para agendar ou vermelho para ver detalhes.</p>
        </div>

        ${perfil.isProprietario ? `
        <button onclick="abrirModalConvidarRecepcionista()" style="width:100%; margin-bottom:10px; padding:12px; border-radius:12px; background: linear-gradient(45deg, #9b59b6, #8e44ad); color:white; font-weight:bold; border:1px solid rgba(255,255,255,0.2); text-transform:uppercase; letter-spacing:1px; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4);">
            👩‍💼 Contratar Secretária
        </button>` : ''}

        <button onclick="abrirModalCriarAgendamentoManual()" class="btn-criar-agendamento-top">
            ➕ CRIAR AGENDAMENTO
        </button>

        <div id="containerEquipeVisual">
            <div class="spinner" style="margin: 20px auto;"></div>
        </div>
    `;

    const container = document.getElementById('containerEquipeVisual');

    // 2. Monta a lista de IDs para buscar
    let listaIds = [];
    
    if (perfil.isProprietario) {
        listaIds = [auth.currentUser.uid]; // Eu (Dono)
        (perfil.equipe || []).forEach(m => listaIds.push(typeof m === 'string' ? m : m.uid));
    } 
    else if (perfil.tipo === 'secretaria') {
        const donoUid = perfil.pertenceABarbearia.uid;
        listaIds.push(donoUid); 
        const donoDoc = await db.collection('usuarios').doc(donoUid).get();
        if(donoDoc.exists) {
            const equipeDono = donoDoc.data().equipe || [];
            equipeDono.forEach(m => {
                const uid = typeof m === 'string' ? m : m.uid;
                if (uid !== auth.currentUser.uid) listaIds.push(uid);
            });
        }
    } else {
        listaIds = [auth.currentUser.uid]; // Profissional comum vê só ele
    }

    // 3. Busca e Renderiza
    try {
        const promises = listaIds.map(uid => db.collection('usuarios').doc(uid).get());
        const docs = await Promise.all(promises);

        container.innerHTML = '';

        for (const doc of docs) {
            if (!doc.exists) continue;
            const u = doc.data();
            const uid = doc.id;
            
            const foto = u.fotoPerfil || u.logo_url || '/icone.png';
            const vagaAtiva = u.vagaImediata === true;
            const btnClass = vagaAtiva ? 'background:#27ae60; color:white;' : 'background:#333; color:#777;';
            const btnText = vagaAtiva ? '🟢 DISPONÍVEL' : '🔴 INDISPONÍVEL';
            const idContainerHorarios = `slots_equipe_${uid}`;
            
            // --- LÓGICA DO BOTÃO REMOVER (NOVIDADE) ---
            let btnRemoverHTML = '';
            // Só o dono vê, e não pode remover a si mesmo
            if (perfil.isProprietario && uid !== auth.currentUser.uid) {
                btnRemoverHTML = `
                <button onclick="removerMembroEquipe('${uid}', '${u.nome}')" 
                    style="position: absolute; top: 5px; right: 5px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 12px;" title="Remover da equipe">
                    🗑️
                </button>`;
            }

            container.innerHTML += `
            <div class="card-equipe-grid" style="position: relative;">
                ${btnRemoverHTML} <img src="${foto}" class="card-equipe-foto" onclick="abrirGestaoMembroV2('${uid}')" style="cursor:pointer; border-color:${u.isProprietario ? '#d4af37' : '#00c6ff'}">
                
                <div class="card-equipe-nome">${u.nome.split(' ')[0]}</div>
                <div class="card-equipe-cargo">${u.isProprietario ? 'PROPRIETÁRIO' : 'MEMBRO'}</div>
                
                <button onclick="toggleVagaImediataEquipe('${uid}', ${vagaAtiva})" style="width:100%; margin:8px 0; font-size:10px; border-radius:4px; padding:6px; cursor:pointer; ${btnClass}">
                    ${btnText}
                </button>
                
                <div id="${idContainerHorarios}" style="width:100%; min-height:50px;"></div>
            </div>`;
            
            setTimeout(() => monitorarHorariosRealTime(uid, idContainerHorarios, "equipe"), 0);
        }
    } catch (e) {
        console.error(e);
        container.innerHTML = '<p>Erro ao carregar.</p>';
    }
}

function abrirModalConvidarRecepcionista() {
    // 1. Pergunta o E-mail
    const email = prompt("Digite o E-MAIL do usuário que será sua Recepcionista:\n(O usuário já deve ter criado uma conta como Cliente no app)");
    if (!email) return;

    // 2. Pergunta o Salário (NOVO)
    const salario = prompt("Qual será o SALÁRIO MENSAL (Valor Fixo)?\nDigite apenas números (ex: 1500):");
    if (!salario || isNaN(salario)) return alert("Salário inválido.");

    // 3. Pergunta o Dia de Pagamento (NOVO)
    const diaPagamento = prompt("Qual o dia do pagamento? (1 a 31):");
    if (!diaPagamento || isNaN(diaPagamento) || diaPagamento < 1 || diaPagamento > 31) return alert("Dia inválido.");

    // Envia tudo
    enviarConviteRecepcionista(email, parseFloat(salario), parseInt(diaPagamento));
}

async function enviarConviteRecepcionista(email, salario, diaPagamento) {
    exibirAguarde("Buscando usuário...");
    
    try {
        const snap = await db.collection('usuarios').where('email', '==', email).limit(1).get();
        
        if (snap.empty) {
            fecharTodosOsModais();
            return exibirPopup("Não encontrado", "Nenhum usuário encontrado com este e-mail. Peça para ela criar uma conta como Cliente primeiro.");
        }
        
        const userDoc = snap.docs[0];
        const userUid = userDoc.id;
        const userData = userDoc.data();

        if (userData.tipo !== 'cliente') {
            fecharTodosOsModais();
            return exibirPopup("Inválido", "Este usuário já é um profissional ou admin.");
        }

        // Envia o convite com os dados financeiros FIXOS
        await db.collection("solicitacoes").add({
            tipo: "convite_recepcionista", 
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nomeBarbearia || perfil.nome,
            destinatarioUid: userUid,
            destinatarioNome: userData.nome,
            
            // DADOS NOVOS DE SALÁRIO
            salarioCombinado: salario,
            diaPagamento: diaPagamento,
            
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Notifica
        notifyUser(userUid, "👑 Proposta de Emprego", `${perfil.nome} te convidou para ser Secretária. Salário: R$ ${salario}`, { link: '#convites' });

        fecharTodosOsModais();
        exibirPopup("Convite Enviado!", `Aguardando ${userData.nome} aceitar.`);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

async function enviarConviteRecepcionista(email) {
    exibirAguarde("Buscando usuário...");
    
    try {
        const snap = await db.collection('usuarios').where('email', '==', email).limit(1).get();
        
        if (snap.empty) {
            fecharTodosOsModais();
            return exibirPopup("Não encontrado", "Nenhum usuário encontrado com este e-mail. Peça para ela criar uma conta como Cliente primeiro.");
        }
        
        const userDoc = snap.docs[0];
        const userUid = userDoc.id;
        const userData = userDoc.data();

        if (userData.tipo !== 'cliente') {
            fecharTodosOsModais();
            return exibirPopup("Inválido", "Este usuário já é um profissional ou admin.");
        }

        // Envia o convite
        await db.collection("solicitacoes").add({
            tipo: "convite_recepcionista", // TIPO ESPECIAL
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nomeBarbearia || perfil.nome,
            destinatarioUid: userUid,
            destinatarioNome: userData.nome,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Notifica
        notifyUser(userUid, "👑 Convite Especial", `${perfil.nome} te convidou para ser Recepcionista/Secretária!`, { link: '#convites' });

        fecharTodosOsModais();
        exibirPopup("Convite Enviado!", `Aguardando ${userData.nome} aceitar.`);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

async function abrirAgendaSecretariaDetalhada() {
    abrirModal('modalAgendaSecretaria');
    const container = document.getElementById('containerAgendaDetalhada');
    container.innerHTML = '<div class="spinner"></div>';
    
    if (!perfil.pertenceABarbearia || !perfil.pertenceABarbearia.uid) {
        container.innerHTML = '<p>Você não está vinculada a nenhuma equipe.</p>';
        return;
    }

    const donoUid = perfil.pertenceABarbearia.uid;
    
    // Busca agendamentos de TODOS da barbearia para HOJE
    // (Isso requer que na criação do agendamento a gente salve 'donoUid' também na coleção 'agendamentos' para facilitar queries, 
    //  mas como não salvamos, vamos buscar por 'barbeiroUid' IN [lista]. Como 'IN' é limitado a 10, faremos diferente:
    //  Buscamos tudo do dia e filtramos no JS, ou melhor: iteramos os membros).
    
    // 1. Pega membros
    const donoDoc = await db.collection('usuarios').doc(donoUid).get();
    const equipe = donoDoc.data().equipe || [];
    const listaUids = [donoUid, ...equipe.map(m => typeof m === 'string' ? m : m.uid)];
    
    // Remove o próprio ID da secretária
    const uidsFiltrados = listaUids.filter(id => id !== auth.currentUser.uid);

    container.innerHTML = '';
    
    // Para cada membro, cria uma coluna/bloco
    for (const uid of uidsFiltrados) {
        const userDoc = await db.collection('usuarios').doc(uid).get();
        const u = userDoc.data();
        
        // Busca agendamentos de hoje
        const snaps = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uid)
            .where('status', 'in', ['confirmado', 'conclusão pendente', 'pendente', 'imediato'])
            .orderBy('horario', 'asc') // Requer índice composto no Firebase
            .get();

        let htmlAgenda = `<div style="margin-bottom:20px; background:#1a1a1a; padding:15px; border-radius:12px; border-left:4px solid var(--cor-destaque);">`;
        htmlAgenda += `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <img src="${u.fotoPerfil || '/icone.png'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
            <h4 style="margin:0; color:#fff;">${u.nome}</h4>
        </div>`;
        
        if (snaps.empty) {
            htmlAgenda += `<p style="font-size:12px; color:#555;">Nenhum agendamento hoje.</p>`;
        } else {
            snaps.forEach(agDoc => {
                const ag = agDoc.data();
                const hora = ag.horario === 'imediato' ? '⚡ AGORA' : ag.horario;
                const statusColor = ag.status === 'pendente' ? '#f1c40f' : (ag.status === 'imediato' ? '#e67e22' : '#2ecc71');
                
                htmlAgenda += `
                <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:5px; border:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span style="color:#fff; font-weight:bold; font-size:16px;">${hora}</span>
                        <div style="font-size:12px; color:#aaa;">${ag.clienteNome}</div>
                        <div style="font-size:10px; color:var(--cor-destaque);">${ag.servico}</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:10px; padding:2px 6px; border-radius:4px; background:${statusColor}; color:#000; font-weight:bold;">${ag.status.toUpperCase()}</span>
                    </div>
                </div>`;
            });
        }
        htmlAgenda += `</div>`;
        container.innerHTML += htmlAgenda;
    }
}

async function abrirGestaoUnica(uidMembro) {
    // Limpeza garantida
    const anterior = document.getElementById('modalGestaoUnica');
    if (anterior) anterior.remove();
    fecharTodosOsModais();

    try {
        const uidDono = auth.currentUser.uid;

        // --- BUSCA DADOS ---
        const docUser = await db.collection('usuarios').doc(uidMembro).get();
        if (!docUser.exists) { alert("Profissional não encontrado."); return; }
        const dados = docUser.data();
        
        // --- PERMISSÕES E TAXA ---
        const podePromo = dados.temPermissaoPromo || false;
        const podeSOS = dados.temPermissaoSOS || false;
        let taxa = dados.taxaComissao || dados.comissao || 0;
        if (taxa === 0) {
            try {
                const docDono = await db.collection('usuarios').doc(uidDono).get();
                const item = (docDono.data().equipe || []).find(m => (m.uid === uidMembro || m === uidMembro));
                if (item && item.comissao) taxa = item.comissao;
            } catch(e) {}
        }
        taxa = parseFloat(String(taxa).replace(',', '.').replace('%', '')) || 0;

        // --- CÁLCULO FINANCEIRO SINCRONIZADO (Exato ao do dashboard do profissional) ---
        const servicosSnap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uidMembro).where('donoUid', '==', uidDono)
            .where('status', 'in', ['concluido', 'avaliado']).get();
        
        let acumuladoLiquidoTotal = 0;
        servicosSnap.forEach(d => {
            const val = parseFloat(d.data().valor) || 0;
            const desconto = val * (taxa / 100);
            acumuladoLiquidoTotal += (val - desconto);
        });

        const pagosSnap = await db.collection('pagamentos_equipe')
            .where('recebedorUid', '==', uidMembro).where('pagadorUid', '==', uidDono).get();
        
        let totalJaPago = 0;
        pagosSnap.forEach(d => totalJaPago += (parseFloat(d.data().valor) || 0));

        let saldoReal = acumuladoLiquidoTotal - totalJaPago;
        if (saldoReal < 0 && saldoReal > -1) saldoReal = 0;

        const foto = dados.fotoPerfil || dados.logo_url || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
        const nome = dados.nome || "Membro";

        // --- CRIAÇÃO DO MODAL (ESTILO FORTE) ---
        const modal = document.createElement('div');
        modal.id = 'modalGestaoUnica';
        modal.style.cssText = `
            position: fixed !important; top: 0 !important; left: 0 !important; 
            width: 100vw !important; height: 100vh !important;
            background: rgba(0,0,0,0.85) !important; 
            z-index: 2147483647 !important;
            display: flex !important; align-items: center !important; justify-content: center !important;
            backdrop-filter: blur(10px); /* Forte Desfoque para o brilho */
            transition: opacity 0.3s;
            opacity: 0;
        `;

        modal.innerHTML = `
        <div id="cardGestaoContent" style="
            background: #181818; 
            border: 2px solid rgba(255,255,255,0.1); /* Borda sutil para brilho */
            width: 90%; 
            max-width: 450px; /* Mais robusto */
            border-radius: 20px; 
            overflow: hidden; 
            position: relative;
            box-shadow: 0 10px 60px rgba(0,0,0,0.8), 0 0 20px rgba(255, 255, 255, 0.05); /* Sombra e brilho */
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #fff;
        ">
            
            <button onclick="document.getElementById('modalGestaoUnica').remove()" 
                style="position:absolute; top:15px; right:15px; background:rgba(255,255,255,0.1); border:none; color:#fff; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:20px; z-index:10; backdrop-filter: blur(5px);">✕</button>

            <div style="padding:40px 20px 30px 20px; text-align:center; background:linear-gradient(180deg, #1f1f1f 0%, #000000 100%);">
                <div style="position:relative; display:inline-block;">
                    <img src="${foto}" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:5px solid var(--cor-destaque, #d4af37); box-shadow:0 0 15px rgba(212, 175, 55, 0.5);">
                    <div onclick="salvarTaxaUnica('${uidMembro}', '${nome}', ${taxa})" 
                         style="position:absolute; bottom:0; right:0; background:#d4af37; color:#000; width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:4px solid #121212; cursor:pointer; font-weight:bold; font-size:16px;">%</div>
                </div>
                <h2 style="margin:15px 0 5px; color:#fff; font-size:26px; font-weight:700;">${nome}</h2>
                <div style="color:#888; font-size:14px;">Taxa Salão: <b style="color:#fff">${taxa}%</b></div>
            </div>

            <div style="padding:25px;">
                
                <div style="
                    background:#121212; 
                    padding:25px; 
                    border-radius:18px; 
                    text-align:center; 
                    margin-bottom:30px; 
                    border:1px solid ${saldoReal > 0 ? '#f39c12' : '#2ecc71'};
                    box-shadow: ${saldoReal > 0 ? 'inset 0 0 10px rgba(243, 156, 18, 0.3), 0 5px 15px rgba(0,0,0,0.5)' : 'inset 0 0 10px rgba(46, 204, 113, 0.3), 0 5px 15px rgba(0,0,0,0.5)'};
                ">
                    <div style="font-size:13px; color:#666; text-transform:uppercase; letter-spacing:1px;">Saldo a Pagar</div>
                    <div style="font-size:40px; font-weight:800; color:${saldoReal > 0 ? '#f39c12' : '#2ecc71'}; margin:10px 0;">
                        ${saldoReal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                    </div>
                    <button onclick="pagarComissaoUnica('${uidMembro}', '${nome}', ${saldoReal})" 
                        style="width:100%; padding:16px; border:none; border-radius:14px; font-weight:bold; cursor:pointer; font-size:16px;
                        background:${saldoReal > 0 ? 'linear-gradient(45deg, #f39c12, #e67e22)' : '#2a2a2a'}; 
                        color:${saldoReal > 0 ? '#fff' : '#555'}; transition:0.2s;"
                        ${saldoReal <= 0 ? 'disabled' : ''}>
                        ${saldoReal > 0 ? '💸 PAGAR E ZERAR SALDO' : '✅ SALDO EM DIA'}
                    </button>
<button onclick="abrirModalEntradaManual(uidProfissionalAtual)" style="width:100%; margin-top:10px; background-color: #333; color: white; border: 1px solid #d4af37;" class="btn-padrao">
    + Adicionar Entrada Manual
</button>
                </div>

                <h4 style="color:#999; font-size:14px; margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:5px;">Acessos Rápidos</h4>
                
                <div style="background:#121212; border-radius:16px; box-shadow:inset 0 0 10px rgba(0,0,0,0.6);">
                    
                    <div onclick="togglePermissao('${uidMembro}', 'temPermissaoPromo', ${!podePromo})" 
                         style="padding:18px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #2a2a2a; cursor:pointer; transition:background 0.1s;"
                         onmouseover="this.style.background='#1f1f1f'" onmouseout="this.style.background='transparent'">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <span style="font-size:24px;">🏷️</span>
                            <span style="color:#fff; font-weight:600;">Liberar Promoções</span>
                        </div>
                        <div style="width:44px; height:24px; background:${podePromo ? '#2ecc71' : '#555'}; border-radius:20px; position:relative; transition:0.3s; box-shadow:inset 0 0 5px rgba(0,0,0,0.5);">
                            <div style="width:20px; height:20px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${podePromo ? '22px' : '2px'}; transition:0.3s; box-shadow:0 1px 3px rgba(0,0,0,0.4);"></div>
                        </div>
                    </div>

                    <div onclick="togglePermissao('${uidMembro}', 'temPermissaoSOS', ${!podeSOS})" 
                         style="padding:18px 20px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:background 0.1s;"
                         onmouseover="this.style.background='#1f1f1f'" onmouseout="this.style.background='transparent'">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <span style="font-size:24px;">🚨</span>
                            <span style="color:#fff; font-weight:600;">Liberar Botão SOS</span>
                        </div>
                        <div style="width:44px; height:24px; background:${podeSOS ? '#2ecc71' : '#555'}; border-radius:20px; position:relative; transition:0.3s; box-shadow:inset 0 0 5px rgba(0,0,0,0.5);">
                            <div style="width:20px; height:20px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${podeSOS ? '22px' : '2px'}; transition:0.3s; box-shadow:0 1px 3px rgba(0,0,0,0.4);"></div>
                        </div>
                    </div>
                </div>

                <button onclick="removerDaEquipe('${uidMembro}')" style="width:100%; margin-top:25px; padding:18px; background:rgba(192, 57, 43, 0.1); border:1px solid #c0392b; color:#ff6b6b; border-radius:12px; font-size:14px; font-weight:600; cursor:pointer; transition:background 0.2s;">
                    🗑️ REMOVER PROFISSIONAL PERMANENTEMENTE
                </button>

            </div>
        </div>
        <style> /* Adiciona um Keyframe simples para a entrada */
        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        </style>
        `;

        document.body.appendChild(modal);
        
        // Força a animação de entrada
        requestAnimationFrame(() => {
            modal.style.opacity = '1';
            const card = document.getElementById('cardGestaoContent');
            if(card) card.style.transform = 'scale(1)';
        });

    } catch (e) {
        console.error(e);
        alert("Erro ao abrir painel: " + e.message);
    }
}

// Variáveis globais
let uidProfissionalFocado = null;
let idAgendamentoFocado = null; // NOVO: Para guardar o ID se for uma conclusão

async function abrirModalEntradaManual(uidProf, idAgendamento = null) {
    uidProfissionalFocado = uidProf;
    idAgendamentoFocado = idAgendamento; // Guarda o ID (pode ser null)
    
    console.log("Abrindo manual para:", uidProf, "Agendamento:", idAgendamento);

    const modal = document.getElementById('modalEntradaManualProfissional');
    const container = document.getElementById('listaServicosManual');
    const titulo = modal.querySelector('h3'); // Pega o título para mudar

    if (!modal) return alert("ERRO: Modal HTML não encontrado!");

    // MUDA O TÍTULO PARA O CONTEXTO CORRETO
    if (idAgendamento) {
        titulo.innerText = "Concluir Agendamento (Financeiro)";
        titulo.style.color = "#2ecc71"; // Verde para conclusão
    } else {
        titulo.innerText = "Entrada Manual (Balcão)";
        titulo.style.color = "#d4af37"; // Dourado para novo
    }

    modal.style.display = 'flex';
    
    // Animação e carregamento
    container.innerHTML = '<p style="color:#fff; text-align:center; padding:10px;">Carregando...</p>';

    try {
        const doc = await db.collection('usuarios').doc(uidProf).get();
        const dados = doc.data();
        const servicos = dados.listaServicos || [];

        container.innerHTML = ''; 

        if (servicos.length === 0) {
            container.innerHTML = '<p style="padding:10px; text-align:center; color:#888;">Sem serviços cadastrados.</p>';
            return;
        }

        servicos.forEach((servico, index) => {
            const div = document.createElement('div');
            div.style.cssText = "padding: 12px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s;";
            
            div.onclick = function() {
                const radio = this.querySelector('input[type="radio"]');
                if(radio) radio.checked = true;
                const allDivs = container.querySelectorAll('div');
                allDivs.forEach(d => d.style.background = 'transparent');
                this.style.background = '#333';
            };

            div.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:14px; font-weight:bold; color:#fff;">${servico.nome}</span>
                    <span style="font-size:12px; color:#d4af37;">R$ ${parseFloat(servico.valor).toFixed(2)}</span>
                </div>
                <input type="radio" name="servicoManual" value="${index}" style="transform: scale(1.5); cursor: pointer;">
            `;
            container.appendChild(div);
        });

    } catch (error) {
        console.error(error);
        container.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar.</p>';
    }
}

async function confirmarEntradaManual() {
    if (!uidProfissionalFocado) return;

    const radios = document.getElementsByName('servicoManual');
    let index = -1;
    for (const r of radios) { if (r.checked) { index = r.value; break; } }
    if (index === -1) return alert("Selecione um serviço!");

    exibirAguarde("Processando entrada...");

    try {
        // 1. Pega dados do profissional e o seu 'vinculoSalao'
        const profDoc = await db.collection('usuarios').doc(uidProfissionalFocado).get();
        const profDados = profDoc.data();
        const servicoObj = profDados.listaServicos[index];
        const formaPagamento = document.getElementById('entradaManualPagamento').value;

        // BUSCA DO DONO PELO VINCULO
        let uidDonoReal = profDados.vinculoSalao || uidProfissionalFocado;

        const valorBruto = parseFloat(servicoObj.valor);
        const taxa = parseFloat(profDados.taxaComissao || profDados.comissao || 0);
        const ganhoDono = valorBruto * (taxa / 100);
        const ganhoProf = valorBruto - ganhoDono;
        let metodos = {}; metodos[formaPagamento] = valorBruto;

        const batch = db.batch();

        // 2. Criar Agendamento já concluído (Gera ID antes)
        const agendRef = db.collection('agendamentos').doc();
        const agendamentoId = agendRef.id; // Guarda o ID

        batch.set(agendRef, {
            barbeiroUid: uidProfissionalFocado,
            barbeiroNome: profDados.nome,
            clienteNome: "Cliente Balcão",
            servico: servicoObj.nome,
            valor: valorBruto,
            status: 'concluido', // Já nasce concluído
            donoUid: uidDonoReal, // Vínculo com o Patrão
            data: new Date().toLocaleDateString('pt-BR'),
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            metodosPagamento: metodos
        });

        // 3. Criar Extrato Financeiro (VINCULADO AO ID DO AGENDAMENTO)
        const extratoRef = db.collection('extrato_financeiro').doc();
        batch.set(extratoRef, {
            agendamentoId: agendamentoId, // <--- BLINDAGEM: Vincula ao agendamento
            donoUid: uidDonoReal, 
            usuarioUid: uidProfissionalFocado,
            tipo: 'receita_servico',
            descricao: `Balcão: ${servicoObj.nome}`,
            valor: valorBruto,
            comissaoRetida: ganhoDono,
            valorLiquidoProfissional: ganhoProf,
            metodos: metodos,
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            extratoIdNoBanco: extratoRef.id
        });

        await batch.commit();

        fecharTodosOsModais();
        exibirPopup("Venda Registrada", "Venda de balcão concluída com sucesso.");
        
        if (typeof sincronizarPainelDeGestao === 'function') sincronizarPainelDeGestao();

    } catch (e) {
        console.error("Erro no balcão:", e);
        fecharTodosOsModais();
        alert("Erro: " + e.message);
    }
}

// --- FUNÇÃO DE TOGGLE (LIGA/DESLIGA) ---
async function togglePermissao(uid, campo, novoEstado) {
    try {
        await db.collection('usuarios').doc(uid).update({
            [campo]: novoEstado
        });
        // Recarrega o modal para ver a animação do switch mudando
        abrirGestaoUnica(uid);
    } catch (e) {
        alert("Erro ao alterar permissão: " + e.message);
    }
}

async function salvarTaxaUnica(uid, nome, atual) {
    // TEXTO MAIS CLARO AQUI:
    const nova = prompt(
        `CONFIGURAÇÃO DE COMISSÃO DE ${nome.toUpperCase()}\n\n` +
        `Qual a porcentagem (%) que fica para o SALÃO?\n` +
        `Exemplo: Se você digitar 40, o salão fica com 40% e o profissional com 60%.`, 
        atual
    );
    
    if (!nova) return;
    const valor = parseFloat(nova.replace(',', '.').replace('%', ''));
    if (isNaN(valor)) return alert("Número inválido");

    const batch = db.batch();
    const donoUid = auth.currentUser.uid;

    batch.update(db.collection('usuarios').doc(uid), { taxaComissao: valor, comissao: valor });

    const docDono = await db.collection('usuarios').doc(donoUid).get();
    let equipe = docDono.data().equipe || [];
    let idx = equipe.findIndex(m => (m.uid === uid || m === uid));
    
    if (idx !== -1) {
        if (typeof equipe[idx] === 'string') equipe[idx] = { uid, nome, comissao: valor };
        else equipe[idx].comissao = valor;
    } else {
        equipe.push({ uid, nome, comissao: valor });
    }
    
    batch.update(db.collection('usuarios').doc(donoUid), { equipe });
    await batch.commit();

    alert("✅ Taxa atualizada!");
    abrirGestaoUnica(uid);
}

// 3. PAGAR COMISSÃO
async function pagarComissaoUnica(uid, nome, valor) {
    if (!confirm(`Confirmar pagamento de ${valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}?`)) return;
    
    await db.collection('pagamentos_equipe').add({
        pagadorUid: auth.currentUser.uid,
        recebedorUid: uid,
        recebedorNome: nome,
        valor: parseFloat(valor),
        data: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("✅ Pagamento registrado!");
    abrirGestaoUnica(uid); // Recarrega o modal para mostrar saldo zero
}

// --- FUNÇÃO DE EDIÇÃO DE COMISSÃO (CORREÇÃO DE "Membro não encontrado") ---
async function editarComissaoMembro(uidTarget, nomeMembro, comissaoAtual) {
    // 1. Pergunta o novo valor
    const novaComissao = prompt(`Digite a nova taxa de comissão para ${nomeMembro}:\n(Exemplo: 40 para 40%)`, comissaoAtual);
    
    // Se cancelar, para tudo
    if (novaComissao === null || novaComissao.trim() === '') return;
    
    // 2. Limpa o valor (evita erros de digitação como "40%" ou "40,00")
    let valorFinal = parseFloat(novaComissao.replace(',', '.').replace('%', ''));
    if (isNaN(valorFinal)) return alert("Número inválido.");

    exibirAguarde(`Salvando taxa de ${valorFinal}%...`);

    try {
        const uidDono = auth.currentUser.uid;
        const batch = db.batch();

        // --- PASSO A: ATUALIZA O PERFIL DO BARBEIRO (Para o Dashboard DELE) ---
        // Isso garante que ele veja a taxa certa imediatamente
        const refBarbeiro = db.collection('usuarios').doc(uidTarget);
        batch.update(refBarbeiro, {
            taxaComissao: valorFinal, 
            comissao: valorFinal
        });

        // --- PASSO B: ATUALIZA A SUA LISTA DE EQUIPE (Para o SEU Painel) ---
        const refDono = db.collection('usuarios').doc(uidDono);
        const docDono = await refDono.get();
        let equipeAtual = docDono.data().equipe || [];

        // Verifica se o membro já está na lista
        const index = equipeAtual.findIndex(m => m.uid === uidTarget);

        if (index !== -1) {
            // CENÁRIO 1: Ele já existe, apenas atualizamos a taxa
            equipeAtual[index].comissao = valorFinal;
            // Atualiza nome e foto também pra garantir sincronia
            equipeAtual[index].nome = nomeMembro; 
        } else {
            // CENÁRIO 2: O ERRO ESTAVA AQUI! Ele não estava na lista, então adicionamos agora.
            equipeAtual.push({
                uid: uidTarget,
                nome: nomeMembro,
                comissao: valorFinal,
                foto: 'default' // Se tiver a url da foto fácil, melhor passar nos argumentos
            });
        }

        batch.update(refDono, { equipe: equipeAtual });

        // --- PASSO C: GRAVA TUDO ---
        await batch.commit();

        fecharTodosOsModais();
        
        // RECARREGA A TELA DO MODAL NA HORA
        // Isso faz o número mudar na sua frente sem precisar fechar e abrir
        setTimeout(() => {
            alert(`✅ Sucesso! Taxa de ${nomeMembro} alterada para ${valorFinal}%.`);
            abrirGerenciarMembroEspecifico(uidTarget);
        }, 500);

    } catch (erro) {
        console.error(erro);
        fecharTodosOsModais();
        alert("Erro ao salvar: " + erro.message);
    }
}

// =========================================================
// === NOVA AGENDA INTERATIVA (PROFISSIONAL & DONO) ===
// =========================================================

async function carregarMinhaAgendaInterativa() {
    const container = document.getElementById('containerMinhaAgendaGrid');
    const contadorLivres = document.getElementById('contadorLivres');
    const contadorOcupados = document.getElementById('contadorOcupados');
    
    container.innerHTML = '<div class="spinner" style="margin: 30px auto;"></div>';

    try {
        const meusAgendamentos = await db.collection('agendamentos')
            .where('barbeiroUid', '==', auth.currentUser.uid)
            .where('status', 'in', ['confirmado', 'conclusão pendente', 'pendente']) 
            .get();

        const mapaOcupacao = {};
        let totalOcupados = 0;

        meusAgendamentos.forEach(doc => {
            const ag = doc.data();
            if (ag.horario) {
                mapaOcupacao[ag.horario] = { id: doc.id, ...ag };
                totalOcupados++;
            }
        });

        let html = '';
        let totalLivres = 0;
        let listaHorarios = [];

        if (perfil.usaAgendaManual && perfil.agenda) {
            listaHorarios = Object.keys(perfil.agenda).filter(h => perfil.agenda[h] === true).sort();
        } else {
            for(let i=8; i<=20; i++) {
                listaHorarios.push(`${i.toString().padStart(2,'0')}:00`);
                if(i < 20) listaHorarios.push(`${i.toString().padStart(2,'0')}:30`);
            }
        }

        listaHorarios.forEach(hora => {
            const agendamento = mapaOcupacao[hora];

            if (agendamento) {
                // CORREÇÃO AQUI: Verifica se valor existe, senão usa 0
                const valorFormatado = (agendamento.valor || 0).toFixed(2);

                const dadosJson = JSON.stringify({
                    id: agendamento.id,
                    clienteUid: agendamento.clienteUid,
                    clienteNome: agendamento.clienteNome || 'Cliente',
                    barbeiroNome: agendamento.barbeiroNome,
                    servico: agendamento.servico,
                    valor: agendamento.valor || 0,
                    status: agendamento.status,
                    telefone: agendamento.clienteTelefone,
                    horario: hora
                }).replace(/"/g, '&quot;'); // Usa escape HTML para evitar quebra no onclick

                html += `
                <div class="agenda-slot-card ocupado" onclick='abrirDetalhesDoAgendamento(${dadosJson})'>
                    <div>
                        <div class="hora">${hora}</div>
                        <div class="servico">${agendamento.servico}</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="cliente">${(agendamento.clienteNome || 'Cliente').split(' ')[0]}</div>
                        <div style="font-size:10px; color:#fff;">R$ ${valorFormatado}</div>
                    </div>
                </div>`;
            } else {
                totalLivres++;
                html += `
                <div class="agenda-slot-card livre" onclick="prepararAgendamentoProprio('${hora}')">
                    <div>
                        <div class="hora">${hora}</div>
                        <div class="info">Disponível</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:20px;">➕</span>
                    </div>
                </div>`;
            }
        });

        container.innerHTML = html;
        if(contadorLivres) contadorLivres.textContent = totalLivres;
        if(contadorOcupados) contadorOcupados.textContent = totalOcupados;

    } catch (e) {
        console.error(e);
        container.innerHTML = '<p style="text-align:center;">Erro ao carregar agenda.</p>';
    }
}

// 1. CLIQUE NO SLOT VERDE (Adicionar Manualmente)
async function prepararAgendamentoProprio(horario) {
    // Reusa o modal de criação manual que já fizemos
    // A única diferença é que o "Profissional" é fixo (EU MESMO)
    
    const selectProf = document.getElementById('manualProfissionalUid');
    const inputHorarioVis = document.getElementById('manualHorarioVisual');
    const inputHorarioHid = document.getElementById('manualHorarioHidden');
    
    // Fixa Eu Mesmo
    selectProf.innerHTML = `<option value="${auth.currentUser.uid}" selected>${perfil.nome} (Eu)</option>`;
    selectProf.disabled = true; // Trava o select
    
    // Carrega Meus Serviços
    await atualizarServicosManual(auth.currentUser.uid);
    
    // Preenche Horário
    inputHorarioVis.value = horario;
    inputHorarioHid.value = horario;
    
    abrirModal('modalCriarAgendamentoManual');
}

// 2. CLIQUE NO SLOT VERMELHO (OCUPADO) -> Abre Detalhes e Ações
async function abrirDetalhesDoAgendamento(dados) {
    // Corrige dados que podem vir como string do HTML
    if (typeof dados === 'string') dados = JSON.parse(dados);

    // =================================================================
    // 🚑 CORREÇÃO DO ERRO PARA AGENDAMENTO MANUAL (BALCÃO)
    // =================================================================
    // Se o agendamento não tem o ID do barbeiro (comum em manuais), 
    // assumimos que o barbeiro é o próprio usuário logado (auth.currentUser)
    if (!dados.barbeiroUid) {
        dados.barbeiroUid = dados.profissionalUid || (auth.currentUser ? auth.currentUser.uid : null);
    }
    // =================================================================

    // --- SALVA DADOS GLOBAIS ---
    window.agendamentoAtualId = dados.id; 
    window.agendamentoIdParaConcluir = dados.id;
    window.agendamentoAtualDados = dados; 

    abrirModal('modalDetalhesAgendamento');
    
    // Preenche textos com proteção contra undefined
    const nomeCliente = (dados.clienteNome || dados.nome || 'Cliente').replace(' (Manual)', '');
    document.getElementById('detalheClienteNome').textContent = nomeCliente;
    document.getElementById('detalheNomeProfissional').textContent = dados.barbeiroNome || 'Profissional';
    document.getElementById('detalheServico').textContent = dados.servico || '-';
    document.getElementById('detalheHorario').textContent = dados.horario || '-';
    
    const valor = parseFloat(dados.valor) || 0;
    document.getElementById('detalheValor').textContent = `R$ ${valor.toFixed(2)}`;
    document.getElementById('detalheStatus').textContent = (dados.status || '').toUpperCase();
    document.getElementById('detalheClienteFone').textContent = dados.telefone || 'Sem telefone';
    
    // --- LÓGICA DA FOTO (MANTIDA ORIGINAL) ---
    const imgEl = document.getElementById('detalheClienteFoto');
    const badgeEl = document.getElementById('detalheClienteBadge');
    
    // Verifica se é cliente de balcão pelo ID "manual_"
    const isManual = dados.clienteUid && dados.clienteUid.toString().startsWith('manual_');

    if (isManual) {
        imgEl.src = '/icone.png'; // SUA LOGO DO APP
        badgeEl.textContent = "BALCÃO";
        badgeEl.style.background = "#f1c40f"; 
        badgeEl.style.color = "#000";
    } else {
        badgeEl.textContent = "APP";
        badgeEl.style.background = "#2ecc71"; 
        badgeEl.style.color = "#fff";
        
        // Tenta buscar a foto real
        imgEl.src = 'https://placehold.co/100?text=...'; 
        if (dados.clienteUid) {
            db.collection('usuarios').doc(dados.clienteUid).get().then(doc => {
                if(doc.exists) {
                    const c = doc.data();
                    imgEl.src = c.fotoPerfil || c.logo_url || '/icone.png';
                } else {
                    imgEl.src = '/icone.png';
                }
            });
        }
    }

    // --- (NOVO) INJEÇÃO DO BOTÃO DE SERVIÇO ADICIONAL ---
    // Verifica se o agendamento está ativo antes de permitir adicionar coisas
    if (dados.status !== 'concluido' && dados.status !== 'cancelado') {
        const containerBotoes = document.querySelector('#modalDetalhesAgendamento .modal-content');
        
        // Verifica se o botão já existe para não criar duplicado
        let btnAdicional = document.getElementById('btnServicoAdicional');
        
        if (!btnAdicional) {
            // Cria o botão dinamicamente se ele não existir no HTML
            btnAdicional = document.createElement('button');
            btnAdicional.id = 'btnServicoAdicional';
            btnAdicional.innerHTML = '➕ Serviço Adicional';
            // Estilo para destacar (Roxo/Gradiente)
            btnAdicional.style.cssText = "width:100%; background: linear-gradient(45deg, #9b59b6, #8e44ad); color:white; font-weight:bold; border:none; padding:12px; border-radius:8px; margin-bottom:10px; margin-top:5px; cursor:pointer;";
            
            // Tenta inserir ANTES do botão concluir
            const btnConcluirRef = document.getElementById('btnConcluirAgenda');
            if(btnConcluirRef && btnConcluirRef.parentNode) {
                btnConcluirRef.parentNode.insertBefore(btnAdicional, btnConcluirRef);
            } else {
                // Se não achar o botão concluir, adiciona no final
                containerBotoes.appendChild(btnAdicional);
            }
        } else {
            // Se já existe, garante que está visível
            btnAdicional.style.display = 'block';
            btnAdicional.textContent = '➕ Serviço Adicional'; // Reseta texto caso tenha mudado
        }

        // Define a ação: Abrir o modal de lista (Função que te enviei anteriormente)
        btnAdicional.onclick = () => abrirModalAdicionarServico();
    } else {
        // Se estiver concluído ou cancelado, esconde o botão se ele existir
        const btnAdicional = document.getElementById('btnServicoAdicional');
        if (btnAdicional) btnAdicional.style.display = 'none';
    }

    // --- CONFIGURAÇÃO DOS BOTÕES ORIGINAIS ---
    const btnMapa = document.getElementById('btnAbrirRotaDetalhe');
    const btnWpp = document.getElementById('btnChamarWpp');
    const btnCancel = document.getElementById('btnCancelarAgenda');
    const btnConcluir = document.getElementById('btnConcluirAgenda');

    // 1. Botão Mapa (Esconde se for manual)
    if (isManual) {
        btnMapa.style.display = 'none';
    } else if (dados.status !== 'concluido' && dados.status !== 'cancelado') {
        btnMapa.style.display = 'block';
        btnMapa.onclick = () => iniciarRastreamentoBusca(dados.clienteUid, nomeCliente, dados.id);
    } else {
        btnMapa.style.display = 'none';
    }

    // 2. Botão WhatsApp
    if (dados.telefone && dados.telefone.length > 8) {
        btnWpp.onclick = () => window.open(`https://wa.me/55${dados.telefone.replace(/\D/g,'')}`, '_blank');
        btnWpp.style.display = 'block';
    } else {
        btnWpp.style.display = 'none';
    }

    // 3. Botão Cancelar
    btnCancel.onclick = () => {
        if(confirm(`Cancelar agendamento de ${nomeCliente}?`)) {
            cancelarAgendamentoManualmente(dados.id, dados.clienteUid, valor);
            fecharModalAtual();
        }
    };

    // 4. Botão Concluir
    if (dados.status === 'concluido') {
        btnConcluir.textContent = "✅ JÁ CONCLUÍDO";
        btnConcluir.disabled = true;
        btnConcluir.style.opacity = "0.5";
        btnConcluir.style.background = "#333";
    } else {
        btnConcluir.textContent = "✅ CONCLUIR E RECEBER";
        btnConcluir.disabled = false;
        btnConcluir.style.opacity = "1";
        btnConcluir.style.background = "linear-gradient(45deg, #2ecc71, #27ae60)";
        
        btnConcluir.onclick = () => {
            fecharModalAtual();
            concluirAgendamento(dados.id, dados.clienteUid);
        };
    }
}

// 1. Abre a lista de serviços POR CIMA dos detalhes
async function abrirModalAdicionarServico() {
    const dadosAgendamento = window.agendamentoAtualDados;
    if (!dadosAgendamento || !dadosAgendamento.barbeiroUid) return exibirPopup("Erro", "Dados do agendamento perdidos.");

    exibirAguarde("Carregando serviços...");

    try {
        // Busca os serviços atualizados do profissional
        const docProf = await db.collection('usuarios').doc(dadosAgendamento.barbeiroUid).get();
        if (!docProf.exists) throw new Error("Profissional não encontrado.");
        
        const servicos = docProf.data().listaServicos || [];
        
        fecharTodosOsModais(true); // Fecha o 'Aguarde' mantendo os outros

        // --- CRIAÇÃO DINÂMICA DO MODAL 2 (LISTA) ---
        let modal = document.getElementById('modalAddServicoLista');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modalAddServicoLista';
            modal.className = 'modal';
            // Z-Index alto para ficar por cima dos Detalhes (que costuma ser 10000)
            modal.style.zIndex = '12000'; 
            document.body.appendChild(modal);
        }

        let htmlLista = '';
        if (servicos.length === 0) {
            htmlLista = '<p style="color:#aaa; text-align:center;">Nenhum serviço cadastrado.</p>';
        } else {
            servicos.forEach((s, index) => {
                htmlLista += `
                <div onclick="confirmarAdicaoServico('${s.nome}', ${s.valor}, ${s.duracao})" 
                     style="background:#222; border:1px solid #444; padding:15px; margin-bottom:8px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#fff; font-weight:bold;">${s.nome}</span>
                    <span style="color:#2ecc71;">R$ ${s.valor.toFixed(2)}</span>
                </div>`;
            });
        }

        modal.innerHTML = `
            <div class="modal-content" style="border: 2px solid #9b59b6; background:#111;">
                <h3 style="color:#fff;">➕ Adicionar Serviço</h3>
                <p style="color:#aaa; font-size:12px;">Isso será somado ao agendamento atual.</p>
                
                <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                    ${htmlLista}
                </div>

                <button onclick="abrirModalCriarNovoServicoAdicional()" style="width:100%; background: #333; border: 1px dashed #777; color: #fff; margin-bottom: 10px;">
                    ✨ Criar Novo Serviço Personalizado
                </button>

                <button onclick="fecharModalAdicional('modalAddServicoLista')" style="width:100%; background:transparent; color:#888;">Cancelar</button>
            </div>
        `;

        // Abre sem fechar o anterior
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);

    } catch (e) {
        fecharTodosOsModais(true);
        exibirPopup("Erro", e.message);
    }
}

// 2. Abre o formulário de criação POR CIMA da lista
function abrirModalCriarNovoServicoAdicional() {
    let modal = document.getElementById('modalCriarServicoFast');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalCriarServicoFast';
        modal.className = 'modal';
        modal.style.zIndex = '13000'; // Mais alto ainda
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal-content" style="border: 2px solid #fff;">
            <h3>✨ Criar Serviço Rápido</h3>
            
            <label>Nome do Serviço</label>
            <input id="inputFastNome" type="text" placeholder="Ex: Sobrancelha" style="width:100%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #444; color:#fff; border-radius:5px;">
            
            <label>Valor (R$)</label>
            <input id="inputFastValor" type="number" placeholder="0.00" style="width:100%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #444; color:#fff; border-radius:5px;">
            
            <label>Tempo Estimado (min)</label>
            <input id="inputFastTempo" type="number" placeholder="30" value="30" style="width:100%; padding:10px; margin-bottom:15px; background:#222; border:1px solid #444; color:#fff; border-radius:5px;">

            <button onclick="salvarServicoRapido()" style="width:100%; background:#27ae60; color:#fff; font-weight:bold; padding:12px; border-radius:8px; border:none;">💾 Criar e Adicionar</button>
            <button onclick="fecharModalAdicional('modalCriarServicoFast')" style="width:100%; background:transparent; color:#888; margin-top:10px;">Voltar</button>
        </div>
    `;

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

// 3. Salva o serviço no perfil e volta para a lista (ou adiciona direto)
async function salvarServicoRapido() {
    const nome = document.getElementById('inputFastNome').value;
    const valor = parseFloat(document.getElementById('inputFastValor').value);
    const duracao = parseInt(document.getElementById('inputFastTempo').value);

    if (!nome || isNaN(valor)) return alert("Preencha nome e valor.");

    exibirAguarde("Salvando...");

    try {
        const uidProf = window.agendamentoAtualDados.barbeiroUid;
        
        // Adiciona permanentemente ao perfil do profissional (opcional, mas recomendado pelo seu pedido)
        await db.collection('usuarios').doc(uidProf).update({
            listaServicos: firebase.firestore.FieldValue.arrayUnion({ nome, valor, duracao })
        });

        // Fecha o modal de criação e o aguarde
        const modalCriar = document.getElementById('modalCriarServicoFast');
        modalCriar.classList.remove('show');
        modalCriar.style.display = 'none';
        
        // Fecha o aguarde
        const aguarde = document.getElementById('popupAguarde');
        if(aguarde) aguarde.classList.remove('show');

        // Volta para o modal de lista recarregando-o
        abrirModalAdicionarServico();

    } catch (e) {
        alert("Erro ao criar: " + e.message);
    }
}

// 4. Executa a adição ao agendamento
async function confirmarAdicaoServico(nomeServico, valorServico, duracao) {
    const agendamentoId = window.agendamentoAtualId;
    if (!agendamentoId) return;

    exibirAguarde("Atualizando agendamento...");

    try {
        const docRef = db.collection('agendamentos').doc(agendamentoId);
        const doc = await docRef.get();
        if (!doc.exists) throw new Error("Agendamento não existe mais.");

        const dadosAtuais = doc.data();
        
        // Lógica de Soma
        const novoValor = (parseFloat(dadosAtuais.valor) || 0) + valorServico;
        // Concatena o nome: "Corte" -> "Corte + Barba"
        const novoNomeServico = `${dadosAtuais.servico} + ${nomeServico}`;

        await docRef.update({
            valor: novoValor,
            servico: novoNomeServico,
            // Atualiza valorOriginal também para manter coerência nas métricas
            valorOriginal: (parseFloat(dadosAtuais.valorOriginal) || 0) + valorServico 
        });

        // Atualiza as variáveis globais para refletir na tela
        window.agendamentoAtualDados.valor = novoValor;
        window.agendamentoAtualDados.servico = novoNomeServico;

        // Atualiza a UI do modal de detalhes (que está embaixo) em tempo real
        document.getElementById('detalheServico').textContent = novoNomeServico;
        document.getElementById('detalheValor').textContent = `R$ ${novoValor.toFixed(2)}`;

        // Fecha os modais sobrepostos
        fecharModalAdicional('modalAddServicoLista');
        fecharTodosOsModais(true); // Fecha o aguarde

        // Mostra confirmação
        if(typeof tocarSom === 'function') tocarSom('sucesso');
        
        // Opcional: Feedback visual rápido
        const btn = document.getElementById('btnServicoAdicional');
        if(btn) {
            btn.textContent = "✅ Adicionado!";
            setTimeout(() => btn.textContent = "➕ Serviço Adicional", 2000);
        }

    } catch (e) {
        fecharTodosOsModais(true);
        exibirPopup("Erro", "Falha ao adicionar: " + e.message);
    }
}

// Helper para fechar apenas o modal específico sem fechar tudo
function fecharModalAdicional(id) {
    const m = document.getElementById(id);
    if (m) {
        m.classList.remove('show');
        setTimeout(() => m.style.display = 'none', 300);
    }
}

async function gerarSlotsHorarios(uidProfissional, dadosUsuario = null) {
    if (!dadosUsuario) {
        const doc = await db.collection('usuarios').doc(uidProfissional).get();
        if (doc.exists) dadosUsuario = doc.data();
    }

    if (!dadosUsuario || !dadosUsuario.usaAgendaManual) {
        return '<div style="text-align:center; padding:10px; color:#555; font-size:10px; font-style:italic;">🚫 Agenda Programada Fechada</div>';
    }

    const snap = await db.collection('agendamentos')
        .where('barbeiroUid', '==', uidProfissional)
        .where('status', 'in', ['confirmado', 'conclusão pendente', 'pendente']) 
        .get();

    const ocupados = {};
    snap.forEach(doc => {
        const ag = doc.data();
        if(ag.horario) ocupados[ag.horario] = { id: doc.id, ...ag };
    });

    let html = '<div class="grid-horarios-mini">';
    
    let listaHorarios = [];
    if (dadosUsuario.agenda) {
        listaHorarios = Object.keys(dadosUsuario.agenda).filter(h => dadosUsuario.agenda[h] === true).sort();
    }
    
    if (listaHorarios.length === 0) {
         return '<div style="text-align:center; padding:10px; color:#555; font-size:10px;">Nenhum horário definido.</div>';
    }

    // PEGA CONFIG DE ALMOÇO
    const almocoInicio = dadosUsuario.horaAlmocoInicio;
    const almocoFim = dadosUsuario.horaAlmocoFim;

    listaHorarios.forEach(hora => {
        // VERIFICA SE É ALMOÇO
        let isAlmoco = false;
        if (almocoInicio && almocoFim) {
            if (hora >= almocoInicio && hora < almocoFim) isAlmoco = true;
        }

        const agendamento = ocupados[hora];
        
        if (isAlmoco) {
            // MOSTRA BLOQUEADO DE ALMOÇO
            html += `<div class="slot-time" style="background:#444; color:#aaa; border:1px dashed #777; cursor:not-allowed; opacity:0.7;">🍽️ Almoço</div>`;
        }
        else if (agendamento) {
            // OCUPADO POR CLIENTE
            const dadosJson = JSON.stringify({
                id: agendamento.id,
                clienteUid: agendamento.clienteUid,
                clienteNome: agendamento.clienteNome,
                barbeiroNome: agendamento.barbeiroNome,
                servico: agendamento.servico,
                valor: agendamento.valor,
                status: agendamento.status,
                telefone: agendamento.clienteTelefone,
                horario: hora
            }).replace(/"/g, '"');
            html += `<div class="slot-time slot-ocupado" onclick='abrirDetalhesDoAgendamento(${dadosJson})'>${hora}</div>`;
        } else {
            // LIVRE
            html += `<div class="slot-time slot-livre" onclick="prepararAgendamentoManual('${uidProfissional}', '${hora}')">${hora}</div>`;
        }
    });

    html += '</div>';
    return html;
}

async function toggleVagaImediataEquipe(uidTarget, estadoAtual) {
    exibirAguarde("Alterando status...");
    try {
        const novoStatus = !estadoAtual;
        
        // Atualiza no banco do funcionário
        await db.collection('usuarios').doc(uidTarget).update({
            vagaImediata: novoStatus
        });
        
        fecharTodosOsModais();
        // Recarrega a tela para ver a mudança de cor
        carregarVisaoGeralEquipe();
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível alterar: " + e.message);
    }
}

async function prepararAgendamentoManual(uidProf, horario) {
    // 1. Abre o modal
    abrirModal('modalCriarAgendamentoManual');
    
    // 2. Referências aos campos (Se o HTML estiver errado, aqui retorna null e causa o erro)
    const selectProf = document.getElementById('manualProfissionalUid');
    const inputCliente = document.getElementById('manualClienteNome');
    const inputHorarioVis = document.getElementById('manualHorarioVisual');
    const inputHorarioHid = document.getElementById('manualHorarioHidden');
    
    // 3. Limpa campos anteriores
    if(inputCliente) inputCliente.value = '';
    document.getElementById('manualServico').innerHTML = '<option>Carregando serviços...</option>';
    
    // 4. PREENCHE O HORÁRIO (Aqui dava o erro se o input não existisse)
    if (inputHorarioHid) inputHorarioHid.value = horario;
    if (inputHorarioVis) inputHorarioVis.value = `🕒 ${horario}`;
    
    // 5. PREENCHE O PROFISSIONAL
    selectProf.innerHTML = '<option>Carregando...</option>';
    
    try {
        let nomeProf = "Profissional";
        if (uidProf === auth.currentUser.uid) {
            nomeProf = `${perfil.nome} (Eu)`;
        } else {
            const doc = await db.collection('usuarios').doc(uidProf).get();
            if(doc.exists) nomeProf = doc.data().nome;
        }
        selectProf.innerHTML = `<option value="${uidProf}" selected>${nomeProf}</option>`;
    } catch (e) {
        console.error("Erro ao carregar nome:", e);
        selectProf.innerHTML = `<option value="${uidProf}" selected>Profissional</option>`;
    }

    // 6. CARREGA OS SERVIÇOS
    await atualizarOpcoesAgendamentoManual(uidProf);
}

// --- FUNÇÃO VISUAL DE RECOMPENSA FINAL ---
function exibirAnimacaoRecompensaFinal(totalPontos) {
    const overlay = document.getElementById('rewardOverlay');
    const pointsText = document.getElementById('rewardPointsTotal');
    
    // 1. Atualiza o texto com o total ganho
    if (pointsText) pointsText.textContent = `+${totalPontos}`;
    
    // 2. Mostra o overlay com a animação do CSS
    if (overlay) overlay.classList.add('show');

    // 3. Dispara os Confetes (usando a biblioteca que adicionamos)
    // Lança um jato de confetes dourados e vermelhos do centro
    confetti({
        particleCount: 150,
        spread: 100,
        origin: { y: 0.6 }, // Sai um pouco abaixo do centro
        colors: ['#FFD700', '#FFA500', '#FF4500', '#FFFFFF']
    });

    // 4. Esconde tudo automaticamente após 3.5 segundos
    setTimeout(() => {
        if (overlay) overlay.classList.remove('show');
    }, 3500);
}

// Abre o modal já preenchido
async function prepararAgendamentoManual(uidProf, horario) {
    // 1. Abre o modal primeiro para dar feedback visual
    abrirModal('modalCriarAgendamentoManual');
    
    // Referências aos campos
    const selectProf = document.getElementById('manualProfissionalUid');
    const inputHorarioVis = document.getElementById('manualHorarioVisual');
    const inputHorarioHid = document.getElementById('manualHorarioHidden');
    const displayHorario = document.getElementById('displayHorarioSelecionado');
    
    // Limpa campos anteriores
    document.getElementById('manualClienteNome').value = '';
    document.getElementById('manualServico').innerHTML = '<option>Carregando serviços...</option>';
    
    // --- LÓGICA DE SELEÇÃO DO PROFISSIONAL ---
    
    // Verifica se cliquei em MIM MESMO ou em OUTRO
    if (uidProf === auth.currentUser.uid) {
        // Sou eu
        selectProf.innerHTML = `<option value="${uidProf}" selected>${perfil.nome} (Eu)</option>`;
    } else {
        // É um membro da equipe: Busca o nome dele no banco para exibir corretamente
        try {
            const doc = await db.collection('usuarios').doc(uidProf).get();
            if (doc.exists) {
                const nomeMembro = doc.data().nome;
                selectProf.innerHTML = `<option value="${uidProf}" selected>${nomeMembro}</option>`;
            } else {
                selectProf.innerHTML = `<option value="${uidProf}" selected>Profissional</option>`;
            }
        } catch (e) {
            console.error("Erro ao buscar nome:", e);
            selectProf.innerHTML = `<option value="${uidProf}" selected>Membro da Equipe</option>`;
        }
    }
    
    // Trava o select para não mudar sem querer (já que você clicou na grade DELE)
    // Se quiser permitir mudar, remova a linha abaixo, mas pode causar confusão visual
    selectProf.disabled = false; 
    
    // 2. Define o Horário visual e oculto
    inputHorarioVis.value = horario; 
    inputHorarioHid.value = horario;
    if(displayHorario) displayHorario.textContent = `🕒 ${horario}`;
    
    // 3. Carrega os serviços daquele profissional específico
    await atualizarOpcoesAgendamentoManual(uidProf);
}

async function atualizarServicosManual(uid) {
    const selectServ = document.getElementById('manualServico');
    selectServ.innerHTML = '<option>Carregando...</option>';
    
    const doc = await db.collection('usuarios').doc(uid).get();
    const servicos = doc.data().listaServicos || [];
    
    selectServ.innerHTML = '';
    servicos.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.nome;
        opt.text = `${s.nome} - R$ ${s.valor}`;
        // Guarda valor no dataset pra usar depois
        opt.dataset.valor = s.valor; 
        selectServ.appendChild(opt);
    });
}

function salvarAgendamentoManual() {
    const uidProf = document.getElementById('manualProfissionalUid').value;
    const nomeProf = document.getElementById('manualProfissionalUid').options[0].text; // Simplificado
    const nomeCliente = document.getElementById('manualClienteNome').value;
    const servicoSelect = document.getElementById('manualServico');
    const nomeServico = servicoSelect.value;
    const valor = parseFloat(servicoSelect.options[servicoSelect.selectedIndex].dataset.valor);
    const horario = document.getElementById('manualHorarioHidden').value;

    if(!nomeCliente || !nomeServico) return alert("Preencha tudo.");

    // Salva no banco como "confirmado" direto
    db.collection('agendamentos').add({
        barbeiroUid: uidProf,
        barbeiroNome: nomeProf,
        clienteUid: 'manual', // Indica que foi criado manualmente
        clienteNome: nomeCliente + ' (Manual)',
        servico: nomeServico,
        valor: valor,
        horario: horario,
        status: 'confirmado',
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        fecharModalAtual();
        carregarVisaoGeralEquipe(); // Atualiza a grade
        alert("Agendado!");
    });
}

async function carregarMensagensAnteriores() {
    if (!oldestMessageSnapshot) {
        document.getElementById('carregarMaisMsgBtn').textContent = 'Fim do histórico';
        document.getElementById('carregarMaisMsgBtn').disabled = true; // Desabilita o botão
        return;
    }

    const btn = document.getElementById('carregarMaisMsgBtn');
    btn.textContent = 'Carregando...';
    btn.disabled = true;

    const agora = new Date();
    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");

    // --- FILTRO POR TIPO DE CHAT ---
    query = query.where("tipoChat", "==", chatAtual);
    // ---------------------------------

    if (chatAtual === 'local') {
        if (perfil.tipo === 'admin') {
            // Admin vê todas as locais, sem filtro de cidade para paginação também
        } else {
            // Usuário comum só pagina na sua cidade
            query = query.where("cidade", "==", perfil.cidade);
        }
    }

    // Continua com a paginação e expiração, ordenando por 'ts'
    query = query.where("deleteAt", ">", agora) // Filtra mensagens não expiradas
                 .orderBy("ts", "desc")         // Ordena pela mais recente primeiro
                 .startAfter(oldestMessageSnapshot) // Começa depois da última mensagem carregada
                 .limit(30);                     // Limite para mensagens anteriores

    try {
        const snapshot = await query.get();
        const chatContainer = document.getElementById("chatMessages");
        
        // Guarda a altura atual para manter a posição do scroll
        const scrollAntes = chatContainer.scrollHeight - chatContainer.scrollTop;

        if (snapshot.empty) {
            btn.textContent = 'Fim do histórico';
            oldestMessageSnapshot = null; // Marca que chegou ao fim
            btn.disabled = true; // Desabilita pois não há mais o que carregar
            return;
        }

        oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1]; // Atualiza o cursor da paginação

        // Inverte a ordem do snapshot (que veio DESC) para iterar (ASC)
        const docsEmOrdem = snapshot.docs.reverse();

        for (const doc of docsEmOrdem) {
            const msg = doc.data();
            const messageDiv = await createMessageDiv(msg, doc.id); // Passa o doc.id
            chatContainer.prepend(messageDiv); // ADICIONA NO TOPO (prepend)
        }

        // Tenta restaurar a posição do scroll relativa ao ponto onde estava
        chatContainer.scrollTop = chatContainer.scrollHeight - scrollAntes;

        btn.textContent = 'Ver mensagens anteriores';
        btn.disabled = false;

    } catch (error) {
        console.error("Erro ao carregar mensagens anteriores:", error);
        btn.textContent = 'Erro ao carregar';
        btn.disabled = false; // Permite tentar novamente
    }
 }

let listenerChatMapa = null;

// --- FUNÇÃO DO CHAT DO MAPA (VISUAL PREMIUM E PRIVADO) ---
async function abrirChatDoMapa() {
    // Validação de Segurança
    if (!chatTempId) {
        return exibirPopup("Erro", "ID do agendamento não encontrado. Tente reabrir o mapa.");
    }
    
    limparAlertaChatMapa();

    // Abre a Janela
    abrirModal('janelaChat');
    const modalChat = document.getElementById('janelaChat');
    // Força ficar na frente do mapa (Z-Index)
    if(modalChat) modalChat.style.zIndex = '25000'; 
    
    document.getElementById('chatTitle').textContent = "💬 Chat da Viagem";
    
    // Prepara Container
    const chatContainer = document.getElementById("chatMessages");
    chatContainer.innerHTML = "<div class='spinner' style='margin-top:20px;'></div>"; 

    // ESCONDE o botão de carregar mais (não precisa no chat temporário)
    const btnCarregarMais = document.getElementById('carregarMaisMsgBtn');
    if(btnCarregarMais) btnCarregarMais.style.display = 'none';

    // --- CONFIGURAÇÃO CRÍTICA DO ID ---
    // Define a variável global para que o 'enviarMensagem' mande pro lugar certo
    chatAtual = 'temp_' + chatTempId; 
    
    // --- CONFIGURAÇÃO DO INPUT (ENTER E BOTÃO) ---
    const input = document.getElementById("chatInput");
    // Clona para limpar eventos antigos do chat global
    const novoInput = input.cloneNode(true);
    input.parentNode.replaceChild(novoInput, input);
    
    // Adiciona evento de Enter
    novoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') enviarMensagem();
    });
    
    // Atualiza o botão de enviar visualmente
    const btnEnviar = document.querySelector('#janelaChat button[onclick^="enviarMensagem"]');
    if(btnEnviar) {
        btnEnviar.onclick = enviarMensagem;
        btnEnviar.innerHTML = "📍 Enviar";
    }

    // --- LISTENER DO CHAT PRIVADO ---
    if (chatListener) chatListener(); // Limpa anterior
    
    chatListener = db.collection("chats").doc(chatAtual).collection("mensagens")
        .orderBy("ts", "desc")
        .limit(50)
        .onSnapshot(async snapshot => {
            
            if(snapshot.empty) {
                chatContainer.innerHTML = "<p style='text-align:center; opacity:0.7; margin-top:20px;'>Chat da viagem iniciado.<br>Combine os detalhes!</p>";
                return;
            }

            // Pega as mensagens e inverte para ordem cronológica
            const docs = snapshot.docs.reverse();
            
            // Usa Promise.all para carregar molduras/fotos ANTES de mostrar
            // Isso evita mensagens em branco ou piscando
            const divs = await Promise.all(docs.map(doc => createMessageDiv(doc.data(), doc.id)));
            
            chatContainer.innerHTML = ""; // Limpa o loading
            divs.forEach(div => chatContainer.appendChild(div));
            
            // Rola para baixo suavemente
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 100);

        }, error => {
            console.error("Erro no chat do mapa:", error);
            chatContainer.innerHTML = "<p style='color:red; text-align:center;'>Erro de conexão.</p>";
        });
}

// --- FUNÇÃO DE ENVIAR (HÍBRIDA: GLOBAL + MAPA) ---
async function enviarMensagem() {
    if (!auth.currentUser) {
        exibirPopup("Para enviar mensagens, faça login.");
        mostrar('authView');
        fecharModalAtual();
        return;
    }
    if (isSending) return;
    
    const input = document.getElementById("chatInput");
    const texto = input.value.trim();
    if (!texto) return;
    
    // SEGURANÇA: Define para onde vai a mensagem
    // Se chatAtual for 'global' ou 'local' -> Vai para a coleção Global
    // Se chatAtual for 'temp_XXXX' -> Vai para a coleção do Mapa
    let docRefDestino = null;
    let isMapChat = false;

    if (chatAtual && chatAtual.startsWith('temp_')) {
        // É Chat do Mapa
        docRefDestino = db.collection("chats").doc(chatAtual).collection("mensagens");
        isMapChat = true;
    } else {
        // É Chat Global ou Local
        docRefDestino = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
        // Se chatAtual estiver nulo, força global
        if (!chatAtual) chatAtual = 'global';
    }

    isSending = true;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24h

    const messageData = {
        remetenteUid: auth.currentUser.uid,
        remetenteNome: perfil.nome,
        tipo: perfil.tipo,
        texto: texto,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: perfil.cidade || 'Global',
        
        // Se for mapa, tipoChat é 'mapa'. Se for global, é 'global'/'local'
        tipoChat: isMapChat ? 'mapa' : chatAtual, 
        
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    };

    try {
        await docRefDestino.add(messageData);
        input.value = ""; 
        
        // Bot de Suporte (Só responde no Chat Global)
        if (!isMapChat && chatAtual === 'global' && (texto.toLowerCase().includes('suporte') || texto.toLowerCase().includes('ajuda'))) { 
            setTimeout(enviarRespostaAI, 1000);
        }
    } catch (error) {
        console.error("Erro ao enviar:", error);
        exibirPopup("Erro ao enviar mensagem.");
    } finally {
        setTimeout(() => { isSending = false; }, 500);
    }
}

// --- FUNÇÃO QUE CRIA O VISUAL DA MENSAGEM (GLOBAL E MAPA) ---
async function createMessageDiv(msg, docId) {
    const messageDiv = document.createElement('div');
    const isCurrentUser = auth.currentUser && msg.remetenteUid === auth.currentUser.uid;
    
    // Define Lado (Esquerda/Direita)
    let classesDiv = `chat-message ${isCurrentUser ? "chat-sent" : "chat-received"}`;
    
    // Define ID para permitir deletar (Admin)
    if (docId) {
        messageDiv.dataset.docId = docId;
        if (perfil && perfil.tipo === 'admin' && msg.tipo !== 'bot' && msg.tipo !== 'ai_suporte') {
            messageDiv.onclick = () => adminDeletarMensagemChat(docId, msg.texto);
            messageDiv.title = 'Admin: Clique para deletar';
            messageDiv.classList.add('admin-deletable');
        }
    }

    let nomeSpanHtml = ''; 
    let balaoCustomClass = '';
    let conteudoTexto = msg.texto;

    // Caso seja BOT
    if (msg.tipo === "bot" || msg.tipo === "ai_suporte") {
        nomeSpanHtml = `<span style="color: #ff4757; font-weight:bold; text-shadow: 0 0 5px rgba(255, 71, 87, 0.4);">🤖 ${msg.tipo === "ai_suporte" ? 'Suporte AI' : 'King Bot'}</span>`;
        messageDiv.style.border = "1px solid #ff4757";
    } 
    else {
        // Tenta buscar dados atualizados do usuário para mostrar moldura/foto
        try {
            let u = null;
            // Otimização: usa cache local se for eu mesmo, senão busca no banco
            if (isCurrentUser && perfil) {
                u = perfil; 
            } else {
                const userDoc = await db.collection("usuarios").doc(msg.remetenteUid).get();
                if (userDoc.exists) u = userDoc.data();
            }

            if(u) {
                // 1. Balão (Background) - LÓGICA DO REI (Prioridade Máxima)
                if (u.isKing) {
                    balaoCustomClass = ' bubble-king custom-bubble';
                } 
                else if (u.balaoSelecionado && BALOES[u.balaoSelecionado]) {
                    balaoCustomClass = ' ' + BALOES[u.balaoSelecionado].classe + ' custom-bubble';
                }

                // 2. Foto + Moldura
                const fotoUrl = u.fotoPerfil || u.logo_url || '/icone.png';
                let avatarHtml = '';

                if (u.molduraSelecionada && MOLDURAS[u.molduraSelecionada]) {
                    const m = MOLDURAS[u.molduraSelecionada];
                    avatarHtml = `
                    <div class="avatar-wrapper chat-size ${u.molduraSelecionada}" onclick="event.stopPropagation(); abrirPerfilUsuarioChat('${msg.remetenteUid}')" style="cursor: pointer;">
                        <div class="coroa-topo"></div>
                        <img src="${fotoUrl}" class="chat-user-photo ${m.classe}" onerror="this.src='/icone.png'">
                    </div>`;
                } else {
                    avatarHtml = `<img src="${fotoUrl}" class="chat-user-photo" style="width:32px; height:32px; border-radius:50%; margin-right:8px; vertical-align:middle; border:1px solid #555; display:inline-block; object-fit:cover; cursor: pointer;" onclick="event.stopPropagation(); abrirPerfilUsuarioChat('${msg.remetenteUid}')" onerror="this.src='/icone.png'">`;
                }

                // 3. Nome (Cor baseada no tipo)
                let classeNome = "";
                if (u.tipo === "admin") classeNome = `admin-chat-red`; 
                else if (u.tipo === "cliente") classeNome = `cliente-chat`; 
                else classeNome = `barbeiro-chat`;

                // --- 4. GERAÇÃO DOS EMOJIS (BADGES) ---
                let badgesHtml = "";

                // A. REI DO DIA (Troféu)
                if (u.isKing) badgesHtml += '<span title="Rei do Dia" style="font-size:14px; margin-left:2px;">🏆</span>';

                // B. ADMIN / DEV (Cérebro)
                if (u.tipo === 'admin') badgesHtml += '<span title="Dev/Admin" style="font-size:14px; margin-left:2px;">🧠</span>';

                // C. VIP ou PRO
                if (isVipAtivo(u)) badgesHtml += '<span title="VIP" style="font-size:12px; margin-left:2px;">💎</span>';
                if (isProAtivo(u)) badgesHtml += '<span title="PRO" style="font-size:12px; margin-left:2px;">🌟</span>';

                // D. CONQUISTAS SELECIONADAS (As 3 escolhidas)
                if (u.conquistasSelecionadas && Array.isArray(u.conquistasSelecionadas)) {
                    // Pega todas as definições para buscar o ícone
                    const todasDefs = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
                    
                    u.conquistasSelecionadas.forEach(cId => {
                        const def = todasDefs[cId];
                        if (def && def.icone) {
                            // Adiciona o emoji da conquista
                            badgesHtml += `<span title="${def.nome}" style="font-size:12px; margin-left:2px;">${def.icone}</span>`;
                        }
                    });
                }

                // Monta o nome + badges clicável
                const nomeClicavel = `<span class="${classeNome}" onclick="event.stopPropagation(); abrirPerfilUsuarioChat('${msg.remetenteUid}')" style="cursor: pointer; font-weight: bold; vertical-align: middle; font-size: 13px;">
                    ${u.nome} ${badgesHtml}
                </span>`;
                
                nomeSpanHtml = `${avatarHtml} <div style="display:inline-block;">${nomeClicavel}</div>`;

            } else {
                // Fallback (Usuário não encontrado)
                nomeSpanHtml = `<div style="display:inline-block;"><img src="/icone.png" class="chat-user-photo" style="width:32px;"> <span style="color:#aaa;">${msg.remetenteNome || 'Usuário'}</span></div>`;
            }
        } catch (error) {
             console.log("Erro render msg:", error);
             nomeSpanHtml = `<span style="color:#fff;">${msg.remetenteNome}</span>`;
        }
    }

    messageDiv.className = classesDiv + balaoCustomClass;

    const timeString = msg.ts && msg.ts.toDate ? msg.ts.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '...';
    
    // Layout da mensagem
    messageDiv.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:4px; flex-wrap: nowrap;">${nomeSpanHtml}</div>
        <div style="padding-left: 2px; word-break: break-word; line-height: 1.4; font-size: 14px;">${conteudoTexto}</div>
        <div style="text-align: right; font-size: 9px; opacity: 0.6; margin-top: 2px;">${timeString}</div>
    `;

    return messageDiv;
}

// --- FUNÇÃO PARA EDITAR COMISSÃO (MATEMÁTICA AUTOMÁTICA) ---
async function editarComissao(uidMembro, nomeAtual, valorAtualProfissional) {
    // Pergunta focada no ganho do PROFISSIONAL
    const novoValor = prompt(
        `Definir comissão de ${nomeAtual}.\n\nQuanto % o PROFISSIONAL deve ganhar?\n(O restante ficará para o salão)`, 
        valorAtualProfissional
    );

    if (novoValor === null) return; // Cancelou

    // Trata o numero (troca virgula por ponto)
    let porcentagemProfissional = parseFloat(novoValor.replace(',', '.'));

    if (isNaN(porcentagemProfissional) || porcentagemProfissional < 0 || porcentagemProfissional > 100) {
        return alert("Por favor, digite um número válido entre 0 e 100.");
    }

    // A MÁGICA: O sistema usa 'taxaComissao' como a parte do SALÃO.
    // Então se o profissional ganha 60%, a taxa do salão é 40%.
    const taxaSalaoParaSalvar = 100 - porcentagemProfissional;

    exibirAguarde("Salvando nova comissão...");

    try {
        await db.collection('usuarios').doc(uidMembro).update({
            taxaComissao: taxaSalaoParaSalvar, // Salva a parte do dono
            comissao: taxaSalaoParaSalvar       // Mantém compatibilidade
        });

        fecharTodosOsModais();
        alert(`Sucesso!\nProfissional: ${porcentagemProfissional}%\nSalão: ${taxaSalaoParaSalvar}%`);
        
        // Reabre o painel para ver a mudança
        setTimeout(() => {
            if (typeof abrirGestaoMembroV2 === 'function') abrirGestaoMembroV2(uidMembro);
        }, 500);

    } catch (e) {
        fecharTodosOsModais();
        alert("Erro ao salvar: " + e.message);
    }
}

async function abrirPerfilUsuarioChat(uid) {
    let u = null;
    
    // Tenta pegar do cache local se for o próprio usuário para ser instantâneo
    if (auth.currentUser && uid === auth.currentUser.uid) {
        u = perfil;
    } else {
        // Busca dados frescos do banco
        const doc = await db.collection('usuarios').doc(uid).get();
        if(!doc.exists) return;
        u = doc.data();
    }
    
    const modalContent = document.querySelector('#modalVisualizarPerfilChat .perfil-visualizacao-content');
    
    // Limpa conteúdo e define fundo escuro chique
    modalContent.innerHTML = '';
    modalContent.parentElement.style.background = "radial-gradient(circle at top, #1a1a1a, #000)";
    
    // ============================================================
    // 1. ÁREA DE DESTAQUE (FOTO, NOME, DATA)
    // ============================================================
    
    const fotoUrl = u.fotoPerfil || u.logo_url || '/icone.png';
    let htmlFoto = '';

    // Verifica se tem moldura equipada
    if (u.molduraSelecionada && MOLDURAS[u.molduraSelecionada]) {
        const m = MOLDURAS[u.molduraSelecionada];
        htmlFoto = `
        <div class="luxury-avatar-bg">
            <div class="avatar-wrapper popup-size ${u.molduraSelecionada}" style="margin: 0;">
                <div class="coroa-topo"></div>
                <img id="visuPerfilFoto" src="${fotoUrl}" class="perfil-foto-grande ${m.classe}" onerror="this.src='/icone.png'" style="position:relative; z-index:2;">
            </div>
        </div>`;
    } else {
        htmlFoto = `
        <div class="luxury-avatar-bg">
            <img id="visuPerfilFoto" src="${fotoUrl}" class="perfil-foto-grande" style="width:120px; height:120px; border-radius:50%; border:3px solid #d4af37; padding:2px; position:relative; z-index:2; object-fit: cover;" onerror="this.src='/icone.png'">
        </div>`;
    }

    // Data de Cadastro (Prata)
    let dataStr = "Membro Recente";
    if (u.criadoEm) {
        let d;
        if (u.criadoEm.toDate) d = u.criadoEm.toDate();
        else if (u.criadoEm.seconds) d = new Date(u.criadoEm.seconds * 1000);
        if (d) dataStr = `Membro desde ${d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
    }

    // Tipo de Usuário (Cargo)
    let cargoHtml = '';
    if (u.tipo === 'admin') cargoHtml = '<span style="color:#e74c3c; font-size:10px; border:1px solid #e74c3c; padding:2px 6px; border-radius:4px;">ADMINISTRADOR</span>';
    else if (isVipAtivo(u)) cargoHtml = '<span style="color:#ffd700; font-size:10px; border:1px solid #ffd700; padding:2px 6px; border-radius:4px;">👑 MEMBRO VIP</span>';
    else if (isProAtivo(u)) cargoHtml = `<span style="color:#00c6ff; font-size:10px; border:1px solid #00c6ff; padding:2px 6px; border-radius:4px;">🌟 PROFISSIONAL ${u.proTier ? u.proTier.toUpperCase().replace('TIER', '') : ''}</span>`;
    else cargoHtml = '<span style="color:#aaa; font-size:10px;">Visitante</span>';

    modalContent.innerHTML += `
        <div style="text-align:center; padding-top:20px;">
            ${htmlFoto}
            <h3 class="text-shine-gold" style="font-size:22px; margin:15px 0 5px 0;">${u.nome}</h3>
            ${cargoHtml}
            <span class="text-silver-date">${dataStr}</span>
        </div>
    `;

    // ============================================================
    // 2. CONQUISTAS SELECIONADAS (3 PRINCIPAIS) - CORRIGIDO
    // ============================================================
    
    // CORREÇÃO: Verifica se é array antes de tentar ler
    const selecionadasSeguras = Array.isArray(u.conquistasSelecionadas) ? u.conquistasSelecionadas : [];
    
    if (selecionadasSeguras.length > 0) {
        const todasDefs = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
        let htmlBadges = '<div style="display: flex; justify-content: center; gap: 20px; margin: 25px 0 10px 0;">';
        
        selecionadasSeguras.forEach(cId => {
            const def = todasDefs[cId];
            if (def) {
                htmlBadges += `
                    <div style="text-align: center; width: 60px; animation: pulse-glow 3s infinite;">
                        <div style="font-size: 32px; margin-bottom: 5px; filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6));">${def.icone}</div>
                        <div style="font-size: 9px; color: #fff; font-weight:bold; line-height: 1.1;">${def.nome.split(' ')[0]}</div>
                    </div>
                `;
            }
        });
        htmlBadges += '</div>';
        modalContent.innerHTML += htmlBadges;
    }

    // ============================================================
    // 3. COLEÇÃO COMPLETA (SCROLL HORIZONTAL)
    // ============================================================

    // A. TODAS AS CONQUISTAS
    const conquistas = Array.isArray(u.conquistas) ? u.conquistas : [];
    
    if (conquistas.length > 0) {
        const todasDefs = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
        let htmlList = '<div class="luxury-section-title">🏆 Galeria de Troféus</div><div class="luxury-scroll">';
        
        conquistas.forEach(cId => {
            if(todasDefs[cId]) {
                htmlList += `
                <div class="mini-collection-item">
                    <span>${todasDefs[cId].icone}</span>
                    <p>${todasDefs[cId].nome}</p>
                </div>`;
            }
        });
        htmlList += '</div>';
        modalContent.innerHTML += htmlList;
    }

    // B. TODAS AS MOLDURAS
    let molduras = Array.isArray(u.moldurasAdquiridas) ? u.moldurasAdquiridas : [];
    
    if(u.tipo === 'admin') {
        if(!molduras.includes('admin_black')) molduras.push('admin_black');
        if(!molduras.includes('admin_red')) molduras.push('admin_red');
    }

    if (molduras.length > 0) {
        let htmlFrames = '<div class="luxury-section-title">🖼️ Molduras de Acervo</div><div class="luxury-scroll">';
        
        molduras.forEach(mId => {
            if (MOLDURAS[mId]) {
                const isEquipped = u.molduraSelecionada === mId;
                const borderStyle = isEquipped ? 'border: 1px solid #d4af37;' : '';
                
                htmlFrames += `
                <div class="mini-collection-item" style="${borderStyle}">
                    <div class="mini-frame-preview ${MOLDURAS[mId].classe}" style="width:30px; height:30px; transform: scale(0.8); background:transparent;"></div>
                    <p>${MOLDURAS[mId].nome}</p>
                </div>`;
            }
        });
        htmlFrames += '</div>';
        modalContent.innerHTML += htmlFrames;
    }

    // C. TODOS OS BALÕES
    let baloes = Array.isArray(u.baloesAdquiridos) ? u.baloesAdquiridos : [];
    
    if(u.tipo === 'admin') {
        if(!baloes.includes('admin_black')) baloes.push('admin_black');
        if(!baloes.includes('admin_red')) baloes.push('admin_red');
    }

    if (baloes.length > 0) {
        let htmlBubbles = '<div class="luxury-section-title">💬 Estilos de Chat</div><div class="luxury-scroll">';
        
        baloes.forEach(bId => {
            if (BALOES[bId]) {
                const isEquipped = u.balaoSelecionado === bId;
                const borderStyle = isEquipped ? 'border: 1px solid #d4af37;' : '';
                
                htmlBubbles += `
                <div class="mini-collection-item" style="${borderStyle}">
                    <div class="chat-message ${BALOES[bId].classe} custom-bubble" style="width:20px; height:15px; font-size:8px; display:flex; align-items:center; justify-content:center; margin:0 auto 5px auto;">Aa</div>
                    <p>${BALOES[bId].nome.replace('Chat ', '')}</p>
                </div>`;
            }
        });
        htmlBubbles += '</div>';
        modalContent.innerHTML += htmlBubbles;
    }

    // ============================================================
    // 4. RODAPÉ (BOTÕES)
    // ============================================================
    
    let btnsHtml = '<div style="margin-top:30px; display:flex; gap:10px; justify-content:center;">';
    btnsHtml += `<button onclick="fecharModalAtual()" style="background:rgba(255,255,255,0.1); border:1px solid #555; color:#fff; width:100%;">Fechar Perfil</button>`;
    
    // Botões Extras para Admin
    if (perfil && perfil.tipo === 'admin' && uid !== auth.currentUser.uid) {
        if(u.telefone) {
            btnsHtml += `<button onclick="abrirWhatsApp('${u.telefone}')" style="background-color:#25D366; width:100%;">WhatsApp</button>`;
        }
        btnsHtml += `<button onclick="fecharModalAtual(); abrirModalGerenciarUsuario('${uid}')" style="background:#e74c3c; width:100%;">Gerenciar</button>`;
    }
    btnsHtml += '</div>';
    
    modalContent.innerHTML += btnsHtml;
    
    abrirModal('modalVisualizarPerfilChat');
}

async function adminAbrirInfoChat(uid) {
    exibirAguarde("Buscando dados do usuário...");
    
    const modal = document.getElementById('modalAdminInfoChat');
    const nomeEl = modal.querySelector('#adminInfoChatNome');
    const conteudoEl = modal.querySelector('#adminInfoChatConteudo');
    const btnWpp = modal.querySelector('#adminInfoChatBtnWpp');
    const btnGerenciar = modal.querySelector('#adminInfoChatBtnGerenciar');

    try {
        const userDoc = await db.collection('usuarios').doc(uid).get();
        if (!userDoc.exists) {
            throw new Error("Usuário não encontrado.");
        }
        const u = userDoc.data();

        nomeEl.textContent = u.nome;
        conteudoEl.innerHTML = `
            <p><strong>Email:</strong> ${u.email}</p>
            <p><strong>Telefone:</strong> ${u.telefone || 'N/A'}</p>
            <p><strong>Tipo:</strong> ${u.tipo}</p>
            <p><strong>Cidade/Estado:</strong> ${u.cidade || 'N/A'} - ${u.estado || 'N/A'}</p>
            <p><strong>Saldo:</strong> R$ ${(u.saldo || 0).toFixed(2)}</p>
            <p><strong>VIP:</strong> ${isVipAtivo(u) ? 'Sim' : 'Não'}</p>
            <p><strong>PRO:</strong> ${isProAtivo(u) ? `Sim (Tier: ${u.proTier})` : 'Não'}</p>
        `;

        if (u.telefone) {
            btnWpp.onclick = () => abrirWhatsApp(u.telefone);
            btnWpp.disabled = false;
        } else {
            btnWpp.onclick = null;
            btnWpp.disabled = true;
        }
        
        btnGerenciar.onclick = () => {
            fecharModalAtual(); // Fecha o modal de info
            abrirModalGerenciarUsuario(uid); // Abre o de gerenciamento completo
        };

        fecharTodosOsModais(); // Fecha o "aguarde"
        abrirModal('modalAdminInfoChat');

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível carregar os dados: " + error.message, 'erro');
    }
}

async function adminDeletarMensagemChat(docId, textoMensagem) {
    if (!docId) return;
    
    const confirmacao = confirm(`ADMIN: Deseja deletar permanentemente esta mensagem?\n\n"${textoMensagem.substring(0, 100)}..."`);
    
    if (confirmacao) {
        exibirAguarde("Deletando mensagem...");
        try {
            const msgRef = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").doc(docId);
            await msgRef.delete();
            fecharTodosOsModais();
            // O listener do 'alternarChat' (com a lógica 'removed')
            // cuidará de remover a mensagem da tela.
            console.log(`[Admin] Mensagem ${docId} deletada.`);
        } catch (error) {
            fecharTodosOsModais();
            console.error("Erro ao deletar mensagem:", error);
            exibirPopup("Erro", "Não foi possível deletar a mensagem: " + error.message);
        }
    }
}

function sendBotMessage() {
    let randomIndex;
    do { randomIndex = Math.floor(Math.random() * botMessages.length); } while (randomIndex === lastBotMessageIndex);
    lastBotMessageIndex = randomIndex;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "bot-uid", remetenteNome: "King Agenda Bot", tipo: "bot",
        texto: botMessages[randomIndex], ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: "global", // Mensagem do bot é global
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    });
}

// ADICIONE ESTA NOVA FUNÇÃO
function handleChatEnter(event) {
    // Verifica se a tecla pressionada foi "Enter" e se a tecla Shift NÃO estava pressionada
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault(); // Impede a quebra de linha
        enviarMensagem(); // Chama a função de enviar
    }
}

// SUBSTITUA A FUNÇÃO enviarRespostaAI INTEIRA POR ESTA:
function enviarRespostaAI() {
    // A constante WHATSAPP_ADM_PHONE já deve estar definida no topo do seu script
    const mensagemPreEscrita = encodeURIComponent("Olá! Preciso de ajuda/suporte com o app King Agenda.");
    const whatsappLink = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagemPreEscrita}`;

    const resposta = `Olá! Sou a assistente virtual. <br><br>
        • Se você precisa de ajuda ou suporte de um administrador, a forma mais rápida é pelo WhatsApp. <br>
        • <a href="${whatsappLink}" target="_blank" style="color: var(--cor-destaque);">Clique aqui para falar com o suporte agora.</a> <br><br>
        • Se for uma dúvida geral sobre o app, tente perguntar aqui.`;
        
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "ai-suporte-uid",
        remetenteNome: "Suporte AI",
        tipo: "ai_suporte",
        texto: resposta,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: "global", // Resposta de suporte é sempre no global
        tipoChat: "global",
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    });
}

// Funções novas para o admin no chat
function adminCarregarCidadesChat() {
    const estado = document.getElementById('adminChatEstado').value;
    const cidadeSelect = document.getElementById('adminChatCidade');
    const valorAtual = cidadeSelect.value;
    cidadeSelect.innerHTML = '<option value="">Selecione a cidade</option>';
    const cidades = cidadesPorEstado[estado] || [];
    cidades.forEach(c => {
        // Seleciona a cidade do perfil do admin por padrão na primeira vez
        const isSelected = c === valorAtual || (c === perfil.cidade && !valorAtual);
        cidadeSelect.innerHTML += `<option value="${c}" ${isSelected ? 'selected' : ''}>${c}</option>`;
    });
    // Após carregar as cidades, se for um admin, recarrega o chat
    if(perfil.tipo === 'admin') {
        adminRecarregarChat();
    }
}

function adminRecarregarChat() {
    // Simplesmente chama a função de alternar, que agora contém a lógica 
    // para ler os selects do admin e carregar as mensagens da cidade escolhida.
    alternarChat('local');
}

function criarAviso(uid, mensagem, tipo = 'geral', agendamentoId = null) {
  const avisoData = { usuarioUid: uid, mensagem, tipo, lido: false, ts: firebase.firestore.FieldValue.serverTimestamp() };
  if (agendamentoId) avisoData.agendamentoId = agendamentoId;
  db.collection("avisos").add(avisoData);
}

function abrirModalComConfirmacao(modalId, tituloPopupConfirmacao = undefined, mensagemPopupConfirmacao = undefined) {
    abrirModal(modalId);
    const modalElement = document.getElementById(modalId);
    // Encontra o botão de fechar padrão (que usa data-modal-id)
    const btnFecharPadrao = modalElement.querySelector(`button[data-modal-id="${modalId}"]`);
    if (btnFecharPadrao) {
        // Modifica o onclick para chamar a confirmação
        btnFecharPadrao.onclick = () => pedirConfirmacaoFecharPopup(modalId, tituloPopupConfirmacao, mensagemPopupConfirmacao);
    }
    // Adiciona a confirmação ao clique no fundo também (se o modal permitir fechar no fundo)
    modalElement.onclick = (event) => {
        if (event.target.id === modalId) { // Clicou no fundo
            pedirConfirmacaoFecharPopup(modalId, tituloPopupConfirmacao, mensagemPopupConfirmacao);
        }
    };
    // Impede que cliques dentro do conteúdo fechem (já feito no seu modal-content)
    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
        modalContent.onclick = (event) => event.stopPropagation();
    }
}

function enviarDenuncia() {
  const texto = document.getElementById("textoDenuncia").value.trim();
  if (!texto) return exibirPopup("Por favor, descreva o problema.");
  db.collection("denuncias").add({
    usuarioUid: auth.currentUser.uid, usuarioNome: perfil.nome, texto,
    status: "aberta", ts: firebase.firestore.FieldValue.serverTimestamp()
  }).then(denunciaRef => {
    abrirModal('modalDenunciaEnviada');
    const mensagem = encodeURIComponent(`🚨 Nova denúncia no app. ID: ${denunciaRef.id}\n\nDe: ${perfil.nome}\n\nDescrição: ${texto}`);
    document.getElementById("btnWhatsappDenuncia").href = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`;
    document.getElementById("textoDenuncia").value = "";
    notifyAdmins("🚨 Nova Denúncia!", `Uma nova denúncia foi enviada por ${perfil.nome}.`, { link: '#denuncias' });
  }).catch(e => exibirPopup("Erro ao enviar denúncia: " + e.message));
}

function abrirServicos() {
  abrirModal('modalServicosBarbeiro');
  listarServicos(); // Apenas lista os serviços
}

function listarServicos() {
  const lista = document.getElementById("listaServicosBarbeiro");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    perfil = doc.data();
    lista.innerHTML = "";
    if (!perfil.listaServicos || perfil.listaServicos.length === 0) {
      lista.innerHTML = "<p>Nenhum serviço cadastrado.</p>";
      return;
    }
    perfil.listaServicos.forEach((s, index) => {
      lista.innerHTML += `<div class="card">${s.nome} - R$ ${s.valor.toFixed(2)} ${s.duracao ? `(${s.duracao} min)` : ''}<button onclick="removerServico(${index})" style="float:right">❌</button></div>`;
    });
  });
}

function iniciarFluxoPosCadastroProfissional() {
    fluxoPosCadastroAtivo = true;
    // Abre o primeiro modal (Logomarca) com a opção de confirmação ao fechar
    abrirModalComConfirmacao('modalLogomarca', '🎨 Adicionar Logomarca');
}

function adicionarServico() {
  // Limpa os campos do modal e define o título para "Adicionar"
  document.getElementById('modalAddServicoTitulo').textContent = 'Adicionar Novo Serviço';
  document.getElementById('addServicoNome').value = '';
  document.getElementById('addServicoValor').value = '';
  document.getElementById('addServicoTempo').value = '';
  
  // Define o botão para chamar a função de salvar (sem índice)
  document.getElementById('btnSalvarServico').onclick = () => salvarServico();
  
  abrirModal('modalAddServico');
}

// ESTA É UMA NOVA FUNÇÃO (cole junto com as outras funções do profissional)
function salvarServico() {
  const nome = document.getElementById("addServicoNome").value;
  const valor = parseFloat(document.getElementById("addServicoValor").value);
  const duracao = parseInt(document.getElementById("addServicoTempo").value);
  
  if (!nome || isNaN(valor) || valor <= 0 || isNaN(duracao) || duracao <= 0) {
      return exibirPopup("Entrada inválida.", "Por favor, preencha nome, valor (Ex: 25.50) e duração (Ex: 30).");
  }

  exibirAguarde("Salvando...");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayUnion({ nome, valor, duracao })
  }).then(() => {
    fecharTodosOsModais(); // Fecha o "aguarde"
    fecharModalAtual(); // Fecha o modal "modalAddServico"
    exibirPopup("Sucesso!", "Serviço adicionado!");
    // listarServicos() será chamado automaticamente pelo onSnapshot em modalServicosBarbeiro
  }).catch(e => {
    fecharTodosOsModais();
    exibirPopup("Erro: " + e.message);
  });
}

function removerServico(index) {
  const servicoParaRemover = perfil.listaServicos[index];
  if (!confirm(`Deseja remover "${servicoParaRemover.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayRemove(servicoParaRemover)
  }).then(() => exibirPopup("Serviço removido!")).catch(e => exibirPopup("Erro: " + e.message));
}

async function verificarCheckInDiario(usuario) {
    const btn = document.getElementById('btnCheckInManual');
    if(btn) btn.style.display = 'none';

    // PROTEÇÃO CRÍTICA: Se não tem usuário ou não tem UID, para tudo.
    if (!usuario || !auth.currentUser || !auth.currentUser.uid) return;

    if (!usuario) return;

    console.log("Verificando Check-in Diário...");

    const hoje = new Date().toDateString(); 
    const ultimoCheckIn = usuario.ultimoCheckInDate; 
    
    // 1. Se já fez check-in hoje, apenas atualiza o ícone visual e sai
    if (ultimoCheckIn === hoje) {
        console.log("Check-in já realizado hoje.");
        atualizarIconeFogo(usuario.diasSeguidos || 1);
        return;
    }

    // 2. Calcula data de ontem para verificar sequência
    const ontem = new Date();
    ontem.setDate(ontem.getDate() - 1);
    const ontemString = ontem.toDateString();

    let novosDias = 1;
    let premioTitulo = "+5 Pontos";
    let premioDesc = "Recompensa Diária";
    let pontosGanhos = 5;
    let ehDia7 = false;
    let resetarCiclo = false;
    
    // 3. Lógica de Sequência
    // Se o último check-in foi ontem, incrementa.
    // Se for null (primeira vez) ou data antiga, começa do 1.
    if (ultimoCheckIn === ontemString) {
        novosDias = (usuario.diasSeguidos || 0) + 1;
    } 

    // --- LÓGICA DO DIA 7 (O GRANDE PRÊMIO) ---
    if (novosDias >= 7) {
        ehDia7 = true;
        pontosGanhos = 10;
        resetarCiclo = true; // Marca para resetar visualmente AMANHÃ
        
        // Define prêmios específicos
        if (usuario.tipo === 'cliente') {
            premioTitulo = "🔥 7 DIAS! PRÊMIO VIP!";
            premioDesc = "+10 Pontos & 2 Dias de VIP Grátis";
            
            // Calcula VIP
            let novaExpiracao = new Date();
            if (isVipAtivo(usuario) && usuario.vipExpirationDate) {
                // Se tem VIP, converte data segura
                const atualVip = usuario.vipExpirationDate.toDate ? usuario.vipExpirationDate.toDate() : new Date(usuario.vipExpirationDate);
                if (atualVip > new Date()) novaExpiracao = atualVip;
            }
            novaExpiracao.setDate(novaExpiracao.getDate() + 2); // +2 Dias
            
            // Atualiza VIP no banco imediatamente
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                vip: true,
                vipExpirationDate: firebase.firestore.Timestamp.fromDate(novaExpiracao)
            });

        } else {
            premioTitulo = "🔥 7 DIAS! DESTAQUE TOTAL!";
            premioDesc = "+10 Pontos & 24h de Perfil Turbinado";
            
            let novaExpiracaoBoost = new Date();
            if (usuario.boostExpiracao) {
                const atualBoost = usuario.boostExpiracao.toDate ? usuario.boostExpiracao.toDate() : new Date(usuario.boostExpiracao);
                if (atualBoost > new Date()) novaExpiracaoBoost = atualBoost;
            }
            novaExpiracaoBoost.setHours(novaExpiracaoBoost.getHours() + 24); // +24h

            db.collection('usuarios').doc(auth.currentUser.uid).update({
                boostExpiracao: firebase.firestore.Timestamp.fromDate(novaExpiracaoBoost),
                ultimoBoostComprado: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } else {
        // Dias 1 a 6
        premioTitulo = `+5 Pontos`;
        premioDesc = `Sequência: ${novosDias} dias`;
    }

    try {
        // Atualiza Pontos e Datas no Banco
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            ultimoCheckInDate: hoje,
            diasSeguidos: resetarCiclo ? 0 : novosDias, // Se completou 7, salva 0 para amanhã ser dia 1
            pontosFidelidade: firebase.firestore.FieldValue.increment(pontosGanhos)
        });
        
        // Atualiza variável local para refletir na hora
        perfil.diasSeguidos = ehDia7 ? 7 : novosDias; 
        perfil.ultimoCheckInDate = hoje;
        perfil.pontosFidelidade = (perfil.pontosFidelidade || 0) + pontosGanhos;
        
        // Atualiza visual do Fogo
        atualizarIconeFogo(ehDia7 ? 7 : novosDias);

        // Preenche e Abre o Modal
        document.getElementById('txtDiasSeguidos').textContent = `${ehDia7 ? 7 : novosDias}/7`;
        document.getElementById('txtRecompensaCheckInTitulo').textContent = premioTitulo;
        document.getElementById('txtRecompensaCheckInDesc').textContent = premioDesc;
        
        tocarSom('sucesso');
        abrirModal('modalCheckIn');
        
        if (ehDia7 && typeof confetti === 'function') {
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 }, zIndex: 20000 });
        }

    } catch (e) {
        console.error("Erro no check-in:", e);
    }
}

// 1. Verifica se o plano venceu toda vez que o perfil carrega
async function verificarValidadePlano(usuario, uid) {
    if (!usuario.proAtivo) return; // Se não é PRO, não precisa checar

    if (!usuario.proExpirationDate) return; // Se não tem data (vitalício ou erro), ignora

    const agora = new Date();
    let dataExpiracao;

    // Converte o Timestamp do Firebase para Objeto Date JS
    if (usuario.proExpirationDate.toDate) {
        dataExpiracao = usuario.proExpirationDate.toDate();
    } else if (usuario.proExpirationDate.seconds) {
        dataExpiracao = new Date(usuario.proExpirationDate.seconds * 1000);
    } else {
        dataExpiracao = new Date(usuario.proExpirationDate); // Tenta string ISO
    }

    // SE VENCEU (Data de expiração é menor que agora)
    if (dataExpiracao < agora) {
        console.log("🚫 Plano PRO expirado! Iniciando limpeza...");
        
        exibirPopup("Plano Expirado", "Sua assinatura PRO ou VIP chegou ao fim. As funções exclusivas foram bloqueadas e seus destaques removidos.", "aviso");

        // 1. Atualiza o banco para Inativo
        await db.collection('usuarios').doc(uid).update({
            proAtivo: false,
            proTier: null,
            vip: false // Remove VIP também se tiver expirado junto (ajuste conforme sua lógica de datas separadas se precisar)
        });

        // 2. Se ele era Tier 4, faz a limpeza pesada (Em Alta + Stories)
        if (usuario.proTier === 'tier4') {
            await limparResquiciosTier4(uid);
        }
    } 
    // SE AINDA É PRO, MAS NÃO É MAIS TIER 4 (Downgrade manual ou erro)
    else if (usuario.proAtivo && usuario.proTier !== 'tier4') {
        // Garante que não tenha nada no "Em Alta" ou Stories indevidamente
        // (Isso roda em background para garantir a integridade)
        limparResquiciosTier4(uid); 
    }
}

// 2. A Faxineira: Apaga Stories e remove do Em Alta
async function limparResquiciosTier4(uid) {
    console.log("🧹 Executando limpeza de Tier 4...");
    const batch = db.batch();
    let temAlgoParaDeletar = false;

    try {
        // A. Busca e deleta STORIES ativos
        const storiesSnap = await db.collection('stories').where('usuarioUid', '==', uid).get();
        storiesSnap.forEach(doc => {
            batch.delete(doc.ref);
            temAlgoParaDeletar = true;
        });

        // B. Busca e deleta fotos do EM ALTA
        const emAltaSnap = await db.collection('batalha_likes').where('ownerUid', '==', uid).get();
        emAltaSnap.forEach(doc => {
            batch.delete(doc.ref);
            temAlgoParaDeletar = true;
        });

        // Executa a limpeza em lote
        if (temAlgoParaDeletar) {
            await batch.commit();
            console.log("✅ Limpeza concluída: Stories e Em Alta removidos.");
        }

    } catch (e) {
        console.error("Erro na limpeza automática:", e);
    }
}

function atualizarIconeFogo(dias) {
    // Encontra o botão de perfil na topbar (o botão com emoji 👤)
    // Procuramos pelo onclick pois ele não tem ID fixo no seu HTML original
    const btnPerfil = document.querySelector('.topbar-right button[onclick="abrirModalPerfil()"]');
    
    if (btnPerfil) {
        // Verifica se já criamos o badge antes
        let badge = document.getElementById('badgeFogoStreak');
        
        if (!badge) {
            badge = document.createElement('span');
            badge.id = 'badgeFogoStreak';
            // Insere DENTRO do botão de perfil
            btnPerfil.appendChild(badge);
        }
        
        // Atualiza o texto: 🔥 + Dias
        badge.innerHTML = `🔥 ${dias}`;
    }
}

// --- VARIÁVEIS GLOBAIS DA BATALHA ---
let cacheBatalha = [];
let dueloAtual = { A: null, B: null };
let travaVoto = false;
let votosSession = 0;
let pontosAcumuladosBatalha = 0;

// 1. INICIAR E CARREGAR DADOS
async function abrirModalBatalha() {
    abrirModal('modalBatalha');
    const loading = document.getElementById('loadingBatalha');
    if (loading) loading.style.display = 'flex';

    // --- CONTADOR DIÁRIO ---
    const hoje = new Date().toLocaleDateString();
    const dataSalva = localStorage.getItem('batalha_data_voto');
    if (dataSalva !== hoje) {
        localStorage.setItem('batalha_votos_hoje', '0');
        localStorage.setItem('batalha_data_voto', hoje);
    }
    const votosHoje = parseInt(localStorage.getItem('batalha_votos_hoje') || '0');
    const countEl = document.getElementById('contadorVotosSession');
    if (countEl) {
        countEl.textContent = `${votosHoje}/75`;
        countEl.style.color = votosHoje >= 75 ? '#e74c3c' : 'var(--cor-destaque)';
    }

    // --- CARREGA COMPETIDORES E LIKES ---
    if (cacheBatalha.length < 5) {
        try {
            console.log("Carregando do Em Alta...");
            const snap = await db.collection('batalha_likes')
                .where('ownerTier', '==', 'tier4') 
                .limit(100) 
                .get();

            cacheBatalha = [];
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.imgUrl) {
                    cacheBatalha.push({
                        uid: d.ownerUid,
                        nome: d.ownerName,
                        tier: d.ownerTier,
                        url: d.imgUrl,
                        imgId: doc.id,
                        totalLikes: d.count || 0 // <--- AQUI PEGAMOS OS LIKES REAIS
                    });
                }
            });
        } catch (e) { console.error("Erro busca:", e); }
    }

    if (cacheBatalha.length < 2) {
        fecharModalAtual();
        exibirPopup("Poucas fotos", "O painel precisa de mais fotos Diamante.");
        return;
    }

    iniciarRoundInicial();
    if (loading) loading.style.display = 'none';
}

// 2. ROUND INICIAL (Sorteia A e B)
function iniciarRoundInicial() {
    let p1 = pegarAleatorio();
    let p2 = pegarAleatorio();
    let tentativas = 0;
    while (p1.imgId === p2.imgId && tentativas < 50) {
        p2 = pegarAleatorio();
        tentativas++;
    }
    dueloAtual.A = p1;
    dueloAtual.B = p2;
    renderizarBatalha();
}

function pegarAleatorio() {
    if (cacheBatalha.length === 0) return null;
    return cacheBatalha[Math.floor(Math.random() * cacheBatalha.length)];
}

function renderizarBatalha() {
    if (!dueloAtual.A || !dueloAtual.B) { iniciarRoundInicial(); return; }
    
    // Renderiza A
    const imgA = document.getElementById('imgBatalhaA');
    const nomeA = document.getElementById('nomeBatalhaA');
    const likeA = document.getElementById('likesBatalhaA'); // Novo elemento de like
    
    if (imgA) imgA.src = dueloAtual.A.url;
    if (nomeA) nomeA.textContent = dueloAtual.A.nome;
    if (likeA) likeA.textContent = dueloAtual.A.totalLikes; // Mostra likes reais
    
    // Renderiza B
    const imgB = document.getElementById('imgBatalhaB');
    const nomeB = document.getElementById('nomeBatalhaB');
    const likeB = document.getElementById('likesBatalhaB'); // Novo elemento de like
    
    if (imgB) imgB.src = dueloAtual.B.url;
    if (nomeB) nomeB.textContent = dueloAtual.B.nome;
    if (likeB) likeB.textContent = dueloAtual.B.totalLikes; // Mostra likes reais
    
    document.querySelectorAll('.voto-animacao').forEach(el => el.classList.remove('show'));
}

// 3. FUNÇÃO DE VOTAR (LÓGICA DE RECOMPENSA 5 VOTOS = 1 PONTO)
async function votarBatalha(escolha) {
    if (!dueloAtual.A || !dueloAtual.B) { iniciarRoundInicial(); return; }
    if (!auth.currentUser) { exibirPopup("Atenção", "Faça login para votar."); return; }
    if (travaVoto) return;
    
    travaVoto = true;
    setTimeout(() => { travaVoto = false; }, 1200); 

    // --- 1. EFEITO VISUAL IMEDIATO NO LIKE (+1 NA TELA) ---
    if (escolha === 'A') {
        dueloAtual.A.totalLikes = (dueloAtual.A.totalLikes || 0) + 1;
        const el = document.getElementById('likesBatalhaA');
        if (el) {
            el.textContent = dueloAtual.A.totalLikes;
            el.style.transition = "transform 0.2s, color 0.2s";
            el.style.transform = "scale(1.5)"; 
            el.style.color = "#ff4500"; 
            setTimeout(() => { 
                el.style.transform = "scale(1)"; 
                el.style.color = "#fff"; 
            }, 300);
        }
    } else {
        dueloAtual.B.totalLikes = (dueloAtual.B.totalLikes || 0) + 1;
        const el = document.getElementById('likesBatalhaB');
        if (el) {
            el.textContent = dueloAtual.B.totalLikes;
            el.style.transition = "transform 0.2s, color 0.2s";
            el.style.transform = "scale(1.5)"; 
            el.style.color = "#00c6ff"; 
            setTimeout(() => { 
                el.style.transform = "scale(1)"; 
                el.style.color = "#fff"; 
            }, 300);
        }
    }

    // --- 2. CONTADOR E LÓGICA DE PRÊMIOS ---
    let votosHoje = parseInt(localStorage.getItem('batalha_votos_hoje') || '0');
    votosHoje++; // Conta o voto atual
    localStorage.setItem('batalha_votos_hoje', votosHoje);

    // Atualiza o visual do contador (Ex: 15/75)
    const countEl = document.getElementById('contadorVotosSession');
    if (countEl) {
        countEl.textContent = `${votosHoje}/75`;
        // Se passou do limite, fica vermelho para indicar que acabaram os prêmios
        if (votosHoje > 75) countEl.style.color = '#e74c3c'; 
    }

    // LÓGICA DO PRÊMIO: Só ganha se for <= 75 E múltiplo de 5
    if (votosHoje <= 75) {
        if (votosHoje % 5 === 0) {
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                pontosFidelidade: firebase.firestore.FieldValue.increment(1)
            }).catch(e => console.log(e));
            
            if(typeof exibirToast === 'function') exibirToast("🎁 +1 King Points!");
        }
    }
    
    // Atualiza missão diária (Conta mesmo se passou de 75)
    if(typeof atualizarProgressoMissao === 'function') atualizarProgressoMissao('voto_batalha');

    // 3. Animação Coração no Centro da Imagem
    const containerId = escolha === 'A' ? 'batalhaOpcaoA' : 'batalhaOpcaoB';
    const container = document.getElementById(containerId);
    if(container) {
        const heart = container.querySelector('.voto-animacao');
        if(heart) heart.classList.add('show');
    }
    tocarSom('ping');

    // 4. Salva no Banco (Background)
    const vencedor = escolha === 'A' ? dueloAtual.A : dueloAtual.B;
    salvarVotoBatalha(vencedor).catch(e => console.log(e));

    // 5. Troca de Round (Apenas o perdedor sai)
    setTimeout(() => {
        try {
            let novoDesafiante;
            let tentativas = 0;
            do {
                novoDesafiante = pegarAleatorio();
                tentativas++;
            } while (novoDesafiante && (novoDesafiante.imgId === dueloAtual.A.imgId || novoDesafiante.imgId === dueloAtual.B.imgId) && tentativas < 50);

            if (escolha === 'A') dueloAtual.B = novoDesafiante;
            else dueloAtual.A = novoDesafiante;
            
            renderizarBatalha();
        } catch(e) { iniciarRoundInicial(); }
    }, 600); 
}

async function fecharModalBatalhaSeguro() {
    // 1. Detecta se o usuário ganhou pontos nesta sessão de votos
    if (typeof pontosAcumuladosBatalha !== 'undefined' && pontosAcumuladosBatalha > 0) {
        console.log(`Sincronizando ${pontosAcumuladosBatalha} pontos antes de sair...`);
        
        try {
            // Referência do usuário logado 
            const userRef = db.collection('usuarios').doc(auth.currentUser.uid);
            
            // Faz o "batimento" único no banco de dados [cite: 40, 43]
            await userRef.update({
                pontosFidelidade: firebase.firestore.FieldValue.increment(pontosAcumuladosBatalha)
            });

            // Limpa o acumulador local para a próxima vez
            pontosAcumuladosBatalha = 0;
            console.log("✅ Pontos salvos com sucesso!");
        } catch (e) {
            console.error("Erro ao salvar pontos na saída:", e);
        }
    }

    // 2. Agora sim, fecha o modal visualmente 
    fecharModal('modalBatalha'); 
    
    // O batimento do Firebase vai atualizar o saldo no Header
    // mas o modal já vai estar fechado, então nada vai travar! [cite: 55]
}

// 5. TROCAR APENAS O PERDEDOR (LOGICA KING OF THE HILL)
function trocarPerdedor(quemGanhou) {
    let novoDesafiante;
    
    // URLs atuais para evitar repetição
    const urlA = dueloAtual.A ? dueloAtual.A.url : '';
    const urlB = dueloAtual.B ? dueloAtual.B.url : '';
    
    let tentativas = 0;
    do {
        novoDesafiante = pegarAleatorio();
        tentativas++;
    } while (novoDesafiante && (novoDesafiante.url === urlA || novoDesafiante.url === urlB) && tentativas < 50);

    if (!novoDesafiante) {
        console.warn("Sem desafiantes disponíveis.");
        return;
    }

    // Quem ganhou continua, quem perdeu é substituído
    if (quemGanhou === 'A') {
        dueloAtual.B = novoDesafiante;
    } else {
        dueloAtual.A = novoDesafiante;
    }
    
    renderizarBatalha();
}

// 6. FUNÇÃO DE SALVAR NO BANCO
async function salvarVotoBatalha(dados) {
    if (!dados || !dados.imgId) return;
    try {
        const docRef = db.collection('batalha_likes').doc(dados.imgId);
        await docRef.update({
            count: firebase.firestore.FieldValue.increment(1),
            lastVote: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection('usuarios').doc(dados.uid).update({
            reputacao: firebase.firestore.FieldValue.increment(1)
        });
    } catch (e) {
        console.error("Erro BD Batalha:", e);
    }
}

function exibirToast(mensagem) {
    const div = document.createElement('div');
    div.innerText = mensagem;
    div.style.cssText = "position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(255, 215, 0, 0.95); color: #000; padding: 10px 20px; border-radius: 25px; font-weight: bold; z-index: 20000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); animation: fadeUp 2s forwards; pointer-events: none;";
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2000);
}
// Estilo da animação
const styleSheet = document.createElement("style");
styleSheet.innerText = "@keyframes fadeUp { 0% { opacity:0; transform:translate(-50%, 20px); } 20% { opacity:1; transform:translate(-50%, 0); } 80% { opacity:1; transform:translate(-50%, 0); } 100% { opacity:0; transform:translate(-50%, -20px); } }";
document.head.appendChild(styleSheet);

// Helper ID Único para a Imagem
function gerarIdUnicoImagem(url, ownerUid) {
    if (!url) return `${ownerUid}_unknown`;
    try {
        const urlLimpa = url.split('?')[0];
        const urlDecodificada = decodeURIComponent(urlLimpa);
        const partes = urlDecodificada.split('/');
        let nomeArquivo = partes[partes.length - 1];
        const idLimpo = nomeArquivo.replace(/\./g, '_').replace(/[^a-zA-Z0-9_]/g, "");
        return `${ownerUid}_${idLimpo}`;
    } catch (e) {
        return `${ownerUid}_img_fallback`; 
    }
}

async function recusarAgendamento(agendamentoId, clienteUid, clienteNome) {
    if (!agendamentoId) return;

    // ADIÇÃO: Para o efeito chiclete caso o mapa já estivesse tentando abrir
    encerrarRastreamentoTotal();

    try {
        // 1. Atualiza o status no Firebase
        await db.collection('agendamentos').doc(agendamentoId).update({
            status: 'recusado',
            recusadoEm: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Envia notificação PUSH/POPUP para o cliente
        if (clienteUid) {
            await fetch(NOTIFICATION_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    targetUid: clienteUid,
                    title: `❌ Agendamento Recusado`,
                    body: `Lamentamos, seu agendamento com ${perfil.nome} não pôde ser confirmado.`,
                    data: { action: 'agendamento_status', status: 'recusado', link: '#historico' }
                })
            });
        }

        fecharModalAtual();
        exibirPopup("Atenção", `Agendamento de ${clienteNome} Recusado.`);
        // Chama a função para recarregar a lista de agendamentos pendentes.

    } catch (error) {
        console.error("Erro ao recusar agendamento:", error);
        exibirPopup("Erro", "Falha ao recusar. Tente novamente.");
    }
}

function sincronizarPainelDeGestao() {
    // 1. Tenta encontrar o container principal da lista de equipe
    const container = document.getElementById('listaEquipeProprietario');

    // Se o container da lista estiver visível, recarrega a lista
    if (container) {
        // Assume que a função que renderiza a lista se chama carregarEquipeComPagamentos
        if (typeof carregarEquipeComPagamentos === 'function') {
            carregarEquipeComPagamentos();
            console.log("Sincronização forçada: Lista de equipe recarregada.");
            return;
        }
    }
    
    // 2. Se o modal inteiro estiver aberto, tenta recarregar o modal principal
    const modalGestao = document.getElementById('modalGerenciarEquipe');
    if (modalGestao && modalGestao.style.display === 'flex') {
        // Assume que a função que abre o modal principal se chama abrirModalGerenciarEquipe
        if (typeof abrirModalGerenciarEquipe === 'function') {
            abrirModalGerenciarEquipe();
            console.log("Sincronização forçada: Modal de gestão recarregado.");
            return;
        }
    }
    
    console.warn("Aviso: Nenhuma função de recarregamento de gestão foi encontrada/executada.");
}

async function salvarLogomarca() {
    // ... (código original de upload e salvar no DB) ...
    const fileInput = document.getElementById("logomarcaFile");
    const progressBar = document.getElementById('logoUploadProgress');
    const previewImg = document.getElementById('logomarcaPreview');
    const btnSalvar = document.getElementById('btnSalvarLogo');

    if (!fileInput.files || fileInput.files.length === 0) { return exibirPopup("Por favor, selecione um arquivo."); }
    const file = fileInput.files[0];
    const userId = auth.currentUser.uid;

    exibirAguarde("Enviando logomarca...");
    progressBar.style.display = 'block'; progressBar.value = 0; previewImg.style.opacity = '0.5'; btnSalvar.disabled = true;

    if (perfil && perfil.logo_url) { try { const oldLogoRef = storage.refFromURL(perfil.logo_url); await oldLogoRef.delete(); } catch (e) { console.warn("Não foi possível deletar a logo antiga:", e.message); } }
    const filePath = `logos/${userId}/${Date.now()}_${file.name}`;

    try {
        const downloadURL = await uploadImage(file, filePath, (progress) => { progressBar.value = progress; });
        await db.collection("usuarios").doc(userId).update({ logo_url: downloadURL });

        progressBar.style.display = 'none'; progressBar.value = 0; previewImg.style.opacity = '1';
        fecharTodosOsModais();
        exibirPopup("Logomarca salva com sucesso!");

        // --- ADIÇÃO PARA FLUXO PÓS-CADASTRO ---
        // ... (código de sucesso)
 if (fluxoPosCadastroAtivo) {
     fecharModalAtual(); // Fecha o modal da logo
     abrirModalComConfirmacao('modalPortfolioBarbeiro', '🖼️ Adicionar ao Portfólio'); // Abre o próximo
 } else {
      fecharModalAtual(); // Fecha o modal da logo (comportamento normal)
 }
        // --- FIM DA ADIÇÃO ---

    } catch (error) { /* ... (bloco catch original) ... */
        progressBar.style.display = 'none'; progressBar.value = 0; previewImg.style.opacity = '1';
        fecharTodosOsModais(); exibirPopup("Erro ao salvar logomarca: " + error.message); btnSalvar.disabled = false;
    }
}

// Listener para preview da logomarca e habilitar botão salvar
const logoFileInput = document.getElementById('logomarcaFile');
const logoPreviewImg = document.getElementById('logomarcaPreview');
const logoSaveBtn = document.getElementById('btnSalvarLogo');
if (logoFileInput && logoPreviewImg && logoSaveBtn) {
    logoFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                logoPreviewImg.src = e.target.result;
                logoPreviewImg.style.display = 'block';
                logoSaveBtn.disabled = false; // Habilita o botão
            }
            reader.readAsDataURL(file);
        } else {
            logoPreviewImg.src = '#';
            logoPreviewImg.style.display = 'none';
            logoSaveBtn.disabled = true; // Desabilita o botão
        }
    });
}

async function finalizarFluxoPosCadastro() {
    if (!fluxoPosCadastroAtivo) return;
    fluxoPosCadastroAtivo = false; // Desativa o fluxo
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ onboarding_profissional_concluido: true });
        console.log("Onboarding do profissional marcado como concluído.");
        exibirPopup("Configuração concluída!", "Você já pode usar todas as funções do painel do profissional."); // Feedback final
    } catch (error) {
        console.error("Erro ao marcar onboarding como concluído:", error);
        // Informar o usuário sobre o erro pode ser útil
        exibirPopup("Erro", "Houve um problema ao finalizar a configuração. Tente novamente mais tarde ou contate o suporte.");
    }
    // Não precisa fechar modal aqui, pois já foi fechado antes de chamar esta função
 }

function alterarEnderecoBarbeiro(event) {
    const rua = document.getElementById("novoEnderecoRua").value.trim();
    const numero = document.getElementById("novoEnderecoNumero").value.trim();
    if (!rua || !numero) return exibirPopup("Por favor, preencha a rua e o número.");
    if (!cadastroCoords) return exibirPopup("Por favor, use o botão para definir a localização no mapa antes de salvar.");
    
    db.collection("usuarios").doc(auth.currentUser.uid).update({ 
        rua, 
        numero,
        latitude: cadastroCoords.latitude,
        longitude: cadastroCoords.longitude,
    }).then(() => {
        exibirPopup("Endereço alterado com sucesso!");
        cadastroCoords = null;
        fecharModalAtual();
    }).catch(e => exibirPopup("Erro ao alterar endereço: " + e.message));
}

function abrirAgenda() {
    abrirModal('modalAgendaBarbeiro');
    
    const container = document.getElementById('modalAgendaBarbeiro').querySelector('.modal-content');
    const scrollContent = document.getElementById('agendaScrollContent');
    const painelManual = document.getElementById('agendaManualPainel');

    // --- LÓGICA DO MODO FÉRIAS (Mantida) ---
    if (!container.querySelector('#btnModoFerias')) {
        const btnFerias = document.createElement('button');
        btnFerias.id = 'btnModoFerias';
        btnFerias.textContent = '🏖️ Ativar Modo Férias/Ausência';
        btnFerias.onclick = () => abrirModal('modalModoFerias');
        btnFerias.style.background = "linear-gradient(45deg, #e57373, #c0392b)";
        
        // Insere antes do painel manual
        scrollContent.insertBefore(btnFerias, painelManual);
    }
    
    carregarAgenda();
}

/**
 * Exibe um popup de confirmação customizado.
 * @param {string} titulo O título do popup.
 * @param {string} mensagem A pergunta ou mensagem.
 * @param {function} onConfirm A função a ser executada se o usuário clicar "Sim".
 */
function exibirConfirmacao(titulo, mensagem, onConfirm) {
    // 1. TRAVA DE SEGURANÇA: Se o chat estiver aberto, não mostramos a confirmação.
    // Isso evita que o popup apareça "atropelando" a conversa do usuário.
    const chat = document.getElementById('janelaChat');
    const chatAberto = chat && (chat.style.display === 'flex' || chat.classList.contains('show'));
    
    if (chatAberto) {
        console.log("Sistema: Chat aberto, ignorando pedido de confirmação por enquanto.");
        return; 
    }

    const modal = document.getElementById('modalConfirmacaoGenerica');
    if (!modal) return;

    // 2. Preenche os dados do modal
    document.getElementById('confirmacaoGenericaTitulo').textContent = titulo;
    document.getElementById('confirmacaoGenericaMensagem').innerHTML = mensagem; 

    onConfirmCallback = onConfirm; 

    // 3. Configura os botões para fechar APENAS este modal, sem limpar os outros
    document.getElementById('btnConfirmacaoGenericaSim').onclick = () => {
        if (onConfirmCallback) onConfirmCallback();
        modal.style.display = 'none'; // Fecha direto via CSS
        onConfirmCallback = null;
    };

    document.getElementById('btnConfirmacaoGenericaNao').onclick = () => {
        modal.style.display = 'none'; // Fecha direto via CSS
        onConfirmCallback = null;
    };

    modal.onclick = (event) => {
         if (event.target.id === 'modalConfirmacaoGenerica') {
             modal.style.display = 'none';
             onConfirmCallback = null;
         }
    };

    // 4. A MÁGICA: Em vez de usar abrirModal(), usamos display flex direto.
    // Isso garante que ele apareça POR CIMA de qualquer coisa, sem fechar nada.
    modal.style.zIndex = '35000'; // Um pouco maior que o chat (25000)
    modal.style.display = 'flex'; 
    
    console.log("Sistema: Popup de confirmação aberto sem fechar outros elementos.");
}

// --- FUNÇÃO CARREGAR AGENDA (BLINDADA CONTRA HORÁRIOS FORA DO EXPEDIENTE E ALMOÇO) ---
function carregarAgenda() {
    const btnDisp = document.getElementById("btnDisponibilidade");
    const btnVagaImediata = document.getElementById("btnVagaImediata");
    const btnAgendaManual = document.getElementById("btnAgendaManual");
    const agendaManualPainel = document.getElementById("agendaManualPainel");
    const horariosContainer = document.getElementById("horariosContainer");

    if (!auth.currentUser || !perfil) return;
    
    // Lógica de Níveis
    const niveis = { 'tier1': 1, 'tier2': 2, 'tier3': 3, 'tier4': 4 };
    const nivelUsuario = (perfil.proAtivo && perfil.proTier) ? niveis[perfil.proTier] : 0;
    const isAdmin = perfil.tipo === 'admin';

    // Conversor de tempo para minutos (necessário para o filtro)
    const timeToMin = (t) => {
        if(!t) return null;
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    };

    // 1. DADOS DE EXPEDIENTE (Busca os horários que você configurou)
    // Se não tiver, usa padrão 07:00 as 20:30 (Para o loop rodar)
    const inicioExp = timeToMin(perfil.horarioInicio) || 420; // 07:00
    const fimExp = timeToMin(perfil.horarioFim) || 1230;      // 20:30
    
    let almocoIn = timeToMin(perfil.almocoInicio);
    let almocoOut = timeToMin(perfil.almocoFim);
    if(almocoIn === almocoOut) { almocoIn = -1; almocoOut = -1; }
    
    // 1. DISPONIBILIDADE AUTOMÁTICA (Livre) - Mantido
    btnDisp.textContent = perfil.disponivel === 'sim' ? '🔴 Parar Disponibilidade Automática' : '🟢 Ativar Disponibilidade Automática';
    btnDisp.style.border = perfil.disponivel === 'sim' ? '1px solid #e74c3c' : '1px solid #2ecc71';

    // 2. VAGA IMEDIATA (Requer TIER 1 - Bronze) - Mantido
    if (nivelUsuario >= 1 || isAdmin) {
        btnVagaImediata.style.opacity = "1";
        btnVagaImediata.style.pointerEvents = "auto";
        btnVagaImediata.onclick = toggleVagaImediata;

        if (perfil.vagaImediata) {
            btnVagaImediata.textContent = "⚡ Vaga Imediata: ATIVADA";
            btnVagaImediata.style.background = "#2ecc71";
            btnVagaImediata.style.color = "#fff";
            btnVagaImediata.classList.add('radar-active');
        } else {
            btnVagaImediata.textContent = "⚡ Vaga Imediata: DESATIVADA";
            btnVagaImediata.style.background = "#333";
            btnVagaImediata.style.color = "#777";
            btnVagaImediata.classList.remove('radar-active');
        }
    } else {
        btnVagaImediata.innerHTML = '🔒 Vaga Imediata <span style="font-size:9px; color:#cd7f32">(Requer Bronze)</span>';
        btnVagaImediata.classList.remove('radar-active');
        btnVagaImediata.style.background = "#333";
        btnVagaImediata.style.opacity = "0.7";
        btnVagaImediata.onclick = () => {
            exibirPopup("🔒 Recurso Bloqueado", "A Vaga Imediata é exclusiva para membros Bronze ou superior.", "aviso");
            setTimeout(() => { 
                abrirModalVipPro(); 
                document.getElementById('modalVipPro').style.zIndex = '22000';
            }, 2000);
        };
    }

    // 3. AGENDA PROGRAMADA (Requer TIER 2 - Prata)
    if (nivelUsuario >= 2 || isAdmin) {
        btnAgendaManual.style.opacity = "1";
        btnAgendaManual.style.pointerEvents = "auto";
        btnAgendaManual.onclick = toggleAgendaManual;

        if (perfil.usaAgendaManual) {
            // ESTADO ATIVO
            btnAgendaManual.textContent = "📅 Agenda Programada: ATIVADA";
            btnAgendaManual.style.background = "var(--cor-destaque)";
            btnAgendaManual.style.color = "#000";
            btnAgendaManual.style.fontWeight = "bold";
            
            // Mostra o painel
            agendaManualPainel.classList.remove("hidden");
            
            // Renderiza os botões de horário (Lógica CORRIGIDA AQUI!)
            horariosContainer.innerHTML = "";
            tempSelectedHorarios = { ...perfil.agenda }; // Copia a agenda atual
            
            // Loop para gerar todos os horários possíveis (7:00 a 20:30)
            for (let i = 7 * 60; i <= 20 * 60; i += 30) {
                
                // --- BLOQUEIO RIGOROSO 1: EXPEDIENTE ---
                if (i < inicioExp || i >= fimExp) {
                    continue; // Pula os horários fora do expediente
                }

                // --- BLOQUEIO RIGOROSO 2: ALMOÇO ---
                if (almocoIn !== -1 && i >= almocoIn && i < almocoOut) {
                    continue; // Pula os horários de almoço
                }
                // -----------------------------
                
                const horas = Math.floor(i / 60);
                const minutos = i % 60;
                const horario = `${horas}:${minutos.toString().padStart(2, '0')}`;
                
                const statusHorario = tempSelectedHorarios[horario];
                const btn = document.createElement('button');
                btn.textContent = horario;
                btn.className = `horario-btn`;
                
                // O estado do botão se estiver fora do expediente é 'bloqueado' e não deve ser clicável.
                if(statusHorario === true) btn.classList.add('selecionado');
                if(statusHorario === 'bloqueado') btn.classList.add('bloqueado');
                
                btn.onclick = () => toggleHorario(horario);
                horariosContainer.appendChild(btn);
            }

        } else {
            // ESTADO INATIVO - Mantido
            btnAgendaManual.textContent = "📅 Agenda Programada: DESATIVADA";
            btnAgendaManual.style.background = "#333";
            btnAgendaManual.style.color = "#777";
            btnAgendaManual.style.fontWeight = "normal";
            
            // Esconde o painel
            agendaManualPainel.classList.add("hidden");
        }

    } else {
        // BLOQUEADO (Sem Tier) - Mantido
        btnAgendaManual.innerHTML = '🔒 Agenda Programada <span style="font-size:9px; color:#c0c0c0">(Requer Prata)</span>';
        btnAgendaManual.style.background = "#333";
        btnAgendaManual.style.opacity = "0.7";
        agendaManualPainel.classList.add("hidden");
        
        btnAgendaManual.onclick = () => {
            exibirPopup("🔒 Recurso Bloqueado", "A Agenda Manual é exclusiva para membros Prata ou superior.", "aviso");
            setTimeout(() => { 
                abrirModalVipPro(); 
                document.getElementById('modalVipPro').style.zIndex = '22000';
            }, 2000);
        };
    }
}

function toggleHorario(horario) {
    const btn = Array.from(document.querySelectorAll('#horariosContainer .horario-btn')).find(b => b.textContent === horario);
    
    // Lógica de ciclo: Livre -> Selecionado -> Bloqueado -> Livre
    // Ou simples: Seleciona / Deseleciona (como pedido: "click seleciona mais 1 click desseleciona")
    
    const statusAtual = tempSelectedHorarios[horario];
    
    if (statusAtual === true) {
        // Se estava selecionado, agora bloqueia (ou desmarca, dependendo da sua regra de negócio. Vou fazer desmarcar)
        delete tempSelectedHorarios[horario];
        btn.classList.remove("selecionado");
        // btn.classList.add("bloqueado"); // Se quiser ciclo de 3 estados, descomente
    } else {
        // Seleciona
        tempSelectedHorarios[horario] = true;
        btn.classList.add("selecionado");
        btn.classList.remove("bloqueado");
    }
}

// --- LÓGICA DE POSTAR STORY (COM TRAVA TIER 4) ---
async function postarStory() {
    // 1. VERIFICAÇÃO DE SEGURANÇA (SÓ TIER 4 DIAMANTE)
    const isDiamante = isProAtivo(perfil) && perfil.proTier === 'tier4';
    
    if (!isDiamante) {
        exibirConfirmacao(
            "🔒 Recurso Exclusivo", 
            "Os Stories são exclusivos para assinantes DIAMANTE (Tier 4).\n\nEvolua seu plano para engajar seus clientes com fotos diárias!", 
            () => {
                fecharTodosOsModais();
                abrirModalVipPro();
            }
        );
        setTimeout(() => {
            const btn = document.getElementById('btnConfirmacaoGenericaSim');
            if(btn) btn.textContent = "💎 Virar Diamante";
        }, 50);
        return; 
    }

    // 2. Se for Diamante, continua...
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        exibirAguarde("Postando Story...");
        try {
            const path = `stories/${auth.currentUser.uid}/${Date.now()}_${file.name}`;
            const url = await uploadImage(file, path); 

            await db.collection('stories').add({
                usuarioUid: auth.currentUser.uid,
                usuarioNome: perfil.nome,
                usuarioFoto: perfil.fotoPerfil || perfil.logo_url || '/icone.png',
                imageUrl: url,
                ts: firebase.firestore.FieldValue.serverTimestamp(),
                expiraEm: new Date(Date.now() + 24 * 60 * 60 * 1000),
                likes: [],
                commentCount: 0
            });

            // --- AUTOMAÇÃO: MANDA PRO EM ALTA ---
            sincronizarComEmAlta(url, auth.currentUser.uid, perfil.nome);

            fecharTodosOsModais();
            exibirPopup("Sucesso", "Story postado! Seus clientes verão por 24h.");
            
        } catch (err) {
            fecharTodosOsModais();
            exibirPopup("Erro", err.message);
        }
    };
    
    input.click();
}

// Adicione o botão no painel do profissional
// (Coloque isso dentro de renderCurrentView ou onde cria os botões do pro)
/*
const btnStory = document.createElement('button');
btnStory.innerHTML = '📸 Postar Story';
btnStory.onclick = postarStory;
// ... append no container de funções ...
*/

let storiesListener = null;

function carregarStories(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const agora = new Date();
    
    // Limpa listener anterior para não duplicar
    if (storiesListener) {
        storiesListener();
        storiesListener = null;
    }
    
    // Busca stories que ainda não expiraram
    storiesListener = db.collection('stories')
        .where('expiraEm', '>', agora)
        .orderBy('expiraEm', 'desc')
        .onSnapshot(snap => {
            container.innerHTML = ''; // Limpa o container
            
            if (snap.empty) {
                container.style.display = 'none'; // Esconde se não tiver stories
                return;
            }
            
            container.style.display = 'flex';

            // Agrupa por usuário
            const storiesMap = {};
            
            snap.forEach(doc => {
                const s = doc.data();
                if (!storiesMap[s.usuarioUid]) {
                    storiesMap[s.usuarioUid] = {
                        nome: s.usuarioNome,
                        foto: s.usuarioFoto,
                        posts: []
                    };
                }
                storiesMap[s.usuarioUid].posts.push({ ...s, id: doc.id });
            });

            // Salva no cache global para abrir depois
            window.storiesCache = storiesMap;

            // Renderiza as bolinhas
            Object.keys(storiesMap).forEach(uid => {
                const data = storiesMap[uid];
                const foto = data.foto || '/icone.png';
                
                container.innerHTML += `
                    <div class="story-item" onclick="abrirStory('${uid}')">
                        <div class="story-circle" style="padding:2px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); border-radius:50%;">
                            <img src="${foto}" style="width:100%; height:100%; border-radius:50%; border: 2px solid #000; object-fit:cover;" onerror="this.src='/icone.png'">
                        </div>
                        <span class="story-name" style="font-size:10px; margin-top:4px; color:#ccc;">${data.nome.split(' ')[0]}</span>
                    </div>
                `;
            });
            
        }, error => {
            console.error("Erro ao carregar stories:", error);
            container.style.display = 'none';
        });
}

// 3. Abrir e Reproduzir Story
let currentStoryInterval;
let currentStoryUserUid;

function abrirStory(uid) {
    const data = window.storiesCache[uid];
    if (!data) return;
    
    currentStoryUserUid = uid; 
    const posts = data.posts;
    let currentPostIndex = 0;
    
    // ... (mesmas variáveis do seu código) ...
    const modal = document.getElementById('modalStoryView');
    const img = document.getElementById('storyImage');
    const barsContainer = document.getElementById('storyProgressBarContainer');
    const userName = document.getElementById('storyUserName');
    const userPhoto = document.getElementById('storyUserPhoto');
    const likeIcon = document.getElementById('storyLikeIcon');
    const likeCount = document.getElementById('storyLikeCount');
    const commentCount = document.getElementById('storyCommentCount');

    userName.textContent = data.nome;
    userPhoto.src = data.foto;
    
    barsContainer.innerHTML = '';
    posts.forEach(() => {
        barsContainer.innerHTML += `<div class="story-progress-bar"><div class="story-progress-fill"></div></div>`;
    });

    // --- BOTÃO DE DELETAR (NOVO) ---
    // Remove botão antigo se existir
    const btnDelAntigo = document.getElementById('btnDeleteStory');
    if(btnDelAntigo) btnDelAntigo.remove();

    // Se sou o dono, cria o botão
    if (auth.currentUser && auth.currentUser.uid === uid) {
        const btnDelete = document.createElement('button');
        btnDelete.id = 'btnDeleteStory';
        btnDelete.innerHTML = '🗑️';
        btnDelete.style.cssText = "position:absolute; bottom:20px; right:20px; z-index:30; background:rgba(0,0,0,0.6); color:red; border:1px solid red; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer;";
        btnDelete.onclick = deletarStoryAtual;
        modal.querySelector('.modal-content').appendChild(btnDelete);
    }
    // -------------------------------

    const showPost = (index) => {
        if (index >= posts.length) {
            // ... (mesma lógica de próximo usuário) ...
             const todosUids = Object.keys(window.storiesCache);
            const meuIndice = todosUids.indexOf(currentStoryUserUid);
            if (meuIndice !== -1 && meuIndice < todosUids.length - 1) {
                abrirStory(todosUids[meuIndice + 1]);
            } else {
                fecharModalAtual();
            }
            return;
        }
        
        currentPostIndex = index;
        const postAtual = posts[index];
        currentStoryId = postAtual.id; // ID IMPORTANTE PARA DELETAR
        
        img.src = postAtual.imageUrl;

        // ... (resto da lógica de likes, animação barras e timer) ...
         if (likesListener) likesListener();
        likesListener = db.collection('stories').doc(currentStoryId)
            .onSnapshot(doc => {
                if (!doc.exists) return;
                const s = doc.data();
                const likes = s.likes || [];
                likeCount.textContent = likes.length;
                commentCount.textContent = s.commentCount || 0;
                const euDeiLike = likes.includes(auth.currentUser.uid);
                likeIcon.textContent = euDeiLike ? '❤️' : '🤍';
                if(euDeiLike) likeIcon.classList.add('heart-active'); else likeIcon.classList.remove('heart-active');
            });

        const fills = document.querySelectorAll('.story-progress-fill');
        fills.forEach((f, i) => {
            if (i < index) f.style.width = '100%';
            else if (i > index) f.style.width = '0%';
            else {
                f.style.width = '0%';
                f.style.transition = 'none';
                setTimeout(() => {
                    f.style.transition = 'width 5s linear';
                    f.style.width = '100%';
                }, 50);
            }
        });

        if (currentStoryInterval) clearTimeout(currentStoryInterval);
        currentStoryInterval = setTimeout(() => {
            showPost(index + 1);
        }, 5000);
    };
    
    // ... (restante da lógica de clique na imagem) ...
     img.onclick = (e) => {
        const width = window.innerWidth;
        if (e.clientX > width / 2) showPost(currentPostIndex + 1);
        else {
            if (currentPostIndex > 0) showPost(currentPostIndex - 1);
        }
    };

    abrirModal('modalStoryView');
    showPost(0);
}

// NOVA FUNÇÃO DE DELETAR
async function deletarStoryAtual() {
    if (!confirm("Tem certeza que deseja apagar este story?")) return;
    
    // Para o timer para não pular enquanto deleta
    if (currentStoryInterval) clearTimeout(currentStoryInterval);

    try {
        await db.collection('stories').doc(currentStoryId).delete();
        
        // Remove a imagem do Storage (Opcional, mas recomendado)
        // Precisaríamos da URL para pegar a referência, mas só deletar do banco já remove do app.
        
        exibirPopup("Story apagado.");
        fecharModalAtual(); // Fecha o visualizador
        
        // Atualiza a lista (se estiver no perfil do profissional, recarrega)
        if (userView.currentType !== 'cliente') {
             carregarStories('storiesContainerBarbeiro');
        }

    } catch (e) {
        exibirPopup("Erro ao apagar: " + e.message);
    }
}

// --- FUNÇÃO DE LIKE ---
async function toggleLikeStory() {
    if (!auth.currentUser || !currentStoryId) return;
    
    const storyRef = db.collection('stories').doc(currentStoryId);
    const uid = auth.currentUser.uid;
    const icon = document.getElementById('storyLikeIcon');
    
    // Verifica visualmente para resposta instantânea
    const isLiked = icon.classList.contains('heart-active') || icon.textContent === '❤️';

    if (isLiked) {
        // --- DESMARCAR (UNLIKE) ---
        icon.textContent = '🤍';
        icon.classList.remove('heart-active');
        
        await storyRef.update({
            likes: firebase.firestore.FieldValue.arrayRemove(uid)
        });
    } else {
        // --- MARCAR (LIKE) ---
        icon.textContent = '❤️';
        icon.classList.add('heart-active');
        tocarSom('ping');
        
        // Missão diária
        if(typeof atualizarProgressoMissao === 'function') atualizarProgressoMissao('like_story');
        
        await storyRef.update({
            likes: firebase.firestore.FieldValue.arrayUnion(uid)
        });
    }
}

// --- FUNÇÕES DE COMENTÁRIOS (CORRIGIDAS) ---

function abrirComentariosStory() {
    if (currentStoryInterval) clearTimeout(currentStoryInterval); 
    
    const modal = document.getElementById('modalComentariosStory');
    const lista = document.getElementById('listaComentariosStory');
    const input = document.getElementById('inputComentarioStory');
    const minhaFoto = document.getElementById('minhaFotoComentario');

    if (perfil) {
        minhaFoto.src = perfil.fotoPerfil || perfil.logo_url || '/icone.png';
    }

    lista.innerHTML = '<div style="text-align:center; margin-top:20px;"><div class="spinner"></div></div>';
    
    modal.classList.add('show');
    modal.style.display = 'flex'; 
    
    setTimeout(() => { input.focus(); }, 300);

    if (commentsListener) commentsListener();
    
    // ATENÇÃO: currentStoryId deve ser global (definido ao abrir o story)
    commentsListener = db.collection('stories').doc(currentStoryId).collection('comments')
        .orderBy('ts', 'asc')
        .onSnapshot(snap => {
            lista.innerHTML = '';
            if (snap.empty) {
                lista.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; opacity:0.5;"><span style="font-size:30px;">💬</span><p>Nenhum comentário ainda.</p></div>';
                return;
            }
            
            snap.forEach(doc => {
                const c = doc.data();
                const foto = c.userPhoto || '/icone.png';
                
                // Lógica de Tempo
                let tempoStr = "agora";
                if (c.ts) {
                    const diff = (new Date() - c.ts.toDate()) / 1000 / 60; 
                    if (diff < 60) tempoStr = Math.floor(diff) + " min";
                    else if (diff < 1440) tempoStr = Math.floor(diff/60) + " h";
                    else tempoStr = Math.floor(diff/1440) + " d";
                }
                
                // Lógica de Like (Novo)
                const likes = c.likes || [];
                const euDeiLike = likes.includes(auth.currentUser.uid);
                const heartClass = euDeiLike ? 'liked' : '';
                const heartSymbol = euDeiLike ? '❤️' : '🤍';
                
                // Lógica de Deletar
                const souDonoDoStory = (currentStoryUserUid === auth.currentUser.uid);
                let deleteAction = '';
                let deletableClass = '';
                if (souDonoDoStory || c.uid === auth.currentUser.uid) {
                    deletableClass = 'deletable';
                    // Nota: O clique para deletar fica na área do texto/nome, não no coração
                    deleteAction = `onclick="if(!event.target.closest('.comment-like-box')) deletarComentarioStory('${doc.id}', '${currentStoryId}')"`;
                }

                lista.innerHTML += `
                    <div class="comment-item ${deletableClass}" ${deleteAction}>
                        <img src="${foto}" class="comment-avatar" onerror="this.src='/icone.png'">
                        
                        <div class="comment-content" style="flex-grow:1;">
                            <div>
                                <span class="comment-name">${c.userName}</span>
                                <span class="comment-text">${c.text}</span>
                            </div>
                            <span class="comment-time">${tempoStr}</span>
                        </div>

                        <div class="comment-like-box" onclick="toggleLikeComentario('stories', '${currentStoryId}', '${doc.id}')">
                            <span id="heart_${doc.id}" class="comment-heart ${heartClass}">${heartSymbol}</span>
                            <span id="count_${doc.id}" class="comment-count">${likes.length}</span>
                        </div>
                    </div>
                `;
            });
            
            setTimeout(() => lista.scrollTop = lista.scrollHeight, 100);
        });
}

async function deletarComentarioStory(commentId, storyId) {
    if (!confirm("Apagar este comentário?")) return;
    
    try {
        const storyRef = db.collection('stories').doc(storyId);
        
        // Remove do banco
        await storyRef.collection('comments').doc(commentId).delete();
        
        // Decrementa contador
        await storyRef.update({
            commentCount: firebase.firestore.FieldValue.increment(-1)
        });
        
        // Não precisa recarregar, o listener atualiza a tela automaticamente
    } catch (e) {
        console.error("Erro ao deletar:", e);
    }
}

function filtrarProdutosLoja() {
    const termo = document.getElementById('searchLojaInput').value.toLowerCase();
    const produtos = document.querySelectorAll('.produto-card');
    produtos.forEach(card => {
        const nome = card.querySelector('.produto-nome').textContent.toLowerCase();
        if (nome.includes(termo)) card.style.display = "flex";
        else card.style.display = "none";
    });
}

function fecharComentariosStory(event) {
    // Se o clique foi no fundo escuro (fora do modal) ou no botão fechar
    if (!event || event.target.id === 'modalComentariosStory' || event.target.tagName === 'BUTTON') {
        const modal = document.getElementById('modalComentariosStory');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
        
        if (commentsListener) {
            commentsListener(); // Para de ouvir o banco
            commentsListener = null;
        }
        
        // Opcional: Retomar o story? Geralmente apps de story não retomam sozinhos após comentário,
        // deixam o usuário clicar na tela para avançar. Se quiser retomar:
        // showPost(currentPostIndex); 
    }
}

async function enviarComentarioStory() {
    const input = document.getElementById('inputComentarioStory');
    const text = input.value.trim();
    if (!text) return;

    const storyIdRef = currentStoryId; // Guarda ID localmente
    const storyRef = db.collection('stories').doc(storyIdRef);
    
    input.value = ''; // Limpa input imediatamente
    input.focus();    // Mantém teclado aberto para comentar mais

    try {
        // Adiciona na subcoleção
        await storyRef.collection('comments').add({
            uid: auth.currentUser.uid,
            userName: perfil.nome,
            userPhoto: perfil.fotoPerfil || perfil.logo_url || '/icone.png',
            text: text,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Incrementa contador visual no documento pai
        await storyRef.update({
            commentCount: firebase.firestore.FieldValue.increment(1)
        });
        
        // Notifica o dono do story (se não for eu mesmo)
        if (currentStoryUserUid !== auth.currentUser.uid) {
            notifyUser(currentStoryUserUid, "💬 Novo Comentário", `${perfil.nome} comentou no seu story: "${text}"`);
        }

    } catch (e) {
        console.error("Erro ao comentar:", e);
    }
}

function fecharComentariosStory() {
    document.getElementById('modalComentariosStory').style.display = 'none';
    if (commentsListener) commentsListener(); // Para de ouvir comentários
    
    // Retoma o timer do Story (opcional, ou deixa o usuário clicar para avançar)
    // Se quiser retomar: showPost(currentPostIndex); 
}

async function enviarComentarioStory() {
    const input = document.getElementById('inputComentarioStory');
    const text = input.value.trim();
    if (!text) return;

    const storyRef = db.collection('stories').doc(currentStoryId);
    
    input.value = ''; // Limpa input
    
    // Adiciona na subcoleção
    await storyRef.collection('comments').add({
        uid: auth.currentUser.uid,
        userName: perfil.nome,
        userPhoto: perfil.fotoPerfil || perfil.logo_url || '/icone.png',
        text: text,
        ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Incrementa contador no documento pai (para mostrar o número no ícone)
    await storyRef.update({
        commentCount: firebase.firestore.FieldValue.increment(1)
    });
}

function agendarPeloStory() {
    fecharModalAtual(); // Fecha o story
    abrirBarbeiroPerfil(currentStoryUserUid); // Abre o perfil do dono do story
}

// ADICIONE ESTA CHAMADA NO renderCurrentView (para clientes):
// if (userView.currentType === 'cliente') carregarStories();
// E adicione o botão "Postar Story" no renderCurrentView (para profissionais).

function abrirAgendamentosBarbeiro() {
    abrirModal('modalAgendamentosBarbeiro');
    const painel = document.getElementById("agendamentosPainel");
    
    // Feedback de carregamento
    painel.innerHTML = `
        <div style='text-align:center; padding:40px; color:#aaa;'>
            <div class="spinner-premium"></div>
            <p style="margin-top:15px; font-weight:600;">Sincronizando sua agenda...</p>
        </div>
    `;

    // Listener em tempo real
    db.collection("agendamentos")
        .where("barbeiroUid", "==", auth.currentUser.uid)
        .where("status", "in", ["pendente", "confirmado", "imediato", "conclusão pendente"])
        .orderBy("ts", "asc")
        .onSnapshot(snap => {
            if (snap.empty) {
                painel.innerHTML = `
                    <div style='text-align:center; padding:60px; opacity:0.6;'>
                        <span style="font-size:50px;">📅</span>
                        <p style="margin-top:10px;">Nenhum agendamento ativo.<br>Suas solicitações aparecerão aqui.</p>
                    </div>`;
                return;
            }

            painel.innerHTML = ""; // Limpa para renderizar
            
            snap.forEach(doc => {
                const ag = doc.data();
                const docId = doc.id;
                
                // Configurações Visuais por Status
                let config = {
                    label: "Agendado",
                    cor: "#3498db",
                    icon: "📅",
                    bg: "rgba(52, 152, 219, 0.1)"
                };

                if (ag.status === "pendente") {
                    config = { label: "Aguardando", cor: "#f1c40f", icon: "⏳", bg: "rgba(241, 196, 15, 0.1)" };
                } else if (ag.status === "imediato") {
                    config = { label: "Imediato", cor: "#e67e22", icon: "⚡", bg: "rgba(230, 126, 34, 0.1)" };
                } else if (ag.status === "confirmado" || ag.status === "conclusão pendente") {
                    config = { label: "Em Andamento", cor: "#2ecc71", icon: "🚀", bg: "rgba(46, 204, 113, 0.1)" };
                }

                // Foto do Cliente (Fallback se não existir)
                const fotoCliente = ag.clienteFoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(ag.clienteNome) + '&background=random&color=fff';
                const horarioDisplay = ag.horario ? `<b>${ag.horario}</b>` : '<span style="color:#e67e22; font-weight:bold;">AGORA</span>';

                // Lógica de Botões Dinâmicos
                let botoesAcao = "";
                if (ag.status === "pendente" || ag.status === "imediato") {
                    const funcAprovar = ag.status === "imediato" ? `aprovarAgendamentoImediato('${docId}','${ag.clienteUid}',${ag.valor})` : `aprovarAgendamento('${docId}','${ag.clienteUid}',${ag.valor},'${ag.horario}')`;
                    botoesAcao = `
                        <div style="display:flex; gap:8px; margin-top:12px;">
                            <button onclick="${funcAprovar}" style="flex:2; background:#2ecc71; color:#fff; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">✅ Aceitar</button>
                            <button onclick="recusarAgendamento('${docId}','${ag.clienteUid}')" style="flex:1; background:#333; color:#ff4444; border:1px solid #ff4444; padding:10px; border-radius:8px; cursor:pointer;">Recusar</button>
                        </div>`;
                } else {
                    botoesAcao = `
                        <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                            <button onclick="iniciarRastreamentoBusca('${ag.clienteUid}', '${ag.clienteNome}', '${docId}')" 
                                style="background: linear-gradient(45deg, #00c6ff, #0072ff); color:#fff; border:none; padding:12px; border-radius:8px; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow: 0 4px 15px rgba(0,198,255,0.3);">
                                📍 Iniciar Rota GPS
                            </button>
                            <div style="display:flex; gap:8px;">
                                <button onclick="abrirModalEntradaManual('${ag.barbeiroUid}', '${docId}')" 
                                    style="flex:1; background:#2ecc71; color:#fff; border:none; padding:10px; border-radius:8px; font-weight:bold;">
                                    ✅ Concluir
                                </button>
                                <button onclick="cancelarAgendamentoManualmente('${docId}','${ag.clienteUid}',${ag.valor})" 
                                    style="flex:1; background:#e74c3c; color:#fff; border:none; padding:10px; border-radius:8px; font-weight:bold;">
                                    ❌ Cancelar
                                </button>
                            </div>
                        </div>`;
                }

                // Link do WhatsApp formatado
                const wppLink = ag.clienteTelefone ? `
                    <a href="https://wa.me/55${ag.clienteTelefone.replace(/\D/g, '')}" target="_blank" 
                       style="display:flex; align-items:center; gap:5px; color:#25D366; text-decoration:none; font-size:13px; font-weight:600; margin-top:8px;">
                        <img src="https://cdn-icons-png.flaticon.com/512/124/124034.png" width="16"> Chamar no WhatsApp
                    </a>` : '';

                // Template do Card
                painel.innerHTML += `
                    <div class="card-agendamento-premium" style="border-left: 6px solid ${config.cor};">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <img src="${fotoCliente}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #333;">
                                <div>
                                    <h4 style="margin:0; font-size:16px; color:#fff;">${ag.clienteNome}</h4>
                                    <span style="background:${config.bg}; color:${config.cor}; font-size:10px; padding:3px 8px; border-radius:20px; font-weight:800; text-transform:uppercase;">
                                        ${config.icon} ${config.label}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px; color:#fff;">${horarioDisplay}</div>
                                <div style="font-size:12px; color:#aaa;">R$ ${parseFloat(ag.valor).toFixed(2)}</div>
                            </div>
                        </div>

                        <div style="background: #1a1a1a; padding:10px; border-radius:8px; border:1px solid #333;">
                            <div style="font-size:13px; color:#ddd;">✂️ <b>Serviço:</b> ${ag.servico}</div>
                            ${wppLink}
                        </div>

                        ${botoesAcao}
                    </div>
                `;
            });
        });

    // Injeta CSS se ainda não existir
    if (!document.getElementById('styleAgendamentos')) {
        const style = document.createElement('style');
        style.id = 'styleAgendamentos';
        style.innerHTML = `
            .card-agendamento-premium {
                background: #222;
                border-radius: 15px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                transition: transform 0.2s;
            }
            .card-agendamento-premium:active { transform: scale(0.98); }
            .spinner-premium {
                width: 40px; height: 40px;
                border: 4px solid #333;
                border-top: 4px solid #00c6ff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        document.head.appendChild(style);
    }
}

function obterLocalizacaoAtual() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error("Geolocalização não suportada."));
        }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = parseFloat(position.coords.latitude);
                const lon = parseFloat(position.coords.longitude);
                
                localizacaoCliente = {
                    latitude: lat,
                    longitude: lon,
                };

                // ATUALIZAÇÃO DE SEGURANÇA NO BANCO
                // Isso garante que se tiver "testandopopup" lá, será substituído agora
                if (auth.currentUser) {
                    db.collection('usuarios').doc(auth.currentUser.uid).update({
                        latitude: lat,
                        longitude: lon
                    }).catch(err => console.log("Erro ao atualizar gps:", err));
                }

                resolve(localizacaoCliente);
            },
            (error) => {
                console.warn("Não foi possível obter a localização: ", error.message);
                reject(error);
            },
            { enableHighAccuracy: true }
        );
    });
}

function formatarNomeProprio(texto) {
  if (!texto) return "";
  // Converte tudo para minúsculo primeiro para padronizar
  return texto.toLowerCase()
    // Separa as palavras por espaço
    .split(' ')
    // Mapeia cada palavra
    .map(palavra => {
      // Capitaliza a primeira letra e concatena com o resto da palavra
      return palavra.charAt(0).toUpperCase() + palavra.slice(1);
    })
    // Junta as palavras de volta com espaço
    .join(' ');
}

// --- FUNÇÃO VAGA IMEDIATA (CORRIGIDA: RESPOSTA INSTANTÂNEA) ---
function toggleVagaImediata() {
    // 1. Pega o estado atual e inverte imediatamente (Lógica Local)
    const estadoAtual = perfil.vagaImediata === true;
    const novoEstado = !estadoAtual;

    // 2. ATUALIZA A VARIÁVEL LOCAL IMEDIATAMENTE (Para a UI não piscar se algo repintar)
    perfil.vagaImediata = novoEstado;

    // 3. ATUALIZA O VISUAL DO BOTÃO NA HORA (Sem esperar servidor)
    const btn = document.getElementById("btnVagaImediata");
    if (btn) {
        if (novoEstado) {
            btn.textContent = "⚡ Vaga Imediata: ATIVADA";
            btn.style.background = "#2ecc71"; // Verde
            btn.style.color = "#fff";
            btn.classList.add('radar-active'); // Adiciona efeito visual se tiver
        } else {
            btn.textContent = "⚡ Vaga Imediata: DESATIVADA";
            btn.style.background = "#333"; // Escuro padrão
            btn.style.color = "#777";
            btn.classList.remove('radar-active');
        }
    }

    // 4. ENVIA PRO SERVIDOR EM "BACKGROUND" (O servidor que se vire)
    // Removemos o 'await' e o loading para não travar a tela
    db.collection('usuarios').doc(auth.currentUser.uid).update({
        vagaImediata: novoEstado
    }).catch(erro => {
        console.error("Erro ao sincronizar vaga imediata (mas a UI já mudou):", erro);
        // Opcional: Se der erro crítico, você poderia reverter, mas 
        // para essa experiência "app nativo", ignoramos erros raros de conexão momentânea.
    });
}

// Função auxiliar para atualizar a cor do botão (AGORA INTELIGENTE)
function atualizarVisualBotaoVaga() {
    const btnRapido = document.getElementById("btnVagaRapida");
    // Atualiza também o botão antigo dentro do menu (se existir)
    const btnMenu = document.getElementById("btnVagaImediata");

    // CENÁRIO 1: Existe um atendimento imediato em andamento (Aprovado)
    if (dadosVagaImediataAtiva) {
        if (btnRapido) {
            btnRapido.innerHTML = "✅ CONCLUIR VAGA IMEDIATA";
            btnRapido.className = "btn-vaga-destaque"; // Mantém estilo base
            btnRapido.style.background = "linear-gradient(45deg, #2ecc71, #27ae60)"; // Verde Concluir
            btnRapido.style.color = "white";
            btnRapido.style.border = "1px solid white";
            btnRapido.classList.remove('radar-active');
            
            // AQUI ESTÁ A MÁGICA: Ao clicar, abre o MESMO popup de agendamento programado
            btnRapido.onclick = function() {
                concluirAgendamento(dadosVagaImediataAtiva.id, dadosVagaImediataAtiva.clienteUid);
            };
        }
        return; // Sai da função para não sobrescrever com o estado de "Disponível/Indisponível"
    }

    // CENÁRIO 2: Comportamento Padrão (Ativar/Desativar Disponibilidade)
    if (btnRapido) {
        // Reseta o onclick para o padrão
        btnRapido.onclick = toggleVagaImediata;
        btnRapido.style.background = ""; // Remove cor inline forçada
        btnRapido.style.color = "";
        btnRapido.style.border = "";
    }

    if (perfil.vagaImediata) {
        // ATIVO (Buscando cliente...)
        if(btnRapido) {
            btnRapido.innerHTML = "📡 VAGA IMEDIATA ATIVA";
            btnRapido.classList.add('ativo');
        }
        if(btnMenu) {
            btnMenu.textContent = '📡 Vaga Imediata ATIVA';
            btnMenu.classList.add('radar-active');
        }
    } else {
        // INATIVO
        if(btnRapido) {
            btnRapido.innerHTML = "⚡ ATIVAR VAGA IMEDIATA";
            btnRapido.classList.remove('ativo');
        }
        if(btnMenu) {
            btnMenu.textContent = '⚡ Ativar Vaga Imediata';
            btnMenu.classList.remove('radar-active');
        }
    }
}

// --- FUNÇÃO AGENDA PROGRAMADA (CORRIGIDA: RENDERIZA OS HORÁRIOS AO CLICAR) ---
function toggleAgendaManual() {
    // 1. Inverte o estado
    const estadoAtual = perfil.usaAgendaManual === true;
    const novoEstado = !estadoAtual;

    // 2. Atualiza variável local imediatamente
    perfil.usaAgendaManual = novoEstado;

    // 3. Atualiza UI
    const btn = document.getElementById("btnAgendaManual");
    const painel = document.getElementById("agendaManualPainel");
    const horariosContainer = document.getElementById("horariosContainer");

    if (btn) {
        if (novoEstado) {
            // --- ATIVANDO ---
            btn.textContent = "📅 Agenda Programada: ATIVADA";
            btn.style.background = "var(--cor-destaque)"; // Dourado
            btn.style.color = "#000";
            btn.style.fontWeight = "bold";
            
            if (painel) painel.classList.remove('hidden');

            // === AQUI ESTAVA FALTANDO: RENDERIZAR OS HORÁRIOS IMEDIATAMENTE ===
            if (horariosContainer) {
                horariosContainer.innerHTML = "";
                // Garante que a variável temporária de edição esteja sincronizada com o perfil
                tempSelectedHorarios = { ...perfil.agenda };

                // Loop para criar os botões (das 07:00 às 20:00)
                for (let i = 7 * 60; i <= 20 * 60; i += 30) { 
                    const horas = Math.floor(i / 60);
                    const minutos = i % 60;
                    const horario = `${horas}:${minutos.toString().padStart(2, '0')}`;
                    
                    const statusHorario = tempSelectedHorarios[horario];
                    
                    const btnHorario = document.createElement('button');
                    btnHorario.textContent = horario;
                    btnHorario.className = `horario-btn`;
                    
                    // Aplica as classes visuais baseadas no estado salvo
                    if(statusHorario === true) btnHorario.classList.add('selecionado');
                    if(statusHorario === 'bloqueado') btnHorario.classList.add('bloqueado');
                    
                    // Adiciona o evento de clique em cada horário
                    btnHorario.onclick = () => toggleHorario(horario);
                    
                    horariosContainer.appendChild(btnHorario);
                }
            }
            // =================================================================

        } else {
            // --- DESATIVANDO ---
            btn.textContent = "📅 Agenda Programada: DESATIVADA";
            btn.style.background = "#333";
            btn.style.color = "#777";
            btn.style.fontWeight = "normal";
            
            if (painel) painel.classList.add('hidden');
        }
    }

    // 4. Salva no Banco de Dados (Background)
    db.collection('usuarios').doc(auth.currentUser.uid).update({
        usaAgendaManual: novoEstado
    }).catch(erro => {
        console.error("Erro ao salvar agenda manual:", erro);
    });
}

function salvarConfigAlmoco() {
    const inicio = document.getElementById('inputAlmocoInicio').value;
    const fim = document.getElementById('inputAlmocoFim').value;

    if (!inicio || !fim) return exibirPopup("Defina início e fim.");
    if (inicio >= fim) return exibirPopup("O início deve ser antes do fim.");

    exibirAguarde("Salvando...");
    
    db.collection('usuarios').doc(auth.currentUser.uid).update({
        horaAlmocoInicio: inicio,
        horaAlmocoFim: fim
    }).then(() => {
        fecharTodosOsModais();
        exibirPopup("Sucesso", "Horário de almoço definido! Ele aparecerá bloqueado na sua agenda.");
        // Atualiza perfil localmente
        if(perfil) { perfil.horaAlmocoInicio = inicio; perfil.horaAlmocoFim = fim; }
    }).catch(e => {
        fecharTodosOsModais();
        exibirPopup("Erro", e.message);
    });
}

// Variável para controle de busca
let buscaEquipeTimeout = null;

// --- FUNÇÃO 1: ESTRUTURA DO MODAL DE EQUIPE ---
async function abrirModalGerenciarEquipe() {
    const modal = document.getElementById('modalGerenciarEquipe');
    modal.classList.add('modal-large');
    
    const modalContent = modal.querySelector('.modal-content');
    
    modalContent.innerHTML = `
        <div class="modal-header-premium">
            <div>
                <h3 style="margin:0; color:var(--cor-destaque); font-size: 20px;">👥 Gestão de Equipe</h3>
                <p style="margin:0; color:#aaa; font-size:12px;">Gerencie pagamentos e adicione novos talentos.</p>
            </div>
            <button onclick="fecharModalAtual()" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:30px; height:30px; border-radius:50%; font-size:16px;">✕</button>
        </div>

        <div class="search-container-top" style="position: relative; z-index: 50; padding: 15px; background: #111;">
            
            <div style="position: relative;">
                <span style="position:absolute; left:12px; top:12px; opacity:0.5;">🔍</span>
                
                <input id="buscaEquipeInputProprietario" 
                       oninput="handleBuscaEquipe(this.value)" 
                       class="search-input-premium" 
                       autocomplete="off"
                       placeholder="Digite para buscar (Ex: 'J' para João)..."
                       style="width:100%; padding-left: 35px; box-sizing: border-box;">
            </div>
            
            <div id="resultadoBuscaEquipe" 
                 style="
                    display: none;
                    position: absolute; 
                    top: 100%;
                    left: 15px; 
                    right: 15px;
                    background: #1a1a1a; 
                    border: 1px solid var(--cor-destaque); 
                    border-top: none;
                    border-radius: 0 0 12px 12px;
                    max-height: 250px; 
                    overflow-y: auto; 
                    z-index: 100; 
                    box-shadow: 0 10px 30px rgba(0,0,0,1);
                 ">
            </div>

            <button onclick="abrirModalConvidarRecepcionista()" 
                    style="width:100%; margin-top:10px; background: linear-gradient(45deg, #9b59b6, #8e44ad); color:white; font-weight:bold; border:1px solid rgba(255,255,255,0.2);">
                👩‍💼 Contratar Secretária
            </button>

        </div>

        <div style="flex-grow:1; overflow-y:auto; padding:20px; background:#0f0f0f; position: relative; z-index: 1;">
            <h4 style="color:#fff; margin-bottom:15px; border-left:4px solid var(--cor-destaque); padding-left:10px;">
                Membros da Equipe & Pagamentos
            </h4>
            <div id="listaEquipeProprietario">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    abrirModal('modalGerenciarEquipe');
    carregarEquipeComPagamentos(); 
}

function handleBuscaEquipe(texto) {
    const container = document.getElementById('resultadoBuscaEquipe');
    
    if (!container) {
        console.error("ERRO: Container 'resultadoBuscaEquipe' não encontrado!");
        return;
    }

    // Se limpar o campo, esconde a lista
    if (!texto || texto.trim().length === 0) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
    }

    // Mostra o container carregando
    container.style.display = 'block';
    container.innerHTML = '<div style="padding:15px; text-align:center; color:#aaa;">🔎 Buscando...</div>';
    
    if (buscaEquipeTimeout) clearTimeout(buscaEquipeTimeout);

    // Espera 500ms para não travar enquanto digita
    buscaEquipeTimeout = setTimeout(() => {
        executarBuscaNoBanco(texto.trim(), container);
    }, 500);
}

// Função para fechar a carteira com estilo e reiniciar
function fecharCarteiraComRestart() {
    // 1. Cria o elemento visual do borrão
    const overlay = document.createElement('div');
    overlay.className = 'blur-transition-overlay';
    document.body.appendChild(overlay);
    
    // 2. Força o navegador a renderizar o elemento (Reflow)
    void overlay.offsetWidth;
    
    // 3. Ativa a animação (dura 1 segundo conforme o CSS)
    overlay.classList.add('blur-transition-active');
    
    // 4. Marca no navegador que o próximo load deve pular a intro
    sessionStorage.setItem('quickRestartV2', 'true');
    
    // 5. Aguarda 1 segundo (tempo do borrão) e Recarrega
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function executarBuscaNoBanco(textoOriginal, container) {
    // Truque: Transforma "joao" em "Joao" para o Firebase achar
    const termoBusca = textoOriginal.charAt(0).toUpperCase() + textoOriginal.slice(1).toLowerCase();
    
    console.log("Buscando no banco por:", termoBusca);

    db.collection('usuarios')
      .where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira'])
      .orderBy('nome')
      .startAt(termoBusca)
      .endAt(termoBusca + '\uf8ff')
      .limit(5)
      .get()
      .then(snap => {
          console.log("Resultados encontrados:", snap.size);
          container.innerHTML = ''; // Limpa o "Buscando..."

          if(snap.empty) { 
              container.innerHTML = '<p style="padding:15px; text-align:center; opacity:0.7; color:#fff;">Nenhum profissional encontrado.</p>'; 
              return; 
          }

          let htmlResultados = '';
          let encontrouAlguemValido = false;

          snap.forEach(doc => {
              // Não mostra a si mesmo
              if (doc.id !== auth.currentUser.uid) {
                  encontrouAlguemValido = true;
                  const u = doc.data();
                  const foto = u.fotoPerfil || u.logo_url || '/icone.png';
                  
                  // Verifica se já está na equipe
                  const jaNaEquipe = perfil.equipe && perfil.equipe.some(m => (m.uid === doc.id || m === doc.id));
                  
                  // Botão Diferente se já estiver na equipe
                  const btnHtml = jaNaEquipe 
                    ? `<span style="font-size:10px; color:#2ecc71; font-weight:bold;">✅ Já na equipe</span>`
                    : `<button onclick="solicitarComissaoEAdicionar('${doc.id}', '${u.nome}')" style="width:auto; padding:6px 12px; font-size:12px; background:var(--cor-destaque); color:#000; font-weight:bold; border:none; border-radius:6px; cursor:pointer;">➕ Convidar</button>`;

                  htmlResultados += `
                    <div class="card" style="padding: 10px; display:flex; justify-content:space-between; align-items:center; background:#222; margin-bottom:1px; border:none; border-bottom:1px solid #333; border-radius:0;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${foto}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #555;">
                            <div>
                                <span style="display:block; font-weight:bold; color:#fff; font-size:14px;">${u.nome}</span>
                                <span style="font-size:10px; color:#aaa;">${u.tipo === 'barbeiro' ? 'Barbeiro' : 'Profissional'}</span>
                            </div>
                        </div>
                        ${btnHtml}
                    </div>`;
              }
          });

          if (!encontrouAlguemValido) {
               container.innerHTML = '<p style="padding:15px; text-align:center; opacity:0.7; color:#fff;">Nenhum profissional encontrado.</p>';
          } else {
               container.innerHTML = htmlResultados;
          }
      })
      .catch(err => {
          console.error("Erro crítico na busca:", err);
          container.innerHTML = `<p style="color:#e74c3c; text-align:center; padding:10px;">Erro: ${err.message}</p>`;
      });
}

async function carregarEquipeComPagamentos() {
    const container = document.getElementById('listaEquipeProprietario');
    if(!container) return; 

    container.innerHTML = '<div class="spinner"></div>';

    try {
        const doc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
        const equipe = doc.data().equipe || [];

        if(equipe.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.5; color:#fff;">
                <p>Sua equipe está vazia.</p>
            </div>`;
            return;
        }

        let html = '';
        
        for (const membro of equipe) {
            const uidMembro = (typeof membro === 'string') ? membro : membro.uid;
            const nomeMembro = (typeof membro === 'string') ? 'Membro' : (membro.nome || 'Profissional');
            const fotoMembro = membro.foto || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            
            html += `
            <div class="card-equipe-premium" style="display:flex; align-items:center; gap:15px; background:#1a1a1a; padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #333;">
                
                <div style="position:relative;">
                    <img src="${fotoMembro}" 
                         onclick="abrirGestaoMembroV2('${uidMembro}')" 
                         style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--cor-destaque); cursor:pointer;">
                </div>

                <div style="flex-grow:1;">
                    <h4 style="margin:0; color:#fff; font-size:16px;">${nomeMembro}</h4>
                    <span style="font-size:11px; color:#aaa;">Clique na foto ou engrenagem para Gerenciar/Pagar</span>
                </div>
                
                <button onclick="abrirGestaoMembroV2('${uidMembro}')" 
                        style="background: #333; color:#fff; border:none; width:35px; height:35px; border-radius:50%; font-size:16px; cursor:pointer;">
                    ⚙️
                </button>
            </div>`;
        }

        container.innerHTML = html;

    } catch(e) {
        console.error(e);
        container.innerHTML = '<p style="color:red">Erro ao carregar equipe.</p>';
    }
}

// =================================================================
// 👑 GESTÃO DE MEMBRO V2 (COM BOTÃO DE NAVEGAÇÃO PARA DASHBOARD)
// =================================================================

async function abrirGestaoMembroV2(uidMembro) {
    const anterior = document.getElementById('modalGestaoV2');
    if (anterior) anterior.remove();

    try {
        const uidDono = auth.currentUser.uid;
        
        // Busca Dados
        const docUser = await db.collection('usuarios').doc(uidMembro).get();
        if (!docUser.exists) return alert("Erro: Usuário não encontrado.");
        const dados = docUser.data();
        const nome = dados.nome || "Membro";
        const foto = dados.fotoPerfil || dados.logo_url || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';

        // LÓGICA DA PORCENTAGEM
        // O banco guarda quanto o SALÃO tira. Vamos converter para quanto o BARBEIRO ganha.
        let taxaSalao = parseFloat(dados.taxaComissao || dados.comissao || 0);
        if (isNaN(taxaSalao)) taxaSalao = 0;
        
        // Ex: Se taxa salão é 40, comissão profissional é 60.
        const comissaoProfissional = 100 - taxaSalao;

        // CALCULA SALDO LÍQUIDO
        const servicosSnap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uidMembro)
            .where('donoUid', '==', uidDono)
            .where('status', 'in', ['concluido', 'avaliado']).get();

        let totalLiquidoProfissional = 0;
        servicosSnap.forEach(doc => {
            const val = parseFloat(doc.data().valor) || 0;
            const ganho = val * (comissaoProfissional / 100);
            totalLiquidoProfissional += ganho;
        });

        const pagosSnap = await db.collection('pagamentos_equipe')
            .where('recebedorUid', '==', uidMembro)
            .where('pagadorUid', '==', uidDono).get();

        let totalJaPago = 0;
        pagosSnap.forEach(doc => totalJaPago += (parseFloat(doc.data().valor) || 0));

        let saldoReal = totalLiquidoProfissional - totalJaPago;
        if (saldoReal > -0.5 && saldoReal < 0.5) saldoReal = 0;

        // Cria Modal
        const modal = document.createElement('div');
        modal.id = 'modalGestaoV2';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 20000; 
            display: flex; align-items: center; justify-content: center;
        `;

        modal.innerHTML = `
        <div style="background: #181818; width: 95%; max-width: 500px; border-radius: 20px; border: 1px solid #333; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.8);">
            
            <button onclick="document.getElementById('modalGestaoV2').remove()" style="position:absolute; top:15px; right:15px; background:rgba(255,255,255,0.1); color:#fff; width:30px; height:30px; border-radius:50%; border:none; cursor:pointer; z-index:10;">✕</button>

            <div style="padding:25px; text-align:center; background: linear-gradient(to bottom, #222, #181818); border-radius: 20px 20px 0 0;">
                <img src="${foto}" style="width:90px; height:90px; border-radius:50%; border:3px solid #d4af37; object-fit:cover; margin-bottom:10px;">
                <h2 style="color:#fff; margin:0 0 5px;">${nome}</h2>
                
                <div onclick="editarComissao('${uidMembro}', '${nome}', ${comissaoProfissional})" 
                     style="background:rgba(212, 175, 55, 0.1); border:1px solid #d4af37; padding:8px 15px; border-radius:20px; display:inline-block; cursor:pointer; margin-top:5px; transition:0.2s;">
                    <span style="color:#aaa; font-size:12px; display:block;">Comissão do Profissional</span>
                    <span style="color:#d4af37; font-size:20px; font-weight:bold;">${comissaoProfissional}% <span style="font-size:14px;">✏️</span></span>
                </div>
            </div>

            <div style="padding:0 25px 25px 25px;">
                <div style="background:#121212; padding:20px; border-radius:15px; text-align:center; border:1px solid ${saldoReal > 0 ? '#f39c12' : '#2ecc71'}; margin-top:20px;">
                    <p style="color:#aaa; font-size:12px; text-transform:uppercase;">SALDO LÍQUIDO A PAGAR</p>
                    <h1 style="color:${saldoReal > 0 ? '#f39c12' : '#2ecc71'}; font-size:36px; margin:5px 0 20px;">
                        ${saldoReal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                    </h1>

                    <button onclick="realizarPagamentoNoBanco('${uidMembro}', ${saldoReal}, '${nome}')" 
                        style="width:100%; padding:14px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; font-size:15px; margin-bottom:10px;
                        background:${saldoReal > 0 ? 'linear-gradient(45deg, #f39c12, #e67e22)' : '#333'}; 
                        color:${saldoReal > 0 ? '#fff' : '#666'};"
                        ${saldoReal <= 0 ? 'disabled' : ''}>
                        ${saldoReal > 0 ? '💸 PAGAR E ZERAR SALDO' : '✅ TUDO PAGO'}
                    </button>

                    <button onclick="abrirModalEntradaManual('${uidMembro}')" 
                        style="width:100%; padding:14px; background: #222; color: #d4af37; border: 1px solid #d4af37; border-radius:10px; cursor:pointer; font-weight:bold;">
                        + Entrada Manual (Balcão)
                    </button>
                </div>

                <button onclick="document.getElementById('modalGestaoV2').remove(); abrirModalDashboardBarbeiro('${uidMembro}')" 
                    style="width:100%; margin-top:15px; padding:12px; background:transparent; color:#888; border:1px solid #333; border-radius:10px; cursor:pointer;">
                    Ver Histórico Completo
                </button>
            </div>
        </div>
        `;

        document.body.appendChild(modal);

    } catch (e) {
        console.error(e);
        alert("Erro ao abrir painel.");
    }
}

// 2. SALVAR TAXA V2 (IMEDIATO)
async function salvarTaxaV2(uid, nome, atual) {
    const nova = prompt(
        `CONFIGURAÇÃO DE COMISSÃO DE ${nome.toUpperCase()}\n\n` +
        `Qual a porcentagem (%) que fica para o SALÃO?\n` +
        `Exemplo: Se você digitar 40, o salão fica com 40% e o profissional com 60%.`, 
        atual
    );
    
    if (!nova) return;
    const valor = parseFloat(nova.replace(',', '.').replace('%', ''));
    if (isNaN(valor)) return alert("Número inválido");

    const batch = db.batch();
    const donoUid = auth.currentUser.uid;

    batch.update(db.collection('usuarios').doc(uid), { taxaComissao: valor, comissao: valor });

    const docDono = await db.collection('usuarios').doc(donoUid).get();
    let equipe = docDono.data().equipe || [];
    let idx = equipe.findIndex(m => (m.uid === uid || m === uid));
    
    if (idx !== -1) {
        if (typeof equipe[idx] === 'string') equipe[idx] = { uid, nome, comissao: valor };
        else equipe[idx].comissao = valor;
    } else {
        equipe.push({ uid, nome, comissao: valor });
    }
    
    batch.update(db.collection('usuarios').doc(donoUid), { equipe });
    await batch.commit();

    alert("✅ Taxa atualizada!");
    abrirGestaoMembroV2(uid); // Recarrega IMEDIATAMENTE
}

async function pagarSaldoV2(uid, nome, valor) {
    if (!confirm(`Confirmar pagamento de ${valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}?`)) return;
    
    exibirAguarde("Registrando saída no caixa...");

    try {
        const batch = db.batch();

        // 1. Registra o pagamento para abater a dívida do profissional
        const pagamentosRef = db.collection('pagamentos_equipe').doc();
        batch.set(pagamentosRef, {
            pagadorUid: auth.currentUser.uid,
            recebedorUid: uid,
            recebedorNome: nome,
            valor: parseFloat(valor),
            data: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. A MÁGICA: Cria o registro no Extrato Financeiro como DESPESA (Saída)
        // O tipo "despesa_comissao" é detectado automaticamente pelo seu painel financeiro como saída
        const extratoRef = db.collection('extrato_financeiro').doc();
        batch.set(extratoRef, {
            donoUid: auth.currentUser.uid, // É uma despesa SUA
            usuarioUid: uid,               // Quem recebeu
            tipo: "despesa_comissao",      // <--- Isso faz aparecer vermelho no gráfico
            descricao: `Pagamento Equipe: ${nome}`,
            valor: parseFloat(valor),
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();

        fecharTodosOsModais(); // Fecha o aguarde
        exibirPopup("Pago!", `O valor foi registrado nas suas SAÍDAS e o saldo de ${nome} foi zerado.`);
        
        // Recarrega o modal do membro para você ver que o saldo zerou
        abrirGestaoMembroV2(uid); 

        // Se o painel financeiro estiver aberto por baixo, força a atualização dele também
        if(document.getElementById('modalFinanceiroProprietario') && document.getElementById('modalFinanceiroProprietario').classList.contains('show')) {
            carregarFinanceiro();
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Erro ao registrar pagamento: " + e.message);
    }
}

async function renderizarGraficoLindo() {
    const canvas = document.getElementById('chartDesempenho');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    try {
        // 1. Busca os Top 7 Barbeiros ordenados por cortesRealizados
        const snapshot = await db.collection('usuarios')
            .where('tipo', '==', 'barbeiro')
            .orderBy('cortesRealizados', 'desc')
            .limit(7)
            .get();

        const labelsProfissionais = [];
        const dadosCortes = [];

        snapshot.forEach(doc => {
            const barp = doc.data();
            // Pega o primeiro nome para não ficar muito grande no gráfico
            const nomeCurto = barp.nome ? barp.nome.split(' ')[0] : 'Profissional';
            labelsProfissionais.push(nomeCurto);
            dadosCortes.push(barp.cortesRealizados || 0);
        });

        // Se o banco estiver vazio, coloca um aviso
        if (labelsProfissionais.length === 0) {
            labelsProfissionais.push("Sem dados");
            dadosCortes.push(0);
        }

        // 2. Criando o Gradiente de Ouro (MANTIDO)
        const gradientGold = ctx.createLinearGradient(0, 0, 0, 400);
        gradientGold.addColorStop(0, 'rgba(255, 215, 0, 0.5)');
        gradientGold.addColorStop(1, 'rgba(255, 215, 0, 0)');

        // 3. Configuração do Chart.js
        new Chart(ctx, {
            type: 'line', // Você pode mudar para 'bar' se preferir um ranking de barras
            data: {
                labels: labelsProfissionais, 
                datasets: [{
                    label: 'Total de Cortes',
                    data: dadosCortes,
                    fill: true,
                    backgroundColor: gradientGold,
                    borderColor: '#FFD700',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#FFD700',
                    pointRadius: 5,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#aaa', stepSize: 1 }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#aaa' }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Erro ao carregar ranking de cortes:", error);
    }
}

// Chame a função
renderizarGraficoLindo();

// Edita Salário e Dia da Secretária
async function editarDadosSecretaria(uid, nome, salarioAtual, diaAtual) {
    const novoSalario = prompt(`Novo Salário para ${nome} (R$):`, salarioAtual);
    if (!novoSalario) return;
    
    const novoDia = prompt(`Novo Dia de Pagamento (1-31):`, diaAtual);
    if (!novoDia) return;

    exibirAguarde("Atualizando...");

    try {
        const donoRef = db.collection('usuarios').doc(auth.currentUser.uid);
        const doc = await donoRef.get();
        let equipeAtual = doc.data().equipe || [];

        // Atualiza no array
        const novaEquipe = equipeAtual.map(m => {
            const idMembro = (typeof m === 'string') ? m : m.uid;
            if (idMembro === uid) {
                // Preserva os dados e atualiza os financeiros
                return { 
                    ...m,
                    uid: uid, 
                    nome: nome, 
                    tipo: 'secretaria',
                    salario: parseFloat(novoSalario),
                    diaPagamento: parseInt(novoDia)
                };
            }
            return m;
        });

        await donoRef.update({ equipe: novaEquipe });
        fecharTodosOsModais();
        exibirPopup("Sucesso", "Dados da secretária atualizados!");
        carregarEquipeComPagamentos();

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// Registra pagamento de salário (não zera pendência, pois é fixo, apenas registra no extrato)
async function realizarPagamentoSalario(uid, nome, valor) {
    if (!confirm(`Confirmar pagamento de SALÁRIO de R$ ${valor} para ${nome}?`)) return;

    exibirAguarde("Registrando...");

    try {
        // Registra no Extrato Financeiro
        await db.collection('extrato_financeiro').add({
            donoUid: auth.currentUser.uid,
            usuarioUid: uid,
            tipo: "pagamento_salario", // Tipo diferente para relatórios
            descricao: `Pagamento Salário (${nome})`,
            valor: parseFloat(valor),
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();
        exibirPopup("Registrado!", "O pagamento foi salvo no seu controle financeiro.");
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// 1. Busca de Usuários (Gera o botão ADD)
function buscarUsuarioEquipeInstantaneo(texto) {
    let containerId = 'resultadoBuscaEquipe'; 
    
    // Verifica se está no modal do proprietário
    const modalProp = document.getElementById('modalGerenciarEquipe');
    if(modalProp && modalProp.classList.contains('show')) {
        const containerProp = modalProp.querySelector('#resultadoBuscaEquipe');
        if(containerProp) {
            atualizarBuscaEquipeContainer(texto, containerProp);
            return;
        }
    }
    
    const container = document.getElementById('resultadoBuscaEquipe');
    atualizarBuscaEquipeContainer(texto, container);
}

function atualizarBuscaEquipeContainer(texto, container) {
    // 1. Tratamento de Maiúsculas/Minúsculas
    // O Firebase diferencia 'a' de 'A'. Como nomes geralmente começam com Maiúscula,
    // transformamos a primeira letra do que foi digitado em Maiúscula.
    // Ex: "joao" vira "Joao".
    const termoBusca = texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();

    // 2. Query Poderosa
    db.collection('usuarios')
      .where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios', 'cabelereira'])
      .orderBy('nome') // Ordena por nome para permitir o busca por prefixo
      .startAt(termoBusca) // Começa onde o nome é igual ao termo
      .endAt(termoBusca + '\uf8ff') // Termina onde o nome deixa de ser igual
      .limit(5) // Traz apenas 5 para ser rápido
      .get()
      .then(snap => {
          container.innerHTML = ''; // Limpa o "Buscando..."

          if(snap.empty) { 
              container.innerHTML = '<p style="padding:10px; text-align:center; opacity:0.7;">Nenhum profissional encontrado.</p>'; 
              return; 
          }

          let encontrouAlguem = false;

          snap.forEach(doc => {
              const u = doc.data();
              // Não mostra a si mesmo na busca
              if (doc.id !== auth.currentUser.uid) {
                  encontrouAlguem = true;
                  const foto = u.fotoPerfil || u.logo_url || '/icone.png';
                  
                  // Verifica se já faz parte da equipe para mudar o botão (Visual apenas)
                  const jaNaEquipe = perfil.equipe && perfil.equipe.some(m => (m.uid === doc.id || m === doc.id));
                  const btnHtml = jaNaEquipe 
                    ? `<span style="font-size:10px; color:#aaa;">Já na equipe</span>`
                    : `<button onclick="solicitarComissaoEAdicionar('${doc.id}', '${u.nome}')" style="width:auto; padding:5px 10px; font-size:12px; background:var(--cor-destaque); color:#000; font-weight:bold;">➕ Convidar</button>`;

                  container.innerHTML += `
                    <div class="card" style="padding: 10px; display:flex; justify-content:space-between; align-items:center; background:#222; margin-bottom:5px; border:1px solid #333;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${foto}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                            <div>
                                <span style="display:block; font-weight:bold; color:#fff;">${u.nome}</span>
                                <span style="font-size:10px; color:#aaa;">${u.tipo}</span>
                            </div>
                        </div>
                        ${btnHtml}
                    </div>`;
              }
          });

          if (!encontrouAlguem) {
               container.innerHTML = '<p style="padding:10px; text-align:center; opacity:0.7;">Nenhum profissional encontrado.</p>';
          }
      })
      .catch(err => {
          console.error("Erro na busca:", err);
          container.innerHTML = '<p style="color:red; text-align:center; padding:10px;">Erro ao buscar.</p>';
      });
}

// 2. Pergunta a Comissão (Chama o envio do convite)
function solicitarComissaoEAdicionar(membroUid, membroNome) {
    const comissao = prompt(`Qual a porcentagem de comissão para ${membroNome}?\n(O profissional receberá um convite para confirmar)\nDigite apenas o número (ex: 50):`, "50");
    
    if (comissao === null) return; // Cancelou
    
    const valorComissao = parseInt(comissao);
    if (isNaN(valorComissao) || valorComissao < 0 || valorComissao > 100) {
        return exibirPopup("Valor inválido", "A comissão deve ser entre 0 e 100.");
    }

    // CHAMA A NOVA FUNÇÃO DE CONVITE (Não adiciona direto!)
    enviarConviteEquipe(membroUid, membroNome, valorComissao);
}

// 3. Envia o Convite (Cria solicitação e Notifica)
async function enviarConviteEquipe(membroUid, membroNome, comissao) {
    exibirAguarde("Enviando convite...");
    
    try {
        // Verifica duplicidade
        const check = await db.collection("solicitacoes")
            .where("tipo", "==", "convite_equipe")
            .where("remetenteUid", "==", auth.currentUser.uid)
            .where("destinatarioUid", "==", membroUid)
            .where("status", "==", "pendente")
            .get();

        if (!check.empty) {
            fecharTodosOsModais(); // Fecha o aguarde
            return exibirPopup("Já enviado", "Você já enviou um convite pendente para este profissional.");
        }

        // Cria a solicitação
        await db.collection("solicitacoes").add({
            tipo: "convite_equipe",
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nomeBarbearia || perfil.nome,
            destinatarioUid: membroUid,
            destinatarioNome: membroNome,
            comissaoProposta: comissao,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Notifica
        notifyUser(membroUid, "📩 Novo Convite!", `${perfil.nome} quer te adicionar à equipe.`, { link: '#convites' });

        fecharTodosOsModais(); // Fecha aguarde
        
        // Popup informativo bonito
        exibirConfirmacao(
            "📨 Convite Enviado!", 
            `O convite foi enviado para ${membroNome} com proposta de ${comissao}%.<br><br>Status: <b style="color:#f1c40f">Aguardando Confirmação...`,
            () => { fecharModalAtual(); }
        );
        // Ajusta botão do popup
        setTimeout(() => {
            const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
            if(btnNao) btnNao.style.display = 'none';
            const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
            if(btnSim) btnSim.textContent = "OK";
        }, 50);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao enviar convite: " + e.message);
    }
}

// 4. Carrega a Equipe (CORRIGIDO PARA NÃO TRAVAR COM ERRO)
async function carregarEquipe() {
    // Tenta pegar o container do modal proprietário ou o do modal funcionário
    let lista = document.getElementById('listaEquipeProprietario');
    if (!lista) lista = document.getElementById('listaEquipeAtual');
    if (!lista) return;

    lista.innerHTML = '<div style="text-align:center;"><div class="spinner"></div></div>';
    
    // Recarrega perfil para garantir dados frescos
    const docUser = await db.collection('usuarios').doc(auth.currentUser.uid).get();
    const dadosPerfil = docUser.data();
    const equipe = dadosPerfil.equipe || [];
    
    if (equipe.length === 0) {
        lista.innerHTML = '<p style="text-align:center; opacity:0.7;">Nenhum membro na equipe.</p>';
        return;
    }
    
    lista.innerHTML = '';
    
    // Processa a lista com segurança
    equipe.forEach(async membro => {
        let uid, comissao;

        // Suporte a legado (se salvou string direto) e novo (objeto)
        if (typeof membro === 'string') {
            uid = membro;
            comissao = 50; // Padrão se não tiver
        } else {
            uid = membro.uid;
            comissao = membro.comissao;
        }

        if(!uid) return; // Pula se estiver quebrado

        try {
            const mDoc = await db.collection('usuarios').doc(uid).get();
            if (mDoc.exists) {
                const m = mDoc.data();
                const foto = m.fotoPerfil || m.logo_url || '/icone.png';
                
                lista.innerHTML += `
                    <div class="membro-equipe-card" style="display:flex; align-items:center; background:var(--cor-botoes); padding:10px; margin-bottom:5px; border-radius:8px; border:1px solid var(--cor-borda);">
                        <img src="${foto}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover;">
                        <div style="flex-grow:1;">
                            <b style="color:#fff;">${m.nome}<br>
                            <small style="color:#aaa;">Comissão: <b style="color:var(--cor-destaque)">${comissao}%</small>
                        </div>
                        <button onclick="removerDaEquipe('${uid}')" style="font-size:12px; padding:5px 8px; width:auto; background:#c0392b;">🗑️</button>
                    </div>`;
            } else {
                // Usuário não existe mais, mostra placeholder
                lista.innerHTML += `
                    <div class="card" style="opacity:0.5;">
                        <small>Usuário removido/não encontrado (UID: ${uid})</small>
                        <button onclick="removerDaEquipe('${uid}')" style="float:right; font-size:10px;">Limpar</button>
                    </div>`;
            }
        } catch(err) {
            console.warn("Erro ao carregar membro:", err);
        }
    });
}

// 5. Remover da Equipe
async function removerDaEquipe(uidAlvo) {
    if(!confirm("Remover este profissional da equipe?")) return;
    
    exibirAguarde("Removendo...");
    try {
        const donoRef = db.collection('usuarios').doc(auth.currentUser.uid);
        const doc = await donoRef.get();
        let equipe = doc.data().equipe || [];
        
        // Filtra removendo o alvo
        const novaEquipe = equipe.filter(m => (typeof m === 'string' ? m !== uidAlvo : m.uid !== uidAlvo));
        
        await donoRef.update({ equipe: novaEquipe });
        
        // Remove o vínculo do profissional também
        await db.collection('usuarios').doc(uidAlvo).update({
            pertenceABarbearia: firebase.firestore.FieldValue.delete(),
            fachada_url: firebase.firestore.FieldValue.delete() // Remove a fachada do dono
        });

        fecharTodosOsModais();
        exibirPopup("Removido com sucesso.");
        
        // Recarrega a lista se o modal estiver aberto
        if(document.getElementById('modalGerenciarEquipe').classList.contains('show')) {
            abrirModalGerenciarEquipe();
        }
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao remover: " + e.message);
    }
}
// --- MODAL DE ENTRADAS (Verde) ---
function abrirModalEntradas() {
    abrirModalFinanceiroEspecifico('entradas');
}

// --- MODAL DE SAÍDAS (Vermelho) ---
function abrirModalSaidas() {
    abrirModalFinanceiroEspecifico('saidas');
}

async function abrirModalFinanceiroEspecifico(tipo) {
    const modal = document.getElementById('modalFinanceiroProprietario');
    modal.classList.add('modal-large');
    abrirModal('modalFinanceiroProprietario');

    const titulo = tipo === 'entradas' ? '📈 Relatório de Entradas' : '📉 Relatório de Saídas';
    const corTema = tipo === 'entradas' ? '#2ecc71' : '#e74c3c';
    
    const content = modal.querySelector('.modal-content');
    content.innerHTML = `
        <div class="modal-header-premium" style="border-bottom: 2px solid ${corTema};">
            <h3 style="margin:0; color:${corTema}; font-size: 22px;">${titulo}</h3>
            <button onclick="fecharModalAtual()" style="background:transparent; border:none; color:#fff; font-size:20px;">✕</button>
        </div>
        
        <div style="flex-grow:1; overflow-y:auto; padding:20px; background:#0f0f0f;">
            <button onclick="abrirModalLancamentoManual('${tipo === 'entradas' ? 'entrada' : 'saida'}')" 
                    style="width:100%; background:${corTema}; color:#000; border:none; padding:15px; border-radius:12px; font-weight:bold; margin-bottom:20px; font-size:16px; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer;">
                ${tipo === 'entradas' ? '➕ Adicionar Entrada Manual' : '➖ Adicionar Saída Manual'}
            </button>

            <div class="chart-card" style="background:#1a1a1a; border-radius:15px; padding:15px; margin-bottom:20px;">
                <canvas id="graficoEspecifico" height="200"></canvas>
            </div>
            
            <div id="resumoDetalhadoHeader"></div>

            <h4 style="color:#fff; margin-bottom:15px; margin-top:20px;">Histórico com Profissionais</h4>
            <div id="listaDetalhesEspecifico" class="scrollable-list">
                <div class="spinner"></div>
            </div>
        </div>
    `;

    // Carregamento de dados com suporte a Fotos
    const agora = new Date();
    const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
    const uidDono = auth.currentUser.uid;

    try {
        const [snapExtrato, snapAgendamentos] = await Promise.all([
            db.collection('extrato_financeiro').where('donoUid', '==', uidDono).where('dataEvento', '>=', firebase.firestore.Timestamp.fromDate(inicioMes)).get(),
            db.collection('agendamentos').where('donoUid', '==', uidDono).where('status', '==', 'concluido').where('ts', '>=', firebase.firestore.Timestamp.fromDate(inicioMes)).get()
        ]);

        let total = 0, tPix = 0, tDin = 0, tDeb = 0, tCred = 0;
        const dadosGrafico = {};
        const itensMostrar = [];
        const uidsFotos = new Set();

        // 1. Processa Extrato (Geral)
        snapExtrato.forEach(doc => {
            const d = doc.data();
            const ehOItem = (tipo === 'entradas' && (d.tipo.includes('entrada') || d.tipo.includes('receita'))) ||
                           (tipo === 'saidas' && (d.tipo.includes('saida') || d.tipo.includes('despesa') || d.tipo.includes('pagamento')));
            
            if (ehOItem) {
                const val = Number(d.valor) || 0;
                total += val;
                if (d.metodos) {
                    tPix += (d.metodos.pix || 0); tDin += (d.metodos.dinheiro || 0);
                    tDeb += (d.metodos.debito || 0); tCred += (d.metodos.credito || 0);
                } else { tDin += val; }
                
                const data = d.dataEvento.toDate();
                const dia = data.toLocaleDateString('pt-BR');
                dadosGrafico[dia] = (dadosGrafico[dia] || 0) + val;
                if (d.usuarioUid) uidsFotos.add(d.usuarioUid);
                itensMostrar.push({ ...d, data, valor: val, uidProfissional: d.usuarioUid, ehEntrada: tipo === 'entradas' });
            }
        });

        // 2. Processa Agendamentos (Apenas se for relatório de Entradas)
        if (tipo === 'entradas') {
            snapAgendamentos.forEach(doc => {
                const ag = doc.data();
                const val = Number(ag.valor) || 0;
                total += val;
                if (ag.metodosPagamento) {
                    tPix += (ag.metodosPagamento.pix || 0); tDin += (ag.metodosPagamento.dinheiro || 0);
                    tDeb += (ag.metodosPagamento.debito || 0); tCred += (ag.metodosPagamento.credito || 0);
                } else { tDin += val; }
                
                const data = ag.ts.toDate();
                const dia = data.toLocaleDateString('pt-BR');
                dadosGrafico[dia] = (dadosGrafico[dia] || 0) + val;
                if (ag.barbeiroUid) uidsFotos.add(ag.barbeiroUid);
                itensMostrar.push({ descricao: `Serviço: ${ag.servico}`, data, valor: val, uidProfissional: ag.barbeiroUid, ehEntrada: true });
            });
        }

        // 3. Busca fotos dos envolvidos
        const mapaFotos = {};
        await Promise.all(Array.from(uidsFotos).map(async uid => {
            const u = (await db.collection('usuarios').doc(uid).get()).data();
            mapaFotos[uid] = u?.fotoPerfil || u?.logo_url || '/icone.png';
        }));

        // 4. Renderiza a Lista 3D
        itensMostrar.sort((a,b) => b.data - a.data);
        let htmlLista = "";
        itensMostrar.forEach(item => {
            const foto = mapaFotos[item.uidProfissional] || '/icone.png';
            htmlLista += renderizarCardFinanceiro3D(item, corTema, foto);
        });

        document.getElementById('listaDetalhesEspecifico').innerHTML = htmlLista || '<p style="text-align:center; padding:20px; opacity:0.5;">Sem registros.</p>';
        
        // Injeta o Resumo de Métodos
        document.getElementById('resumoDetalhadoHeader').innerHTML = `
            <div style="background: #1a1a1a; border-radius: 12px; padding: 15px; border: 1px solid #333;">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px; border-bottom:1px solid #333; padding-bottom:10px;">
                    <span style="color:#aaa;">SOMA TOTAL</span>
                    <span style="color:#fff; font-size:20px; font-weight:bold;">R$ ${total.toFixed(2)}</span>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px;">
                    <div style="display:flex; justify-content:space-between;"><span style="color:#00C851">Pix</span> <b>R$ ${tPix.toFixed(2)}</b></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:#33b5e5">Dinheiro</span> <b>R$ ${tDin.toFixed(2)}</b></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:#ffbb33">Débito</span> <b>R$ ${tDeb.toFixed(2)}</b></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:#ff4444">Crédito</span> <b>R$ ${tCred.toFixed(2)}</b></div>
                </div>
            </div>
        `;

        // Renderiza o gráfico linear (usando sua lógica original)
        renderizarGraficoLinearFinanceiro(dadosGrafico, corTema, tipo);

    } catch (e) { console.error(e); }
}

function renderizarCardFinanceiro3D(item, cor, fotoUrl) {
    // 1. Formata a hora: 14:05, 09:30, etc.
    const horas = item.data.getHours().toString().padStart(2, '0');
    const minutos = item.data.getMinutes().toString().padStart(2, '0');
    const horarioFormatado = `${horas}:${minutos}`;

    // 2. BLINDAGEM: Trata aspas para não quebrar o HTML do botão
    const descricaoSegura = (item.descricao || 'Lançamento').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    
    // 3. IDENTIFICAÇÃO: Pega o ID e a Coleção de Origem (extrato_financeiro ou agendamentos)
    const idSeguro = item.id;
    const origemSegura = item.colecaoOrigem || ''; 

    return `
    <div class="card-financeiro gsap-feed-item" style="position: relative; margin: 15px 10px 20px 35px; background: #222; border-radius: 12px; border-left: 5px solid ${cor}; padding: 15px 15px 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 15px rgba(0,0,0,0.4); z-index: 1;">
        
        <div style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; border-radius: 50%; border: 3px solid ${cor}; box-shadow: 5px 5px 15px rgba(0,0,0,0.6); background: #000; overflow: hidden; z-index: 99;">
            <img src="${fotoUrl}" onerror="this.src='/icone.png'" style="width:100%; height:100%; object-fit:cover;">
        </div>

        <div style="flex-grow:1;">
            <div style="color:#fff; font-weight:bold; font-size:14px; text-transform:capitalize;">${item.descricao || 'Lançamento'}</div>
            <div style="color:#888; font-size:11px; margin-top:3px; display:flex; gap:10px;">
                <span>📅 ${item.data.toLocaleDateString('pt-BR')}</span>
                <span style="color:#bbb;">⏰ ${horarioFormatado}</span>
            </div>
            ${origemSegura === 'agendamentos' ? '<div style="font-size:9px; color:#f1c40f; margin-top:2px;">🔔 Pendente no Extrato</div>' : ''}
        </div>

        <div style="text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
            <div style="color:${cor}; font-weight:bold; font-size:16px;">
                ${item.ehEntrada ? '+' : '-'} R$ ${item.valor.toFixed(2)}
            </div>
            
            <button onclick="excluirMovimentacaoFinanceira('${idSeguro}', '${descricaoSegura}', '${origemSegura}')" 
                    style="background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; cursor: pointer; font-size: 13px; padding: 6px 12px; border-radius: 6px; margin-top: 5px; font-weight: bold; transition: 0.2s;">
                🗑️ Excluir
            </button>
        </div>
    </div>`;
}

async function excluirMovimentacaoFinanceira(id, descricao) {
    if (!id) return;

    const confirmar = confirm(`⚠️ EXCLUSÃO DEFINITIVA\n\nRegistro: "${descricao}"\n\nDeseja apagar este lançamento de TODOS os registros (Extrato e Agenda)?`);
    if (!confirmar) return;

    exibirAguarde("Limpando banco de dados...");

    try {
        // 1. Criamos as referências iniciais
        const refExtrato = db.collection('extrato_financeiro').doc(id);
        const refAgendamento = db.collection('agendamentos').doc(id);

        // 2. BUSCA CRUZADA: Vamos ver se esse ID tem um "parceiro" vinculado
        const [docExtrato, docAgendamento] = await Promise.all([
            refExtrato.get(),
            refAgendamento.get()
        ]);

        const batch = db.batch(); // Usamos Batch para deletar tudo de uma vez só

        // Caso A: O ID clicado era de um Extrato
        if (docExtrato.exists) {
            batch.delete(refExtrato);
            const dados = docExtrato.data();
            // Se dentro do extrato existia o ID do agendamento, marcamos para deletar também
            if (dados.agendamentoId) {
                const parceiroRef = db.collection('agendamentos').doc(dados.agendamentoId);
                batch.delete(parceiroRef);
            }
        }

        // Caso B: O ID clicado era de um Agendamento
        if (docAgendamento.exists) {
            batch.delete(refAgendamento);
            // Procuramos no extrato se existe algum documento apontando para este agendamento
            const extratosVinculados = await db.collection('extrato_financeiro')
                .where('agendamentoId', '==', id).get();
            
            extratosVinculados.forEach(docVinculado => {
                batch.delete(docVinculado.ref);
            });
        }

        // Caso C: Segurança (Tenta deletar o ID puro nas duas, caso não tenha entrado nos ifs acima)
        if (!docExtrato.exists && !docAgendamento.exists) {
            batch.delete(refExtrato);
            batch.delete(refAgendamento);
        }

        // 3. EXECUTA A LIMPEZA
        await batch.commit();

        console.log("Sucesso: Registros removidos de ambas as coleções.");
        
        // 4. FINALIZAÇÃO
        fecharAguarde();
        exibirPopup("Excluído", "O registro foi removido completamente.");

        // Força o recarregamento da lista
        if (typeof carregarFinanceiro === 'function') {
            setTimeout(() => {
                carregarFinanceiro();
            }, 400);
        }

    } catch (error) {
        console.error("Erro crítico na exclusão:", error);
        fecharAguarde(); // Garante que o popup de "Aguarde" não fique eterno
        alert("Erro ao excluir do banco: " + error.message);
    }
}

async function realizarPagamentoEquipe(uidProfissional, nomeProfissional, valor) {
    if (valor <= 0) return exibirPopup("Sem pendências", "Este profissional não tem valores a receber.");

    const confirmacao = confirm(`Confirmar que você PAGOU R$ ${valor.toFixed(2)} presencialmente para ${nomeProfissional}?\n\nIsso zerará o contador de pendência dele.`);
    if (!confirmacao) return;

    exibirAguarde("Registrando baixa...");

    try {
        const batch = db.batch();
        
        // 1. Zera o pendente do Profissional (Perfil dele)
        const profRef = db.collection('usuarios').doc(uidProfissional);
        batch.update(profRef, { faturamentoPendente: 0 });

        // 2. Registra o Pagamento no Extrato (Visível para AMBOS)
        const extratoRef = db.collection('extrato_financeiro').doc();
        batch.set(extratoRef, {
            donoUid: auth.currentUser.uid,      // Dono vê como Despesa
            usuarioUid: uidProfissional,        // Profissional vê como Recebimento
            tipo: "pagamento_comissao",         // Novo tipo para identificar pagamento
            descricao: `Pagamento de Comissão`, // Texto para o extrato
            valor: valor,
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();

        notifyUser(uidProfissional, "✅ Pagamento Recebido", `O proprietário registrou o pagamento de R$ ${valor.toFixed(2)}.`);

        fecharTodosOsModais();
        exibirPopup("Baixa Efetuada!", `O valor foi zerado e o pagamento registrado.`);
        
        // Recarrega a lista do proprietário
        abrirModalGerenciarEquipe();

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// --- FACHADA ---
function abrirModalFachada() {
    abrirModal('modalFachada');
}

async function salvarFachada() {
    const file = document.getElementById('fachadaFile').files[0];
    if (!file) return exibirPopup("Selecione uma imagem.");
    
    exibirAguarde("Enviando...");
    const url = await uploadImage(file, `fachadas/${auth.currentUser.uid}`);
    
    // Salva no perfil do Dono
    await db.collection('usuarios').doc(auth.currentUser.uid).update({ fachada_url: url });
    
    // (Opcional) Atualizar todos os membros da equipe com a referência da fachada
    // Mas é mais eficiente carregar a fachada do dono na hora de abrir o perfil
    
    fecharTodosOsModais();
    exibirPopup("Fachada salva!");
}

// Variáveis globais
let chartDespesasInstance = null;
let cacheTransacoesFinanceiras = []; // <--- NOVA VARIÁVEL PARA GUARDAR OS DADOS

async function abrirModalFinanceiroProprietario() {
    abrirModal('modalFinanceiroProprietario');
    const modalContent = document.querySelector('#modalFinanceiroProprietario .modal-content');
    
    // MANTIDO (Estilo base)
    modalContent.style.cssText = "display: flex !important; flex-direction: column !important; max-height: 90vh !important; height: 90vh !important; padding: 0 !important; overflow: hidden !important; background: #000;";
    
    const hoje = new Date();
    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    const formatarDataInput = (d) => d.toISOString().split('T')[0];

    modalContent.innerHTML = `
        <div style="flex-shrink: 0; padding: 15px; border-bottom: 1px solid #333; background:#111; text-align:center; z-index: 2;">
            <h3 style="margin:0; color:var(--cor-destaque);">📊 Gestão Completa</h3>
            <p style="font-size:12px; color:#aaa; margin:0;">Controle de Caixa</p>
        </div>

        <div id="gestaoBodyScroll" style="flex-grow: 1; overflow-y: auto; padding: 15px; min-height: 0; position: relative;">
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="abrirModalLancamentoManual('entrada')" style="flex:1; background: linear-gradient(145deg, #1a1a1a, #0f0f0f); border:1px solid #2ecc71; color:#2ecc71; padding:15px; font-weight:bold;">
                    📈 REGISTRAR<br>ENTRADA
                </button>
                <button onclick="abrirModalRegistrarDespesa()" style="flex:1; background: linear-gradient(145deg, #1a1a1a, #0f0f0f); border:1px solid #e74c3c; color:#e74c3c; padding:15px; font-weight:bold;">
                    📉 REGISTRAR<br>SAÍDA
                </button>
            </div>

            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button onclick="carregarFinanceiro('dia')" style="flex:1; font-size:10px; padding:8px;">Hoje</button>
                <button onclick="carregarFinanceiro('semana')" style="flex:1; font-size:10px; padding:8px;">Semana</button>
                <button onclick="carregarFinanceiro('mes')" style="flex:1; font-size:10px; padding:8px; background:var(--cor-destaque); color:black;">Mês</button>
            </div>
            
            <div style="background:#111; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; gap:5px; align-items:center;">
                <input type="date" id="finDataInicio" value="${formatarDataInput(inicioMes)}" style="flex:1; font-size:11px; background:#222; border:none; color:#fff;">
                <span style="font-size:10px;">até</span>
                <input type="date" id="finDataFim" value="${formatarDataInput(hoje)}" style="flex:1; font-size:11px; background:#222; border:none; color:#fff;">
                <button onclick="carregarFinanceiro('custom')" style="width:auto; padding:5px 10px;">🔍</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div style="background:#1a1a1a; padding:10px; border-radius:8px; border-top: 3px solid #2ecc71;">
                    <span style="font-size:10px; color:#aaa; display:block;">ENTRADAS</span>
                    <span id="resumoEntradas" style="font-size:16px; font-weight:bold; color:#2ecc71;">R$ ...</span>
                </div>
                <div style="background:#1a1a1a; padding:10px; border-radius:8px; border-top: 3px solid #e74c3c;">
                    <span style="font-size:10px; color:#aaa; display:block;">SAÍDAS</span>
                    <span id="resumoSaidas" style="font-size:16px; font-weight:bold; color:#e74c3c;">R$ ...</span>
                </div>
                <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #111, #000); padding:15px; border-radius:8px; border: 1px solid var(--cor-destaque); text-align:center; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.15);">
                    <span style="font-size:12px; color:#aaa; display:block; text-transform:uppercase; letter-spacing: 1px;">Saldo Líquido</span>
                    <span id="resumoSaldo" style="font-size:28px; font-weight:bold; color:#fff;">R$ ...</span>
                </div>
            </div>

            <h4 style="font-size:12px; color:#888; margin-bottom:5px; text-transform:uppercase;">📈 Evolução do Lucro</h4>
            <div style="background: linear-gradient(to bottom, #1a1a1a, #0f0f0f); padding: 10px; border-radius: 12px; border: 1px solid #333; box-shadow: inset 0 0 20px #000; margin-bottom: 20px;">
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="graficoEvolucaoLucro"></canvas>
                </div>
            </div>

            <h4 style="font-size:12px; color:#888; margin-bottom:5px; text-transform:uppercase;">📉 Distribuição de Despesas</h4>
            <div style="background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333;">
                <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:center;">
                    <div style="width: 140px; height: 140px; position: relative;">
                        <canvas id="chartDespesasCategoria"></canvas>
                    </div>
                    <div id="legendaDespesas" style="flex:1; margin-left:15px; display:flex; flex-direction:column; gap:5px; min-width:120px; font-size:11px;"></div>
                </div>
            </div>

            <h4 style="font-size:12px; color:#888; margin-bottom:5px; text-transform:uppercase;">💳 Métodos de Pagamento</h4>
            <div style="background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333;">
                <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:center;">
                    <div style="width: 140px; height: 140px; position: relative;">
                        <canvas id="chartMetodosPagamento"></canvas>
                    </div>
                    <div id="legendaMetodos" style="flex:1; margin-left:15px; display:flex; flex-direction:column; gap:5px; min-width:120px;"></div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <h4 style="font-size:14px; margin-bottom:10px; border-left:3px solid var(--cor-destaque); padding-left:10px;">Movimentações Recentes</h4>
                
                <div id="filtrosFinanceirosContainer" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; align-items: flex-start;">
                    
                    <button onclick="filtrarListaFinanceira('todas')" class="btn-filtro-cat ativo" 
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 50px; height: 50px; padding: 0; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff;">
                        <span style="font-size: 16px; line-height:1;">🔁</span>
                        <span style="font-size: 9px; margin-top:3px; font-weight:bold;">Todos</span>
                    </button>

                    <button onclick="filtrarListaFinanceira('servico')" class="btn-filtro-cat" 
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 50px; height: 50px; padding: 0; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff;">
                        <span style="font-size: 16px; line-height:1;">✂️</span>
                        <span style="font-size: 9px; margin-top:3px; font-weight:bold;">Serv.</span>
                    </button>

                    <button onclick="filtrarListaFinanceira('fixa')" class="btn-filtro-cat" 
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 50px; height: 50px; padding: 0; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff;">
                        <span style="font-size: 16px; line-height:1;">🔒</span>
                        <span style="font-size: 9px; margin-top:3px; font-weight:bold;">Fixas</span>
                    </button>

                    <button onclick="filtrarListaFinanceira('variavel')" class="btn-filtro-cat" 
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 50px; height: 50px; padding: 0; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff;">
                        <span style="font-size: 16px; line-height:1;">📉</span>
                        <span style="font-size: 9px; margin-top:3px; font-weight:bold;">Var.</span>
                    </button>

                    <button onclick="filtrarListaFinanceira('investimento')" class="btn-filtro-cat" 
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 50px; height: 50px; padding: 0; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff;">
                        <span style="font-size: 16px; line-height:1;">🚀</span>
                        <span style="font-size: 9px; margin-top:3px; font-weight:bold;">Inv.</span>
                    </button>

                    <button onclick="filtrarListaFinanceira('imposto')" class="btn-filtro-cat" 
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-width: 50px; height: 50px; padding: 0; border-radius: 10px; border: 1px solid #333; background: #222; color: #fff;">
                        <span style="font-size: 16px; line-height:1;">🏛️</span>
                        <span style="font-size: 9px; margin-top:3px; font-weight:bold;">Imp.</span>
                    </button>

                </div>
            </div>

            <div id="listaGanhosEquipe"></div>
            
            <div style="height: 50px;"></div> 
        </div>

        <div style="flex-shrink: 0; padding: 10px; border-top: 1px solid #333; background:#111;">
            <button onclick="fecharModalAtual()" style="background:#333; width:100%;">❌ Fechar</button>
        </div>
    `;
    
    setTimeout(() => {
        carregarFinanceiro('mes'); 
    }, 100);
}

async function carregarFinanceiro(periodo = 'mes') {
    const elEntradas = document.getElementById('resumoEntradas');
    const elSaidas = document.getElementById('resumoSaidas');
    const elSaldo = document.getElementById('resumoSaldo');
    const lista = document.getElementById('listaGanhosEquipe');

    if (!elSaldo || !lista) return;
    lista.innerHTML = '<div class="spinner"></div>';

    const agora = new Date();
    let dataInicio, dataFim;

    // --- LÓGICA DE DATAS (INTACTA) ---
    if (periodo === 'custom') {
        const inpInicio = document.getElementById('finDataInicio').value;
        const inpFim = document.getElementById('finDataFim').value;
        if (!inpInicio || !inpFim) return;
        dataInicio = new Date(inpInicio + 'T00:00:00');
        dataFim = new Date(inpFim + 'T23:59:59');
    } else {
        dataFim = new Date();
        dataFim.setHours(23, 59, 59, 999);
        if (periodo === 'dia') {
            dataInicio = new Date(agora);
            dataInicio.setHours(0, 0, 0, 0);
        } else if (periodo === 'semana') {
            dataInicio = new Date(agora);
            const diff = agora.getDate() - agora.getDay() + (agora.getDay() === 0 ? -6 : 1);
            dataInicio.setDate(diff); dataInicio.setHours(0, 0, 0, 0);
        } else {
            dataInicio = new Date(agora.getFullYear(), agora.getMonth(), 1);
            dataInicio.setHours(0, 0, 0, 0);
        }
    }

    try {
        const uidDono = auth.currentUser.uid;
        
        // --- BUSCA NO BANCO (INTACTA) ---
        const [snapExtrato, snapAgendamentos] = await Promise.all([
            db.collection('extrato_financeiro').where('donoUid', '==', uidDono)
                .where('dataEvento', '>=', firebase.firestore.Timestamp.fromDate(dataInicio))
                .where('dataEvento', '<=', firebase.firestore.Timestamp.fromDate(dataFim)).get(),
            db.collection('agendamentos').where('donoUid', '==', uidDono).where('status', '==', 'concluido')
                .where('ts', '>=', firebase.firestore.Timestamp.fromDate(dataInicio))
                .where('ts', '<=', firebase.firestore.Timestamp.fromDate(dataFim)).get()
        ]);

        let totalEntradas = 0, totalSaidas = 0;
        let mPix = 0, mDinheiro = 0, mDebito = 0, mCredito = 0;
        const despesasCategorias = { 'fixa': 0, 'variavel': 0, 'investimento': 0, 'imposto': 0 };

        const itens = [];
        const idsAgendamentosJaProcessados = new Set(); 
        const uidsParaBuscarFoto = new Set();
        const mapaResultados = {};

        // 1. PROCESSAMOS EXTRATO
        snapExtrato.forEach(doc => {
            const d = doc.data();
            const val = Number(d.valor) || 0;
            const data = d.dataEvento.toDate();
            const diaStr = data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            
            if (d.agendamentoId) idsAgendamentosJaProcessados.add(d.agendamentoId);

            const ehEntrada = d.tipo.includes('entrada') || d.tipo.includes('receita');
            if (ehEntrada) {
                totalEntradas += val;
                mapaResultados[diaStr] = (mapaResultados[diaStr] || 0) + val;
                if (d.metodos) {
                    mPix += (d.metodos.pix || 0); mDinheiro += (d.metodos.dinheiro || 0);
                    mDebito += (d.metodos.debito || 0); mCredito += (d.metodos.credito || 0);
                } else { mDinheiro += val; }
            } else {
                totalSaidas += val;
                mapaResultados[diaStr] = (mapaResultados[diaStr] || 0) - val;
                
                if (d.categoria && despesasCategorias[d.categoria] !== undefined) {
                    despesasCategorias[d.categoria] += val;
                } else {
                    despesasCategorias['variavel'] += val;
                }
            }
            if (d.usuarioUid) uidsParaBuscarFoto.add(d.usuarioUid);
            itens.push({ ...d, id: doc.id, valor: val, data, ehEntrada, uidProfissional: d.usuarioUid });
        });

        // 2. PROCESSAMOS AGENDAMENTOS
        snapAgendamentos.forEach(doc => {
            if (idsAgendamentosJaProcessados.has(doc.id)) return;
            const ag = doc.data();
            const val = parseFloat(ag.valor) || 0;
            const dataAg = ag.ts?.toDate() || new Date();
            const diaStr = dataAg.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});

            totalEntradas += val;
            mapaResultados[diaStr] = (mapaResultados[diaStr] || 0) + val;
            
            if (ag.metodosPagamento) {
                mPix += (ag.metodosPagamento.pix || 0); mDinheiro += (ag.metodosPagamento.dinheiro || 0);
                mDebito += (ag.metodosPagamento.debito || 0); mCredito += (ag.metodosPagamento.credito || 0);
            } else { mDinheiro += val; }
            
            if (ag.barbeiroUid) uidsParaBuscarFoto.add(ag.barbeiroUid);
            itens.push({ id: doc.id, descricao: `Serviço: ${ag.servico}`, valor: val, data: dataAg, ehEntrada: true, uidProfissional: ag.barbeiroUid });
        });

        // --- BUSCA FOTOS ---
        const mapaFotos = {};
        await Promise.all(Array.from(uidsParaBuscarFoto).map(async uid => {
            if(!uid) return;
            const u = (await db.collection('usuarios').doc(uid).get()).data();
            mapaFotos[uid] = u?.fotoPerfil || u?.logo_url || '/icone.png';
        }));

        // Ordena
        itens.sort((a, b) => b.data - a.data);

        // --- SALVA NO CACHE GLOBAL E INJETA FOTOS ---
        cacheTransacoesFinanceiras = itens.map(item => {
             // Injeta a URL da foto direto no objeto pra não precisar buscar de novo depois
             item.fotoUrlCache = mapaFotos[item.uidProfissional] || '/icone.png';
             return item;
        });
        
        // --- ATUALIZA TOTAIS E GRÁFICOS ---
        elEntradas.textContent = `R$ ${totalEntradas.toFixed(2)}`;
        elSaidas.textContent = `R$ ${totalSaidas.toFixed(2)}`;
        const saldoFinal = totalEntradas - totalSaidas;
        elSaldo.textContent = `R$ ${saldoFinal.toFixed(2)}`;
        elSaldo.style.color = saldoFinal >= 0 ? '#2ecc71' : '#e74c3c';

        if (typeof renderizarGraficoResultados === 'function') renderizarGraficoResultados(mapaResultados);
        if (typeof renderizarGraficoMetodos === 'function') renderizarGraficoMetodos(mPix, mDinheiro, mDebito, mCredito);
        renderizarGraficoDespesasDetalhado(despesasCategorias);

        // --- RENDERIZA A LISTA (Começa exibindo TODOS) ---
        filtrarListaFinanceira('todas');

    } catch (e) { 
        console.error(e);
        lista.innerHTML = `<p style="color:red; text-align:center;">Erro: ${e.message}</p>`;
    }
}

// ======================================================
// 🎯 FUNÇÃO DE FILTRO DA LISTA FINANCEIRA
// ======================================================
function filtrarListaFinanceira(filtro) {
    const lista = document.getElementById('listaGanhosEquipe');
    if(!lista) return;

    lista.innerHTML = '';

    // 1. Atualiza visual dos botões (Mantendo o layout flex)
    document.querySelectorAll('.btn-filtro-cat').forEach(btn => {
        // Verifica se o texto do onclick bate com o filtro
        if(btn.getAttribute('onclick').includes(`'${filtro}'`)) {
            // ATIVO
            btn.style.background = '#e74c3c'; 
            btn.style.borderColor = '#e74c3c';
            btn.style.transform = 'scale(1.05)'; // Leve destaque de tamanho
        } else {
            // INATIVO
            btn.style.background = '#222'; 
            btn.style.borderColor = '#333';
            btn.style.transform = 'scale(1)';
        }
        btn.style.transition = 'all 0.2s ease';
    });

    // 2. Filtra o Array Global (Cache)
    let itensFiltrados = [];

    if (filtro === 'todas') {
        itensFiltrados = cacheTransacoesFinanceiras;
    } 
    else if (filtro === 'servico') {
        itensFiltrados = cacheTransacoesFinanceiras.filter(i => i.ehEntrada === true);
    } 
    else {
        // Saídas (fixa, variavel, investimento, imposto)
        itensFiltrados = cacheTransacoesFinanceiras.filter(i => i.ehEntrada === false && i.categoria === filtro);
    }

    // 3. Renderiza
    if (itensFiltrados.length === 0) {
        lista.innerHTML = '<p style="text-align:center; opacity:0.5; padding:20px;">Nenhuma movimentação nesta categoria.</p>';
        return;
    }

    let html = '';
    itensFiltrados.forEach(item => {
        const cor = item.ehEntrada ? '#2ecc71' : '#e74c3c';
        
        let descFinal = item.descricao;
        if(!item.ehEntrada && item.categoria) {
            const icones = { 'fixa':'🔒', 'variavel':'📉', 'investimento':'🚀', 'imposto':'🏛️' };
            descFinal = `${icones[item.categoria] || ''} ${item.descricao}`;
        }

        // Usa a foto do cache
        html += renderizarCardFinanceiro3D({ ...item, descricao: descFinal }, cor, item.fotoUrlCache);
    });

    lista.innerHTML = html;

    // 4. Animação GSAP
    if (typeof gsap !== "undefined" && typeof ScrollTrigger !== "undefined") {
        gsap.registerPlugin(ScrollTrigger);
        ScrollTrigger.getAll().forEach(t => t.kill()); 
        
        const cards = gsap.utils.toArray(".gsap-feed-item");
        cards.forEach((card) => {
            gsap.fromTo(card, { opacity: 0, y: 20 }, {
                opacity: 1, y: 0, duration: 0.3, ease: "power2.out",
                scrollTrigger: { trigger: card, scroller: "#gestaoBodyScroll", start: "top 100%" }
            });
        });
    }
}

// ======================================================
// 📊 NOVO GRÁFICO: DISTRIBUIÇÃO DE DESPESAS (COM VALOR R$)
// ======================================================
function renderizarGraficoDespesasDetalhado(dados) {
    const canvas = document.getElementById('chartDespesasCategoria');
    const containerLegenda = document.getElementById('legendaDespesas');
    
    if(!canvas || !containerLegenda) return;

    // Destroi gráfico anterior se existir
    if (chartDespesasInstance) {
        chartDespesasInstance.destroy();
        chartDespesasInstance = null;
    }

    const labels = ['Fixas', 'Variáveis', 'Investimento', 'Impostos'];
    const valores = [dados.fixa, dados.variavel, dados.investimento, dados.imposto];
    // Cores: Azul, Amarelo, Verde Neon, Roxo
    const cores = ['#3498db', '#f1c40f', '#2ecc71', '#9b59b6'];

    // Se não tiver despesa nenhuma, limpa
    if(valores.every(v => v === 0)) {
        containerLegenda.innerHTML = "<span style='color:#555; font-style:italic;'>Sem despesas no período.</span>";
        // Limpa visualmente o canvas
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }

    // Cria o gráfico Doughnut
    const ctx = canvas.getContext('2d');
    chartDespesasInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores,
                borderWidth: 0,
                hoverOffset: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%', // Espessura da rosca
            plugins: {
                legend: { display: false }, // Esconde legenda padrão do Chart.js
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            return `${label}: R$ ${value.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });

    // Gera a Legenda Customizada (HTML) ao lado
    containerLegenda.innerHTML = '';
    const total = valores.reduce((a,b) => a+b, 0);
    
    labels.forEach((label, i) => {
        if(valores[i] > 0) {
            const perc = ((valores[i] / total) * 100).toFixed(0);
            const valorReais = valores[i].toFixed(2); // Valor formatado

            containerLegenda.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%; margin-bottom:6px; color:#ccc;">
                    
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:10px; height:10px; border-radius:50%; background:${cores[i]}"></div>
                        <span style="font-size:11px;">${label}</span>
                    </div>
                    
                    <div style="text-align:right;">
                        <span style="font-size:11px; font-weight:bold; color:#fff;">${perc}%</span>
                        <span style="font-size:10px; color:#888; margin-left:3px;">(R$ ${valorReais})</span>
                    </div>

                </div>
            `;
        }
    });
}

// ======================================================
// 💸 LÓGICA DE REGISTRO DE DESPESAS (COLE NO FINAL DO ARQUIVO)
// ======================================================

// 1. Configuração das categorias e sugestões
const CATEGORIAS_DESPESAS = {
    'fixa': {
        label: '🔒 Contas Fixas',
        sugestoes: ['Aluguel', 'Energia', 'Água', 'Internet', 'Sistema', 'Salário Fixo', 'Contabilidade']
    },
    'variavel': {
        label: '📉 Variáveis/Insumos',
        sugestoes: ['Comissão Funcionário', 'Produtos', 'Descartáveis', 'Lanche', 'Manutenção', 'Combustível']
    },
    'investimento': {
        label: '🚀 Investimentos',
        sugestoes: ['Móveis', 'Reforma', 'Equipamentos', 'Cursos', 'Marketing', 'Computador']
    },
    'imposto': {
        label: '🏛️ Impostos/Taxas',
        sugestoes: ['MEI (DAS)', 'INSS', 'Taxa Maquininha', 'Alvará', 'IPTU', 'Tarifa Bancária']
    }
};

// 2. Abre o Modal de Registro (O botão chama ISSO aqui)
function abrirModalRegistrarDespesa() {
    const modalId = 'modalRegistrarDespesaDetalhada';
    
    // Remove anterior se existir para limpar memória e evitar duplicação
    if(document.getElementById(modalId)) document.getElementById(modalId).remove();

    const hoje = new Date().toISOString().split('T')[0];

    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal show';
    modal.style.cssText = "z-index: 20000; display: flex;";

    modal.innerHTML = `
        <div class="modal-content" style="border: 2px solid #e74c3c;">
            <h3 style="color: #e74c3c; margin-top:0;">💸 Registrar Saída</h3>
            <p style="font-size:12px; color:#aaa; margin-bottom:15px;">Classifique a despesa para gerar gráficos.</p>

            <div class="form-despesa-container">
                
                <div class="form-group-despesa">
                    <label>Valor (R$)</label>
                    <input type="number" id="inputDespesaValor" class="form-input-despesa" placeholder="0.00" inputmode="decimal">
                </div>

                <div class="form-group-despesa">
                    <label>Categoria</label>
                    <select id="selectDespesaCategoria" class="form-select-despesa" onchange="atualizarChipsDespesa()">
                        <option value="" disabled selected>Selecione o tipo...</option>
                        <option value="fixa">🔒 Fixa (Mensal)</option>
                        <option value="variavel">📉 Variável (Esporádica)</option>
                        <option value="investimento">🚀 Investimento (Crescimento)</option>
                        <option value="imposto">🏛️ Impostos e Taxas</option>
                    </select>
                </div>

                <div class="form-group-despesa">
                    <label>Descrição / Item</label>
                    <div id="containerChipsDespesa" class="chip-container" style="margin-bottom:8px;"></div>
                    <input type="text" id="inputDespesaDescricao" class="form-input-despesa" placeholder="Ex: Conta de Luz">
                </div>

                <div class="form-group-despesa">
                    <label>Data</label>
                    <input type="date" id="inputDespesaData" class="form-input-despesa" value="${hoje}">
                </div>

            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="document.getElementById('${modalId}').remove()" style="flex:1; background:#333; color:#fff;">Cancelar</button>
                <button onclick="salvarDespesaDetalhada()" style="flex:1; background:#e74c3c; color:#fff; font-weight:bold;">Confirmar</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

// 3. Atualiza as sugestões (chips) quando troca o select
function atualizarChipsDespesa() {
    const categoria = document.getElementById('selectDespesaCategoria').value;
    const container = document.getElementById('containerChipsDespesa');
    const inputDesc = document.getElementById('inputDespesaDescricao');
    
    container.innerHTML = '';
    
    if (CATEGORIAS_DESPESAS[categoria]) {
        CATEGORIAS_DESPESAS[categoria].sugestoes.forEach(texto => {
            const chip = document.createElement('div');
            chip.className = 'chip-opcao';
            chip.textContent = texto;
            // Estilo inline básico para o chip, caso não tenha CSS
            chip.style.cssText = "display:inline-block; padding:4px 8px; margin:2px; background:#333; border-radius:12px; font-size:10px; cursor:pointer; border:1px solid #444;";
            
            chip.onclick = () => {
                inputDesc.value = texto;
                // Efeito visual de seleção
                Array.from(container.children).forEach(c => c.style.background = '#333');
                chip.style.background = '#e74c3c';
            };
            container.appendChild(chip);
        });
    }
}

// 4. Salva no Banco de Dados
async function salvarDespesaDetalhada() {
    const valor = parseFloat(document.getElementById('inputDespesaValor').value);
    const categoria = document.getElementById('selectDespesaCategoria').value;
    const descricao = document.getElementById('inputDespesaDescricao').value.trim();
    const dataInput = document.getElementById('inputDespesaData').value;

    if (isNaN(valor) || valor <= 0) return exibirPopup("Erro", "Valor inválido.");
    if (!categoria) return exibirPopup("Erro", "Selecione a categoria.");
    if (!descricao) return exibirPopup("Erro", "Digite uma descrição.");

    exibirAguarde("Salvando...");

    try {
        // Cria data corrigindo fuso horário (meio-dia para evitar pular dia)
        const dataObj = new Date(dataInput + 'T12:00:00');

        await db.collection('extrato_financeiro').add({
            usuarioUid: auth.currentUser.uid,
            donoUid: auth.currentUser.uid, 
            tipo: 'saida',                 
            subtipo: 'despesa_detalhada',
            
            // Novos campos vitais para o gráfico
            categoria: categoria,          // fixa, variavel, investimento, imposto
            descricao: descricao,
            
            valor: valor,
            dataEvento: firebase.firestore.Timestamp.fromDate(dataObj),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Opcional: Atualizar saldo atual do usuário (se seu app usa esse campo)
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            saldo: firebase.firestore.FieldValue.increment(-valor)
        });

        // Remove o modal de registro
        const modalReg = document.getElementById('modalRegistrarDespesaDetalhada');
        if(modalReg) modalReg.remove();
        
        fecharTodosOsModais(); // Fecha aguarde
        exibirPopup("Sucesso", "Saída registrada!");
        
        // Recarrega o painel financeiro para atualizar o gráfico e a lista
        if(typeof abrirModalFinanceiroProprietario === 'function') {
            abrirModalFinanceiroProprietario();
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", e.message);
    }
}

function renderizarGraficoResultados(mapaResultados) {
    const canvas = document.getElementById('graficoEvolucaoLucro');
    
    if (!canvas) {
        console.warn("Canvas 'graficoEvolucaoLucro' não encontrado.");
        return;
    }
    
    const ctx = canvas.getContext('2d');

    // Destroi gráfico anterior para não sobrepor
    if (window.chartEvolucao instanceof Chart) {
        window.chartEvolucao.destroy();
    }

    const labels = Object.keys(mapaResultados).sort();
    const valores = labels.map(l => mapaResultados[l]);
    
    // Cores dinâmicas (Verde se positivo, Vermelho se negativo)
    const cores = valores.map(v => v >= 0 ? '#2ecc71' : '#e74c3c');
    const coresFundo = valores.map(v => v >= 0 ? 'rgba(46, 204, 113, 0.2)' : 'rgba(231, 76, 60, 0.2)');

    window.chartEvolucao = new Chart(ctx, {
        type: 'line', // Linha fica mais bonito para evolução
        data: {
            labels: labels,
            datasets: [{
                label: 'Saldo do Dia (R$)',
                data: valores,
                backgroundColor: coresFundo, // Preenchimento abaixo da linha
                borderColor: '#d4af37',      // Linha Dourada
                pointBackgroundColor: cores, // Bolinha Verde/Vermelha
                pointBorderColor: '#fff',
                borderWidth: 2,
                pointRadius: 4,
                fill: true,                  // Ativa preenchimento
                tension: 0.4                 // Curva suave
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `R$ ${context.raw.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    grid: { color: 'rgba(255,255,255,0.05)' }, 
                    ticks: { color: '#888', callback: (val) => `R$${val}` } 
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { color: '#aaa', maxRotation: 45, minRotation: 45 } 
                }
            }
        }
    });
}

async function abrirModalLancamentoManual(tipo) {
    const modal = document.getElementById('modalFluxoFinanceiro');
    if (!modal) return;
    
    const titulo = tipo === 'entrada' ? '💰 Adicionar Entrada' : '💸 Adicionar Saída';
    const cor = tipo === 'entrada' ? '#2ecc71' : '#e74c3c';
    const hoje = new Date().toISOString().split('T')[0];
    
    // Injeta o formulário no corpo do modal
    const container = modal.querySelector('.modal-body') || modal.querySelector('.conteudo-modal-fluxo') || modal.querySelector('.modal-content');
    
    // Limpa conteúdo anterior mantendo a estrutura do modal se possível, ou recria
    // Aqui recriamos o interior do modal-content para garantir
    container.innerHTML = `
        <h3 style="color:${cor}; margin-top:0; text-align:center;">${titulo}</h3>
        <p style="text-align:center; font-size:12px; color:#aaa;">Registro manual no caixa do proprietário.</p>
        
        <div style="padding:10px;">
            <label style="color:#aaa; font-size:12px; display:block; margin-bottom:5px;">Nome do Registro / Descrição</label>
            <input type="text" id="manualDescricao" placeholder="Ex: Venda de Produto, Conta de Luz..." style="width:100%; padding:12px; margin-bottom:15px; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">
            
            <label style="color:#aaa; font-size:12px; display:block; margin-bottom:5px;">Valor (R$)</label>
            <input type="number" id="manualValor" placeholder="0.00" step="0.01" style="width:100%; padding:12px; margin-bottom:15px; background:#222; border:1px solid #444; color:#fff; border-radius:8px; font-weight:bold; font-size:18px;">
            
            <label style="color:#aaa; font-size:12px; display:block; margin-bottom:5px;">Data do Registro</label>
            <input type="date" id="manualData" value="${hoje}" style="width:100%; padding:12px; margin-bottom:15px; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="fecharModalAtual()" style="flex:1; background:#333;">Cancelar</button>
                <button onclick="salvarLancamentoManualDefinitivo('${tipo}')" style="flex:1; background:${cor}; color:#000; font-weight:bold;">💾 Salvar</button>
            </div>
        </div>
    `;
    
    abrirModal('modalFluxoFinanceiro');
}

// Função para salvar no banco
async function salvarLancamentoManualDefinitivo(tipo) {
    const desc = document.getElementById('manualDescricao').value.trim();
    const valor = parseFloat(document.getElementById('manualValor').value);
    const dataStr = document.getElementById('manualData').value;

    if (!desc) return exibirPopup("Erro", "Digite o nome/descrição do registro.");
    if (isNaN(valor) || valor <= 0) return exibirPopup("Erro", "Digite um valor válido.");
    if (!dataStr) return exibirPopup("Erro", "Selecione uma data.");

    exibirAguarde("Salvando...");

    try {
        // Cria a data correta (meio-dia para evitar problemas de fuso horário)
        const dataEvento = new Date(dataStr + 'T12:00:00');
        
        await db.collection('extrato_financeiro').add({
            descricao: desc,
            valor: valor,
            usuarioUid: auth.currentUser.uid, // Quem lançou
            donoUid: auth.currentUser.uid,    // Dono do caixa
            tipo: tipo === 'entrada' ? 'entrada_manual' : 'saida_manual',
            dataEvento: firebase.firestore.Timestamp.fromDate(dataEvento),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        fecharTodosOsModais();
        exibirPopup("Sucesso", "Lançamento registrado!");
        
        // Garante que o painel financeiro seja recarregado
        if (document.getElementById('modalFinanceiroProprietario')) {
            abrirModalFinanceiroProprietario();
        }
        
    } catch (e) {
        console.error(e);
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao salvar: " + e.message);
    }
}

// Resolve o ReferenceError: renderizarGraficoLinearFinanceiro is not defined
function renderizarGraficoLinearFinanceiro(dadosDiarios, cor, tipo) {
    const ctx = document.getElementById('graficoEspecifico')?.getContext('2d');
    if (!ctx) return;

    if (window.chartEspecifico) window.chartEspecifico.destroy();

    const labels = Object.keys(dadosDiarios).reverse();
    const valores = labels.map(l => dadosDiarios[l]);

    window.chartEspecifico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: tipo === 'entradas' ? 'Entradas R$' : 'Saídas R$',
                data: valores,
                borderColor: cor,
                backgroundColor: cor + '22',
                fill: true,
                tension: 0.4
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}

// Função para o Gráfico de Evolução de Lucro do Painel Principal
function renderizarGraficoEvolucaoLucro(labels, valores) {
    const ctx = document.getElementById('graficoEvolucaoLucro')?.getContext('2d');
    if (!ctx) return;

    if (window.chartEvolucao) window.chartEvolucao.destroy();

    window.chartEvolucao = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Lucro Líquido',
                data: valores,
                borderColor: '#2ecc71',
                pointBackgroundColor: valores.map(v => v >= 0 ? '#2ecc71' : '#e74c3c'),
                tension: 0.3,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false } }
        }
    });
}

async function excluirItemFinanceiro(id, origem, valor) {
    if (!confirm(`Excluir permanentemente R$ ${valor}?`)) return;
    exibirAguarde("Apagando...");
    try {
        if (origem === 'extrato') await db.collection('extrato_financeiro').doc(id).delete();
        else await db.collection('agendamentos').doc(id).delete();
        fecharTodosOsModais();
        carregarFinanceiro('mes'); 
    } catch (e) { fecharTodosOsModais(); exibirPopup("Erro", e.message); }
}

// --- NOVO: FUNÇÃO PARA VER DÍVIDA E PAGAR PROFISSIONAL ---
async function gerenciarPagamentoProfissional(uidProfissional, nomeProfissional, taxaComissaoUser) {
    exibirAguarde("Calculando saldo pendente...");

    try {
        const uidDono = auth.currentUser.uid;
        
        // 1. CALCULA QUANTO ELE JÁ PRODUZIU (COMISSÃO DELE)
        // Busca todos os serviços feitos por ele
        const servicosSnap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uidProfissional)
            .where('donoUid', '==', uidDono)
            .where('status', 'in', ['concluido', 'avaliado'])
            .get();

        let totalComissaoGerada = 0;
        servicosSnap.forEach(doc => {
            const d = doc.data();
            const valor = parseFloat(d.valor) || 0;
            // A taxaComissaoUser é quanto o SALÃO pega. O resto é do barbeiro.
            // Se taxa é 40%, barbeiro ganha 60%.
            const taxaSalao = taxaComissaoUser || 0;
            const parteBarbeiro = valor - (valor * (taxaSalao / 100));
            totalComissaoGerada += parteBarbeiro;
        });

        // 2. CALCULA QUANTO VOCÊ JÁ PAGOU A ELE (HISTÓRICO DE PAGAMENTOS)
        const pagamentosSnap = await db.collection('pagamentos_equipe')
            .where('recebedorUid', '==', uidProfissional)
            .where('pagadorUid', '==', uidDono)
            .get();

        let totalJaPago = 0;
        pagamentosSnap.forEach(doc => {
            totalJaPago += parseFloat(doc.data().valor);
        });

        // 3. O SALDO A PAGAR É A DIFERENÇA
        const saldoDevedor = totalComissaoGerada - totalJaPago;

        fecharTodosOsModais();

        // 4. MOSTRA O POPUP DE PAGAMENTO
        // Vamos usar o modalGenerico ou criar um HTML dinâmico rápido aqui
        const confirmacao = confirm(
            `FINANCEIRO: ${nomeProfissional}\n\n` +
            `💰 Total de Comissões: ${formatarMoeda(totalComissaoGerada)}\n` +
            `💸 Já Pago: ${formatarMoeda(totalJaPago)}\n` +
            `-----------------------------------\n` +
            `🚨 A PAGAR: ${formatarMoeda(saldoDevedor)}\n\n` +
            `Deseja realizar o pagamento e ZERAR esse saldo?`
        );

        if (confirmacao) {
            if (saldoDevedor <= 0) return alert("Não há saldo pendente para pagar.");
            realizarPagamentoNoBanco(uidProfissional, saldoDevedor, nomeProfissional);
        }

    } catch (e) {
        console.error(e);
        fecharTodosOsModais();
        alert("Erro ao calcular finanças.");
    }
}

async function realizarPagamentoNoBanco(uidRecebedor, valorLiquidoParaPagar, nomeRecebedor) {
    if (valorLiquidoParaPagar <= 0) return alert("Não há saldo pendente.");

    if (!confirm(`Pagar R$ ${valorLiquidoParaPagar.toLocaleString('pt-BR', {minimumFractionDigits: 2})} para ${nomeRecebedor}?`)) {
        return;
    }

    exibirAguarde("Pagando...");

    try {
        // 1. REGISTRA PAGAMENTO
        // A conta é: (Total Produzido Liquido) - (Total Pago) = Saldo
        // Ao adicionar este pagamento, o Total Pago sobe e iguala o Produzido, zerando o Saldo.
        await db.collection('pagamentos_equipe').add({
            pagadorUid: auth.currentUser.uid,
            recebedorUid: uidRecebedor,
            recebedorNome: nomeRecebedor,
            valor: parseFloat(valorLiquidoParaPagar), // O valor exato que estava na tela
            data: firebase.firestore.FieldValue.serverTimestamp(),
            tipo: 'comissao_zeramento'
        });

        // 2. Extrato (Opcional, para seu controle de caixa)
        await db.collection('extrato_financeiro').add({
            donoUid: auth.currentUser.uid,
            usuarioUid: auth.currentUser.uid, // Sai do seu caixa
            tipo: 'saida_manual',
            descricao: `Pagamento Comissão: ${nomeRecebedor}`,
            valor: parseFloat(valorLiquidoParaPagar),
            dataEvento: firebase.firestore.FieldValue.serverTimestamp(),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais(); 
        
        // RECARREGA A TELA PARA MOSTRAR ZERADO
        alert("Pago com sucesso! O saldo foi zerado.");
        
        setTimeout(() => {
            if (document.getElementById('modalGestaoV2')) abrirGestaoMembroV2(uidRecebedor);
            else if (document.getElementById('modalGestaoUnica')) abrirGestaoUnica(uidRecebedor);
        }, 500);

    } catch (e) {
        fecharTodosOsModais();
        alert("Erro: " + e.message);
    }
}

function formatarMoeda(valor) {
    // 1. Converte para número (caso venha como string do banco: "50.00")
    let numero = parseFloat(valor);

    // 2. Proteção de erro: Se não for número válido (ex: null, undefined ou texto), assume 0
    if (isNaN(numero)) {
        numero = 0;
    }

    // 3. Formatação Nativa do Browser (Padrão ABNT/BRL)
    return numero.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
}

function salvarAgendaManual() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ agenda: tempSelectedHorarios })
      .then(() => exibirPopup("Agenda salva!"))
      .catch(e => exibirPopup("Erro ao salvar: " + e.message));
}

function toggleDisponibilidade() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ disponivel: perfil.disponivel === "sim" ? "nao" : "sim" }).catch(e => exibirPopup("Erro: " + e.message));
}

async function aprovarAgendamentoImediato(agendamentoId, clienteUid, valor) {
    if (window.pararAlertaManual) window.pararAlertaManual();
    exibirAguarde("Aprovando e Abrindo Mapa...");
    
    // Define taxa (lógica mantida)
    let taxaAplicada = TAXA || 0; 
    // ... (lógica de taxa mantida se houver)

    try {
        await db.runTransaction(async t => {
            const agRef = db.collection("agendamentos").doc(agendamentoId);
            
            // 1. Lê o agendamento para saber QUEM é o barbeiro
            const agDoc = await t.get(agRef);
            if (!agDoc.exists) throw "Agendamento não existe.";
            const agData = agDoc.data();
            
            if (agData.status !== 'imediato') throw "Solicitação já processada.";
            
            const uidBarbeiroDestino = agData.barbeiroUid; // <--- O profissional real
            
            // 2. Referências
            const cliRef = db.collection("usuarios").doc(clienteUid);
            const barbRef = db.collection("usuarios").doc(uidBarbeiroDestino); 

            const [cDoc, bDoc] = await Promise.all([t.get(cliRef), t.get(barbRef)]);
            if (!cDoc.exists) throw "Cliente não encontrado.";
            
            // 3. Desativa Vaga Imediata do BARBEIRO (não de quem tá clicando)
            t.update(barbRef, { vagaImediata: false });
            
            // 4. Atualiza Agendamento
            t.update(agRef, { 
                status: "conclusão pendente", 
                confirmadoEm: firebase.firestore.FieldValue.serverTimestamp(), 
                lembreteConcluirEnviado: false,
                clienteNotificado: false,
                // Salva lat/lon do barbeiro para o cliente rastrear
                barbeiroLat: bDoc.data().latitude,
                barbeiroLon: bDoc.data().longitude
            });

            // (Lógica de taxa admin mantida...)
        });

        fecharTodosOsModais();
        
        // Notificações
        criarAviso(clienteUid, `✅ Vaga Aprovada! Prepare-se.`, 'vaga-aprovada', agendamentoId);
        notifyUser(clienteUid, "✅ Vaga Aprovada!", "Seu agendamento foi confirmado pela equipe. O mapa abrirá em 5s.");

        exibirPopup("Vaga Aprovada!", "O cliente foi notificado e o mapa será aberto.");
        
        // 5. LÓGICA DO RASTREAMENTO PARA QUEM APROVOU
        // Se eu sou o barbeiro, abre meu rastreamento normal.
        // Se eu sou Dono/Secretária, abre o rastreamento em modo "observador" (simulado como profissional)
        
        setTimeout(() => {
            // Busca a localização do barbeiro para iniciar o mapa (origem ou destino, dependendo da sua logica de mapa)
            // Na sua função iniciarRastreamento, se o papel é 'profissional', ele usa 'minhaFoto' e 'destLat' como cliente.
            // Para simplificar: Quem aprovou vê o mapa como se fosse o profissional.
            
            // Precisamos das coordenadas do BARBEIRO que vai atender, não as minhas (se eu for secretária)
            // Mas a função iniciarRastreamento usa 'destLat' para o "Outro" (Cliente).
            // E usa perfil.latitude para "Eu".
            
            // Vamos abrir o mapa. O cliente enviou a localização dele no agendamento?
            // Normalmente o cliente manda a dele no 'currentLat' se estiver com app aberto, 
            // mas o rastreamento inicial usa a fixa.
            
            // Vamos recuperar os dados do agendamento para pegar o clienteUid
            db.collection('agendamentos').doc(agendamentoId).get().then(snap => {
                 const d = snap.data();
                 // Usa as coordenadas do barbeiro que estão no banco, caso eu seja secretária em outro lugar
                 // Mas a função iniciarRastreamento pega a "Minha" localização do perfil local.
                 // Se for secretária, o mapa vai traçar da Secretária até o Cliente, o que é aceitável para monitoramento.
                 
                 // Se o cliente tem localizacao salva no perfil:
                 db.collection('usuarios').doc(clienteUid).get().then(cSnap => {
                     const cData = cSnap.data();
                     if(cData.latitude && cData.longitude) {
                         iniciarRastreamento(clienteUid, cData.latitude, cData.longitude, 'profissional', agendamentoId);
                     }
                 });
            });

        }, 5000);

    } catch (e) {
        fecharTodosOsModais();
        console.error("Erro na transação:", e);
        exibirPopup("Erro ao aprovar: " + e);
    }
}

async function aprovarAgendamento(agendamentoId, clienteUid, valor, horario = null) {
  if (window.pararAlertaManual) window.pararAlertaManual();
  exibirAguarde("Aprovando...");
  
  try {
      const result = await db.runTransaction(async t => {
          const agRef = db.collection("agendamentos").doc(agendamentoId);
          const cliRef = db.collection("usuarios").doc(clienteUid);
          const barbRef = db.collection("usuarios").doc(auth.currentUser.uid);
          
          const [agDoc, cDoc, bDoc] = await Promise.all([t.get(agRef), t.get(cliRef), t.get(barbRef)]);
          
          if (agDoc.data().status !== 'pendente') throw "Já processado.";
          if (!cDoc.exists) throw "Cliente não encontrado.";
          
          // --- REMOVIDO: Verificação de saldo e desconto do cliente ---
          // if (cDoc.data().saldo < valor) throw "Saldo insuficiente.";
          // t.update(cliRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });

          // Atualiza status do agendamento
          t.update(agRef, { 
              status: "conclusão pendente", 
              confirmadoEm: firebase.firestore.FieldValue.serverTimestamp(),
              barbeiroLat: bDoc.data().latitude, 
              barbeiroLon: bDoc.data().longitude
          });

          // Remove horário da lista de manuais se necessário
          if (bDoc.data().usaAgendaManual && horario) {
              const agendaAtual = bDoc.data().agenda || {};
              if (agendaAtual[horario]) { 
                  delete agendaAtual[horario]; 
                  t.update(barbRef, { agenda: agendaAtual }); 
              }
          }
          return { clienteNome: cDoc.data().nome };
      });

      fecharTodosOsModais();

      if (horario) {
          // Feedback Visual
          const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
          if(btnAgendamentos) {
              btnAgendamentos.classList.add('notificacao-pulsante');
              setTimeout(() => btnAgendamentos.classList.remove('notificacao-pulsante'), 10000);
          }
          exibirPopup("Agendamento Confirmado!", `O cliente ${result.clienteNome} foi avisado.\n\nO mapa abrirá automaticamente 20 minutos antes das ${horario}.`);
          
          // Notificações
          criarAviso(clienteUid, `✅ Agendamento das ${horario} Aprovado!`, 'agendamento-aprovado', agendamentoId);
          notifyUser(clienteUid, "✅ Agendamento Aprovado!", `Horário das ${horario} confirmado!`, { link: '#historico' });

      } else {
           // Vaga Imediata
           if (perfil.latitude && perfil.longitude) {
               iniciarRastreamento(clienteUid, perfil.latitude, perfil.longitude, 'profissional', agendamentoId);
               setTimeout(() => {
                   notifyUser(clienteUid, "📍 Aprovado!", `Acompanhe no mapa.`, { link: '#historico' });
                   exibirPopup("Cliente Notificado", "Rota iniciada imediatamente.");
               }, 1000); 
           } else {
               exibirPopup("Sucesso", "Aprovado com sucesso.");
           }
      }

  } catch(e) {
      fecharTodosOsModais();
      exibirPopup("Erro ao aprovar: " + e);
  }
}

function recusarAgendamento(agendamentoId, clienteUid) {
  if (!confirm("Recusar este agendamento?")) return;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'pendente' && status !== 'imediato') throw "Solicitação já processada.";
      t.update(agendamentoRef, { status: "cancelado" });
  }).then(() => {
      setTimeout(() => location.reload(), 4000); // 4 segundos

      
      notifyUser(clienteUid, "❌ Agendamento Recusado", `O profissional ${perfil.nome} não pôde aceitar seu pedido.`);
      exibirPopup("Agendamento recusado.");
  }).catch(e => exibirPopup("Erro ao recusar: " + e));
}

async function cancelarAgendamentoManualmente(agendamentoId, clienteUid, valor) {
    // 1. Confirmação inicial
    if (!confirm("Cancelar este agendamento? O dinheiro será reembolsado e sua reputação será afetada.")) return;

    // ADIÇÃO: Para o efeito chiclete do mapa imediatamente
    if (typeof encerrarRastreamentoTotal === 'function') encerrarRastreamentoTotal();

    exibirAguarde("Cancelando...");

    // Base de Taxas
    const TAXA_ADMIN = 0.10; // Taxa de 10%

    try {
        await db.runTransaction(async t => {
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);

            // --- 1. FASE DE LEITURAS ---
            
            // Lê o agendamento
            const agendamentoDoc = await t.get(agendamentoRef);
            if (!agendamentoDoc.exists) throw new Error("Agendamento não encontrado.");

            const agData = agendamentoDoc.data();
            const status = agData.status;

            if (status !== 'confirmado' && status !== 'conclusão pendente' && status !== 'imediato') {
                throw new Error("Apenas agendamentos ativos podem ser cancelados.");
            }

            // Lê o barbeiro
            const barbeiroRef = db.collection("usuarios").doc(agData.barbeiroUid);
            const barbeiroDoc = await t.get(barbeiroRef);
            if (!barbeiroDoc.exists) throw new Error("Profissional não encontrado.");
            const barbeiroData = barbeiroDoc.data();

            // --- 2. FASE DE CÁLCULOS ---
            const valorTaxaAdmin = valor * TAXA_ADMIN;

            // --- 3. FASE DE ESCRITAS ---

            // A. Reembolsa o Cliente (BLINDAGEM AQUI)
            // Verificamos se NÃO é manual (pelo prefixo 'manual_') e se o UID existe
            const ehClienteManual = !clienteUid || clienteUid === 'manual' || clienteUid.startsWith('manual_');
            
            if (!ehClienteManual) {
                const clienteRef = db.collection("usuarios").doc(clienteUid);
                // Opcional: Você pode ler o cliente antes se quiser garantir que o doc existe, 
                // mas se ele chegou aqui com UID real, o update deve funcionar.
                t.update(clienteRef, {
                    saldo: firebase.firestore.FieldValue.increment(valor)
                });
            }

            // B. Penaliza o Barbeiro
            t.update(barbeiroRef, {
                reputacao: firebase.firestore.FieldValue.increment(-10)
            });

            // C. Atualiza status do Agendamento
            t.update(agendamentoRef, { status: "cancelado" });

            // D. Libera o horário na agenda
            const horario = agData.horario;
            if (barbeiroData && barbeiroData.usaAgendaManual && horario && horario !== 'imediato') {
                const campoHorario = `agenda.${horario}`;
                t.update(barbeiroRef, {
                    [campoHorario]: true // Volta o slot para disponível
                });
            }
            // Se for vaga imediata, religa a vaga imediata no perfil
            else if (horario === 'imediato' || status === 'imediato') {
                t.update(barbeiroRef, { vagaImediata: true });
            }

            // E. Estorno de taxas Admin
            const adminRef = db.collection("config").doc("financeiro");
            t.set(adminRef, {
                arrecadadoTaxas: firebase.firestore.FieldValue.increment(-valorTaxaAdmin)
            }, { merge: true });

            // F. Lançamento no Extrato Financeiro (Histórico)
            const extratoRef = db.collection("extrato_financeiro").doc();
            t.set(extratoRef, {
                donoUid: agData.donoUid || agData.barbeiroUid,
                usuarioUid: agData.barbeiroUid,
                clienteUid: clienteUid, // Salva o ID manual no histórico para conferência
                tipo: "cancelamento_servico",
                descricao: `Cancelamento: ${agData.servico} (Reputação -10)`,
                valor: 0,
                dataEvento: firebase.firestore.Timestamp.now(),
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        // --- APÓS A TRANSAÇÃO (SUCESSO) ---

        // Notifica o cliente via Push (Apenas se for cliente real do App)
        const ehClienteManualPos = !clienteUid || clienteUid === 'manual' || clienteUid.startsWith('manual_');
        if (!ehClienteManualPos && typeof notifyUser === 'function') {
            notifyUser(clienteUid, "🔄 Agendamento Cancelado", `O profissional cancelou seu horário. O valor de R$ ${valor.toFixed(2)} foi estornado.`);
        }

        fecharTodosOsModais();
        
        // Mensagem customizada dependendo do tipo de cliente
        if (ehClienteManualPos) {
            exibirPopup("Agendamento de balcão cancelado. Ninguém foi reembolsado pois não houve pagamento via app.");
        } else {
            exibirPopup("Agendamento cancelado e valor reembolsado. Sua reputação diminuiu.");
        }

        // Recarrega para atualizar a agenda visualmente
        setTimeout(() => location.reload(), 1500);

    } catch (e) {
        fecharAguarde(null, true); // Fecha o "Cancelando..."
        console.error("Erro detalhado no cancelamento:", e);
        exibirPopup("Erro ao cancelar: " + (e.message || e));
    }
}

function tocarSom(tipo, volume = 1.0) {
    // Para e reinicia qualquer som anterior para evitar sobreposição
    if (audioAlert) { audioAlert.pause(); audioAlert.currentTime = 0; }
    if (audioSuccess) { audioSuccess.pause(); audioSuccess.currentTime = 0; }
    if (audioPing) { audioPing.pause(); audioPing.currentTime = 0; }
    if (audioChat) { audioChat.pause(); audioChat.currentTime = 0; }

    try {
        if (tipo === 'sucesso') {
            audioSuccess.volume = volume;
            audioSuccess.play().catch(e=>{});
        }

        if (tipo === 'chat') {
            audioChat.volume = volume;
            audioChat.play().catch(e=>{});
        }

        if (tipo === 'ping') {
            audioPing.volume = volume; // Aplica o volume recebido
            audioPing.play().catch(e=>{});
        }
        
        if (tipo === 'alerta') {
            audioAlert.volume = volume;
            audioAlert.play().catch(e=>{}); 
        }
    } catch(e) { console.warn("Erro audio:", e); }
}

let mapGeral = null;

async function abrirMapaGeral() {
    abrirModal('modalMapaGeral');
    
    // Pequeno delay para garantir que o modal abriu antes de renderizar o mapa
    setTimeout(async () => {
        // Se o mapa já existe, apenas invalida o tamanho para corrigir renderização
        if (mapGeral) {
            mapGeral.invalidateSize();
            carregarMarcadoresNoMapa(); // Atualiza posições
            return;
        }

        // Pega localização do cliente ou usa padrão
        let lat = -23.5505; // SP Padrão
        let lon = -46.6333;

        if (localizacaoCliente) {
            lat = localizacaoCliente.latitude;
            lon = localizacaoCliente.longitude;
        }

        // Inicializa o Leaflet
        mapGeral = L.map('mapaGeral', {
            center: [lat, lon],
            zoom: 15,
            zoomControl: false // Remove controles padrão para ficar mais limpo
        });

        // Adiciona Tiles (Usei CartoDB Dark Matter para o visual escuro/3D fake)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(mapGeral);

        // Adiciona marcador do USUÁRIO ATUAL (Você)
        if (auth.currentUser && perfil) {
            const minhaFoto = perfil.fotoPerfil || perfil.logo_url || '/icone.png';
            const meuIcone = L.divIcon({
                className: 'custom-map-marker',
                html: `<div class="marker-foto usuario-atual" style="background-image: url('${minhaFoto}');"></div>`,
                iconSize: [60, 60],
                iconAnchor: [30, 30]
            });
            
            L.marker([lat, lon], {icon: meuIcone}).addTo(mapGeral)
             .bindPopup(`<div style="text-align:center;">Você está aqui!</div>`).openPopup();
        }

        // Carrega as barbearias
        await carregarMarcadoresNoMapa();

    }, 500);
}

async function carregarMarcadoresNoMapa() {
    // Busca profissionais (Barbeiros, Manicures, etc)
    // Nota: Filtramos apenas quem tem localização definida
    const snap = await db.collection('usuarios')
        .where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios'])
        .get();

    snap.forEach(doc => {
        const u = doc.data();
        if (u.latitude && u.longitude) {
            // Define a foto (Prioridade: Foto Perfil > Logo > Ícone)
            const fotoUrl = u.fotoPerfil || u.logo_url || '/icone.png';
            
            // Cria o ícone HTML personalizado
            const customIcon = L.divIcon({
                className: 'custom-map-marker',
                html: `<div class="marker-foto" style="background-image: url('${fotoUrl}');"></div>`,
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });

            // Cria o marcador e o popup
            const marker = L.marker([u.latitude, u.longitude], {icon: customIcon}).addTo(mapGeral);
            
            // Conteúdo do Popup (Ao clicar na bolinha)
            const popupContent = `
                <div style="text-align:center; color: #fff; min-width: 150px;">
                    <img src="${fotoUrl}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; margin-bottom:5px; border: 2px solid var(--cor-destaque);">
                    <h4 style="margin:0; color:var(--cor-destaque);">${u.nome}</h4>
                    <p style="font-size:12px; margin:5px 0;">${u.tipo === 'barbeiro' ? '💈 Barbearia' : '💅 Estética'}</p>
                    <button onclick="fecharModalAtual(); abrirBarbeiroPerfil('${doc.id}')" 
                            style="background: var(--cor-destaque); color: #000; padding: 8px 15px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top:5px;">
                        Ver Perfil / Agendar
                    </button>
                </div>
            `;
            marker.bindPopup(popupContent);
        }
    });
}

// ================================================================
// === SISTEMA DE AGENDAMENTO MANUAL (CORRIGIDO E OTIMIZADO) ===
// ================================================================

// 1. ABRIR O MODAL E CARREGAR A EQUIPE
async function abrirModalCriarAgendamentoManual(preUid = null, preHorario = null) {
    const selectProf = document.getElementById('manualProfissionalUid');
    const inputCliente = document.getElementById('manualClienteNome');
    
    // Limpa campos
    inputCliente.value = '';
    document.getElementById('manualHorarioHidden').value = '';
    document.getElementById('displayHorarioSelecionado').textContent = '';
    
    selectProf.innerHTML = '<option>Carregando...</option>';
    
    abrirModal('modalCriarAgendamentoManual');

    // --- POPULAR O SELECT DE PROFISSIONAIS ---
    let htmlOptions = '';
    
    // Adiciona o próprio usuário (Sempre pode agendar pra si mesmo)
    htmlOptions += `<option value="${auth.currentUser.uid}">👤 ${perfil.nome} (Eu)</option>`;

    // Se for Proprietário, busca a equipe
    if (perfil.isProprietario && perfil.equipe && perfil.equipe.length > 0) {
        
        // Vamos buscar os nomes atualizados do banco para não ter erro
        const listaIds = perfil.equipe.map(m => (typeof m === 'string' ? m : m.uid));
        
        // Remove duplicatas do próprio ID se houver
        const idsFiltrados = listaIds.filter(id => id !== auth.currentUser.uid);

        if (idsFiltrados.length > 0) {
            try {
                // Busca em paralelo para ser rápido
                const promises = idsFiltrados.map(uid => db.collection('usuarios').doc(uid).get());
                const docs = await Promise.all(promises);
                
                docs.forEach(doc => {
                    if (doc.exists) {
                        const u = doc.data();
                        htmlOptions += `<option value="${doc.id}">💈 ${u.nome}</option>`;
                    }
                });
            } catch (e) {
                console.error("Erro ao carregar nomes da equipe", e);
            }
        }
    }

    selectProf.innerHTML = htmlOptions;

    // --- DEFINIR SELEÇÃO INICIAL ---
    // Se veio de um clique na grade (preUid), seleciona ele. Se não, seleciona eu mesmo.
    if (preUid) {
        selectProf.value = preUid;
    } else {
        selectProf.value = auth.currentUser.uid;
    }

    // Carrega os dados do profissional selecionado (Serviços e Horários)
    await atualizarOpcoesAgendamentoManual(selectProf.value, preHorario);
}

// 2. ATUALIZAR SERVIÇOS E HORÁRIOS AO MUDAR O PROFISSIONAL (COM FILTRO DE ALMOÇO)
// 2. ATUALIZAR SERVIÇOS E HORÁRIOS AO MUDAR O PROFISSIONAL (COM DEBUG)
async function atualizarOpcoesAgendamentoManual(uid, horarioPreSelecionado = null) {
    console.log("--> INICIANDO ATUALIZAÇÃO DE HORÁRIOS PARA UID:", uid); // DEBUG

    const selectServico = document.getElementById('manualServico');
    const containerHorarios = document.getElementById('containerHorariosManual');
    
    // Limpa visual
    selectServico.innerHTML = '<option>Carregando...</option>';
    containerHorarios.innerHTML = '<div class="spinner" style="grid-column: 1/-1; margin: 0 auto;"></div>';

    try {
        // 1. DADOS DO PROFISSIONAL
        const doc = await db.collection('usuarios').doc(uid).get();
        if (!doc.exists) throw new Error("Profissional não encontrado");
        const u = doc.data();

        console.log("DADOS DO PROFISSIONAL:", u.nome);
        console.log("Horários Configurados:", u.horarioInicio, u.horarioFim, "Almoço:", u.almocoInicio, u.almocoFim);

        // --- A. SERVIÇOS ---
        selectServico.innerHTML = '';
        if (u.listaServicos && u.listaServicos.length > 0) {
            u.listaServicos.forEach(s => {
                const v = s.valor ? `R$ ${s.valor.toFixed(2)}` : 'Var.';
                selectServico.innerHTML += `<option value="${s.nome}" data-valor="${s.valor || 0}">${s.nome} - ${v}</option>`;
            });
        } else {
            selectServico.innerHTML = '<option value="">Sem serviços</option>';
        }

        // --- B. DEFINIÇÃO DOS LIMITES (TRAVA) ---
        const timeToMin = (t) => {
            if(!t) return null;
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        };

        // Força Padrão se não tiver nada
        const inicioExp = timeToMin(u.horarioInicio) || 480; // 08:00
        const fimExp = timeToMin(u.horarioFim) || 1200;      // 20:00
        
        let almocoIn = timeToMin(u.almocoInicio);
        let almocoOut = timeToMin(u.almocoFim);
        if(almocoIn === almocoOut) { almocoIn = -1; almocoOut = -1; }

        console.log("Minutos de Corte -> Início:", inicioExp, "Fim:", fimExp, "Almoço:", almocoIn, "até", almocoOut);

        // --- C. AGENDAMENTOS OCUPADOS ---
        // Pega Data do Input (Se não tiver, usa hoje)
        const inputData = document.getElementById('manualData'); // <--- CERTIFIQUE-SE QUE TEM ESSE INPUT NO HTML
        let dataBusca = inputData && inputData.value ? inputData.value : new Date().toISOString().split('T')[0];
        
        // Formata para DD/MM/AAAA se seu banco usa esse formato
        const [ano, mes, dia] = dataBusca.split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;

        console.log("Buscando ocupados para data:", dataFormatada);

        const snapAg = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uid)
            .where('data', '==', dataFormatada) // Filtra pela data certa!
            .where('status', 'in', ['confirmado', 'conclusão pendente', 'pendente']) 
            .get();

        const horariosOcupados = [];
        snapAg.forEach(d => {
            if (d.data().horario) horariosOcupados.push(d.data().horario);
        });

        // --- D. LISTA DE HORÁRIOS POSSÍVEIS ---
        let horariosPossiveis = [];
        if (u.usaAgendaManual && u.agenda) {
            horariosPossiveis = Object.keys(u.agenda).filter(h => u.agenda[h] === true).sort();
        } else {
            // Gera lista completa para filtrar depois
            for(let i=0; i<=23; i++) {
                const h = i.toString().padStart(2,'0');
                horariosPossiveis.push(`${h}:00`);
                horariosPossiveis.push(`${h}:30`);
            }
        }

        // --- E. RENDERIZAÇÃO COM FILTRO ---
        containerHorarios.innerHTML = '';
        let contagem = 0;

        horariosPossiveis.forEach(h => {
            const minAtual = timeToMin(h);
            
            // >>> AQUI É O BLOQUEIO <<<
            // Se for MENOR que Inicio OU MAIOR/IGUAL ao Fim -> TCHAU
            if (minAtual < inicioExp || minAtual >= fimExp) return;

            // Se for DENTRO do almoço -> TCHAU
            if (almocoIn !== -1 && minAtual >= almocoIn && minAtual < almocoOut) return;

            // Se passou, desenha
            contagem++;
            const isOcupado = horariosOcupados.includes(h);
            const btn = document.createElement('div');
            
            btn.style.cssText = `
                padding: 8px; text-align: center; border-radius: 6px; 
                font-size: 12px; font-weight: bold; cursor: pointer; 
                border: 1px solid #333; transition: all 0.2s;
            `;

            if (isOcupado) {
                btn.style.backgroundColor = 'rgba(231, 76, 60, 0.2)';
                btn.style.color = '#e74c3c';
                btn.style.borderColor = '#e74c3c';
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.textContent = h;
            } else {
                btn.textContent = h;
                btn.className = 'btn-horario-manual'; 
                
                if (horarioPreSelecionado && h === horarioPreSelecionado) {
                    btn.style.backgroundColor = '#2ecc71';
                    btn.style.color = '#000';
                    btn.style.borderColor = '#2ecc71';
                    document.getElementById('manualHorarioHidden').value = h;
                } else {
                    btn.style.backgroundColor = '#222';
                    btn.style.color = '#fff';
                }

                btn.onclick = () => {
                    document.querySelectorAll('.btn-horario-manual').forEach(b => {
                        b.style.backgroundColor = '#222';
                        b.style.color = '#fff';
                        b.style.borderColor = '#333';
                    });
                    btn.style.backgroundColor = '#2ecc71';
                    btn.style.color = '#000';
                    btn.style.borderColor = '#2ecc71';
                    document.getElementById('manualHorarioHidden').value = h;
                };
            }
            containerHorarios.appendChild(btn);
        });

        if (contagem === 0) {
            containerHorarios.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#e74c3c; padding:10px;">Sem horários disponíveis neste dia.</p>';
        }

    } catch (e) {
        console.error("ERRO CRÍTICO AO CARREGAR HORÁRIOS:", e);
        containerHorarios.innerHTML = '<p style="color:red">Erro.</p>';
    }
}

// 3. SALVAR NO BANCO
async function salvarAgendamentoManual() {
    const selectProf = document.getElementById('manualProfissionalUid');
    const uidProf = selectProf.value;
    
    // Tenta pegar o nome do profissional
    const optionProf = selectProf.options[selectProf.selectedIndex];
    const nomeProf = optionProf.text.replace(' (Eu)', '').replace('💈 ', '');
    
    // Pega a comissão configurada no option (se houver, senão busca do banco depois)
    let comissaoProf = parseFloat(optionProf.dataset.comissao || 0);

    const nomeCliente = document.getElementById('manualClienteNome').value.trim();
    const telefoneCliente = document.getElementById('manualClienteTelefone').value.trim();
    const selectServico = document.getElementById('manualServico');
    const nomeServico = selectServico.value;
    const valorServico = parseFloat(selectServico.options[selectServico.selectedIndex].dataset.valor || 0);
    const horario = document.getElementById('manualHorarioHidden').value;

    // --- VALIDAÇÃO ---
    if (!uidProf || !nomeCliente || !selectServico.value || !horario) {
        return exibirPopup("Dados Incompletos", "Por favor, preencha profissional, cliente, serviço e horário.");
    }
    if (!telefoneCliente || telefoneCliente.length < 8) {
        return exibirPopup("Telefone Obrigatório", "Por favor, informe o telefone do cliente de balcão para contato.");
    }

    exibirAguarde("Agendando...");

    try {
        // Se a comissão não veio do dataset, buscamos rápido no banco para garantir a métrica
        if (comissaoProf === 0 && uidProf !== auth.currentUser.uid) {
            const docProf = await db.collection('usuarios').doc(uidProf).get();
            if (docProf.exists) {
                const dadosProf = docProf.data();
                comissaoProf = dadosProf.taxaComissao || dadosProf.comissao || 50; 
                // Nota: Se for o proprietário agendando para si mesmo, a comissão é irrelevante (100%), mas mantemos a lógica.
            }
        }
        
        // Calcula valor da comissão estimada
        const valorComissao = (valorServico * comissaoProf) / 100;

        // --- MÁSCARA DE ID PERFEITA ---
        // Criamos um ID que parece um UID real, mas com prefixo manual para controle
        const clienteUidMascara = `manual_${Date.now()}_${Math.floor(Math.random() * 1000)}`;

        await db.collection('agendamentos').add({
            barbeiroUid: uidProf,
            barbeiroNome: nomeProf,
            
            // Dados do Cliente "Mascarado"
            clienteUid: clienteUidMascara, 
            clienteNome: nomeCliente, // Removemos o "(Manual)" visual para ficar mais bonito, controlamos pelo UID
            clienteTelefone: telefoneCliente,
            
            servico: nomeServico,
            valor: valorServico,
            valorOriginal: valorServico,
            horario: horario,
            status: 'confirmado', // Balcão já entra confirmado
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            origem: 'balcao_painel', // Identificador interno
            avaliado: false,
            
            // Dados Financeiros para o Futuro
            comissaoCalculada: valorComissao,
            percentualComissao: comissaoProf,
            donoUid: auth.currentUser.uid, // Quem criou (O Dono)
            
            lembreteConcluirEnviado: false
        });

        fecharTodosOsModais();
        exibirPopup("Sucesso", "Agendamento de balcão criado!");
        
        // Atualiza a tela
        if (typeof carregarVisaoGeralEquipe === "function" && userView.currentType === 'profissionais') {
            carregarVisaoGeralEquipe();
        } else if (typeof carregarMinhaAgendaInterativa === "function" && userView.currentType === 'minhaAgenda') {
            carregarMinhaAgendaInterativa();
        }

    } catch (e) {
        fecharTodosOsModais();
        console.error(e);
        exibirPopup("Erro ao salvar: " + e.message);
    }
}

// --- VARIÁVEIS GLOBAIS PARA O FLUXO DE CONCLUSÃO ---
window.agendamentoIdParaConcluir = null;
window.clienteUidParaConcluir = null;

// Esta é a função que você chamou
function concluirAgendamento(agendamentoId, clienteUid) {
    window.agendamentoIdParaConcluir = agendamentoId;
    window.clienteUidParaConcluir = clienteUid;
    resetarModal(); 
    document.getElementById('modal-pagamento').style.display = 'flex';
}

async function salvarConclusao() {
    const idAgendamento = window.agendamentoIdParaConcluir;
    if (!idAgendamento) return;

    let valorTotalInformado = 0;
    let metodos = { pix: 0, dinheiro: 0, credito: 0, debito: 0 };
    
    document.querySelectorAll('.input-pagamento-valor').forEach(input => {
        const v = parseFloat(input.value) || 0;
        const tipo = input.dataset.tipo;
        metodos[tipo] = v;
        valorTotalInformado += v;
    });

    if (valorTotalInformado <= 0) return alert("Informe os valores pagos.");

    exibirAguarde("Finalizando e vinculando ao Proprietário...");

    try {
        // 1. Pegar dados do agendamento para saber quem é o barbeiro e O STATUS ATUAL
        const agendRef = db.collection('agendamentos').doc(idAgendamento);
        const docAgend = await agendRef.get();
        
        if (!docAgend.exists) throw new Error("Agendamento não encontrado.");
        const dadosAgend = docAgend.data();

        // --- BLINDAGEM 1: Verifica se já foi concluído ---
        if (dadosAgend.status === 'concluido') {
            fecharTodosOsModais();
            return exibirPopup("Já Concluído", "Este agendamento já foi finalizado e contabilizado anteriormente.");
        }

        // --- BLINDAGEM 2: Verifica se já existe extrato para este ID (Dupla proteção) ---
        const checkExtrato = await db.collection('extrato_financeiro')
            .where('agendamentoId', '==', idAgendamento)
            .limit(1)
            .get();
            
        if (!checkExtrato.empty) {
            // Se já tem extrato, apenas atualiza o status do agendamento se necessário e sai
            if (dadosAgend.status !== 'concluido') {
                await agendRef.update({ status: 'concluido' });
            }
            fecharTodosOsModais();
            return exibirPopup("Aviso", "Este serviço já possui registro financeiro gerado.");
        }

        const uidBarbeiro = dadosAgend.barbeiroUid;

        // 2. BUSCAR O PATRÃO PELO CAMPO 'vinculoSalao'
        const profDoc = await db.collection('usuarios').doc(uidBarbeiro).get();
        const profDados = profDoc.data();
        
        // Se o campo vinculoSalao existir, esse é o ID do proprietário.
        // Se não existir, o próprio barbeiro é o dono.
        let uidDonoReal = profDados.vinculoSalao || uidBarbeiro;
        console.log("LOG: Barbeiro:", uidBarbeiro, "-> Dono (vinculoSalao):", uidDonoReal);

        const taxaComissao = profDados.comissao || profDados.taxaComissao || 0;
        const valorComissaoDono = valorTotalInformado * (taxaComissao / 100);
        const valorLiquidoProfissional = valorTotalInformado - valorComissaoDono;

        const batch = db.batch();

        // 3. Atualizar Agendamento com o Dono Correto e Status
        batch.update(agendRef, {
            status: 'concluido',
            valorFinalPago: valorTotalInformado,
            metodosPagamento: metodos,
            dataConclusao: firebase.firestore.FieldValue.serverTimestamp(),
            donoUid: uidDonoReal 
        });

        // 4. Gravar Extrato Financeiro
        const extratoRef = db.collection('extrato_financeiro').doc();
        batch.set(extratoRef, {
            agendamentoId: idAgendamento, // <--- IMPORTANTE: Vincula o ID para a blindagem funcionar
            donoUid: uidDonoReal, // O Proprietário verá por causa deste campo
            usuarioUid: uidBarbeiro,
            clienteUid: dadosAgend.clienteUid || 'balcao',
            tipo: 'receita_servico',
            descricao: `Serviço: ${dadosAgend.servico}`,
            valor: valorTotalInformado,
            comissaoRetida: valorComissaoDono,
            valorLiquidoProfissional: valorLiquidoProfissional,
            metodos: metodos,
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            extratoIdNoBanco: extratoRef.id
        });

        await batch.commit();

        fecharTodosOsModais();
        exibirPopup("Sucesso!", `Concluído. ID do Registro: ${extratoRef.id}`);
        
        if (typeof sincronizarPainelDeGestao === 'function') sincronizarPainelDeGestao();

    } catch (e) {
        console.error("Erro na conclusão:", e);
        fecharTodosOsModais();
        alert("Erro: " + e.message);
    }
}

// 4. RENDERIZAR GRÁFICO DE MÉTODOS DE PAGAMENTO (Rosca)
function renderizarGraficoMetodos(pix, din, deb, cred) {
    const ctx = document.getElementById('chartMetodosPagamento');
    const legContainer = document.getElementById('legendaMetodos');
    
    if (!ctx || !legContainer) {
         console.warn("Container do gráfico de métodos não encontrado.");
         return;
    }

    // Destrói instância anterior
    if (window.chartMetodos instanceof Chart) {
        window.chartMetodos.destroy();
    }
    
    // Atualiza Legenda HTML com Valores
    legContainer.innerHTML = `
        <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #333; padding-bottom:2px;">
            <span style="color:#00C851">Pix</span> <b>R$ ${pix.toFixed(2)}</b>
        </div>
        <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #333; padding-bottom:2px;">
            <span style="color:#33b5e5">Dinheiro</span> <b>R$ ${din.toFixed(2)}</b>
        </div>
        <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #333; padding-bottom:2px;">
            <span style="color:#ffbb33">Débito</span> <b>R$ ${deb.toFixed(2)}</b>
        </div>
        <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%;">
            <span style="color:#ff4444">Crédito</span> <b>R$ ${cred.toFixed(2)}</b>
        </div>
    `;

    // Se tudo for zero, desenha cinza
    let dados = [pix, din, deb, cred];
    let cores = ['#00C851', '#33b5e5', '#ffbb33', '#ff4444'];
    
    if (pix+din+deb+cred === 0) {
        dados = [1];
        cores = ['#333'];
    }

    const context = ctx.getContext('2d');
    window.chartMetodos = new Chart(context, {
        type: 'doughnut',
        data: {
            labels: ['Pix', 'Dinheiro', 'Débito', 'Crédito'],
            datasets: [{
                data: dados,
                backgroundColor: cores,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Importante
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let val = context.raw || 0;
                            // Se for o gráfico "vazio" (cinza), não mostra valor
                            if(context.dataset.backgroundColor[0] === '#333') return 'Sem dados';
                            return ` R$ ${val.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}

// --- FUNÇÕES DE TRANSAÇÃO MANUAL ---

function prepararTransacaoManual(tipo) {
    const modal = document.getElementById('modalNovaTransacao');
    const titulo = document.getElementById('tituloNovaTransacao');
    const inputTipo = document.getElementById('transacaoTipo');
    const inputData = document.getElementById('transacaoData');
    
    document.getElementById('transacaoDescricao').value = '';
    document.getElementById('transacaoValor').value = '';
    inputData.value = new Date().toISOString().split('T')[0]; 
    
    inputTipo.value = tipo;
    
    if (tipo === 'entrada') {
        titulo.innerHTML = "💰 Nova Receita (Entrada)";
        titulo.style.color = "#2ecc71";
    } else {
        titulo.innerHTML = "💸 Nova Despesa (Saída)";
        titulo.style.color = "#e74c3c";
    }
    
    abrirModal('modalNovaTransacao');
    modal.style.zIndex = '26000';
}

async function salvarTransacaoManual() {
    const tipo = document.getElementById('transacaoTipo').value;
    const descricao = document.getElementById('transacaoDescricao').value.trim();
    const valor = parseFloat(document.getElementById('transacaoValor').value);
    const dataStr = document.getElementById('transacaoData').value;

    if (!descricao || isNaN(valor) || valor <= 0 || !dataStr) {
        return exibirPopup("Preencha todos os campos corretamente.");
    }

    exibirAguarde("Salvando...");

    try {
        const dataEvento = new Date(dataStr + 'T12:00:00');
        
        await db.collection('extrato_financeiro').add({
            donoUid: auth.currentUser.uid,
            usuarioUid: auth.currentUser.uid, 
            tipo: tipo === 'entrada' ? 'entrada_manual' : 'saida_manual',
            descricao: descricao,
            valor: valor,
            dataEvento: firebase.firestore.Timestamp.fromDate(dataEvento),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();
        abrirModalFinanceiroProprietario(); // Recarrega
        exibirPopup("Sucesso", "Movimentação registrada!");

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar: " + e.message);
    }
}

async function salvarTransacaoManual() {
    const tipo = document.getElementById('transacaoTipo').value; // 'entrada' ou 'saida'
    const descricao = document.getElementById('transacaoDescricao').value.trim();
    const valor = parseFloat(document.getElementById('transacaoValor').value);
    const dataStr = document.getElementById('transacaoData').value;

    if (!descricao || isNaN(valor) || valor <= 0 || !dataStr) {
        return exibirPopup("Preencha todos os campos corretamente.");
    }

    exibirAguarde("Salvando...");

    try {
        const dataEvento = new Date(dataStr + 'T12:00:00'); // Meio dia para evitar fuso
        
        await db.collection('extrato_financeiro').add({
            donoUid: auth.currentUser.uid,
            usuarioUid: auth.currentUser.uid, // Quem lançou
            tipo: tipo === 'entrada' ? 'entrada_manual' : 'saida_manual',
            descricao: descricao,
            origem: descricao, // Compatibilidade
            valor: valor,
            valorTotal: valor, // Compatibilidade
            dataEvento: firebase.firestore.Timestamp.fromDate(dataEvento),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais(); // Fecha aguarde e modal de transação
        
        // Recarrega o painel financeiro
        // Precisamos garantir que o modal de gestão continue aberto ou reabra
        // Como 'fecharTodosOsModais' fecha tudo, vamos reabrir:
        abrirModalFinanceiroProprietario();
        exibirPopup("Sucesso", "Movimentação registrada!");

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar: " + e.message);
    }
}

// Controla o surgimento dos campos de valor no modal de pagamento
function toggleInput(tipo) {
    const container = document.getElementById('inputs-valores');
    const check = document.querySelector(`input[value="${tipo}"]`);
    
    if (check.checked) {
        const div = document.createElement('div');
        div.id = `group-${tipo}`;
        div.innerHTML = `
            <label style="color:#aaa; font-size:12px; text-transform:uppercase;">Valor em ${tipo}:</label>
            <input type="number" step="0.01" class="input-pagamento-valor" data-tipo="${tipo}" 
                   oninput="atualizarTotalPagamento()" placeholder="0,00" 
                   style="width:100%; background:#222; color:#00ff00; border:1px solid #444; padding:10px; border-radius:8px; margin-bottom:10px;">
        `;
        container.appendChild(div);
    } else {
        const el = document.getElementById(`group-${tipo}`);
        if (el) el.remove();
        atualizarTotalPagamento();
    }
}

// Soma os valores digitados para mostrar o total no rodapé do modal
function atualizarTotalPagamento() {
    let total = 0;
    document.querySelectorAll('.input-pagamento-valor').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('display-total').textContent = formatarMoeda(total);
}

// Função de fechamento que estava faltando
function fecharModalPagamento() {
    document.getElementById('modal-pagamento').style.display = 'none';
    resetarModal();
}

function resetarModal() {
    document.getElementById('inputs-valores').innerHTML = '';
    document.querySelectorAll('#opcoes-pagamento input').forEach(c => c.checked = false);
    document.getElementById('display-total').textContent = 'R$ 0,00';
}

// ATUALIZE ESTA FUNÇÃO EM INDEX.HTML
async function abrirClientesBarbeiro() {
  abrirModal('modalClientesBarbeiro');
  const lista = document.getElementById("listaClientesBarbeiro");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  
  const agendamentosSnap = await db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "==", "concluido")
    .get();

  const clientesMap = {};
  agendamentosSnap.forEach(doc => {
    const ag = doc.data();
    if (!clientesMap[ag.clienteUid]) {
      clientesMap[ag.clienteUid] = { 
          nome: ag.clienteNome, 
          totalCortes: 0, 
          telefone: ag.clienteTelefone,
          uid: ag.clienteUid // Adiciona o UID para salvar a nota
      };
    }
    clientesMap[ag.clienteUid].totalCortes++;
  });

  // Carrega as notas salvas
  const notasSnap = await db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid).get();
  const notasData = notasSnap.exists ? notasSnap.data().notas : {};

  lista.innerHTML = Object.keys(clientesMap).length === 0 ? "<p>Você ainda não tem clientes.</p>" : "";
  
  Object.values(clientesMap).sort((a, b) => b.totalCortes - a.totalCortes).forEach(c => {
    const notaAtual = notasData[c.uid] || "";
    const whatsappLink = c.telefone ? `<a href="https://wa.me/55${c.telefone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()"><button style="font-size:12px; padding: 5px 8px; margin-top:5px;">💬 WhatsApp</button></a>` : '';
    
    lista.innerHTML += `
        <div class="card">
            ${c.nome}
            <p>Serviços concluídos: ${c.totalCortes}</p>
            ${whatsappLink}
            <textarea id="nota_${c.uid}" placeholder="Adicione notas sobre este cliente..." style="margin-top: 10px; width: 100%; min-height: 50px;">${notaAtual}</textarea>
            <button onclick="salvarNotaCliente('${c.uid}')" style="font-size:12px; padding: 5px 8px; margin-top:5px;">Salvar Nota</button>
        </div>`;
  });
}

// ADICIONE ESTA NOVA FUNÇÃO EM INDEX.HTML
async function salvarNotaCliente(clienteUid) {
    const nota = document.getElementById(`nota_${clienteUid}`).value;
    const ref = db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid);
    try {
        await ref.set({
            notas: {
                [clienteUid]: nota
            }
        }, { merge: true });
        exibirPopup("Nota salva com sucesso!");
    } catch (e) {
        console.error("Erro ao salvar nota:", e);
        exibirPopup("Não foi possível salvar a nota.");
    }
}

function abrirHistoricoBarbeiro() {
  abrirModal('modalHistoricoBarbeiro');
  const painel = document.getElementById("painelHistoricoBarbeiro");
  painel.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("agendamentos").where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"]).orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      if (snap.empty) {
          painel.innerHTML = "<p>Nenhum serviço no histórico encontrado.</p>";
          return;
      }
      painel.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        const dataFormatada = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString('pt-BR') : 'Data indisponível';
        const statusIcon = a.status === "concluido" ? "✅" : "❌";
        const statusTexto = a.status === "concluido" ? "Concluído" : "Cancelado";
        painel.innerHTML += `<div class="card" style="margin-bottom: 10px;">
          <p><strong>${statusIcon} Cliente:</strong> ${a.clienteNome}</p>
          <p><strong>✂️ Serviço:</strong> ${a.servico} - R$ ${a.valor.toFixed(2)}</p>
          <p><strong>🗓️ Data:</strong> ${dataFormatada}</p>
          <p><strong>Status:</strong> ${statusTexto}</p>
        </div>`;
      });
    });
}

function criarPromocao() {
  const nome = document.getElementById("promocaoNome").value;
  const descricao = document.getElementById("promocaoDescricao").value;
  const desconto = parseInt(document.getElementById("promocaoDesconto").value);
  if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) return exibirPopup("Preencha os campos corretamente.");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayUnion({ nome, descricao, desconto })
  }).then(() => {
    exibirPopup("Promoção criada!");
    fecharModalAtual();
  }).catch(e => exibirPopup("Erro: " + e.message));
}

function removerPromocao(index) {
  const p = perfil.promocoes[index];
  if (!confirm(`Remover a promoção "${p.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayRemove(p)
  }).then(() => exibirPopup("Promoção removida!")).catch(e => exibirPopup("Erro: " + e.message));
}

function carregarPromocoesAtivas() {
    const container = document.getElementById('listaPromocoes');
    container.innerHTML = '';
    if (perfil.promocoes && perfil.promocoes.length > 0) {
        perfil.promocoes.forEach((promo, index) => {
            const validadeStr = promo.validade ? `Válida até: ${new Date(promo.validade.seconds * 1000).toLocaleDateString('pt-BR')}` : 'Sem data de expiração';
            container.innerHTML += `
                <div class="card">
                    ${promo.nome} (${promo.desconto}%)
                    <p style="font-size:14px;">${promo.descricao}</p>
                    <p style="font-size:12px; opacity: 0.7;">${validadeStr}</p>
                    <button onclick="removerPromocao(${index})" style="background:#c0392b; float:right;">🗑️</button>
                </div>`;
        });
    } else {
        container.innerHTML = '<p>Nenhuma promoção ativa no momento.</p>';
    }
}

// Substitua a função abrirPromocoes inteira por esta
function abrirPromocoes() {
    abrirModal('modalPromocoesBarbeiro');
    carregarPromocoesAtivas();
}

// SUBSTITUA a função abrirModalAddPromocao por esta:
function abrirModalAddPromocao() {
    const selectServicos = document.getElementById('addPromocaoServicos');
    selectServicos.innerHTML = ''; // Limpa opções antigas

    if (perfil.listaServicos && perfil.listaServicos.length > 0) {
        perfil.listaServicos.forEach(servico => {
            const option = document.createElement('option');
            option.value = servico.nome; // Usaremos o nome como identificador
            option.textContent = `${servico.nome} - R$ ${servico.valor.toFixed(2)}`;
            selectServicos.appendChild(option);
        });
    } else {
        selectServicos.innerHTML = '<option disabled>Você não tem serviços cadastrados</option>';
    }

    // Limpa os campos do formulário
    document.getElementById('addPromocaoNome').value = '';
    document.getElementById('addPromocaoDescricao').value = '';
    document.getElementById('addPromocaoDesconto').value = '';
    document.getElementById('addPromocaoValidade').value = '';
    document.getElementById('addPromocaoValorMinimo').value = '';

    abrirModal('modalAddPromocao');
}

// SUBSTITUA a função salvarNovaPromocao por esta:
async function salvarNovaPromocao() {
    // ... (código original de validação e salvar no DB) ...
    const nome = document.getElementById('addPromocaoNome').value.trim();
    const descricao = document.getElementById('addPromocaoDescricao').value.trim();
    const desconto = parseInt(document.getElementById('addPromocaoDesconto').value);
    const validadeInput = document.getElementById('addPromocaoValidade').value;
    const valorMinimo = parseFloat(document.getElementById('addPromocaoValorMinimo').value) || 0;
    const servicosSelecionados = Array.from(document.getElementById('addPromocaoServicos').selectedOptions).map(option => option.value);

    if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) { return exibirPopup("Preencha nome, descrição e um desconto válido."); }
    if (servicosSelecionados.length === 0) { return exibirPopup("Selecione pelo menos um serviço para aplicar a promoção."); }

    const novaPromocao = { id: `promo_${new Date().getTime()}`, nome, descricao, desconto, servicosAplicaveis: servicosSelecionados, valorMinimo: valorMinimo, validade: validadeInput ? new Date(validadeInput + 'T23:59:59') : null };

    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({ promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao) });
        exibirPopup("Promoção salva com sucesso!");
        fecharModalAtual();

        // --- ADIÇÃO PARA FLUXO PÓS-CADASTRO ---
        // ... (código de sucesso)
fecharModalAtual(); // Fecha o modal de adicionar promoção

if (fluxoPosCadastroAtivo) {
    finalizarFluxoPosCadastro(); // Finaliza o fluxo aqui
} else {
    // Comportamento normal: Atualiza a lista se o modal de promoções estiver aberto
    const promocoesDoc = await db.collection("usuarios").doc(auth.currentUser.uid).get();
    if (promocoesDoc.exists) { // Verifica se o documento existe
       perfil.promocoes = promocoesDoc.data().promocoes;
       if (document.getElementById('modalPromocoesBarbeiro').classList.contains('show')) {
           carregarPromocoesAtivas();
       }
    }
}
        // --- FIM DA ADIÇÃO ---

    } catch (e) { /* ... (bloco catch original) ... */
        exibirPopup("Erro ao salvar promoção: " + e.message);
    }
}

function abrirAvaliacoesBarbeiro() {
  abrirModal('modalAvaliacoes');
  const lista = document.getElementById("listaAvaliacoesModal");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  
  db.collection("avaliacoes")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .orderBy("ts", "desc")
    .limit(30)
    .onSnapshot(async snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma avaliação recebida.</p>" : "";
      
      for (const doc of snap.docs) {
        const a = doc.data();
        let clienteNome = "Anônimo";
        
        // Tenta pegar nome do cliente
        if (a.clienteUid) {
             // Otimização: Se for avaliação recente, provavelmente está no cache do navegador
             try {
                 const clienteDoc = await db.collection("usuarios").doc(a.clienteUid).get();
                 if (clienteDoc.exists) clienteNome = clienteDoc.data().nome;
             } catch(e){}
        }

        // HTML da foto (se houver)
        let fotoHtml = '';
        if (a.fotoUrl) {
            fotoHtml = `<img src="${a.fotoUrl}" style="width:100%; height:150px; object-fit:cover; border-radius:8px; margin-top:10px; border:1px solid #444;" onclick="window.open(this.src)">`;
        }

        lista.innerHTML += `
        <div class="card" style="margin-bottom:15px; border-left: 3px solid var(--cor-destaque);">
            <div style="display:flex; justify-content:space-between;">
                <span>${clienteNome}</span>
                <span style="color:var(--cor-destaque)">${a.nota}/10 ⭐</span>
            </div>
            <p style="margin-top:5px; font-style:italic; font-size:13px;">"${a.comentario}"</p>
            ${fotoHtml}
            <small style="display:block; margin-top:5px; opacity:0.5; font-size:10px;">
                ${a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString() : ''}
            </small>
        </div>`;
      }
    });
}

// Variável para guardar qual ID abrir
let idAgendamentoPrioritario = null;
let listenerMapaFooter = null;

// Chame esta função dentro de 'carregarPerfilUsuario' (no bloco inicial ou onde carrega listeners)
function iniciarMonitoramentoMapaAtivo(uid) {
    if (listenerMapaFooter) listenerMapaFooter();

    // Monitora agendamentos ativos (conclusão pendente)
    listenerMapaFooter = db.collection('agendamentos')
        .where('barbeiroUid', '==', uid)
        .where('status', 'in', ['conclusão pendente', 'confirmado']) // Pega os ativos
        .onSnapshot(snap => {
            const footerBtn = document.getElementById('footerMapContainer');
            const redeemBtn = document.getElementById('redeemContainer');
            
            if (snap.empty) {
                // Nenhuma viagem ativa -> Esconde botão mapa, mostra resgate
                if(footerBtn) footerBtn.classList.add('hidden');
                if(redeemBtn) redeemBtn.classList.remove('hidden');
                idAgendamentoPrioritario = null;
                return;
            }

            // --- LÓGICA DE PRIORIDADE ---
            let melhorAgendamento = null;
            let melhorTimestamp = 0; // Para pegar o último criado

            snap.forEach(doc => {
                const ag = doc.data();
                ag.id = doc.id;
                
                // Prioridade 1: Vaga Imediata (Sempre ganha)
                if (!melhorAgendamento && (ag.horario === 'imediato' || !ag.horario)) {
                    melhorAgendamento = ag;
                }
                // Prioridade 2: Horário Programado (Pega o mais recente criado/em curso)
                else if (melhorAgendamento && (melhorAgendamento.horario === 'imediato' || !melhorAgendamento.horario)) {
                    // Se já temos um imediato, mantém ele (Imediato > Programado)
                } 
                else {
                    // Disputa entre programados: Pega o que tiver TS maior (último criado)
                    // Ou poderia ser o mais próximo da hora atual. Vamos usar o último criado como pedido.
                    const ts = ag.ts ? ag.ts.toMillis() : 0;
                    if (ts > melhorTimestamp) {
                        melhorTimestamp = ts;
                        melhorAgendamento = ag;
                    }
                }
            });

            if (melhorAgendamento) {
                // Achou um ativo -> Mostra botão mapa, esconde resgate
                idAgendamentoPrioritario = melhorAgendamento;
                
                if(footerBtn) footerBtn.classList.remove('hidden');
                if(redeemBtn) redeemBtn.classList.add('hidden'); // Esconde o de baixo para não sobrepor feio
                
                // Esconde também o botão chiclete do topo se ele estiver visível (para não ter 2)
                const btnTopo = document.getElementById('btnMinimizadoMapa');
                if(btnTopo) btnTopo.style.display = 'none';
            }
        });
}

// Função do Clique no Botão do Rodapé
function abrirMapaPrioritario() {
    fecharModalAtual();
    if (!idAgendamentoPrioritario) return;
    
    const ag = idAgendamentoPrioritario;
    
    // Abre o rastreamento
    // Se o profissional ainda não tem lat/lon gravada no agendamento, usa a do perfil dele
    if (perfil.latitude && perfil.longitude) {
        iniciarRastreamento(
            ag.clienteUid,         // Outro UID (Cliente)
            perfil.latitude,       // Minha Lat (Destino)
            perfil.longitude,      // Minha Lon (Destino)
            'profissional',        // Meu Papel
            ag.id                  // ID do Agendamento
        );
    } else {
        exibirPopup("Erro", "Sua localização não está definida para abrir o mapa.");
    }
}

// ======================================================================
// --- NOVAS FUNÇÕES DE PAGAMENTO (APRIMORADO) ---
// ======================================================================

// SUBSTITUA a função 'iniciarDeposito' inteira (Linha ~4661) por esta:

function iniciarDeposito() {
    if (checkGuestLimit()) return;
    if (isTwa) {
        // Ambiente TWA (Play Store): Abre o modal de depósito do Google Play
        abrirModal('modalDepositoPlayStore');
    } else {
        // Ambiente Web (Navegador): Abre o formulário de depósito (PIX/Cartão)
        abrirModal('modalDepositoFormulario');
        const inputs = ['depositoPrimeiroNome', 'depositoSegundoNome', 'depositoCpf', 'depositoTelefone'];
        const btn = document.getElementById('btnContinuarDeposito');
        inputs.forEach(id => {
            document.getElementById(id).oninput = () => {
                const allFilled = inputs.every(i => document.getElementById(i).value.trim() !== '');
                btn.disabled = !allFilled;
            };
        });
    }
}

async function criarSolicitacaoDeposito() {
    const primeiroNome = document.getElementById('depositoPrimeiroNome').value.trim();
    const segundoNome = document.getElementById('depositoSegundoNome').value.trim();
    const cpf = document.getElementById('depositoCpf').value.trim();
    const telefone = document.getElementById('depositoTelefone').value.trim();
    const valor = parseFloat(document.getElementById('depositoValor').value);

    if (!primeiroNome || !segundoNome || !cpf || !telefone || isNaN(valor) || valor <= 0) {
        return exibirPopup("Por favor, preencha todos os campos corretamente.");
    }

    const nomeCompleto = `${primeiroNome} ${segundoNome}`;
    const tipoSaldoDesc = tipoDepositoAtual === 'digital' ? 'Moedas Digitais' : 'Saldo de Serviços';

    exibirAguarde("Gerando solicitação...");

    try {
        // 1. Salva no banco de dados (Painel Admin)
        await db.collection("solicitacoes").add({
            tipo: "deposito",
            subtipo: tipoDepositoAtual, // 'servico' ou 'digital'
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            dadosDeposito: { nomeCompleto, cpf, telefone },
            valor: valor,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Notifica Admin
        notifyAdmins("📥 Novo Depósito Iniciado", `${perfil.nome} quer depositar R$${valor.toFixed(2)}.`, { link: '#solicitacoes' });

        // 3. FECHA TUDO E ABRE A ESCOLHA DE PAGAMENTO
        fecharTodosOsModais(); // Fecha o aguarde e o formulário
        
        // Pequeno delay para garantir a transição visual
        setTimeout(() => {
            abrirModal('modalDeposito');
        }, 500);

    } catch (error) {
        console.error("Erro ao criar solicitação:", error);
        fecharTodosOsModais();
        exibirPopup("Erro ao processar solicitação. Tente novamente.");
    }
}

function iniciarSaque() {
  abrirModal('modalSaque');
}

function processarPagamentoPixAprimorado() {
    // Fecha o modal de escolha de pagamento
    fecharModalAtual();
    exibirAguarde('Gerando dados PIX...');
    
    setTimeout(() => {
        fecharTodosOsModais(); // Fecha o aguarde
        
        // 1. Injeta os dados corretos nos elementos
        const textarea = document.getElementById('pixChaveAleatoria');
        const displayChave = document.getElementById('pixChaveDisplay');
        
        const chavePixReal = "18912553712"; // SUA CHAVE
        
        if(textarea) textarea.value = chavePixReal;
        if(displayChave) displayChave.textContent = chavePixReal;
        
        // 2. Abre o modal com os dados visíveis
        abrirModal('modalExibirPixAprimorado');
        
        // 3. Inicia o timer de 10 minutos
        iniciarTimerPix(600); 
    }, 1000); 
}

function abrirModalTaxaCartao() {
    abrirModal('modalTaxaCartao');
}

function processarPagamentoCartaoAprimorado() {
    notifyAdmins("🟢 Tentativa de Cartão!", `${perfil.nome} está tentando pagar com cartão de crédito.`);
    exibirAguarde('Redirecionando...', 'Você está indo para uma plataforma segura de pagamento.');
    setTimeout(() => {
        window.open('https://pay.kiwify.com.br/T3M9m1C', '_blank');
        fecharTodosOsModais();
    }, 2500);
}

function iniciarTimerPix(duracao) {
    if (pixTimerInterval) clearInterval(pixTimerInterval);
    let timer = duracao;
    const display = document.getElementById('pixTimer');
    pixTimerInterval = setInterval(() => {
        const minutos = parseInt(timer / 60, 10);
        const segundos = parseInt(timer % 60, 10);
        display.textContent = `${minutos < 10 ? "0" + minutos : minutos}:${segundos < 10 ? "0" + segundos : segundos}`;
        if (--timer < 0) {
            clearInterval(pixTimerInterval);
            display.textContent = "EXPIRADO";
            abrirModal('modalPixExpirado');
        }
    }, 1000);
}

function tentarGerarPixNovamente() {
    fecharTodosOsModais();
    setTimeout(() => {
        processarPagamentoPixAprimorado();
    }, 300);
}

function copiarCodigoPixAprimorado(event) {
    const textoParaCopiar = document.getElementById('pixChaveAleatoria').value;
    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const botao = event.target;
        botao.textContent = '✅ Copiado!';
        notifyAdmins("🟢 Chave PIX Copiada!", `O usuário ${perfil.nome} copiou a chave PIX. Provável depósito a caminho.`);
        setTimeout(() => {
            botao.textContent = 'Copiar Chave Aleatória PIX';
        }, 2000);
    }).catch(err => {
        console.error('Falha ao copiar: ', err);
        exibirPopup('Não foi possível copiar o código. Por favor, selecione e copie manualmente.');
    });
}

function confirmarEnvioComprovante() {
    const mensagem = encodeURIComponent("Olá! Segue o comprovante do meu depósito no app King Agenda.");
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharTodosOsModais();
}

// --- CONTROLE DE ALERTA (LOOP DE 10 VEZES) ---
let loopAlertaInterval = null;
let contadorAlerta = 0;

function dispararAlertaMaximo() {
    // 1. Para qualquer som anterior
    pararSomAlerta();
    if (loopAlertaInterval) clearInterval(loopAlertaInterval);
    
    // 2. Mostra botão de parar
    const btn = document.getElementById('btnPararAlerta');
    if(btn) btn.classList.remove('hidden');

    // 3. Toca a primeira vez
    tocarSom('alerta');
    contadorAlerta = 1;
    console.log("🚨 ALERTA MÁXIMO INICIADO (1/10)");

    // 4. Inicia o loop (toca a cada 2.5 segundos)
    loopAlertaInterval = setInterval(() => {
        if (contadorAlerta >= 10) {
            pararAlertaManual(); // Para sozinho depois de 10 vezes
        } else {
            tocarSom('alerta');
            contadorAlerta++;
            console.log(`🚨 ALERTA ${contadorAlerta}/10`);
        }
    }, 2500); // 2.5s dá tempo do áudio terminar antes de tocar o próximo
}

function pararAlertaManual() {
    if (loopAlertaInterval) {
        clearInterval(loopAlertaInterval);
        loopAlertaInterval = null;
    }
    pararSomAlerta(); // Sua função existente que pausa o áudio
    const btn = document.getElementById('btnPararAlerta');
    if(btn) btn.classList.add('hidden');
    contadorAlerta = 0;
}

async function confirmarSaque() {
    const nome = document.getElementById('saqueNomeCompleto').value.trim();
    const valorSolicitado = parseFloat(document.getElementById('saqueValor').value);
    const chaveTipo = document.getElementById('saqueChavePixTipo').value;
    const chave = document.getElementById('saqueChavePix').value.trim();

    if (!nome || isNaN(valorSolicitado) || valorSolicitado <= 0 || !chaveTipo || !chave) {
        return exibirPopup("Preencha todos os dados corretamente.");
    }

    // Leitura dos saldos
    // Fallback: se saldoReal não existe, usa 'saldo' antigo
    const saldoRealDisponivel = (perfil.saldoReal !== undefined) ? perfil.saldoReal : (perfil.saldo || 0);
    const saldoBonusDisponivel = perfil.saldoBonus || 0;

    // --- REGRA DE SAQUE 1:1 ---
    // Tentamos tirar metade de cada. 
    // Se não tiver bonus suficiente, tira mais do real.
    // O que NÃO PODE é tirar mais bônus do que real.
    
    let debitoBonus = valorSolicitado / 2;
    let debitoReal = valorSolicitado / 2;

    // Se o débito de bônus exceder o que o usuário tem de bônus, ajusta
    if (debitoBonus > saldoBonusDisponivel) {
        const diferenca = debitoBonus - saldoBonusDisponivel;
        debitoBonus = saldoBonusDisponivel; // Zera o bônus dele
        debitoReal += diferenca; // O resto sai do Real
    }

    // VERIFICAÇÃO FINAL: O saldo Real cobre a parte dele?
    if (debitoReal > saldoRealDisponivel) {
        return exibirPopup("Saldo Real Insuficiente", 
            `Para sacar R$ ${valorSolicitado.toFixed(2)}, pela regra de Bônus (1:1), você precisaria de:\n` +
            `• R$ ${debitoReal.toFixed(2)} de Saldo Real\n` +
            `• R$ ${debitoBonus.toFixed(2)} de Saldo Bônus\n\n` +
            `Seu Saldo Real disponível: R$ ${saldoRealDisponivel.toFixed(2)}`
        );
    }

    // Se passou, confirma e envia para o admin
    if(!confirm(`Confirma o saque de R$ ${valorSolicitado.toFixed(2)}?\n\nSerá debitado:\n- R$ ${debitoReal.toFixed(2)} (Real)\n- R$ ${debitoBonus.toFixed(2)} (Bônus)`)) return;

    exibirAguarde("Enviando solicitação...");

    try {
        await db.collection("solicitacoes").add({
            tipo: "saque",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            dadosSaque: { nomeTitular: nome },
            valor: valorSolicitado,
            debitoRealCalculado: debitoReal,   // Admin saberá quanto tirar de cada
            debitoBonusCalculado: debitoBonus,
            chavePixTipo: chaveTipo,
            chavePix: chave,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();
        abrirModal('modalSaqueConfirmado');

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

function contatarAdminSaque() {
    const valor = document.getElementById('saqueValor').value;
    const mensagem = encodeURIComponent(`Olá! Acabei de solicitar um saque no valor de R$${valor} e gostaria de confirmar o recebimento.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharTodosOsModais();
}

// ======================================================================
// --- FIM DAS FUNÇÕES DE PAGAMENTO ---
// ======================================================================

function pedirConfirmacaoFecharPopup(modalId, titulo = '🤔 Tem certeza?', mensagem = 'Você pode completar esta etapa mais tarde pelas configurações.') {
    modalOriginalIdParaConfirmar = modalId; // Guarda qual modal pediu
    document.getElementById('confirmarFecharTitulo').textContent = titulo;
    document.getElementById('confirmarFecharMensagem').textContent = mensagem;
    abrirModal('modalConfirmarFecharPopup');
}

function confirmarFechamentoPopup() {
    fecharModalAtual(); // Fecha o modal de confirmação
    if (modalOriginalIdParaConfirmar) {
        // Encontra o modal original na pilha e o remove também
        const modalOriginal = document.getElementById(modalOriginalIdParaConfirmar);
        if (modalOriginal && modalOriginal.classList.contains('show')) {
            const indexNaPilha = modalStack.indexOf(modalOriginal);
            if (indexNaPilha > -1) {
                modalStack.splice(indexNaPilha, 1);
            }
            modalOriginal.classList.remove('show');
            setTimeout(() => { modalOriginal.style.display = 'none'; }, 300);
        }

        // --- LÓGICA DE AVANÇO NO FLUXO PÓS-CADASTRO ---
        if (fluxoPosCadastroAtivo) {
            if (modalOriginalIdParaConfirmar === 'modalLogomarca') {
                abrirModalComConfirmacao('modalPortfolioBarbeiro', '🖼️ Adicionar ao Portfólio'); // Próximo: Portfólio
            } else if (modalOriginalIdParaConfirmar === 'modalPortfolioBarbeiro') {
                abrirModalComConfirmacao('modalAddPromocao', '🎁 Adicionar Promoção (Opcional)'); // Próximo: Promoção (Opcional)
            } else if (modalOriginalIdParaConfirmar === 'modalAddPromocao') {
                finalizarFluxoPosCadastro(); // Finaliza o fluxo se pular a promoção
            }
        }
        // --- FIM DA LÓGICA DE AVANÇO ---

        modalOriginalIdParaConfirmar = null; // Limpa a referência
    }
 }

function cancelarFechamentoPopup() {
    fecharModalAtual(); // Fecha apenas o modal de confirmação
    // Não faz nada com o modal original, ele continua aberto
    modalOriginalIdParaConfirmar = null; // Limpa a referência
}

async function confirmarSolicitacaoAcessoLoja() {
    // Verifica se já existe uma solicitação pendente para evitar duplicação
    try {
        const q = db.collection("solicitacoes")
            .where("usuarioUid", "==", auth.currentUser.uid)
            .where("tipo", "==", "liberacao_loja")
            .where("status", "==", "pendente");
        const existingRequests = await q.get();
        if (!existingRequests.empty) {
            fecharModalAtual(); // Fecha o modal de solicitação
            return exibirPopup("Atenção", "Você já possui uma solicitação de acesso à loja pendente. Aguarde a análise do administrador.");
        }
    } catch (error) {
        console.error("Erro ao verificar solicitações existentes:", error);
        // Continua mesmo se a verificação falhar, mas loga o erro
    }

    exibirAguarde("Enviando solicitação...");

    try {
        // Cria a solicitação no Firestore
        await db.collection("solicitacoes").add({
            tipo: "liberacao_loja",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome, // Pega o nome do perfil carregado
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Prepara e abre o link do WhatsApp
        const mensagem = encodeURIComponent(`Olá! Gostaria de solicitar autorização para cadastrar produtos na loja do app King Agenda.\n\nMeu nome de usuário é: ${perfil.nome}\nMeu email: ${perfil.email}`);
        const phoneNum = WHATSAPP_ADM_PHONE.startsWith('55') ? WHATSAPP_ADM_PHONE : `55${WHATSAPP_ADM_PHONE.replace(/\D/g, '')}`;
        window.open(`https://wa.me/${phoneNum}?text=${mensagem}`, '_blank');

        fecharTodosOsModais(); // Fecha o "Aguarde" e o modal de solicitação
        exibirPopup("✅ Solicitação Enviada!", "Seu pedido foi enviado para análise. Você foi redirecionado(a) ao WhatsApp para contato.");

        // Notifica os administradores
        notifyAdmins("🛍️ Nova Solicitação de Loja", `${perfil.nome} (${perfil.email}) solicitou acesso para vender na loja.`, { link: '#solicitacoes' });

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao confirmar solicitação de acesso à loja:", error);
        exibirPopup("Erro", "Não foi possível enviar sua solicitação: " + error.message);
    }
 }

async function publicarBlog() {
  const titulo = document.getElementById("blogTitulo").value.trim();
  const conteudo = document.getElementById("blogConteudo").value.trim();
  if (!titulo || !conteudo) return exibirPopup("Preencha todos os campos.");
  await db.collection("blog").add({
    titulo, conteudo, autor: perfil.nome, autorUid: auth.currentUser.uid,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  exibirPopup("Postagem publicada!");
  fecharModalAtual();
}

function carregarListaBlog() {
  const lista = document.getElementById("listaBlog");
  lista.innerHTML = "<div class='spinner'></div>";
  
  db.collection("blog").orderBy("ts", "desc").onSnapshot(snap => {
    lista.innerHTML = "";
    
    // --- 1. INJEÇÃO DOS POSTS FIXOS DE PROMOÇÃO ---
    
    // Card para Clientes (VIP)
    const cardVip = `
        <div class="card" style="margin-bottom:15px; border: 2px solid #d4af37; background: linear-gradient(135deg, #1a0b00, #000);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:#d4af37;">🎁 PRESENTE: 30 DIAS VIP</h4>
                <span style="background:#d4af37; color:black; font-size:10px; padding:2px 6px; border-radius:4px;">EXCLUSIVO CLIENTE</span>
            </div>
            <p style="margin-top:10px; color:#fff;">Experimente Cashback em dobro, taxas zero e destaque no chat!</p>
            <div style="background:#333; padding:10px; border-radius:8px; text-align:center; margin-top:10px;">
                <p style="margin:0; font-size:12px; color:#aaa;">Seu código:</p>
                <strong style="font-size:24px; color:#fff; letter-spacing:2px;">(VIP)</strong>
            </div>
            <button onclick="abrirPortaSecreta()" style="width:100%; margin-top:10px; background:#d4af37; color:#000; font-weight:bold;">💎 Resgatar Agora</button>
        </div>`;

    // Card para Profissionais (TIER 1)
    const cardTier1 = `
        <div class="card" style="margin-bottom:15px; border: 2px solid #00c6ff; background: linear-gradient(135deg, #001a2b, #000);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:#00c6ff;">🎁 PRESENTE: 30 DIAS PRO</h4>
                <span style="background:#00c6ff; color:black; font-size:10px; padding:2px 6px; border-radius:4px;">EXCLUSIVO PROFISSIONAL</span>
            </div>
            <p style="margin-top:10px; color:#fff;">Libere a Vaga Imediata e aumente seus ganhos sem pagar nada agora!</p>
            <div style="background:#333; padding:10px; border-radius:8px; text-align:center; margin-top:10px;">
                <p style="margin:0; font-size:12px; color:#aaa;">Seu código:</p>
                <strong style="font-size:24px; color:#fff; letter-spacing:2px;">(TIER1)</strong>
            </div>
            <button onclick="abrirPortaSecreta()" style="width:100%; margin-top:10px; background:#00c6ff; color:#000; font-weight:bold;">🚀 Resgatar Agora</button>
        </div>`;

    // Exibe os cards fixos no topo
    lista.innerHTML += cardVip;
    lista.innerHTML += cardTier1;
    
    // -------------------------------------------------

    // Posts normais do banco
    const trintaHorasAtras = new Date().getTime() - (30 * 60 * 60 * 1000);
    snap.forEach(doc => {
      const p = doc.data();
      if (p.ts && p.ts.toDate().getTime() > trintaHorasAtras) {
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><h4>${p.titulo}</h4><p>${p.conteudo}</p><p style="font-size:12px;opacity:0.7;">Por: ${p.autor}</p></div>`;
      }
    });
  });
}

// Função auxiliar para o botão do modal
function irParaBlogPromo() {
    fecharModalAtual();
    carregarListaBlog();
    abrirModal('modalBlog');
}

document.getElementById('onlineUserCount').onclick = () => abrirModalUsuariosOnline();

function carregarAdmin() {
    if (adminBalanceListener) adminBalanceListener(); 
    db.collection("usuarios").get().then(snapshot => {
        adminUserBalances = {};
        snapshot.forEach(doc => { adminUserBalances[doc.id] = doc.data().saldo || 0; });
        adminBalanceListener = db.collection("usuarios").onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "modified") {
                    const novo = change.doc.data();
                    const id = change.doc.id;
                    const antigoSaldo = adminUserBalances[id] || 0;
                    const novoSaldo = novo.saldo || 0;
                    if (Math.floor(novoSaldo / 100) > Math.floor(antigoSaldo / 100)) {
                        exibirPopup(`⚠️ Alerta de Saldo! ${novo.nome} ultrapassou R$${Math.floor(novoSaldo / 100) * 100}.`);
                    }
                    adminUserBalances[id] = novoSaldo;
                }
            });
        });
    });

    // Listener para solicitações pendentes
    db.collection("solicitacoes").where("status", "==", "pendente").onSnapshot(snap => {
        const btn = document.getElementById('btnAdminSolicitacoes');
        if (btn) btn.classList.toggle('notificacao-pulsante', !snap.empty);
    });

    // Listener para denúncias abertas
    db.collection("denuncias").where("status", "==", "aberta").onSnapshot(snap => {
        const btn = document.getElementById('btnAdminDenuncias');
        if (btn) btn.classList.toggle('notificacao-pulsante', !snap.empty);
    });

    // --- NOVO: Listener para Contas Excluídas (Popup do Admin) ---
    db.collection("avisos")
        .where("destinatario", "==", "admin")
        .where("tipo", "==", "conta_excluida_admin")
        .where("lido", "==", false)
        .onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const aviso = change.doc.data();
                    
                    // Prepara mensagem do WhatsApp
                    const msgWpp = encodeURIComponent(`Olá ${aviso.usuarioNome}, vi que você excluiu sua conta do aplicativo King Agenda. Há algo que eu possa fazer para melhorar sua experiência ou ajudar a resolver algum problema?`);
                    const phoneNum = aviso.usuarioTelefone ? aviso.usuarioTelefone.replace(/\D/g, '') : null;
                    
                    // Callback do botão OK (Abre WhatsApp e marca aviso como lido)
                    const acaoAdmin = () => {
                        if (phoneNum) {
                            window.open(`https://wa.me/55${phoneNum}?text=${msgWpp}`, '_blank');
                        } else {
                            exibirPopup("Sem Telefone", "O usuário não tinha telefone cadastrado.");
                        }
                        // Marca como lido para não aparecer de novo
                        db.collection("avisos").doc(change.doc.id).update({ lido: true });
                    };

                    // Exibe Popup Bloqueante
                    let textoPopup = `O usuário ${aviso.usuarioNome} excluiu a conta.`;
                    if(!phoneNum) textoPopup += `<br>(Usuário sem telefone cadastrado)`;
                    
                    exibirPopupBloqueante(
                        "🗑️ Conta Excluída!", 
                        textoPopup + "<br><br>Clique abaixo para entrar em contato e tentar recuperar o usuário.", 
                        acaoAdmin
                    );
                    
                    // Altera o texto do botão do popup bloqueante dinamicamente
                    setTimeout(() => {
                        const btn = document.getElementById('btnOkBloqueante');
                        if(btn) btn.textContent = phoneNum ? "💬 Chamar no WhatsApp" : "Ok, Entendi";
                    }, 100);
                }
            });
        });
    // ------------------------------------------------------------

    // Listener para usuários online (somente admin)
    const countElement = document.getElementById('onlineUserCount');
    if (onlineUsersListener) onlineUsersListener(); // Cancela listener anterior

    const thresholdDate = new Date(Date.now() - USER_ACTIVE_THRESHOLD_MS); // Data limite (ex: 5 min atrás)

    onlineUsersListener = db.collection('usuarios')
        .where('lastSeen', '>', thresholdDate)
        .onSnapshot(snap => {
            const count = snap.size;
            if (countElement) {
                // Atualiza o texto do botão
                countElement.textContent = `🏆 ${count} Online`; 
                countElement.classList.toggle('hidden', !(perfil && perfil.tipo === 'admin' && userView.currentType === 'admin'));
            }

            // ATUALIZA A LISTA DO MODAL EM TEMPO REAL
            const lista = document.getElementById('listaUsuariosOnline');
            if (lista) {
                lista.innerHTML = ""; // Limpa a lista
                if (snap.empty) {
                    lista.innerHTML = "<p>Nenhum usuário online no momento.</p>";
                    return;
                }
                snap.forEach(doc => {
                    const u = doc.data();
                    lista.innerHTML += `<div class="selectable-item" onclick="adminAbrirInfoChat('${doc.id}')" title="Ver opções para ${u.nome}">${u.nome}</div>`;
                });
            }

        }, err => {
            console.error("Erro ao ouvir usuários online:", err);
            if (countElement) countElement.classList.add('hidden');
        });
}

function abrirModalUsuariosOnline() {
    abrirModal('modalUsuariosOnline');
    // A lista é populada em tempo real pelo listener em carregarAdmin()
}

function abrirWhatsApp(telefone) {
    if (!telefone) {
        return exibirPopup("Aviso", "Este usuário não possui um número de telefone cadastrado.");
    }
    const phoneNum = telefone.startsWith('55') ? telefone : `55${telefone.replace(/\D/g, '')}`;
    window.open(`https://wa.me/${phoneNum}`, '_blank');
}

async function abrirModalEstatisticas() {
    abrirModal('modalEstatisticas');
    const painel = document.getElementById("estatisticasPainel");
    painel.innerHTML = "<p>⏳ Carregando estatísticas e gráficos...</p>";
    
    try {
        // --- 1. DADOS DE USUÁRIOS E ECONOMIA ---
        const usuariosSnap = await db.collection("usuarios").get();
        let totalUsuarios = usuariosSnap.size;
        let clientes = 0, barbeiros = 0, vip = 0, pro = 0;
        let somaReputacao = 0, barbeirosComReputacao = 0;
        
        // Variáveis de Economia
        let totalReal = 0;
        let totalBonus = 0;
        let totalDigital = 0; // Moedas

        usuariosSnap.forEach(doc => {
            const u = doc.data();
            
            // Contagem de Tipos
            if (u.tipo === "cliente") clientes++;
            if (u.tipo === "barbeiro" || u.tipo === 'manicure_pedicure' || u.tipo === 'designer_cilios') {
                barbeiros++; 
                if(u.reputacao) {
                    somaReputacao += u.reputacao;
                    barbeirosComReputacao++;
                }
            }
            if (u.vip) vip++;
            if (isProAtivo(u)) pro++;

            // Soma dos Saldos (Economia)
            totalReal += (u.saldoReal !== undefined ? u.saldoReal : (u.saldo || 0));
            totalBonus += (u.saldoBonus || 0);
            totalDigital += (u.saldoDigital || 0);
        });

        const mediaReputacao = barbeirosComReputacao > 0 ? (somaReputacao / barbeirosComReputacao).toFixed(0) : 'N/A';

        // --- 2. DADOS DE AGENDAMENTOS ---
        const agendamentosSnap = await db.collection("agendamentos").get();
        let totalAgendamentos = agendamentosSnap.size;
        let concluidos = 0, cancelados = 0;
        agendamentosSnap.forEach(doc => {
            const status = doc.data().status;
            if (status === 'concluido') concluidos++;
            if (status === 'cancelado') cancelados++;
        });

        // --- 3. DADOS DO SISTEMA ---
        const solicitacoesSnap = await db.collection("solicitacoes").where('status', '==', 'pendente').get();
        let solicitacoesPendentes = solicitacoesSnap.size;

        const financeiroDoc = await db.collection("config").doc("financeiro").get();
        const fin = financeiroDoc.data() || { arrecadadoTaxas: 0, arrecadadoVip: 0, arrecadadoPro: 0 };
        
        // --- 4. RENDERIZAÇÃO DO HTML ---
        painel.innerHTML = `
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <div class="popup-section" style="flex: 1; min-width: 200px;">
                    <h4>👥 Usuários (${totalUsuarios})</h4>
                    <p>Clientes: <b>${clientes}</b></p>
                    <p>Profissionais: <b>${barbeiros}</b></p>
                    <p>VIPs: <b>${vip}</b> | PROs: <b>${pro}</b></p>
                </div>
                <div class="popup-section" style="flex: 1; min-width: 200px;">
                    <h4>🗓️ Agendamentos</h4>
                    <p>Total: <b>${totalAgendamentos}</b></p>
                    <p style="color:#4CAF50">Concluídos: <b>${concluidos}</b></p>
                    <p style="color:#e74c3c">Cancelados: <b>${cancelados}</b></p>
                </div>
            </div>

            <div class="popup-section" style="background: #1a1a1a; border: 1px solid #333;">
                <h4 style="text-align:center; color: #f1c40f;">💰 Economia do Jogo</h4>
                <div style="display:flex; justify-content: space-around; font-size: 11px; margin-bottom: 10px;">
                    <div style="text-align:center"><span style="color:#2ecc71; font-size:14px;">●</span><br>R$ ${totalReal.toFixed(2)}<br>Real</div>
                    <div style="text-align:center"><span style="color:#3498db; font-size:14px;">●</span><br>R$ ${totalBonus.toFixed(2)}<br>Bônus</div>
                    <div style="text-align:center"><span style="color:#f1c40f; font-size:14px;">●</span><br>${totalDigital}<br>Moedas</div>
                </div>
                <div style="padding: 10px; text-align: center;">
    <button onclick="limparEconomiaDiretoNoBanco()" class="btn-danger-reset" 
        style="background: #c0392b; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 4px 15px rgba(192, 57, 43, 0.3);">
        🚀 ZERAR TUDO PARA O LANÇAMENTO
    </button>
</div>
                <div style="max-width: 300px; margin: 0 auto;">
                    <canvas id="chartEconomia"></canvas>
                </div>
            </div>

            <div class="popup-section">
                <h4>⚙️ Admin & Taxas</h4>
                <p>Reputação Média: ⭐ ${mediaReputacao}</p>
                <p>Solicitações Pendentes: <b>${solicitacoesPendentes}</b></p>
                <hr style="border-color:#333; margin: 5px 0;">
                <p>Taxas Arrecadadas: <span style="color:#2ecc71">R$ ${fin.arrecadadoTaxas.toFixed(2)}</span></p>
                <p>Vendas VIP/PRO: <span style="color:#f1c40f">R$ ${(fin.arrecadadoVip + fin.arrecadadoPro).toFixed(2)}</span></p>
            </div>
        `;

        // --- 5. RENDERIZAÇÃO DO GRÁFICO (CHART.JS) ---
        // Pequeno delay para garantir que o Canvas existe no DOM
        setTimeout(() => {
            const ctx = document.getElementById('chartEconomia');
            if(ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Saldo Real (R$)', 'Saldo Bônus (R$)', 'Moedas (Qtd)'],
                        datasets: [{
                            data: [totalReal, totalBonus, totalDigital],
                            backgroundColor: ['#2ecc71', '#3498db', '#f1c40f'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }, // Legenda oculta pois já fiz manual acima
                            title: { display: false }
                        },
                        cutout: '70%' // Espessura da rosquinha
                    }
                });
            }
        }, 100);

    } catch (error) {
        painel.innerHTML = "<p style='color:red'>Erro ao carregar stats: " + error.message + "</p>";
        console.error("Erro estatisticas:", error);
    }
}

function iniciarCompraMoedas() {
    const modal = document.getElementById('modalCompraMoedas');
    const grid = document.getElementById('gridLojaDiamantes');
    
    const produtos = [
        { id: 'diamante_1',  qtd: 1,   nome: 'Gota Solitária', icon: '💎', pop: '' },
        { id: 'diamante_3',  qtd: 3,   nome: 'Pequeno Lote',   icon: '💎💎', pop: '' },
        { id: 'diamante_10', qtd: 10,  nome: 'Pack King',      icon: '💎✨', pop: 'MAIS VENDIDO' },
        { id: 'diamante_25', qtd: 25,  nome: 'Cesto de Luz',   icon: '📦💎', pop: 'MELHOR VALOR' },
        { id: 'diamante_100', qtd: 100, nome: 'Baú do Trono',   icon: '💰💎', pop: 'SUPREMO' }
    ];

    grid.innerHTML = produtos.map(p => `
        <div class="card-diamante ${p.pop ? 'destaque' : ''}">
            ${p.pop ? `<span class="badge-pop">${p.pop}</span>` : ''}
            <div class="card-icon">${p.icon}</div>
            <div class="card-info">
                <span class="card-qtd">${p.qtd} Diamantes</span>
                <span class="card-nome">${p.nome}</span>
            </div>
            <button class="btn-comprar-item" onclick="processarCompraPlayStore('${p.id}')">ADQUIRIR</button>
        </div>
    `).join('');

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Trava o fundo
}

function fecharModalCompraMoedas() {
    document.getElementById('modalCompraMoedas').style.display = 'none';
    document.body.style.overflow = 'auto'; // Destrava o fundo
}

async function processarCompraPlayStore(skuId) {
    if (!auth.currentUser) return;
    
    // 1. Verifica se o navegador suporta a API de Bens Digitais (TWA)
    if (!window.getDigitalGoodsService) {
        exibirPopup("Loja Indisponível", "Esta loja só funciona dentro do aplicativo Android instalado.");
        return;
    }

    exibirAguarde("Conectando à Google Play...");

    try {
        // 2. Conecta ao Serviço do Google Play (usando o link oficial do Google)
        const service = await window.getDigitalGoodsService('https://play.google.com/billing');
        
        const comprasPendentes = await service.listPurchases();
        for (const p of comprasPendentes) {
            await service.consume(p.purchaseToken);
            console.log("Limpando compra pendente encontrada...");
        }

        // 3. Monta o pedido de pagamento
        const paymentMethods = [{
            supportedMethods: 'https://play.google.com/billing',
            data: { sku: skuId }
        }];

        const details = {
            total: { label: 'Total', amount: { currency: 'BRL', value: '0.00' } } // O valor real o Google pega pelo SKU
        };

        const request = new PaymentRequest(paymentMethods, details);
        
        // 4. ABRE O POP-UP NATIVO DO GOOGLE PLAY (Onde o cliente coloca a senha/digital)
        const paymentResponse = await request.show();
        
        // 5. O Google gerou um Token de sucesso!
        const { purchaseToken } = paymentResponse.details;

        if (purchaseToken) {
            exibirAguarde("Validando compra...");

            // 6. Envia o Token para o seu BACKEND (Render) validar
            const response = await fetch('https://navalhabackend.onrender.com/api/confirmar-compra-real', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uid: auth.currentUser.uid,
                    skuId: skuId,
                    purchaseToken: purchaseToken
                })
            });

            const data = await response.json();

            if (data.success) {
                // 1. CONSUMIR A COMPRA (O "Pulo do Gato")
                // Isso avisa ao Google que o item foi usado e pode ser comprado novamente.
                try {
                    await service.consume(purchaseToken);
                    console.log("Produto consumido com sucesso no Google Play.");
                } catch (consumeError) {
                    console.error("Erro ao consumir produto:", consumeError);
                    // Opcional: mesmo se falhar o consumo agora, você já entregou os diamantes.
                }

                // 2. Finaliza a transação na interface do Google (Mantido)
                await paymentResponse.complete('success');
                
                // 3. Feedback visual (Mantido)
                tocarSom('sucesso');
                if (typeof confetti === 'function') confetti({ particleCount: 200 });
                exibirPopup("💎 SUCESSO!", "Diamantes adicionados!", 'sucesso');
                fecharModalCompraMoedas();
                
            } else {
                await paymentResponse.complete('fail');
                throw new Error("Erro na validação do servidor.");
            }
        }

    } catch (e) {
        fecharAguarde(null, true);
        console.error("Erro na compra:", e);
        // Se o usuário clicar em "Cancelar", cai aqui
    }
}

function monitorarHorariosRealTime(uidProfissional, containerId, modoVisualizacao) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '<div class="spinner" style="margin:10px auto; width:20px; height:20px;"></div>';

    // 1. Ouvinte dos Agendamentos do Profissional (Ocupados)
    // Escuta status que ocupam vaga: pendente, confirmado, imediato, conclusão pendente
    const queryAgendamentos = db.collection('agendamentos')
        .where('barbeiroUid', '==', uidProfissional)
        .where('status', 'in', ['pendente', 'confirmado', 'imediato', 'conclusão pendente']);

    // 2. Ouvinte do Perfil do Profissional (Disponíveis)
    const docRefProfissional = db.collection('usuarios').doc(uidProfissional);

    // Precisamos combinar os dois dados. Vamos aninhar os listeners.
    // Primeiro ouvimos o PERFIL (Configuração da Agenda)
    const unsubPerfil = docRefProfissional.onSnapshot(userSnap => {
        if (!userSnap.exists) return;
        const u = userSnap.data();

        // Agora ouvimos os AGENDAMENTOS (Ocupação)
        const unsubAgendamentos = queryAgendamentos.onSnapshot(agendSnap => {
            
            // Mapeia os horários ocupados
            const ocupados = {};
            agendSnap.forEach(doc => {
                const ag = doc.data();
                if (ag.horario) {
                    ocupados[ag.horario] = { 
                        id: doc.id, 
                        clienteNome: ag.clienteNome,
                        status: ag.status,
                        // Guardamos dados extras para o click na equipe
                        ...ag 
                    };
                }
            });

            // Gera a lista de horários configurados pelo profissional
            let listaHorarios = [];
            if (u.usaAgendaManual && u.agenda) {
                listaHorarios = Object.keys(u.agenda).filter(h => u.agenda[h] === true).sort();
            } else {
                // Se não usa manual, gera padrão (exemplo)
                // Se preferir, pode mostrar "Agenda Fechada" aqui se usaAgendaManual for false
            }

            // --- RENDERIZAÇÃO ---
            let html = '';

            if (!u.usaAgendaManual) {
                html = '<p style="font-size:12px; color:#555; text-align:center;">Agenda programada fechada.</p>';
                // Se tiver vaga imediata, mostra só ela (lógica específica do modal)
            } else if (listaHorarios.length === 0) {
                html = '<p style="font-size:12px; color:#555; text-align:center;">Nenhum horário configurado.</p>';
            } else {
                // Modo Grid
                if (modoVisualizacao === 'equipe') {
                    html = '<div class="grid-horarios-mini">'; // Grid 2 colunas da equipe
                }

                listaHorarios.forEach(hora => {
                    const dadosOcupado = ocupados[hora];

                    // === MODO CLIENTE (ABRIR PERFIL) ===
                    if (modoVisualizacao === 'cliente') {
                        // Se estiver ocupado, NÃO MOSTRA (Some da lista)
                        if (!dadosOcupado) {
                            // Está livre
                            html += `<div class="selectable-item" onclick='selecionarHorario(this, "${hora}")'>📅 ${hora}</div>`;
                        }
                        // Se quiser mostrar riscado em vez de sumir, use else { ... class="bloqueado" ... }
                    }

                    // === MODO EQUIPE (GESTÃO) ===
                    else if (modoVisualizacao === 'equipe') {
                        if (dadosOcupado) {
                            // OCUPADO -> VERMELHO
                            // Prepara dados para abrir detalhes ao clicar
                            const dadosJson = JSON.stringify({
                                id: dadosOcupado.id,
                                clienteUid: dadosOcupado.clienteUid,
                                clienteNome: dadosOcupado.clienteNome,
                                barbeiroNome: u.nome,
                                servico: dadosOcupado.servico,
                                valor: dadosOcupado.valor,
                                status: dadosOcupado.status,
                                telefone: dadosOcupado.clienteTelefone,
                                horario: hora
                            }).replace(/"/g, '&quot;');

                            html += `<div class="slot-time slot-ocupado" onclick='abrirDetalhesDoAgendamento(${dadosJson})'>${hora}</div>`;
                        } else {
                            // LIVRE -> VERDE
                            html += `<div class="slot-time slot-livre" onclick="prepararAgendamentoManual('${uidProfissional}', '${hora}')">${hora}</div>`;
                        }
                    }
                });

                if (modoVisualizacao === 'equipe') html += '</div>';
            }

            // Vaga Imediata (Extra)
            if (modoVisualizacao === 'cliente' && u.vagaImediata) {
                // Adiciona no topo
                html = `<div class="selectable-item status-imediato" onclick='selecionarHorario(this, "imediato")' style="margin-bottom:10px; border-color:#2ecc71;">⚡ Vaga Imediata Disponível</div>` + html;
            }

            container.innerHTML = html;

        });

        // Guarda o unsubscribe dos agendamentos DENTRO do objeto de controle
        // Isso é um pouco complexo pois temos 2 listeners aninhados.
        // Vamos guardar uma função que cancela ambos.
        const unsubscribeTotal = () => {
            unsubPerfil();
            unsubAgendamentos();
        };

        if (modoVisualizacao === 'cliente') {
            unsubscribeHorariosPerfil = unsubscribeTotal;
        } else {
            listenersEquipe[uidProfissional] = unsubscribeTotal;
        }
    });
}

function abrirModalSolicitacoes() {
    abrirModal('modalSolicitacoes');
    const lista = document.getElementById("listaSolicitacoes");
    
    // Feedback inicial
    lista.innerHTML = "<div style='text-align:center; padding:20px; color:#d4af37;'>⏳ Carregando painel administrativo...</div>";

    // 1. PRIMEIRO: Busca as Transações Financeiras (São prioridade)
    db.collection("transacoes")
        .where("status", "==", "pendente")
        .orderBy("data", "desc")
        .onSnapshot(snapTransacoes => {

            // 2. SEGUNDO: Busca as Solicitações Gerais (Emprego, Convites, etc)
            db.collection("solicitacoes")
                .where("status", "==", "pendente")
                .orderBy("ts", "desc")
                .onSnapshot(snapSolicitacoes => {

                    let htmlFinal = "";

                    // --- BLOCO A: FINANCEIRO (Depósitos e Saques) ---
                    if (!snapTransacoes.empty) {
                        htmlFinal += `<h4 style="color:#d4af37; border-bottom:1px solid #333; padding:10px 0; margin-bottom:10px;">💸 Financeiro Pendente</h4>`;
                        
                        snapTransacoes.forEach(doc => {
                            const t = doc.data();
                            const isDep = t.tipo === 'deposito';
                            
                            // Configuração visual
                            const cor = isDep ? '#2ecc71' : '#e74c3c'; // Verde ou Vermelho
                            const icone = isDep ? '📥' : '📤';
                            const titulo = isDep ? 'DEPÓSITO' : 'SAQUE';
                            
                            // Detalhes extras (Pix para saque)
                            let extras = "";
                            if(t.tipo === 'saque' && t.chavePix) {
                                extras = `<div style="background:#000; padding:5px; border-radius:4px; margin-top:5px; font-size:11px; color:#ccc;">🔑 PIX: ${t.chavePix}</div>`;
                            }

                            htmlFinal += `
                            <div class="card" style="background:#151515; border-left: 4px solid ${cor}; padding:12px; margin-bottom:12px; border-radius:4px;">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                    <div>
                                        <strong style="color:${cor}; font-size:14px;">${icone} ${titulo}</strong>
                                        <div style="color:#fff; font-size:16px; font-weight:bold; margin:4px 0;">R$ ${parseFloat(t.valor).toFixed(2)}</div>
                                        <div style="font-size:12px; color:#aaa;">Usuário: ${t.usuarioNome || 'Desconhecido'}</div>
                                    </div>
                                    <div style="text-align:right; font-size:10px; color:#555;">
                                        ${new Date(t.data.toDate()).toLocaleDateString('pt-BR')}
                                    </div>
                                </div>
                                
                                ${extras}

                                <div style="display:flex; gap:10px; margin-top:12px;">
                                    <button onclick="aprovarTransacao('${doc.id}', '${t.uid}', '${t.tipo}', ${t.valor})" 
                                            style="flex:1; background:#27ae60; color:white; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;">
                                        ✅ Aprovar
                                    </button>
                                    
                                    <button onclick="recusarTransacao('${doc.id}')" 
                                            style="flex:1; background:#c0392b; color:white; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;">
                                        ❌ Recusar
                                    </button>
                                </div>
                            </div>`;
                        });
                    }

                    // --- BLOCO B: SOLICITAÇÕES GERAIS ---
                    if (!snapSolicitacoes.empty) {
                        htmlFinal += `<h4 style="color:#aaa; border-bottom:1px solid #333; padding:10px 0; margin:20px 0 10px 0;">📋 Solicitações Gerais</h4>`;
                        
                        snapSolicitacoes.forEach(doc => {
                            const s = doc.data();
                            
                            // Se for pedido de secretária (Lógica especial)
                            if (s.subtipo === "secretaria_pede_emprego") {
                                htmlFinal += `
                                <div class="card" style="background:#1a1a1a; border-left: 4px solid #9b59b6; padding:10px; margin-bottom:10px;">
                                    <div style="margin-bottom:10px;">
                                        <strong style="color:#9b59b6;">👩‍💼 VAGA: SECRETÁRIA</strong><br>
                                        <span style="color:#fff;">${s.remetenteNome}</span>
                                    </div>
                                    <button onclick="abrirModalAceitarSecretaria('${doc.id}', '${s.remetenteUid}', '${s.remetenteNome}', \`${s.sobreMim || ''}\`, '${s.remetenteFoto||''}')" style="width:100%; padding:8px; background:#8e44ad; color:white; border:none; border-radius:5px; cursor:pointer;">
                                        Ver Perfil & Contratar
                                    </button>
                                    <button onclick="adminDeletarSolicitacao('${doc.id}')" style="width:100%; margin-top:5px; padding:5px; background:none; border:1px solid #444; color:#777; border-radius:5px; cursor:pointer;">Recusar</button>
                                </div>`;
                            } 
                            // Solicitações Comuns
                            else {
                                htmlFinal += `
                                <div class="card" style="position: relative; background:#222; padding:10px; margin-bottom:10px;">
                                    <div onclick="verDetalhesSolicitacao('${doc.id}')">
                                        <strong style="color:#fff">${s.tipo ? s.tipo.toUpperCase() : 'GERAL'}</strong><br>
                                        <span style="font-size:13px; color:#ccc">De: ${s.usuarioNome || s.remetenteNome}</span>
                                        ${s.valor ? `<p style="color:#aaa; font-size:12px;">Valor: R$ ${s.valor.toFixed(2)}</p>` : ''}
                                        <p style="color: #ff9800; font-size:10px; margin-top:5px;">STATUS: PENDENTE</p>
                                    </div>
                                    <button onclick="adminDeletarSolicitacao('${doc.id}')" style="position: absolute; top: 10px; right: 10px; background: #c0392b; width: 30px; height: 30px; border:none; border-radius: 50%; color:white; cursor:pointer;">🗑️</button>
                                </div>`;
                            }
                        });
                    }

                    // Se não tiver nada em lugar nenhum
                    if (htmlFinal === "") {
                        lista.innerHTML = `
                            <div style="text-align:center; padding:40px 20px;">
                                <div style="font-size:40px; margin-bottom:10px;">✅</div>
                                <p style="color:#777;">Tudo limpo! Nenhuma pendência.</p>
                            </div>`;
                    } else {
                        lista.innerHTML = htmlFinal;
                    }

                }); // Fim snapSolicitacoes
        }); // Fim snapTransacoes
}


// =================================================================
// FUNÇÕES QUE FAZEM O DINHEIRO CAIR NA CONTA (NECESSÁRIAS)
// =================================================================

window.aprovarTransacao = async function(docId, uid, tipo, valor) {
    if(!confirm(`Confirma a aprovação deste ${tipo.toUpperCase()} de R$ ${valor}?`)) return;

    exibirAguarde("Processando saldo...");

    try {
        const userRef = db.collection("usuarios").doc(uid);
        const transacaoRef = db.collection("transacoes").doc(docId);

        // Executa tudo junto: Se falhar um, cancela tudo (Segurança Financeira)
        await db.runTransaction(async (transaction) => {
            // 1. Pega os dados atuais do usuário
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) throw "Usuário não encontrado!";

            const dadosUser = userDoc.data();
            const saldoAtual = dadosUser.saldoReal || 0;
            let novoSaldo = saldoAtual;

            // 2. Calcula o novo saldo
            if (tipo === 'deposito') {
                novoSaldo = saldoAtual + parseFloat(valor);
            } else if (tipo === 'saque') {
                // No saque, supomos que já verificamos saldo na solicitação, 
                // mas aqui confirmamos a retirada do banco de dados.
                novoSaldo = saldoAtual - parseFloat(valor);
            }

            // 3. Atualiza o Usuário
            transaction.update(userRef, { saldoReal: novoSaldo });

            // 4. Atualiza a Transação para APROVADO
            transaction.update(transacaoRef, { 
                status: "aprovado",
                dataAprovacao: firebase.firestore.FieldValue.serverTimestamp(),
                saldoAposTransacao: novoSaldo // Útil para auditoria
            });
        });

        fecharTodosOsModais(); // Fecha o aguarde
        alert("✅ Sucesso! O saldo do usuário foi atualizado.");

    } catch (error) {
        console.error(error);
        fecharTodosOsModais();
        alert("❌ Erro ao aprovar: " + error.message);
    }
};

window.recusarTransacao = async function(docId) {
    const motivo = prompt("Motivo da recusa (opcional):");
    if(motivo === null) return; // Cancelou

    try {
        await db.collection("transacoes").doc(docId).update({ 
            status: "rejeitado",
            motivoRejeicao: motivo || "Sem motivo",
            dataRejeicao: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Solicitação recusada.");
    } catch (e) {
        alert("Erro: " + e.message);
    }
};

// Função auxiliar simples para deletar solicitações gerais (botão lixeira)
window.adminDeletarSolicitacao = async function(docId) {
    if(!confirm("Excluir esta solicitação permanentemente?")) return;
    try {
        await db.collection("solicitacoes").doc(docId).delete();
    } catch(e) { console.error(e); }
};

function abrirModalAceitarSecretaria(solicitacaoId, uidCandidata, nomeCandidata, sobreMim, fotoCandidata) {
    const modalId = 'modalAceitarContratoSecretaria';
    let modal = document.getElementById(modalId);

    // Cria o modal se não existir
    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.onclick = (e) => fecharModal(e);
        document.body.appendChild(modal);
    }

    const textoSobre = sobreMim ? `"${sobreMim}"` : "Sem descrição.";

    modal.innerHTML = `
        <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
            <h3 style="color:#9b59b6; margin-top:0;">📋 Contratar Secretária</h3>
            
            <img src="${fotoCandidata}" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid #9b59b6; margin-bottom:10px;">
            
            <h4 style="margin:0; color:#fff;">${nomeCandidata}</h4>
            
            <div style="background:#222; padding:10px; border-radius:8px; margin:15px 0; text-align:left; font-style:italic; font-size:13px; color:#ccc; max-height:100px; overflow-y:auto;">
                ${textoSobre}
            </div>

            <hr style="border-color:#333; margin:15px 0;">

            <label style="display:block; text-align:left; font-size:12px; color:#aaa;">💰 Salário Mensal (R$):</label>
            <input type="number" id="inputSalarioContrato" placeholder="Ex: 1500" style="font-size:16px; font-weight:bold; color:#2ecc71;">
            
            <p style="font-size:10px; color:#f1c40f; margin-top:-5px; margin-bottom:15px; text-align:left;">
                ⚠️ pagamentos presenciais!
            </p>

            <label style="display:block; text-align:left; font-size:12px; color:#aaa;">🗓️ Dia do Pagamento (1-31):</label>
            <input type="number" id="inputDiaPagamentoContrato" placeholder="Ex: 5">

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="fecharModalAtual()" style="background:#555; flex:1;">Cancelar</button>
                <button onclick="confirmarContratacaoSecretaria('${solicitacaoId}', '${uidCandidata}', '${nomeCandidata}')" style="background:#2ecc71; flex:1; font-weight:bold;">✅ Contratar</button>
            </div>
        </div>
    `;

    abrirModal(modalId);
}

// Função para aprovar transação financeira
async function aprovarTransacao(transacaoId, usuarioUid, tipo, valor, debitoReal = 0, debitoBonus = 0) {
    if (!confirm(`Confirma a aprovação desta transação?\n\nTipo: ${tipo === 'deposito' ? 'Depósito' : 'Saque'}\nValor: R$ ${valor.toFixed(2)}`)) {
        return;
    }
    
    exibirAguarde("Processando aprovação...");
    
    try {
        const usuarioRef = db.collection("usuarios").doc(usuarioUid);
        const transacaoRef = db.collection("transacoes").doc(transacaoId);
        
        // Usa transação para garantir consistência
        await db.runTransaction(async (t) => {
            const usuarioDoc = await t.get(usuarioRef);
            if (!usuarioDoc.exists) {
                throw new Error("Usuário não encontrado");
            }
            
            const usuarioData = usuarioDoc.data();
            const updates = {};
            
            if (tipo === "deposito") {
                // Depósito: incrementa saldoReal
                if (usuarioData.saldoReal !== undefined) {
                    updates.saldoReal = firebase.firestore.FieldValue.increment(valor);
                } else {
                    // Fallback: usa saldo antigo se saldoReal não existir
                    updates.saldo = firebase.firestore.FieldValue.increment(valor);
                }
            } else if (tipo === "saque") {
                // Saque: decrementa saldoReal e saldoBonus
                if (debitoReal > 0) {
                    if (usuarioData.saldoReal !== undefined) {
                        updates.saldoReal = firebase.firestore.FieldValue.increment(-debitoReal);
                    } else {
                        updates.saldo = firebase.firestore.FieldValue.increment(-debitoReal);
                    }
                }
                
                if (debitoBonus > 0) {
                    updates.saldoBonus = firebase.firestore.FieldValue.increment(-debitoBonus);
                }
            }
            
            // Atualiza o saldo do usuário
            if (Object.keys(updates).length > 0) {
                t.update(usuarioRef, updates);
            }
            
            // Marca a transação como aprovada
            t.update(transacaoRef, {
                status: "aprovado",
                dataAprovacao: firebase.firestore.FieldValue.serverTimestamp(),
                aprovadoPor: auth.currentUser.uid
            });
        });
        
        fecharTodosOsModais();
        exibirPopup("✅ Transação aprovada com sucesso! O saldo foi atualizado.", "Sucesso", "sucesso");
        
        // Recarrega a lista de solicitações
        setTimeout(() => {
            abrirModalSolicitacoes();
        }, 500);
        
    } catch (error) {
        console.error("Erro ao aprovar transação:", error);
        fecharTodosOsModais();
        exibirPopup("Erro ao aprovar transação: " + error.message);
    }
}

// Função para recusar transação financeira
async function recusarTransacao(transacaoId) {
    if (!confirm("Confirma a recusa desta transação?")) {
        return;
    }
    
    exibirAguarde("Processando recusa...");
    
    try {
        await db.collection("transacoes").doc(transacaoId).update({
            status: "recusado",
            dataRecusa: firebase.firestore.FieldValue.serverTimestamp(),
            recusadoPor: auth.currentUser.uid
        });
        
        fecharTodosOsModais();
        exibirPopup("❌ Transação recusada.", "Info", "info");
        
        // Recarrega a lista de solicitações
        setTimeout(() => {
            abrirModalSolicitacoes();
        }, 500);
        
    } catch (error) {
        console.error("Erro ao recusar transação:", error);
        fecharTodosOsModais();
        exibirPopup("Erro ao recusar transação: " + error.message);
    }
}

async function confirmarContratacaoSecretaria(solicitacaoId, uidCandidata, nomeCandidata) {
    const salario = document.getElementById('inputSalarioContrato').value;
    const diaPagamento = document.getElementById('inputDiaPagamentoContrato').value;

    if (!salario || isNaN(salario)) return alert("Defina um salário válido.");
    if (!diaPagamento || isNaN(diaPagamento) || diaPagamento < 1 || diaPagamento > 31) return alert("Defina um dia de pagamento válido.");

    exibirAguarde("Contratando...");

    try {
        const batch = db.batch();
        
        // 1. Atualiza Perfil da Secretária (Muda tipo e vincula)
        const userRef = db.collection('usuarios').doc(uidCandidata);
        batch.update(userRef, {
            tipo: 'secretaria',
            pertenceABarbearia: {
                uid: auth.currentUser.uid,
                nome: perfil.nomeBarbearia || perfil.nome
            },
            salario: parseFloat(salario),
            diaPagamento: parseInt(diaPagamento),
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp() // Reinicia o app dela
        });

        // 2. Adiciona à Equipe do Dono
        const donoRef = db.collection('usuarios').doc(auth.currentUser.uid);
        const donoDoc = await donoRef.get();
        let equipeAtual = donoDoc.data().equipe || [];
        
        // Remove duplicatas
        equipeAtual = equipeAtual.filter(m => (typeof m === 'string' ? m !== uidCandidata : m.uid !== uidCandidata));
        
        // Adiciona com os dados financeiros
        equipeAtual.push({
            uid: uidCandidata,
            nome: nomeCandidata,
            tipo: 'secretaria',
            salario: parseFloat(salario),
            diaPagamento: parseInt(diaPagamento)
        });
        
        batch.update(donoRef, { equipe: equipeAtual });
        
        // 3. Marca solicitação como aprovada
        const solRef = db.collection("solicitacoes").doc(solicitacaoId);
        batch.update(solRef, { status: "aprovado" });
        
        await batch.commit();
        
        fecharTodosOsModais();
        exibirPopup("Sucesso!", `${nomeCandidata} agora faz parte da sua equipe como Secretária.`);
        
        // Notifica ela
        notifyUser(uidCandidata, "🎉 Contratação Aprovada!", `Bem-vinda à equipe! Seu painel foi atualizado.`);

        // Atualiza a lista da equipe se estiver aberta
        if (document.getElementById('modalGerenciarEquipe').classList.contains('show')) {
            carregarEquipeComPagamentos();
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao contratar: " + e.message);
    }
}

async function adminDeletarSolicitacao(id) {
    if(confirm("Tem certeza que deseja EXCLUIR esta solicitação? Ela sumirá da lista.")) {
        try {
            await db.collection("solicitacoes").doc(id).delete();
            exibirPopup("Solicitação excluída.");
        } catch (e) {
            exibirPopup("Erro ao excluir: " + e.message);
        }
    }
}

async function configurarPainelSecretaria() {
    const nomeBarb = document.getElementById('nomeBarbeariaSecretaria');
    
    // Verifica se já tem vínculo
    if (perfil.pertenceABarbearia && perfil.pertenceABarbearia.uid) {
        nomeBarb.textContent = perfil.pertenceABarbearia.nome || "Barbearia Vinculada";
        
        // Se já tem vínculo, o botão "Equipe" abre a gestão normal
        // Se a secretária clicar em Equipe, vai para a view 'profissionaisView'
    } else {
        // SEM VÍNCULO: Força a ida para a tela de Equipe, mas carrega a lista de donos
        switchView('profissionais');
        carregarListaProprietariosParaSecretaria();
    }
}

async function carregarListaProprietariosParaSecretaria() {
    const container = document.getElementById('containerEquipeVisual');
    
    // Header bonito e explicativo
    const titulo = document.querySelector('#profissionaisView h2');
    if(titulo) titulo.innerHTML = "🏢 Encontrar Emprego<br><span style='font-size:12px; opacity:0.7; font-weight:normal;'>Envie solicitação para um proprietário</span>";

    container.innerHTML = '<div class="spinner" style="margin: 50px auto;"></div>';

    try {
        // Busca proprietários no banco
        const snap = await db.collection('usuarios')
            .where('isProprietario', '==', true)
            .limit(50)
            .get();

        // Limpa e aplica a CLASSE DE GRID RESPONSIVO
        container.innerHTML = '';
        container.className = 'grid-vagas-secretaria'; // <--- AQUI APLICA O CSS DO PASSO 1
        
        if (snap.empty) {
            container.innerHTML = '<p style="text-align:center; opacity:0.6; grid-column: 1/-1;">Nenhum proprietário encontrado no momento.</p>';
            return;
        }

        let html = "";

        snap.forEach(doc => {
            const dono = doc.data();
            // Evita mostrar a si mesma se ela marcou sem querer que é dona
            if (doc.id === auth.currentUser.uid) return;

            const foto = dono.fotoPerfil || dono.logo_url || '/icone.png';
            const nomeNegocio = dono.nomeBarbearia || "Estabelecimento";
            const nomeDono = dono.nome ? dono.nome.split(' ')[0] : "Proprietário"; // Pega só o primeiro nome
            const localizacao = (dono.cidade && dono.estado) ? `${dono.cidade} - ${dono.estado}` : "Localização não definida";

            // HTML do Card (Usando as novas classes CSS)
            html += `
            <div class="card-dono-vaga">
                <div class="dono-vaga-header">
                    <img src="${foto}" class="dono-vaga-foto">
                    <div class="dono-vaga-info">
                        <div class="dono-vaga-titulo">${nomeNegocio}</div>
                        <div class="dono-vaga-sub">👤 ${nomeDono}</div>
                        <div class="dono-vaga-sub">📍 ${localizacao}</div>
                    </div>
                </div>
                
                <button class="btn-solicitar-vaga" onclick="enviarSolicitacaoSecretaria('${doc.id}', '${dono.nome}')">
                    <span>🤝</span> Solicitar Vínculo
                </button>
            </div>`;
        });

        container.innerHTML = html;

    } catch (e) {
        container.innerHTML = '<p style="text-align:center; color:#e74c3c;">Erro ao carregar lista.</p>';
        console.error(e);
    }
}

// Variáveis temporárias para guardar quem é o alvo
let tempDonoUid = null;
let tempDonoNome = null;

function enviarSolicitacaoSecretaria(donoUid, donoNome) {
    tempDonoUid = donoUid;
    tempDonoNome = donoNome;

    // Cria o modal dinamicamente se não existir
    const modalId = 'modalSolicitarVinculoSecretaria';
    let modal = document.getElementById(modalId);

    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.onclick = (e) => fecharModal(e); // Fecha ao clicar fora
        
        modal.innerHTML = `
            <div class="modal-content" onclick="event.stopPropagation()">
                <h3 style="color:var(--cor-destaque)">🤝 Solicitar Vínculo</h3>
                <p>Envie uma mensagem para <b>${donoNome}</b>.</p>
                
                <label style="text-align:left; display:block; font-size:12px; color:#aaa; margin-top:10px;">Fale sobre você (Opcional):</label>
                <textarea id="inputSobreMimSecretaria" rows="4" placeholder="Ex: Tenho experiência em atendimento e gestão de agenda..." style="width:100%; background:#222; color:#fff; border:1px solid #444; border-radius:8px; padding:10px;"></textarea>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="fecharModalAtual()" style="background:#555; flex:1;">Cancelar</button>
                    <button onclick="confirmarEnvioSolicitacaoSecretaria()" style="background: linear-gradient(45deg, #00c6ff, #0072ff); flex:1; font-weight:bold;">🚀 Enviar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        // Atualiza o nome do dono se o modal já existia
        modal.querySelector('p b').textContent = donoNome;
        document.getElementById('inputSobreMimSecretaria').value = ''; // Limpa campo
    }

    abrirModal(modalId);
}

async function confirmarEnvioSolicitacaoSecretaria() {
    const sobreMim = document.getElementById('inputSobreMimSecretaria').value.trim();
    
    exibirAguarde("Enviando solicitação...");
    
    try {
        await db.collection("solicitacoes").add({
            tipo: "convite_equipe", 
            subtipo: "secretaria_pede_emprego", 
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nome,
            remetenteFoto: perfil.fotoPerfil || perfil.logo_url || '/icone.png', // Envia a foto junto
            sobreMim: sobreMim, // Salva o texto
            destinatarioUid: tempDonoUid,
            destinatarioNome: tempDonoNome,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        fecharTodosOsModais();
        exibirPopup("Solicitação Enviada!", "O proprietário receberá seu perfil e mensagem.");
        
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

async function verDetalhesSolicitacao(id) {
  const doc = await db.collection("solicitacoes").doc(id).get();
  if (!doc.exists) return exibirPopup("Erro", "Solicitação não encontrada."); // Usa popup
  const s = doc.data();
  if (!s || s.status !== 'pendente') return exibirPopup("Info", `Esta solicitação já foi ${s.status}.`); // Usa popup

  // --- NOVA LÓGICA ---
  if (s.tipo === 'alteracao_cidade') {
      abrirModalAdminCidade(id, s); // Abre o modal específico
      return; // Sai da função aqui para não mostrar o confirm genérico
  }
  // --- FIM DA NOVA LÓGICA ---

  if (s.tipo === 'recuperacao_senha') {
      const novaSenha = prompt(`RECUPERAÇÃO DE SENHA PARA: ${s.email}\n\nDigite uma nova senha temporária (mínimo 6 caracteres):`);
      if (novaSenha && novaSenha.length >= 6) {
          try {
              exibirAguarde("Buscando usuário e redefinindo senha...");
              // Busca o usuário pelo email na coleção 'usuarios' para obter o UID
              const userQuery = await db.collection('usuarios').where('email', '==', s.email).limit(1).get();
              if (userQuery.empty) {
                  throw new Error("Nenhum usuário encontrado com este e-mail no banco de dados.");
              }
              const userDoc = userQuery.docs[0];
              const targetUid = userDoc.id; // UID encontrado
              const telefoneUsuario = userDoc.data().telefone; // Pega o telefone do Firestore

              // Chama o backend para redefinir a senha via Firebase Auth
              const response = await fetch(`${BACKEND_API_URL}/admin/reset-user-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: targetUid, newPassword: novaSenha })
              });
              const data = await response.json();
              if (!response.ok) {
                  console.error("Backend error response:", data); // Log detalhado do erro do backend
                  throw new Error(data.message || `Erro ${response.status} do backend.`);
              }

              // Marca a solicitação como aprovada no Firestore
              await db.collection("solicitacoes").doc(id).update({ status: "aprovado" });

              fecharAguarde(null, true);
              exibirPopup("Sucesso", "Senha redefinida com sucesso!");

              // Abre o WhatsApp para enviar a nova senha para o usuário
              if (telefoneUsuario) {
                 const phoneNum = telefoneUsuario.startsWith('55') ? telefoneUsuario : `55${telefoneUsuario.replace(/\D/g, '')}`; // Garante 55 e limpa
                 const mensagem = encodeURIComponent(`Olá! Conforme sua solicitação, sua nova senha de acesso para o app King Agenda é:\n\n*${novaSenha}*\n\nRecomendamos que você a altere assim que fizer o login.`);
                 window.open(`https://wa.me/${phoneNum}?text=${mensagem}`, '_blank');
              } else {
                 exibirPopup("Aviso", "Não foi possível encontrar o telefone do usuário para enviar a senha via WhatsApp. Avise-o manualmente.");
              }

          } catch (error) {
              fecharAguarde(null, true);
              console.error("Erro detalhado ao processar recuperação:", error); // Log detalhado
              exibirPopup("Erro", "Erro ao processar recuperação: " + error.message);
          }
      } else if (novaSenha) { // Se digitou algo mas < 6 chars
          exibirPopup("Aviso", "A senha deve ter no mínimo 6 caracteres. A operação foi cancelada.");
      }
      // Se cancelou o prompt, não faz nada
  } else {
    // Lógica antiga para outros tipos de solicitação (saque, depósito, etc.)
    let detalhes = `Detalhes:\nTipo: ${s.tipo.toUpperCase()}\nUsuário: ${s.usuarioNome}\nValor: R$ ${s.valor ? s.valor.toFixed(2) : 'N/A'}\n`;

    if(s.tipo === 'saque') {
      detalhes += `Chave: ${s.chavePixTipo} - ${s.chavePix}\nAprovar? (Ação irreversível - faça APÓS a transferência PIX)`;
    } else if (s.tipo === 'deposito') {
      detalhes += `Nome Completo: ${s.dadosDeposito.nomeCompleto}\nCPF: ${s.dadosDeposito.cpf}\nTelefone: ${s.dadosDeposito.telefone}\n\nAprovar este depósito? (O valor será adicionado ao saldo do usuário)`;
    } else if (s.tipo === "liberacao_loja") {
        detalhes += `\nAprovar liberação da loja para ${s.usuarioNome}?`;
    }
     else {
      detalhes += `\nAprovar?`;
    }

    // Usa confirm por enquanto, pode ser substituído por popup customizado depois
    const confirmar = confirm(detalhes);
    if (confirmar) {
      if (s.tipo === "saque") aprovarSaque(id, s.usuarioUid, s.valor);
      else if (s.tipo === "deposito") aprovarDeposito(id, s.usuarioUid, s.valor);
      else if (s.tipo === "liberacao_loja") aprovarLiberacaoLoja(id, s.usuarioUid);
    } else if (confirm("Deseja recusar a solicitação?")) {
      recusarSolicitacao(id, s.usuarioUid, s.tipo);
    }
  }
}

function aprovarSaque(id, uid, valor) {
  // 1. Busca a solicitação para saber quanto descontar de cada saldo
  db.collection("solicitacoes").doc(id).get().then(snap => {
      if (!snap.exists) return exibirPopup("Erro", "Solicitação não encontrada.");
      
      const s = snap.data();
      
      // Se for solicitação nova, usa os valores calculados.
      // Se for antiga (sem os campos), assume que tudo sai do Saldo Real.
      const debitoReal = s.debitoRealCalculado !== undefined ? s.debitoRealCalculado : valor;
      const debitoBonus = s.debitoBonusCalculado || 0;

      db.runTransaction(async t => {
        const userRef = db.collection("usuarios").doc(uid);
        const userDoc = await t.get(userRef);
        
        if (!userDoc.exists) throw "Usuário não encontrado.";
        const userData = userDoc.data();

        // Verifica saldos atuais (com fallback para campo antigo 'saldo')
        const saldoRealAtual = (userData.saldoReal !== undefined) ? userData.saldoReal : (userData.saldo || 0);
        const saldoBonusAtual = userData.saldoBonus || 0;

        // Validação de segurança final
        if (saldoRealAtual < debitoReal) throw `Saldo Real insuficiente (Tem: ${saldoRealAtual}, Precisa: ${debitoReal})`;
        if (saldoBonusAtual < debitoBonus) throw `Saldo Bônus insuficiente (Tem: ${saldoBonusAtual}, Precisa: ${debitoBonus})`;

        const updates = {};

        // Desconta do Saldo Real
        if (userData.saldoReal !== undefined) {
            updates.saldoReal = firebase.firestore.FieldValue.increment(-debitoReal);
        } else {
            updates.saldo = firebase.firestore.FieldValue.increment(-debitoReal);
        }

        // Desconta do Saldo Bônus (se houver)
        if (debitoBonus > 0) {
            updates.saldoBonus = firebase.firestore.FieldValue.increment(-debitoBonus);
        }

        // Executa atualizações
        t.update(userRef, updates);
        t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });
        
        // (Opcional) Cria registro no extrato financeiro para histórico
        const extratoRef = db.collection('extrato_financeiro').doc();
        t.set(extratoRef, {
            donoUid: uid,
            usuarioUid: auth.currentUser.uid, // Admin que aprovou
            tipo: 'saque_aprovado',
            descricao: `Saque: R$${debitoReal.toFixed(2)} (Real) + R$${debitoBonus.toFixed(2)} (Bônus)`,
            valor: valor,
            dataEvento: firebase.firestore.Timestamp.now(),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

      }).then(() => {
        exibirPopup("Saque aprovado com sucesso!");
        
        // Notifica o usuário
        const msg = debitoBonus > 0 
            ? `Seu saque de R$ ${valor.toFixed(2)} (sendo R$ ${debitoBonus.toFixed(2)} de bônus) foi enviado.`
            : `Seu saque de R$ ${valor.toFixed(2)} foi enviado.`;
            
        notifyUser(uid, "💸 Saque Aprovado!", msg, { link: '#carteira' });
        
      }).catch(e => {
        console.error(e);
        exibirPopup("Erro ao aprovar: " + e);
      });
  });
}

function aprovarDeposito(id, uid, valor) {
  db.collection("solicitacoes").doc(id).get().then(snap => {
      if (!snap.exists) throw new Error("Solicitação sumiu.");
      const solicitacao = snap.data();
      const tipoSaldo = solicitacao.subtipo || 'servico'; 

      db.runTransaction(async t => {
        const userRef = db.collection("usuarios").doc(uid);
        const userDoc = await t.get(userRef);
        if (!userDoc.exists) throw new Error("Usuário não encontrado!");
        
        const userData = userDoc.data();
        
        const updates = {};
        if (tipoSaldo === 'digital') {
            updates.saldoDigital = firebase.firestore.FieldValue.increment(valor);
        } else {
            // --- MUDANÇA: Depósito em dinheiro vai para saldoReal ---
            // Se o campo saldoReal ainda não existe, cria ele pegando o 'saldo' antigo + valor novo
            // Mas para segurança do incremento, usamos o fieldvalue.
            // O sistema assumirá que se saldoReal não existe, começa do zero, mas
            // precisamos garantir a migração visual no modal.
            
            // Para simplificar a transação: Se saldoReal não existe no doc,
            // o ideal é tratar 'saldo' antigo como real.
            // Aqui vamos apenas incrementar 'saldoReal'. A visualização cuida do resto.
            // No entanto, para limpar o banco, podemos deletar 'saldo' e somar em 'saldoReal'
            // se fosse uma migração. Vamos apenas somar em saldoReal.
            
            updates.saldoReal = firebase.firestore.FieldValue.increment(valor);
            
            // Opcional: Se 'saldoReal' for undefined no banco, ele cria com o valor.
            // Se o usuário tinha 'saldo' antigo, ele não será perdido pois a função de leitura
            // (abrirModalCarteira) lê (saldoReal ?? saldo).
        }

        // Pontos por depósito
        const pontosPorDezReais = isVipAtivo(userData) ? 2 : 1;
        const pontosGanhos = Math.floor(valor / 10) * pontosPorDezReais;
        if (pontosGanhos > 0) {
            updates.pontosFidelidade = firebase.firestore.FieldValue.increment(pontosGanhos);
        }

        t.update(userRef, updates);
        t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });

      }).then(() => {
        exibirPopup("Depósito aprovado!");
        notifyUser(uid, "💰 Depósito Aprovado!", `R$ ${valor.toFixed(2)} creditados.`, { link: '#carteira' });
      }).catch(e => {
        exibirPopup("Erro: " + e.message);
      });
  });
}

function recusarSolicitacao(id, uid, tipo) {
  db.collection("solicitacoes").doc(id).update({ status: "recusado" })
    .then(() => {
      exibirPopup("Solicitação recusada.");
      notifyUser(uid, `❌ Solicitação Recusada`, `Sua solicitação de ${tipo} foi recusada.`);
    }).catch(e => exibirPopup("Erro: " + e.message));
}

// --- FUNÇÃO DE COMPARTILHAR STORY ---
function compartilharStoryAtual() {
    // currentStoryUserUid é uma variável global que já criamos na função abrirStory
    if (!currentStoryUserUid) return;

    const nomeProfissional = document.getElementById('storyUserName').textContent;
    
    // Cria o link direto para o perfil do profissional
    const shareUrl = window.location.origin + window.location.pathname + '?p=' + currentStoryUserUid;
    
    const textoCompartilhamento = `Confira os stories de ${nomeProfissional} no King Agenda! 📸`;

    if (navigator.share) {
        navigator.share({
            title: 'King Agenda Stories',
            text: textoCompartilhamento,
            url: shareUrl
        }).catch(console.error);
    } else {
        // Fallback para PC ou navegadores antigos
        copiarParaClipboard(shareUrl, "Link do Story");
    }
}

function mostrarToastSair() {
    let toast = document.getElementById("toastNotification");
    
    // Se não existir o elemento no HTML, cria dinamicamente
    if (!toast) {
        toast = document.createElement("div");
        toast.id = "toastNotification";
        toast.className = "toast-notification";
        toast.textContent = "Pressione voltar novamente para sair";
        document.body.appendChild(toast);
    }
    
    toast.className = "toast-notification show";
    
    // Esconde após 2 segundos
    setTimeout(function(){ 
        toast.className = toast.className.replace("show", ""); 
    }, 2000);
}

// Variável global temporária para saber quem estamos editando
let uidMembroEmEdicao = null;

// Função para abrir o modal e carregar as permissões atuais do banco
async function abrirGerenciarPermissoes(uid, nome) {
    uidMembroEmEdicao = uid;
    document.getElementById('nomeMembroPermissao').textContent = nome;
    
    // Reseta visualmente os checkboxes
    document.getElementById('checkPermissaoSOS').checked = false;
    document.getElementById('checkPermissaoPromo').checked = false;
    
    exibirAguarde("Carregando acessos...");
    
    try {
        const doc = await db.collection('usuarios').doc(uid).get();
        if (doc.exists) {
            const dados = doc.data();
            // Verifica se existe o objeto permissoes, senão assume false
            const perms = dados.permissoes || {};
            
            document.getElementById('checkPermissaoSOS').checked = perms.sos === true;
            document.getElementById('checkPermissaoPromo').checked = perms.promocoes === true;
        }
        
        fecharTodosOsModais(); // Fecha o aguarde
        abrirModal('modalPermissoesEquipe');
        
        // Configura o botão de salvar para chamar a função correta
        document.getElementById('btnSalvarPermissoes').onclick = salvarPermissoesNoBanco;
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível carregar as permissões.");
    }
}

// Função para salvar as permissões no Firestore
async function salvarPermissoesNoBanco() {
    if (!uidMembroEmEdicao) return;
    
    const podeSOS = document.getElementById('checkPermissaoSOS').checked;
    const podePromo = document.getElementById('checkPermissaoPromo').checked;
    
    exibirAguarde("Atualizando acessos...");
    
    try {
        await db.collection('usuarios').doc(uidMembroEmEdicao).update({
            permissoes: {
                sos: podeSOS,
                promocoes: podePromo
            },
            // Força reload no aparelho do barbeiro para aplicar as mudanças na hora
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        fecharTodosOsModais();
        exibirPopup("Sucesso", "Permissões atualizadas! O painel do profissional será atualizado.");
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar", e.message);
    }
}

// Variável global para guardar a lista de usuários e filtrar sem gastar leitura do banco
let adminUsersCache = []; 

function abrirModalUsuarios() {
  abrirModal('modalUsuarios');
  const painel = document.getElementById("usuariosPainel");
  
  // 1. Injeta o Campo de Busca e o Container da Lista
  painel.innerHTML = `
    <div style="position: sticky; top: 0; background: var(--cor-card); z-index: 10; padding-bottom: 10px;">
        <input type="text" id="inputBuscaAdmin" placeholder="🔎 Buscar por nome, email ou telefone..." 
               oninput="filtrarUsuariosAdmin(this.value)" 
               style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--cor-destaque);">
    </div>
    <div id="listaUsuariosRender" style="padding-bottom: 20px;">
        <p style="text-align:center;">⏳ Carregando usuários...</p>
    </div>
  `;

  // 2. Busca os dados
  db.collection("usuarios").onSnapshot(snap => {
    adminUsersCache = []; // Limpa cache
    
    if (snap.empty) {
        document.getElementById("listaUsuariosRender").innerHTML = "<p>Nenhum usuário cadastrado.</p>";
        return;
    }

    snap.forEach(doc => {
      const u = doc.data();
      adminUsersCache.push({ id: doc.id, ...u });
    });

    // 3. Renderiza a lista completa inicialmente
    renderizarListaUsuariosAdmin(adminUsersCache);
  });
}

// Função Auxiliar: Renderiza o HTML (CORRIGIDA)
function renderizarListaUsuariosAdmin(lista) {
    const container = document.getElementById("listaUsuariosRender");
    if (!container) return;

    if (!lista || lista.length === 0) {
        container.innerHTML = "<p style='text-align:center; opacity:0.7;'>Nenhum usuário encontrado.</p>";
        return;
    }

    let html = "";
    lista.forEach(u => {
        // --- BLINDAGEM CONTRA ERROS (FIX) ---
        // Se não tiver tipo, assume 'desconhecido' para não travar o .toUpperCase()
        const tipoSafe = u.tipo ? u.tipo : 'desconhecido';
        const nomeSafe = u.nome || 'Sem Nome';
        const emailSafe = u.email || 'Sem E-mail';
        const telefoneSafe = u.telefone || 'N/A';
        const idSafe = u.id || u.uid; // Garante pegar o ID mesmo se vier como uid

        // Define cor baseada no tipo
        let corTipo = "#aaa";
        if (tipoSafe === 'admin') corTipo = "#e74c3c";
        if (tipoSafe === 'barbeiro' || tipoSafe === 'manicure_pedicure') corTipo = "var(--cor-destaque)";

        html += `
        <div class="card" style="margin-bottom: 10px; border-left: 3px solid ${corTipo};">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold;">${nomeSafe}</span>
                <span style="font-size:10px; background:#333; padding:2px 6px; border-radius:4px; color:${corTipo}">
                    ${tipoSafe.toUpperCase()}
                </span>
            </div>
            <p style="font-size:12px; margin: 5px 0; color:#ccc;">📧 ${emailSafe}</p>
            <p style="font-size:12px; margin: 0 0 10px 0; color:#ccc;">📞 ${telefoneSafe}</p>
            <button onclick="abrirModalGerenciarUsuario('${idSafe}')" style="width:100%; padding:8px; font-size:13px; cursor:pointer;">⚙️ Gerenciar</button>
        </div>`;
    });
    
    container.innerHTML = html;
}

// Função Auxiliar: Filtra em tempo real
function filtrarUsuariosAdmin(termo) {
    const termoLimpo = termo.toLowerCase().trim();
    
    if (!termoLimpo) {
        renderizarListaUsuariosAdmin(adminUsersCache); // Mostra tudo se limpar
        return;
    }

    const filtrados = adminUsersCache.filter(u => {
        const nome = (u.nome || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        const telefone = (u.telefone || "").toLowerCase();
        
        return nome.includes(termoLimpo) || email.includes(termoLimpo) || telefone.includes(termoLimpo);
    });

    renderizarListaUsuariosAdmin(filtrados);
}

function abrirDenuncias() {
  abrirModal('modalDenunciasAdmin');
  const lista = document.getElementById("listaDenuncias");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("denuncias").where("status", "==", "aberta").orderBy("ts", "desc")
    .onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma denúncia aberta.</p>" : "";
      snap.forEach(doc => {
        const d = doc.data();
        lista.innerHTML += `<div class="card" onclick="verDetalhesDenuncia('${doc.id}')">Denúncia de ${d.usuarioNome}<p>${d.texto.substring(0, 50)}...</p></div>`;
      });
    });
}

async function verDetalhesDenuncia(id) {
  const doc = await db.collection("denuncias").doc(id).get();
  const d = doc.data();
  if (!d) return;
  if (confirm(`Denúncia de ${d.usuarioNome}:\n${d.texto}\n\nDeseja fechar esta denúncia?`)) {
    fecharDenuncia(id);
  }
}

function fecharDenuncia(id) {
  db.collection("denuncias").doc(id).update({ status: "fechada" }).then(() => exibirPopup("Denúncia fechada!"));
}

async function renderizarGraficoFinanceiro() {
    const ctx = document.getElementById('chartFinanceiro').getContext('2d');
    
    // PROTEÇÃO: Só roda se tiver usuário logado e for admin
    if (!auth.currentUser || (perfil && perfil.tipo !== 'admin')) return;

    try {
        // 1. Busca os dados reais do seu servidor
        const response = await fetch('https://navalhabackend.onrender.com/admin/stats-financeiro', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid })
        });
        const result = await response.json();

        if (!result.success) throw new Error("Falha ao carregar dados.");

        // 2. Configura o Gradiente Verde
        const gradientGreen = ctx.createLinearGradient(0, 0, 0, 400);
        gradientGreen.addColorStop(0, 'rgba(0, 255, 127, 0.6)');
        gradientGreen.addColorStop(1, 'rgba(0, 255, 127, 0)');

        // 3. Cria o gráfico com os dados do banco
        if (window.adminChartInstance) window.adminChartInstance.destroy(); // Limpa anterior
        
        window.adminChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: result.labels, // Meses vindos do servidor (ex: 2025-11, 2025-12)
                datasets: [{
                    label: 'Total em R$',
                    data: result.valores, // Valores totais de cada mês
                    backgroundColor: gradientGreen,
                    borderColor: '#00ff7f',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `R$ ${context.raw.toFixed(2).replace('.', ',')}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { 
                            color: '#00ff7f',
                            callback: (value) => `R$ ${value}`
                        }
                    },
                    x: { ticks: { color: '#aaa' } }
                }
            }
        });
    } catch (e) {
        console.error("Erro ao renderizar gráfico financeiro:", e);
    }
}

async function abrirModalGerenciarUsuario(uid) {
    exibirAguarde("Carregando painel de gestão...");
    try {
        const userDoc = await db.collection('usuarios').doc(uid).get();
        const u = userDoc.data();

        // Obtém status de Auth (para saber se está desabilitado)
        let isDisabled = false;
        try {
            const response = await fetch(`${BACKEND_API_URL}/admin/get-user-details`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid })
            });
            if (response.ok) {
                const data = await response.json();
                isDisabled = data.auth.disabled;
            }
        } catch (e) { console.warn("Não foi possível buscar status de auth:", e); }

        const container = document.getElementById('adminGerenciarConteudo');
        
        const saldoReal = (u.saldo || 0).toFixed(2);
        const saldoDigital = (u.saldoDigital || 0).toFixed(2);
        const isVip = isVipAtivo(u);
        const isPro = isProAtivo(u);
        const isProprietario = u.isProprietario === true; 
        const proTier = u.proTier ? u.proTier.toUpperCase() : '';
        const nomeEstabelecimento = u.nomeBarbearia || 'Não definido';

        container.innerHTML = `
            <div style="background: ${isDisabled ? '#3a0000' : 'transparent'}; padding: 5px; border-radius: 10px;">
                <h4 style="word-break: break-all; text-align: center; margin-bottom: 5px; color: ${isDisabled ? '#e74c3c' : 'inherit'};">
                    ${u.nome} ${isDisabled ? '(BLOQUEADO)' : ''}
                </h4>
                <p style="font-size: 11px; opacity: 0.7; text-align: center;">UID: ${uid} | Tipo: ${u.tipo.toUpperCase()}</p>
            </div>
            <hr style="border-color: var(--cor-borda); margin: 10px 0;">

            <div class="popup-section">
                <h4>📝 Dados Cadastrais</h4>
                <label style="font-size:11px;">Nome:</label>
                <input id="adminEditNome" type="text" value="${u.nome}" style="margin-bottom:5px;">
                
                <div style="display:flex; gap:5px;">
                    <div style="flex:1">
                        <label style="font-size:11px;">Telefone:</label>
                        <input id="adminEditTelefone" type="text" value="${u.telefone || ''}">
                    </div>
                    <div style="flex:1">
                        <label style="font-size:11px;">Cidade/UF:</label>
                        <input id="adminEditCidade" type="text" value="${u.cidade || ''} - ${u.estado || ''}" placeholder="Cidade - UF">
                    </div>
                </div>
                <button onclick="adminSalvarDadosBasicos('${uid}')" style="background: #444; font-size: 12px; padding: 8px;">💾 Salvar Dados</button>
            </div>

            <div class="popup-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <p><strong>🏢 Proprietário:</strong> <b style="color:${isProprietario ? '#2ecc71' : '#aaa'}">${isProprietario ? 'SIM' : 'NÃO'}</p>
                    <span style="font-size:11px; opacity:0.7;">${isProprietario ? nomeEstabelecimento : ''}</span>
                </div>
                <button onclick="adminToggleProprietario('${uid}', ${!isProprietario}, '${u.nomeBarbearia || ''}')" style="width:100%; background:${isProprietario ? '#c0392b' : '#27ae60'};">
                    ${isProprietario ? 'Remover Proprietário' : '👑 Tornar Proprietário'}
                </button>
            </div>

            <div class="popup-section">
                <h4>💰 Financeiro</h4>
                <div style="margin-bottom: 10px;">
                    <p style="margin:0 0 5px 0;">Saldo Real (Serviços): <b style="color: #2ecc71;">R$ ${saldoReal}</p>
                    <div style="display:flex; gap:5px;">
                        <input id="adminSaldoRealInput" type="number" placeholder="+ / -" style="margin:0;">
                        <button onclick="adminModificarSaldo('${uid}')" style="width:auto;">OK</button>
                    </div>
                </div>
                <div>
                    <p style="margin:0 0 5px 0;">Saldo Digital (Moedas): <b style="color: #00c6ff;">${saldoDigital}</p>
                    <div style="display:flex; gap:5px;">
                        <input id="adminSaldoDigitalInput" type="number" placeholder="+ / -" style="margin:0;">
                        <button onclick="adminModificarSaldoDigital('${uid}')" style="width:auto; background: #0072ff;">OK</button>
                    </div>
                </div>
            </div>

            <div class="popup-section">
                <h4>🌟 Status e Assinaturas</h4>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span>👑 VIP: <b style="color:${isVip ? '#f1c40f' : '#aaa'}">${isVip ? 'ATIVO' : 'INATIVO'}</span>
                    <button onclick="adminToggleVip('${uid}', ${!isVip})" style="width:auto; font-size:12px; padding: 5px 10px; background:${isVip ? '#c0392b' : '#2ecc71'}">
                        ${isVip ? 'Tirar' : 'Dar VIP'}
                    </button>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
                    <div style="margin-bottom: 5px;">
                        <span>💼 PRO: <b style="color:${isPro ? '#00c6ff' : '#aaa'}">${isPro ? 'ATIVO' : 'INATIVO'} <span style="font-size:11px;">${proTier}</span></span>
                    </div>
                    <div style="display:flex; gap:5px; align-items: center;">
                        <select id="adminProTierSelect" style="margin:0; padding:5px; flex-grow: 1; font-size:12px;">
                            <option value="tier1" ${u.proTier === 'tier1' ? 'selected' : ''}>Bronze</option>
                            <option value="tier2" ${u.proTier === 'tier2' ? 'selected' : ''}>Prata</option>
                            <option value="tier3" ${u.proTier === 'tier3' ? 'selected' : ''}>Ouro</option>
                            <option value="tier4" ${u.proTier === 'tier4' ? 'selected' : ''}>Diamante</option>
                        </select>
                        <button onclick="adminDefinirPro('${uid}')" style="width:auto; font-size:12px; background:#27ae60;">Set</button>
                        ${isPro ? `<button onclick="adminTogglePro('${uid}', false)" style="width:auto; font-size:12px; background:#c0392b;">X</button>` : ''}
                    </div>
                </div>
            </div>

            <div class="popup-section">
                <p><strong>👤 Mudar Tipo:</strong></p>
                <div style="display:flex; gap:5px;">
                    <select id="adminSelectTipoUsuario" style="margin:0; padding:8px;">
                        <option value="cliente" ${u.tipo === 'cliente' ? 'selected' : ''}>Cliente</option>
                        <option value="barbeiro" ${u.tipo === 'barbeiro' ? 'selected' : ''}>Barbeiro</option>
                        <option value="manicure_pedicure" ${u.tipo === 'manicure_pedicure' ? 'selected' : ''}>Manicure</option>
                        <option value="designer_cilios" ${u.tipo === 'designer_cilios' ? 'selected' : ''}>Cílios</option>
                        <option value="admin" ${u.tipo === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                    <button onclick="adminSalvarNovoTipo('${uid}')" style="width:auto;">Salvar</button>
                </div>
            </div>

            <div class="popup-section">
                <p><strong>⚙️ Segurança & Acesso:</strong></p>
                
                <div style="background: rgba(230, 126, 34, 0.1); padding: 8px; border-radius: 8px; border: 1px solid #e67e22; margin-bottom: 10px;">
                    <label style="font-size:11px; color:#e67e22;">Redefinir Senha do Usuário:</label>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input id="adminNovaSenha" type="text" placeholder="Digite a nova senha" style="margin:0; flex-grow:1;">
                        <button onclick="adminDefinirNovaSenha('${uid}')" style="width:auto; font-size:11px; background-color: #e67e22;">💾 Alterar</button>
                    </div>
                </div>

                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button onclick="adminToggleLoja('${uid}', ${!u.lojaLiberada})" style="flex:1; font-size:11px;">${u.lojaLiberada ? '🚫 Bloquear Loja' : '✅ Liberar Loja'}</button>
                </div>
                
                <button onclick="adminToggleUserStatus('${uid}', ${!isDisabled})" style="margin-top:10px; background-color: ${isDisabled ? '#2ecc71' : '#c0392b'}; border: 2px solid ${isDisabled ? '#27ae60' : '#e74c3c'};">
                    ${isDisabled ? '🔓 DESBLOQUEAR ACESSO' : '🚫 BLOQUEAR ACESSO (BANIR)'}
                </button>
                
                <button onclick="abrirModalEditorDados('${uid}')" style="margin-top:10px; background:transparent; border:1px solid #555; color:#888;">📝 Editor Bruto (JSON)</button>
            </div>

<div class="popup-section" style="border: 1px solid #ff4444; background: rgba(255,68,68,0.05);">
                <h4 style="color:#ff4444;">☢️ Zona de Perigo</h4>
                <p style="font-size:10px; color:#aaa;">Isso removerá o profissional do mapa e da lista principal imediatamente.</p>
                <button onclick="adminExcluirCardProfissional('${uid}', '${u.nome}')" 
                        style="background:#ff4444; color:#fff; font-weight:bold; width:100%; border:none;">
                    🗑️ EXCLUIR CARD DA TELA PRINCIPAL
                </button>
            </div>

            <button onclick="fecharModalAtual()" style="margin-top: 20px; background:#555;">❌ Fechar</button>
        `;

        fecharTodosOsModais();
        abrirModal('modalGerenciarUsuario');
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao carregar usuário: " + error.message);
    }
}

async function adminExcluirCardProfissional(uid, nome) {
    const confirma = prompt(`⚠️ ATENÇÃO!\nPara remover ${nome} da tela principal, digite o nome dele abaixo:\n(Ele deixará de ser profissional e virará um cliente comum)`);
    
    if (confirma !== nome) {
        return alert("Nome incorreto. Ação cancelada.");
    }

    exibirAguarde("Limpando registro profissional...");

    try {
        await db.collection('usuarios').doc(uid).update({
            tipo: 'cliente', // Transforma em cliente (some da lista)
            vagaImediata: false,
            disponivel: 'nao',
            usaAgendaManual: false,
            listaServicos: firebase.firestore.FieldValue.delete(),
            agenda: firebase.firestore.FieldValue.delete(),
            pertenceABarbearia: firebase.firestore.FieldValue.delete(),
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp() // Reinicia o app dele
        });

        fecharTodosOsModais();
        exibirPopup("Sucesso!", "O card foi removido da tela principal. O usuário agora é um Cliente.");
        fecharModalAtual(); // Fecha o modal de gestão
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao excluir", e.message);
    }
}

async function adminToggleProprietario(uid, deveSerProprietario, nomeAtualBarbearia) {
    let nomeBarbearia = nomeAtualBarbearia;

    if (deveSerProprietario) {
        // Se for virar dono, pergunta o nome
        const input = prompt("Digite o nome do Estabelecimento/Barbearia:", nomeAtualBarbearia || "");
        if (input === null) return; // Cancelou
        if (input.trim() === "") return alert("O nome é obrigatório.");
        nomeBarbearia = input.trim();
    } else {
        if (!confirm("Remover status de proprietário? A equipe vinculada poderá perder a referência.")) return;
    }

    exibirAguarde("Atualizando...");
    try {
        const updates = {
            isProprietario: deveSerProprietario,
            nomeBarbearia: deveSerProprietario ? nomeBarbearia : firebase.firestore.FieldValue.delete(),
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('usuarios').doc(uid).update(updates);
        
        fecharTodosOsModais();
        exibirPopup("Sucesso", `Status atualizado! ${deveSerProprietario ? 'Agora é Proprietário de: ' + nomeBarbearia : 'Não é mais proprietário.'}`);
        abrirModalGerenciarUsuario(uid); // Atualiza
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao atualizar: " + e.message);
    }
}

async function adminSalvarDadosBasicos(uid) {
    const novoNome = document.getElementById('adminEditNome').value.trim();
    const novoTelefone = document.getElementById('adminEditTelefone').value.trim();
    const localizacao = document.getElementById('adminEditCidade').value.trim();
    
    if (!novoNome) return alert("O nome não pode ser vazio.");

    // Tenta separar Cidade e Estado se houver traço
    let cidade = "", estado = "";
    if (localizacao.includes("-")) {
        const parts = localizacao.split("-");
        cidade = parts[0].trim();
        estado = parts[1].trim();
    } else {
        cidade = localizacao;
    }

    exibirAguarde("Salvando dados...");
    try {
        await db.collection('usuarios').doc(uid).update({
            nome: novoNome,
            telefone: novoTelefone,
            cidade: formatarNomeProprio(cidade),
            estado: formatarNomeProprio(estado),
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        fecharTodosOsModais();
        exibirPopup("Sucesso", "Dados atualizados!");
        abrirModalGerenciarUsuario(uid);
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// Função Secundária: Abre o Popup de Edição Completa
async function abrirModalEditorDados(uid) {
    exibirAguarde("Buscando dados brutos...");
    try {
        // Chama o backend para pegar auth + firestore
        const response = await fetch(`${BACKEND_API_URL}/admin/get-user-details`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `Erro ${response.status}`);
        }
        const { firestore: u } = await response.json();

        // Cria o HTML do modal dinamicamente (se não existir no HTML base, injeta no body)
        let modalEditor = document.getElementById('modalEditorDadosUsuario');
        if (!modalEditor) {
            modalEditor = document.createElement('div');
            modalEditor.id = 'modalEditorDadosUsuario';
            modalEditor.className = 'modal';
            modalEditor.onclick = (e) => fecharModal(e);
            modalEditor.innerHTML = `<div class="modal-content" onclick="event.stopPropagation()" style="max-height:85vh; overflow-y:auto;"><h3>📝 Editar Dados</h3><div id="editorCamposContainer"></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="fecharModalAtual()" style="background:#555; flex:1;">Ocultar Dados</button><button id="btnSalvarEdicaoGeral" style="flex:1; background:#2ecc71;">💾 Salvar Tudo</button></div></div>`;
            document.body.appendChild(modalEditor);
        }

        const containerCampos = modalEditor.querySelector('#editorCamposContainer');
        containerCampos.innerHTML = '';

        // Gera inputs para campos editáveis
        const camposIgnorados = ['fcmTokens', 'listaServicos', 'portfolio', 'conquistas', 'agenda', 'promocoes', 'favoritos', 'baloesAdquiridos', 'moldurasAdquiridas'];
        const camposEditaveis = {};

        Object.keys(u).sort().forEach(key => {
            if (camposIgnorados.includes(key)) return; // Pula campos complexos

            let valor = u[key];
            let inputType = 'text';
            
            if (typeof valor === 'number') inputType = 'number';
            if (typeof valor === 'boolean') {
                // Para booleanos, usa select
                camposEditaveis[key] = valor;
                containerCampos.innerHTML += `
                    <label style="font-size:12px; color:var(--cor-destaque); margin-top:5px; display:block;">${key}</label>
                    <select id="edit_geral_${key}" style="padding:5px;">
                        <option value="true" ${valor ? 'selected' : ''}>True</option>
                        <option value="false" ${!valor ? 'selected' : ''}>False</option>
                    </select>`;
                return;
            }
            if (key.toLowerCase().includes('data') || (valor && typeof valor === 'object' && valor.seconds)) {
                // Apenas exibe data (não editável facilmente aqui para evitar quebra)
                if (valor && valor.seconds) valor = new Date(valor.seconds * 1000).toISOString();
                containerCampos.innerHTML += `<label style="font-size:12px; color:#aaa; margin-top:5px; display:block;">${key} (Apenas Leitura)</label><input value="${valor}" disabled style="background:#333;">`;
                return;
            }

            camposEditaveis[key] = valor;
            containerCampos.innerHTML += `
                <label style="font-size:12px; color:var(--cor-destaque); margin-top:5px; display:block;">${key}</label>
                <input id="edit_geral_${key}" type="${inputType}" value="${valor !== undefined ? valor : ''}">`;
        });

        // Configura botão salvar
        document.getElementById('btnSalvarEdicaoGeral').onclick = () => adminSalvarEdicaoGeral(uid, camposEditaveis);

        fecharTodosOsModais(); // Fecha aguarde e o modal de gerenciar anterior
        abrirModal('modalEditorDadosUsuario');

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao carregar dados: " + error.message);
    }
}

async function adminSalvarEdicaoGeral(uid, mapaCampos) {
    exibirAguarde("Salvando dados...");
    let updates = {};
    
    // Coleta valores dos inputs
    Object.keys(mapaCampos).forEach(key => {
        const el = document.getElementById(`edit_geral_${key}`);
        if (el) {
            let val = el.value;
            // Converte tipos de volta
            if (typeof mapaCampos[key] === 'number') val = parseFloat(val);
            if (typeof mapaCampos[key] === 'boolean') val = (val === 'true');
            
            updates[key] = val;
        }
    });

    // Força reload se mudou algo crítico
    updates.forceReloadTimestamp = firebase.firestore.FieldValue.serverTimestamp();

    try {
        await db.collection('usuarios').doc(uid).update(updates);
        fecharTodosOsModais();
        exibirPopup("Dados salvos com sucesso!");
        abrirModalGerenciarUsuario(uid); // Volta para o menu principal
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar: " + e.message);
    }
}

// (Alteração 1) Adicionar Giros (Decrementa o contador de realizados, criando crédito)
async function adminAdicionarGiros(uid) {
    const qtde = parseInt(document.getElementById('adminInputGiros').value);
    if (isNaN(qtde) || qtde <= 0) return exibirPopup("Digite uma quantidade válida.");

    exibirAguarde("Adicionando giros...");
    try {
        // Subtrai dos realizados. Se user fez 1 e subtraio 5, fica -4.
        // Se o limite é 1, 1 - (-4) = 5 giros disponíveis.
        await db.collection('usuarios').doc(uid).update({
            girosRealizadosHoje: firebase.firestore.FieldValue.increment(-qtde),
            ultimoGiroRoleta: new Date().toDateString() // Garante que vale para hoje
        });
        fecharTodosOsModais();
        exibirPopup("Sucesso", `${qtde} giros adicionados!`);
        abrirModalGerenciarUsuario(uid); 
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// (Alteração 1) Remover Giros (Aumenta o contador de realizados)
async function adminRemoverGiros(uid) {
    const qtde = parseInt(document.getElementById('adminInputGiros').value);
    if (isNaN(qtde) || qtde <= 0) return exibirPopup("Digite uma quantidade válida.");

    exibirAguarde("Removendo giros...");
    try {
        await db.collection('usuarios').doc(uid).update({
            girosRealizadosHoje: firebase.firestore.FieldValue.increment(qtde),
            ultimoGiroRoleta: new Date().toDateString()
        });
        fecharTodosOsModais();
        exibirPopup("Sucesso", `${qtde} giros removidos!`);
        abrirModalGerenciarUsuario(uid); 
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// (Alteração 4) Salvar Novo Tipo de Usuário
async function adminSalvarNovoTipo(uid) {
    const novoTipo = document.getElementById('adminSelectTipoUsuario').value;
    if (!confirm(`Alterar este usuário para "${novoTipo}"? O app dele será reiniciado.`)) return;

    exibirAguarde("Alterando tipo...");
    try {
        let updates = { 
            tipo: novoTipo,
            forceReloadTimestamp: firebase.firestore.FieldValue.serverTimestamp() // Força reload
        };
        
        // Limpa campos se virar cliente
        if (novoTipo === 'cliente') {
            updates.listaServicos = [];
            updates.agenda = {};
            updates.vagaImediata = false;
        }

        await db.collection('usuarios').doc(uid).update(updates);
        fecharTodosOsModais();
        exibirPopup("Sucesso", `Usuário agora é ${novoTipo}.`);
        abrirModalGerenciarUsuario(uid);
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao alterar tipo: " + error.message);
    }
}

function prepararDeletarConta() {
  // Fecha o modal de configurações onde o botão está
  fecharModalAtual();
  
  // Pede confirmação inicial
  exibirConfirmacao("⚠️ Excluir Conta?", "Esta ação é irreversível. Todos os seus dados serão apagados permanentemente. Deseja continuar?", () => {
      // Se o usuário disser SIM, abre o modal de senha/email
      const emailInput = document.getElementById('exclusaoEmailInput');
      const senhaInput = document.getElementById('exclusaoSenhaInput');
      
      if(emailInput) emailInput.value = '';
      if(senhaInput) senhaInput.value = '';
      
      abrirModal('modalConfirmarSenhaExclusao');
  });
}

async function deletarConta() {
  const emailDigitado = document.getElementById('exclusaoEmailInput').value.trim();
  const password = document.getElementById('exclusaoSenhaInput').value;
  const user = auth.currentUser;

  if (!user) return;

  if (!emailDigitado || !password) {
      return exibirPopup("Dados incompletos.", "Por favor, digite seu e-mail e senha para confirmar.");
  }

  if (emailDigitado.toLowerCase() !== user.email.toLowerCase()) {
      return exibirPopup("E-mail incorreto.", "O e-mail digitado não corresponde à conta logada.");
  }

  // CORREÇÃO AQUI: Usa a função correta para fechar o modal atual
  fecharModalAtual(); 
  exibirAguarde("Excluindo sua conta...");

  try {
      // 1. Reautenticar (Obrigatório pelo Firebase para operações sensíveis)
      const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
      await user.reauthenticateWithCredential(credential);

      // 2. NOTIFICAR O ADMIN (Antes de apagar os dados)
      await db.collection('avisos').add({
          tipo: 'conta_excluida_admin',
          usuarioNome: perfil.nome || 'Usuário',
          usuarioTelefone: perfil.telefone || '',
          usuarioEmail: user.email,
          motivo: "Exclusão pelo próprio usuário",
          destinatario: 'admin',
          lido: false,
          ts: firebase.firestore.FieldValue.serverTimestamp()
      });

      // 3. Deletar dados do Firestore
      await db.collection('usuarios').doc(user.uid).delete();
      
      // 4. Deletar usuário do Authentication
      await user.delete();

      fecharTodosOsModais();
      alert("Sua conta foi excluída com sucesso.");
      location.reload(); // Reinicia o app
      
  } catch (error) {
      fecharTodosOsModais();
      console.error("Erro na exclusão:", error);
      
      if (error.code === 'auth/wrong-password') {
          exibirPopup("Senha Incorreta", "A senha digitada está incorreta. A exclusão foi cancelada.", 'erro');
          // Reabre o modal para tentar de novo após um breve delay
          setTimeout(() => abrirModal('modalConfirmarSenhaExclusao'), 1000);
      } else {
          exibirPopup("Erro", "Ocorreu um erro ao excluir sua conta: " + error.message, 'erro');
      }
  }
}

async function adminSalvarAlteracoesUsuario(uid) {
    const nomeInput = document.getElementById('adminNovoNome');
    const telefoneInput = document.getElementById('adminNovoTelefone');
    const estadoInput = document.getElementById('adminNovoEstado'); // Input de estado
    const cidadeInput = document.getElementById('adminNovoCidade'); // Input de cidade

    const updates = {
        nome: nomeInput.value.trim(),
        telefone: telefoneInput.value.trim(),
        // Formata os valores dos inputs antes de salvar
        estado: formatarNomeProprio(estadoInput.value.trim()),
        cidade: formatarNomeProprio(cidadeInput.value.trim())
    };

    if (!updates.nome || !updates.telefone || !updates.estado || !updates.cidade) {
        return exibirPopup("Todos os campos (Nome, Telefone, Estado, Cidade) devem ser preenchidos.");
    }
     // Validação extra para telefone (exemplo)
    if (!/^\d{10,11}$/.test(updates.telefone)) {
        return exibirPopup("O telefone deve conter 10 ou 11 dígitos (com DDD).");
    }

    exibirAguarde("Salvando...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, updates })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Erro no backend');

        fecharTodosOsModais();
        exibirPopup("Dados do usuário atualizados com sucesso!");
        // Não é mais necessário fechar o modal aqui, fecharTodosOsModais já faz
        // Opcional: Reabrir a lista pode ser confuso, melhor deixar o admin fechar
        // abrirModalUsuarios();

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar alterações: " + error.message);
    }
}

async function adminDefinirNovaSenha(uid) {
    
    // 1. Encontrar o elemento de input de forma segura
    const inputSenha = document.getElementById('adminNovaSenha');

    // VERIFICAÇÃO CRÍTICA: Se o elemento não existe, impede o crash e notifica o Admin.
    if (!inputSenha) {
        console.error("ERRO CRÍTICO: Elemento 'adminNovaSenha' não encontrado no DOM. A função não pode prosseguir.");
        return exibirPopup("Erro: Campo de nova senha não encontrado na tela. Por favor, feche e reabra a janela de edição.");
    }

    // 2. Agora, podemos acessar o valor com segurança
    const novaSenha = inputSenha.value; 
    
    // 3. O resto da sua lógica
    if (novaSenha.length < 6) {
        return exibirPopup("A nova senha deve ter no mínimo 6 caracteres.");
    }
    if (!confirm("Tem certeza que deseja definir esta nova senha para o usuário? Ele perderá o acesso com a senha antiga.")) {
        return;
    }
    
    exibirAguarde("Redefinindo senha...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/reset-user-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, newPassword: novaSenha })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirPopup(`Senha redefinida! A nova senha é "${novaSenha}". É recomendado enviar para o usuário via WhatsApp.`);
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao definir nova senha: " + error.message);
    }
}

async function adminToggleUserStatus(uid, disable) {
    const acao = disable ? "desabilitar" : "reativar";
    if (!confirm(`Tem certeza que deseja ${acao} a conta deste usuário? Ele ${disable ? 'não poderá mais fazer login' : 'poderá voltar a fazer login'}.`)) {
        return;
    }

    exibirAguarde(`${acao.charAt(0).toUpperCase() + acao.slice(1)}ndo conta...`);
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/toggle-user-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, disable })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirPopup(`Conta ${disable ? 'desabilitada' : 'reativada'} com sucesso!`);
        fecharModalAtual(); // Fecha o modal para forçar a reabertura com os dados atualizados
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup(`Erro ao ${acao} conta: ` + error.message);
    }
}


// Funções de Ação do Modal Admin
async function adminMudarTipo(uid) {
  const novoTipo = document.getElementById('adminNovoTipo').value;
  await db.collection("usuarios").doc(uid).update({ tipo: novoTipo });
  exibirPopup("Tipo alterado!");
  fecharModalAtual();
}

// Função para Modificar Saldo Real (Adicionar ou Subtrair)
async function adminModificarSaldo(uid) {
  const input = document.getElementById('adminModificarSaldo') || document.getElementById('adminSaldoRealInput'); // Compatibilidade com IDs
  const valor = parseFloat(input.value);
  
  if (isNaN(valor) || valor === 0) return exibirPopup("Digite um valor válido (positivo para adicionar, negativo para remover).");

  const acao = valor > 0 ? "adicionar" : "remover";
  if(!confirm(`Tem certeza que deseja ${acao} R$ ${Math.abs(valor).toFixed(2)} do Saldo Real?`)) return;

  exibirAguarde("Atualizando saldo...");
  try {
      await db.collection("usuarios").doc(uid).update({ saldo: firebase.firestore.FieldValue.increment(valor) });
      
      notifyUser(uid, "💸 Atualização de Saldo", `Seu saldo foi ajustado em R$ ${valor.toFixed(2)} pelo suporte.`, { link: '#carteira' });
      
      fecharTodosOsModais(); // Fecha aguarde
      exibirPopup("Sucesso", "Saldo Real atualizado!");
      abrirModalGerenciarUsuario(uid); // Reabre para ver a mudança
  } catch(e) {
      fecharTodosOsModais();
      exibirPopup("Erro: " + e.message);
  }
}

// --- FUNCIONALIDADE: RETORNO INTELIGENTE (IA) ---
function verificarRetornoInteligente() {
    // Só para clientes
    if (!perfil || perfil.tipo !== 'cliente') return;

    const hoje = new Date().toDateString();
    const ultimoAviso = localStorage.getItem('last_smart_return_check');

    // Só checa uma vez por dia
    if (ultimoAviso === hoje) return;

    // Se tem agendamento anterior
    if (perfil.ultimoAgendamento) {
        const dataUltimo = perfil.ultimoAgendamento.toDate(); // Timestamp do Firebase
        const diffDias = Math.floor((new Date() - dataUltimo) / (1000 * 60 * 60 * 24));

        // Regra: Se faz mais de 25 dias
        if (diffDias >= 25) {
            setTimeout(() => {
                exibirConfirmacao(
                    "✂️ Hora do Retoque?", 
                    `Faz ${diffDias} dias que você cortou o cabelo. Que tal agendar um horário para manter o estilo?`,
                    () => {
                        fecharTodosOsModais();
                        // Abre a lista de barbeiros favoritos ou geral
                        mostrar('clienteView');
                        abrirBarbeiros(); 
                    }
                );
            }, 5000); // Mostra 5s após abrir o app
        }
    }
    
    // Marca que já checou hoje
    localStorage.setItem('last_smart_return_check', hoje);
}

// Função para Modificar Saldo Digital (Adicionar ou Subtrair)
async function adminModificarSaldoDigital(uid) {
  const input = document.getElementById('adminModificarSaldoDigital') || document.getElementById('adminSaldoDigitalInput');
  const valor = parseFloat(input.value);
  
  if (isNaN(valor) || valor === 0) return exibirPopup("Digite um valor válido.");

  if(!confirm(`Tem certeza que deseja adicionar/remover ${valor} Moedas Digitais?`)) return;
    
  exibirAguarde("Atualizando moedas...");
  try {
      await db.collection("usuarios").doc(uid).update({ 
          saldoDigital: firebase.firestore.FieldValue.increment(valor) 
      });
      
      fecharTodosOsModais();
      exibirPopup("Sucesso", "Saldo Digital atualizado!");
      abrirModalGerenciarUsuario(uid);
  } catch(e) {
      fecharTodosOsModais();
      exibirPopup("Erro: " + e.message);
  }
}

// Função Wrapper para capturar o Tier selecionado no Select
function adminDefinirPro(uid) {
    const select = document.getElementById('adminProTierSelect');
    if(!select) return;
    const tier = select.value;
    adminTogglePro(uid, true, tier);
}

// Função Principal do PRO (Atualizada para receber o Tier)
async function adminTogglePro(uid, conceder, tierSelecionado = 'tier1') {
    exibirAguarde(conceder ? "Concedendo PRO..." : "Removendo PRO...");
    
    try {
        // 1. Busca dados atuais para verificar moldura temporária
        const userDoc = await db.collection('usuarios').doc(uid).get();
        if (!userDoc.exists) throw new Error("Usuário não encontrado.");
        const u = userDoc.data();

        let updates = {};
        
        if (conceder) {
            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 30); 
            
            updates = {
                proAtivo: true,
                proTier: tierSelecionado,
                proExpirationDate: expiracao.toISOString() 
            };
        } else {
            // Lógica de limpeza ao remover PRO
            if (u.molduraSelecionada) {
                const moldurasCompradas = u.moldurasAdquiridas || [];
                // Se a moldura atual não for comprada (é temporária do PRO), remove
                if (!moldurasCompradas.includes(u.molduraSelecionada)) {
                    updates.molduraSelecionada = firebase.firestore.FieldValue.delete();
                }
            }
            updates.proAtivo = false;
            updates.proTier = null;
            updates.proExpirationDate = null;
        }
        
        // Chama Backend Seguro
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                adminUid: auth.currentUser.uid, 
                targetUid: uid, 
                updates: updates 
            })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Erro no backend');

        fecharTodosOsModais(); // Fecha aguarde
        
        if (conceder) {
            notifyUser(uid, "🌟 PRO Ativado!", `Admin ativou seu plano ${tierSelecionado}.`);
            exibirPopup("Sucesso!", `Plano PRO ${tierSelecionado} definido.`);
        } else {
            notifyUser(uid, "ℹ️ PRO Removido", "Seu plano PRO foi cancelado pelo admin.");
            exibirPopup("Sucesso!", "Plano PRO removido.");
        }
        
        abrirModalGerenciarUsuario(uid); // Atualiza a tela

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro", error.message);
    }
}

async function adminToggleVip(uid, conceder) {
    const acao = conceder ? "Concedendo VIP..." : "Removendo VIP...";
    exibirAguarde(acao);
    try {
        let updates = {};
        if (conceder) {
            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 180); // 6 meses
            updates = {
                vip: true,
                vipExpirationDate: expiracao.toISOString() // Envia como string ISO
            };
        } else {
            updates = {
                vip: false,
                vipExpirationDate: null // Define como null (seu backend e a função isVipAtivo já tratam isso)
            };
        }
        
        // CHAMA O BACKEND SEGURO
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                adminUid: auth.currentUser.uid, 
                targetUid: uid, 
                updates: updates 
            })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Erro no backend');

        fecharTodosOsModais();
        exibirPopup(conceder ? "VIP concedido!" : "VIP Removido!");
        
        // Notifica o usuário
        if (conceder) {
            notifyUser(uid, "👑 VIP Concedido!", "Um administrador ativou sua assinatura VIP por 6 meses.");
        } else {
            notifyUser(uid, "ℹ️ VIP Removido", "Sua assinatura VIP foi removida por um administrador.");
        }
        
        abrirModalGerenciarUsuario(uid); // Reabre para atualizar a UI
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao gerenciar VIP: " + error.message);
    }
}

// --- LÓGICA ANTES & DEPOIS ---

function abrirCriarAntesDepois() {
    abrirModal('modalCriarAntesDepois');
}

function previewBA(input, imgId) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => document.getElementById(imgId).src = e.target.result;
        reader.readAsDataURL(file);
    }
}

async function salvarAntesDepois() {
    const fileAntes = document.getElementById('fileAntes').files[0];
    const fileDepois = document.getElementById('fileDepois').files[0];
    
    if (!fileAntes || !fileDepois) return exibirPopup("Selecione as duas fotos!");

    exibirAguarde("Criando mágica...");
    
    try {
        // Upload das duas imagens
        const urlAntes = await uploadImage(fileAntes, `ba/${auth.currentUser.uid}/${Date.now()}_antes`);
        const urlDepois = await uploadImage(fileDepois, `ba/${auth.currentUser.uid}/${Date.now()}_depois`);
        
        // Salva no portfólio como um objeto especial
        // Vamos usar um formato de string especial: "BA|urlAntes|urlDepois"
        const stringMagica = `BA|${urlAntes}|${urlDepois}`;
        
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            portfolio: firebase.firestore.FieldValue.arrayUnion(stringMagica)
        });
        
        fecharTodosOsModais();
        exibirPopup("Sucesso!", "Comparativo adicionado ao portfólio!");
        // Recarrega portfolio se estiver aberto
        if(document.getElementById('modalPortfolioBarbeiro').classList.contains('show')) {
             carregarPortfolioExistente();
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// --- ATUALIZAR A RENDERIZAÇÃO DO PORTFÓLIO ---
// Você precisa atualizar a função 'renderizarGridPortfolio' (e a do cliente) 
// para entender esse novo formato "BA|..."

/* COMO INTEGRAR:
Procure sua função 'renderizarGridPortfolio' (ou onde mostra as fotos).
Onde tem o loop `portfolioUrls.forEach(url => { ... })`, adicione essa verificação:
*/

/* EXEMPLO DE CÓDIGO PARA COLAR DENTRO DO SEU LOOP DE PORTFÓLIO: */
/*
    if (url.startsWith("BA|")) {
        const parts = url.split('|');
        const imgAntes = parts[1];
        const imgDepois = parts[2];
        
        // Renderiza o Card Interativo
        const container = document.createElement('div');
        container.className = 'before-after-container';
        // Evento para deslizar no desktop e celular
        container.onmousemove = (e) => moveSlider(e, container);
        container.ontouchmove = (e) => moveSlider(e, container);

        container.innerHTML = `
            <img src="${imgDepois}" class="ba-img img-depois">
            <div class="ba-img img-antes" style="background-image: url('${imgAntes}'); background-size: cover; width: 50%;"></div>
            <div class="ba-label lbl-antes">Antes</div>
            <div class="ba-label lbl-depois">Depois</div>
            <div class="ba-slider-handle" style="left: 50%;">↔️</div>
        `;
        
        // Adiciona botão de excluir se for o dono
        // ... (seu código de botão excluir) ...

        gridContainer.appendChild(container);
        return; // Pula o resto do loop normal de imagem simples
    }
*/

// Função para mover o slider
function moveSlider(e, container) {
    const rect = container.getBoundingClientRect();
    let x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    
    // Limites
    if (x < 0) x = 0;
    if (x > rect.width) x = rect.width;
    
    const percent = (x / rect.width) * 100;
    
    // Move a linha divisória (imagem de cima)
    const imgAntes = container.querySelector('.img-antes');
    const handle = container.querySelector('.ba-slider-handle');
    
    // A imagem de "Antes" é uma div com background, ajustamos a largura dela
    imgAntes.style.width = percent + "%";
    handle.style.left = percent + "%";
}

async function enviarAlertaSOS() {
    const desconto = parseInt(document.getElementById('sosDesconto').value);
    const horas = parseFloat(document.getElementById('sosHoras').value);
    const descricao = document.getElementById('sosDescricao').value.trim();
    
    const checkboxes = document.querySelectorAll('.sos-servico-check:checked');
    const servicosSelecionados = Array.from(checkboxes).map(cb => cb.value);

    if (!desconto || !horas) return exibirPopup("Preencha o desconto e a duração.");
    if (servicosSelecionados.length === 0) return exibirPopup("Selecione pelo menos um serviço.");
    if (!descricao) return exibirPopup("Adicione uma descrição.");
    
    if (!perfil.latitude || !perfil.longitude) return exibirPopup("Erro", "Localização não definida.");

    exibirAguarde("Ativando SOS e Notificando...");

    try {
        // CALCULA A DATA DE EXPIRAÇÃO
        const dataExpiracao = new Date(Date.now() + (horas * 60 * 60 * 1000));

        // 1. ATUALIZA O PERFIL DO PROFISSIONAL (ISSO FAZ O PREÇO MUDAR NO CARD)
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            sosConfig: {
                ativo: true,
                desconto: desconto,
                servicos: servicosSelecionados, // Lista de nomes dos serviços
                mensagem: descricao,
                expiraEm: firebase.firestore.Timestamp.fromDate(dataExpiracao)
            }
        });

        // 2. CRIA O AVISO NO BANCO (Popup In-App)
        await db.collection('avisos').add({
            tipo: 'oferta_relampago',
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nome,
            remetenteFoto: perfil.fotoPerfil || perfil.logo_url || '/icone.png',
            mensagem: descricao,
            servicos: servicosSelecionados,
            latOrigem: perfil.latitude,
            lonOrigem: perfil.longitude,
            raioKm: 3, 
            desconto: desconto,
            expiraEm: dataExpiracao,
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            destinatario: 'area_local'
        });

        // 3. CHAMA O BACKEND (Push Notification)
        // (Mantém a chamada que fizemos no passo anterior)
        fetch('https://navalhabackend.onrender.com/api/disparar-sos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                latOrigem: perfil.latitude,
                lonOrigem: perfil.longitude,
                nomeProfissional: perfil.nome,
                mensagem: descricao,
                desconto: desconto,
                uidProfissional: auth.currentUser.uid
            })
        }).catch(err => console.warn("Erro silencioso no push:", err));

        // Limpeza visual
        const modal = document.getElementById('modalSOS');
        if (modal) modal.remove();
        fecharTodosOsModais();

        exibirPopup("🚀 SOS ATIVADO!", `Os preços foram atualizados no seu perfil e os clientes notificados. A oferta dura ${horas}h.`);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", e.message);
    }
}

// SUBSTITUA A FUNÇÃO abrirModalSOS INTEIRA POR ESTA:
function abrirModalSOS() {
    if (!perfil || perfil.tipo === 'cliente') return;

    // --- TRAVA DE SEGURANÇA TIER 4 ---
    if (perfil.tipo !== 'admin' && (!perfil.proAtivo || perfil.proTier !== 'tier4')) {
        return cliqueBloqueado('tier4');
    }

    // Gera a lista de serviços com checkboxes
    let htmlServicos = '';
    if (perfil.listaServicos && perfil.listaServicos.length > 0) {
        htmlServicos = `<p style="font-size:12px; margin-bottom:5px;">Selecione os serviços da oferta:</p>
                        <div style="max-height:100px; overflow-y:auto; background:#222; padding:10px; border-radius:8px; margin-bottom:10px; text-align:left;">`;
        
        perfil.listaServicos.forEach((s, index) => {
            htmlServicos += `
                <div style="margin-bottom:5px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" class="sos-servico-check" value="${s.nome}" style="width:auto; margin:0;">
                        <span style="font-size:13px;">${s.nome} (R$ ${s.valor.toFixed(2)})</span>
                    </label>
                </div>`;
        });
        htmlServicos += `</div>`;
    } else {
        htmlServicos = `<p style="color:#e74c3c; font-size:12px;">Você não tem serviços cadastrados para ofertar.</p>`;
    }

    const html = `
        <div id="modalSOS" class="modal show" style="z-index: 20000; display:flex;">
            <div class="modal-content" style="border: 2px solid var(--cor-destaque-ouro);">
                <h3 style="color:var(--cor-destaque-ouro); margin-top:0;">🚨 SOS CADEIRA VAZIA</h3>
                <p style="font-size:12px; color:#ccc;">Lance uma oferta relâmpago para clientes em um raio de 3km!</p>
                
                ${htmlServicos}

                <label style="font-size:12px;">Desconto (%):</label>
                <input type="number" id="sosDesconto" placeholder="Ex: 20" value="20" style="margin-bottom:10px;">
                
                <label style="font-size:12px;">Breve Descrição / Chamada:</label>
                <input type="text" id="sosDescricao" placeholder="Ex: Corre que é só hoje! Cadeira liberou agora." style="margin-bottom:10px;">

                <label style="font-size:12px;">Válido por (horas):</label>
                <input type="number" id="sosHoras" placeholder="Ex: 2" value="2">
                
                <button onclick="enviarAlertaSOS()" class="btn-launch-offer" style="width:100%; margin: 15px 0 10px 0; display: block;">🚀 DISPARAR ALERTA</button>
                
                <button onclick="document.getElementById('modalSOS').remove()" style="background:#555; width:100%;">❌ Cancelar</button>
            </div>
        </div>
    `;
    
    // Remove modal anterior se existir para não duplicar
    const anterior = document.getElementById('modalSOS');
    if(anterior) anterior.remove();

    document.body.insertAdjacentHTML('beforeend', html);
}

async function carregarGraficoVendasGlobal() {
    const ctx = document.getElementById('chartVendasAdmin');
    if (!ctx) return;

    const inicioMes = new Date();
    inicioMes.setDate(1);
    inicioMes.setHours(0,0,0,0);

    try {
        // Busca todas as solicitações de depósito aprovadas do mês
        const snap = await db.collection("solicitacoes")
            .where("tipo", "==", "deposito")
            .where("status", "==", "aprovado")
            .where("ts", ">=", firebase.firestore.Timestamp.fromDate(inicioMes))
            .get();

        let totalDigital = 0; // Moedas 💎
        let totalVirtual = 0; // Saldo R$ 💵

        snap.forEach(doc => {
            const d = doc.data();
            const valor = parseFloat(d.valor) || 0;
            if (d.subtipo === 'digital') totalDigital += valor;
            else totalVirtual += valor;
        });

        // Renderiza o Gráfico de Barras Comparativo
        if (window.chartGlobalAdmin) window.chartGlobalAdmin.destroy();
        
        window.chartGlobalAdmin = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Moeda Digital (💎)', 'Moeda Virtual (💵)'],
                datasets: [{
                    data: [totalDigital, totalVirtual],
                    backgroundColor: ['#00c6ff', '#2ecc71'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#888' } },
                    x: { ticks: { color: '#fff' } }
                }
            }
        });

        document.getElementById('legendaVendasAdmin').innerHTML = `
            <span style="color:#00c6ff">💎 Total: ${totalDigital.toFixed(2)}</span>
            <span style="color:#2ecc71">💵 Total: R$ ${totalVirtual.toFixed(2)}</span>
        `;

    } catch (e) { console.error("Erro gráfico admin:", e); }
}

function abrirModalGiftCard() {
    // Saldo real e digital do usuário logado
    const saldoReal = perfil.saldo || 0;
    const saldoDigital = perfil.saldoDigital || 0;
    
    // O Z-Index foi mantido alto (35000) para garantir que fique sobre a Carteira
    const html = `
        <div id="modalGift" class="modal show" style="z-index: 35000 !important; display:flex;">
            <div class="modal-content" style="border: 2px solid #d4af37;">
                <h3>🎁 Enviar Presente</h3>
                <p>Escolha qual saldo você quer enviar:</p>
                
                <div style="display:flex; justify-content:center; gap:20px; margin: 10px 0; font-size:14px;">
                    <label style="font-weight:bold;">
                        <input type="radio" name="tipo_saldo_gift" value="saldo" checked> 
                        R$ Saldo Real <span style="color:#2ecc71;">(${saldoReal.toFixed(2)})</span>
                    </label>
                    <label style="font-weight:bold;">
                        <input type="radio" name="tipo_saldo_gift" value="saldoDigital"> 
                        💎 Moedas <span style="color:#00c6ff;">(${saldoDigital.toFixed(2)})</span>
                    </label>
                </div>

                <input type="email" id="giftEmail" placeholder="E-mail do amigo (cadastrado)">
                <input type="number" id="giftValor" placeholder="Valor a enviar (R$)">
                
                <button onclick="enviarGiftCard()" style="background: linear-gradient(45deg, #d4af37, #f1c40f); color:black; font-weight:bold; width:100%;">🎁 Enviar Agora</button>
                <button onclick="document.getElementById('modalGift').remove()" style="background:#555; margin-top:10px; width:100%;">Cancelar</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
    
    // Pequeno script para desabilitar o botão se o saldo for zero em ambos
    const btnEnviar = document.querySelector('#modalGift button[onclick^="enviarGiftCard"]');
    if (saldoReal === 0 && saldoDigital === 0 && btnEnviar) {
         btnEnviar.disabled = true;
         btnEnviar.textContent = "Saldo Zerado";
    }
}

// --- FUNÇÃO UNIVERSAL DE LIKE EM COMENTÁRIO ---
async function toggleLikeComentario(caminhoColecaoPai, idDocPai, idComentario) {
    if (!auth.currentUser) return;
    
    const uid = auth.currentUser.uid;
    // Monta o caminho: ex: 'stories/ID_STORY/comments/ID_COMENTARIO'
    const docRef = db.collection(caminhoColecaoPai).doc(idDocPai).collection('comments').doc(idComentario);

    // Feedback Visual Imediato (Busca o elemento pelo ID único)
    const heartIcon = document.getElementById(`heart_${idComentario}`);
    const countSpan = document.getElementById(`count_${idComentario}`);
    
    if (heartIcon && countSpan) {
        const isLiked = heartIcon.classList.contains('liked');
        let count = parseInt(countSpan.textContent) || 0;

        if (isLiked) {
            // Desmarcar
            heartIcon.classList.remove('liked');
            heartIcon.textContent = '🤍';
            countSpan.textContent = Math.max(0, count - 1);
            
            // Atualiza Banco (Remove UID)
            docRef.update({
                likes: firebase.firestore.FieldValue.arrayRemove(uid)
            }).catch(console.error);

        } else {
            // Marcar
            heartIcon.classList.add('liked');
            heartIcon.textContent = '❤️';
            countSpan.textContent = count + 1;
            tocarSom('ping'); // Som de satisfação

            // Atualiza Banco (Adiciona UID - Garante 1 por pessoa)
            docRef.update({
                likes: firebase.firestore.FieldValue.arrayUnion(uid)
            }).catch(console.error);
        }
    }
}

// --- FUNÇÃO enviarGiftCard (ATUALIZADA COM ALERTA DE RECEBIMENTO) ---
async function enviarGiftCard() {
    const emailDestino = document.getElementById('giftEmail').value.trim().toLowerCase();
    const valor = parseFloat(document.getElementById('giftValor').value);
    
    // NOVO: Pega o tipo de saldo selecionado
    const tipoSaldoInput = document.querySelector('input[name="tipo_saldo_gift"]:checked');
    const tipoSaldo = tipoSaldoInput ? tipoSaldoInput.value : 'saldo';
    
    // Define qual saldo checar
    const saldoParaDebitar = tipoSaldo === 'saldoDigital' ? (perfil.saldoDigital || 0) : (perfil.saldo || 0);
    const campoSaldo = tipoSaldo === 'saldoDigital' ? 'saldoDigital' : 'saldo';
    const tipoMoeda = tipoSaldo === 'saldoDigital' ? 'Moedas Digitais 💎' : 'Saldo Real R$';

    if (!emailDestino || isNaN(valor) || valor <= 0) return alert("Dados inválidos.");
    if (valor > saldoParaDebitar) return alert(`Saldo insuficiente. Seu saldo atual é R$ ${saldoParaDebitar.toFixed(2)}.`);
    if (emailDestino === perfil.email) return alert("Você não pode enviar para si mesmo.");

    document.getElementById('modalGift').remove();
    exibirAguarde(`Enviando ${tipoMoeda}...`);

    try {
        const snap = await db.collection('usuarios').where('email', '==', emailDestino).limit(1).get();
        if (snap.empty) {
            fecharTodosOsModais();
            return exibirPopup("Erro", "Usuário não encontrado com este e-mail.");
        }
        const amigoDoc = snap.docs[0];
        const amigoData = amigoDoc.data();

        await db.runTransaction(async (t) => {
            const meuRef = db.collection('usuarios').doc(auth.currentUser.uid);
            const amigoRef = db.collection('usuarios').doc(amigoDoc.id);

            // 1. Debita do remetente
            t.update(meuRef, { [campoSaldo]: firebase.firestore.FieldValue.increment(-valor) });
            
            // 2. Credita no destinatário
            t.update(amigoRef, { [campoSaldo]: firebase.firestore.FieldValue.increment(valor) });
            
            // 3. Registra no extrato
            const extratoRef = db.collection('extrato_financeiro').doc();
            t.set(extratoRef, {
                tipo: 'gift_card_sent',
                subtipo: tipoSaldo,
                usuarioUid: auth.currentUser.uid,
                valor: valor,
                descricao: `Presente (${tipoMoeda}) para ${amigoData.nome}`,
                dataEvento: firebase.firestore.Timestamp.now()
            });
        });

        // 1. Notifica o amigo (Push Notification)
        notifyUser(amigoDoc.id, "🎁 Você ganhou um Presente!", `${perfil.nome} te enviou R$ ${valor.toFixed(2)} em ${tipoMoeda}!`, { link: '#carteira' });
        
        // 2. CRIA O AVISO PARA O POPUP INSTANTÂNEO + CONFETES
        await db.collection('avisos').add({
            tipo: 'gift_received',
            usuarioUid: amigoDoc.id,
            mensagem: `Seu amigo ${perfil.nome} te enviou R$ ${valor.toFixed(2)} em ${tipoMoeda}!`,
            remetenteNome: perfil.nome,
            valor: valor,
            moeda: tipoMoeda,
            lido: false,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();
        if(typeof confetti === 'function') confetti();
        exibirPopup("Sucesso!", `Você enviou R$ ${valor.toFixed(2)} em ${tipoMoeda} para ${amigoData.nome}!`);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao enviar presente: " + e.message);
    }
}

// 3. FUNÇÃO REI DO DIA
async function verificarSeSouRei() {
    if (!perfil || !perfil.proAtivo) return; 
    try {
        const snap = await db.collection('batalha_likes').orderBy('count', 'desc').limit(1).get();
        if (!snap.empty) {
            const topFoto = snap.docs[0].data();
            const souEu = topFoto.ownerUid === auth.currentUser.uid;
            if (souEu && !perfil.isKing) {
                await db.collection('usuarios').doc(auth.currentUser.uid).update({
                    isKing: true,
                    kingDesde: firebase.firestore.FieldValue.serverTimestamp()
                });
                exibirPopup("🏆 VOCÊ É O REI!", "Sua foto é a mais votada do dia! Você ganhou o Balão Dourado com Troféu.");
            } else if (!souEu && perfil.isKing) {
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ isKing: false });
            }
        }
    } catch (e) { console.warn("Erro ao verificar Rei:", e); }
}

function abrirModalVipPro() {
    const container = document.getElementById('vipProContentContainer');
    const proAtivo = isProAtivo(perfil);
    let htmlContent = "";

    const niveis = { 'tier1': 1, 'tier2': 2, 'tier3': 3, 'tier4': 4 };
    const meuNivel = (proAtivo && perfil.proTier) ? niveis[perfil.proTier] : 0;

    if (proAtivo) {
        let dataFormatada = "Indefinido";
        if (perfil.proExpirationDate) {
             try {
                 const dateObj = typeof perfil.proExpirationDate.toDate === 'function' ? perfil.proExpirationDate.toDate() : new Date(perfil.proExpirationDate);
                 dataFormatada = dateObj.toLocaleDateString('pt-BR');
             } catch (e) {}
        }
        const tierAtual = perfil.proTier;
        const infoTier = PRECOS_PRO[tierAtual];
        
        htmlContent += `
            <div class="pro-glow" style="padding: 15px; border-radius: 15px; text-align: center; background: #222; margin-bottom: 20px;">
                <h3 style="color: var(--cor-destaque);">✅ Plano Atual: ${infoTier.nome.toUpperCase()}</h3>
                <p>Válido até: <strong>${dataFormatada}</strong></p>
                <p style="font-size: 13px; opacity: 0.8;">${infoTier.desc}</p>
            </div>
            <h4 style="text-align:center; margin-bottom:15px;">🚀 Evolua seu Plano:</h4>
        `;
    }

    if (meuNivel === 4) {
        htmlContent += `<p style="text-align:center; color:#2ecc71;">🏆 Você já possui o nível máximo!</p>`;
    } else {
        let htmlPlanos = '';
        const cores = { 'tier1': '#cd7f32', 'tier2': '#c0c0c0', 'tier3': '#ffd700', 'tier4': '#00c6ff' };

        Object.keys(PRECOS_PRO).forEach(tier => {
            const nivelPlano = niveis[tier];
            if (nivelPlano <= meuNivel) return; 

            const plano = PRECOS_PRO[tier];
            const cor = cores[tier];
            
            htmlPlanos += `
            <div class="card" style="border: 2px solid ${cor}; background: linear-gradient(135deg, #1a1a1a, #000); cursor: pointer; margin-bottom: 15px; position: relative; overflow: hidden;" onclick="assinarPro('${tier}')">
                ${tier === 'tier4' ? '<div style="position:absolute; top:0; right:0; background:gold; color:black; font-size:10px; padding:2px 8px; font-weight:bold;">RECOMENDADO</div>' : ''}
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="color: ${cor}; margin:0; font-size: 18px; text-transform: uppercase;">${plano.nome}</h4>
                    <div style="text-align:right;">
                        <span class="preco-cortado">R$ ${plano.cortado.toFixed(2)}</span>
                        <span style="background:${cor}; color:black; font-weight:bold; padding:2px 8px; border-radius:10px; font-size:14px;">R$ ${plano.preco.toFixed(2)}</span>
                    </div>
                </div>
                <p style="color: #ddd; font-size: 13px; margin: 10px 0; line-height: 1.4;">${plano.desc}</p>
                <button style="background: ${cor}; width: 100%; color:black; font-weight:bold; border:none; padding: 10px; margin-top: 5px; pointer-events: none;">
                    ${proAtivo ? 'FAZER UPGRADE' : 'ASSINAR AGORA'}
                </button>
            </div>`;
        });
        htmlContent += `<div style="max-height: 60vh; overflow-y: auto; padding: 5px;">${htmlPlanos}</div>`;
    }
    
    container.innerHTML = htmlContent;
    
    // --- CORREÇÃO DE CAMADA AQUI ---
    const modal = document.getElementById('modalVipPro');
    
    // Fecha outros modais que possam estar na frente (exceto o próprio)
    // Opcional: Se quiser manter o fundo, não feche, apenas suba o nível deste.
    
    // Aplica Z-Index Supremo
    modal.style.setProperty('z-index', '99999', 'important');
    
    abrirModal('modalVipPro');
}

async function adminDeletarUsuario(uid, nome) {
  if (prompt(`TEM CERTEZA? Para deletar ${nome}, digite "DELETAR":`) === "DELETAR") {
    await db.collection("usuarios").doc(uid).delete();
    exibirPopup("Usuário deletado!");
    fecharModalAtual();
  } else exibirPopup("Exclusão cancelada.");
}

async function adminToggleLoja(uid, deveAtivar) {
    const acao = deveAtivar ? "liberar" : "bloquear";
    if (!confirm(`Tem certeza que deseja ${acao} o acesso à loja para este usuário?`)) return;

    exibirAguarde(`${deveAtivar ? 'Liberando' : 'Bloqueando'} acesso...`);
    try {
        await db.collection('usuarios').doc(uid).update({ lojaLiberada: deveAtivar });
        fecharTodosOsModais();
        exibirPopup(`Acesso à loja ${deveAtivar ? 'liberado' : 'bloqueado'} com sucesso!`);
        // Reabre o modal para atualizar a interface
        abrirModalGerenciarUsuario(uid); // Chama a função que recarrega os dados e reabre
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup(`Erro ao ${acao} acesso: ${error.message}`);
    }
}

// NOVA FUNÇÃO PARA ADMIN REMOVER MOLDURAS MANUALMENTE
async function adminRemoverMoldura(uid, molduraKey, isDefinitiva) {
    if (!confirm(`Tem certeza que deseja remover a moldura "${MOLDURAS[molduraKey].nome}" deste usuário?`)) return;

    exibirAguarde("Removendo moldura...");
    try {
        const userRef = db.collection('usuarios').doc(uid);
        const userDoc = await userRef.get();
        const u = userDoc.data();
        
        let updates = {};

        // 1. Se for definitiva, remove do array de adquiridas
        if (isDefinitiva) {
            updates.moldurasAdquiridas = firebase.firestore.FieldValue.arrayRemove(molduraKey);
        }

        // 2. Se o usuário estiver USANDO essa moldura no momento, desequipa ela
        if (u.molduraSelecionada === molduraKey) {
            updates.molduraSelecionada = firebase.firestore.FieldValue.delete();
        }

        await userRef.update(updates);

        fecharTodosOsModais();
        exibirPopup("Sucesso", "Moldura removida com sucesso!");
        abrirModalGerenciarUsuario(uid); // Reabre para atualizar a lista

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Erro ao remover moldura: " + error.message);
    }
}

// ADICIONE ESTA NOVA FUNÇÃO PARA GERENCIAR OS PONTOS
async function adminModificarPontos(uid) {
    const inputPontos = document.getElementById('adminModificarPontos');
    const valor = parseInt(inputPontos.value);

    if (isNaN(valor)) {
        return exibirPopup("Por favor, insira um número válido de pontos.");
    }

    const acao = valor >= 0 ? "adicionar" : "remover";
    if (!confirm(`Tem certeza que deseja ${acao} ${Math.abs(valor)} pontos ${valor >= 0 ? 'para' : 'de'} este usuário?`)) {
        return;
    }

    exibirAguarde("Modificando pontos...");
    try {
        await db.collection('usuarios').doc(uid).update({
            pontosFidelidade: firebase.firestore.FieldValue.increment(valor)
        });
        fecharTodosOsModais();
        exibirPopup(`Pontos modificados com sucesso!`);
        notifyUser(uid, "🏆 Pontos Alterados!", `Um administrador alterou seus King Points em ${valor}.`, { link: '#fidelidade' });
        inputPontos.value = ''; // Limpa o input
        abrirModalGerenciarUsuario(uid); // Reabre para atualizar
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao modificar pontos: " + error.message);
    }
}

function solicitarVirarProfissional() {
    fecharModalAtual(); // Fecha o modal de config
    exibirConfirmacao("Virar Profissional?", 
    "Tem certeza que deseja se tornar um profissional? Seu painel será alterado e você precisará configurar seus serviços, agenda e portfólio para começar a receber agendamentos. Esta ação não pode ser desfeita facilmente pelo app.", 
    () => {
        // Callback a ser executado se o usuário clicar "Sim"
        executarVirarProfissional();
    });
}

async function executarVirarProfissional() {
    if (perfil.tipo !== 'cliente') return;
    
    exibirAguarde("Atualizando seu perfil...");
    try {
        // Calcula 7 dias a partir de agora
        const validadeInicial = new Date();
        validadeInicial.setDate(validadeInicial.getDate() + 7);

        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            tipo: perfil.interesse_principal || 'barbeiro', 
            precisaConfiguracaoInicial: true, 
            onboarding_profissional_concluido: false,
            
            // --- BÔNUS DE BOAS-VINDAS AO MUNDO PRO ---
            proAtivo: true,
            proTier: 'tier1',
            proExpirationDate: firebase.firestore.Timestamp.fromDate(validadeInicial)
        });
        
        fecharTodosOsModais();
        exibirPopup("Sucesso!", "Você virou Profissional e ganhou 7 dias de Plano Bronze grátis!", 'sucesso', () => {
            setTimeout(() => location.reload(), 4000); 
        });
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível atualizar seu perfil: " + e.message, 'erro');
    }
}


async function adminMudarTipoUsuario(uid, novoTipo) {
    // Validação removida para permitir 'admin'
    if (!confirm(`Tem certeza que deseja alterar o tipo deste usuário para "${novoTipo}"? O aplicativo dele será reiniciado.`)) return;

    // 1. Mostrar "Aguarde" IMEDIATAMENTE
    exibirAguarde("Alterando tipo de usuário...");

    try {
        // Atualiza o tipo e reseta campos específicos se necessário
        const updates = { tipo: novoTipo };
        if (novoTipo === 'cliente') {
            updates.listaServicos = [];
            updates.promocoes = [];
            updates.portfolio = [];
            updates.logo_url = firebase.firestore.FieldValue.delete();
            updates.disponivel = "nao";
            updates.vagaImediata = false;
            updates.usaAgendaManual = false;
            updates.agenda = {};
            updates.ausente = false;
            updates.ausenciaInicio = firebase.firestore.FieldValue.delete();
            updates.ausenciaFim = firebase.firestore.FieldValue.delete();
        } else {
             updates.onboarding_profissional_concluido = true;
        }

        // Adiciona o timestamp para forçar reload no *outro* cliente, se ele estiver online
        updates.forceReloadTimestamp = firebase.firestore.FieldValue.serverTimestamp();

        // Salva as alterações no Firestore
        await db.collection('usuarios').doc(uid).update(updates);

        // 2. Fechar "Aguarde" e Mostrar "Sucesso"
        fecharAguarde(null, true); // Força o fechamento do Aguarde
        exibirPopup("Sucesso", `Tipo de usuário alterado para "${novoTipo}" com sucesso! O aplicativo do usuário será reiniciado.`);

        // 3. Agendar o redirecionamento FORÇADO após 3 segundos
        //    (Isso afeta APENAS a tela do ADMIN que fez a ação, o usuário afetado
        //     será reiniciado pela lógica no onAuthStateChanged que já implementamos)
        //    Não precisamos reiniciar a tela do admin aqui, apenas reabrir o modal.
        // setTimeout(() => {
        //     console.log("Forçando reinicialização da *sua* tela (admin)...");
        //     window.location.href = '/?force_reload=' + Date.now(); // Adiciona timestamp para garantir que não use cache
        // }, 3000);

        // Em vez de reiniciar a tela do admin, apenas reabrimos o modal para ver a mudança
         abrirModalGerenciarUsuario(uid); // Reabre o modal do usuário gerenciado
         location.reload();
         abrirModalGerenciarUsuario(uid);

    } catch (error) {
        // Em caso de erro
        fecharAguarde(null, true); // Garante que o Aguarde feche
        console.error("Erro ao alterar tipo:", error);
        exibirPopup("Erro", `Erro ao alterar tipo: ${error.message}`);
    }
}

function toggleSubMenu(menuId, btnElement) {
    const menu = document.getElementById(menuId);
    if (menu) {
        const isHidden = menu.classList.contains('hidden');
        
        // Fecha todos os outros primeiro (opcional, para ficar mais limpo)
        document.querySelectorAll('.sub-menu-container').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.super-btn').forEach(el => el.classList.remove('open'));

        if (isHidden) {
            menu.classList.remove('hidden');
            if(btnElement) btnElement.classList.add('open');
        } else {
            menu.classList.add('hidden');
            if(btnElement) btnElement.classList.remove('open');
        }
    }
}

function abrirModalIdentidadeVisual() {
    const modalId = 'modalEscolhaIdentidade';
    
    // Se não existir, cria o HTML
    if (!document.getElementById(modalId)) {
        const div = document.createElement('div');
        div.id = modalId;
        div.className = 'modal';
        div.onclick = (e) => fecharModal(e);
        div.innerHTML = `
            <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
                <h3>📸 Identidade Visual</h3>
                <p>Gerencie como sua marca aparece.</p>
                
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
                    <button onclick="fecharModalAtual(); abrirModal('modalLogomarca')" style="padding:15px; background: #222; border:1px solid #aaa;">
                        <span style="font-size:20px;">🖼️</span><br>Foto de Perfil / Logo
                    </button>
                    
                    <button onclick="fecharModalAtual(); abrirModalPortfolioBarbeiro()" style="padding:15px; background: #222; border:1px solid #aaa;">
                        <span style="font-size:20px;">📸</span><br>Meu Portfólio (Fotos)
                    </button>
                    
                    ${perfil.isProprietario ? 
                    `<button onclick="fecharModalAtual(); abrirModalFachada()" style="padding:15px; background: #222; border:2px solid var(--cor-destaque);">
                        <span style="font-size:20px;">🏢</span><br>Fachada do Estabelecimento (Aplica a Todos)
                    </button>` : ''}
                </div>
                
                <button onclick="fecharModalAtual()" style="margin-top:15px; background:#555;">Cancelar</button>
            </div>
        `;
        document.body.appendChild(div);
    }
    
    // Atualiza dinamicamente se virou proprietário depois de criar o modal
    const btnFachadaExistente = document.querySelector(`#${modalId} button[onclick*="abrirModalFachada"]`);
    if (perfil.isProprietario && !btnFachadaExistente) {
        // Se agora é dono e o botão não está lá, recria o modal
        document.getElementById(modalId).remove();
        abrirModalIdentidadeVisual(); // Chama de novo recursivamente
        return;
    }
    
    abrirModal(modalId);
}

function exibirPopupNovoAgendamento(agendamentoDoc) {
    const modal = document.getElementById('modalNovoAgendamento');
    if (popupAgendamentoAberto && modal.style.display === 'flex') return; 

    const ag = agendamentoDoc.data();
    const agId = agendamentoDoc.id;
    
    // --- BLINDAGEM DE DADOS (Se o campo não existir, usa um texto padrão) ---
    const clienteNome = ag.clienteNome || "Cliente Particular";
    const servicoNome = ag.servico || "Serviço não informado";
    const barbeiroNome = ag.barbeiroNome || "Profissional";
    
    // TRATAMENTO DO VALOR: O segredo para não dar erro de 'toFixed'
    // Convertemos para Number e, se der erro ou for vazio, usamos 0.00
    const valorNum = Number(ag.valor) || 0;
    const valorFormatado = valorNum.toFixed(2);

    // Verifica se sou eu mesmo que vou cortar
    const euSouOBarbeiro = (auth.currentUser.uid === ag.barbeiroUid);
    
    let titulo = "🔔 Vaga Imediata!";
    let infoExtra = "";
    
    if (!euSouOBarbeiro) {
        titulo = "🔔 EQUIPE: Solicitação de Vaga!";
        infoExtra = `
            <div style="background:#333; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #555;">
                <p style="margin:0; font-size:11px; color:#aaa;">Profissional Escolhido:</p>
                <p style="margin:0; font-size:16px; font-weight:bold; color:#f1c40f;">💈 ${barbeiroNome}</p>
            </div>
        `;
    }

    modal.querySelector('h3').textContent = titulo;
    
    const infoDiv = document.getElementById('modalNovoAgendamentoInfo');
    infoDiv.innerHTML = `
        ${infoExtra}
        <p>Cliente: <b>${clienteNome}</b></p>
        <p>Serviço: ${servicoNome}</p>
        <p>Valor: <b style="color:#2ecc71">R$ ${valorFormatado}</b></p>
        <p style="font-size:11px; color:#aaa; margin-top:5px;">⚠️ Requer aprovação imediata</p>
    `;
    
    const btnAceitar = document.getElementById('btnAceitarAgendamentoPopup');
    const btnRecusar = document.getElementById('btnRecusarAgendamentoPopup');
    const btnWpp = document.getElementById('btnWhatsAppPopup');

    btnAceitar.onclick = () => {
        if(typeof pararAlertaManual === 'function') pararAlertaManual();
        // Passamos o valorNum já tratado para evitar erros na próxima função
        aprovarAgendamentoImediato(agId, ag.clienteUid, valorNum);
    };

    btnRecusar.onclick = () => {
        if(typeof pararAlertaManual === 'function') pararAlertaManual();
        recusarAgendamento(agId, ag.clienteUid); 
    };

    if (ag.clienteTelefone) {
        btnWpp.href = `https://wa.me/55${ag.clienteTelefone.replace(/\D/g,'')}`;
        btnWpp.style.display = 'block';
    } else {
        btnWpp.style.display = 'none';
    }

    popupAgendamentoAberto = true;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

// --- FUNÇÃO PARA ADICIONAR AO EM ALTA AUTOMATICAMENTE (TIER 4) ---
async function sincronizarComEmAlta(imgUrl, targetUid, targetName) {
    if (!imgUrl || !targetUid) return;

    try {
        // 1. Busca os dados do dono da imagem (ou do profissional avaliado)
        const userDoc = await db.collection('usuarios').doc(targetUid).get();
        if (!userDoc.exists) return;
        
        const u = userDoc.data();
        
        // 2. VERIFICA SE É DIAMANTE (TIER 4)
        const isDiamante = (u.proAtivo && u.proTier === 'tier4');

        if (isDiamante) {
            // Verifica duplicidade para não postar a mesma foto duas vezes
            const checkSnap = await db.collection('batalha_likes')
                .where('imgUrl', '==', imgUrl)
                .limit(1)
                .get();

            if (checkSnap.empty) {
                // 3. Salva no Em Alta
                await db.collection('batalha_likes').add({
                    imgUrl: imgUrl,
                    ownerUid: targetUid,
                    ownerName: targetName || u.nome,
                    ownerTier: 'tier4',
                    count: 0, // Começa com 0 likes
                    likedBy: [],
                    ts: firebase.firestore.FieldValue.serverTimestamp(),
                    origem: 'automatico' // Flag de controle interna
                });
                console.log(">> Imagem sincronizada com Em Alta (Diamante)");
            }
        }
    } catch (e) {
        console.error("Erro ao sincronizar Em Alta:", e);
    }
}

async function enviarNotificacaoMarketing() {
    const title = document.getElementById('marketingTitulo').value.trim();
    const body = document.getElementById('marketingCorpo').value.trim();
    if (!title || !body || !confirm(`Confirma o envio da notificação em massa?`)) return;
    try {
        exibirAguarde("Aguarde...", "Enviando notificações para todos.");
        const response = await fetch("https://navalhabackend.onrender.com/enviar-notificacao-massa", {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, body, adminUid: auth.currentUser.uid }),
        });
        const data = await response.json();
        fecharTodosOsModais();
        if (!response.ok) throw new Error(data.message);
        exibirPopup(`Notificações enviadas!\nSucessos: ${data.successCount}\nFalhas: ${data.failureCount}`);
        fecharModalAtual();
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup('Falha ao enviar: ' + error.message);
    }
}

const conquistasDefinidas = {
    'cliente': {
        'cortes_1': { nome: 'Primeiro Agendamento', icone: '👶', descricao: 'Concluiu seu primeiro agendamento.', level: 1 },
        'cortes_5': { nome: 'Cliente Iniciante', icone: '👍', descricao: 'Concluiu 5 agendamentos.', level: 2 },
        'cortes_10': { nome: 'Cliente Regular', icone: '⭐', descricao: 'Concluiu 10 agendamentos.', level: 3 },
        'cortes_50': { nome: 'Parceiro da Beleza', icone: '💪', descricao: 'Concluiu 50 agendamentos.', level: 5 },
        'cortes_100': { nome: 'Membro de Honra', icone: '👑', descricao: 'Concluiu 100 agendamentos.', level: 6 },
        'cortes_250': { nome: 'Cliente Fanático', icone: '🔥', descricao: 'Concluiu 250 agendamentos.', level: 7 },
        'cortes_500': { nome: 'Cliente Lenda', icone: '🏆', descricao: 'Concluiu 500 agendamentos.', level: 8 },
        'cortes_1000': { nome: 'Embaixador King Agenda', icone: '💎', descricao: 'Concluiu 1000 agendamentos.', level: 9 }
    },
    'profissional': {
        'cortes_1': { nome: 'Primeiro Cliente', icone: '🎉', descricao: 'Concluiu seu primeiro serviço.', level: 1 },
        'cortes_10': { nome: 'Profissional em Ascensão', icone: '🔥', descricao: 'Concluiu 10 serviços.', level: 3 },
        'cortes_50': { nome: 'Profissional Experiente', icone: '😎', descricao: 'Concluiu 50 serviços.', level: 5 },
        'cortes_100': { nome: 'Mestre da Área', icone: '💎', descricao: 'Concluiu 100 serviços.', level: 6 },
        'cortes_250': { nome: 'Referência Local', icone: '🚀', descricao: 'Concluiu 250 serviços.', level: 7 }, // ADICIONADO
        'cortes_500': { nome: 'Influenciador da Beleza', icone: '🌟', descricao: 'Concluiu 500 serviços.', level: 8 }, // ADICIONADO
        'cortes_1000': { nome: 'Lenda do Ramo', icone: '🏆', descricao: 'Concluiu 1000 serviços.', level: 9 } // Level ajustado
    }
};

// SUBSTITUA A FUNÇÃO verificarConquistas
async function verificarConquistas(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.cortesRealizados || 0;
    const definicoes = conquistasDefinidas.cliente;
    // CORREÇÃO: 'cortes_1000' estava com aspas erradas
    const niveis = { 1: 'cortes_1', 5: 'cortes_5', 10: 'cortes_10', 50: 'cortes_50', 100: 'cortes_100', 250: 'cortes_250', 500: 'cortes_500', 1000: 'cortes_1000' };

    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = definicoes[conquistaId];
            notifyUser(uid, "🏅 Nova Conquista!", `Você desbloqueou: "${conquista.nome}"!`, { link: '#conquistas' });
        }
    }
}

// SUBSTITUA A FUNÇÃO verificarConquistasBarbeiro
async function verificarConquistasBarbeiro(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.clientesAtendidos || 0;
    const definicoes = conquistasDefinidas.profissional;
    // CORREÇÃO: 'cortes_1000' estava com aspas erradas e 'cortes_5' estava faltando (agora incluído como você pediu)
    const niveis = { 1: 'cortes_1', 10: 'cortes_10', 50: 'cortes_50', 100: 'cortes_100', 250: 'cortes_250', 500: 'cortes_500', 1000: 'cortes_1000' };

    
    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = definicoes[conquistaId];
            notifyUser(uid, "🏅 Nova Conquista de Profissional!", `Você desbloqueou: "${conquista.nome}"!`, { link: '#conquistas' });
        }
    }
}

function abrirModalConquistas() {
    abrirModal('modalConquistas');
    const container = document.getElementById('listaConquistas');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    const definicoes = conquistasDefinidas.cliente;
    for (const id in definicoes) {
        const c = definicoes[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon
">${c.icone}</div><div>${c.nome}<p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

function abrirModalConquistasBarbeiro() {
    abrirModal('modalConquistasBarbeiro');
    const container = document.getElementById('listaConquistasBarbeiro');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    const definicoes = conquistasDefinidas.profissional;
    for (const id in definicoes) {
        const c = definicoes[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon">${c.icone}</div><div>${c.nome}<p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

async function abrirModalRankingUnificado() {
    abrirModal('modalRankingUnificado');
    const container = document.getElementById('listaRankingUnificado');
    container.innerHTML = `
        <div style="text-align:center; padding: 20px;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p>Carregando os melhores...</p>
        </div>`;
    
    try {
        const [clientesSnap, profissionaisSnap] = await Promise.all([
            db.collection('usuarios').where('tipo', '==', 'cliente').orderBy('cortesRealizados', 'desc').limit(30).get(),
            db.collection('usuarios').where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios']).orderBy('clientesAtendidos', 'desc').limit(30).get()
        ]);
        
        let ranking = [];
        
        // Helper para extrair dados
        const processarUser = (doc, tipoUser) => {
            const d = doc.data();
            // CORREÇÃO DA PRIORIDADE DA FOTO E FALLBACK PARA ÍCONE DO APP
            // 1. Foto Perfil > 2. Logo > 3. Ícone do App (/icone.png)
            const fotoFinal = d.fotoPerfil || d.logo_url || '/icone.png';

            return { 
                uid: doc.id,
                nome: d.nome, 
                foto: fotoFinal,
                contagem: tipoUser === 'cliente' ? (d.cortesRealizados || 0) : (d.clientesAtendidos || 0), 
                tipo: tipoUser,
                conquistas: d.conquistas || [],
                moldura: d.molduraSelecionada
            };
        };

        clientesSnap.forEach(doc => ranking.push(processarUser(doc, 'cliente')));
        profissionaisSnap.forEach(doc => ranking.push(processarUser(doc, 'profissional')));

        // Ordena
        ranking.sort((a, b) => b.contagem - a.contagem);
        
        container.innerHTML = "";
        
        if (ranking.length === 0) {
            container.innerHTML = "<p style='text-align:center'>Ranking vazio.</p>";
            return;
        }

        ranking.slice(0, 50).forEach((item, i) => {
            let medalhaHtml = obterIconeMaiorConquista(item.conquistas, item.tipo);
            const tipoEmoji = item.tipo === 'cliente' ? '🙋' : '💈';
            
            // Montagem do Avatar (Com ou sem moldura)
            let avatarHtml = '';
            
            // Adiciona handler de erro para garantir que se a foto falhar, carregue o icone.png
            const imgError = `onerror="this.src='/icone.png'"`;

            if (item.moldura && MOLDURAS[item.moldura]) {
                const m = MOLDURAS[item.moldura];
                avatarHtml = `
                <div class="avatar-wrapper ranking-size ${item.moldura}">
                    <div class="coroa-topo"></div>
                    <img src="${item.foto}" class="ranking-foto ${m.classe}" ${imgError}>
                </div>`;
            } else {
                avatarHtml = `<img src="${item.foto}" class="ranking-foto" style="width:45px;height:45px;border-radius:50%;border:2px solid #444;margin-right:10px;" ${imgError}>`;
            }
            
            container.innerHTML += `
                <div class="ranking-novo-item" onclick="abrirPerfilUsuarioChat('${item.uid}')">
                    <div class="ranking-posicao">#${i + 1}</div>
                    ${avatarHtml}
                    <div class="ranking-info">
                        <span class="ranking-nome" style="color: ${item.tipo === 'profissional' ? 'var(--cor-destaque)' : '#fff'}">
                            ${item.nome} ${tipoEmoji}
                        </span>
                        <div class="ranking-conquistas">${medalhaHtml}</div>
                    </div>
                    <div class="ranking-score">${item.contagem}</div>
                </div>`;
        });

    } catch (e) { 
        container.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar ranking.</p>'; 
        console.error(e);
    }
}

function obterIconeMaiorConquista(conquistas, tipo) {
    if (!conquistas || conquistas.length === 0) return '';
    const definicoes = tipo === 'cliente' ? conquistasDefinidas.cliente : conquistasDefinidas.profissional;
    let maiorLevel = -1;
    let melhorIcone = '';
    for (const id of conquistas) {
        if (definicoes[id] && definicoes[id].level > maiorLevel) {
            maiorLevel = definicoes[id].level;
            melhorIcone = definicoes[id].icone;
        }
    }
    return maiorLevel > -1 ? `<span class="chat-medal">${melhorIcone}</span>` : '';
}

// SUBSTITUA A FUNÇÃO renderizarPainelProfissionalPadrao INTEIRA POR ESTA:
function renderizarPainelProfissionalPadrao() {
    const parent = document.getElementById('barbeiroFuncoesContainer');
    parent.innerHTML = '';
    const contentDiv = document.createElement('div');
    parent.appendChild(contentDiv);

    if (contentDiv) {
        const temPermissaoSOS = perfil.isProprietario || (perfil.permissoes && perfil.permissoes.sos === true);
        const temNivelTecnico = perfil.tipo === 'admin' || (perfil.proAtivo && perfil.proTier === 'tier4');
        const podeCriarPlanos = perfil.isProprietario || (perfil.permissoes && perfil.permissoes.planos === true);
        const temPermissaoPromo = perfil.isProprietario || (perfil.permissoes && perfil.permissoes.promocoes === true);
        const isDono = perfil.isProprietario;

        // Estilos Inline
        const gridStyle = `display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px;`;
        const cardStyle = `background: #222; border: 1px solid #333; border-radius: 12px; padding: 10px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90px; text-align: center; cursor: pointer; transition: transform 0.2s; position: relative;`;
        
        // Botão SOS
        let htmlSOS = '';
        if (typeof abrirModalSOS === 'function' && temPermissaoSOS) {
            htmlSOS = temNivelTecnico 
                ? `<button onclick="abrirModalSOS()" class="btn-sos-opportunity" style="width:100%; margin-bottom: 15px; padding:15px; border-radius:12px; font-size:16px;">🚨 SOS Cadeira Vazia</button>`
                : `<button onclick="cliqueBloqueado('tier4')" style="width:100%; margin-bottom: 15px; background: #222; color: #888; border: 1px solid #444; padding:15px; border-radius:12px;">🔒 SOS Cadeira Vazia <span style="font-size:9px; color:#00c6ff;">(Diamante)</span></button>`;
        }

        // --- GRID PRINCIPAL ---
        let htmlGridPrincipal = `
            <div>
                <div style="${gridStyle}">
                    <div onclick="abrirModalCriarAgendamentoManual()" style="${cardStyle} border-color: #d4af37;">
                         <span style="font-size: 20px;">➕</span>
                        <span style="font-size: 11px; margin-top: 5px; color: #d4af37; font-weight: bold;">Novo<br>Agend.</span>
                    </div>
                    
                   <div onclick="abrirAgendamentosBarbeiro()" style="${cardStyle} border-color: #2ecc71;">
                        <span style="font-size: 20px;">⏰</span>
                        <span style="font-size: 11px; margin-top: 5px; color: #2ecc71; font-weight: bold;">Meus<br>Agend.</span>
                    </div>

                   <div onclick="abrirAgenda()" style="${cardStyle}">
                        <span style="font-size: 20px;">📅</span>
                        <span style="font-size: 11px; margin-top: 5px; color: #fff;">Agenda<br>Config</span>
                    </div>

                    <div onclick="abrirServicos()" style="${cardStyle}">
                        <span style="font-size: 20px;">✂️</span>
                        <span style="font-size: 11px; margin-top: 5px; color: #fff;">Meus<br>Serviços</span>
                    </div>

                    <div onclick="abrirConfiguracaoHorario()" style="${cardStyle}">
                        <span style="font-size: 20px;">⏰</span>
                        <span style="font-size: 11px; margin-top: 5px; color: #fff;">Expediente<br>Almoço</span>
                    </div>

                    ${isDono ? `
                    <div onclick="abrirModalFinanceiroProprietario()" style="${cardStyle} background: linear-gradient(145deg, #1a1a1a, #2a2a2a); border-color: #d4af37;">
                        <span style="font-size: 20px;">📊</span>
                        <span style="font-size: 11px; margin-top: 5px; color: gold; font-weight: bold;">Gestão<br>Dono</span>
                    </div>` : `
                    <div onclick="abrirModalDashboardBarbeiro()" style="${cardStyle}">
                        <span style="font-size: 20px;">🚀</span>
                        <span style="font-size: 11px; margin-top: 5px; color: #fff;">Meu<br>Desempenho</span>
                    </div>`}
                </div>
            </div>
        `;

        // Menus Expansíveis (AGORA INICIAM FECHADOS - CLASSE 'hidden' ADICIONADA)
        let htmlFinanceiro = `
            <div>
                <button class="super-btn" onclick="toggleSubMenu('menu_financeiro', this)">💰 Outros Financeiros</button>
                <div id="menu_financeiro" class="sub-menu-container hidden"> <button onclick="abrirModalCarteira()" style="width:48%">💵 Carteira / Saque</button>
                    <button onclick="abrirModalDashboardBarbeiro()" style="width:48%">📈 Relatórios</button>
                    ${podeCriarPlanos ? `<button onclick="abrirCriarPlano()" style="width:48%; border: 1px solid gold; color: gold;">👑 Criar Assinatura</button>` : ''}
                    ${(perfil.lojaLiberada || perfil.tipo === 'admin') ? `<button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" style="width:48%">🏪 Minha Loja</button>` : gerarBotaoPro("🏪 Minha Loja", "abrirModalParaVender()", "tier3", perfil).replace('width:45%', 'width:48%')}
                    <button id="btnMinhasComprasBarbeiro" onclick="abrirMinhasCompras()" style="width:48%">🛍️ Minhas Compras</button>
                </div>
            </div>`;

        let htmlOperacional = `
            <div>
                <button class="super-btn" onclick="toggleSubMenu('menu_operacional', this)">⚙️ Clientes & Histórico</button>
                <div id="menu_operacional" class="sub-menu-container hidden"> <button onclick="abrirClientesBarbeiro()" style="width:48%">🧑‍🤝‍🧑 Lista Clientes</button>
                    <button onclick="abrirHistoricoBarbeiro()" style="width:48%">📜 Histórico Completo</button>
                     ${isDono ? `<button onclick="switchView('profissionais')" style="width:98%; border:1px solid #aaa;">👥 Gerenciar Equipe</button>` : ''}
                </div>
            </div>`;
            
        let htmlMarketing = `
            <div>
                <button class="super-btn" onclick="toggleSubMenu('menu_marketing', this)">🎨 Visual & Marketing</button>
                <div id="menu_marketing" class="sub-menu-container hidden"> <button onclick="abrirModalIdentidadeVisual()" style="width:100%; margin-bottom:5px;">📸 Identidade Visual</button>
                    ${temPermissaoPromo ? `<button onclick="abrirPromocoes()" style="width:48%">🎁 Criar Promoções</button>` : ''}
                    <button onclick="abrirModalTurbinar()" style="width:48%; background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b); color:#000;">🚀 Turbinar</button>
                    <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:48%">📍 Endereço</button>
                </div>
            </div>`;
            
        let htmlCarreira = `
            <div>
                <button class="super-btn" onclick="toggleSubMenu('menu_carreira', this)">🏆 Carreira & Comunidade</button>
                <div id="menu_carreira" class="sub-menu-container hidden"> <button id="btnVipPro" onclick="abrirModalVipPro()" style="width:100%; background: linear-gradient(45deg, var(--cor-destaque-azul), #00c6ff); color:white; font-weight:bold; margin-bottom:5px;">🌟 Assinar Plano PRO</button>
                    ${gerarBotaoPro("📸 Stories", "postarStory()", "tier4", perfil).replace('width:45%', 'width:48%')}
                     <button onclick="abrirModalBatalha()" style="width:48%">⚔️ Batalha</button>
                    <button onclick="abrirModalConquistasBarbeiro()" style="width:48%">🏅 Conquistas</button>
                    <button onclick="abrirModalRankingUnificado()" style="width:48%">📊 Ranking</button>
                    <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:48%">📰 Blog</button>
                    <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:48%">⭐ Avaliações</button>
                    <button onclick="abrirModalFidelidade()" style="width:48%">💎 Meus Pontos</button>
                </div>
            </div>`;
        
        // Renderiza
        contentDiv.innerHTML = htmlSOS + htmlGridPrincipal + htmlFinanceiro + htmlOperacional + htmlMarketing + htmlCarreira;

        // Mapa 3D Button Logic
        const containerMapa = document.getElementById('mapaBtnContainerBarbeiro');
        if (containerMapa) {
            containerMapa.innerHTML = '';
            const btnMapa = document.createElement('button');
            btnMapa.innerHTML = '🗺️ Mapa da Beleza (3D)';
            btnMapa.style.cssText = "width: 100%; margin-bottom: 10px; background: linear-gradient(45deg, #d4af37, #f1c40f); color: white; font-weight: bold; border-radius: 12px;";
            btnMapa.onclick = abrirMapaGeral;
            containerMapa.appendChild(btnMapa);
        }

        // --- FORÇAR GAVETA ABERTA AO INICIAR? NÃO! (REMOVIDO CÓDIGO QUE FORÇAVA ABRIR) ---
        const containerFuncoes = document.getElementById('barbeiroFuncoesContainer');
        const btnToggle = containerFuncoes ? containerFuncoes.previousElementSibling : null; 

        if (containerFuncoes) {
            // Apenas garante que o container pai esteja visível, mas as gavetas dentro estarão hidden
            containerFuncoes.classList.remove('hidden');
            containerFuncoes.style.display = 'block';
        }
        if (btnToggle && btnToggle.classList.contains('blinking-button')) {
            btnToggle.classList.remove('closed');
            btnToggle.classList.add('open');
        }
    }
}

function renderizarPainelClientePadrao() {
    const parent = document.getElementById('clienteFuncoesContainer');
    parent.innerHTML = ''; 
    const contentDiv = document.createElement('div');
    parent.appendChild(contentDiv);

    if (contentDiv) {
        // Verifica se tem convite (usando flag do perfil ou verificação em tempo real)
        const temConvite = perfil.temConvitesPendentes === true;
        
        // Define o estilo do botão baseado se tem convite ou não
        const estiloConvite = temConvite 
            ? 'background: #2c3e50; border: 1px solid #e74c3c; color: #fff;' // Com convite (Borda vermelha)
            : 'width:100%'; // Normal

        const badgeConvite = temConvite 
            ? '<span style="background:#e74c3c; color:#fff; font-size:10px; padding:2px 6px; border-radius:10px; font-weight:bold; margin-left:auto;">NOVO PEDIDO!</span>' 
            : '<span style="color:#666; margin-left:auto;">›</span>';

        let htmlAtividades = `
            <button class="super-btn" onclick="toggleSubMenu('menu_cli_atividades', this)">📝 Minhas Atividades</button>
            <div id="menu_cli_atividades" class="sub-menu-container hidden">
                
                <button onclick="abrirModalConvitesEquipe()" style="width:100%; display:flex; align-items:center; text-align:left; ${estiloConvite}">
                    <span>📩 Convites e Propostas</span>
                    ${badgeConvite}
                </button>

                <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:100%">📜 Meus Agendamentos / Histórico</button>
                <button onclick="abrirModalCarteira()" style="width:48%">💰 Minha Carteira</button>
                <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:48%">🛍️ Compras Loja</button>
                ${(perfil.lojaLiberada || perfil.tipo === 'admin') ? `<button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" style="width:100%; margin-top:5px;">🏪 Gerenciar Minha Loja</button>` : `<button onclick="abrirModal('modalSolicitarLoja')" style="width:100%; margin-top:5px; opacity:0.8; background:#333;">🏪 Quero Vender no App</button>`}
            </div>`;

        let htmlClube = `
            <button class="super-btn" onclick="toggleSubMenu('menu_cli_clube', this)">💎 Clube de Vantagens</button>
            <div id="menu_cli_clube" class="sub-menu-container hidden">
                 <button id="btnVip" onclick="abrirModalVip()" style="width:100%; margin-bottom:5px;">💎 Assinatura VIP</button>
                 <button onclick="abrirModalFidelidade()" style="width:48%">💎 Meus Pontos</button>
                 <button onclick="abrirModalBatalha()" style="width:48%">⚔️ Batalha</button>
                 <button onclick="abrirModalConquistas()" style="width:48%">🏅 Conquistas</button>
                 <button onclick="abrirModalRankingUnificado()" style="width:48%">📊 Ranking</button>
                 <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:100%; margin-top:5px;">📰 Blog & Códigos</button>
            </div>`;
            
        contentDiv.innerHTML = htmlAtividades + htmlClube;
        
        // Mapa 3D Button Logic
        const containerMapa = document.getElementById('mapaBtnContainerCliente');
        if (containerMapa) {
            containerMapa.innerHTML = ''; 
            const btnMapa = document.createElement('button');
            btnMapa.innerHTML = '🗺️ Mapa da Beleza (3D)';
            btnMapa.style.cssText = "width: 100%; margin-bottom: 10px; background: linear-gradient(45deg, #d4af37, #f1c40f); color: white; font-weight: bold; border-radius: 12px;";
            btnMapa.onclick = abrirMapaGeral;
            containerMapa.appendChild(btnMapa);
        }
        
        // Dispara uma verificação silenciosa para atualizar a flag se necessário
        verificarConvitesSilencioso();
    }
}

// --- FUNÇÕES DE CONVITE (EQUIPE/SECRETARIA) ---

// 1. Apenas verifica se tem convites para atualizar o visual do botão na próxima renderização
async function verificarConvitesSilencioso() {
    if(!auth.currentUser) return;
    const snap = await db.collection('convites')
        .where('destinatarioUid', '==', auth.currentUser.uid)
        .where('status', '==', 'pendente')
        .get();
    
    // Atualiza o perfil localmente para refletir na UI instantaneamente
    if (!snap.empty) {
        perfil.temConvitesPendentes = true;
    } else {
        perfil.temConvitesPendentes = false;
    }
}

// --- FUNÇÃO 1: LISTAR CONVITES (SEM POPUP DE CARREGAMENTO) ---
async function abrirModalConvitesEquipe() {
    // REMOVIDO: exibirAguarde("Buscando propostas..."); 
    
    try {
        const snapshot = await db.collection('solicitacoes')
            .where('destinatarioUid', '==', auth.currentUser.uid)
            .where('tipo', '==', 'convite_equipe')
            .where('status', '==', 'pendente')
            .get();

        // Não precisa fechar modal de aguarde pois não abrimos nenhum

        let listaConvites = [];
        snapshot.forEach(doc => {
            let d = doc.data();
            d.id = doc.id;
            listaConvites.push(d);
        });

        // Ordenação manual (Mais recente primeiro)
        listaConvites.sort((a, b) => {
            const timeA = a.ts && a.ts.seconds ? a.ts.seconds : 0;
            const timeB = b.ts && b.ts.seconds ? b.ts.seconds : 0;
            return timeB - timeA;
        });

        let htmlLista = '';
        
        if (listaConvites.length === 0) {
            htmlLista = `
                <div style="text-align:center; padding: 30px;">
                    <span style="font-size:40px; opacity:0.5;">📭</span>
                    <p style="color:#aaa; margin-top:10px;">Nenhum convite pendente.</p>
                </div>`;
        } else {
            listaConvites.forEach(d => {
                const tipoTexto = d.subtipo === 'secretaria_pede_emprego' ? 'SECRETÁRIA(O)' : 'PARCEIRO';
                const remetenteUid = d.remetenteUid || d.donoUid; 
                // Pegamos o nome da barbearia (remetenteNome)
                const nomeSalao = d.remetenteNome || 'Barbearia'; 
                
                const infoExtra = d.comissaoProposta ? `<br><span style="color:#2ecc71">Comissão: ${d.comissaoProposta}%</span>` : '';

                htmlLista += `
                <div style="background: #222; border: 1px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="color: #d4af37; font-size: 10px; font-weight: bold; margin-bottom: 5px;">PROPOSTA DE EMPREGO</div>
                    <div style="color: #fff; font-size: 14px; margin-bottom: 8px;">
                        <b>${nomeSalao}</b> convidou você para a equipe como <b>${tipoTexto}</b>.${infoExtra}
                    </div>
                    <div style="display:flex; gap: 10px; margin-top:10px;">
                        <button onclick="responderConviteEquipe('${d.id}', 'rejeitar', '${remetenteUid}', '${d.subtipo}', '${nomeSalao}')" style="flex:1; padding:8px; border-radius:5px; border:none; background:#333; color:#fff; cursor:pointer;">Recusar</button>
                        
                        <button onclick="responderConviteEquipe('${d.id}', 'aceitar', '${remetenteUid}', '${d.subtipo}', '${nomeSalao}')" style="flex:1; padding:8px; border-radius:5px; border:none; background:#27ae60; color:#fff; font-weight:bold; cursor:pointer;">Aceitar</button>
                    </div>
                </div>`;
            });
        }

        // Renderiza o Modal
        const anterior = document.getElementById('modalConvitesAtivos');
        if(anterior) anterior.remove();

        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.zIndex = '10000';
        modal.id = 'modalConvitesAtivos'; 
        modal.innerHTML = `
            <div class="modal-content">
                <h3>📩 Convites e Propostas</h3>
                <div style="max-height: 60vh; overflow-y: auto;">
                    ${htmlLista}
                </div>
                <div style="text-align:right; margin-top:15px;">
                    <button class="btn-padrao" onclick="document.getElementById('modalConvitesAtivos').remove()">Fechar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

    } catch (e) {
        console.error("ERRO LISTA:", e);
        alert("Erro ao buscar convites: " + e.message);
    }
}

// --- FUNÇÃO 2: RESPONDER (SALVA O NOME DA BARBEARIA) ---
async function responderConviteEquipe(conviteId, resposta, donoUid, subtipo, nomeSalao) {
    if(!conviteId) { alert("Erro: ID do convite inválido."); return; }

    // Aqui mantivemos um "Aguarde" rápido só para travar cliques duplos durante a gravação
    exibirAguarde("Atualizando perfil...");
    
    try {
        const batch = db.batch();
        const conviteRef = db.collection('solicitacoes').doc(conviteId);
        const meuRef = db.collection('usuarios').doc(auth.currentUser.uid);

        if (resposta === 'aceitar') {
            // 1. Marca convite como aceito
            batch.update(conviteRef, { status: 'aceito', respondidoEm: firebase.firestore.FieldValue.serverTimestamp() });
            
            // 2. ADICIONA O PROFISSIONAL NA EQUIPE DO DONO
            if(donoUid) {
                const donoRef = db.collection('usuarios').doc(donoUid);
                batch.update(donoRef, { 
                    equipe: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid) 
                });
            }

            // 3. ATUALIZA O SEU PERFIL (Salva o Nome!)
            const novoTipo = (subtipo === 'convite_secretaria' || subtipo === 'secretaria_pede_emprego') ? 'secretaria' : 'barbeiro';

            const updates = {
                tipo: novoTipo,
                vinculoSalao: donoUid,
                vagaImediata: true,
                
                // --- AQUI ESTÁ A CORREÇÃO DO NOME ---
                // Salvamos o objeto completo e o campo texto para garantir compatibilidade
                pertenceABarbearia: { uid: donoUid, nome: nomeSalao }, 
                nomeBarbearia: nomeSalao, 
                // ------------------------------------

                dataContratacao: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (novoTipo === 'secretaria') {
                updates.permissoes = ['agenda', 'clientes', 'caixa', 'produtos'];
            }

            batch.update(meuRef, updates);

        } else {
            // Apenas rejeita
            batch.update(conviteRef, { status: 'rejeitado', respondidoEm: firebase.firestore.FieldValue.serverTimestamp() });
        }

        await batch.commit();
        
        fecharTodosOsModais();
        const modalLista = document.getElementById('modalConvitesAtivos');
        if(modalLista) modalLista.remove();
        
        if (resposta === 'aceitar') {
            exibirPopup("Sucesso! 🥂", `Bem-vindo(a) à equipe ${nomeSalao}!`);
            setTimeout(() => window.location.reload(), 2000); 
        } else {
            exibirPopup("Feito", "Convite recusado.");
            if(typeof verificarConvitesSilencioso === 'function') verificarConvitesSilencioso();
        }

    } catch (e) {
        fecharTodosOsModais();
        console.error("ERRO RESPOSTA:", e);
        alert("Erro ao responder: " + e.message);
    }
}

async function removerMembroEquipe(uidAlvo, nomeAlvo) {
    const confirmar = confirm(`TEM CERTEZA?\n\nIsso removerá ${nomeAlvo} da equipe.\nEle voltará a ser Autônomo imediatamente.`);
    
    if (!confirmar) return;

    exibirAguarde("Desvinculando profissional...");

    try {
        const batch = db.batch();
        const alvoRef = db.collection('usuarios').doc(uidAlvo);
        const donoRef = db.collection('usuarios').doc(auth.currentUser.uid);

        // 1. LIMPEZA COMPLETA NO PROFISSIONAL (Remove TODOS os rastros da barbearia)
        batch.update(alvoRef, {
            // Remove o ID do vínculo
            vinculoSalao: firebase.firestore.FieldValue.delete(), 
            
            // Remove o Objeto Visual (AQUI QUE ESTAVA O ERRO, O NOME FICAVA PRESO)
            pertenceABarbearia: firebase.firestore.FieldValue.delete(),
            nomeBarbearia: firebase.firestore.FieldValue.delete(), 
            
            // Remove permissões e datas antigas
            permissoes: firebase.firestore.FieldValue.delete(),
            dataContratacao: firebase.firestore.FieldValue.delete(),
            
            // Força o status de Autônomo Disponível
            tipo: 'barbeiro', 
            vagaImediata: true, // <--- Libera o sinal de "Ocupado"
            
            dataDemissao: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. ATUALIZA A LISTA DO DONO (Remove do array visual da equipe)
        const donoDoc = await donoRef.get();
        if (donoDoc.exists) {
            let equipeAtual = donoDoc.data().equipe || [];
            
            // Filtra removendo o profissional
            const novaEquipe = equipeAtual.filter(membro => {
                const idMembro = typeof membro === 'string' ? membro : membro.uid;
                return idMembro !== uidAlvo;
            });

            batch.update(donoRef, { equipe: novaEquipe });
            
            // Atualiza localmente para sumir da tela na hora
            perfil.equipe = novaEquipe; 
        }

        await batch.commit();

        fecharTodosOsModais();
        exibirPopup("Concluído", `${nomeAlvo} foi removido e agora aparece como Autônomo.`);
        
        // Atualiza o painel da equipe (remove o card dele)
        if (typeof carregarVisaoGeralEquipe === 'function') carregarVisaoGeralEquipe();
        
        // Se estiver vendo a lista geral de barbeiros, força atualização
        if (typeof window.barbeirosListener === 'function') {
             // O próprio listener do Firestore vai detectar a mudança no 'pertenceABarbearia' e atualizar o card para "Autônomo" e liberar o botão 🤝
        }

    } catch (e) {
        console.error(e);
        fecharTodosOsModais();
        alert("Erro ao remover: " + e.message);
    }
}

function mudarFiltroNicho(novoNicho, containerId) {
    // 1. Atualiza a variável global
    window.filtroNichoAtual = novoNicho;

    // 2. Remove o filtro visual antigo para forçar ele a ser recriado com a classe 'active' certa
    // (Isso corrige um bug visual onde a cor do emoji não mudaria)
    const filterDivId = 'nicheFilterDiv_' + containerId;
    const filtroExistente = document.getElementById(filterDivId);
    if (filtroExistente) filtroExistente.remove();

    // 3. Recarrega a lista principal aplicando o novo filtro
    carregarBarbeirosPrincipal(containerId);
}

let chartInstance = null; // Variável global para destruir gráfico anterior

async function abrirModalDashboardBarbeiro(uidTarget) {
    // Se não passar ID, assume que é o usuário logado vendo o próprio
    const uidMembro = uidTarget || auth.currentUser.uid;
    const uidDono = auth.currentUser.uid; 
    
    // Verifica se sou eu mesmo ou se sou o dono vendo um membro
    const souDonoDoNegocio = perfil.isProprietario;
    const souEuMesmo = (auth.currentUser.uid === uidMembro);

    // Limpeza visual
    const anterior = document.getElementById('modalDashBarbeiro');
    if (anterior) anterior.remove();
    fecharTodosOsModais();
    exibirAguarde("Calculando métricas...");

    try {
        const docUser = await db.collection('usuarios').doc(uidMembro).get();
        if (!docUser.exists) throw new Error("Usuário não encontrado");
        const dados = docUser.data();
        
        let taxaSalao = parseFloat(dados.taxaComissao || dados.comissao || 0);
        if (isNaN(taxaSalao)) taxaSalao = 0;
        const pctBarbeiro = 100 - taxaSalao;

        const agora = new Date();
        const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
        const fimMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 0, 23, 59, 59);
        
        let queryAg = db.collection('agendamentos')
            .where('barbeiroUid', '==', uidMembro)
            .where('status', 'in', ['concluido', 'avaliado']);

        if (dados.tipo === 'dono' || uidMembro !== auth.currentUser.uid) {
             queryAg = queryAg.where('donoUid', '==', uidDono);
        }

        const [snapshotAg, snapshotPag] = await Promise.all([
            queryAg.get(),
            db.collection('pagamentos_equipe').where('recebedorUid', '==', uidMembro).get()
        ]);

        let acumuladoComissaoGlobal = 0;
        let totalPagoGlobal = 0;
        let liquidoMes = 0;
        let metodosMes = { pix:0, dinheiro:0, credito:0, debito:0 };
        let listaHistorico = [];

        snapshotAg.forEach(doc => {
            const d = doc.data();
            const val = parseFloat(d.valor) || 0;
            const comissao = val * (pctBarbeiro / 100);
            
            let dataServico = new Date();
            if(d.dataConclusao && d.dataConclusao.toDate) { dataServico = d.dataConclusao.toDate(); }
            else if(d.ts && d.ts.toDate) { dataServico = d.ts.toDate(); }
            else if(d.data) { dataServico = new Date(d.data + 'T00:00:00'); }

            acumuladoComissaoGlobal += comissao;

            if (dataServico >= inicioMes && dataServico <= fimMes) {
                liquidoMes += comissao;
                if (d.metodosPagamento) {
                    metodosMes.pix += (d.metodosPagamento.pix || 0);
                    metodosMes.dinheiro += (d.metodosPagamento.dinheiro || 0);
                    metodosMes.credito += (d.metodosPagamento.credito || 0);
                    metodosMes.debito += (d.metodosPagamento.debito || 0);
                } else {
                    metodosMes.dinheiro += val;
                }
            }

            listaHistorico.push({
                id: doc.id, 
                nomeCliente: d.nomeCliente || (d.clienteNome ? d.clienteNome : 'Cliente Avulso'),
                servico: d.servico || 'Serviço',
                hora: dataServico.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                dataCompleta: dataServico,
                dataLegivel: dataServico.toLocaleDateString('pt-BR'),
                dataISO: dataServico.toLocaleString('pt-BR'),
                valorComissao: comissao
            });
        });

        snapshotPag.forEach(doc => {
            const val = parseFloat(doc.data().valor) || 0;
            totalPagoGlobal += val;
        });

        let aReceber = acumuladoComissaoGlobal - totalPagoGlobal;
        if (aReceber < 0.1 && aReceber > -0.1) aReceber = 0;
        listaHistorico.sort((a, b) => b.dataCompleta - a.dataCompleta);
        
        fecharTodosOsModais(); 

        let htmlListaHistorico = '';
        if (listaHistorico.length === 0) {
            htmlListaHistorico = '<div style="text-align:center; color:#666; padding:20px;">Nenhum serviço realizado ainda.</div>';
        } else {
            listaHistorico.slice(0, 50).forEach(item => {
                // Lógica do botão de deletar preservada
                let deleteBtn = '';
                if (souDonoDoNegocio || souEuMesmo) {
                    deleteBtn = `
                    <button onclick="deletarRegistroFinanceiro('${item.id}', '${uidMembro}')" 
                            style="background: rgba(231, 76, 60, 0.1); color: #e74c3c; border: 1px solid rgba(231,76,60,0.3); width: 28px; height: 28px; border-radius: 6px; display:flex; align-items:center; justify-content:center; cursor:pointer; margin-left:10px;">
                        🗑️
                    </button>`;
                }

                // NOVO LAYOUT "EXTRATO PREMIUM" COM ID_BANCO INTEGRADO
                htmlListaHistorico += `
                <div class="card-extrato-premium" style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 3px solid #d4af37; border: 1px solid rgba(255,255,255,0.05); border-left: 4px solid #d4af37;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong style="display:block; font-size:14px; color:#fff;">${item.servico}</strong>
                            <span style="font-size:12px; color:#888;">Cliente: ${item.nomeCliente}</span>
                            <small style="display:block; color: #555; margin-top:2px;">${item.dataISO}</small>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="text-align:right;">
                                <div style="color: #2ecc71; font-weight: bold; font-size:15px;">
                                    + ${item.valorComissao.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                                </div>
                                <div style="color: #444; font-size: 9px; text-transform: uppercase; font-weight:bold;">Sua Comissão</div>
                            </div>
                            ${deleteBtn}
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 9px; color: #444; display: flex; justify-content: space-between; align-items: center;">
                        <span>DOC_ID: <span style="font-family:monospace;">${item.id}</span></span>
                        <span style="color:#d4af37; cursor:pointer; font-weight:bold; text-transform:uppercase; letter-spacing:0.5px;" 
                              onclick="navigator.clipboard.writeText('${item.id}'); alert('ID Copiado!')">
                              Copiar ID
                        </span>
                    </div>
                </div>`;
            });
        }

        const modal = document.createElement('div');
        modal.id = 'modalDashBarbeiro';
        modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 15000; overflow-y: auto; display: flex; flex-direction: column;`;
        
        modal.innerHTML = `
            <div style="padding: 20px; background: #111; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10;">
                <div>
                    <h2 style="color: #fff; margin:0; font-size:18px;">Desempenho</h2>
                    <span style="color: #888; font-size:12px;">${dados.nome}</span>
                </div>
                <button onclick="document.getElementById('modalDashBarbeiro').remove()" style="background:transparent; border:none; color:#fff; font-size:24px; cursor:pointer;">✕</button>
            </div>

            <div style="padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 12px; border-left: 4px solid #f1c40f;">
                        <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Líquido (Mês)</div>
                        <div style="font-size: 20px; color: #f1c40f; font-weight: bold; margin-top: 5px;">
                            ${liquidoMes.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                        </div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 12px; border-left: 4px solid #fff;">
                        <div style="color: #aaa; font-size: 11px; text-transform: uppercase;">Total Recebido</div>
                        <div style="font-size: 20px; color: #fff; font-weight: bold; margin-top: 5px;">
                            ${totalPagoGlobal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                        </div>
                    </div>
                    <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);">
                        <div style="color: #000; font-size: 12px; font-weight: 800; text-transform: uppercase;">A Receber (Acumulado)</div>
                        <div style="font-size: 28px; color: #000; font-weight: 900; margin-top: 0px;">
                            ${aReceber.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                        </div>
                        <div style="font-size: 10px; color: #004d26; font-weight:600;">Disponível para pagamento</div>
                    </div>
                </div>

                <div style="background: #181818; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333;">
                    <h4 style="color:#ccc; margin:0 0 15px 0; font-size:14px;">Balanço Financeiro</h4>
                    <div style="height: 200px; position: relative;">
                        <canvas id="chartBalanco"></canvas>
                    </div>
                </div>

                <h3 style="color: #fff; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; margin-top: 30px;">
                    📜 Histórico de Serviços (Últimos 50)
                </h3>
                <div id="listaHistoricoContainer">
                    ${htmlListaHistorico}
                </div>
                <br><br>
            </div>
        `;

        document.body.appendChild(modal);

        // Renderiza Gráfico
        new Chart(document.getElementById('chartBalanco').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['A Receber', 'Líquido (Mês)'],
                datasets: [{
                    data: [aReceber, liquidoMes],
                    backgroundColor: ['#2ecc71', '#f1c40f'], 
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { color: '#fff', font: {size: 12} } 
                    } 
                }
            }
        });
    } catch (e) {
        console.error(e);
        fecharTodosOsModais();
        alert("Erro ao carregar dashboard: " + e.message);
    }
}

// NOVA FUNÇÃO: DELETAR REGISTRO FINANCEIRO/AGENDAMENTO (COM LIMPEZA COMPLETA)
async function deletarRegistroFinanceiro(idAgendamento, uidMembro) {
    if (!confirm("⚠️ ATENÇÃO: Tem certeza que deseja excluir este registro?\nIsso removerá o serviço do histórico e recalculará os ganhos. Essa ação não pode ser desfeita.")) return;
    exibirAguarde("Excluindo registro de todos os bancos...");

    try {
        // --- ETAPA 1: Pega dados do agendamento antes de excluir (para achar o extrato) ---
        const agDoc = await db.collection('agendamentos').doc(idAgendamento).get();
        let dadosParaBusca = null;
        
        if (agDoc.exists) {
            const d = agDoc.data();
            dadosParaBusca = {
                valor: parseFloat(d.valor),
                barbeiroUid: d.barbeiroUid,
                donoUid: d.donoUid
            };
            // Deleta o agendamento (Isso limpa a visão do Profissional)
            await db.collection('agendamentos').doc(idAgendamento).delete();
            console.log("Agendamento deletado.");
        } else {
            console.warn("Agendamento já não existia, tentando limpar extratos orfãos...");
            // Se o agendamento não existe, tentamos limpar pelo menos pelo ID se ele foi usado como chave em algum lugar, 
            // mas sem dados de valor fica difícil achar o extrato exato se não tiver ID vinculado.
        }

        // --- ETAPA 2: Tenta encontrar e remover do Extrato Financeiro (Visão do Dono) ---
        // O extrato financeiro não tem o mesmo ID do agendamento, então buscamos por correspondência.
        // Critérios: Mesmo valor, mesmo profissional, mesmo dono e criado num intervalo de tempo próximo (ex: 24h).
        
        if (dadosParaBusca) {
            // Define uma janela de tempo ampla (ex: 7 dias) para garantir que ache mesmo se datas diferirem um pouco
            // (Melhor seria salvar o ID do agendamento no extrato na hora de criar, mas como paliativo:)
            
            // Busca extratos desse profissional e dono
            const snapshotExtrato = await db.collection('extrato_financeiro')
                .where('usuarioUid', '==', dadosParaBusca.barbeiroUid)
                .where('donoUid', '==', dadosParaBusca.donoUid)
                .where('valor', '==', dadosParaBusca.valor)
                .get();

            if (!snapshotExtrato.empty) {
                // Itera e deleta possíveis duplicatas ou o registro único
                const batch = db.batch();
                let deletouAlgo = false;
                
                snapshotExtrato.forEach(doc => {
                    // Aqui poderíamos refinar por data se necessário, mas assumindo que valor+usuário+dono é único o suficiente 
                    // para um "registro financeiro" específico que se quer deletar.
                    batch.delete(doc.ref);
                    deletouAlgo = true;
                });
                
                if (deletouAlgo) {
                    await batch.commit();
                    console.log("Registro correspondente no Extrato Financeiro deletado.");
                }
            } else {
                console.log("Nenhum extrato financeiro correspondente encontrado.");
            }
        }
        
        fecharTodosOsModais(); // Fecha o aguarde
        exibirPopup("Excluído", "Registro removido permanentemente de todos os relatórios!");
        
        // Recarrega o dashboard para ver o novo saldo
        setTimeout(() => {
            abrirModalDashboardBarbeiro(uidMembro);
        }, 500);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao excluir: " + e.message);
    }
}

// --- SISTEMA DE PROTEÇÃO CONTRA DUPLICIDADE ---
async function verificarTransacaoRecente(donoUid, valor, uidProfissional) {
    // Define um intervalo de tempo (ex: 2 minutos atrás)
    const doisMinutosAtras = new Date(Date.now() - 2 * 60 * 1000); 
    
    try {
        const snapshot = await db.collection('extrato_financeiro')
            .where('donoUid', '==', donoUid)
            .where('usuarioUid', '==', uidProfissional) // Mesmo profissional
            .where('valor', '==', valor) // Mesmo valor
            .where('ts', '>', doisMinutosAtras) // Feito agora pouco
            .get();

        if (!snapshot.empty) {
            console.warn("Bloqueado: Transação duplicada detectada.");
            return true; // EXISTE DUPLICIDADE!
        }
        return false; // Seguro para prosseguir
    } catch (e) {
        console.error("Erro ao verificar duplicidade:", e);
        return false; // Na dúvida, deixa passar (ou bloqueie se preferir segurança total)
    }
}

// Variável global para guardar o listener e poder cancelar ao fechar
let dashboardListener = null;

async function carregarDadosDashboardIndividual(uid, uidDono, taxa, isDonoPagando, nomeProfissional) {
    // Limpa listener anterior se houver
    if (dashboardListener) {
        dashboardListener();
        dashboardListener = null;
    }

    const containerLista = document.getElementById('dashListaHistorico');
    const elLiquido = document.getElementById('dashValorLiquido');
    const elBruto = document.getElementById('dashValorBruto');
    const elDetalhes = document.getElementById('dashDetalhesPagamento');

    containerLista.innerHTML = '<div class="spinner"></div>';

    // --- PARTE 1: LISTENER EM TEMPO REAL NO PERFIL DO USUÁRIO (MÉTRICAS INSTANTÂNEAS) ---
    // Isso faz o saldo subir na hora que o dono conclui lá no outro celular
    dashboardListener = db.collection('usuarios').doc(uid).onSnapshot(doc => {
        if (!doc.exists) return;
        const u = doc.data();

        // Pega os valores acumulados no banco (Fonte da Verdade)
        // Se não tiver o campo novo, usa 0
        const saldoPendente = u.faturamentoPendente || 0;
        const brutoTotal = (u.metrics && u.metrics.faturamentoBruto) ? u.metrics.faturamentoBruto : 0;
        
        // Atualiza a tela imediatamente
        if(elLiquido) elLiquido.textContent = formatarMoeda(saldoPendente);
        if(elBruto) elBruto.textContent = formatarMoeda(brutoTotal);
        
        if(elDetalhes) {
            elDetalhes.innerHTML = `<span style="color:${saldoPendente > 0 ? '#2ecc71' : '#aaa'}">🟢 Disponível para Saque/Pagamento</span>`;
        }

        // Atualiza o botão de pagar dinamicamente (se for o dono vendo)
        if (isDonoPagando) {
            const btnContainer = document.getElementById('dashBotaoPagarContainer');
            if (btnContainer) {
                btnContainer.innerHTML = `
                <button onclick="pagarSaldoV2('${uid}', '${nomeProfissional}', ${saldoPendente})" 
                    style="width:100%; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; font-size:14px; margin-top:10px;
                    background:${saldoPendente > 0 ? 'linear-gradient(45deg, #f39c12, #e67e22)' : '#333'}; 
                    color:${saldoPendente > 0 ? '#fff' : '#777'}; transition:0.2s;"
                    ${saldoPendente <= 0 ? 'disabled' : ''}>
                    ${saldoPendente > 0 ? '💸 PAGAR E ZERAR SALDO' : '✅ NADA A PAGAR'}
                </button>`;
            }
        }
    });

    // --- PARTE 2: CARREGAR HISTÓRICO (LISTA VISUAL) ---
    // Isso pode ser uma query normal (get) pois o histórico não precisa ser tão instantâneo quanto o saldo
    try {
        const snapshotTotal = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uid)
            .where('status', 'in', ['concluido', 'avaliado'])
            .orderBy('ts', 'desc')
            .limit(30)
            .get();

        let htmlLista = '';
        let tPix = 0, tDin = 0, tDeb = 0, tCred = 0;

        snapshotTotal.forEach(doc => {
            const d = doc.data();
            const valBruto = parseFloat(d.valor) || 0;
            
            // Recalcula visualmente quanto foi a parte dele nesse serviço
            // Nota: Isso é visual. O saldo real é o que pegamos no listener acima.
            const descontoSalao = valBruto * (taxa / 100);
            const liquidoSuaParte = valBruto - descontoSalao;

            // Soma métodos para o gráfico
            if (d.metodosPagamento) {
                tPix += (d.metodosPagamento.pix || 0);
                tDin += (d.metodosPagamento.dinheiro || 0);
                tDeb += (d.metodosPagamento.debito || 0);
                tCred += (d.metodosPagamento.credito || 0);
            } else {
                tDin += valBruto;
            }

            htmlLista += `
                <div style="background:#222; margin-bottom:5px; padding:10px; border-radius:6px; border-left: 3px solid #2ecc71; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="color:#fff; font-size:12px;">${d.servico}</div>
                        <div style="color:#666; font-size:9px;">${d.ts ? d.ts.toDate().toLocaleDateString('pt-BR') : '-'}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#2ecc71; font-weight:bold; font-size:12px;">+ ${formatarMoeda(liquidoSuaParte)}</div>
                        <div style="color:#555; font-size:9px;">Bruto: ${formatarMoeda(valBruto)}</div>
                    </div>
                </div>`;
        });

        containerLista.innerHTML = htmlLista || '<p style="text-align:center; opacity:0.5; font-size:12px;">Nenhum serviço recente.</p>';

        // Renderiza Gráfico de Métodos
        const ctx = document.getElementById('chartMetodosIndividual');
        const legContainer = document.getElementById('legendaMetodosIndividual');
        
        if (ctx && legContainer) {
            if (window.chartIndividualInstance) window.chartIndividualInstance.destroy();

            // Legenda HTML
            legContainer.innerHTML = `
                <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #333; padding-bottom:2px;">
                    <span style="color:#00C851">Pix</span> <b>R$ ${tPix.toFixed(2)}</b>
                </div>
                <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #333; padding-bottom:2px;">
                    <span style="color:#33b5e5">Dinheiro</span> <b>R$ ${tDin.toFixed(2)}</b>
                </div>
                <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #333; padding-bottom:2px;">
                    <span style="color:#ffbb33">Débito</span> <b>R$ ${tDeb.toFixed(2)}</b>
                </div>
                <div style="font-size:11px; color:#aaa; display:flex; justify-content:space-between; width:100%;">
                    <span style="color:#ff4444">Crédito</span> <b>R$ ${tCred.toFixed(2)}</b>
                </div>
            `;

            // Gráfico
            let dadosChart = [tPix, tDin, tDeb, tCred];
            let coresChart = ['#00C851', '#33b5e5', '#ffbb33', '#ff4444'];
            if (tPix+tDin+tDeb+tCred === 0) { dadosChart = [1]; coresChart = ['#333']; }

            window.chartIndividualInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pix', 'Dinheiro', 'Débito', 'Crédito'],
                    datasets: [{
                        data: dadosChart,
                        backgroundColor: coresChart,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

    } catch (e) {
        console.error("Erro lista:", e);
        containerLista.innerHTML = `<p style="color:red; text-align:center;">Erro: ${e.message}</p>`;
    }
}

// --- FUNÇÃO DE CONFIGURAÇÃO DE HORÁRIOS ---
// --- FUNÇÃO AJUSTADA (SEM POPUP DE CARREGAMENTO) ---
async function abrirConfiguracaoHorario() {
    fecharTodosOsModais(); // Fecha qualquer coisa que esteja aberta antes

    try {
        const uid = auth.currentUser.uid;
        
        // Busca os dados (sem bloquear a tela)
        const docUser = await db.collection('usuarios').doc(uid).get();
        const dados = docUser.data();

        // Valores Padrão (caso nunca tenha configurado)
        const hInicio = dados.horarioInicio || "09:00";
        const hFim = dados.horarioFim || "19:00";
        const aInicio = dados.almocoInicio || "12:00";
        const aFim = dados.almocoFim || "13:00";

        // CRIA O MODAL DINAMICAMENTE
        const modal = document.createElement('div');
        modal.id = 'modalConfigHorario';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 20000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        `;

        modal.innerHTML = `
        <div style="background: #181818; width: 90%; max-width: 400px; border-radius: 20px; border: 1px solid #333; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.8); position:relative;">
            
            <div style="padding:20px; background:linear-gradient(to right, #1f1f1f, #181818); border-bottom:1px solid #333; text-align:center;">
                <h2 style="color:#d4af37; margin:0; font-size:18px;">⏰ Meu Expediente</h2>
                <p style="color:#888; font-size:12px; margin:5px 0 0 0;">Configure sua disponibilidade diária</p>
            </div>

            <div style="padding:25px;">
                
                <div style="margin-bottom:25px;">
                    <label style="color:#fff; font-weight:bold; font-size:14px; display:block; margin-bottom:10px;">💼 Horário de Trabalho</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="flex:1;">
                            <span style="color:#aaa; font-size:11px;">Início</span>
                            <input type="time" id="inputInicio" value="${hInicio}" 
                                style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:12px; border-radius:8px; font-size:16px; outline:none; text-align:center;">
                        </div>
                        <span style="color:#666;">até</span>
                        <div style="flex:1;">
                            <span style="color:#aaa; font-size:11px;">Fim</span>
                            <input type="time" id="inputFim" value="${hFim}" 
                                style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:12px; border-radius:8px; font-size:16px; outline:none; text-align:center;">
                        </div>
                    </div>
                </div>

                <hr style="border:0; border-top:1px dashed #333; margin:20px 0;">

                <div style="margin-bottom:25px;">
                    <label style="color:#fff; font-weight:bold; font-size:14px; display:block; margin-bottom:10px;">🍽️ Pausa para Almoço</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div style="flex:1;">
                            <span style="color:#aaa; font-size:11px;">Saída</span>
                            <input type="time" id="inputAlmocoInicio" value="${aInicio}" 
                                style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:12px; border-radius:8px; font-size:16px; outline:none; text-align:center;">
                        </div>
                        <span style="color:#666;">até</span>
                        <div style="flex:1;">
                            <span style="color:#aaa; font-size:11px;">Volta</span>
                            <input type="time" id="inputAlmocoFim" value="${aFim}" 
                                style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:12px; border-radius:8px; font-size:16px; outline:none; text-align:center;">
                        </div>
                    </div>
                    <p style="color:#555; font-size:10px; margin-top:5px; text-align:center;">*Horários iguais = Sem pausa.</p>
                </div>

                <div style="display:flex; gap:10px;">
                    <button onclick="document.getElementById('modalConfigHorario').remove()" 
                        style="flex:1; padding:15px; background:transparent; border:1px solid #444; color:#aaa; border-radius:10px; cursor:pointer; font-weight:bold;">
                        Cancelar
                    </button>
                    <button onclick="salvarConfiguracaoHorario()" 
                        style="flex:1.5; padding:15px; background:linear-gradient(45deg, #d4af37, #f1c40f); border:none; color:#000; border-radius:10px; cursor:pointer; font-weight:bold; font-size:16px;">
                        Salvar
                    </button>
                </div>

            </div>
        </div>
        `;

        document.body.appendChild(modal);

    } catch (e) {
        console.error(e);
        // Se der erro (ex: sem internet), aí sim avisa
        alert("Erro ao abrir configurações: " + e.message);
    }
}

// --- FUNÇÃO PARA SALVAR NO BANCO ---
async function salvarConfiguracaoHorario() {
    const inicio = document.getElementById('inputInicio').value;
    const fim = document.getElementById('inputFim').value;
    const almocoInicio = document.getElementById('inputAlmocoInicio').value;
    const almocoFim = document.getElementById('inputAlmocoFim').value;

    if (!inicio || !fim) return alert("Preencha o horário de início e fim do expediente.");

    // Fecha modal visualmente
    document.getElementById('modalConfigHorario').remove();
    exibirAguarde("Salvando alterações...");

    try {
        const uid = auth.currentUser.uid;
        
        await db.collection('usuarios').doc(uid).update({
            horarioInicio: inicio,
            horarioFim: fim,
            almocoInicio: almocoInicio,
            almocoFim: almocoFim
        });

        // Opcional: Se você usa geração automática de slots, 
        // talvez precise chamar uma função aqui para regenerar a agenda do dia
        // Ex: gerarAgendaDoDia(uid); 

        fecharTodosOsModais();
        exibirPopup("Sucesso", "Seus horários foram atualizados!");

    } catch (e) {
        fecharTodosOsModais();
        alert("Erro ao salvar: " + e.message);
    }
}

// --- FUNÇÃO PARA SALVAR A TAXA CORRETAMENTE (CORREÇÃO DE GRAVAÇÃO) ---
async function salvarAlteracaoMembro(uidMembro) {
    // 1. Pega os inputs do modal de edição (Use os IDs que estão no seu HTML)
    // Se seus inputs tiverem outros IDs, ajuste aqui.
    const inputNome = document.getElementById('editNomeMembro'); 
    const inputTaxa = document.getElementById('editTaxaMembro'); // O input onde vc digita a %

    if (!inputTaxa) {
        alert("Erro: Campo de taxa não encontrado no código.");
        return;
    }

    exibirAguarde("Salvando alterações...");

    try {
        // 2. Limpeza do valor (transforma "40,00%" em 40)
        let valorBruto = inputTaxa.value;
        // Remove % e troca virgula por ponto
        let valorLimpo = parseFloat(valorBruto.replace('%', '').replace(',', '.'));

        if (isNaN(valorLimpo)) valorLimpo = 0;

        console.log(`Salvando para ${uidMembro}: Taxa ${valorLimpo}%`);

        // 3. GRAVAÇÃO NO BANCO DE DADOS (A CORREÇÃO ESTÁ AQUI)
        // Atualizamos direto na coleção 'usuarios' que é onde o painel do barbeiro lê
        await db.collection('usuarios').doc(uidMembro).update({
            taxaComissao: valorLimpo,  // Grava como Número
            comissao: valorLimpo       // Grava com outro nome tbm por garantia
        });

        // 4. Finalização
        fecharTodosOsModais();
        exibirPopup("Sucesso", "Taxa de comissão atualizada!");
        
        // Recarrega a lista para vc ver
        if (typeof carregarMinhaEquipe === 'function') carregarMinhaEquipe();

    } catch (erro) {
        console.error(erro);
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao atualizar perfil: " + erro.message);
    }
}

// Função auxiliar para carregar o gráfico e lista (MANTIDA/AJUSTADA)
async function carregarDadosFinanceiroProfissional() {
    const elSaldoTotal = document.getElementById('dashSaldoTotal');
    const listaDetalhes = document.getElementById('dashboardConteudo');
    const agora = new Date();
    const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1); 
    inicioMes.setHours(0,0,0,0);

    try {
        const snap = await db.collection('extrato_financeiro')
            .where('usuarioUid', '==', auth.currentUser.uid)
            .where('dataEvento', '>=', firebase.firestore.Timestamp.fromDate(inicioMes))
            .get();

        let ganhosLiquidosMes = 0;
        const mapaDias = {};
        const itensLista = [];

        snap.forEach(doc => {
            const d = doc.data();
            const data = d.dataEvento.toDate();
            
            // FILTRO DE SERVIÇOS (Soma no Total do Mês)
            if (d.tipo === 'receita_servico' || d.tipo === 'ganho_pessoal' || d.tipo_secundario === 'ganho_pessoal') {
                const valorLiquido = (d.valorComissao !== undefined) ? Number(d.valorComissao) : Number(d.valor);
                ganhosLiquidosMes += valorLiquido;

                const diaStr = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                mapaDias[diaStr] = (mapaDias[diaStr] || 0) + valorLiquido;

                itensLista.push({ tipo: 'servico', texto: d.descricao, valor: valorLiquido, data: data });
            }
            // FILTRO DE PAGAMENTOS (Apenas exibe na lista, não soma na produção)
            else if (d.tipo === 'pagamento_comissao') {
                itensLista.push({ tipo: 'pagamento', texto: "💰 PAGAMENTO RECEBIDO", valor: Number(d.valor), data: data });
            }
        });

        if(elSaldoTotal) elSaldoTotal.textContent = `R$ ${ganhosLiquidosMes.toFixed(2)}`;

        // Renderiza Lista
        itensLista.sort((a, b) => b.data - a.data);
        let htmlLista = '';
        itensLista.forEach(item => {
            if (item.tipo === 'pagamento') {
                htmlLista += `<div class="card" style="padding:10px; margin-bottom:5px; background: rgba(46, 204, 113, 0.15); border: 1px solid #2ecc71;"><div style="display:flex; justify-content:space-between;"><span>${item.texto}</span><span style="color:#fff;">${item.data.toLocaleDateString()}</span></div><div style="text-align:right; font-weight:bold; color:#fff;">R$ ${item.valor.toFixed(2)}</div></div>`;
            } else {
                htmlLista += `<div style="padding:10px; border-bottom:1px solid #333;"><div style="display:flex; justify-content:space-between;"><span style="font-size:12px; color:#ccc;">${item.texto}</span><span style="font-size:12px; color:var(--cor-destaque);">+ R$ ${item.valor.toFixed(2)}</span></div><small style="color:#666;">${item.data.toLocaleString()}</small></div>`;
            }
        });
        if(listaDetalhes) listaDetalhes.innerHTML = htmlLista || '<p style="text-align:center; opacity:0.5;">Sem registros.</p>';

        // Renderiza Gráfico
        const ctx = document.getElementById('financeiroChart').getContext('2d');
        if (window.meuGrafico instanceof Chart) window.meuGrafico.destroy();
        window.meuGrafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(mapaDias).sort(),
                datasets: [{ label: 'Comissão (R$)', data: Object.keys(mapaDias).sort().map(k => mapaDias[k]), backgroundColor: '#d4af37', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { beginAtZero: true, grid: { color: '#333' } } }, plugins: { legend: { display: false } } }
        });

    } catch (e) { console.error(e); }
}

async function definirMetaFinanceira() {
    const atual = perfil.metaMensal || 2000;
    const novaMeta = prompt("Defina sua meta de faturamento mensal (R$):", atual);
    
    if (novaMeta) {
        const valor = parseFloat(novaMeta);
        if (isNaN(valor) || valor <= 0) return alert("Valor inválido.");
        
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ metaMensal: valor });
        exibirPopup("Meta Atualizada!", `Vamos buscar esses R$ ${valor}!`);
        abrirModalDashboardBarbeiro(); // Recarrega para ver a barra mudar
    }
}

async function abrirModalPortfolioBarbeiro() {
    abrirModal('modalPortfolioBarbeiro');
    
    // Cancela o listener anterior se ele estiver ativo
    if (portfolioListener) {
        portfolioListener();
        portfolioListener = null;
    }

    imagensMarcadasParaExcluir = [];

    // --- INÍCIO DA MODIFICAÇÃO (Task 2) ---
    // Aguarda o carregamento inicial (get()) antes de continuar
    // Isso garante que o 'perfil' esteja atualizado
    await carregarPortfolioExistente();
    // --- FIM DA MODIFICAÇÃO ---

    // --- Configuração do Input de Novos Arquivos ---
    const fileInput = document.getElementById('portfolioFilesInput');
    const previewContainer = document.getElementById('portfolioPreviews');
    const progressBar = document.getElementById('portfolioUploadProgress');
    const btnSalvar = document.getElementById('btnSalvarPortfolio');

    // Limpa seleções anteriores do input e previews
    fileInput.value = '';
    previewContainer.innerHTML = '';
    progressBar.style.display = 'none';
    progressBar.value = 0;

    // Remove listener antigo para evitar duplicação
    fileInput.onchange = null;

    // Adiciona novo listener para preview e habilita/desabilita botão
    fileInput.onchange = () => {
        previewContainer.innerHTML = ''; // Limpa previews antigos
        const files = fileInput.files;
        
        // Usa 'perfil' que é atualizado pelo listener/get
        const portfolioAtual = (perfil?.portfolio || []).length; 
        const imagensMarcadas = imagensMarcadasParaExcluir.length;
        // Calcula o espaço baseado em quantas imagens VÃO SOBRAR
        const espacoDisponivel = 30 - (portfolioAtual - imagensMarcadas);

        if (files.length > 0) {
            if (files.length > espacoDisponivel) {
                exibirPopup('Limite Excedido', `Você pode adicionar no máximo mais ${espacoDisponivel} imagens (total de 30).`);
                fileInput.value = ''; // Limpa a seleção inválida
                btnSalvar.disabled = true; // Mantém desabilitado
                return;
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '60px';
                    img.style.height = '60px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
            btnSalvar.disabled = false; // Habilita o botão se houver arquivos válidos
        } else {
            // Habilita salvar se houver apenas exclusões
            btnSalvar.disabled = imagensMarcadasParaExcluir.length === 0;
        }
    };

    // Atualiza o estado do contador e do input (caso já tenha 30 imagens)
    atualizarContadorEInputPortfolio();
}

// 2. ADICIONE ESTA NOVA FUNÇÃO (Função de ajuda)
function atualizarContadorEInputPortfolio() {
    // Garante que está lendo o 'perfil' mais recente
    const portfolioUrls = perfil?.portfolio || [];
    const contadorElement = document.getElementById('portfolioContador');
    const fileInput = document.getElementById('portfolioFilesInput');
    const labelFileInput = document.getElementById('labelPortfolioFiles');
    const btnSalvarPortfolio = document.getElementById('btnSalvarPortfolio');

    // Calcula quantas imagens "contam" (total - marcadas para excluir)
    const imagensAtuaisContagem = portfolioUrls.length - imagensMarcadasParaExcluir.length;
    if (contadorElement) {
         contadorElement.textContent = imagensAtuaisContagem;
    }

    const espacoDisponivel = 30 - imagensAtuaisContagem;
    if (fileInput && labelFileInput) {
        fileInput.disabled = espacoDisponivel <= 0;
        labelFileInput.textContent = espacoDisponivel <= 0
            ? "Limite de 30 imagens atingido."
            : `Adicionar Novas Imagens (${espacoDisponivel} restantes)`;
        
        // Se o espaço for 0, limpa qualquer seleção de arquivo
        if (espacoDisponivel <= 0) {
            fileInput.value = ''; 
            document.getElementById('portfolioPreviews').innerHTML = ''; // Limpa previews de novas
        }
    }
    
    if(btnSalvarPortfolio) {
         const novosArquivosSelecionados = fileInput.files && fileInput.files.length > 0;
         // O botão só fica desabilitado se NÃO houver novos arquivos E NÃO houver exclusões marcadas
         btnSalvarPortfolio.disabled = (!novosArquivosSelecionados && imagensMarcadasParaExcluir.length === 0);
    }
}

// --- FUNÇÃO DE EMERGÊNCIA: REPOPULAR O EM ALTA ---
async function adminRepopularEmAlta() {
    if (!confirm("Isso vai varrer todos os usuários Diamante e copiar as fotos do portfólio para o Em Alta. Continuar?")) return;

    exibirAguarde("Sincronizando fotos antigas...");
    
    try {
        // 1. Busca todos os usuários que são Tier 4
        const snap = await db.collection('usuarios')
            .where('proTier', '==', 'tier4')
            .where('proAtivo', '==', true)
            .get();

        if (snap.empty) {
            fecharTodosOsModais();
            return exibirPopup("Aviso", "Nenhum usuário Diamante (Tier 4) encontrado.");
        }

        let totalProcessado = 0;

        // 2. Itera sobre cada usuário
        // Usamos for...of para garantir que o await funcione sequencialmente e não trave o navegador
        for (const doc of snap.docs) {
            const u = doc.data();
            const uid = doc.id;

            // Se tiver portfólio, manda ver
            if (u.portfolio && u.portfolio.length > 0) {
                for (const url of u.portfolio) {
                    // Ignora strings especiais de Antes/Depois por enquanto para evitar erros
                    if (url.startsWith("BA|")) continue;

                    // Usa a função que criamos no passo anterior
                    // Ela já verifica se existe duplicata antes de salvar
                    await sincronizarComEmAlta(url, uid, u.nome);
                    totalProcessado++;
                }
            }
        }

        fecharTodosOsModais();
        exibirPopup("Sucesso!", `${totalProcessado} fotos antigas foram verificadas e sincronizadas!`);
        
        // Recarrega a tela para você ver a mágica
        setTimeout(() => {
            if(document.getElementById('emAltaView').classList.contains('hidden') === false) {
                carregarFeedEmAlta();
            }
        }, 1000);

    } catch (e) {
        console.error(e);
        fecharTodosOsModais();
        exibirPopup("Erro", e.message);
    }
}

async function salvarAlteracoesPortfolio() {
    const fileInput = document.getElementById("portfolioFilesInput");
    const progressBar = document.getElementById('portfolioUploadProgress');
    const btnSalvar = document.getElementById('btnSalvarPortfolio');
    const userId = auth.currentUser.uid;
    const files = fileInput.files;

    const portfolioAtual = perfil?.portfolio || [];
    const imagensExistentesParaManter = portfolioAtual.filter(url => !imagensMarcadasParaExcluir.includes(url));
    const totalImagensFinais = imagensExistentesParaManter.length + (files ? files.length : 0);
    
    if (totalImagensFinais > 30) {
        return exibirPopup(`O limite é 30 imagens. Você está tentando salvar ${totalImagensFinais}.`);
    }
    if (files.length === 0 && imagensMarcadasParaExcluir.length === 0) {
        btnSalvar.disabled = true;
        return exibirPopup("Nenhuma alteração detectada.", "Nenhuma imagem nova selecionada ou marcada para exclusão.");
    }

    exibirAguarde("Salvando alterações no portfólio...");
    btnSalvar.disabled = true;
    progressBar.style.display = 'block';
    progressBar.value = 0;

    const uploadPromises = [];
    const newImageUrls = []; // Vamos guardar as novas URLs aqui
    let totalBytesUpload = 0;
    const uploadTasksInfo = [];

    if (files && files.length > 0) {
        totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
        Array.from(files).forEach((file, index) => {
            const filePath = `portfolio/${userId}/${Date.now()}_${index}_${file.name}`;
            const uploadPromise = new Promise((resolve, reject) => {
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);
                const taskInfo = { task: uploadTask, bytesTransferred: 0 };
                uploadTasksInfo.push(taskInfo);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        taskInfo.bytesTransferred = snapshot.bytesTransferred;
                        let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                        const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                        progressBar.value = progress;
                    },
                    (error) => reject(error),
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            newImageUrls.push(downloadURL); // Guarda URL
                            resolve();
                        } catch(urlError) { reject(urlError); }
                    }
                );
            });
            uploadPromises.push(uploadPromise);
        });
    }

    try {
        await Promise.all(uploadPromises);

        const deletePromises = imagensMarcadasParaExcluir.map(async url => {
            try {
                const imageRef = storage.refFromURL(url);
                await imageRef.delete();
            } catch (e) {
                if (e.code !== 'storage/object-not-found') {
                     notifyAdmins("⚠️ Falha ao deletar", `Erro: ${e.code}`);
                }
            }
        });
        await Promise.all(deletePromises);

        const finalImageUrls = [...imagensExistentesParaManter, ...newImageUrls];

        await db.collection('usuarios').doc(userId).update({
            portfolio: finalImageUrls
        });
        
        perfil = (await db.collection('usuarios').doc(userId).get()).data();

        // --- AUTOMAÇÃO: MANDA NOVAS FOTOS PRO EM ALTA ---
        if (newImageUrls.length > 0) {
            newImageUrls.forEach(url => {
                sincronizarComEmAlta(url, userId, perfil.nome);
            });
        }

        fecharTodosOsModais(); 
        exibirPopup('Sucesso!', 'Seu portfólio foi atualizado.');

        fileInput.value = '';
        document.getElementById('portfolioPreviews').innerHTML = '';
        progressBar.style.display = 'none';
        btnSalvar.disabled = true;
        imagensMarcadasParaExcluir = [];

        if (fluxoPosCadastroAtivo) {
             fecharModalAtual();
             const perfilAtualizado = (await db.collection('usuarios').doc(userId).get()).data();
             if (perfilAtualizado.portfolio && perfilAtualizado.portfolio.length > 0) {
                  abrirModalComConfirmacao('modalAddPromocao', '🎁 Adicionar Promoção (Opcional)'); 
             } else {
                  exibirPopup("Portfólio Obrigatório", "Você precisa adicionar pelo menos uma imagem.");
                  abrirModalComConfirmacao('modalPortfolioBarbeiro', '🖼️ Adicionar ao Portfólio');
             }
         }

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup('Erro ao salvar portfólio: ' + (error.message || error));
        btnSalvar.disabled = false; 
        progressBar.style.display = 'none';
    }
}

// Variáveis globais para o detalhe (Mantenha se já não tiver)
let altaDetalheId = null; 
let altaDetalheDados = null; 
let altaUnsubscribeComments = null;
let altaUnsubscribeLikes = null;

let unsubscribeEmAlta = null;

function carregarFeedEmAlta() {
    // ADICIONE ESTA LINHA NO COMEÇO:
    atualizarProgressoMissao('ver_em_alta');
    // -----------------------------

    const container = document.getElementById('gridEmAlta');
    if (container) container.classList.remove('em-alta-grid');

    // Se já tiver um listener rodando, não recria o HTML, apenas deixa atualizar
    if (unsubscribeEmAlta) {
        // Se quiser forçar recarga visual completa, descomente abaixo:
        // unsubscribeEmAlta(); unsubscribeEmAlta = null;
        // Mas para fluidez, se já está rodando, não faz nada.
        return; 
    }

    container.innerHTML = '<div class="spinner" style="margin: 50px auto;"></div>';

    if(typeof atualizarProgressoMissao === 'function') atualizarProgressoMissao('ver_em_alta');

    // Query em tempo real
    const query = db.collection('batalha_likes')
        .orderBy('count', 'desc') 
        .limit(100);

    unsubscribeEmAlta = query.onSnapshot(snap => {
        // Remove spinner na primeira carga
        const spinner = container.querySelector('.spinner');
        if(spinner) container.innerHTML = '<div class="em-alta-grid"></div>';
        
        const grid = container.querySelector('.em-alta-grid');
        
        // Limpa a lista global para manter sincronizado
        // Nota: Em atualizações "modified", não precisamos limpar, mas em "added"/"removed" sim.
        // Para simplificar a lógica de ordenação (já que a ordem muda com os likes),
        // vamos reconstruir o array de dados, mas atualizar o DOM com inteligência.
        
        listaEmAltaGlobal = [];
        snap.forEach(doc => {
            const d = doc.data();
            if (d.imgUrl && d.ownerTier === 'tier4') {
                listaEmAltaGlobal.push({ id: doc.id, ...d });
            }
        });

        // Loop nas mudanças do banco
        snap.docChanges().forEach(change => {
            const d = change.doc.data();
            const docId = change.doc.id;
            
            // Só nos importam itens Tier 4 com imagem
            if (!d.imgUrl || d.ownerTier !== 'tier4') return;

            // Calcula total de likes
            const likesFeed = (d.likedBy && Array.isArray(d.likedBy)) ? d.likedBy.length : 0;
            const totalLikes = (d.count || 0) + likesFeed;

            if (change.type === 'added') {
                // Adiciona novo item na Grid
                const item = criarElementoEmAlta(d, docId, totalLikes, listaEmAltaGlobal.length - 1);
                grid.appendChild(item);
            }
            
            if (change.type === 'modified') {
                // ATUALIZAÇÃO SUAVE: Acha o elemento e muda só o texto
                const cardExistente = document.getElementById(`card-alta-${docId}`);
                if (cardExistente) {
                    const badgeLike = cardExistente.querySelector('.em-alta-likes-text');
                    if (badgeLike) {
                        // Efeito visual de pulso no número
                        badgeLike.style.transform = "scale(1.5)";
                        badgeLike.style.color = "#ff4500"; // Laranja temporário
                        badgeLike.textContent = `❤️ ${totalLikes}`;
                        
                        setTimeout(() => {
                            badgeLike.style.transform = "scale(1)";
                            badgeLike.style.color = "white";
                        }, 300);
                    }
                } else {
                    // Se não achou (caso raro de ordenação), recria
                    const item = criarElementoEmAlta(d, docId, totalLikes, 0); 
                    grid.appendChild(item);
                }
            }

            if (change.type === 'removed') {
                const card = document.getElementById(`card-alta-${docId}`);
                if (card) card.remove();
            }
        });

    }, error => {
        console.error(error);
        if(container.innerHTML.includes('spinner')) 
            container.innerHTML = '<p style="text-align:center;">Erro ao carregar feed.</p>';
    });
}

// Função auxiliar para criar o HTML do card (Evita repetição)
function criarElementoEmAlta(d, docId, totalLikes, indexVirtual) {
    const item = document.createElement('div');
    item.className = 'em-alta-item';
    item.id = `card-alta-${docId}`; // ID único para encontrar depois
    
    // Precisamos de um jeito de pegar o índice correto ao clicar
    item.onclick = () => {
        // Recalcula índice baseado na lista global atualizada
        const idx = listaEmAltaGlobal.findIndex(x => x.id === docId);
        if(idx !== -1) abrirPlayerEmAlta(idx);
    };

    item.innerHTML = `
        <img src="${d.imgUrl}" class="em-alta-img" loading="lazy">
        <div class="em-alta-badge">💎 TOP</div>
        <div class="em-alta-overlay">
            <div class="em-alta-stats">
                <span class="em-alta-likes-text" style="transition: all 0.3s;">❤️ ${totalLikes}</span>
                <span style="opacity:0.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80px;">${d.ownerName}</span>
            </div>
        </div>
    `;
    return item;
}

// --- 2. ABRIR O PLAYER (MODAL TELA CHEIA - COM PODER DE ADMIN) ---
function abrirPlayerEmAlta(index) {
    if (index < 0 || index >= listaEmAltaGlobal.length) return;

    indexEmAltaAtual = index;
    const dados = listaEmAltaGlobal[index];
    
    const modal = document.getElementById('modalDetalhesEmAlta');
    const modalContent = modal.querySelector('.modal-content');
    
    // --- LÓGICA DE PERMISSÃO (Dono ou Admin) ---
    let btnDeleteHtml = '';
    
    const euSouDono = auth.currentUser && auth.currentUser.uid === dados.ownerUid;
    const souAdmin = perfil && perfil.tipo === 'admin'; // Verifica se é o Chefe

    if (euSouDono || souAdmin) {
        // Se for Admin, o botão fica com borda vermelha mais forte para destacar o poder
        const borda = souAdmin ? '2px solid red' : '1px solid rgba(255,255,255,0.5)';
        
        btnDeleteHtml = `
            <button onclick="deletarImagemEmAlta('${dados.id}', '${dados.imgUrl}')" 
                style="background:rgba(0,0,0,0.6); color:white; border:${borda}; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:60;">
                🗑️
            </button>`;
    }
    // ---------------------------------------------

    modalContent.innerHTML = `
        <div style="position:relative; width:100%; height:100%; background:#000; display:flex; flex-direction:column;">
            
            <div id="emAltaBarsContainer" class="em-alta-progress-container"></div>

            <div style="position:absolute; top:25px; left:15px; z-index:50; display:flex; gap:10px; align-items:center;">
                
                ${btnDeleteHtml} <button onclick="fecharPlayerEmAlta()" style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.3); color:white; width:35px; height:35px; border-radius:50%; font-size:16px; display:flex; align-items:center; justify-content:center; cursor:pointer;">✕</button>
            </div>

            <div style="position:absolute; top:25px; right:15px; z-index:40; display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.4); padding:5px 10px; border-radius:20px; backdrop-filter:blur(2px);">
                <div style="text-align:right;">
                    <b id="playerUserName" style="color:white; font-size:12px; display:block; text-shadow:0 1px 2px black;">...
                    <span style="color:#00c6ff; font-size:9px; display:block;">💎 Diamante</span>
                </div>
                <img id="playerUserPhoto" src="" style="width:32px; height:32px; border-radius:50%; border:1px solid #00c6ff; object-fit:cover;">
            </div>

            <div class="touch-nav-left" onclick="navegarEmAlta(-1)"></div>
            <div class="touch-nav-right" onclick="navegarEmAlta(1)"></div>

            <div style="flex:1; display:flex; align-items:center; justify-content:center; position:relative; width:100%; height:100%;">
                <img id="playerMainImage" src="" style="width:100%; height:100%; object-fit:contain;">
            </div>

            <div style="background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px; padding-bottom:30px; position:absolute; bottom:0; width:100%; z-index:60;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    
                    <div style="display:flex; gap:20px; padding-left:10px;">
                        <div onclick="acaoLikeEmAlta()" style="text-align:center; cursor:pointer;">
                            <span id="playerHeartIcon" style="font-size:28px;">🤍</span>
                            <span id="playerLikeCount" style="display:block; color:white; font-size:12px; font-weight:bold;">0</span>
                        </div>
                        <div onclick="acaoComentarEmAlta()" style="text-align:center; cursor:pointer;">
                            <span style="font-size:28px;">💬</span>
                            <span style="display:block; color:white; font-size:12px;">Comentar</span>
                        </div>
                    </div>

                    <button onclick="acaoAgendarEmAlta()" style="background: linear-gradient(45deg, #00c6ff, #0072ff); color:white; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; font-size:12px; box-shadow:0 0 10px rgba(0, 198, 255, 0.5); margin-right:10px;">
                        ✂️ AGENDAR
                    </button>
                </div>
            </div>
        </div>
    `;

    abrirModal('modalDetalhesEmAlta');
    renderizarBarrasProgresso(); 
    carregarFotoDoPlayer(index); 
}

function carregarFotoDoPlayer(index) {
    // Validações
    if (!listaEmAltaGlobal || listaEmAltaGlobal.length === 0) return;
    if (index < 0 || index >= listaEmAltaGlobal.length) {
        fecharPlayerEmAlta(); 
        return;
    }

    indexEmAltaAtual = index;
    const dados = listaEmAltaGlobal[index];
    
    // 🔥🔥 CORREÇÃO CRÍTICA AQUI: FORÇA O ID NAS GLOBAIS 🔥🔥
    altaDetalheId = dados.id; 
    altaDetalheDados = dados;
    window.idFotoBatalhaAtual = dados.id; // Backup de segurança
    
    console.log("FOTO CARREGADA. ID SALVO:", altaDetalheId); // Debug no console

    if (typeof timerEmAlta !== 'undefined' && timerEmAlta) clearTimeout(timerEmAlta);

    // 1. Imagem e Nome
    const imgMain = document.getElementById('playerMainImage');
    const nameMain = document.getElementById('playerUserName');
    if(imgMain) imgMain.src = dados.imgUrl || '';
    if(nameMain) nameMain.textContent = dados.ownerName || 'Desconhecido';
    
    // 2. Contagem de Likes
    const votosBatalha = parseInt(dados.count || 0); 
    let likesFeed = 0;
    if (dados.likedBy && Array.isArray(dados.likedBy)) {
        likesFeed = dados.likedBy.length;
    }
    const totalLikes = votosBatalha + likesFeed;
    const countEl = document.getElementById('playerLikeCount');
    if(countEl) countEl.textContent = totalLikes;

    // 3. Ícone do Coração
    const icon = document.getElementById('playerHeartIcon');
    if (icon && auth.currentUser) {
        const euDeiLike = dados.likedBy && dados.likedBy.includes(auth.currentUser.uid);
        if(euDeiLike) {
            icon.textContent = '❤️';
            icon.classList.add('heart-active');
        } else {
            icon.textContent = '🤍';
            icon.classList.remove('heart-active');
        }
    }

    // 4. Foto do Profissional
    const imgUser = document.getElementById('playerUserPhoto');
    if (imgUser) {
        imgUser.src = '/icone.png'; 
        if (dados.ownerUid && typeof dados.ownerUid === 'string' && dados.ownerUid.length > 5) {
            db.collection('usuarios').doc(dados.ownerUid).get()
                .then(snap => {
                    if(snap.exists) {
                        const u = snap.data();
                        imgUser.src = u.fotoPerfil || u.logo_url || '/icone.png';
                    }
                })
                .catch(err => console.warn("Ignorando erro foto user:", err)); 
        }
    }

    // 5. Barras de Progresso
    if (typeof atualizarBarrasVisuais === 'function') atualizarBarrasVisuais(index);
    
    const fills = document.querySelectorAll('.em-alta-progress-fill');
    if (fills[index]) {
        const barraAtual = fills[index];
        barraAtual.style.transition = 'none';
        barraAtual.style.width = '0%';
        void barraAtual.offsetWidth; 
        barraAtual.style.transition = `width ${TEMPO_POR_FOTO}ms linear`;
        barraAtual.style.width = '100%';
    }

    timerEmAlta = setTimeout(() => {
        navegarEmAlta(1);
    }, TEMPO_POR_FOTO);
}

// --- 4. FUNÇÕES DE SUPORTE (BARRAS) ---
function renderizarBarrasProgresso() {
    const container = document.getElementById('emAltaBarsContainer');
    container.innerHTML = '';
    listaEmAltaGlobal.forEach(() => {
        container.innerHTML += `<div class="em-alta-progress-bar"><div class="em-alta-progress-fill"></div></div>`;
    });
}

function atualizarBarrasVisuais(indexAtual) {
    const fills = document.querySelectorAll('.em-alta-progress-fill');
    fills.forEach((fill, idx) => {
        if (idx < indexAtual) {
            fill.style.transition = 'none';
            fill.style.width = '100%';
        } else if (idx > indexAtual) {
            fill.style.transition = 'none';
            fill.style.width = '0%';
        }
    });
}

// --- 5. NAVEGAÇÃO E AÇÕES ---
function navegarEmAlta(direcao) {
    carregarFotoDoPlayer(indexEmAltaAtual + direcao);
}

function fecharPlayerEmAlta() {
    if (timerEmAlta) clearTimeout(timerEmAlta);
    fecharModalAtual();
}

function acaoAgendarEmAlta() {
    if (timerEmAlta) clearTimeout(timerEmAlta);
    const dados = listaEmAltaGlobal[indexEmAltaAtual];
    fecharModalAtual(); // Fecha Player
    fecharModalAtual(); // Fecha Grid Em Alta
    abrirBarbeiroPerfil(dados.ownerUid);
}

function acaoLikeEmAlta() {
    if (!auth.currentUser) return; // PROTEÇÃO

    const dados = listaEmAltaGlobal[indexEmAltaAtual];
    if (!dados) return; // Proteção extra se a lista estiver vazia

    const uid = auth.currentUser.uid;
    const docRef = db.collection('batalha_likes').doc(dados.id);
    const icon = document.getElementById('playerHeartIcon');
    const countEl = document.getElementById('playerLikeCount');

    let currentTotal = parseInt(countEl.textContent);
    const isLiked = icon.textContent === '❤️';

    if (isLiked) {
        icon.textContent = '🤍';
        countEl.textContent = currentTotal - 1;
        if (dados.likedBy) dados.likedBy = dados.likedBy.filter(u => u !== uid);
        docRef.update({ likedBy: firebase.firestore.FieldValue.arrayRemove(uid) });
    } else {
        icon.textContent = '❤️';
        countEl.textContent = currentTotal + 1;
        tocarSom('ping');
        if (!dados.likedBy) dados.likedBy = [];
        dados.likedBy.push(uid);
        docRef.update({ likedBy: firebase.firestore.FieldValue.arrayUnion(uid) });
    }
}

function acaoComentarEmAlta() {
    if (timerEmAlta) clearTimeout(timerEmAlta); // Pausa o story
    const dados = listaEmAltaGlobal[indexEmAltaAtual];
    
    altaDetalheId = dados.id;
    altaDetalheDados = dados; 
    
    // Reutiliza a função que já abre o modal e carrega os comentários
    abrirModalComentariosAlta();

    // --- CORREÇÃO: Carrega a SUA foto na barrinha de digitar ---
    const imgMinhaFoto = document.getElementById('minhaFotoComentario');
    if (imgMinhaFoto && perfil) {
        imgMinhaFoto.src = perfil.fotoPerfil || perfil.logo_url || '/icone.png';
    }
}

function abrirModalComentariosAlta() {
    // 1. Configura as variáveis globais
    const dados = listaEmAltaGlobal[indexEmAltaAtual];
    altaDetalheId = dados.id;
    altaDetalheDados = dados; 

    // 2. Prepara o Modal
    const modal = document.getElementById('modalComentariosStory');
    const lista = document.getElementById('listaComentariosStory');
    const titulo = modal.querySelector('h3') || modal.querySelector('div[style*="border-bottom"] h3'); // Tenta achar o título
    
    if(titulo) titulo.textContent = "Comentários (Em Alta)";
    
    // 3. CORREÇÃO DEFINITIVA: Recria a barra de input para garantir que o botão funcione
    // Procura a div de rodapé (onde fica o input) e substitui o HTML dela
    const footerDiv = modal.querySelector('div[style*="border-top"]'); // Pega a div com borda no topo (rodapé)
    
    if (footerDiv) {
        const minhaFoto = perfil.fotoPerfil || perfil.logo_url || '/icone.png';
        footerDiv.innerHTML = `
            <img src="${minhaFoto}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #444;">
            <input id="inputComentarioAlta" type="text" placeholder="Comente algo..." style="flex-grow: 1; border-radius: 20px; background: #000; border: 1px solid #333; color:white; padding:12px; font-size: 14px; margin: 0 10px;">
            <button onclick="enviarComentarioEmAlta()" style="width:auto; padding: 10px; border-radius: 50%; background: transparent; color: var(--cor-destaque); font-weight: bold; font-size: 16px; border:none;">Enviar</button>
        `;
    }

    // 4. Mostra o Modal
    modal.classList.add('show');
    modal.style.display = 'flex';
    lista.innerHTML = '<div class="spinner" style="margin-top:20px;"></div>';

    // 5. Carrega Comentários
    if (altaUnsubscribeComments) altaUnsubscribeComments();
    
    altaUnsubscribeComments = db.collection('batalha_likes').doc(altaDetalheId).collection('comments')
        .orderBy('ts', 'asc')
        .onSnapshot(snap => {
            lista.innerHTML = '';
            if (snap.empty) {
                lista.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Seja o primeiro a comentar!</p>';
                return;
            }
            
            snap.forEach(doc => {
                const c = doc.data();
                const souDonoImagem = auth.currentUser.uid === altaDetalheDados.ownerUid;
                const souDonoComent = auth.currentUser.uid === c.uid;
                
                let deleteAction = '';
                if(souDonoImagem || souDonoComent || (perfil && perfil.tipo === 'admin')) {
                    deleteAction = `onclick="deletarComentarioIndividual('${altaDetalheId}', '${doc.id}')" style="cursor:pointer; border:1px dashed #444;" title="Toque para apagar"`;
                }

                // Foto do usuário que comentou
                const fotoUser = c.userPhoto || '/icone.png';

                lista.innerHTML += `
                    <div class="comment-item" ${deleteAction} style="padding:10px;">
                        <img src="${fotoUser}" style="width:30px; height:30px; border-radius:50%; object-fit:cover; margin-right:10px;">
                        <div>
                            <span style="font-weight:bold; color:var(--cor-destaque); font-size:12px;">${c.nome}</span>
                            <div style="color:#ddd; font-size:13px;">${c.texto}</div>
                        </div>
                    </div>`;
            });
            setTimeout(() => lista.scrollTop = lista.scrollHeight, 100);
        });
}


// --- FUNÇÃO CORRIGIDA: ENVIAR COMENTÁRIO EM ALTA ---
async function enviarComentarioEmAlta() {
    // Agora buscamos o ID específico que criamos acima
    const input = document.getElementById('inputComentarioAlta');
    
    if (!input) {
        console.error("Input não encontrado. Verifique se abrirModalComentariosAlta recriou o rodapé.");
        return;
    }

    const texto = input.value.trim();
    if (!texto || !altaDetalheId) return;

    input.value = ''; 
    input.focus();

    try {
        const docRef = db.collection('batalha_likes').doc(altaDetalheId);
        
        // Garante que o documento pai existe
        const doc = await docRef.get();
        if(!doc.exists && altaDetalheDados) {
             await docRef.set({
                imgUrl: altaDetalheDados.imgUrl,
                ownerUid: altaDetalheDados.ownerUid,
                ownerName: altaDetalheDados.ownerName,
                ownerTier: 'tier4',
                count: altaDetalheDados.count || 0,
                likedBy: [],
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Salva o comentário com a FOTO do usuário
        await docRef.collection('comments').add({
            uid: auth.currentUser.uid,
            nome: perfil.nome,
            userPhoto: perfil.fotoPerfil || perfil.logo_url || '/icone.png', // <-- ADICIONA A FOTO
            texto: texto,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

    } catch (e) {
        console.error("Erro ao comentar:", e);
        exibirPopup("Erro", "Falha ao enviar comentário.");
    }
}

async function executarFaxinaGeral() {
    if (!confirm("Isso irá remover permanentemente do banco todos os usuários que foram excluídos da autenticação. Deseja continuar?")) return;

    exibirAguarde("Limpando banco de dados...", true);

    try {
        const response = await fetch('https://navalhabackend.onrender.com/admin/sync-database-cleanup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid })
        });

        const data = await response.json();
        
        fecharModalAtual(true); // Fecha o aguarde
        
        if (data.success) {
            exibirPopup("Sucesso!", data.message);
        } else {
            exibirPopup("Erro", "Falha na sincronização.");
        }
    } catch (e) {
        fecharModalAtual(true);
        exibirPopup("Erro", "Servidor offline ou erro de conexão.");
    }
}

// Dar Like (Cria o doc se não existir)
async function toggleLikeAlta() {
    if (!altaDetalheId || !auth.currentUser) return;
    
    const docRef = db.collection('batalha_likes').doc(altaDetalheId);
    const uid = auth.currentUser.uid;

    try {
        const doc = await docRef.get();
        
        if (!doc.exists) {
            // Cria o documento pela primeira vez
            await docRef.set({
                imgUrl: altaDetalheDados.imgUrl,
                ownerUid: altaDetalheDados.ownerUid,
                ownerName: altaDetalheDados.ownerName,
                ownerTier: 'tier4',
                count: 1,
                likedBy: [uid],
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
            tocarSom('ping');
        } else {
            const data = doc.data();
            const likedBy = data.likedBy || [];
            
            if (likedBy.includes(uid)) {
                // Remove Like
                await docRef.update({
                    likedBy: firebase.firestore.FieldValue.arrayRemove(uid),
                    count: firebase.firestore.FieldValue.increment(-1)
                });
            } else {
                // Adiciona Like
                tocarSom('ping');
                await docRef.update({
                    likedBy: firebase.firestore.FieldValue.arrayUnion(uid),
                    count: firebase.firestore.FieldValue.increment(1)
                });
            }
        }
    } catch (e) {
        console.error("Erro like:", e);
    }
}

// Enviar Comentário
async function enviarComentarioEmAlta() {
    const input = document.getElementById('inputComentarioAlta');
    const texto = input.value.trim();
    if (!texto || !altaDetalheId) return;

    input.value = ''; // Limpa

    try {
        // Garante que o documento pai existe antes de adicionar na subcoleção
        const docRef = db.collection('batalha_likes').doc(altaDetalheId);
        const doc = await docRef.get();
        if(!doc.exists) {
             await docRef.set({
                imgUrl: altaDetalheDados.imgUrl,
                ownerUid: altaDetalheDados.ownerUid,
                ownerName: altaDetalheDados.ownerName,
                ownerTier: 'tier4',
                count: 0,
                likedBy: [],
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        await docRef.collection('comments').add({
            uid: auth.currentUser.uid,
            nome: perfil.nome,
            texto: texto,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (e) {
        console.error(e);
        exibirPopup("Erro ao comentar.");
    }
}

// Carregar Comentários
function carregarComentariosEmAlta(docId) {
    if (altaUnsubscribeComments) altaUnsubscribeComments();

    const container = document.getElementById('listaComentariosAlta');
    const txtCount = document.getElementById('txtCommentCountAlta');

    altaUnsubscribeComments = db.collection('batalha_likes').doc(docId).collection('comments')
        .orderBy('ts', 'asc')
        .onSnapshot(snap => {
            if (txtCount) txtCount.textContent = snap.size;
            container.innerHTML = '';
            
            if (snap.empty) {
                container.innerHTML = '<p style="font-size:12px; color:#666; text-align:center; padding:10px;">Seja o primeiro a comentar.</p>';
                return;
            }

            snap.forEach(doc => {
                const c = doc.data();
                
                // Lógica de Deletar Comentário (Dono da Imagem ou Dono do Comentário ou Admin)
                let deleteAttr = '';
                const souDonoImagem = auth.currentUser.uid === altaDetalheDados.ownerUid;
                const souDonoComent = auth.currentUser.uid === c.uid;
                const souAdmin = perfil.tipo === 'admin';

                if (souDonoImagem || souDonoComent || souAdmin) {
                    deleteAttr = `onclick="deletarComentarioIndividual('${docId}', '${doc.id}')" style="cursor:pointer; border:1px dashed #444; padding:5px; border-radius:5px;" title="Toque para apagar"`;
                }

                container.innerHTML += `
                    <div class="comentario-linha" ${deleteAttr}>
                        <span class="comentario-nome">${c.nome}:</span>
                        <span class="comentario-texto">${c.texto}</span>
                    </div>`;
            });
            
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        });
}

// Deletar Comentário
async function deletarComentarioIndividual(docId, commentId) {
    if(!confirm("Apagar comentário?")) return;
    try {
        await db.collection('batalha_likes').doc(docId).collection('comments').doc(commentId).delete();
    } catch(e) {
        console.error(e);
    }
}

// Deletar Imagem (Dono do Portfólio)
async function deletarImagemEmAlta(docId, url) {
    if(!confirm("Tem certeza que deseja apagar esta imagem do Em Alta? (Isso não apaga do seu portfólio)")) return;
    
    exibirAguarde("Apagando...");
    try {
        // Apaga o documento de likes/comentários
        await db.collection('batalha_likes').doc(docId).delete();
        
        // (Opcional) Se quiser apagar do portfólio real também:
        // await db.collection('usuarios').doc(auth.currentUser.uid).update({ portfolio: firebase.firestore.FieldValue.arrayRemove(url) });

        fecharTodosOsModais();
        exibirPopup("Imagem removida do feed.");
        
        // Recarrega o grid
        carregarFeedEmAlta();
        
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao apagar: " + e.message);
    }
}

function compartilharEmAltaUrl(url) {
    if (navigator.share) {
        navigator.share({
            title: 'Olha esse corte!',
            text: 'Vi esse estilo incrível no King Agenda 🔥',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url);
        exibirPopup("Link copiado!", "Cole nas suas redes sociais.");
    }
}

async function carregarPortfolioExistente() {
    const gridContainer = document.getElementById('portfolioExistenteGrid');
    gridContainer.innerHTML = '<p>Carregando...</p>'; // Feedback inicial

    // Cancela o listener anterior, se existir
    if (portfolioListener) {
        portfolioListener();
        portfolioListener = null;
    }
    
    const docRef = db.collection('usuarios').doc(auth.currentUser.uid);

    try {
        // 1. FAZ UM GET PRIMEIRO PARA CARGA RÁPIDA E SINCRONIZAÇÃO
        const doc = await docRef.get();
        if (doc.exists) {
            perfil = doc.data(); // ATUALIZA O PERFIL GLOBAL IMEDIATAMENTE
            renderizarGridPortfolio(doc.data()); // Renderiza a grid com os dados do get()
        } else {
            gridContainer.innerHTML = '<p style="color: red;">Erro: Perfil não encontrado.</p>';
        }
    } catch (getError) {
         console.error("Erro ao fazer 'get' do portfólio:", getError);
         gridContainer.innerHTML = `<p style="color: red;">Erro ao carregar: ${getError.message}</p>`;
    }

    // 2. AGORA, ANEXA O LISTENER para atualizações em tempo real
    portfolioListener = docRef.onSnapshot(doc => {
        const modalPortfolio = document.getElementById('modalPortfolioBarbeiro');
        // Se o modal não estiver aberto ou o doc não existir, cancela o listener
        if (!doc.exists || !modalPortfolio || !modalPortfolio.classList.contains('show')) {
            if (portfolioListener) {
                portfolioListener(); // Cancela o listener
                portfolioListener = null;
            }
            return;
        }
        
        perfil = doc.data(); // Atualiza o perfil global
        renderizarGridPortfolio(doc.data()); // Re-renderiza a grid com novos dados
        atualizarContadorEInputPortfolio(); // Atualiza o contador/input

    }, error => {
        console.error("Erro ao ouvir updates do portfólio:", error);
        gridContainer.innerHTML = '<p style="color: red;">Erro ao carregar portfólio.</p>';
    });
}

function renderizarGridPortfolio(perfilData) {
    const gridContainer = document.getElementById('portfolioExistenteGrid');
    const portfolioUrls = perfilData?.portfolio || [];
    
    gridContainer.innerHTML = ''; // Limpa o container

    if (portfolioUrls.length === 0) {
        gridContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nenhuma imagem no portfólio ainda.</p>';
        return;
    }

    portfolioUrls.forEach(url => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative'; 
        imgContainer.dataset.url = url; // Guarda a URL no elemento

        const imgElement = document.createElement('img');
        imgElement.src = url;
        imgElement.alt = 'Imagem do Portfólio';
        imgElement.style.width = '100%';
        imgElement.style.height = '100px';
        imgElement.style.objectFit = 'cover';
        imgElement.style.borderRadius = '4px';
        imgElement.style.border = '1px solid var(--cor-borda)';
        imgElement.onerror = function() {
            this.src='https://placehold.co/100x100?text=Erro!';
            const deleteBtn = this.nextElementSibling;
            if(deleteBtn) deleteBtn.remove();
        };

        const deleteButton = document.createElement('button');
        deleteButton.textContent = '❌';
        deleteButton.style.position = 'absolute';
        deleteButton.style.top = '2px';
        deleteButton.style.right = '2px';
        deleteButton.style.background = 'rgba(0,0,0,0.7)';
        deleteButton.style.color = 'white';
        deleteButton.style.border = 'none';
        deleteButton.style.borderRadius = '50%';
        deleteButton.style.width = '20px';
        deleteButton.style.height = '20px';
        deleteButton.style.fontSize = '10px';
        deleteButton.style.lineHeight = '20px'; 
        deleteButton.style.textAlign = 'center';
        deleteButton.style.padding = '0';
        deleteButton.style.cursor = 'pointer';
        deleteButton.title = 'Remover Imagem';

        deleteButton.onclick = (e) => {
            e.stopPropagation();
            marcarImagemPortfolioParaExcluir(deleteButton, url); // Chama a função de "marcar"
        };

        imgContainer.appendChild(imgElement);
        imgContainer.appendChild(deleteButton);
        gridContainer.appendChild(imgContainer);

        // Re-aplica o estilo de "marcado" se a imagem estiver na lista global de exclusão
        if (imagensMarcadasParaExcluir.includes(url)) {
             imgContainer.classList.add('marcada-para-excluir');
             deleteButton.textContent = '↩️';
             deleteButton.title = 'Manter Imagem';
             imgElement.style.opacity = '0.5';
             imgElement.style.border = '2px solid red';
        }
    });
}

async function enviarEmailDeContato() {
    const userEmail = perfil ? perfil.email : prompt("Seu email para resposta:");
    const message = prompt("Sua mensagem:");
    if (!userEmail || !message) return;

    exibirAguarde("Enviando mensagem...");
    try {
        const sendEmailFunction = firebase.functions().httpsCallable('sendContactEmail');
        const result = await sendEmailFunction({ email: userEmail, message: message });
        fecharTodosOsModais();
        exibirPopup("Sucesso", result.data.message);
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao chamar função de email:", error);
        exibirPopup("Erro", error.message);
    }
}
// No HTML, o link do email chamaria essa função:
// <a href="#" onclick="enviarEmailDeContato()">...</a>

function fecharModalDashboard() {
    // Desliga o listener do banco de dados para economizar recurso
    if (typeof dashboardListener !== 'undefined' && dashboardListener) {
        dashboardListener(); 
        dashboardListener = null;
    }
    
    // Remove o modal da tela
    const modal = document.getElementById('modalGestaoV2');
    if (modal) {
        ocultarModalVisualmente(modal);
        setTimeout(() => modal.remove(), 350); // Remove do DOM depois da animação
    }
}

function abrirModalFidelidade() {
    // 1. Proteção contra perfil não carregado
    if (!perfil) {
        exibirPopup("Erro", "Aguarde o carregamento do perfil.");
        return;
    }

    abrirModal('modalFidelidade');
    const container = document.querySelector("#modalFidelidade .modal-content");
    
    // Garante valores numéricos
    const saldoPontos = perfil.pontosFidelidade || 0;
    const saldoMoedas = perfil.saldoDigital || 0;

    container.innerHTML = `
        <div style="text-align:center;">
            <div class="king-points-icon">👑</div>
            <h3 style="color: #d4af37; text-transform: uppercase; margin:0;">King Points</h3>
            <p style="font-size: 12px; color: #aaa; margin-top:5px;">A moeda da realeza.</p>
        </div>

        <div class="king-balance-display">
            <span style="font-size: 14px; color: #ccc;">Seu Saldo:</span>
            <div style="font-size: 32px; font-weight: 800; color: #fff; text-shadow: 0 2px 4px #000;">
                ${saldoPontos} <span style="font-size:16px; color:#d4af37;">KP</span>
            </div>
        </div>

        <div class="chat-tabs" style="margin-bottom: 15px;">
            <div class="chat-tab active" onclick="alternarAbaKing('comprar', this)">📥 Comprar</div>
            <div class="chat-tab" onclick="alternarAbaKing('enviar', this)">🎁 Enviar</div>
            <div class="chat-tab" onclick="alternarAbaKing('resgatar', this)">🔄 Trocar</div>
        </div>

        <div id="abaKingComprar" class="aba-king-content">
            <p style="font-size:12px; text-align:center; margin-bottom:10px;">
                Use seu Saldo Digital (Moedas) para comprar King Points.<br>
                <b style="color:#2ecc71;">Custo: 0.03 Moedas por Ponto.</b>
            </p>
            
            <div style="background:#222; padding:10px; border-radius:10px; margin-bottom:10px; text-align:center;">
                <span style="font-size:12px;">Saldo Digital Disponível:</span><br>
                <b style="color:#00c6ff; font-size:16px;">💎 ${saldoMoedas.toFixed(2)}</b>
            </div>

            <label>Quantidade de King Points:</label>
            <input type="number" id="inputQtdCompraKP" placeholder="Ex: 100" oninput="calcularCustoKP(this.value)">
            
            <p style="text-align:right; font-size:14px; margin:5px 0;">
                Custo Total: <b id="displayCustoKP" style="color:#e74c3c;">0.00</b> Moedas
            </p>

            <button onclick="comprarKingPoints()" style="width:100%; background: linear-gradient(45deg, #d4af37, #f1c40f); color:black; font-weight:bold; margin-top:10px;">
                💳 COMPRAR AGORA
            </button>
        </div>

        <div id="abaKingEnviar" class="aba-king-content hidden">
            <p style="font-size:12px; text-align:center; margin-bottom:10px;">
                Envie King Points para um amigo usando o e-mail dele.
            </p>
            <input type="email" id="inputEmailDestinoKP" placeholder="E-mail do usuário (cadastrado)">
            <input type="number" id="inputQtdEnvioKP" placeholder="Quantidade de Pontos">
            
            <button onclick="enviarKingPoints()" style="width:100%; background: #9b59b6; border: 1px solid #fff; margin-top:10px;">
                🎁 ENVIAR PRESENTE
            </button>
        </div>

        <div id="abaKingResgatar" class="aba-king-content hidden">
            <p style="font-size:12px; text-align:center; margin-bottom:10px;">
                Troque seus King Points por Saldo Bônus para usar em serviços ou na loja.
            </p>
            <div style="background:#333; padding:15px; border-radius:10px; border:1px dashed #d4af37; text-align:center;">
                <p style="margin:0; font-size:14px;">Pacote Padrão</p>
                <h4 style="margin:5px 0; color:#d4af37;">100 KP = R$ 5,00</h4>
                <p style="font-size:10px; color:#aaa;">Saldo Bônus</p>
            </div>
            <button onclick="resgatarPontos()" style="width:100%; background:#2ecc71; margin-top:15px;">
                🔄 REALIZAR TROCA
            </button>
        </div>

        <button data-modal-id="modalFidelidade" onclick="fecharModal(event)" style="margin-top: 15px; background:#555;">❌ Fechar</button>
    `;
}

// --- FUNÇÕES KING POINTS (FIDELIDADE 2.0) ---

// Alterna entre as abas do modal
function alternarAbaKing(aba, elemento) {
    // Atualiza botões
    document.querySelectorAll('#modalFidelidade .chat-tab').forEach(t => t.classList.remove('active'));
    elemento.classList.add('active');

    // Esconde todas as divs de conteúdo
    document.querySelectorAll('.aba-king-content').forEach(d => d.classList.add('hidden'));

    // Mostra a selecionada
    if(aba === 'comprar') document.getElementById('abaKingComprar').classList.remove('hidden');
    if(aba === 'enviar') document.getElementById('abaKingEnviar').classList.remove('hidden');
    if(aba === 'resgatar') document.getElementById('abaKingResgatar').classList.remove('hidden');
}

// Calcula o custo em tempo real ao digitar
function calcularCustoKP(valor) {
    const qtd = parseInt(valor);
    const display = document.getElementById('displayCustoKP');
    if (isNaN(qtd) || qtd < 0) {
        display.textContent = "0.00";
        return;
    }
    // Custo: 0.03 por ponto
    const custo = qtd * 0.03;
    display.textContent = custo.toFixed(2);
}

// Lógica de Compra (Usa Saldo Digital)
async function comprarKingPoints() {
    const inputQtd = document.getElementById('inputQtdCompraKP');
    const qtd = parseInt(inputQtd.value);
    
    if (isNaN(qtd) || qtd <= 0) return exibirPopup("Valor inválido", "Digite uma quantidade maior que zero.");

    const custoTotal = qtd * 0.03;
    const saldoDigital = perfil.saldoDigital || 0;

    if (saldoDigital < custoTotal) {
        return exibirPopup("Saldo Insuficiente", `Você precisa de ${custoTotal.toFixed(2)} Moedas Digitais. Seu saldo: ${saldoDigital.toFixed(2)}.`, "aviso", () => {
            // Fecha este e abre o de comprar moedas
            fecharModalAtual();
            abrirModalCarteira(); // Ou função direta de comprar moedas se tiver
        });
    }

    if (!confirm(`Confirmar compra de ${qtd} King Points por ${custoTotal.toFixed(2)} Moedas?`)) return;

    exibirAguarde("Processando compra...");

    try {
        await db.runTransaction(async (t) => {
            const userRef = db.collection('usuarios').doc(auth.currentUser.uid);
            const doc = await t.get(userRef);
            const data = doc.data();

            if ((data.saldoDigital || 0) < custoTotal) throw "Saldo insuficiente durante transação.";

            t.update(userRef, {
                saldoDigital: firebase.firestore.FieldValue.increment(-custoTotal),
                pontosFidelidade: firebase.firestore.FieldValue.increment(qtd)
            });

            // Registro no extrato (opcional, mas bom pra controle)
            const extratoRef = db.collection('extrato_financeiro').doc();
            t.set(extratoRef, {
                usuarioUid: auth.currentUser.uid,
                tipo: 'compra_king_points',
                valor: custoTotal, // Valor em moedas gasto
                pontos: qtd,
                descricao: `Compra de ${qtd} KP`,
                dataEvento: firebase.firestore.Timestamp.now(),
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        fecharTodosOsModais();
        tocarSom('sucesso');
        if (typeof confetti === 'function') confetti();
        exibirPopup("Sucesso!", `Você comprou ${qtd} King Points! 👑`);
        
        // Reabre o modal para ver o saldo novo
        setTimeout(() => abrirModalFidelidade(), 1500);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro na compra: " + e);
    }
}

// Lógica de Envio (Transferência entre usuários)
async function enviarKingPoints() {
    const emailDestino = document.getElementById('inputEmailDestinoKP').value.trim().toLowerCase();
    const qtd = parseInt(document.getElementById('inputQtdEnvioKP').value);

    if (!emailDestino || isNaN(qtd) || qtd <= 0) return exibirPopup("Preencha o e-mail e a quantidade corretamente.");
    if (emailDestino === perfil.email) return exibirPopup("Você não pode enviar pontos para si mesmo.");
    
    if ((perfil.pontosFidelidade || 0) < qtd) {
        return exibirPopup("Saldo Insuficiente", `Você tem apenas ${perfil.pontosFidelidade || 0} KP.`);
    }

    if (!confirm(`Deseja enviar ${qtd} King Points para ${emailDestino}? Essa ação não pode ser desfeita.`)) return;

    exibirAguarde("Enviando pontos...");

    try {
        // 1. Busca o destinatário
        const snap = await db.collection('usuarios').where('email', '==', emailDestino).limit(1).get();
        if (snap.empty) {
            fecharTodosOsModais();
            return exibirPopup("Usuário não encontrado", "Verifique o e-mail digitado.");
        }
        const destinatarioDoc = snap.docs[0];
        const destinatarioUid = destinatarioDoc.id;
        const destinatarioNome = destinatarioDoc.data().nome;

        // 2. Transação de transferência
        await db.runTransaction(async (t) => {
            const meuRef = db.collection('usuarios').doc(auth.currentUser.uid);
            const destRef = db.collection('usuarios').doc(destinatarioUid);

            // Verifica meu saldo de novo dentro da transação
            const meuDoc = await t.get(meuRef);
            if ((meuDoc.data().pontosFidelidade || 0) < qtd) throw "Saldo insuficiente.";

            // Debita de mim
            t.update(meuRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(-qtd) });
            // Credita no amigo
            t.update(destRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(qtd) });
        });

        // 3. Notifica o amigo
        notifyUser(destinatarioUid, "👑 King Points Recebidos!", `${perfil.nome} te enviou ${qtd} King Points de presente!`, { link: '#fidelidade' });
        
        // Cria aviso interno
        criarAviso(destinatarioUid, `🎁 Você recebeu ${qtd} KP de ${perfil.nome}!`, 'gift_points');

        fecharTodosOsModais();
        tocarSom('sucesso');
        exibirPopup("Enviado!", `Você enviou ${qtd} KP para ${destinatarioNome}.`);

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao enviar: " + e);
    }
}

async function abrirPortfolioCliente(barbeiroUid, barbeiroNome) {
    const doc = await db.collection('usuarios').doc(barbeiroUid).get();
    if (!doc.exists) return;
    const portfolio = doc.data().portfolio || [];
    
    const grid = document.getElementById('portfolioClienteGrid');
    grid.innerHTML = '';
    document.getElementById('portfolioClienteNome').textContent = `🖼️ Portfólio de ${barbeiroNome}`;
    
    if (portfolio.length > 0) {
        portfolio.forEach(url => {
            grid.innerHTML += `<img src="${url}" alt="Foto do portfólio" onerror="this.src='https://placehold.co/150?text=Erro'">`;
        });
    } else {
        grid.innerHTML = '<p>Este profissional ainda não adicionou imagens ao portfólio.</p>';
    }
    
    abrirModal('modalPortfolioCliente');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distância em km
}

function obterLocalizacaoAtual() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error("Geolocalização não suportada."));
        }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                localizacaoCliente = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                };
                resolve(localizacaoCliente);
            },
            (error) => {
                console.warn("Não foi possível obter a localização: ", error.message);
                reject(error);
            }
        );
    });
}

function obterLocalizacaoCadastro() {
    const btn = document.getElementById('btnLocalizacaoCadastro');
    if(btn) btn.textContent = '⏳ Obtendo localização...';
    if (!navigator.geolocation) {
        exibirPopup("Geolocalização não é suportada pelo seu navegador.");
        if(btn) btn.textContent = '📍 Usar minha localização atual';
        return;
    }
    navigator.geolocation.getCurrentPosition(
        (position) => {
            cadastroCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
            };
            
            if(btn) btn.textContent = '✅ Localização Obtida!';
        },
        (error) => {
            exibirPopup("Não foi possível obter a localização. Por favor, verifique as permissões no seu navegador.");
            if(btn) btn.textContent = '📍 Usar minha localização atual';
        }
    );
}

// ======================================================
// === SISTEMA DE MISSÕES DIÁRIAS ===
// ======================================================

const LISTA_MISSOES = [
    { id: 'voto_batalha', titulo: 'Jurado de Estilo', desc: 'Vote em 5 batalhas', meta: 5 },
    { id: 'abrir_loja', titulo: 'Vitrine Virtual', desc: 'Visite a Loja do App', meta: 1 },
    { id: 'like_story', titulo: 'Engajado', desc: 'Curta 3 Stories', meta: 3 },
    { id: 'ver_em_alta', titulo: 'Tendências', desc: 'Abra o painel Em Alta', meta: 1 },
    { id: 'abrir_perfil_pro', titulo: 'Explorador', desc: 'Visite o perfil de um profissional', meta: 1 }
];

// Variável global para guardar a função de cancelar o listener (para limpeza)
let convitesListener = null; 

// --- NOVO: FUNÇÃO DE ESCUTA DE CONVITES ---
function iniciarListenerConvites(uid) {
    if (convitesListener) convitesListener(); // Limpa listener anterior
    
    console.log("Iniciando Listener Convites...");

    // Busca convites onde EU sou o destinatário e o status é 'pendente'
    convitesListener = db.collection("solicitacoes")
        .where("destinatarioUid", "==", uid)
        .where("tipo", "==", "convite_equipe")
        .where("status", "==", "pendente")
        .onSnapshot(snap => {
            const temConvites = !snap.empty;
            const mudou = perfil.temConvitesPendentes !== temConvites;

            if (mudou) {
                // Atualiza o perfil localmente (sem escrever no banco o tempo todo)
                perfil.temConvitesPendentes = temConvites; 
                
                // Força o re-render do painel para o botão sumir/aparecer
                if (typeof renderCurrentView === 'function') {
                    renderCurrentView(); 
                }
                
                // Toca alerta se um convite NOVO acabou de chegar
                if(temConvites && snap.docChanges().some(c => c.type === 'added')) {
                    tocarSom('alerta'); // Alerta sonoro para o novo convite
                }
            }
        });
}

async function verificarMissoesDiarias() {
    if (!perfil) return;
    const hoje = new Date().toDateString();
    
    // Se não tem missões ou é um novo dia, gera novas
    if (!perfil.missoesData || perfil.missoesData !== hoje || !perfil.missoesAtivas) {
        const novasMissoes = [];
        // Pega 3 aleatórias
        const shuffled = [...LISTA_MISSOES].sort(() => 0.5 - Math.random());
        shuffled.slice(0, 3).forEach(m => {
            novasMissoes.push({ ...m, progresso: 0, concluida: false });
        });

        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            missoesData: hoje,
            missoesAtivas: novasMissoes,
            bauMissaoResgatado: false
        });
        perfil.missoesAtivas = novasMissoes; // Atualiza local
    }

    renderizarMissoes();
}

function renderizarMissoes() {
    const container = document.getElementById('containerMissoesDiarias');
    if (!container) return;
    container.innerHTML = '';

    let todasConcluidas = true;

    perfil.missoesAtivas.forEach(m => {
        if (!m.concluida) todasConcluidas = false;
        const porcentagem = (m.progresso / m.meta) * 100;
        const icone = m.concluida ? '✅' : '⭕';
        const classeCheck = m.concluida ? 'concluida' : '';

        container.innerHTML += `
            <div class="missao-item">
                <div class="missao-info">
                    <div class="missao-titulo">${m.titulo} <span style="font-weight:normal; opacity:0.7;">(${m.desc})</span></div>
                    <div class="missao-barra-bg">
                        <div class="missao-barra-fill" style="width: ${porcentagem}%"></div>
                    </div>
                    <div style="font-size:10px; margin-top:2px; color:#aaa;">${m.progresso}/${m.meta}</div>
                </div>
                <div class="missao-check ${classeCheck}">${icone}</div>
            </div>`;
    });

    if (todasConcluidas && !perfil.bauMissaoResgatado) {
        container.innerHTML += `<button onclick="resgatarBauMissoes()" style="width:100%; background: linear-gradient(45deg, #ffd700, #f1c40f); color:black; font-weight:bold; animation: pulse-map 1s infinite;">🎁 RESGATAR RECOMPENSA DIÁRIA</button>`;
    } else if (todasConcluidas && perfil.bauMissaoResgatado) {
        container.innerHTML += `<p style="text-align:center; color:#2ecc71; font-size:12px;">🎉 Você completou tudo por hoje!</p>`;
    }
}

async function atualizarProgressoMissao(idMissao) {
    if (!perfil || !perfil.missoesAtivas) return;
    
    let mudou = false;
    let missaoCompletadaAgora = null;

    // Mapeia e atualiza o array local
    const novasMissoes = perfil.missoesAtivas.map(m => {
        // Verifica se é a missão certa e se AINDA não foi concluída
        if (m.id === idMissao && !m.concluida) {
            m.progresso++;
            
            // Se atingiu a meta
            if (m.progresso >= m.meta) {
                m.progresso = m.meta; // Trava no máximo
                m.concluida = true;
                missaoCompletadaAgora = m.titulo;
                mudou = true;
            } else {
                // Se apenas progrediu mas não acabou
                mudou = true; 
            }
        }
        return m;
    });

    if (mudou) {
        // Atualiza variável global imediatamente para reflexo visual
        perfil.missoesAtivas = novasMissoes; 
        
        // Salva no Firebase
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ 
            missoesAtivas: novasMissoes 
        });

        // Se completou, avisa e toca som
        if (missaoCompletadaAgora) {
            tocarSom('sucesso');
            exibirToast(`🎯 Missão Cumprida: ${missaoCompletadaAgora}`);
        }
        
        // Se o modal de perfil estiver aberto, atualiza a lista visualmente
        const containerMissoes = document.getElementById('containerMissoesDiarias');
        if (containerMissoes) {
            renderizarMissoes();
        }
    }
}

async function resgatarBauMissoes() {
    exibirAguarde("Abrindo baú...");
    
    // Weighted Probabilities:
    // 40% = 10 Points
    // 15% = 1 Digital Coin
    // 45% = 5 Points + 1 Spin
    
    const rand = Math.random() * 100; // 0 to 100
    let premio = null;

    if (rand < 40) {
        // 0 - 39.99 (40%)
        premio = { 
            txt: "10 King Points", 
            update: { pontosFidelidade: firebase.firestore.FieldValue.increment(10) } 
        };
    } else if (rand < 55) {
        // 40 - 54.99 (15%)
        premio = { 
            txt: "1 Moeda Digital", 
            update: { saldoDigital: firebase.firestore.FieldValue.increment(1) } 
        };
    } else {
        // 55 - 100 (45%)
        // Note: Subtracts 1 from 'girosRealizadosHoje' to give a free spin (credit)
        premio = { 
            txt: "5 Pontos + 1 Giro na Roleta", 
            update: { 
                pontosFidelidade: firebase.firestore.FieldValue.increment(5), 
                girosRealizadosHoje: firebase.firestore.FieldValue.increment(-1) 
            } 
        };
    }

    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            ...premio.update,
            bauMissaoResgatado: true
        });

        fecharTodosOsModais();
        if (typeof confetti === 'function') confetti();
        exibirPopup("🎁 Recompensa!", `Você ganhou: ${premio.txt}`, "sucesso");
        
        // Update local state to hide button immediately
        perfil.bauMissaoResgatado = true;
        renderizarMissoes(); // Re-render mission list to show "Completed" message

    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao resgatar: " + e.message);
    }
}


// ======================================================
// === PAINEL EM ALTA (TRENDING TIER 4) ===
// ======================================================

async function abrirPainelEmAlta() {
    atualizarProgressoMissao('ver_em_alta'); // Missão
    abrirModal('modalEmAlta');
    const container = document.getElementById('gridEmAlta');
    container.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';

    try {
        // Busca imagens da coleção de likes (que agora salva dados completos)
        // Ordena por quantidade de likes
        const snap = await db.collection('batalha_likes')
            .orderBy('count', 'desc')
            .limit(50)
            .get();

        container.innerHTML = '<div class="em-alta-grid"></div>';
        const grid = container.querySelector('.em-alta-grid');
        
        let encontrouAlgo = false;

        snap.forEach(doc => {
            const d = doc.data();
            // Filtro: Apenas se tiver URL e for Tier 4 (Salvo no momento do voto)
            // Se for dado antigo sem tier, ignora ou mostra se quiser
            if (d.imgUrl && d.ownerTier === 'tier4') {
                encontrouAlgo = true;
                
                const item = document.createElement('div');
                item.className = 'em-alta-item';
                item.onclick = () => abrirDetalhesEmAlta(d, doc.id);
                
                item.innerHTML = `
                    <img src="${d.imgUrl}" class="em-alta-img">
                    <div class="em-alta-badge">💎 TOP</div>
                    <div class="em-alta-overlay">
                        <div class="em-alta-stats">
                            <span>❤️ ${d.count}</span>
                            <span style="opacity:0.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80px;">${d.ownerName}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(item);
            }
        });

        if (!encontrouAlgo) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:#aaa;">Ainda não há imagens Diamante em alta. Vote nas batalhas!</p>';
        }

    } catch (e) {
        console.error(e);
        container.innerHTML = '<p style="text-align:center;">Erro ao carregar feed.</p>';
    }
}

function abrirDetalhesEmAlta(dados, docId) {
    imagemAltaAtualId = docId; // ID do documento em batalha_likes
    
    document.getElementById('imgDetalheAlta').src = dados.imgUrl;
    document.getElementById('nomeProfDetalheAlta').textContent = dados.ownerName;
    document.getElementById('countLikesAlta').textContent = dados.count;
    
    // Tenta carregar foto do profissional
    db.collection('usuarios').doc(dados.ownerUid).get().then(snap => {
        if(snap.exists) {
            const u = snap.data();
            document.getElementById('fotoProfDetalheAlta').src = u.fotoPerfil || u.logo_url || '/icone.png';
        }
    });

    // Configura o botão de agendar
    const btnAgendar = document.getElementById('btnAgendarAlta');
    btnAgendar.onclick = () => {
        fecharModalAtual(); // Fecha o detalhe
        fecharModalAtual(); // Fecha o Em Alta
        abrirBarbeiroPerfil(dados.ownerUid); // Abre o perfil
    };

    abrirModal('modalDetalhesEmAlta');
}

function darLikeEmAlta() {
    if (!imagemAltaAtualId) return;
    
    // Atualiza visualmente na hora
    const countEl = document.getElementById('countLikesAlta');
    let atual = parseInt(countEl.textContent);
    countEl.textContent = atual + 1;
    tocarSom('ping');

    // Salva no banco
    db.collection('batalha_likes').doc(imagemAltaAtualId).update({
        count: firebase.firestore.FieldValue.increment(1)
    });
}

function carregarNovaBatalha() {
    // Verifica se tem fotos suficientes
    if (!todasFotos || todasFotos.length < 2) {
        console.warn("Aguardando carregamento das fotos...");
        return;
    }

    // Sorteia 2 índices diferentes
    let idx1 = Math.floor(Math.random() * todasFotos.length);
    let idx2 = Math.floor(Math.random() * todasFotos.length);
    
    // Garante que não são iguais
    while (idx1 === idx2) {
        idx2 = Math.floor(Math.random() * todasFotos.length);
    }

    const competidorA = todasFotos[idx1];
    const competidorB = todasFotos[idx2];

    // Salva no objeto global para a função votarBatalha usar depois
    dueloAtual = {
        a: competidorA,
        b: competidorB
    };

    console.log("Nova batalha iniciada:", dueloAtual);

    // --- ATUALIZA A TELA (DOM) ---
    // Ajuste os IDs abaixo ('imgA', 'imgB', etc) conforme o seu HTML
    
    // Competidor A
    const imgA = document.getElementById('imgA'); // Ou o ID da imagem da esquerda
    const nomeA = document.getElementById('nomeA');
    if (imgA) {
        imgA.src = competidorA.url || competidorA.imgUrl;
        imgA.onclick = () => votarBatalha('A'); // Garante o click
    } 
    if (nomeA) nomeA.textContent = competidorA.nome || "Profissional A";

    // Competidor B
    const imgB = document.getElementById('imgB'); // Ou o ID da imagem da direita
    const nomeB = document.getElementById('nomeB');
    if (imgB) {
        imgB.src = competidorB.url || competidorB.imgUrl;
        imgB.onclick = () => votarBatalha('B'); // Garante o click
    }
    if (nomeB) nomeB.textContent = competidorB.nome || "Profissional B";

    // Reseta animações de coração se tiverem ficado travadas
    document.querySelectorAll('.voto-animacao').forEach(el => el.classList.remove('show'));
}

async function votarBatalha(escolha) {
    if (!dueloAtual.A || !dueloAtual.B) { iniciarRoundInicial(); return; }
    if (!auth.currentUser) { exibirPopup("Atenção", "Faça login para votar."); return; }
    if (travaVoto) return;
    
    travaVoto = true;
    setTimeout(() => { travaVoto = false; }, 1200); 

    // --- 1. EFEITO VISUAL IMEDIATO NO LIKE (+1 NA TELA) ---
    if (escolha === 'A') {
        dueloAtual.A.totalLikes = (dueloAtual.A.totalLikes || 0) + 1;
        const el = document.getElementById('likesBatalhaA');
        if (el) {
            el.textContent = dueloAtual.A.totalLikes;
            el.style.transition = "transform 0.2s, color 0.2s";
            el.style.transform = "scale(1.5)"; 
            el.style.color = "#ff4500"; 
            setTimeout(() => { 
                el.style.transform = "scale(1)"; 
                el.style.color = "#fff"; 
            }, 300);
        }
    } else {
        dueloAtual.B.totalLikes = (dueloAtual.B.totalLikes || 0) + 1;
        const el = document.getElementById('likesBatalhaB');
        if (el) {
            el.textContent = dueloAtual.B.totalLikes;
            el.style.transition = "transform 0.2s, color 0.2s";
            el.style.transform = "scale(1.5)"; 
            el.style.color = "#00c6ff"; 
            setTimeout(() => { 
                el.style.transform = "scale(1)"; 
                el.style.color = "#fff"; 
            }, 300);
        }
    }

    // --- 2. CONTADOR E LÓGICA DE PRÊMIOS ACUMULADOS ---
    let votosHoje = parseInt(localStorage.getItem('batalha_votos_hoje') || '0');
    votosHoje++; 
    localStorage.setItem('batalha_votos_hoje', votosHoje);

    const countEl = document.getElementById('contadorVotosSession');
    if (countEl) {
        countEl.textContent = `${votosHoje}/75`;
        if (votosHoje > 75) countEl.style.color = '#e74c3c'; 
    }

    // LÓGICA DO PRÊMIO: Acumula localmente para não fechar o modal
    if (votosHoje <= 75) {
        if (votosHoje % 5 === 0) {
            // --- MUDANÇA AQUI: Apenas incrementa a variável na memória ---
            pontosAcumuladosBatalha++; 
            
            // O Toast avisa que ele ganhou, mas o saldo no topo só mudará ao fechar
            if(typeof exibirToast === 'function') {
                exibirToast("🎁 +1 Ponto Acumulado!");
            }
        }
    }
    
    if(typeof atualizarProgressoMissao === 'function') atualizarProgressoMissao('voto_batalha');

    // 3. Animação Coração no Centro da Imagem
    const containerId = escolha === 'A' ? 'batalhaOpcaoA' : 'batalhaOpcaoB';
    const container = document.getElementById(containerId);
    if(container) {
        const heart = container.querySelector('.voto-animacao');
        if(heart) heart.classList.add('show');
    }
    tocarSom('ping');

    // 4. Salva o voto na FOTO (Background) - Isso não fecha o modal pois não altera o USER
    const vencedor = escolha === 'A' ? dueloAtual.A : dueloAtual.B;
    salvarVotoBatalha(vencedor).catch(e => console.log(e));

    // 5. Troca de Round (Apenas o perdedor sai)
    setTimeout(() => {
        try {
            let novoDesafiante;
            let tentativas = 0;
            do {
                novoDesafiante = pegarAleatorio();
                tentativas++;
            } while (novoDesafiante && (novoDesafiante.imgId === dueloAtual.A.imgId || novoDesafiante.imgId === dueloAtual.B.imgId) && tentativas < 50);

            if (escolha === 'A') dueloAtual.B = novoDesafiante;
            else dueloAtual.A = novoDesafiante;
            
            renderizarBatalha();
        } catch(e) { iniciarRoundInicial(); }
    }, 600); 
}

function abrirRota(barbeiroLat, barbeiroLon) {
    if (localizacaoCliente) {
        window.open(`https://www.google.com/maps/dir/?api=1&origin=$${localizacaoCliente.latitude},${localizacaoCliente.longitude}&destination=${barbeiroLat},${barbeiroLon}`, '_blank');
    } else {
        window.open(`https://www.google.com/maps/search/?api=1&query=$${barbeiroLat},${barbeiroLon}`, '_blank');
    }
}

function abrirModalTurbinar(){
    abrirModal('modalTurbinar');
}

function togglePasswordVisibility(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (!input || !iconElement) return; // Adiciona verificação
    if (input.type === "password") {
        input.type = "text";
        iconElement.textContent = '🙈';
    } else {
        input.type = "password";
        iconElement.textContent = '👁️';
    }
}

function abrirModalAlterarSenha() {
    // Limpa os campos ao abrir
    document.getElementById('senhaAtual').value = '';
    document.getElementById('novaSenha').value = '';
    document.getElementById('confirmarNovaSenha').value = '';
    // Garante que comecem como password
    document.getElementById('senhaAtual').type = 'password';
    document.getElementById('novaSenha').type = 'password';
    document.getElementById('confirmarNovaSenha').type = 'password';
    document.querySelectorAll('#modalAlterarSenha .show-password-toggle').forEach(el => el.textContent = '👁️'); // Seleciona ícones específicos deste modal

    abrirModal('modalAlterarSenha');
}

// 1. Verificar Acesso ao Balão (Inclui lógica de PRÊMIO TEMPORÁRIO DA ROLETA)
function verificarAcessoBalao(key) {
    const b = BALOES[key];
    const meusBaloes = perfil.baloesAdquiridos || [];
    
    if (b.adminOnly) {
        return perfil.tipo === 'admin' ? { acesso: true, tipo: 'permanente' } : { acesso: false, tipo: 'bloqueado_admin' };
    }
    if (meusBaloes.includes(key)) return { acesso: true, tipo: 'permanente' };

    // VERIFICAÇÃO CORRETA DO PRÊMIO
    if (perfil.premiosTemporarios && perfil.premiosTemporarios[`balao_${key}`]) {
        const validade = perfil.premiosTemporarios[`balao_${key}`].toDate();
        if (validade > new Date()) return { acesso: true, tipo: 'temporario_roleta', validade };
    }
    
    if (isProAtivo(perfil) && perfil.proTier) {
        // ... (lógica pro mantida) ...
         const tier = perfil.proTier;
         const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
         const baloesOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
         if (niveis.indexOf(tier) >= baloesOrdem.indexOf(key) && niveis.indexOf(tier) > -1) {
             return { acesso: true, tipo: 'temporario_pro' };
         }
    }
    return { acesso: false, tipo: 'nenhum' };
}

function atualizarVisibilidadeBotaoCheckin() {
    const btn = document.getElementById('btnCheckInManual');
    if (!btn || !perfil) return;

    const hoje = new Date().toDateString();
    
    // Se a data do último check-in for DIFERENTE de hoje, mostra o botão.
    // Se for IGUAL (já fez), esconde.
    if (perfil.ultimoCheckInDate !== hoje) {
        btn.style.display = 'inline-block'; // Mostra
    } else {
        btn.style.display = 'none'; // Esconde
    }
}

// 2. Renderizar Lista de Balões (Chame isso dentro de abrirModalPerfil)
function renderizarBaloes() {
    const container = document.getElementById('listaBaloes');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(BALOES).forEach(key => {
        const b = BALOES[key];
        
        // Filtro de Admin (não mostra se não for admin)
        if (b.adminOnly && perfil.tipo !== 'admin') return;

        const selecionado = perfil.balaoSelecionado === key;
        const statusAcesso = verificarAcessoBalao(key);
        
        const checkDisplay = selecionado ? 'flex' : 'none';
        let rodapeHtml = '';
        let estiloBorda = '';

        // Lógica de visualização do status
        if (statusAcesso.tipo === 'permanente') {
            const texto = b.adminOnly ? 'Exclusivo' : 'Adquirido';
            rodapeHtml = `<span style="font-size:10px; color:#4CAF50; margin-top:2px;">${texto}</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #4CAF50;'; 
        } 
        else if (statusAcesso.tipo === 'temporario_pro') {
            rodapeHtml = `<span style="font-size:9px; color:#00c6ff;">Liberado PRO</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #00c6ff;';
        } 
        else if (statusAcesso.tipo === 'temporario_roleta') {
            // --- CORREÇÃO AQUI ---
            // Antes estava calculando horas fixas. Agora usa o sistema de timer em tempo real.
            const ts = statusAcesso.validade.getTime();
            rodapeHtml = `<span class="contador-tempo-real" data-expire="${ts}" style="font-size:9px; color:#e57373; font-weight:bold;">Calculando...</span>`;
            estiloBorda = 'border-color: #e57373;';
        } 
        else {
            rodapeHtml = `<span style="font-size:10px; color:#ff9800; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; margin-top:2px;">R$${b.preco}</span>`;
            estiloBorda = 'opacity: 0.7;';
        }

        // Preview Visual do Balão dentro da loja
        const previewHtml = `
            <div class="chat-message ${b.classe} custom-bubble" style="width: 60px; height: 40px; display:flex; align-items:center; justify-content:center; font-size:10px; margin-bottom:5px;">
                Abc
            </div>
        `;

        container.innerHTML += `
            <div id="balao_${key}" class="moldura-item ${selecionada ? 'selecionada' : ''}" 
                 onclick="gerenciarBalao('${key}', this)" 
                 style="flex: 0 0 auto; width: 90px; display:flex; flex-direction:column; align-items:center; position:relative; cursor:pointer; margin: 0; ${estiloBorda}"> 
                 
                <div class="moldura-check" style="display: ${checkDisplay}; right: 10px;">✅</div>
                ${previewHtml}
                <span style="font-size:11px; font-weight:bold; color: #fff;">${b.nome}</span>
                ${rodapeHtml}
            </div>`;
    });
}

// 3. Gerenciar Clique no Balão
async function gerenciarBalao(key, element) {
    const b = BALOES[key];
    const statusAcesso = verificarAcessoBalao(key);
    
    // Se já tem (seja permanente, pro ou roleta), equipa direto
    if (statusAcesso.acesso) {
        selecionarMolduraVisualmente(element); // Reusa a função visual das molduras
        try {
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ balaoSelecionado: key });
        } catch (e) { exibirPopup("Erro ao salvar."); }
        return;
    }

    // Se não tem, compra
    executarCompraBalao(key, b);
}

// 4. Compra de Balão
// Função CORRIGIDA para usar Saldo Digital no Balão
function executarCompraBalao(key, b) {
    const saldoDigital = perfil.saldoDigital || 0;

    // CORREÇÃO: Verifica Saldo Digital
    if (saldoDigital < b.preco) {
        return exibirPopup("Moedas Insuficientes", "Você precisa de mais Saldo Digital (Moedas) para comprar este item.", "aviso", () => {
            iniciarCompraMoedas();
        });
    }
    
    exibirConfirmacao(
        "Comprar Estilo?", 
        `Deseja adquirir "${b.nome}" VITALÍCIO por ${b.preco.toFixed(2)} Moedas?`, 
        () => {
            exibirAguarde("Comprando...");
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                saldoDigital: firebase.firestore.FieldValue.increment(-b.preco), // CORREÇÃO: Desconta do Digital
                baloesAdquiridos: firebase.firestore.FieldValue.arrayUnion(key),
                balaoSelecionado: key
            }).then(() => {
                fecharTodosOsModais();
                exibirPopup("Sucesso!", "Item adquirido!", "sucesso", () => abrirModalPerfil());
            }).catch(e => {
                fecharTodosOsModais();
                exibirPopup("Erro na compra: " + e.message);
            });
        }
    );
}

async function executarAlteracaoSenha() {
    const senhaAtual = document.getElementById('senhaAtual').value;
    const novaSenha = document.getElementById('novaSenha').value;
    const confirmarNovaSenha = document.getElementById('confirmarNovaSenha').value;

    if (!senhaAtual || !novaSenha || !confirmarNovaSenha) {
        return exibirPopup("Preencha todos os campos.");
    }
    if (novaSenha.length < 6) {
        return exibirPopup("A nova senha deve ter pelo menos 6 caracteres.");
    }
    if (novaSenha !== confirmarNovaSenha) {
        return exibirPopup("As novas senhas não coincidem.");
    }

    exibirAguarde("Verificando senha atual...");
    const user = auth.currentUser;
    if (!user) { // Adiciona verificação de usuário
        fecharTodosOsModais();
        exibirPopup("Erro: Usuário não está logado.");
        mostrar('authView');
        return;
    }
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, senhaAtual);

    try {
        await user.reauthenticateWithCredential(credential);
        // Reautenticação bem-sucedida, agora atualiza a senha
        exibirAguarde("Atualizando senha..."); // Atualiza texto do popup
        await user.updatePassword(novaSenha);
        fecharTodosOsModais();
        exibirPopup("✅ Senha alterada com sucesso!");
        fecharModalAtual(); // Fecha o modal de alterar senha
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao alterar senha:", error);
        if (error.code === 'auth/wrong-password') {
            exibirPopup("❌ Senha atual incorreta. Tente novamente.");
        } else if (error.code === 'auth/too-many-requests') {
             exibirPopup("❌ Muitas tentativas incorretas. Tente novamente mais tarde.");
        } else {
            exibirPopup("❌ Erro ao alterar senha: " + error.message);
        }
    }
}

// --- SISTEMA DE ANIMAÇÃO DE SCROLL (OBSERVER API) ---
// Substitui a necessidade de bibliotecas pesadas como GSAP para coisas simples

document.addEventListener("DOMContentLoaded", () => {
    // Configura o observador
    const observerOptions = {
        threshold: 0.1, // Dispara quando 10% do elemento aparece
        rootMargin: "0px 0px -50px 0px" // Margem negativa para disparar um pouco antes
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                // Se quiser que anime apenas uma vez, descomente a linha abaixo:
                // observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    // Função para aplicar a classe em novos elementos dinâmicos
    window.ativarAnimacoesScroll = function() {
        const elementos = document.querySelectorAll('.card, .produto-card, .em-alta-item');
        elementos.forEach(el => {
            el.classList.add('reveal-on-scroll'); // Adiciona a classe base
            observer.observe(el); // Começa a observar
        });
    };

    // Chama inicialmente e configura um intervalo para verificar novos conteúdos carregados via AJAX
    ativarAnimacoesScroll();
    
    // Hack para observar elementos que surgem depois (ex: listas do Firebase)
    setInterval(ativarAnimacoesScroll, 2000); 
});

async function solicitarAlteracaoCidade() {
    if (!perfil) return exibirPopup("Erro", "Não foi possível carregar seu perfil.");

    // Limpa os inputs ao abrir
    document.getElementById('novoEstadoInput').value = '';
    document.getElementById('novoCidadeInput').value = '';

    abrirModal('modalAlterarCidadeInputs');
}

// Função chamada pelo botão "Confirmar" do modal de inputs
function processarInputsCidade() {
    const novoEstadoInput = document.getElementById('novoEstadoInput').value.trim();
    const novaCidadeInput = document.getElementById('novoCidadeInput').value.trim();

    if (!novoEstadoInput || !novaCidadeInput) {
        // Mostra erro dentro do modal ou usa exibirPopup
        exibirPopup("Atenção", "Por favor, preencha o estado e a cidade.");
        return;
    }

    const novoEstadoFormatado = formatarNomeProprio(novoEstadoInput);
    const novaCidadeFormatada = formatarNomeProprio(novaCidadeInput);

    // Fecha o modal de inputs
    fecharModalAtual();

    // Abre o modal de confirmação
    document.getElementById('confirmCidadeEstadoTexto').textContent = `${novaCidadeFormatada} - ${novoEstadoFormatado}`;
    // Define a ação do botão "Sim" para chamar a função final com os dados corretos
    document.getElementById('btnSimConfirmarCidade').onclick = () => executarAlteracaoCidadeAposConfirmacao(novoEstadoFormatado, novaCidadeFormatada);
    abrirModal('modalConfirmarAlteracaoCidade');
}

// Função que executa a lógica principal após a confirmação
async function executarAlteracaoCidadeAposConfirmacao(novoEstadoFormatado, novaCidadeFormatada) {
    // Fecha o modal de confirmação
    fecharModalAtual();

    exibirAguarde("Criando solicitação...");
    try {
        const solicitacaoRef = db.collection("solicitacoes").doc();
        await solicitacaoRef.set({
            id: solicitacaoRef.id,
            tipo: "alteracao_cidade",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            cidadeAtual: perfil.cidade,
            estadoAtual: perfil.estado,
            novoEstadoSolicitado: novoEstadoFormatado,
            novaCidadeSolicitada: novaCidadeFormatada,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        const mensagem = encodeURIComponent(`Olá! Gostaria de solicitar a alteração da minha cidade no app King Agenda.\n\nUsuário: ${perfil.nome}\nCidade Atual: ${perfil.cidade} - ${perfil.estado}\nNova Cidade: ${novaCidadeFormatada} - ${novoEstadoFormatado}\n\nID da Solicitação: ${solicitacaoRef.id}`);
        const phoneNum = WHATSAPP_ADM_PHONE.startsWith('55') ? WHATSAPP_ADM_PHONE : `55${WHATSAPP_ADM_PHONE.replace(/\D/g, '')}`; // Garante formato E.164
        window.open(`https://wa.me/${phoneNum}?text=${mensagem}`, '_blank');

        fecharAguarde(null, true);
        exibirPopup("Sucesso", "Solicitação enviada! Você foi redirecionado para o WhatsApp.");
        notifyAdmins("🏙️ Alteração de Cidade", `${perfil.nome} solicitou alterar para ${novaCidadeFormatada} - ${novoEstadoFormatado} (ID: ${solicitacaoRef.id}).`, { link: '#solicitacoes' });
        // Não precisa fechar modal aqui, pois já foram fechados

    } catch (error) {
        fecharAguarde(null, true);
        console.error("Erro ao solicitar alteração de cidade:", error);
        exibirPopup("Erro", "Não foi possível criar a solicitação: " + error.message);
    }
}

async function limparEconomiaDiretoNoBanco() {
    // 1. Confirmação de segurança para evitar acidentes
    const confirmar = confirm("🚨 ATENÇÃO: Você vai zerar pontosFidelidade, pontosKP, saldo e saldoDigital de TODOS os usuários. Confirmar?");
    if (!confirmar) return;

    exibirAguarde("Limpando dados da economia...");

    try {
        const usuariosRef = db.collection('usuarios'); // Acessa a coleção de usuários
        const snapshot = await usuariosRef.get();

        if (snapshot.empty) {
            fecharModalAtual(true);
            alert("Nenhum usuário encontrado para resetar.");
            return;
        }

        const batch = db.batch(); // Inicia o pacote de atualizações em massa

        snapshot.forEach(doc => {
            const userRef = usuariosRef.doc(doc.id);
            
            // Reseta exatamente os 4 campos que você listou
            batch.update(userRef, {
                pontosFidelidade: 0,
                pontosKP: 0,
                saldo: 0,
                saldoDigital: 0
            });
        });

        // Envia todas as alterações de uma vez para o Firestore
        await batch.commit();

        fecharModalAtual(true);
        exibirPopup("🚀 ECONOMIA ZERADA", "Todos os saldos e pontos foram definidos como 0.", 'sucesso');
        
        // Recarrega a página para atualizar os gráficos do painel
        setTimeout(() => location.reload(), 2000);

    } catch (error) {
        fecharModalAtual(true);
        console.error("Erro ao resetar banco:", error);
        alert("Erro técnico. Verifique se você tem permissão de administrador no Firebase.");
    }
}

let solicitacaoAtualId = null; // Variável global para guardar o ID da solicitação aberta
let solicitacaoAtualUid = null; // Variável global para guardar o UID do usuário da solicitação

async function abrirModalAdminCidade(id, s) {
  solicitacaoAtualId = id;
  solicitacaoAtualUid = s.usuarioUid;

  document.getElementById('adminCidadeNomeUsuario').textContent = s.usuarioNome;
  document.getElementById('adminCidadeAtual').textContent = `${s.cidadeAtual || 'N/A'} - ${s.estadoAtual || 'N/A'}`;

  // --- MODIFICATION START ---
  // Use the NEW unique IDs and prefix
  const estadoSelectId = 'adminNovoEstadoSolicitacao';
  const cidadeSelectId = 'adminNovoCidadeSolicitacao';
  const prefix = 'adminNovoSolicitacao'; // Define the correct prefix

  const estadoSelect = document.getElementById(estadoSelectId);
  const cidadeSelect = document.getElementById(cidadeSelectId);

  // Clear old city options
  cidadeSelect.innerHTML = '<option value="">Selecione o estado</option>';

  // Load states using the correct prefix
  carregarEstados(prefix);
  // Add a slight delay to ensure states are populated before setting value/loading cities
  setTimeout(() => {
    estadoSelect.value = s.estadoAtual || ""; // Set current state

    // Load cities for the selected state, using the correct prefix
    carregarCidades(prefix);
    // Add another delay to ensure cities are loaded before setting the value
    setTimeout(() => {
        // Set the current city if it exists in the loaded options
        if(cidadeSelect.querySelector(`option[value="${s.cidadeAtual}"]`)) {
            cidadeSelect.value = s.cidadeAtual;
        } else {
            cidadeSelect.value = ""; // Otherwise, default to "Select city"
        }
    }, 150); // Delay for city options loading
  }, 100); // Delay for state options loading
  // --- MODIFICATION END ---

  abrirModal('modalAdminDetalhesCidade');
}

/**
 * Faz upload de um arquivo para o Firebase Storage.
 * @param {File} file O arquivo a ser enviado.
 * @param {string} path O caminho no Storage (ex: 'logos/userId.jpg').
 * @param {function} [onProgress] Callback para progresso (opcional).
 * @returns {Promise<string>} A URL de download do arquivo.
 */
function uploadImage(file, path, onProgress) {
    return new Promise((resolve, reject) => {
        const storageRef = storage.ref(path);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload está ' + progress + '% concluído');
                if (onProgress) {
                    onProgress(progress); // Chama o callback de progresso
                }
            },
            (error) => {
                console.error("Erro no upload: ", error);
                reject(error);
            },
            () => {
                // Upload concluído com sucesso, pega a URL de download
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    console.log('Arquivo disponível em', downloadURL);
                    resolve(downloadURL); // Retorna a URL
                }).catch(reject);
            }
        );
    });
}

async function aprovarAlteracaoCidade() {
    // Lê dos inputs corretos
    const novoEstadoInput = document.getElementById('adminNovoEstadoSolicitacao');
    const novaCidadeInput = document.getElementById('adminNovoCidadeSolicitacao');

    const novoEstado = formatarNomeProprio(novoEstadoInput.value.trim());
    const novaCidade = formatarNomeProprio(novaCidadeInput.value.trim());

    if (!novoEstado || !novaCidade) {
        return exibirPopup("Erro", "Digite o novo estado e cidade.");
    }

    if (!confirm(`Confirmar alteração para ${novaCidade} - ${novoEstado}?`)) return;

    exibirAguarde("Atualizando cidade...");
    try {
        await db.runTransaction(async t => {
            const userRef = db.collection("usuarios").doc(solicitacaoAtualUid);
            const solicitacaoRef = db.collection("solicitacoes").doc(solicitacaoAtualId);

            t.update(userRef, { estado: novoEstado, cidade: novaCidade });
            t.update(solicitacaoRef, { status: "aprovado", novoEstado: novoEstado, novaCidade: novaCidade });
        });

        fecharTodosOsModais(); // Fecha Aguarde e Modal Detalhes
        exibirPopup("Sucesso", "Cidade do usuário alterada!");
        notifyUser(solicitacaoAtualUid, "✅ Cidade Alterada!", `Sua cidade foi atualizada para ${novaCidade} - ${novoEstado}.`);

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao aprovar alteração de cidade:", error);
        exibirPopup("Erro", "Não foi possível aprovar a alteração: " + error.message);
    } finally {
        // Limpa as variáveis globais após a operação
        solicitacaoAtualId = null;
        solicitacaoAtualUid = null;
    }
}

// Função auxiliar para recusar a solicitação aberta no modal de cidade
function recusarSolicitacaoAtual() {
    if (solicitacaoAtualId && solicitacaoAtualUid) {
         // Usa popup de confirmação customizado se você tiver um, senão usa confirm
        if (confirm("Tem certeza que deseja recusar esta solicitação?")) {
            recusarSolicitacao(solicitacaoAtualId, solicitacaoAtualUid, 'alteracao_cidade');
            fecharModalAtual(); // Fecha o modal de detalhes da cidade
        }
    }
}

// Funções da Loja
function abrirModalParaVender() {
    if (perfil.lojaLiberada || perfil.tipo === 'admin') {
        abrirFormularioProduto();
    } else {
        abrirModal('modalLiberarLoja');
    }
}

function solicitarLiberacaoLoja() {
    const mensagem = encodeURIComponent(`Olá, gostaria de solicitar autorização para cadastrar produtos na loja. Meu nome de usuário é ${perfil.nome}.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    db.collection("solicitacoes").add({
        tipo: "liberacao_loja",
        usuarioUid: auth.currentUser.uid,
        usuarioNome: perfil.nome,
        status: "pendente",
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        exibirPopup("Sua solicitação foi enviada ao administrador. Você será redirecionado para o WhatsApp para confirmar.");
        notifyAdmins("🛍️ Liberação de Loja", `${perfil.nome} quer permissão para vender.`, { link: '#solicitacoes' });
    }).catch(e => exibirPopup("Erro ao criar solicitação: " + e.message));
}

// --- SISTEMA DE ANIMAÇÃO "ROLAGEM VIVA" (SCROLL REVEAL) ---

document.addEventListener("DOMContentLoaded", () => {
    
    // Configuração do Observador
    const observerOptions = {
        root: null, // Usa a viewport do navegador
        rootMargin: '0px', // Sem margem extra
        threshold: 0.15 // Ativa quando 15% do elemento estiver visível
    };

    const scrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Quando entra na tela: Aparece
                entry.target.classList.add('scroll-visible');
                entry.target.classList.remove('scroll-hidden');
            } else {
                // Quando sai da tela: Some (Opcional: Se quiser que suma ao subir de volta)
                // Se quiser que fique visível depois de carregar, comente as duas linhas abaixo.
                entry.target.classList.remove('scroll-visible');
                entry.target.classList.add('scroll-hidden');
            }
        });
    }, observerOptions);

    // Função para aplicar o observador em novos elementos (chamada periodicamente)
    window.aplicarEfeitoScroll = function() {
        // Seleciona todos os elementos que devem ter animação
        const elementos = document.querySelectorAll('.card, .produto-card, .em-alta-item, .card-equipe-grid, .agenda-slot-card, .selectable-item');
        
        elementos.forEach(el => {
            // Se o elemento ainda não está sendo observado
            if (!el.classList.contains('observado-pelo-scroll')) {
                el.classList.add('observado-pelo-scroll'); // Marca como observado
                el.classList.add('scroll-hidden'); // Define estado inicial invisível
                scrollObserver.observe(el); // Começa a vigiar
            }
        });
    };

    // Roda imediatamente
    aplicarEfeitoScroll();

    // Roda a cada 1.5 segundos para pegar novos elementos carregados via AJAX/Firebase
    setInterval(aplicarEfeitoScroll, 1500);
});

function aprovarLiberacaoLoja(solicitacaoId, uid) {
    db.runTransaction(async t => {
        t.update(db.collection("usuarios").doc(uid), { lojaLiberada: true });
        t.update(db.collection("solicitacoes").doc(solicitacaoId), { status: "aprovado" });
    }).then(() => {
        exibirPopup("Acesso à loja liberado!");
        notifyUser(uid, "🛍️ Acesso à Loja Liberado!", "Parabéns! Você já pode cadastrar seus produtos para vender no app.");
    }).catch(e => exibirPopup("Erro ao aprovar: " + e.message));
}

async function carregarProdutos() {
    // ADICIONE ESTA LINHA NO COMEÇO:
    atualizarProgressoMissao('abrir_loja');
    // -----------------------------

    const container = document.getElementById('lojaContainer');
    
    // Injeta a barra de busca se não existir
    if (!document.getElementById('searchLojaInput')) {
        const searchInput = document.createElement('input');
        searchInput.id = 'searchLojaInput';
        searchInput.placeholder = '🔍 Buscar na loja...';
        searchInput.onkeyup = filtrarProdutosLoja;
        // Insere antes do container
        container.parentNode.insertBefore(searchInput, container);
    }

    container.innerHTML = '<p>Carregando loja...</p>';

    try {
        const produtosSnap = await db.collection('loja_produtos').orderBy('ts', 'desc').get();
        
        let premiumHtml = ''; 
        let officialHtml = '<h4 style="grid-column: 1 / -1;">⭐ Oficiais King Agenda ⭐</h4>';
        let communityProducts = [];
        let officialProductsFound = false;

        produtosSnap.forEach(doc => {
            const produto = { ...doc.data(), id: doc.id };
            const produtoJSON = JSON.stringify(produto).replace(/'/g, "\\'");
            
            if (produto.isPremium) {
                const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
                const imgUrl = (produto.imageUrls && produto.imageUrls.length > 0) ? produto.imageUrls[0] : 'https://placehold.co/250x250?text=Premium';
                
                premiumHtml += `
                <div class="produto-card produto-premium" onclick='handleProdutoClick(${produtoJSON})'>
                    <img src="${imgUrl}" style="height: 200px; object-fit: cover; border-bottom: 2px solid gold;">
                    <div class="produto-info">
                        <div class="produto-nome">🌟 ${produto.nome} 🌟</div>
                        <div class="produto-preco">R$ ${precoFinal.toFixed(2)}</div>
                        <p style="font-size: 10px; letter-spacing: 2px; margin-top: 5px;">EDICÃO LIMITADA</p>
                    </div>
                </div>`;
            } else if (produto.isOficial) {
                officialHtml += renderProdutoCard(produto, produtoJSON);
                officialProductsFound = true;
            } else {
                communityProducts.push({ data: produto, json: produtoJSON });
            }
        });

        if (!officialProductsFound) officialHtml += '<p style="grid-column: 1 / -1; font-size: 14px; opacity: 0.7;">Nenhum produto oficial comum.</p>';

        let communityHtml = '<h4 style="grid-column: 1 / -1; margin-top: 20px;">🛒 Marketplace da Comunidade</h4>';
        if (communityProducts.length === 0) {
            communityHtml += '<p style="grid-column: 1 / -1;">Nenhum produto da comunidade.</p>';
        } else {
            communityProducts.forEach(p => {
                communityHtml += renderProdutoCard(p.data, p.json);
            });
        }
        
        container.innerHTML = premiumHtml + officialHtml + communityHtml;

    } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        container.innerHTML = '<p>Ocorreu um erro ao carregar a loja.</p>';
    }
}

function filtrarProdutosLoja() {
    const termo = document.getElementById('searchLojaInput').value.toLowerCase();
    const produtos = document.querySelectorAll('.produto-card');
    produtos.forEach(card => {
        const nome = card.querySelector('.produto-nome').textContent.toLowerCase();
        if (nome.includes(termo)) card.style.display = "flex";
        else card.style.display = "none";
    });
}

function checkGuestLimit() {
    // PROTEÇÃO: Se auth.currentUser for null, retorna true (bloqueado) e não crasha
    if (!auth.currentUser) return true; 

    if (auth.currentUser.isAnonymous) {
        tocarSom('alerta'); 
        exibirConfirmacao(
            "Crie sua conta!", 
            "Para realizar agendamentos, pagamentos ou salvar seu progresso, você precisa de uma conta segura.",
            () => {
                fecharTodosOsModais();
                prepararCriarConta(); 
                mostrar('authView');
            }
        );
        return true; 
    }
    return false; 
}

function renderProdutoCard(p, pJson) {
    const precoFinal = p.desconto ? p.preco * (1 - p.desconto / 100) : p.preco;
    const precoHtml = p.desconto ? `<span class="produto-preco-original">R$ ${p.preco.toFixed(2)}</span> R$ ${precoFinal.toFixed(2)}` : `R$ ${p.preco.toFixed(2)}`;
    // Usa a primeira imagem do array 'imageUrls' ou a 'imagemUrl' antiga, ou um placeholder
    const imageUrlPrincipal = (p.imageUrls && p.imageUrls.length > 0) ? p.imageUrls[0] : p.imagemUrl;
    const placeholder = 'https://placehold.co/150x150?text=Nova+Versao'; // Placeholder atualizado

    return `
        <div class="produto-card" onclick='handleProdutoClick(${pJson})'>
            <img src="${imageUrlPrincipal || placeholder}" alt="${p.nome}" onerror="this.onerror=null; this.src='${placeholder}';">
            <div class="produto-info">
                <div class="produto-nome">${p.nome}</div>
                <div class="produto-preco">${precoHtml}</div>
            </div>
        </div>
    `;
}

async function exibirVersaoApp() {
    try {
        const response = await fetch('/index.html', { method: 'HEAD', cache: 'no-store' });
        const lastModified = response.headers.get('Last-Modified');
        if (lastModified) {
            const d = new Date(lastModified);
            const version = `V${d.getFullYear().toString().slice(-2)}.${(d.getMonth() + 1).toString().padStart(2, '0')}.${d.getDate().toString().padStart(2, '0')}.${d.getHours().toString().padStart(2, '0')}${d.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('appVersion').textContent = version;
        }
    } catch(e) {
        console.error("Erro ao obter King Agenda do app:", e);
        document.getElementById('appVersion').textContent = 'V.Local';
    }
}

function recarregarSaldoDoUsuario() {
    exibirPopup("💰 Seu saldo foi atualizado! A interface irá refletir a mudança em instantes.");
}

if (firebase.messaging.isSupported()) {
    messaging.onMessage((payload) => {
        console.log('Mensagem de primeiro plano recebida:', payload);

        if (payload.data && payload.data.tipo === 'atualizar_saldo') {
            recarregarSaldoDoUsuario();
        }

        if (payload.notification) {
            const notificationTitle = payload.notification.title;
            const notificationOptions = {
                body: payload.notification.body,
                icon: payload.notification.icon || '/icone.png'
            };
            if (Notification.permission === 'granted') {
                new Notification(notificationTitle, notificationOptions);
            }
        }
    });
}

async function abrirDetalhesProduto(produto) {
    produtoParaCompra = { ...produto }; // Copia o produto para evitar modificações indesejadas
    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;

    // Carrega Imagens no Carrossel
    const imagensContainer = document.getElementById('detalhesProdutoImagensContainer');
    const indicadoresContainer = document.getElementById('detalhesProdutoImagensIndicadores');
    imagensContainer.innerHTML = ''; // Limpa container
    indicadoresContainer.innerHTML = ''; // Limpa indicadores
    const imageUrls = produto.imageUrls || (produto.imagemUrl ? [produto.imagemUrl] : []); // Compatibilidade
    const placeholder = 'https://placehold.co/250x250?text=Nova+Versao'; // Placeholder atualizado

    if (imageUrls.length === 0) {
         imagensContainer.innerHTML = `<img src="${placeholder}" alt="Sem Imagem" style="width: 100%; height: 250px; object-fit: contain; scroll-snap-align: start; flex-shrink: 0;">`; // Adicionado flex-shrink
    } else {
        imageUrls.forEach((url, index) => {
            imagensContainer.innerHTML += `
                <img src="${url}" alt="Imagem ${index + 1} do Produto" style="width: 100%; height: 250px; object-fit: contain; scroll-snap-align: start; flex-shrink: 0;" onerror="this.onerror=null; this.src='${placeholder}';">`; // Adicionado flex-shrink
            // Adiciona indicador apenas se houver mais de uma imagem
            if (imageUrls.length > 1) {
                indicadoresContainer.innerHTML += `<span data-index="${index}" style="height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin: 0 3px; cursor: pointer; transition: background-color 0.3s ease;"></span>`;
            }
        });

        // Lógica dos indicadores (só executa se houver indicadores)
        if (imageUrls.length > 1) {
            const indicadores = indicadoresContainer.querySelectorAll('span');
            let scrollTimeout; // Para evitar múltiplos updates rápidos no scroll

            const updateIndicadores = () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => { // Debounce
                    const scrollLeft = imagensContainer.scrollLeft;
                    const imgWidth = imagensContainer.offsetWidth;
                    // Prevenção contra divisão por zero
                    const activeIndex = imgWidth > 0 ? Math.round(scrollLeft / imgWidth) : 0;
                    indicadores.forEach((span, index) => {
                        span.style.backgroundColor = index === activeIndex ? 'var(--cor-destaque)' : '#bbb';
                    });
                }, 50); // Atraso pequeno para debounce
            };


            // Atualiza na rolagem e ao clicar no indicador
            imagensContainer.onscroll = updateIndicadores;
            indicadores.forEach(span => {
                span.onclick = () => {
                    const index = parseInt(span.dataset.index);
                    imagensContainer.scrollTo({
                        left: index * imagensContainer.offsetWidth,
                        behavior: 'smooth'
                    });
                    // Atualiza imediatamente ao clicar
                     indicadores.forEach((s, i) => s.style.backgroundColor = i === index ? 'var(--cor-destaque)' : '#bbb');
                };
            });
            updateIndicadores(); // Atualiza na abertura inicial
        }
    }


    // Carrega outros detalhes
    document.getElementById('detalhesProdutoNome').textContent = produto.nome;
    document.getElementById('detalhesProdutoPreco').textContent = `R$ ${precoFinal.toFixed(2)}`;
    document.getElementById('detalhesProdutoDescricao').textContent = produto.descricao || 'Sem descrição.';

    // Carrega Tamanhos
    const tamanhosContainer = document.getElementById('detalhesProdutoTamanhos');
    tamanhosContainer.innerHTML = '';
    if (produto.tamanhos && produto.tamanhos.length > 0) {
        produto.tamanhos.forEach((t, index) => {
            tamanhosContainer.innerHTML += `<input type="radio" name="tamanho_selecionado" value="${t}" id="tamanho_${t}" ${index === 0 ? 'checked' : ''}><label for="tamanho_${t}">${t}</label>`;
        });
    } else {
        // Se não há tamanhos definidos, cria um input invisível com valor 'único'
        tamanhosContainer.innerHTML = '<input type="radio" name="tamanho_selecionado" value="único" id="tamanho_unico" checked style="display: none;"><label for="tamanho_unico">Tamanho único</label>';
    }

    // Carrega Avaliação
    const avaliacaoContainer = document.getElementById('detalhesProdutoAvaliacao');
    await carregarAvaliacaoProduto(produto.id, produto.nome, avaliacaoContainer);

    document.getElementById('btnComprarAgora').onclick = () => iniciarCompra(produto);
    abrirModal('modalProdutoDetalhes');
}


function iniciarCompra(produto) {
    const tamanhoSelecionado = document.querySelector('input[name="tamanho_selecionado"]:checked');
    if ((produto.tamanhos && produto.tamanhos.length > 0) && !tamanhoSelecionado) {
        return exibirPopup('Por favor, selecione um tamanho.');
    }
    produtoParaCompra.tamanhoSelecionado = tamanhoSelecionado ? tamanhoSelecionado.value : 'único';
    
    abrirModal('modalFormularioCompraLoja');
    document.getElementById('btnPagarCompraLoja').onclick = () => {
        const nome = document.getElementById('compraNomeCompleto').value;
        const cpf = document.getElementById('compraCpf').value;
        const telefone = document.getElementById('compraTelefone').value;
        const email = document.getElementById('compraEmail').value;
        const cep = document.getElementById('compraCep').value;
        const rua = document.getElementById('compraRua').value;
        const numero = document.getElementById('compraNumeroCasa').value;
        if (!nome || !cpf || !telefone || !email || !cep || !rua || !numero) {
            return exibirPopup('Todos os campos são obrigatórios.');
        }
        
        const precoFinal = produtoParaCompra.desconto ? produtoParaCompra.preco * (1 - produtoParaCompra.desconto / 100) : produtoParaCompra.preco;
        document.getElementById('valorDebito').textContent = precoFinal.toFixed(2);
        
        const overlay = document.getElementById('overlayPagamento');
        overlay.classList.remove('hidden');
        document.getElementById('btnNaoDebitar').onclick = () => overlay.classList.add('hidden');
        document.getElementById('btnSimDebitar').onclick = () => confirmarCompraLoja({ nome, cpf, telefone, email, cep, rua, numero });
    };
}

async function confirmarCompraLoja(dadosEntrega) {
    exibirAguarde("Processando seu pedido...");
    const produto = produtoParaCompra;
    
    // Calcula o Preço Final do Produto (considerando desconto do item, se houver)
    const precoTotal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;

    // --- LEITURA DOS SALDOS ATUAIS ---
    // Fallback: se não tiver saldoReal, usa o 'saldo' antigo
    const saldoRealDisponivel = (perfil.saldoReal !== undefined) ? perfil.saldoReal : (perfil.saldo || 0);
    const saldoBonusDisponivel = perfil.saldoBonus || 0;

    // --- LÓGICA DE PAGAMENTO (REGRA 1 PRA 1) ---
    
    // 1. Qual é o máximo de bônus permitido? (50% do valor do produto)
    const limiteMaximoBonus = precoTotal / 2;

    // 2. Quanto vamos usar de bônus?
    // A regra é: "Usar o máximo possível de bônus, respeitando o limite de 50%".
    // Então pegamos o MENOR valor entre: O que o usuário tem X O limite de 50%.
    const usoBonus = Math.min(saldoBonusDisponivel, limiteMaximoBonus);
    
    // 3. O restante deve ser pago com Saldo Real
    const usoReal = precoTotal - usoBonus;

    // --- EXEMPLOS MATEMÁTICOS PARA CONFERÊNCIA ---
    // Ex 1: Produto 60. Limite Bonus = 30. Tenho 49 Bonus.
    // usoBonus = Math.min(49, 30) -> 30.
    // usoReal = 60 - 30 -> 30. (Fica 30/30 - OK)
    
    // Ex 2: Produto 100. Limite Bonus = 50. Tenho 49 Bonus.
    // usoBonus = Math.min(49, 50) -> 49. (Usa tudo que tem)
    // usoReal = 100 - 49 -> 51. (Fica 49/51 - OK)

    // --- VALIDAÇÃO ---
    // Verifica se o usuário tem saldo REAL suficiente para cobrir a parte dele
    if (saldoRealDisponivel < usoReal) {
        fecharTodosOsModais();
        exibirPopup('Saldo Real Insuficiente', 
            `Valor do produto: R$ ${precoTotal.toFixed(2)}\n\n` +
            `🔹 Bônus Aplicado: R$ ${usoBonus.toFixed(2)}\n` +
            `💵 Necessário em Saldo Real: R$ ${usoReal.toFixed(2)}\n\n` +
            `Você tem apenas R$ ${saldoRealDisponivel.toFixed(2)} em Saldo Real.`,
            "aviso", 
            () => abrirModalCarteira()
        );
        return; 
    }

    try {
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const produtoRef = db.collection("loja_produtos").doc(produto.id);

            // 1. Debita os saldos separadamente
            const updates = {};
            
            // Debita do Saldo Bônus
            if (usoBonus > 0) {
                updates.saldoBonus = firebase.firestore.FieldValue.increment(-usoBonus);
            }

            // Debita do Saldo Real
            // Se o campo saldoReal existe, usa ele. Se não, usa 'saldo' para compatibilidade.
            if (perfil.saldoReal !== undefined) {
                updates.saldoReal = firebase.firestore.FieldValue.increment(-usoReal);
            } else {
                updates.saldo = firebase.firestore.FieldValue.increment(-usoReal);
            }

            t.update(clienteRef, updates);
            
            // 2. Incrementa contagem de vendas do produto
            t.update(produtoRef, { vendasRealizadas: firebase.firestore.FieldValue.increment(1) });

            // 3. Cria o pedido com os detalhes do pagamento
            t.set(db.collection("loja_pedidos").doc(), {
                produtoId: produto.id,
                produtoNome: produto.nome,
                valor: precoTotal, // Valor total da venda
                pagamentoInfo: { 
                    real: usoReal, 
                    bonus: usoBonus,
                    regra: "max_50_percent_bonus"
                }, 
                tamanho: produto.tamanhoSelecionado,
                clienteUid: auth.currentUser.uid,
                clienteNome: perfil.nome,
                endereco: `${dadosEntrega.rua}, ${dadosEntrega.numero}`,
                cpf: dadosEntrega.cpf,
                telefone: dadosEntrega.telefone,
                email: dadosEntrega.email,
                cep: dadosEntrega.cep,
                vendedorUid: produto.vendedorUid,
                vendedorNotificado: false,
                status: "pendente",
                avaliado: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        fecharTodosOsModais();
        
        // Mensagem de sucesso detalhando o pagamento
        exibirPopup("Pedido Realizado!", 
            `Pagamento efetuado com sucesso!\n\n` +
            `💵 Saldo Real: -R$ ${usoReal.toFixed(2)}\n` +
            `🎁 Saldo Bônus: -R$ ${usoBonus.toFixed(2)}`
        );
        
        notifyUser(produto.vendedorUid, '🎉 Nova Venda!', `Você vendeu "${produto.nome}"! Acesse 'Entregas' para enviar.`, { link: '#entregas' });

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup('Erro ao processar a compra: ' + e.message);
    }
}

// Nova Função para Admin Adicionar Giros na Roleta
async function adminAdicionarGiros(uid) {
    const inputGiros = document.getElementById('adminInputGiros');
    const qtde = parseInt(inputGiros.value);

    if (isNaN(qtde) || qtde <= 0) {
        return exibirPopup("Valor inválido", "Digite uma quantidade válida de giros.");
    }

    if (!confirm(`Deseja adicionar ${qtde} giros extras para este usuário hoje?`)) return;

    exibirAguarde("Adicionando giros...");

    try {
        await db.collection('usuarios').doc(uid).update({
            girosRealizadosHoje: firebase.firestore.FieldValue.increment(-qtde),
            // Atualiza a data para garantir que o front entenda que é "hoje" e use o valor
            ultimoGiroRoleta: new Date().toDateString() 
        });

        fecharTodosOsModais();
        exibirPopup("Sucesso", `${qtde} giros adicionados!`);
        abrirModalGerenciarUsuario(uid); 
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível adicionar giros: " + e.message);
    }
}

async function abrirGerenciarLoja() {
    abrirModal('modalGerenciarLoja');
    const container = document.getElementById('listaMeusProdutos');
    container.innerHTML = '<p>Carregando seus produtos...</p>';
    
    const snap = await db.collection('loja_produtos').where('vendedorUid', '==', auth.currentUser.uid).get();
    if (snap.empty) {
        container.innerHTML = '<p>Você ainda não tem produtos cadastrados.</p>';
        return;
    }
    
    container.innerHTML = '';
    snap.forEach(doc => {
        const p = doc.data();
        container.innerHTML += `
            <div class="card">
                ${p.nome} - R$ ${p.preco.toFixed(2)}
                <p>Vendas: ${p.vendasRealizadas || 0}</p>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="abrirFormularioProduto('${doc.id}')" style="font-size:12px; padding: 5px 8px;">✏️ Editar</button>
                    <button onclick="deletarProdutoVendedor('${doc.id}')" style="background: #c0392b; font-size:12px; padding: 5px 8px;">🗑️ Excluir</button>
                </div>
            </div>`;
    });
}

// Função auxiliar para marcar/desmarcar imagem de PRODUTO para exclusão
function marcarImagemProdutoParaExcluir(buttonElement, imageUrl) {
    const imgContainer = buttonElement.parentElement;
    const imgElement = imgContainer.querySelector('img');
    const isMarked = imgContainer.classList.toggle('marcada-para-excluir');
    const fileInput = document.getElementById('produtoFiles');
    const labelFileInput = document.getElementById('labelProdutoFiles');
    const contadorImagensElement = document.getElementById('produtoContadorImagens');

    if (isMarked) {
        imagensMarcadasParaExcluir.push(imageUrl); // Adiciona ao array de exclusão
        buttonElement.textContent = '↩️';
        buttonElement.title = 'Manter Imagem';
        imgElement.style.opacity = '0.5';
        imgElement.style.border = '2px solid red';
    } else {
        // Remove do array de exclusão
        imagensMarcadasParaExcluir = imagensMarcadasParaExcluir.filter(url => url !== imageUrl);
        buttonElement.textContent = '❌';
        buttonElement.title = 'Excluir Imagem';
        imgElement.style.opacity = '1';
        imgElement.style.border = 'none';
    }

     // Atualiza contador e estado do input de novas imagens
     const previewsExistentesContainer = document.getElementById('produtoPreviewsExistentes');
     const existingImagesTotal = previewsExistentesContainer.querySelectorAll('div[data-url]').length; // Total inicial
     const currentImageCount = existingImagesTotal - imagensMarcadasParaExcluir.length; // Quantas ficarão
     const allowedNew = 5 - currentImageCount;

     if (contadorImagensElement) contadorImagensElement.textContent = currentImageCount; // Atualiza o contador exibido

     if (allowedNew <= 0) {
         fileInput.disabled = true;
         fileInput.value = ''; // Limpa seleção se não pode adicionar mais
         document.getElementById('produtoPreviewsNovas').innerHTML = '';
         labelFileInput.textContent = 'Limite de 5 imagens atingido.';
     } else {
         fileInput.disabled = false;
         labelFileInput.textContent = `Adicionar Novas Imagens (${allowedNew} restantes):`;
         // Se o número de arquivos selecionados agora excede o limite, limpa
         if (fileInput.files.length > allowedNew) {
             fileInput.value = '';
             document.getElementById('produtoPreviewsNovas').innerHTML = '';
             exibirPopup("Atenção", `Você só pode adicionar ${allowedNew} nova(s) imagem(ns) devido às exclusões marcadas. Selecione novamente.`);
         }
     }
}

function marcarImagemPortfolioParaExcluir(buttonElement, imageUrl) {
    const imgContainer = buttonElement.parentElement;
    const imgElement = imgContainer.querySelector('img');
    const isMarked = imgContainer.classList.toggle('marcada-para-excluir');
    
    if (isMarked) {
        imagensMarcadasParaExcluir.push(imageUrl); // Adiciona ao array de exclusão
        buttonElement.textContent = '↩️';
        buttonElement.title = 'Manter Imagem';
        imgElement.style.opacity = '0.5';
        imgElement.style.border = '2px solid red';
    } else {
        // Remove do array de exclusão
        imagensMarcadasParaExcluir = imagensMarcadasParaExcluir.filter(url => url !== imageUrl);
        buttonElement.textContent = '❌';
        buttonElement.title = 'Remover Imagem';
        imgElement.style.opacity = '1';
        imgElement.style.border = '1px solid var(--cor-borda)'; // Volta ao normal
    }

     // Atualiza contador, input e botão salvar
     atualizarContadorEInputPortfolio();
}

async function abrirFormularioProduto(produtoId = null, isPremium = false) {
    produtoEmEdicaoId = produtoId;
    imagensMarcadasParaExcluir = []; 
    const modal = document.getElementById('modalAddEditProduto');
    
    // Título Diferente para Premium
    const titulo = isPremium ? '🌟 Novo Produto PREMIUM' : (produtoId ? '✏️ Editar Produto' : '📦 Adicionar Novo Produto');
    document.getElementById('formProdutoTitulo').textContent = titulo;

    // Guarda flag no dataset do modal
    modal.dataset.isPremium = isPremium ? 'true' : 'false';

    const nomeInput = modal.querySelector('#produtoNome');
    const precoInput = modal.querySelector('#produtoPreco');
    const descontoInput = modal.querySelector('#produtoDesconto');
    const descricaoInput = modal.querySelector('#produtoDescricao');
    const tamanhosCheckboxes = modal.querySelectorAll('input[name="tamanhos"]');
    const fileInput = modal.querySelector('#produtoFiles');
    const labelFileInput = modal.querySelector('#labelProdutoFiles');
    const previewsExistentesContainer = modal.querySelector('#produtoPreviewsExistentes');
    const previewsNovasContainer = modal.querySelector('#produtoPreviewsNovas');
    const progressBar = modal.querySelector('#produtoUploadProgress');
    const btnSalvar = modal.querySelector('#btnSalvarProduto');
    const contadorImagensElement = modal.querySelector('#produtoContadorImagens');

    nomeInput.value = '';
    precoInput.value = '';
    descontoInput.value = '';
    descricaoInput.value = '';
    tamanhosCheckboxes.forEach(c => c.checked = false);
    fileInput.value = ''; 
    fileInput.disabled = false; 
    labelFileInput.textContent = 'Adicionar Novas Imagens';
    previewsExistentesContainer.innerHTML = '';
    previewsNovasContainer.innerHTML = '';
    progressBar.style.display = 'none';
    progressBar.value = 0;
    btnSalvar.disabled = false; 
    contadorImagensElement.textContent = '0'; 

    let existingImageUrls = [];
    if (produtoId) {
        exibirAguarde("Carregando dados do produto...");
        try {
            const doc = await db.collection('loja_produtos').doc(produtoId).get();
            if (!doc.exists) throw new Error("Produto não encontrado.");
            const p = doc.data();

            nomeInput.value = p.nome || '';
            precoInput.value = p.preco || '';
            descontoInput.value = p.desconto || '';
            descricaoInput.value = p.descricao || '';
            if (p.tamanhos && Array.isArray(p.tamanhos)) {
                p.tamanhos.forEach(t => {
                    const checkbox = modal.querySelector(`input[value="${t}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            existingImageUrls = p.imageUrls || (p.imagemUrl ? [p.imagemUrl] : []);
            contadorImagensElement.textContent = existingImageUrls.length; 
            existingImageUrls.forEach(url => {
                 previewsExistentesContainer.innerHTML += `
                    <div style="position: relative; margin-right: 5px;" data-url="${url}">
                        <img src="${url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" alt="Imagem Existente">
                        <button onclick="marcarImagemProdutoParaExcluir(this, '${url}')" style="position: absolute; top: 0; right: 0; background: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; line-height: 18px; padding: 0; cursor: pointer;" title="Excluir Imagem">❌</button>
                    </div>`;
            });
            fecharAguarde(null, true);
        } catch (error) {
            fecharAguarde(null, true);
            exibirPopup("Erro", "Não foi possível carregar os dados do produto: " + error.message);
            return;
        }
    } else {
         if (existingImageUrls.length >= 5) {
            fileInput.disabled = true;
            labelFileInput.textContent = 'Limite de 5 imagens atingido.';
         }
    }

    fileInput.onchange = null;
    fileInput.onchange = () => {
        previewsNovasContainer.innerHTML = '';
        const files = fileInput.files;
        const currentImageCount = existingImageUrls.length - imagensMarcadasParaExcluir.length;
        const allowedNew = 5 - currentImageCount;

        if (files.length > 0) {
            if (files.length > allowedNew) {
                exibirPopup("Limite de Imagens", `Você pode adicionar no máximo mais ${allowedNew} imagens (total de 5).`);
                fileInput.value = ''; 
                return;
            }
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewsNovasContainer.innerHTML += `<img src="${e.target.result}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 5px;" alt="Nova Imagem">`;
                }
                reader.readAsDataURL(file);
            });
        }
    };

    const currentCountInitial = existingImageUrls.length;
    if (currentCountInitial >= 5) {
        fileInput.disabled = true;
        labelFileInput.textContent = 'Limite de 5 imagens atingido.';
    } else {
         fileInput.disabled = false;
         labelFileInput.textContent = `Adicionar Novas Imagens (${5 - currentCountInitial} restantes):`;
    }

    abrirModal('modalAddEditProduto');
}

async function salvarProdutoVendedor() {
    const modal = document.getElementById('modalAddEditProduto');
    const nome = modal.querySelector('#produtoNome').value.trim();
    const preco = parseFloat(modal.querySelector('#produtoPreco').value);
    
    // --- CORREÇÃO: Tratamento robusto do Desconto Opcional ---
    const descontoInput = modal.querySelector('#produtoDesconto').value.trim();
    let desconto = null;
    if (descontoInput !== "") {
        desconto = parseInt(descontoInput);
    }

    const descricao = modal.querySelector('#produtoDescricao').value.trim();
    const tamanhosSelecionados = Array.from(modal.querySelectorAll('input[name="tamanhos"]:checked')).map(cb => cb.value);
    const fileInput = modal.querySelector('#produtoFiles');
    const progressBar = modal.querySelector('#produtoUploadProgress');
    const btnSalvar = modal.querySelector('#btnSalvarProduto');
    
    // Pega Flag Premium
    const isPremium = modal.dataset.isPremium === 'true';

    if (!nome || isNaN(preco) || preco <= 0 || !descricao || tamanhosSelecionados.length === 0) {
        return exibirPopup('Preencha todos os campos obrigatórios (*): Nome, Preço, Descrição e pelo menos um Tamanho.');
    }
    
    // Validação do desconto corrigida: Só reclama se for número inválido
    if (desconto !== null && (isNaN(desconto) || desconto < 1 || desconto > 99)) {
        return exibirPopup('O desconto deve ser um número entre 1 e 99 (ou deixe em branco).');
    }

    const files = fileInput.files;
    const imagensExistentesParaManter = [];
    modal.querySelectorAll('#produtoPreviewsExistentes div[data-url]:not(.marcada-para-excluir)').forEach(div => {
        imagensExistentesParaManter.push(div.dataset.url);
    });

    const totalImagensFinais = imagensExistentesParaManter.length + (files ? files.length : 0);

    if (totalImagensFinais === 0) {
        return exibirPopup('O produto precisa ter pelo menos uma imagem.');
    }
    if (totalImagensFinais > 5) {
        return exibirPopup(`O produto pode ter no máximo 5 imagens. Você está tentando salvar ${totalImagensFinais}.`);
    }

    exibirAguarde("Salvando produto...");
    btnSalvar.disabled = true;
    progressBar.style.display = 'block';
    progressBar.value = 0;

    const uploadPromises = [];
    const newImageUrls = [];
    let totalBytesUpload = 0;
    const uploadTasksInfo = [];

    if (files && files.length > 0) {
        totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
        Array.from(files).forEach((file, index) => {
            const productIdForPath = produtoEmEdicaoId || `new_${auth.currentUser.uid}_${Date.now()}`;
            const filePath = `products/${auth.currentUser.uid}/${productIdForPath}/${Date.now()}_${index}_${file.name}`;
            const uploadPromise = new Promise((resolve, reject) => {
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);
                const taskInfo = { task: uploadTask, bytesTransferred: 0 };
                uploadTasksInfo.push(taskInfo);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        taskInfo.bytesTransferred = snapshot.bytesTransferred;
                        let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                        const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                        progressBar.value = progress;
                    },
                    (error) => reject(error),
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            newImageUrls.push(downloadURL); 
                            resolve();
                        } catch(urlError) { reject(urlError); }
                    }
                );
            });
            uploadPromises.push(uploadPromise);
        });
    }

    try {
        await Promise.all(uploadPromises);

        const deletePromises = imagensMarcadasParaExcluir.map(async url => {
            try {
                const decodedUrl = decodeURIComponent(url);
                const pathRegex = /\/o\/(.+)\?alt=media/;
                const match = decodedUrl.match(pathRegex);
                if (match && match[1]) {
                    const filePath = match[1];
                    await storage.ref(filePath).delete();
                }
            } catch (e) { console.warn("Erro ao deletar imagem:", e); }
        });
        await Promise.all(deletePromises);

        const finalImageUrls = [...imagensExistentesParaManter, ...newImageUrls];

        const productData = {
            nome,
            preco,
            // Salva null ou deleta o campo se não houver desconto
            desconto: desconto !== null ? desconto : firebase.firestore.FieldValue.delete(),
            descricao,
            tamanhos: tamanhosSelecionados,
            imageUrls: finalImageUrls, 
            imagemUrl: finalImageUrls[0] || null,
            vendedorUid: auth.currentUser.uid,
            vendedorNome: perfil.nome,
            isOficial: perfil.tipo === 'admin',
            isPremium: isPremium
        };

        if (produtoEmEdicaoId) {
            await db.collection('loja_produtos').doc(produtoEmEdicaoId).update(productData);
        } else {
            productData.ts = firebase.firestore.FieldValue.serverTimestamp();
            productData.vendasRealizadas = 0;
            await db.collection('loja_produtos').add(productData);
        }

        fecharTodosOsModais();
        exibirPopup('Produto salvo com sucesso!');
        if(perfil.tipo === 'admin') abrirGerenciarLojaAdmin();
        else abrirGerenciarLoja();

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup('Erro ao salvar produto: ' + (error.message || error));
        btnSalvar.disabled = false;
        progressBar.style.display = 'none';
    }
}

function habilitarEnterParaFormulario(inputIds, buttonId) {
    const button = document.getElementById(buttonId);
    if (!button) {
        console.warn(`Botão com ID "${buttonId}" não encontrado para habilitar Enter.`);
        return;
    }

    inputIds.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('keyup', function(event) {
                // Verifica se a tecla pressionada foi "Enter" e se não é um textarea (para permitir Shift+Enter)
                if (event.key === 'Enter' && input.tagName.toLowerCase() !== 'textarea') {
                    event.preventDefault(); // Impede envio padrão se houver <form>
                    if (!button.disabled) { // Só clica se o botão não estiver desabilitado
                       button.click();
                    }
                }
            });
        } else {
             console.warn(`Input com ID "${inputId}" não encontrado para habilitar Enter no botão "${buttonId}".`);
        }
    });
}

async function deletarProdutoVendedor(produtoId) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        exibirPopup('Produto excluído.');
        abrirGerenciarLoja();
    }
}

async function abrirEntregasVendedor() {
    abrirModal('modalEntregasVendedor');
    const container = document.getElementById('listaEntregas');
    container.innerHTML = '<p>Carregando entregas...</p>';

    if (pedidosVendedorListener) pedidosVendedorListener();

    pedidosVendedorListener = db.collection('loja_pedidos')
      .where('vendedorUid', '==', auth.currentUser.uid)
      // Trazemos status relevantes para o vendedor
      .where('status', 'in', ['pendente', 'enviado', 'entregue_pendente_confirmacao', 'disputa']) 
      .orderBy('ts', 'desc')
      .onSnapshot(snap => {
        if(snap.empty) {
            container.innerHTML = '<p>Nenhuma entrega ativa.</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
            const pedido = doc.data();
            let statusHtml = '';
            let acaoHtml = '';

            // Lógica de Status e Botões do Vendedor
            if (pedido.status === 'pendente') {
                statusHtml = '<p style="color: #f1c40f;">📦 Status: Aguardando Envio</p>';
                // ALTERAÇÃO AQUI: Adicionada a classe 'notificacao-pulsante' para sinalizar
                acaoHtml = `<button onclick="marcarProdutoEnviado('${doc.id}', '${pedido.clienteUid}')" class="notificacao-pulsante" style="background: #3498db;">🚚 Marcar Produto Enviado</button>`;
            } 
            else if (pedido.status === 'enviado') {
                statusHtml = '<p style="color: #3498db;">🚚 Status: A Caminho (Aguardando Cliente)</p>';
                acaoHtml = `<button onclick="enviarLembreteConfirmacao('${doc.id}', '${pedido.clienteUid}')" style="background: #555; font-size: 12px;">🔔 Enviar Lembrete ao Cliente</button>`;
            }
            else if (pedido.status === 'entregue_pendente_confirmacao') {
                statusHtml = '<p style="color: #9b59b6;">⏳ Status: Cliente Confirmando Recebimento...</p>';
                acaoHtml = `<button disabled style="opacity: 0.7; cursor: not-allowed;">Aguardando Cliente</button>`;
            } 
            else if (pedido.status === 'disputa') {
                statusHtml = '<p style="color: #e74c3c;">🚨 Status: Problema Reportado pelo Cliente</p>';
                acaoHtml = `<button onclick="window.open('https://wa.me/${pedido.telefone.replace(/\\D/g,'')}', '_blank')">💬 Contatar Cliente</button>`;
            }

            container.innerHTML += `
                <div class="card">
                    Comprador: ${pedido.clienteNome}
                    <p>Produto: ${pedido.produtoNome} (T: ${pedido.tamanho}) - R$ ${pedido.valor.toFixed(2)}</p>
                    <p>Endereço: ${pedido.endereco} - CEP: ${pedido.cep}</p>
                    <p>WhatsApp: <a href="https://wa.me/55${pedido.telefone.replace(/\D/g,'')}" target="_blank">${pedido.telefone}</a></p>
                    ${statusHtml}
                    <div style="margin-top: 10px;">${acaoHtml}</div>
                </div>`;
        });
    });
}

async function marcarProdutoEnviado(pedidoId, clienteUid) {
    if (!confirm("Confirmar que o produto foi enviado? O status mudará para 'A Caminho'.")) return;
    
    exibirAguarde("Atualizando status...");
    try {
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: 'enviado' });
        fecharTodosOsModais(); // Fecha o aguarde
        
        // Notifica o comprador
        notifyUser(clienteUid, '🚚 Produto a Caminho!', 'O vendedor despachou seu produto. Quando chegar, confirme no app.', { link: '#minhascompras' });
        
        exibirPopup("Status Atualizado", "O cliente foi notificado que o produto está a caminho.");
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

function enviarLembreteConfirmacao(pedidoId, clienteUid) {
    if(confirm("Enviar lembrete para o cliente confirmar o recebimento? Use apenas se o produto já deveria ter chegado.")) {
        notifyUser(clienteUid, '🔔 Confirme a Entrega', 'Se você já recebeu seu produto, por favor confirme no app para liberar o vendedor.', { link: '#minhascompras' });
        exibirPopup("Lembrete enviado!");
    }
}

function notificarCompradorEntrega(pedidoId, clienteUid) {
    // Optional: Add logic here to prevent spamming the buyer (e.g., check last notification time)
    if (confirm("Enviar um lembrete para o comprador confirmar o recebimento?")) {
        notifyUser(clienteUid, '🚚 Confirme o Recebimento!', 'Lembrete: Seu pedido foi marcado como entregue. Por favor, confirme o recebimento no app para liberar o pagamento ao vendedor.');
        exibirPopup('Lembrete enviado ao comprador.');
    }
}

/**
 * Inicia o rastreamento (Cliente indo até o Barbeiro ou vice-versa).
 * @param {string} outroUid - UID da outra pessoa.
 * @param {number} destLat - Latitude do destino.
 * @param {number} destLon - Longitude do destino.
 * @param {string} papel - 'cliente' (quem viaja) ou 'profissional' (quem espera).
 */

function limparMapaSeguro() {
    try {
        // 1. Remove o controle de rotas PRIMEIRO (Isso corrige o erro removeLayer)
        if (routingControl && mapRastreamento) {
            try { mapRastreamento.removeControl(routingControl); } catch(e) {}
        }
        routingControl = null;

        // 2. Remove o mapa DEPOIS
        if (mapRastreamento) {
            mapRastreamento.off(); // Remove listeners
            mapRastreamento.remove(); // Destrói o mapa
            mapRastreamento = null;
        }

        // 3. Limpa o container HTML
        const container = document.getElementById('mapaRastreamento');
        if (container) {
            container._leaflet_id = null; 
            container.innerHTML = ""; 
        }
    } catch (e) {
        console.warn("Erro ao limpar mapa (ignorado):", e);
    }
}

let rotaControl = null;
let chatTempId = null;

// --- FUNÇÃO AUXILIAR DE BUSCA ---
async function iniciarRastreamentoBusca(targetUid, nome, agendamentoId) {
    exibirAguarde("Buscando localização...");
    try {
        const doc = await db.collection('usuarios').doc(targetUid).get();
        if(doc.exists && doc.data().latitude && doc.data().longitude) {
            fecharTodosOsModais();
            // Deduz o papel automaticamente
            const meuPapel = (perfil.tipo === 'cliente') ? 'cliente' : 'profissional';
            iniciarRastreamento(targetUid, doc.data().latitude, doc.data().longitude, meuPapel, agendamentoId);
        } else {
            fecharTodosOsModais();
            exibirPopup("Aviso", `O usuário ${nome} não possui localização definida no momento.`);
        }
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Falha ao buscar localização.");
    }
}

// 1. INICIALIZAÇÃO DO MAPA (CORREÇÃO: SINCRONIA REAL-TIME CLIENTE -> PROFISSIONAL)
// Variável global para o bloqueio de tela


// =========================================================================
// === SISTEMA DE MAPA "CHICLETE" (CORRIGIDO) ===
// =========================================================================

// Variáveis Globais (Usando var para evitar erro de redeclaração se colar por cima)
var mapReopenTimer = null;      // O temporizador de 15 segundos
var currentTrackingData = null; // Guarda os dados da rota atual para reabrir
var wakeLock = null;            // Bloqueio de tela

var currentTransportMode = 'driving'; 
var targetUserPhoto = null; 
var userRoleMap = 'cliente'; 

// Verifica variáveis para evitar erros de undefined
if (typeof mapRastreamento === 'undefined') var mapRastreamento = null;
if (typeof routingControl === 'undefined') var routingControl = null;
if (typeof watchIdGPS === 'undefined') var watchIdGPS = null;

var ultimoTempoSegundos = 0;
var unsubscribeTransporte = null;
var unsubscribeChatNotif = null;

// --- 1. INICIALIZAÇÃO DO MAPA (COM PERSISTÊNCIA) ---
async function iniciarRastreamento(outroUid, destLat, destLon, papel, agendamentoId) {
    // SALVA O ESTADO PARA RECUPERAR SE O APP FECHAR
    const dadosSessao = {
        outroUid, destLat, destLon, papel, agendamentoId,
        timestamp: Date.now()
    };
    localStorage.setItem('sessao_rastreamento_ativa', JSON.stringify(dadosSessao));

    if (typeof twacommand !== 'undefined' && typeof twacommand.twacommand === 'function') {
        twacommand.twacommand('LocationTracking', 'START'); 
        console.log("Comando nativo START enviado.");
    }
 
    // Se o mapa já existe (apenas minimizado), maximiza
    if (mapRastreamento && document.getElementById('btnMinimizadoMapa').style.display !== 'none') {
        maximizarMapa();
        return;
    }

    // Garante que o botão minimizado esteja oculto durante o carregamento
    document.getElementById('btnMinimizadoMapa').style.display = 'none';

    userRoleMap = papel; 
    agendamentoState.barbeiroLat = parseFloat(destLat); 
    agendamentoState.barbeiroLon = parseFloat(destLon);
    chatTempId = agendamentoId;

    monitorarNotificacoesChatMapa(agendamentoId);

    // Tenta manter a tela ligada para o GPS não morrer no Android
    try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}

    // Busca foto do outro usuário
    try {
        const doc = await db.collection('usuarios').doc(outroUid).get();
        targetUserPhoto = doc.exists ? (doc.data().fotoPerfil || doc.data().logo_url || '/icone.png') : '/icone.png';
    } catch(e) { targetUserPhoto = '/icone.png'; }

    const minhaFoto = perfil.fotoPerfil || perfil.logo_url || '/icone.png';
    let fotoDoBarbeiroNoMapa, fotoDoClienteNoMapa;

    if (papel === 'cliente') {
        fotoDoClienteNoMapa = minhaFoto;      
        fotoDoBarbeiroNoMapa = targetUserPhoto; 
    } else {
        fotoDoBarbeiroNoMapa = minhaFoto;     
        fotoDoClienteNoMapa = targetUserPhoto;  
    }

    abrirModal('modalRastreamento');
    const modalContent = document.querySelector('#modalRastreamento .modal-content');
    
    // Limpa botões antigos
    ['btnChatTemporario', 'infoETA', 'transportControlsDiv', 'btnFecharMapaFloat'].forEach(id => {
        const el = document.getElementById(id); if(el) el.remove();
    });

    // Injeta controles
    const mapaHtmlExtras = `
        <div id="infoETA" class="eta-badge" style="display:none; top: 20px; font-size:16px; border:2px solid #d4af37; background:rgba(0,0,0,0.9);">Calculando...</div>
        
        <button id="btnChatTemporario" onclick="abrirChatDoMapa()" style="position:absolute; bottom:120px; right:20px; z-index:1000; background:#00c6ff; border:2px solid white; border-radius:50%; width:60px; height:60px; font-size:30px; box-shadow:0 0 15px rgba(0,198,255,0.5);">💬</button>
        
        <div id="transportControlsDiv" class="transport-controls" style="top: 80px; right: 10px; display: none;">
            <button class="transport-btn active" onclick="mudarTransporte('driving', this)">🚗</button>
            <button class="transport-btn" onclick="mudarTransporte('walking', this)">🚶</button>
        </div>
        
        <button id="btnFecharMapaFloat" onclick="minimizarMapa()" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); z-index:1000; width:auto; padding:12px 30px; background:#c0392b; border:2px solid white; font-weight:bold; box-shadow:0 4px 15px rgba(0,0,0,0.6); border-radius:30px;">⬇️ MINIMIZAR MAPA</button>
    `;
    modalContent.insertAdjacentHTML('beforeend', mapaHtmlExtras);

    setTimeout(() => {
        // Limpa instância anterior se existir
        limparMapaSeguro(); 

        mapRastreamento = L.map('mapaRastreamento', { zoomControl: false }).setView([destLat, destLon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM', maxZoom: 19 }).addTo(mapRastreamento);

        const iconDestino = L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="map-emoji-badge">🏁</div><div class="map-photo-marker" style="background-image: url('${fotoDoBarbeiroNoMapa}'); border-color: #d4af37;"></div>`,
            iconSize: [50, 50], iconAnchor: [25, 25]
        });
        L.marker([destLat, destLon], { icon: iconDestino }).addTo(mapRastreamento);

        if (papel === 'cliente') {
            document.getElementById('transportControlsDiv').style.display = 'flex';
            if (navigator.geolocation) {
                if(watchIdGPS) navigator.geolocation.clearWatch(watchIdGPS);
                
                // CONFIGURAÇÃO AGRESSIVA DE GPS PARA O CLIENTE
                watchIdGPS = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    localizacaoCliente = { latitude: lat, longitude: lon };
                    gerenciarRotaCorreta();
                    
                    // Atualiza Firebase
                    db.collection('agendamentos').doc(agendamentoId).update({
                        currentLat: lat,
                        currentLon: lon,
                        modoTransporte: currentTransportMode,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(err => console.warn("Falha GPS Firebase:", err));

                }, (err) => {
                    console.warn("Erro GPS:", err);
                    // Tenta reconectar se der erro
                }, { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0 
                });
            }
        } else {
            // PROFISSIONAL
            document.getElementById('transportControlsDiv').style.display = 'none';
            if(unsubscribeFirebase) unsubscribeFirebase();
            
            unsubscribeFirebase = db.collection('agendamentos').doc(agendamentoId)
                .onSnapshot(doc => {
                    if(!doc.exists) return;
                    const data = doc.data();
                    
                    if (data.status === 'concluido' || data.status === 'cancelado') {
                        encerrarRastreamentoTotal();
                        exibirPopup("Fim da Viagem", `O serviço foi ${data.status}.`);
                        return;
                    }

                    if (data.currentLat && data.currentLon) {
                        localizacaoCliente = { latitude: data.currentLat, longitude: data.currentLon };
                        gerenciarRotaCorreta();
                    }
                    if (data.modoTransporte && data.modoTransporte !== currentTransportMode) {
                        currentTransportMode = data.modoTransporte;
                        gerenciarRotaCorreta();
                    }
                });
        }
    }, 500);
}

function minimizarMapa() {
    // 1. Esconde o modal do mapa (CSS)
    const modal = document.getElementById('modalRastreamento');
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 300);

    // 2. Mostra o botão flutuante no topo
    const btn = document.getElementById('btnMinimizadoMapa');
    btn.style.display = 'block';
    
    // O GPS e o Firebase CONTINUAM rodando no fundo
    console.log("Mapa minimizado. GPS ativo.");
}

// --- 3. MAXIMIZAR MAPA (RESTAURA SE NECESSÁRIO) ---
function maximizarMapa() {
    // 1. Esconde o botão flutuante
    const btn = document.getElementById('btnMinimizadoMapa');
    if(btn) btn.style.display = 'none';

    // 2. Se o mapa não existe na memória (ex: após refresh), recria usando LocalStorage
    if (!mapRastreamento) {
        const sessaoSalva = localStorage.getItem('sessao_rastreamento_ativa');
        if (sessaoSalva) {
            try {
                const dados = JSON.parse(sessaoSalva);
                console.log("🔄 Reconstruindo mapa após refresh...");
                iniciarRastreamento(dados.outroUid, dados.destLat, dados.destLon, dados.papel, dados.agendamentoId);
                return; // iniciarRastreamento já abre o modal
            } catch (e) {
                console.error("Erro ao restaurar mapa:", e);
            }
        }
    }

    // 3. Se o mapa já existe em memória, apenas mostra o modal
    const modal = document.getElementById('modalRastreamento');
    modal.style.display = 'flex';
    setTimeout(() => { modal.classList.add('show'); }, 10);
    
    // Corrige renderização do Leaflet
    setTimeout(() => {
        if(mapRastreamento) mapRastreamento.invalidateSize();
    }, 300);
}

// --- VERIFICAR SE TEM MAPA PENDENTE AO ABRIR O APP ---
function verificarRastreamentoPendente() {
    const sessaoSalva = localStorage.getItem('sessao_rastreamento_ativa');
    
    if (sessaoSalva) {
        try {
            const dados = JSON.parse(sessaoSalva);
            
            // Verifica se o agendamento ainda é válido no Firebase (opcional, mas bom pra não bugar)
            // Por enquanto, confiamos no localStorage e mostramos o botão
            console.log("📍 Rastreamento pendente encontrado. Exibindo botão.");
            
            const btn = document.getElementById('btnMinimizadoMapa');
            if (btn) {
                btn.style.display = 'block';
                btn.innerHTML = "🗺️ MAPA EM ANDAMENTO (Clique para abrir)";
                // Adiciona uma animação para chamar atenção
                btn.style.animation = "pulse-blue 1.5s infinite";
            }
            
        } catch (e) {
            console.error("Erro ao ler sessão salva:", e);
            localStorage.removeItem('sessao_rastreamento_ativa');
        }
    }
}

function encerrarRastreamentoTotal() {
    console.log("🛑 Encerrando rastreamento total.");
    
    // LIMPA A SESSÃO DO LOCAL STORAGE
    localStorage.removeItem('sessao_rastreamento_ativa');

    if (typeof twacommand !== 'undefined' && typeof twacommand.twacommand === 'function') {
        twacommand.twacommand('LocationTracking', 'STOP');
        console.log("Comando nativo STOP enviado.");
    }

    // Limpa recursos
    if (watchIdGPS) { navigator.geolocation.clearWatch(watchIdGPS); watchIdGPS = null; }
    if (unsubscribeFirebase) { unsubscribeFirebase(); unsubscribeFirebase = null; }
    if (wakeLock) { wakeLock.release().then(() => { wakeLock = null; }); }
    
    // Destrói o mapa
    limparMapaRastreamento();
    
    // Fecha modal se estiver aberto
    fecharModalAtual();
    
    // Esconde o botão chiclete
    const btn = document.getElementById('btnMinimizadoMapa');
    if(btn) btn.style.display = 'none';
}

// --- 2. FUNÇÃO MODIFICADA: FECHAR MAPA COM EFEITO CHICLETE ---
function pararRastreamentoEFechar() {
    // Limpa recursos do mapa
    if (watchIdGPS) { navigator.geolocation.clearWatch(watchIdGPS); watchIdGPS = null; }
    if (unsubscribeFirebase) { unsubscribeFirebase(); unsubscribeFirebase = null; }
    if (unsubscribeChatNotif) { unsubscribeChatNotif(); unsubscribeChatNotif = null; }
    if (wakeLock) { wakeLock.release().then(() => { wakeLock = null; }); }
    
    limparMapaRastreamento();
    fecharModalAtual();

    // --- LÓGICA DO CHICLETE (15 SEGUNDOS) ---
    if (currentTrackingData) {
        console.log("⏳ Mapa fechado manualmente. Reabrindo em 15 segundos...");
        
        // Exibe um Toast (aviso flutuante) se a função existir, senão usa console
        if(typeof exibirToast === 'function') {
            exibirToast("O mapa reabrirá em 15s (Agendamento Ativo)");
        }

        if (mapReopenTimer) clearTimeout(mapReopenTimer);
        
        mapReopenTimer = setTimeout(() => {
            // Verifica se ainda temos dados válidos antes de reabrir
            if (currentTrackingData) {
                console.log("🔄 Reabrindo mapa (Chiclete)!");
                iniciarRastreamento(
                    currentTrackingData.outroUid,
                    currentTrackingData.destLat,
                    currentTrackingData.destLon,
                    currentTrackingData.papel,
                    currentTrackingData.agendamentoId
                );
            }
        }, 15000); // 15000ms = 15 segundos
    }
}

// --- 3. NOVA FUNÇÃO: MATAR O CHICLETE (CHAMAR AO CONCLUIR/CANCELAR) ---
function pararChicleteDefinitivo() {
    console.log("🛑 Parando efeito chiclete definitivamente.");
    
    // 1. Zera os dados de reabertura
    currentTrackingData = null; 
    
    // 2. Mata o timer se estiver contando
    if (mapReopenTimer) {
        clearTimeout(mapReopenTimer); 
        mapReopenTimer = null;
    }
    
    // 3. Fecha o mapa se estiver aberto
    const modalMapa = document.getElementById('modalRastreamento');
    if (modalMapa && modalMapa.classList.contains('show')) {
        // Chama versão limpa que não ativa o timer novamente
        limparMapaRastreamento();
        fecharModalAtual();
    }
}

// 2. MUDANÇA DE TRANSPORTE
function mudarTransporte(modo, btnElement) {
    document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('active'));
    if(btnElement) btnElement.classList.add('active');
    currentTransportMode = modo;

    if (mapRastreamento && localizacaoCliente) {
        gerenciarRotaCorreta();
    }

    if (chatTempId && userRoleMap === 'cliente') {
        db.collection('agendamentos').doc(chatTempId).update({ modoTransporte: modo }).catch(()=>{});
    }
}

// 3. GERENCIADOR DE DIREÇÃO DA ROTA
function gerenciarRotaCorreta() {
    if (!localizacaoCliente || !agendamentoState.barbeiroLat) return;

    if (userRoleMap === 'cliente') {
        // Cliente = Origem (Carro), Profissional = Destino (Bandeira)
        atualizarRotaReal(localizacaoCliente.latitude, localizacaoCliente.longitude, agendamentoState.barbeiroLat, agendamentoState.barbeiroLon);
    } else {
        // Profissional = Destino (Bandeira), Cliente = Origem (Carro)
        // A função atualizarRotaReal desenha sempre de Lat1 para Lat2
        // Então passamos: Lat1=Cliente, Lat2=Profissional
        // (A ordem dos parâmetros determina a lógica visual na função abaixo)
        
        // CORREÇÃO: Passamos sempre a coordenada do CLIENTE primeiro
        atualizarRotaReal(localizacaoCliente.latitude, localizacaoCliente.longitude, agendamentoState.barbeiroLat, agendamentoState.barbeiroLon);
    }
}

// 4. DESENHO DA ROTA E LÓGICA (MAPA SILENCIOSO)
function atualizarRotaReal(latInicio, lonInicio, latFim, lonFim) {
    if (!mapRastreamento) return; 

    // Remove controle anterior
    if (routingControl) { 
        try { mapRastreamento.removeControl(routingControl); } catch(e){} 
        routingControl = null; 
    }

    let emojiTransporte = '🚗';
    if (currentTransportMode === 'cycling') emojiTransporte = '🚲';
    if (currentTransportMode === 'walking') emojiTransporte = '🚶';

    const minhaFoto = perfil.fotoPerfil || perfil.logo_url || '/icone.png';
    let fotoCliente, fotoProfissional;

    if (userRoleMap === 'cliente') {
        fotoCliente = minhaFoto;
        fotoProfissional = targetUserPhoto;
    } else {
        fotoCliente = targetUserPhoto;
        fotoProfissional = minhaFoto;
    }

    try {
        routingControl = L.Routing.control({
            waypoints: [L.latLng(latInicio, lonInicio), L.latLng(latFim, lonFim)],
            createMarker: function(i, wp, nWps) {
                if (i === 0) { // Cliente
                    const iconHtml = `<div class="map-emoji-badge">${emojiTransporte}</div><div class="map-photo-marker pulse-animation" style="background-image: url('${fotoCliente}'); border-color: #00c6ff;"></div>`;
                    return L.marker(wp.latLng, { icon: L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [50, 50], iconAnchor: [25, 25] }) });
                } else if (i === nWps - 1) { // Profissional
                    const iconHtml = `<div class="map-emoji-badge">🏁</div><div class="map-photo-marker" style="background-image: url('${fotoProfissional}'); border-color: #d4af37;"></div>`;
                    return L.marker(wp.latLng, { icon: L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [50, 50], iconAnchor: [25, 25] }) });
                }
                return null;
            },
            lineOptions: { styles: [{color: 'black', opacity: 0.8, weight: 10}, {color: '#00c6ff', opacity: 1, weight: 6}] },
            router: L.Routing.mapbox('pk.eyJ1IjoibG9wZXNkZXYiLCJhIjoiY21pc2g3aGZ5MTFucTNlb2dqMHJsYnhyOSJ9.UmjJWTZ7pF3Dalf0tqu4HA', { profile: `mapbox/${currentTransportMode}` }),
            show: false, 
            addWaypoints: false, 
            draggableWaypoints: false, 
            fitSelectedRoutes: true
        });
        
        routingControl.addTo(mapRastreamento);
        
        routingControl.on('routesfound', function(e) {
            const summary = e.routes[0].summary;
            const minutos = Math.ceil((summary.totalTime * 0.6) / 60);
            const distanciaKm = (summary.totalDistance / 1000).toFixed(1);
            
            // --- ATUALIZAÇÃO VISUAL APENAS (SEM SOM) ---
            const badge = document.getElementById('infoETA');
            if(badge) {
                badge.style.display = 'block';
                badge.innerHTML = `⏱️ ~${minutos} min (${distanciaKm} km)`;
                
                // Muda a cor se estiver perto, mas SEM SOM
                if (summary.totalDistance <= 500) {
                    badge.style.borderColor = 'red'; 
                    badge.innerText = "CLIENTE PRÓXIMO (500m)!";
                } else {
                    badge.style.borderColor = '#2ecc71';
                }
            }
        });
        
        // Remove painel de texto
        const routingContainer = document.querySelector('.leaflet-routing-container');
        if(routingContainer) routingContainer.style.display = 'none';

    } catch (e) { console.error("Erro rota:", e); }
}

function traduzirModo(modo) {
    if(modo === 'driving') return 'Carro 🚗';
    if(modo === 'cycling') return 'Bicicleta/Moto 🚲';
    if(modo === 'walking') return 'A Pé 🚶';
    return modo;
}

function pararRastreamentoEFechar() {
    if (watchIdGPS) { navigator.geolocation.clearWatch(watchIdGPS); watchIdGPS = null; }
    if (unsubscribeFirebase) { unsubscribeFirebase(); unsubscribeFirebase = null; }
    if (unsubscribeChatNotif) { unsubscribeChatNotif(); unsubscribeChatNotif = null; }
    limparMapaRastreamento();
    fecharModalAtual();
}

async function apagarChatTemporario(agendamentoId) {
    if (!agendamentoId) return;
    const chatId = 'temp_' + agendamentoId;
    console.log("Apagando chat:", chatId);
    
    // Pega todas as mensagens da sala temporária
    const ref = db.collection("chats").doc(chatId).collection("mensagens");
    const snapshot = await ref.get();
    
    if (snapshot.empty) return;

    // Deleta em lote
    const batch = db.batch();
    snapshot.docs.forEach((doc) => {
        batch.delete(doc.ref);
    });
    
    await batch.commit();
    console.log("Chat limpo.");
}

async function marcarComoEntregue(pedidoId, clienteUid) {
    if (!confirm("Confirmar que o produto foi entregue? O comprador será notificado para confirmar o recebimento.")) return;
    try {
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: 'entregue_pendente_confirmacao' });
        notifyUser(clienteUid, '🚚 Seu Pedido foi Entregue!', 'Por favor, confirme o recebimento do seu produto no app para finalizar a compra.');
        exibirPopup('Notificação enviada ao comprador.');
    } catch (e) {
        exibirPopup('Erro ao marcar como entregue: ' + e.message);
    }
}

async function abrirMinhasCompras() {
    if (!auth.currentUser) return; // PROTEÇÃO CONTRA NULL

    abrirModal('modalMinhasCompras');
    const container = document.getElementById('listaMinhasCompras');
    container.innerHTML = '<p>Carregando suas compras...</p>';

    const snap = await db.collection('loja_pedidos').where('clienteUid', '==', auth.currentUser.uid).orderBy('ts', 'desc').get();
    if (snap.empty) {
        container.innerHTML = '<p>Você ainda não fez nenhuma compra.</p>';
        return;
    }
    container.innerHTML = '';
    snap.forEach(doc => {
        const compra = doc.data();
        let statusTexto = 'Processando';
        let acaoBotao = '';

        // Lógica de Status do Comprador
        switch(compra.status) {
            case 'pendente': 
                statusTexto = '⏳ Aguardando envio do vendedor'; 
                break;
            case 'enviado': 
                statusTexto = '🚚 A Caminho'; 
                acaoBotao = `<button onclick="abrirModalConfirmacaoComprador({id: '${doc.id}', vendedorUid: '${compra.vendedorUid}', valor: ${compra.valor}, produtoNome: '${compra.produtoNome}'})" style="background: #2ecc71; animation: pulse-green 2s infinite;">🎁 Recebi a Entrega</button>`;
                break;
            case 'entregue_pendente_confirmacao': // Caso legado ou redundante
            case 'confirmado_pelo_cliente': 
                statusTexto = '✅ Entrega Confirmada'; 
                break;
            case 'disputa': 
                statusTexto = '🚨 Em disputa/Recusado'; 
                break;
        }
        
        // Botão de Avaliação
        if (compra.status === 'confirmado_pelo_cliente' && !compra.avaliado) {
            acaoBotao = `<button onclick="abrirModalAvaliacaoProduto('${doc.id}', '${compra.produtoId}', '${compra.produtoNome}')">⭐ Avaliar Produto</button>`;
        } else if (compra.status === 'confirmado_pelo_cliente' && compra.avaliado) {
            acaoBotao = `<p style="font-size: 14px; color: var(--cor-destaque);">✅ Produto avaliado!</p>`;
        }

        container.innerHTML += `
            <div class="card">
                ${compra.produtoNome}
                <p>Status: ${statusTexto}</p>
                <div style="margin-top: 10px;">${acaoBotao}</div>
            </div>
        `;
    });
}

function abrirModalConfirmacaoComprador(pedidoObj) {
    // pedidoObj contém: id, vendedorUid, valor, produtoNome (passados no HTML)
    const modal = document.getElementById('modalConfirmacaoComprador');
    
    document.getElementById('confirmacaoCompradorTitulo').textContent = "Recebeu o produto?";
    document.getElementById('confirmacaoCompradorTexto').textContent = `Confirme se você recebeu "${pedidoObj.produtoNome}". Isso liberará o pagamento ao vendedor.`;

    // Remove listeners antigos clonando
    const btnSim = document.getElementById('btnAceitarEntrega');
    const btnNao = document.getElementById('btnRecusarEntrega');
    
    const novoSim = btnSim.cloneNode(true);
    const novoNao = btnNao.cloneNode(true);
    
    btnSim.parentNode.replaceChild(novoSim, btnSim);
    btnNao.parentNode.replaceChild(novoNao, btnNao);

    // Como responderConfirmacaoEntrega busca do banco pelo ID, só precisamos passar o ID e o booleano
    novoSim.onclick = () => responderConfirmacaoEntrega(pedidoObj.id, true);
    novoNao.onclick = () => responderConfirmacaoEntrega(pedidoObj.id, false);
    
    abrirModal('modalConfirmacaoComprador');
}

async function responderConfirmacaoEntrega(pedidoId, aceito) {
    try {
        const pedidoRef = db.collection('loja_pedidos').doc(pedidoId);
        const pedidoDoc = await pedidoRef.get();
        if (!pedidoDoc.exists) throw new Error("Pedido não encontrado.");

        const { vendedorUid, valor, produtoNome } = pedidoDoc.data();

        if (aceito) {
            exibirAguarde("Liberando pagamento ao vendedor...");

            await db.runTransaction(async t => {
                const vendedorRef = db.collection("usuarios").doc(vendedorUid);
                // Pega referência do Admin para receber a taxa (se houver)
                const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
                const adminRef = !adminSnap.empty ? db.collection("usuarios").doc(adminSnap.docs[0].id) : null;
                const financeiroRef = db.collection("config").doc("financeiro");

                const vendedorDoc = await t.get(vendedorRef);
                if (!vendedorDoc.exists) throw new Error("Vendedor não encontrado.");
                const vendedorData = vendedorDoc.data();

                // === LÓGICA DE TAXA DA LOJA (CORRIGIDA: CLIENTE = 0%) ===
                let taxaAplicada = 0.00; // Começa zerado

                // 1. Se for Cliente ou Admin: TAXA ZERO
                if (vendedorData.tipo === 'cliente' || vendedorData.tipo === 'admin') {
                    taxaAplicada = 0.00; 
                } 
                // 2. Se for Profissional (Barbeiro, Manicure, etc): APLICA TAXAS
                else {
                    taxaAplicada = 0.10; // Base Profissional: 10%

                    // Redução por Tier PRO
                    if (isProAtivo(vendedorData) && vendedorData.proTier) {
                        if (vendedorData.proTier === 'tier3') taxaAplicada = 0.05; // Ouro: 5%
                        if (vendedorData.proTier === 'tier4') taxaAplicada = 0.00; // Diamante: 0%
                        // Tier 1 e 2 continuam na base de 10% na loja
                    }
                }

                // Cálculo
                const valorTaxa = valor * taxaAplicada;
                const valorVendedor = valor - valorTaxa;

                // Créditos
                t.update(vendedorRef, { saldo: firebase.firestore.FieldValue.increment(valorVendedor) });
                
                // Se tiver taxa (Profissional não-Diamante) e admin existir, paga a taxa
                if (valorTaxa > 0 && adminRef) {
                    t.update(adminRef, { saldo: firebase.firestore.FieldValue.increment(valorTaxa) });
                    t.set(financeiroRef, { arrecadadoTaxasLoja: firebase.firestore.FieldValue.increment(valorTaxa) }, { merge: true });
                }

                // Finaliza Pedido
                t.update(pedidoRef, { status: 'confirmado_pelo_cliente' });
            });

            fecharTodosOsModais();
            
            notifyUser(vendedorUid, '💰 Dinheiro Liberado!', `Venda de "${produtoNome}" concluída. Valor liberado.`);
            exibirPopup('Sucesso!', 'Recebimento confirmado. Obrigado!');
            
            abrirMinhasCompras(); 

        } else {
            // Recusa/Disputa
            await pedidoRef.update({ status: 'disputa' });
            notifyUser(vendedorUid, '🚨 Entrega Contestada', `Cliente reportou problema em "${produtoNome}".`, { link: '#entregas' });
            fecharModalAtual();
            exibirPopup('Aviso', 'O vendedor foi notificado sobre o problema.');
            abrirMinhasCompras();
        }

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup('Erro: ' + e.message);
    }
}

function toggleFuncoes(containerId) {
    const container = document.getElementById(containerId);
    const button = container.previousElementSibling;
    if (container) {
        container.classList.toggle('hidden');
        button.classList.toggle('closed', container.classList.contains('hidden'));
    }
}

function handleProdutoClick(produto) {
    if (!auth.currentUser) {
        exibirPopup("Para ver detalhes e comprar produtos, por favor, faça login ou crie uma conta.");
        mostrar('authView');
    } else {
        abrirDetalhesProduto(produto);
    }
}

function iniciarVerificacaoDePendencias(uid) {
    if (pendenciasInterval) clearInterval(pendenciasInterval);
    verificarPendencias(uid);
    pendenciasInterval = setInterval(() => verificarPendencias(uid), 60000);
}

async function verificarPendencias(uid) {
    if (!uid || !perfil) return;

    // --- 1. PENDÊNCIAS DE VENDAS (GERENCIAR LOJA) ---
    // Verifica se o usuário (Vendedor) tem produtos com status "Aguardando Envio"
    if (perfil.lojaLiberada || perfil.tipo === 'admin') {
        const vendasPendentesSnap = await db.collection('loja_pedidos')
            .where('vendedorUid', '==', uid)
            .where('status', '==', 'pendente')
            .get();

        const btnGerenciarLojaProf = document.getElementById('btnGerenciarLojaBarbeiro');
        const btnGerenciarLojaCli = document.getElementById('btnGerenciarLojaCliente');

        if (!vendasPendentesSnap.empty) {
            btnGerenciarLojaProf?.classList.add('notificacao-pulsante');
            btnGerenciarLojaCli?.classList.add('notificacao-pulsante');
        } else {
            btnGerenciarLojaProf?.classList.remove('notificacao-pulsante');
            btnGerenciarLojaCli?.classList.remove('notificacao-pulsante');
        }
    }

    // --- 2. PENDÊNCIAS DE COMPRAS (MINHAS COMPRAS - PARA TODOS) ---
    // Verifica se há compras "A Caminho" ou "Entregue" para Clientes OU Profissionais
    const comprasPendentesSnap = await db.collection('loja_pedidos')
        .where('clienteUid', '==', uid)
        .where('status', 'in', ['enviado', 'entregue_pendente_confirmacao'])
        .get();

    const btnComprasBarbeiro = document.getElementById('btnMinhasComprasBarbeiro');
    const btnComprasCliente = document.getElementById('btnMinhasCompras');

    if (!comprasPendentesSnap.empty) {
        // Ativa o alerta visual nos botões de ambos os painéis (se existirem na tela)
        btnComprasBarbeiro?.classList.add('notificacao-pulsante');
        btnComprasCliente?.classList.add('notificacao-pulsante');

        // EXIBE O POPUP APENAS UMA VEZ POR SESSÃO
        if (!avisoEntregaRealizadoSessao) {
            const pedido = comprasPendentesSnap.docs[0].data();
            const docId = comprasPendentesSnap.docs[0].id;
            
            abrirPopupEntregaCaminho({
                id: docId,
                vendedorUid: pedido.vendedorUid,
                valor: pedido.valor,
                produtoNome: pedido.produtoNome,
                status: pedido.status
            });
            
            avisoEntregaRealizadoSessao = true; 
        }
    } else {
        btnComprasBarbeiro?.classList.remove('notificacao-pulsante');
        btnComprasCliente?.classList.remove('notificacao-pulsante');
    }

    // --- 3. PENDÊNCIAS ESPECÍFICAS POR TIPO ---

    // LÓGICA DO PROFISSIONAL (Agendamentos)
    if (perfil.tipo !== 'cliente') {
        const agendamentosSnap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', uid)
            .where('status', '==', 'pendente')
            .get();
        const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
        
        if (!agendamentosSnap.empty) {
            btnAgendamentos?.classList.add('notificacao-pulsante');
        } else {
            btnAgendamentos?.classList.remove('notificacao-pulsante');
        }
    }

    // LÓGICA DO CLIENTE (Avaliações Pendentes)
    if (perfil.tipo === 'cliente') {
        const avaliacoesSnap = await db.collection('agendamentos')
            .where('clienteUid', '==', uid)
            .where('status', '==', 'concluido')
            .where('avaliado', '==', false)
            .get();
        const btnHistorico = document.getElementById('btnHistoricoCliente');
        
        if (!avaliacoesSnap.empty) {
            btnHistorico?.classList.add('notificacao-pulsante');
        } else {
            btnHistorico?.classList.remove('notificacao-pulsante');
        }
    }

    // --- 4. PENDÊNCIAS DE SAQUE (RESTAURADO) ---
    const saqueSnap = await db.collection("solicitacoes")
        .where("usuarioUid", "==", uid)
        .where("status", "==", "pendente")
        .where("tipo", "==", "saque")
        .get();
        
    if (!saqueSnap.empty) {
        // Mantém a lógica original (apenas verifica, sem ação visual específica definida no código antigo)
    }
}

function abrirPopupEntregaCaminho(pedidoObj) {
    const modal = document.getElementById('modalConfirmacaoComprador');
    
    let titulo = "🚚 Entrega a Caminho!";
    let mensagem = `O produto "${pedidoObj.produtoNome}" está marcado como enviado.\n\nVocê já recebeu a encomenda?`;
    
    if (pedidoObj.status === 'entregue_pendente_confirmacao') {
        titulo = "📦 Entrega Realizada?";
        mensagem = `O vendedor informou que "${pedidoObj.produtoNome}" foi entregue.\n\nConfirma o recebimento para liberar o pagamento?`;
    }

    document.getElementById('confirmacaoCompradorTitulo').textContent = titulo;
    document.getElementById('confirmacaoCompradorTexto').innerText = mensagem;

    // Botão: Ainda não recebi (Apenas fecha)
    const btnNao = document.getElementById('btnRecusarEntrega');
    btnNao.textContent = "Ainda não recebi";
    btnNao.style.background = "#555"; // Cinza neutro
    btnNao.onclick = () => {
        fecharModalAtual();
        // Não faz nada no banco, apenas fecha o aviso
    };

    // Botão: Confirmar (Finaliza)
    const btnSim = document.getElementById('btnAceitarEntrega');
    btnSim.textContent = "✅ Sim, Recebi!";
    btnSim.style.background = "#27ae60"; // Verde
    
    // Remove listeners antigos clonando
    const novoSim = btnSim.cloneNode(true);
    const novoNao = btnNao.cloneNode(true);
    btnSim.parentNode.replaceChild(novoSim, btnSim);
    btnNao.parentNode.replaceChild(novoNao, btnNao);

    // Reatribui os onclicks
    novoNao.onclick = () => fecharModalAtual();
    novoSim.onclick = () => responderConfirmacaoEntrega(pedidoObj.id, true);
    
    abrirModal('modalConfirmacaoComprador');
}

// SUBSTITUA A FUNÇÃO 'verificarPendenciasEssenciaisProfissional' INTEIRA EM index.html
async function verificarPendenciasEssenciaisProfissional(uid) {
    // Se o fluxo inicial ainda está ativo (true) ou se um popup de etapa já está aberto, não faz nada.
    if (etapaAtualOnboarding > 0 || !perfil || perfil.precisaConfiguracaoInicial === true) {
        return;
    }

    // Se o onboarding inicial foi pulado (false), verificamos as pendências.
    const p = perfil;

    // 1. Verifica se HÁ ALGUMA pendência essencial
    const temServicos = p.listaServicos && p.listaServicos.length > 0;
    const temHorarioManual = Object.values(p.agenda || {}).some(v => v === true);
    const temAgenda = p.vagaImediata || temHorarioManual;
    const temLogo = !!p.logo_url;
    const temPortfolio = p.portfolio && p.portfolio.length > 0;

    const temPendencia = !temServicos || !temAgenda || !temLogo || !temPortfolio;

    // 2. Se tiver pendência, mostra o popup de Lembrete
    if (temPendencia) {
        // Não abre se outro modal já estiver visível (ex: o de Lembrete)
        if (document.getElementById('modalLembretePendencia').classList.contains('show')) {
            return;
        }
        console.log("Fluxo Lembrete: Pendências encontradas. Abrindo modalLembretePendencia.");
        abrirModal('modalLembretePendencia');
    }
    // Se não houver pendência, não faz nada.
}

// [ADICIONAR ESTAS NOVAS FUNÇÕES]

/**
 * Chamada pelo botão "OK, Configurar" do modal de lembrete.
 * Fecha o lembrete e inicia a verificação do primeiro popup pendente.
 */
function iniciarFluxoDeLembrete() {
    fecharModalAtual(); // Fecha o modal de lembrete
    
    // Roda a verificação de qual popup abrir.
    // Usamos um timeout curto para garantir que o modal de lembrete feche antes do próximo abrir.
    setTimeout(() => {
        abrirProximoPopupDeLembrete();
    }, 350); 
}

/**
 * Verifica (recarregando o perfil) qual a próxima configuração essencial pendente
 * e abre o modal correspondente no "modo lembrete".
 */
async function abrirProximoPopupDeLembrete() {
    // Recarrega o perfil para garantir dados frescos
    let p;
    try {
        exibirAguarde("Verificando..."); // Mostra um aguarde rápido
        const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
        if (!userDoc.exists) throw new Error("Usuário não encontrado.");
        p = userDoc.data();
        perfil = p; // Atualiza o perfil global
        fecharAguarde(null, true); // Fecha o aguarde
    } catch (e) {
        fecharAguarde(null, true);
        exibirPopup("Erro", "Não foi possível verificar suas configurações: " + e.message, "erro");
        return;
    }
    
    console.log("Fluxo Lembrete: Verificando próxima pendência...");

    // 1. Verifica Serviços
    if (!p.listaServicos || p.listaServicos.length === 0) {
        console.log("Fluxo Lembrete: Abrindo Etapa 1 (Serviços).");
        abrirOnboardingEtapa1(true); // 'true' para modo lembrete
        return;
    }

    // 2. Verifica Agenda (Etapa 3 do fluxo original)
    const temHorarioManual = Object.values(p.agenda || {}).some(v => v === true);
    if (!p.vagaImediata && !temHorarioManual) {
        console.log("Fluxo Lembrete: Abrindo Etapa 3 (Agenda).");
        abrirOnboardingEtapa3(true); // 'true' para modo lembrete
        return;
    }

    // 3. Verifica Logomarca (Etapa 4)
    if (!p.logo_url) {
        console.log("Fluxo Lembrete: Abrindo Etapa 4 (Logo).");
        abrirOnboardingEtapa4(true); // 'true' para modo lembrete
        return;
    }
    
    // 4. Verifica Portfólio (Etapa 5)
    if (!p.portfolio || p.portfolio.length === 0) {
        console.log("Fluxo Lembrete: Abrindo Etapa 5 (Portfólio).");
        abrirOnboardingEtapa5(true); // 'true' para modo lembrete
        return;
    }

    // 5. Nenhuma pendência encontrada!
    console.log("Fluxo Lembrete: Nenhuma pendência restante.");
    exibirPopup("Tudo Certo!", "Todas as suas configurações essenciais estão completas.", "sucesso");
}

async function carregarAvaliacaoProduto(produtoId, produtoNome, container) {
    container.innerHTML = '';
    
    if (produtoNome.toLowerCase().includes('King Agenda')) {
        const hoje = new Date().toISOString().split('T')[0]; 
        const seed = produtoId + hoje;
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            const char = seed.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        const randomValue = (Math.abs(hash) % 10) / 10;
        const notaAleatoria = (4.1 + randomValue).toFixed(1);

        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        
        let avaliacaoHtml = `<p class="avaliacao-estrelas">⭐ ${notaAleatoria}</p>`;
        
        if (!snap.empty) {
            const ultimaAvaliacao = snap.docs[0].data();
            const doisDiasAtras = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000);
            if (ultimaAvaliacao.ts.toDate() > doisDiasAtras) {
                avaliacaoHtml += `<p class="avaliacao-comentario">"${ultimaAvaliacao.comentario}"</p>`;
            } else {
                 avaliacaoHtml += `<p class="avaliacao-comentario">Veja as avaliações dos clientes.</p>`;
            }
        } else {
             avaliacaoHtml += `<p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        }
        container.innerHTML = avaliacaoHtml;

    } else {
        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        if (snap.empty) {
            container.innerHTML = `<p class="avaliacao-estrelas">⭐ Sem avaliação</p><p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        } else {
            const avaliacao = snap.docs[0].data();
            container.innerHTML = `
                <p class="avaliacao-estrelas">⭐ ${avaliacao.nota.toFixed(1)}</p>
                <p class="avaliacao-comentario">"${avaliacao.comentario}"</p>
            `;
        }
    }
}

let notaSelecionada = 0;
function abrirModalAvaliacaoProduto(pedidoId, produtoId, produtoNome) {
    notaSelecionada = 0;
    document.getElementById('avaliarProdutoNome').textContent = produtoNome;
    document.getElementById('avaliarProdutoComentario').value = '';
    
    const starsContainer = document.getElementById('ratingStars');
    const stars = starsContainer.querySelectorAll('span');

    stars.forEach(star => {
        star.classList.remove('selected');
        star.innerHTML = '☆';
        star.onmouseover = () => {
            const rating = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('hovered', parseInt(s.dataset.value) <= rating);
                s.innerHTML = parseInt(s.dataset.value) <= rating ? '★' : '☆';
            });
        };
        star.onmouseout = () => {
            stars.forEach(s => {
                s.classList.remove('hovered');
                const rating = notaSelecionada;
                s.innerHTML = parseInt(s.dataset.value) <= rating ? '★' : '☆';
            });
        };
        star.onclick = () => {
            notaSelecionada = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('selected', parseInt(s.dataset.value) <= notaSelecionada);
            });
        };
    });

    document.getElementById('btnSalvarAvaliacaoProduto').onclick = () => {
        const comentario = document.getElementById('avaliarProdutoComentario').value.trim();
        if (notaSelecionada === 0) {
            return exibirPopup('Por favor, selecione uma nota de 1 a 5 estrelas.');
        }
        salvarAvaliacaoProduto(pedidoId, produtoId, notaSelecionada, comentario);
    };
    
    abrirModal('modalAvaliarProduto');
}

async function salvarAvaliacaoProduto(pedidoId, produtoId, nota, comentario) {
    try {
        await db.collection('avaliacoes_produtos').add({
            produtoId,
            nota,
            comentario,
            clienteUid: auth.currentUser.uid,
            clienteNome: perfil.nome,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('loja_pedidos').doc(pedidoId).update({ avaliado: true });
        
        exibirPopup('Obrigado pela sua avaliação!');
        fecharModalAtual();
        abrirMinhasCompras();
    } catch (e) {
        exibirPopup('Erro ao salvar avaliação: ' + e.message);
    }
}

function fazerLogout() {
    // 1. Limpeza de Intervalos e Listeners
    if (updateLastSeenInterval) { clearInterval(updateLastSeenInterval); updateLastSeenInterval = null; }
    if (onlineUsersListener) { onlineUsersListener(); onlineUsersListener = null; }
    if (globalChatListener) { globalChatListener(); globalChatListener = null; }
    // (Adicione limpeza de outros listeners se necessário)

    // 2. Esconde elementos visuais de usuário logado
    const countElement = document.getElementById('onlineUserCount');
    if (countElement) countElement.classList.add('hidden');
    document.getElementById("topbar").classList.add("hidden");
    document.getElementById("bottomButtons").classList.add("hidden");

    // 3. Executa o Logout no Firebase
    auth.signOut().then(() => {
        console.log("Logout realizado.");
        
        // 4. Reseta variáveis globais
        perfil = null;
        userView = { originalType: null, currentType: null };
        
        // 5. Redireciona para a View de Autenticação (Login)
        // Importante: Não recarrega a página, apenas troca a view
        mostrar('authView');
        
        // Opcional: Limpa campos de login para segurança
        document.getElementById('email').value = '';
        document.getElementById('senha').value = '';
        
        exibirPopup("Você saiu", "Até logo!");
    });
}

function handleDeepLink() {
    const hash = window.location.hash.substring(1);
    if (!hash || !auth.currentUser) return;

    switch (hash) {
        case 'agendamentos':
            if (perfil.tipo !== 'cliente') abrirAgendamentosBarbeiro();
            break;
        case 'solicitacoes':
            if (perfil.tipo === 'admin') abrirModalSolicitacoes();
            break;
        case 'denuncias':
            if (perfil.tipo === 'admin') abrirDenuncias();
            break;
        case 'carteira':
            abrirModal('modalCarteira');
            break;
        case 'historico':
            if (perfil.tipo === 'cliente') abrirHistoricoCliente();
            break;
        case 'fidelidade':
            abrirModal('modalFidelidade');
            break;
        case 'conquistas':
            if (perfil.tipo === 'cliente') abrirModalConquistas();
            else abrirModalConquistasBarbeiro();
            break;
        case 'avaliacoes':
            if (perfil.tipo !== 'cliente') abrirAvaliacoesBarbeiro();
            break;
        case 'minhascompras':
            abrirMinhasCompras();
            break;
        case 'entregas':
            abrirEntregasVendedor();
            break;
    }
    history.pushState("", document.title, window.location.pathname + window.location.search);
}


// --- NOVA FUNÇÃO: LIMPEZA DE ITENS EXPIRADOS ---
async function verificarLimpezaItensExpirados(usuario) {
    if (!usuario) return;
    
    let updates = {};
    let mudou = false;
    const agora = new Date();

    // 1. Verifica Moldura Selecionada
    if (usuario.molduraSelecionada) {
        const m = MOLDURAS[usuario.molduraSelecionada];
        // Se não é item permanente (comprado/admin)
        if (m && !m.adminOnly && (!usuario.moldurasAdquiridas || !usuario.moldurasAdquiridas.includes(usuario.molduraSelecionada))) {
            let temAcesso = false;
            
            // Checa se é prêmio temporário válido
            if (usuario.premiosTemporarios && usuario.premiosTemporarios[`moldura_${usuario.molduraSelecionada}`]) {
                const validade = usuario.premiosTemporarios[`moldura_${usuario.molduraSelecionada}`].toDate();
                if (validade > agora) temAcesso = true;
            }
            
            // Checa se é benefício PRO válido
            if (isProAtivo(usuario)) {
                const tier = usuario.proTier;
                const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
                const moldurasOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
                // Se o tier atual cobre a moldura
                if (niveis.indexOf(tier) >= moldurasOrdem.indexOf(usuario.molduraSelecionada)) {
                    temAcesso = true;
                }
            }

            // Se não tem acesso por nenhuma via, remove a seleção
            if (!temAcesso) {
                updates.molduraSelecionada = firebase.firestore.FieldValue.delete();
                mudou = true;
                console.log("Moldura expirada removida.");
            }
        }
    }

    // 2. Verifica Balão Selecionado
    if (usuario.balaoSelecionado) {
        const b = BALOES[usuario.balaoSelecionado];
        if (b && !b.adminOnly && (!usuario.baloesAdquiridos || !usuario.baloesAdquiridos.includes(usuario.balaoSelecionado))) {
            let temAcesso = false;

            // Checa prêmio temporário
            if (usuario.premiosTemporarios && usuario.premiosTemporarios[`balao_${usuario.balaoSelecionado}`]) {
                const validade = usuario.premiosTemporarios[`balao_${usuario.balaoSelecionado}`].toDate();
                if (validade > agora) temAcesso = true;
            }

            // Checa PRO
            if (isProAtivo(usuario)) {
                const tier = usuario.proTier;
                const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
                const baloesOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
                if (niveis.indexOf(tier) >= baloesOrdem.indexOf(usuario.balaoSelecionado)) {
                    temAcesso = true;
                }
            }

            if (!temAcesso) {
                updates.balaoSelecionado = firebase.firestore.FieldValue.delete();
                mudou = true;
                console.log("Balão expirado removido.");
            }
        }
    }

    // Executa a atualização se necessário
    if (mudou) {
        try {
            await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
            exibirPopup("Itens Expirados", "Alguns itens visuais expiraram (Fim do PRO ou Prêmio Roleta) e foram removidos do seu perfil.", "aviso");
        } catch (e) {
            console.error("Erro ao limpar itens expirados:", e);
        }
    }
}


// ADICIONE ESTA NOVA FUNÇÃO EM INDEX.HTML
async function ativarModoFerias() {
    const inicio = document.getElementById('feriasInicio').value;
    const fim = document.getElementById('feriasFim').value;

    if (!inicio || !fim) {
        return exibirPopup("Por favor, selecione a data de início e fim.");
    }

    const dataInicio = new Date(inicio);
    const dataFim = new Date(fim);

    if (dataFim < dataInicio) {
        return exibirPopup("A data de fim não pode ser anterior à data de início.");
    }
    
    if (!confirm(`Você tem certeza que deseja bloquear sua agenda de ${dataInicio.toLocaleDateString()} até ${dataFim.toLocaleDateString()}? Seus clientes serão notificados.`)) {
        return;
    }

    exibirAguarde("Bloqueando agenda e notificando...");

    try {
        // Lógica de notificação (simples, para não sobrecarregar)
        // Uma implementação mais avançada usaria Cloud Functions para notificar em lotes
        const clientesSnap = await db.collection("agendamentos")
            .where("barbeiroUid", "==", auth.currentUser.uid)
            .where("status", "==", "concluido")
            .get();

        const clientesNotificados = new Set();
        clientesSnap.forEach(doc => {
            const clienteUid = doc.data().clienteUid;
            if (!clientesNotificados.has(clienteUid)) {
                notifyUser(
                    clienteUid, 
                    `🗓️ Aviso de ${perfil.nome}`, 
                    `O profissional estará ausente de ${dataInicio.toLocaleDateString()} a ${dataFim.toLocaleDateString()}.`
                );
                clientesNotificados.add(clienteUid);
            }
        });

        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            ausente: true,
            ausenciaInicio: firebase.firestore.Timestamp.fromDate(dataInicio),
            ausenciaFim: firebase.firestore.Timestamp.fromDate(dataFim)
        });

        fecharTodosOsModais();
        exibirPopup("Modo férias ativado com sucesso! Sua agenda está bloqueada para o período e seus clientes foram notificados.");

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Ocorreu um erro: " + e.message);
    }
}

function exibirPopupBloqueante(titulo, mensagem, onOk) {
    const modal = document.getElementById('modalBloqueante');
    
    // Remove onclick do fundo para impedir fechamento
    modal.onclick = null; 
    
    document.getElementById('tituloBloqueante').textContent = titulo;
    document.getElementById('msgBloqueante').innerHTML = mensagem.replace(/\n/g, '<br>');
    
    const btnOk = document.getElementById('btnOkBloqueante');
    
    // Remove listeners antigos clonando o botão
    const novoBtn = btnOk.cloneNode(true);
    btnOk.parentNode.replaceChild(novoBtn, btnOk);
    
    novoBtn.onclick = () => {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
        if (onOk) onOk(); // Executa a ação (ex: atualizar 'clienteNotificado: true')
    };
    
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

function finalizarOnboarding() {
    localStorage.setItem('onboarding_concluido', 'true');
    const modal = document.getElementById('modalOnboarding');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 500);
    prepararCriarConta();
    mostrar('authView'); // <-- ADICIONE ESTA LINHA
}

function aplicarTemaPorProfissao(interesse) {
    let cor = 'var(--cor-destaque-ouro)';
    if (interesse === 'manicure_pedicure' || interesse === 'designer_cilios') {
        cor = 'var(--cor-destaque-rosa)';
    }
    document.documentElement.style.setProperty('--cor-destaque', cor);
}

// =====================================================================
// ====== INÍCIO: NOVAS FUNÇÕES ONBOARDING (SUBSTITUIR) ===============
// =====================================================================

// Variáveis globais para o fluxo de onboarding
let onboardingServicos = [];
let onboardingPromocoes = [];
let onboardingAgendaConfig = { vagaImediata: false, usaAgendaManual: false, agenda: {} };
let onboardingLogoUrl = null;
let onboardingPortfolioUrls = [];
let etapaAtualOnboarding = 0;

// =====================================================================
// ====== INÍCIO: NOVA FUNÇÃO MESTRE DE ONBOARDING (ADICIONAR) ========
// =====================================================================

/**
 * Esta é a função "mestre" que verifica todas as pendências essenciais
 * em ordem e abre o popup correto.
 * É chamada no login (se o onboarding estiver pendente) e após a conclusão de cada etapa.
 */
async function iniciarFluxoDeConfiguracaoProfissional() {
    if (!perfil) {
        // Garante que o perfil esteja carregado antes de checar
        console.log("Fluxo: Perfil não carregado, buscando...");
        try {
            const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
            if (!userDoc.exists) throw new Error("Usuário não encontrado no DB.");
            perfil = userDoc.data();
        } catch (e) {
            exibirPopup("Erro Crítico", "Não foi possível carregar seu perfil: " + e.message, "erro");
            auth.signOut();
            return;
        }
    }
    
    const p = perfil;
    console.log("Fluxo: Iniciando verificação de pendências de configuração...");

    // Etapa 1: Serviços (ESSENCIAL)
    // Critério: Só aparece se não tiver nenhum serviço.
    if (!p.listaServicos || p.listaServicos.length === 0) {
        console.log("Fluxo: Pendência encontrada [Etapa 1: Serviços]");
        return abrirOnboardingEtapa1(); // <-- CORREÇÃO AQUI (nome da função corrigido)
    }

    // Etapa 3: Agenda (ESSENCIAL)
    // Critério: Só aparece se vaga imediata E Agenda Programada estiverem desativadas/vazias.
    const temHorarioManual = Object.values(p.agenda || {}).some(v => v === true);
    if (!p.vagaImediata && !temHorarioManual) {
        console.log("Fluxo: Pendência encontrada [Etapa 3: Agenda]");
        return abrirOnboardingEtapa3();
    }

    // Etapa 4: Logomarca (ESSENCIAL)
    // Critério: Só aparece se não tiver logo.
    if (!p.logo_url) {
        console.log("Fluxo: Pendência encontrada [Etapa 4: Logomarca]");
        return abrirOnboardingEtapa4();
    }
    
    // Etapa 5: Portfólio (ESSENCIAL)
    // Critério: Só aparece se não tiver nenhuma foto no portfólio.
    if (!p.portfolio || p.portfolio.length === 0) {
        console.log("Fluxo: Pendência encontrada [Etapa 5: Portfólio]");
        return abrirOnboardingEtapa5();
    }

    // Se passou por tudo, finaliza o onboarding!
    console.log("Fluxo: Nenhuma pendência essencial encontrada. Finalizando onboarding.");
    finalizarOnboardingCompleto();
}

// =====================================================================
// ====== FIM: NOVA FUNÇÃO MESTRE DE ONBOARDING (ADICIONAR) ==========
// =====================================================================

// --- ETAPA 1: SERVIÇOS ---
// [SUBSTITUIR ESTA FUNÇÃO]
function abrirOnboardingEtapa1(isModoLembrete = false) {
    etapaAtualOnboarding = 1;
    onboardingServicos = []; // Limpa
    
    const modal = document.getElementById('modalOnboardingProfissionalServicos');
    if (!modal) {
        console.error("Modal modalOnboardingProfissionalServicos não encontrado!");
        return;
    }

    // Limpa campos e lista
    document.getElementById('onboardingServicosList').innerHTML = '';
    document.getElementById('onboardingServicoNome').value = '';
    document.getElementById('onboardingServicoValor').value = '';
    document.getElementById('onboardingServicoTempo').value = '';
    document.getElementById('btnOnboardingNextServicos').disabled = true;

    const btnConcluir = document.getElementById('btnOnboardingNextServicos');
    let btnFechar = document.getElementById('btnOnboardingCloseServicos');

    // Adiciona o botão Fechar se não existir
    if (!btnFechar) {
        btnFechar = document.createElement('button');
        btnFechar.id = 'btnOnboardingCloseServicos';
        btnFechar.textContent = '❌ Fechar';
        btnFechar.style.backgroundColor = '#555';
        btnFechar.onclick = () => fecharOnboardingComAviso(1);
        btnConcluir.parentNode.insertBefore(btnFechar, btnConcluir);
        btnConcluir.parentNode.style.display = 'flex';
        btnConcluir.parentNode.style.gap = '10px';
    }

    // Lógica dos botões baseada no modo
    if (isModoLembrete) {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingServicosLembrete; // Nova função wrapper
        btnFechar.classList.add('hidden'); // Esconde o "Fechar"
        btnFechar.parentNode.style.justifyContent = 'flex-end'; 
    } else {
        btnConcluir.textContent = 'Próximo ➡️'; // No fluxo inicial, é "Próximo"
        btnConcluir.onclick = salvarOnboardingServicos; // Função original
        btnFechar.classList.remove('hidden'); // Mostra o "Fechar"
        btnFechar.parentNode.style.justifyContent = 'space-between';
    }

    abrirModal('modalOnboardingProfissionalServicos');
}

// --- LISTENERS DE REGISTRO E FUNÇÕES DE SERVIÇO (COM PROTEÇÃO) ---

// 1. Proteção: Só adiciona listener se o select 'tipo' existir
const tipoSelectReg = document.getElementById('tipo');
if (tipoSelectReg) {
    tipoSelectReg.addEventListener('change', function() {
        const val = this.value;
        const divProp = document.getElementById('proprietario-check-container');
        
        // Mostra se for qualquer tipo de profissional
        if(val === 'barbeiro' || val === 'manicure_pedicure' || val === 'designer_cilios') {
            divProp.classList.remove('hidden');
        } else {
            divProp.classList.add('hidden');
            // Opcional: Reseta o campo se voltar para cliente
            const propSelect = document.getElementById('isProprietario');
            if(propSelect) propSelect.value = 'nao';
            const nomeBarbInput = document.getElementById("nomeBarbeariaCadastro");
            if(nomeBarbInput) nomeBarbInput.classList.add('hidden');
        }
    });
}

// 2. Proteção: Só adiciona listener se o select 'isProprietario' existir
const isPropSelectReg = document.getElementById('isProprietario');
if (isPropSelectReg) {
    isPropSelectReg.addEventListener('change', function() {
        const isProp = this.value === 'sim';
        const inputNome = document.getElementById("nomeBarbeariaCadastro");
        if(isProp) inputNome.classList.remove('hidden');
        else inputNome.classList.add('hidden');
    });
}

// Função para adicionar serviço na lista visual (Onboarding)
function adicionarServicoOnboarding() {
    const nome = document.getElementById('onboardingServicoNome').value.trim();
    const valor = parseFloat(document.getElementById('onboardingServicoValor').value);
    const tempo = parseInt(document.getElementById('onboardingServicoTempo').value);
    
    if (!nome || isNaN(valor) || valor <= 0 || isNaN(tempo) || tempo <= 0) {
        return exibirPopup("Entrada inválida", "Preencha nome, valor e tempo corretamente.");
    }

    // Adiciona ao array global
    onboardingServicos.push({ nome, valor, duracao: tempo });
    
    const list = document.getElementById('onboardingServicosList');
    // Adicionei um estilo inline simples para ficar mais organizado na lista
    list.innerHTML += `<div style="background:var(--cor-botoes); padding:8px; border-radius:5px; margin-bottom:5px; border:1px solid var(--cor-borda);">✅ ${nome} - R$${valor.toFixed(2)} (${tempo} min)</div>`;
    
    // Limpa campos
    document.getElementById('onboardingServicoNome').value = '';
    document.getElementById('onboardingServicoValor').value = '';
    document.getElementById('onboardingServicoTempo').value = '';
    
    // Habilita o botão de avançar
    const btnNext = document.getElementById('btnOnboardingNextServicos');
    if(btnNext) btnNext.disabled = false;
}

// Salva e avança para a Etapa 2 (Promoções)
async function salvarOnboardingServicos() {
    if (onboardingServicos.length === 0) {
        exibirPopup("Atenção", "Você precisa adicionar pelo menos 1 serviço para continuar.");
        return;
    }
    
    exibirAguarde("Salvando serviços...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            listaServicos: onboardingServicos
        });
        fecharTodosOsModais(); // Fecha aguarde e modal atual
        
        // Verifica se a próxima função existe antes de chamar
        if (typeof abrirOnboardingEtapa2 === 'function') {
            abrirOnboardingEtapa2(); // Abre Etapa 2
        } else {
            console.error("Função abrirOnboardingEtapa2 não encontrada.");
        }
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar serviços", e.message);
    }
}

// --- ETAPA 2: PROMOÇÕES ---
function abrirOnboardingEtapa2() {
    etapaAtualOnboarding = 2;
    onboardingPromocoes = []; // Limpa

    // Carrega os serviços cadastrados na etapa 1 no select
    const selectServicos = document.getElementById('onboardingPromocaoServicos');
    selectServicos.innerHTML = '';
    onboardingServicos.forEach(servico => {
        selectServicos.innerHTML += `<option value="${servico.nome}">${servico.nome} - R$ ${servico.valor.toFixed(2)}</option>`;
    });

    // Limpa campos do formulário
    document.getElementById('onboardingPromocaoNome').value = '';
    document.getElementById('onboardingPromocaoDescricao').value = '';
    document.getElementById('onboardingPromocaoDesconto').value = '';
    document.getElementById('onboardingPromocaoValidade').value = '';
    
    abrirModal('modalOnboardingPromocoes');
}

// Salva e avança para a Etapa 3 (Agenda)
async function salvarOnboardingPromocao() {
    const nome = document.getElementById('onboardingPromocaoNome').value.trim();
    const descricao = document.getElementById('onboardingPromocaoDescricao').value.trim();
    const desconto = parseInt(document.getElementById('onboardingPromocaoDesconto').value);
    const validadeInput = document.getElementById('onboardingPromocaoValidade').value;
    const servicosSelecionados = Array.from(document.getElementById('onboardingPromocaoServicos').selectedOptions).map(option => option.value);

    // Validação
    if (servicosSelecionados.length === 0 || !nome || isNaN(desconto) || desconto <= 0) {
        document.getElementById('overlayOnboardingPromocao').classList.remove('hidden');
        return;
    }
    
    const novaPromocao = {
        id: `promo_${new Date().getTime()}`, nome, descricao, desconto, 
        servicosAplicaveis: servicosSelecionados, valorMinimo: 0,
        validade: validadeInput ? new Date(validadeInput + 'T23:59:59') : null 
    };
    
    onboardingPromocoes.push(novaPromocao); // Salva localmente por enquanto

    exibirAguarde("Salvando promoção...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao)
        });
        fecharTodosOsModais();
        abrirOnboardingEtapa3(); // Abre Etapa 3
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar promoção", e.message);
    }
}

// --- LÓGICA DO REGISTRO (MOSTRAR PERGUNTA DE PROPRIETÁRIO) ---

// 1. Pega os elementos do HTML
const regTipoSelect = document.getElementById('tipo');
const regDivProprietario = document.getElementById('proprietario-check-container');
const regSelectIsProp = document.getElementById('isProprietario');
const regInputNomeBarb = document.getElementById('nomeBarbeariaCadastro');

// 2. Adiciona o evento de mudança no Tipo (Cliente vs Profissional)
if (regTipoSelect && regDivProprietario) {
    regTipoSelect.addEventListener('change', function() {
        const val = this.value;
        // Se for qualquer profissional, MOSTRA a pergunta
        if(['barbeiro', 'manicure_pedicure', 'designer_cilios'].includes(val)) {
            regDivProprietario.classList.remove('hidden');
        } else {
            // Se for cliente, ESCONDE
            regDivProprietario.classList.add('hidden');
            // Reseta os campos internos para evitar cadastro errado
            if(regSelectIsProp) regSelectIsProp.value = 'nao';
            if(regInputNomeBarb) regInputNomeBarb.classList.add('hidden');
        }
    });
}

// 3. Adiciona o evento de mudança na pergunta "É dono?"
if (regSelectIsProp && regInputNomeBarb) {
    regSelectIsProp.addEventListener('change', function() {
        if(this.value === 'sim') {
            regInputNomeBarb.classList.remove('hidden'); // Mostra input do nome da barbearia
        } else {
            regInputNomeBarb.classList.add('hidden'); // Esconde
        }
    });
}

// --- ETAPA 3: AGENDA ---
function abrirOnboardingEtapa3(isModoLembrete = false) {
    etapaAtualOnboarding = 3;
    const modal = document.getElementById('modalOnboardingAgenda');
    
    onboardingAgendaConfig = { vagaImediata: false, usaAgendaManual: false, agenda: {} };

    const btnDisp = document.getElementById("onboardingBtnDisponibilidade");
    const btnVaga = document.getElementById("onboardingBtnVagaImediata");
    const btnManual = document.getElementById("onboardingBtnAgendaManual");
    const painelManual = document.getElementById("onboardingAgendaManualPainel");
    const horariosContainer = document.getElementById("onboardingHorariosContainer");

    btnDisp.textContent = '🟢 Ficar Disponível (Automático)';
    btnDisp.classList.remove('selected'); 
    onboardingAgendaConfig.disponivel = "nao";
    btnVaga.textContent = '⚡ Ativar Vaga Imediata';
    btnVaga.classList.remove('selected');
    btnManual.textContent = '📅 Ativar Agenda Programada';
    btnManual.classList.remove('selected');
    painelManual.classList.add("hidden");
    
    horariosContainer.innerHTML = "";
    for (let i = 7 * 60; i <= 18 * 60; i += 30) {
        const horas = Math.floor(i / 60);
        const minutos = i % 60;
        const horario = `${horas}:${minutos.toString().padStart(2, '0')}`;
        const btn = document.createElement('button');
        btn.textContent = horario;
        btn.className = `horario-btn`;
        btn.onclick = () => {
            const statusAtual = onboardingAgendaConfig.agenda[horario];
            if (statusAtual === true) {
                delete onboardingAgendaConfig.agenda[horario];
                btn.classList.remove("selecionado");
            } else {
                onboardingAgendaConfig.agenda[horario] = true;
                btn.classList.add("selecionado");
            }
        };
        horariosContainer.appendChild(btn);
    }

    // Lógica dos botões
    const btnConcluir = document.getElementById('btnOnboardingNextAgenda');
    const btnFechar = modal.querySelector('button[onclick^="fecharOnboardingComAviso(3)"]'); 

    if (isModoLembrete) {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingAgendaLembrete; // Nova função wrapper
        if(btnFechar) btnFechar.classList.add('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'flex-end';
    } else {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingAgenda; // Função original
        if(btnFechar) btnFechar.classList.remove('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'space-between';
    }
    
    abrirModal('modalOnboardingAgenda');
}

// Funções de toggle para a agenda do onboarding
function toggleOnboardingDisponibilidade() {
    const btnDisp = document.getElementById("onboardingBtnDisponibilidade");
    const novoStatus = (onboardingAgendaConfig.disponivel === "sim") ? "nao" : "sim";
    onboardingAgendaConfig.disponivel = novoStatus;
    btnDisp.textContent = novoStatus === 'sim' ? '🔴 Ficar Indisponível (Automático)' : '🟢 Ficar Disponível (Automático)';
    btnDisp.classList.toggle('selected', novoStatus === 'sim');
}

function toggleOnboardingVagaImediata() {
    const btnVaga = document.getElementById("onboardingBtnVagaImediata");
    onboardingAgendaConfig.vagaImediata = !onboardingAgendaConfig.vagaImediata;
    btnVaga.textContent = onboardingAgendaConfig.vagaImediata ? '⚠️ Desativar Vaga Imediata' : '⚡ Ativar Vaga Imediata';
    btnVaga.classList.toggle('selected', onboardingAgendaConfig.vagaImediata);

    // --- LÓGICA DE DESATIVAÇÃO MÚTUA REMOVIDA ---
}

function toggleOnboardingAgendaManual() {
    const btnManual = document.getElementById("onboardingBtnAgendaManual");
    onboardingAgendaConfig.usaAgendaManual = !onboardingAgendaConfig.usaAgendaManual;
    btnManual.classList.toggle('selected', onboardingAgendaConfig.usaAgendaManual);
    document.getElementById("onboardingAgendaManualPainel").classList.toggle("hidden", !onboardingAgendaConfig.usaAgendaManual);

    // --- LÓGICA DE DESATIVAÇÃO MÚTUA REMOVIDA ---
}

// Salva e avança para a Etapa 4 (Logomarca)
async function salvarOnboardingAgenda() {
    // Validação: Pelo menos uma opção deve ser ativada
    const { disponivel, vagaImediata, usaAgendaManual, agenda } = onboardingAgendaConfig;
    const agendaManualConfigurada = usaAgendaManual && Object.values(agenda).some(v => v === true);

    if (disponivel === "nao" && !vagaImediata && !agendaManualConfigurada) {
        document.getElementById('overlayOnboardingAgenda').classList.remove('hidden');
        return;
    }
    
    exibirAguarde("Salvando agenda...");
    try {
        const updates = {
            disponivel: disponivel,
            vagaImediata: vagaImediata,
            usaAgendaManual: usaAgendaManual,
            agenda: usaAgendaManual ? agenda : {} // Salva agenda se manual, senão limpa
        };
        await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
        fecharTodosOsModais();
        abrirOnboardingEtapa4(); // Abre Etapa 4
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar agenda", e.message);
    }
}

function abrirOnboardingEtapa4(isModoLembrete = false) {
    etapaAtualOnboarding = 4;
    onboardingLogoUrl = null; 
    const modal = document.getElementById('modalOnboardingLogomarca');

    const fileInput = document.getElementById("onboardingLogomarcaFile");
    const previewImg = document.getElementById("onboardingLogomarcaPreview");
    const btnSalvar = document.getElementById("btnOnboardingNextLogo");
    
    // Reseta estado visual
    fileInput.value = ''; 
    previewImg.src = 'https://placehold.co/150?text=Sua+Foto'; // Reset imagem
    btnSalvar.disabled = true;

    // Listener para quando o usuário seleciona o arquivo
    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                btnSalvar.disabled = false; 
            }
            reader.readAsDataURL(file);
        }
    };

    // Configura botões dependendo se é o fluxo inicial ou lembrete
    const btnConcluir = btnSalvar;
    // Tenta encontrar o botão "Fechar" (que agora pode ser "Depois")
    const btnFechar = modal.querySelector('button[onclick^="fecharOnboardingComAviso(4)"]');

    if (isModoLembrete) {
        btnConcluir.textContent = 'Salvar Foto ➡️';
        btnConcluir.onclick = salvarOnboardingLogoLembrete;
        if(btnFechar) btnFechar.classList.add('hidden'); // Esconde opção de pular no lembrete
    } else {
        btnConcluir.textContent = 'Próximo ➡️';
        btnConcluir.onclick = salvarOnboardingLogo; 
        if(btnFechar) {
            btnFechar.classList.remove('hidden');
            btnFechar.textContent = "Pular (Fazer Depois)";
        }
    }
    
    abrirModal('modalOnboardingLogomarca');
}

async function salvarOnboardingLogo() {
    const fileInput = document.getElementById("onboardingLogomarcaFile");
    const progressBar = document.getElementById('onboardingLogoUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextLogo');

    if (!fileInput.files || fileInput.files.length === 0) {
        document.getElementById('overlayOnboardingLogo').classList.remove('hidden');
        return;
    }
    
    const file = fileInput.files[0];
    const userId = auth.currentUser.uid;
    const filePath = `perfis/${userId}/${Date.now()}_${file.name}`;

    exibirAguarde("Enviando foto...");
    progressBar.style.display = 'block'; 
    btnSalvar.disabled = true;

    try {
        const downloadURL = await uploadImage(file, filePath, (progress) => {
            progressBar.value = progress;
        });
        
        onboardingLogoUrl = downloadURL;

        // ATENÇÃO: Salvamos tanto em logo_url (compatibilidade) quanto em fotoPerfil (novo padrão)
        await db.collection("usuarios").doc(userId).update({
            logo_url: downloadURL,
            fotoPerfil: downloadURL
        });
        
        fecharTodosOsModais();
        abrirOnboardingEtapa5(); // Vai para o Portfólio
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; 
        btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar foto", error.message);
    }
}

// Versão para o Lembrete (Popups Persistentes)
async function salvarOnboardingLogoLembrete() {
    const fileInput = document.getElementById("onboardingLogomarcaFile");
    const progressBar = document.getElementById('onboardingLogoUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextLogo');

    if (!fileInput.files || fileInput.files.length === 0) {
        return exibirPopup("Selecione uma foto.");
    }
    
    const file = fileInput.files[0];
    const userId = auth.currentUser.uid;
    const filePath = `perfis/${userId}/${Date.now()}_${file.name}`;

    exibirAguarde("Atualizando perfil...");
    progressBar.style.display = 'block'; 
    btnSalvar.disabled = true;

    try {
        const downloadURL = await uploadImage(file, filePath, (progress) => {
            progressBar.value = progress;
        });
        
        await db.collection("usuarios").doc(userId).update({
            logo_url: downloadURL,
            fotoPerfil: downloadURL
        });
        
        fecharTodosOsModais();
        abrirProximoPopupDeLembrete(); // Chama o próximo item pendente
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; 
        btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar", error.message, "erro");
    }
}

// --- ETAPA 5: PORTFÓLIO ---
function abrirOnboardingEtapa5(isModoLembrete = false) {
    etapaAtualOnboarding = 5;
    onboardingPortfolioUrls = []; 
    const modal = document.getElementById('modalOnboardingPortfolio');

    const fileInput = document.getElementById("onboardingPortfolioFilesInput");
    const previewContainer = document.getElementById("onboardingPortfolioPreviews");
    const btnSalvar = document.getElementById("btnOnboardingNextPortfolio");

    fileInput.value = '';
    previewContainer.innerHTML = '';
    btnSalvar.disabled = true;
    
    fileInput.onchange = (event) => {
        previewContainer.innerHTML = ''; 
        const files = event.target.files;
        
        if (files.length === 0) {
            btnSalvar.disabled = true;
            return;
        }
        if (files.length > 30) {
            exibirPopup("Limite Excedido", "Você pode enviar no máximo 30 imagens de uma vez.");
            fileInput.value = '';
            btnSalvar.disabled = true;
            return;
        }

        Array.from(files).forEach(file => {
             const reader = new FileReader();
             reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '60px'; img.style.height = '60px';
                img.style.objectFit = 'cover'; img.style.borderRadius = '4px';
                previewContainer.appendChild(img);
             }
             reader.readAsDataURL(file);
        });
        btnSalvar.disabled = false; 
    };

    // Lógica dos botões
    const btnConcluir = btnSalvar; // Reutilizando a var
    const btnFechar = modal.querySelector('button[onclick^="fecharOnboardingComAviso(5)"]');

    if (isModoLembrete) {
        btnConcluir.textContent = '🎉 Concluir'; // Última etapa
        btnConcluir.onclick = salvarOnboardingPortfolioLembrete; // Nova função wrapper
        if(btnFechar) btnFechar.classList.add('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'flex-end';
    } else {
        btnConcluir.textContent = '🎉 Finalizar Configuração'; // Última etapa
        btnConcluir.onclick = salvarOnboardingPortfolio; // Função original
        if(btnFechar) btnFechar.classList.remove('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'space-between';
    }

    abrirModal('modalOnboardingPortfolio');
}

// [ADICIONAR ESTAS NOVAS FUNÇÕES]

/** (Modo Lembrete) Salva Serviços e chama o próximo popup */
async function salvarOnboardingServicosLembrete() {
    if (onboardingServicos.length === 0) {
        exibirPopup("Atenção", "Você precisa adicionar pelo menos 1 serviço para continuar.");
        return;
    }
    
    exibirAguarde("Salvando serviços...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            listaServicos: onboardingServicos
        });
        fecharTodosOsModais(); // Fecha aguarde e modal
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar serviços", e.message, "erro");
    }
}

/** (Modo Lembrete) Salva Agenda e chama o próximo popup */
async function salvarOnboardingAgendaLembrete() {
    const { disponivel, vagaImediata, usaAgendaManual, agenda } = onboardingAgendaConfig;
    const agendaManualConfigurada = usaAgendaManual && Object.values(agenda).some(v => v === true);

    if (disponivel === "nao" && !vagaImediata && !agendaManualConfigurada) {
        document.getElementById('overlayOnboardingAgenda').classList.remove('hidden');
        return;
    }
    
    exibirAguarde("Salvando agenda...");
    try {
        const updates = {
            disponivel: disponivel,
            vagaImediata: vagaImediata,
            usaAgendaManual: usaAgendaManual,
            agenda: usaAgendaManual ? agenda : {}
        };
        await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
        fecharTodosOsModais();
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar agenda", e.message, "erro");
    }
}

/** (Modo Lembrete) Salva Portfólio e chama o próximo popup (que finalizará) */
async function salvarOnboardingPortfolioLembrete() {
    const fileInput = document.getElementById("onboardingPortfolioFilesInput");
    const progressBar = document.getElementById('onboardingPortfolioUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextPortfolio');
    const userId = auth.currentUser.uid;
    const files = fileInput.files;

    if (!files || files.length === 0) {
        document.getElementById('overlayOnboardingPortfolio').classList.remove('hidden');
        return;
    }
    
    exibirAguarde(`Enviando ${files.length} imagem(ns)...`);
    progressBar.style.display = 'block'; btnSalvar.disabled = true;

    // (Lógica de upload copiada de 'salvarOnboardingPortfolio')
    const uploadPromises = [];
    let totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
    const uploadTasksInfo = [];

    Array.from(files).forEach((file, index) => {
        const filePath = `portfolio/${userId}/${Date.now()}_${index}_${file.name}`;
        const uploadPromise = new Promise((resolve, reject) => {
            const storageRef = storage.ref(filePath);
            const uploadTask = storageRef.put(file);
            const taskInfo = { task: uploadTask, bytesTransferred: 0 };
            uploadTasksInfo.push(taskInfo);

            uploadTask.on('state_changed',
                (snapshot) => {
                    taskInfo.bytesTransferred = snapshot.bytesTransferred;
                    let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                    const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                    progressBar.value = progress;
                },
                (error) => reject(error),
                async () => {
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve(downloadURL);
                    } catch(urlError) { reject(urlError); }
                }
            );
        });
        uploadPromises.push(uploadPromise);
    });

    try {
        const novasUrls = await Promise.all(uploadPromises);
        
        await db.collection('usuarios').doc(userId).update({
            portfolio: firebase.firestore.FieldValue.arrayUnion(...novasUrls)
        });
        
        fecharTodosOsModais();
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador (que verá que tudo está completo)
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar portfólio", error.message, "erro");
    }
}

// Salva e FINALIZA o fluxo
async function salvarOnboardingPortfolio() {
    const fileInput = document.getElementById("onboardingPortfolioFilesInput");
    const progressBar = document.getElementById('onboardingPortfolioUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextPortfolio');
    const userId = auth.currentUser.uid;
    const files = fileInput.files;

    if (!files || files.length === 0) {
        document.getElementById('overlayOnboardingPortfolio').classList.remove('hidden');
        return;
    }
    
    exibirAguarde(`Enviando ${files.length} imagem(ns)...`);
    progressBar.style.display = 'block'; btnSalvar.disabled = true;

    const uploadPromises = [];
    let totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
    const uploadTasksInfo = [];

    Array.from(files).forEach((file, index) => {
        const filePath = `portfolio/${userId}/${Date.now()}_${index}_${file.name}`;
        const uploadPromise = new Promise((resolve, reject) => {
            const storageRef = storage.ref(filePath);
            const uploadTask = storageRef.put(file);
            const taskInfo = { task: uploadTask, bytesTransferred: 0 };
            uploadTasksInfo.push(taskInfo);

            uploadTask.on('state_changed',
                (snapshot) => {
                    taskInfo.bytesTransferred = snapshot.bytesTransferred;
                    let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                    const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                    progressBar.value = progress;
                },
                (error) => reject(error),
                async () => {
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve(downloadURL); // Retorna a URL
                    } catch(urlError) { reject(urlError); }
                }
            );
        });
        uploadPromises.push(uploadPromise);
    });

    try {
        const novasUrls = await Promise.all(uploadPromises);
        onboardingPortfolioUrls = novasUrls; // Salva localmente

        await db.collection('usuarios').doc(userId).update({
            portfolio: firebase.firestore.FieldValue.arrayUnion(...novasUrls)
        });
        
        // Se chegou aqui, tudo deu certo
        finalizarOnboardingCompleto();
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar portfólio", error.message);
    }
}

// --- FUNÇÕES DE CONTROLE DO FLUXO ONBOARDING ---

function fecharOnboardingComAviso(etapa) {
    etapaAtualOnboarding = etapa; // Guarda a etapa atual
    const mensagens = {
        1: "Você precisa adicionar seus serviços para que clientes possam agendar.",
        2: "Sem promoções, você pode perder a chance de atrair novos clientes.",
        3: "Você deve configurar sua agenda para que clientes saibam quando você atende.",
        4: "Uma logomarca gera credibilidade e ajuda clientes a te reconhecerem.",
        5: "O portfólio é essencial para clientes verem a qualidade do seu trabalho."
    };
    
    document.getElementById('avisoOnboardingTitulo').textContent = `Sair da Etapa ${etapa}?`;
    document.getElementById('avisoOnboardingMensagem').textContent = mensagens[etapa] || "Você pode concluir esta etapa mais tarde nas configurações.";
    
    abrirModal('modalAvisoOnboarding');
}

async function confirmarFechamentoOnboarding() {
    fecharTodosOsModais(); // Fecha o aviso e o modal da etapa
    
    // --- NOVA LÓGICA (PEDIDO DO USUÁRIO) ---
    // Marca o onboarding inicial como "ignorado" para não mostrar mais.
    // O novo fluxo de "lembrete" será ativado no próximo login.
    exibirAguarde("Salvando preferência...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            precisaConfiguracaoInicial: false // <-- A MUDANÇA PRINCIPAL
        });
        fecharTodosOsModais();
        exibirPopup("OK!", "Você pode completar as configurações mais tarde no seu painel. Elas são essenciais para clientes agendarem.");
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível salvar sua preferência: " + e.message, "erro");
    }
    // --- FIM DA NOVA LÓGICA ---
}

// Chamada APENAS no sucesso da Etapa 5
async function finalizarOnboardingCompleto() {
    exibirAguarde("Finalizando configuração...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            precisaConfiguracaoInicial: false // Finalmente, marca como concluído!
        });
        fecharTodosOsModais(); // Fecha o aguarde e o modal de portfólio
        exibirPopup("🎉 Configuração Concluída!", "Seu perfil de profissional está pronto! Bem-vindo(a) ao King Agenda.");
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao finalizar", e.message);
    }
}


// Substitui a função 'avancarOnboarding' antiga que não será mais usada
function avancarOnboarding(etapa) {
   // Esta função foi substituída pela nova lógica (salvarOnboardingServicos, etc.)
   // Mas a deixamos aqui em branco para evitar erros caso algo ainda a chame.
   console.warn("Função 'avancarOnboarding' obsoleta foi chamada.");
}

// =====================================================================
// ====== FIM: NOVAS FUNÇÕES ONBOARDING (SUBSTITUIR) =================
// =====================================================================

async function adminDeletarProduto(produtoId, nome) {
    if(confirm(`Tem certeza que deseja deletar o produto "${nome}"?`)) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        exibirPopup("Produto deletado!");
        fecharModalAtual();
    }
}

async function abrirGerenciarLojaAdmin() {
    abrirModal('modalGerenciarLojaAdmin');
    const produtosList = document.getElementById('adminDeletarProdutoList');
    const usuariosList = document.getElementById('adminToggleLojaList');
    produtosList.innerHTML = "<p>Carregando...</p>";
    usuariosList.innerHTML = "<p>Carregando...</p>";

    // BOTÃO PREMIUM ADICIONADO AQUI
    const modalContent = document.querySelector('#modalGerenciarLojaAdmin .modal-content');
    if (!document.getElementById('btnAdicionarPremium')) {
        const btnPremium = document.createElement('button');
        btnPremium.id = 'btnAdicionarPremium';
        btnPremium.textContent = '🌟 Adicionar Produto PREMIUM';
        btnPremium.className = 'btn-admin-premium'; 
        btnPremium.onclick = () => abrirFormularioProduto(null, true); // Chama com flag Premium
        // Insere logo após o título (index 0 é titulo, 1 é conteúdo)
        modalContent.insertBefore(btnPremium, modalContent.children[1]); 
    }

    const produtosSnap = await db.collection('loja_produtos').get();
    produtosList.innerHTML = "";
    produtosSnap.forEach(doc => {
        const p = doc.data();
        produtosList.innerHTML += `<div class="card">${p.nome} por ${p.vendedorNome} <button style="background: #c0392b; float:right;" onclick="adminDeletarProduto('${doc.id}', '${p.nome}')">X</button></div>`;
    });

    const usersSnap = await db.collection('usuarios').where('lojaLiberada', 'in', [true, false]).get();
    usuariosList.innerHTML = "";
    usersSnap.forEach(doc => {
        const u = doc.data();
        if (u.tipo === 'admin') return;
        usuariosList.innerHTML += `<div class="card">${u.nome} <button style="float:right;" onclick="adminToggleLoja('${doc.id}', ${!u.lojaLiberada})">${u.lojaLiberada ? 'Desativar' : 'Ativar'}</button></div>`;
    });
}

async function registrarSincronizacaoDeMensagem(mensagemData) {
    const swRegistration = await navigator.serviceWorker.ready;
    // Salve a mensagem no IndexedDB (armazenamento local) aqui
    await swRegistration.sync.register('enviar-mensagem-chat');
    console.log('Sincronização para envio de mensagem registrada.');
}

// --- FUNÇÕES DE FAVORITOS CORRIGIDAS ---

// Alterna o estado do filtro (Mostrar Todos <-> Mostrar Favoritos)
function alternarFiltroFavoritos() {
    mostrarApenasFavoritos = !mostrarApenasFavoritos;
    
    // Atualiza visual do botão (se estiver visível)
    const btn = document.getElementById('btnMostrarFavoritos');
    if (btn) {
        btn.textContent = mostrarApenasFavoritos ? "📋 Mostrar Todos" : "⭐ Mostrar Apenas Favoritos";
        btn.classList.toggle('estilo-gold', !mostrarApenasFavoritos);
        btn.classList.toggle('estilo-pink', mostrarApenasFavoritos); // Exemplo de troca de cor
    }

    // Identifica qual lista precisa ser recarregada com base no que está visível
    const modalBusca = document.getElementById('modalBarbeariasCliente');
    
    if (modalBusca && modalBusca.classList.contains('show')) {
        // Se o modal de busca está aberto, atualiza ele
        carregarBarbeirosPrincipal('listaBarbeirosPrincipalModal', false);
    } else {
        // Se não, atualiza a lista do painel principal
        if (userView.currentType === 'cliente') {
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
        } else {
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
        }
    }
}

// --- FUNÇÃO DE FAVORITAR COM FEEDBACK INSTANTÂNEO ---
async function toggleFavorito(barbeiroUid) {
    if (!auth.currentUser) return;
    
    const userRef = db.collection('usuarios').doc(auth.currentUser.uid);
    const listaFavoritosAtual = perfil.favoritos || [];
    const jaFavorito = listaFavoritosAtual.includes(barbeiroUid);
    
    // 1. ATUALIZAÇÃO VISUAL OTIMISTA (Muda na hora!)
    // Procura todos os botões desse barbeiro na tela
    const botoes = document.querySelectorAll(`button[onclick*="toggleFavorito('${barbeiroUid}')"]`);
    
    botoes.forEach(btn => {
        if (jaFavorito) {
            // Vai remover: Vira coração vazio
            btn.innerHTML = '♡';
            btn.style.color = 'white';
        } else {
            // Vai adicionar: Vira coração cheio e colorido
            btn.innerHTML = '❤️';
            btn.style.color = 'var(--cor-destaque)';
        }
        // Efeito de pulso ao clicar
        btn.style.transform = 'scale(1.3)';
        setTimeout(() => btn.style.transform = 'scale(1)', 200);
    });

    // 2. ATUALIZAÇÃO NO BANCO DE DADOS
    try {
        if (jaFavorito) {
            await userRef.update({
                favoritos: firebase.firestore.FieldValue.arrayRemove(barbeiroUid)
            });
        } else {
            await userRef.update({
                favoritos: firebase.firestore.FieldValue.arrayUnion(barbeiroUid)
            });
            // Toca som de sucesso
            tocarSom('ping');
        }
        
    } catch (error) {
        console.error("Erro ao favoritar:", error);
        // Se der erro, reverte visualmente
        botoes.forEach(btn => {
            if (jaFavorito) {
                btn.innerHTML = '❤️';
                btn.style.color = 'var(--cor-destaque)';
            } else {
                btn.innerHTML = '♡';
                btn.style.color = 'white';
            }
        });
        exibirPopup("Erro ao salvar favorito.");
    }
}

function copiarParaClipboard(text, nome) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
            .then(() => exibirPopup("Link Copiado", `O link para o perfil de ${nome} foi copiado! Cole no WhatsApp ou outras redes.`))
            .catch(err => console.error('Erro ao copiar:', err));
    } else {
        // Fallback manual para navegadores muito antigos
        exibirPopup("Link Manual", "Seu navegador não suporta cópia automática. Copie o link abaixo manualmente: <br><br>" + text, 8000);
    }
}

// Função principal de compartilhamento
function compartilharPerfil(nome, uid) {
    // URL que direciona o usuário para a página principal com o parâmetro 'p' (profile)
    const shareUrl = window.location.origin + window.location.pathname + '?p=' + uid; 

    if (navigator.share) {
        // Usa a API nativa do sistema operacional (mais elegante)
        navigator.share({
            title: 'King Agenda - ' + nome,
            text: 'Agende um horário com ' + nome + ' no app King Agenda!',
            url: shareUrl
        }).catch(error => {
            console.warn('Compartilhamento falhou, usando fallback de cópia.', error);
            copiarParaClipboard(shareUrl, nome);
        });
    } else {
        // Fallback: Copiar para área de transferência
        copiarParaClipboard(shareUrl, nome);
    }
}

// Verifica se há um parâmetro de perfil na URL e abre o perfil
function checarParametrosURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const profileUid = urlParams.get('p'); // 'p' é o parâmetro de perfil
    const homeHash = window.location.hash.includes('cliente') || window.location.hash.includes('barbeiro');

    if (profileUid) {
        // 1. Limpa o parâmetro da URL para que o link não recarregue o perfil se o usuário navegar
        const newUrl = window.location.origin + window.location.pathname + (homeHash ? window.location.hash : '');
        window.history.replaceState({}, document.title, newUrl);
        
        // 2. Abre o perfil do barbeiro. 
        // Se o usuário estiver deslogado, isGuest será true, permitindo a visualização.
        const isGuest = !auth.currentUser;
        abrirBarbeiroPerfil(profileUid, isGuest); 
        return true; // Indica que o deep link foi tratado
    }
    return false; // Indica que não havia deep link
}

function setupConfiguracoes() {
    // --- CORREÇÃO: REMOVIDAS CHAMADAS DO PAINEL VISITANTE ANTIGO ---
    // configurarBotoesGuest();  <-- REMOVIDO
    // carregarBarbeirosPrincipal('listaBarbeirosPrincipalGuest', true); <-- REMOVIDO

    const btnSolicitarLoja = document.getElementById('btnSolicitarAcessoLoja');
    const msgLojaLiberada = document.getElementById('msgLojaJaLiberada');

    if (btnSolicitarLoja && msgLojaLiberada && perfil) {
        const mostrarBotao = !perfil.lojaLiberada && perfil.tipo !== 'admin';
        btnSolicitarLoja.classList.toggle('hidden', !mostrarBotao);
        msgLojaLiberada.classList.toggle('hidden', mostrarBotao);
    }

    const secaoVirarProfissional = document.getElementById('secaoVirarProfissional');
    if (secaoVirarProfissional && perfil) {
        secaoVirarProfissional.classList.toggle('hidden', perfil.tipo !== 'cliente');
    }

    // --- LÓGICA DE ALTERAÇÃO DE INTERESSE (NICHO) ---
    const interesseContainer = document.getElementById('configInteresseContainer');
    const buttons = interesseContainer ? interesseContainer.querySelectorAll('button') : [];
    
    buttons.forEach(btn => {
        // Marca visualmente o botão do interesse atual
        const isActive = btn.dataset.interesse === (perfil.interesse_principal || 'barbeiro');
        btn.classList.toggle('selected', isActive);
        
        btn.onclick = async () => {
            const novoInteresse = btn.dataset.interesse;
            
            // Se clicar no que já está selecionado, não faz nada
            if (novoInteresse === perfil.interesse_principal) return;

            exibirAguarde("Alterando interesse...");
            try {
                // Atualiza no banco
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ 
                    interesse_principal: novoInteresse 
                });
                
                fecharTodosOsModais();
                exibirPopup("Sucesso", "Seu interesse foi atualizado! O app será recarregado para exibir os novos profissionais.", "sucesso");
                           
            } catch (error) {
                fecharTodosOsModais();
                exibirPopup("Erro", "Não foi possível alterar o interesse: " + error.message);
            }
        }
    });
}

// Gera a lista completa de prêmios dinamicamente
function gerarListaPremiosRoleta() {
    let lista = [];

    // 1. Pontos de Fidelidade (1 a 10)
    for (let i = 1; i <= 10; i++) {
        lista.push({ tipo: 'ponto', id: `ponto_${i}`, val: i, nome: `${i} Pontos` });
    }

    // 2. Todas as Molduras (Se existirem)
    if (typeof MOLDURAS !== 'undefined') {
        Object.keys(MOLDURAS).forEach(key => {
            const m = MOLDURAS[key];
            if (!m.adminOnly) { // Opcional: esconder exclusivas de admin
                lista.push({ tipo: 'moldura', id: key, val: m.classe, nome: m.nome, imgHtml: `<div class="mini-moldura-preview ${m.classe}"></div>` });
            }
        });
    }

    // 3. Todos os Balões (Se existirem)
    if (typeof BALOES !== 'undefined') {
        Object.keys(BALOES).forEach(key => {
            const b = BALOES[key];
            if (!b.adminOnly) {
                lista.push({ tipo: 'balao', id: key, val: b.classe, nome: b.nome, imgHtml: `<div class="mini-balao-preview chat-message ${b.classe}">Chat</div>` });
            }
        });
    }

    // 4. PRÊMIO PRINCIPAL: Caixa Surpresa (Sempre por último ou espalhado)
    lista.push({ tipo: 'caixa', id: 'caixa_surpresa', val: '🎁', nome: 'Caixa Surpresa' });

    return lista;
}

function abrirModalPerfil() {
    if (!perfil) return;

    const nomeAtual = perfil.nome || "";
    const fotoAtual = perfil.fotoPerfil || 'https://placehold.co/100';
    
    // 1. Gera e EMBARALHA a lista
    let listaCrua = gerarListaPremiosRaw();
    window.itensRoletaAtual = shuffleArray(listaCrua); // Salva na global embaralhado!

    // 2. Cria o HTML da faixa visual
    let faixaHtml = '';
    // Repete 50 vezes para dar efeito infinito
    for(let i=0; i<50; i++) {
        window.itensRoletaAtual.forEach(item => {
            let conteudo = '';
            let classeExtra = '';

            if (item.tipo === 'ponto') {
                conteudo = `<span>${item.val}</span>`;
                classeExtra = 'ponto';
            } else if (item.tipo === 'caixa') {
                conteudo = `<span>${item.val}</span>`;
                classeExtra = 'caixa';
            } else {
                conteudo = item.imgHtml;
                classeExtra = 'premio-top';
            }
            faixaHtml += `<div class="roleta-item ${classeExtra}">${conteudo}</div>`;
        });
    }

    const premioCaixa = perfil.tipo === 'cliente' ? '💎 VIP (3 Dias)' : '🚀 Destaque Topo (24h)';
    const infoTexto = `🎁 Caixa Surpresa: ${premioCaixa}`;
    const infoPremios = `Sorteio entre ${window.itensRoletaAtual.length} itens embaralhados!`;

    const modal = document.getElementById('modalMeuPerfil');
    
    // --- TRUQUE PARA OS POPUPS ABRIREM POR CIMA ---
    // Definimos o z-index deste modal como 10000. 
    // Os modais de checkin/resgate devem ter z-index maior (ex: 15000) no CSS.
    modal.style.zIndex = '10000'; 

    const content = modal.querySelector('.modal-content');

    content.innerHTML = `
        <h3>👤 Editar Perfil</h3>
        
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="position: relative; display: inline-block;">
                <img id="perfilFotoPreview" src="${fotoAtual}" class="perfil-foto-grande" style="width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333; object-fit: cover;">
                <label for="perfilFotoInput" style="position: absolute; bottom: 0; right: 0; background: var(--cor-destaque); color: #000; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">📷</label>
            </div>
            <input type="file" id="perfilFotoInput" accept="image/*" style="display: none;" onchange="previewFotoPerfil()">
        </div>

        <label>Nome de Exibição:</label>
        <input type="text" id="perfilNomeInput" value="${nomeAtual}" placeholder="Seu nome">

        <div class="popup-section">
            <h4>🎰 Roleta Diária</h4>
            <div style="background: #222; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444;">
                <p id="roletaInfoPremios" style="font-size: 12px; color: #ffcc00; margin: 0 0 5px 0;">${infoTexto}</p>
                <p style="font-size: 10px; color: #ccc; margin: 0; line-height: 1.3;">${infoPremios}</p>
            </div>
            
            <div class="roleta-wrapper-externo" style="position: relative;">
                 <div class="seta-externa topo"></div>
                 <div id="roletaVisual" class="roleta-container" style="margin: 0;">
                    <div class="roleta-faixa" id="roletaFaixa" style="transform: translateX(0px);">${faixaHtml}</div>
                 </div>
                 <div class="seta-externa baixo"></div>
            </div>
            <button id="btnGirarRoleta" onclick="girarRoleta()" style="width: 100%; font-weight: bold; font-size: 16px; margin-top:10px;">Carregando...</button>
        </div>

        <div class="popup-section">
            <h4>🖼️ Molduras de Perfil</h4>
            <div id="listaMolduras" class="molduras-scroll-container"></div>
        </div>

        <div class="popup-section" style="border-top: 1px solid var(--cor-borda); padding-top: 15px;">
            <h4>💬 Estilos de Chat</h4>
            <div id="listaBaloes" class="molduras-scroll-container"></div>
        </div>
  
        <div class="popup-section" style="border-top: 1px solid var(--cor-borda); padding-top: 15px;">
            <h4 style="color: #2ecc71;">🎯 Missões de Hoje</h4>
            <div id="containerMissoesDiarias" style="margin-top: 10px;">
                <p style="font-size:12px; color:#aaa;">Carregando...</p>
            </div>
        </div>

        <div class="perfil-acoes-container">
            <div class="btn-perfil-acao" onclick="verificarCheckInDiario(perfil)">
                <div class="icone-perfil fogo">🔥</div>
                <span>Check-in</span>
            </div>
            <div class="btn-perfil-acao" onclick="abrirPortaSecreta()">
                <div class="icone-perfil presente">🎁</div>
                <span>Resgatar</span>
            </div>
            <div class="btn-perfil-acao" onclick="abrirMapaPrioritario()">
                <div class="icone-perfil mapa">🗺️</div>
                <span>Rota Atual</span>
            </div>
        </div>

        <div class="popup-section">
            <h4>🏅 Exibir Conquistas (Máx 3)</h4>
            <div id="listaSelecaoConquistas" class="scrollable-list" style="max-height: 120px;"></div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid var(--cor-borda); padding-top: 15px;">
            <button onclick="fecharModalAtual()" style="background-color: #555; flex: 1;">❌ Cancelar</button>
            <button onclick="salvarNomePerfil()" style="flex: 1;">💾 Salvar Alterações</button>
        </div>
    `;

    atualizarBotaoRoleta();

    requestAnimationFrame(() => {
        renderizarMolduras();
        renderizarBaloes();
        renderizarSelecaoConquistas();
        if(typeof iniciarRelogiosPerfil === 'function') iniciarRelogiosPerfil();
        if(typeof verificarMissoesDiarias === 'function') verificarMissoesDiarias();
    });

    abrirModal('modalMeuPerfil');
}

function atualizarBotaoRoleta() {
    const btnGirar = document.getElementById('btnGirarRoleta');
    if (!btnGirar || !perfil) return;

    const hoje = new Date().toDateString();
    
    // 1. Cálculo rigoroso de Giros Totais
    let girosTotais = 1; // Padrão

    if (isVipAtivo(perfil)) {
        girosTotais = 4;
    } else if (isProAtivo(perfil) && perfil.proTier) {
        const configPro = (typeof PRECOS_PRO !== 'undefined') ? PRECOS_PRO[perfil.proTier] : null;
        girosTotais = configPro ? configPro.giros : 1;
    }
    
    // 2. Verifica giros realizados hoje
    const jaGirouHoje = perfil.ultimoGiroRoleta === hoje;
    let realizados = jaGirouHoje ? (perfil.girosRealizadosHoje || 0) : 0;

    // 3. Cálculo de restantes
    let girosRestantes = girosTotais - realizados;
    
    // Se o admin deu giros extras (valor negativo em realizados), eles somam aqui
    if (realizados < 0) {
        girosRestantes = girosTotais + Math.abs(realizados);
    }

    if (girosRestantes > 0) {
        btnGirar.textContent = `🎲 GIRAR (${girosRestantes} Restantes)`;
        btnGirar.disabled = false;
        btnGirar.style.opacity = "1";
        btnGirar.style.background = "linear-gradient(45deg, #d4af37, #f1c40f)";
        btnGirar.style.color = "#000";
    } else {
        btnGirar.textContent = "Volte Amanhã";
        btnGirar.disabled = true;
        btnGirar.style.opacity = "0.5";
        btnGirar.style.background = "#333";
        btnGirar.style.color = "#888";
    }
}

function previewFotoPerfil() {
    const file = document.getElementById('perfilFotoInput').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => document.getElementById('perfilFotoPreview').src = e.target.result;
        reader.readAsDataURL(file);
    }
}

async function salvarNomePerfil() {
    exibirAguarde("Salvando perfil...");
    const nome = document.getElementById('perfilNomeInput').value.trim();
    const file = document.getElementById('perfilFotoInput').files[0];
    
    if(!nome) return exibirPopup("O nome não pode ser vazio");

    let updates = { nome: nome };
    
    try {
        if (file) {
            // Usa a função uploadImage já existente
            const url = await uploadImage(file, `perfis/${auth.currentUser.uid}/${Date.now()}_foto`);
            updates.fotoPerfil = url;
        }
        
        await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
        fecharTodosOsModais();
        exibirPopup("Perfil atualizado com sucesso!");
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar: " + e.message);
    }
}
// Variável Global para garantir que o giro matemático bata com o visual embaralhado
window.itensRoletaAtual = [];

// Função para embaralhar array (Fisher-Yates)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Gera a lista crua (sem embaralhar ainda)
function gerarListaPremiosRaw() {
    let lista = [];
    // 1. Pontos (1 a 10)
    for (let i = 1; i <= 10; i++) {
        lista.push({ tipo: 'ponto', id: `ponto_${i}`, val: i, nome: `${i} Pontos` });
    }
    // 2. Molduras
    if (typeof MOLDURAS !== 'undefined') {
        Object.keys(MOLDURAS).forEach(key => {
            const m = MOLDURAS[key];
            if (!m.adminOnly) {
                lista.push({ tipo: 'moldura', id: key, val: m.classe, nome: m.nome, imgHtml: `<div class="mini-moldura-preview ${m.classe}"></div>` });
            }
        });
    }
    // 3. Balões
    if (typeof BALOES !== 'undefined') {
        Object.keys(BALOES).forEach(key => {
            const b = BALOES[key];
            if (!b.adminOnly) {
                lista.push({ tipo: 'balao', id: key, val: b.classe, nome: b.nome, imgHtml: `<div class="mini-balao-preview chat-message ${b.classe}">Chat</div>` });
            }
        });
    }
    // 4. Caixa Surpresa
    lista.push({ tipo: 'caixa', id: 'caixa_surpresa', val: '🎁', nome: 'Caixa Surpresa' });
    
    return lista;
}

async function girarRoleta() {
    if (!auth.currentUser) return;
    const btnGirar = document.getElementById('btnGirarRoleta');
    if (!btnGirar) return;
    
    // Validações de limite (Mantido igual)
    const hoje = new Date().toDateString();
    let girosTotais = isVipAtivo(perfil) ? 4 : 1;
    if (isProAtivo(perfil) && perfil.proTier && typeof PRECOS_PRO !== 'undefined') {
        girosTotais = PRECOS_PRO[perfil.proTier].giros;
    }
    const jaGirouHoje = perfil.ultimoGiroRoleta === hoje;
    let realizados = jaGirouHoje ? (perfil.girosRealizadosHoje || 0) : 0;
    
    if (realizados >= girosTotais) {
        exibirPopup("Sem giros", "Você já usou seus giros de hoje. Volte amanhã!");
        return;
    }

    // --- A MÁGICA: Sorteio baseado na lista EMBARALHADA global ---
    // Se por algum motivo a global estiver vazia, gera uma nova (fallback)
    if (!window.itensRoletaAtual || window.itensRoletaAtual.length === 0) {
        window.itensRoletaAtual = shuffleArray(gerarListaPremiosRaw());
    }

    const listaUsada = window.itensRoletaAtual;
    const totalItens = listaUsada.length;
    // Sorteia um índice (0 até total-1)
    const targetIndex = Math.floor(Math.random() * totalItens);
    const premioSorteado = listaUsada[targetIndex]; // Pega o objeto do prêmio

    btnGirar.disabled = true;
    btnGirar.textContent = "Sorteando..."; 

    perfil.girosRealizadosHoje = (realizados + 1);
    perfil.ultimoGiroRoleta = hoje;

    // --- ANIMAÇÃO VISUAL ---
    const ITEM_WIDTH = 90; 
    const LOOPS = 35; // Voltas completas
    const finalIndex = (LOOPS * totalItens) + targetIndex; // Onde parar
    
    const containerWidth = 320; 
    const targetCenterPixel = (finalIndex * ITEM_WIDTH) + (ITEM_WIDTH / 2);
    const viewCenterPixel = containerWidth / 2;
    const jitter = Math.floor(Math.random() * 40) - 20; 
    const moveX = targetCenterPixel - viewCenterPixel + jitter;

    const faixa = document.getElementById('roletaFaixa');
    if (faixa) {
        faixa.style.transition = `transform 6s cubic-bezier(0.1, 0, 0.1, 1)`;
        faixa.style.transform = `translateX(-${moveX}px)`;
    }

    // --- LÓGICA DE RECOMPENSA E SALVAMENTO ---
    try {
        let updates = {
            girosRealizadosHoje: perfil.girosRealizadosHoje,
            ultimoGiroRoleta: perfil.ultimoGiroRoleta
        };
        let msgRetorno = "";
        const agora = new Date();
        const validade24h = new Date(agora.getTime() + (24 * 60 * 60 * 1000));
        const validade3dias = new Date(agora.getTime() + (3 * 24 * 60 * 60 * 1000));

        if (premioSorteado.tipo === 'ponto') {
            updates.pontosFidelidade = firebase.firestore.FieldValue.increment(premioSorteado.val);
            msgRetorno = `Você ganhou ${premioSorteado.val} pontos de fidelidade!`;
        } 
        else if (premioSorteado.tipo === 'moldura') {
            updates[`premiosTemporarios.moldura_${premioSorteado.id}`] = firebase.firestore.Timestamp.fromDate(validade24h);
            msgRetorno = `Você desbloqueou a moldura "${premioSorteado.nome}" por 24 horas!`;
        }
        else if (premioSorteado.tipo === 'balao') {
            updates[`premiosTemporarios.balao_${premioSorteado.id}`] = firebase.firestore.Timestamp.fromDate(validade24h);
            msgRetorno = `Você desbloqueou o balão "${premioSorteado.nome}" por 24 horas!`;
        }
        else if (premioSorteado.tipo === 'caixa') {
            if (perfil.tipo === 'cliente') {
                updates.vip = true;
                updates.vipExpirationDate = validade3dias.toISOString();
                msgRetorno = "🎁 CAIXA SURPRESA: Você ganhou 3 DIAS DE VIP GRÁTIS!";
            } else {
                updates[`premiosTemporarios.destaque_topo`] = firebase.firestore.Timestamp.fromDate(validade24h);
                msgRetorno = "🎁 CAIXA SURPRESA: Destaque no TOPO por 24 horas!";
            }
        }

        setTimeout(async () => {
            await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
            
            const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
            perfil = userDoc.data();
            perfil.uid = auth.currentUser.uid;

            if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 99999 });
            if (typeof tocarSom === 'function') tocarSom('sucesso');

            // Exibe popup bloqueante
            exibirPopupBloqueante("🎉 Parabéns!", msgRetorno, () => {
                atualizarBotaoRoleta();
                if (typeof renderizarMolduras === 'function') renderizarMolduras();
                if (typeof renderizarBaloes === 'function') renderizarBaloes();
            });

            if (typeof notifyUser === 'function') notifyUser(auth.currentUser.uid, "🎰 Roleta", msgRetorno);

        }, 6000);

    } catch (e) {
        console.error("Erro roleta:", e);
        setTimeout(() => {
            exibirPopup("Erro", "Falha ao salvar prêmio. Verifique conexão.");
            atualizarBotaoRoleta();
        }, 6000);
    }
}

function verificarAcessoMoldura(key) {
    const m = MOLDURAS[key];
    const minhasMolduras = perfil.moldurasAdquiridas || [];
    
    if (m.adminOnly) {
        return perfil.tipo === 'admin' ? { acesso: true, tipo: 'permanente' } : { acesso: false, tipo: 'bloqueado_admin' };
    }
    if (minhasMolduras.includes(key)) return { acesso: true, tipo: 'permanente' };

    // VERIFICAÇÃO CORRETA DO PRÊMIO
    if (perfil.premiosTemporarios && perfil.premiosTemporarios[`moldura_${key}`]) {
        const validade = perfil.premiosTemporarios[`moldura_${key}`].toDate();
        if (validade > new Date()) return { acesso: true, tipo: 'temporario_roleta', validade };
    }

    if (isProAtivo(perfil) && perfil.proTier) {
         // ... (lógica pro mantida) ...
         const tier = perfil.proTier;
         const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
         const moldurasOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
         if (niveis.indexOf(tier) >= moldurasOrdem.indexOf(key) && niveis.indexOf(tier) > -1) {
             return { acesso: true, tipo: 'temporario' };
         }
    }
    return { acesso: false, tipo: 'nenhum' };
}	

function renderizarMolduras() {
    const container = document.getElementById('listaMolduras');
    container.className = 'molduras-scroll-container'; 
    container.innerHTML = '';
    
    Object.keys(MOLDURAS).forEach(key => {
        const m = MOLDURAS[key];
        if (m.adminOnly && perfil.tipo !== 'admin') return;

        const selecionada = perfil.molduraSelecionada === key;
        const statusAcesso = verificarAcessoMoldura(key); 
        const checkDisplay = selecionada ? 'flex' : 'none';
        
        let rodapeHtml = '';
        let estiloBorda = '';

        if (statusAcesso.tipo === 'permanente') {
            const texto = m.adminOnly ? 'Exclusivo Admin' : 'Adquirido';
            rodapeHtml = `<span style="font-size:10px; color:#4CAF50; margin-top:2px;">${texto}</span>`;
            estiloBorda = selecionada ? '' : 'border-color: #4CAF50;'; 
        } 
        else if (statusAcesso.tipo === 'temporario') {
            rodapeHtml = `<span style="font-size:9px; color:#00c6ff; font-weight:bold; margin-top:2px;">Liberado PRO</span>`;
            estiloBorda = selecionada ? '' : 'border-color: #00c6ff;';
        } 
        else if (statusAcesso.tipo === 'temporario_roleta') {
            // AQUI MUDOU: Adicionamos a classe e o data-expire
            const ts = statusAcesso.validade.getTime();
            rodapeHtml = `<span class="contador-tempo-real" data-expire="${ts}" style="font-size:9px; color:#e57373; font-weight:bold; margin-top:2px;">Calculando...</span>`;
            estiloBorda = 'border-color: #e57373;';
        } 
        else {
            rodapeHtml = `<span style="font-size:10px; color:#ff9800; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; margin-top:2px;">R$${m.preco}</span>`;
            estiloBorda = 'opacity: 0.7;';
        }

        container.innerHTML += `
            <div id="moldura_${key}" class="moldura-item ${selecionada ? 'selecionada' : ''}" 
                 onclick="gerenciarMoldura('${key}', this)" 
                 style="flex: 0 0 auto; width: 80px; display:flex; flex-direction:column; align-items:center; position:relative; cursor:pointer; margin: 0; ${estiloBorda}"> 
                 
                <div class="moldura-check" style="display: ${checkDisplay}; right: 10px;">✅</div>
                <div class="avatar-wrapper shop-size ${key}" style="display: flex; justify-content: center; align-items: center;">
                    <div class="coroa-topo"></div> 
                    <div class="${m.classe}" style="width: 60px; height: 60px; border-radius: 50%; background: #222;"></div>
                </div>
                <span style="font-size:12px; margin-top:8px; font-weight:bold; color: #fff;">${m.nome}</span>
                ${rodapeHtml}
            </div>`;
    });
}

function selecionarMolduraVisualmente(element) {
    // Remove seleção visual de todas as outras
    document.querySelectorAll('.moldura-item').forEach(item => {
        item.classList.remove('temp-selected');
        item.classList.remove('selecionada'); // Remove a classe persistente antiga visualmente
    });
    
    // Adiciona a classe temporária ao clicado (que força o check a aparecer via CSS)
    element.classList.add('temp-selected');
}

function renderizarBaloes() {
    const container = document.getElementById('listaBaloes');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(BALOES).forEach(key => {
        const b = BALOES[key];
        
        // Filtro de Admin (não mostra se não for admin)
        if (b.adminOnly && perfil.tipo !== 'admin') return;

        const selecionado = perfil.balaoSelecionado === key;
        const statusAcesso = verificarAcessoBalao(key);
        
        const checkDisplay = selecionado ? 'flex' : 'none';
        let rodapeHtml = '';
        let estiloBorda = '';

        // Lógica de visualização do status (Comprado, PRO, Roleta)
        if (statusAcesso.tipo === 'permanente') {
            const texto = b.adminOnly ? 'Exclusivo' : 'Adquirido';
            rodapeHtml = `<span style="font-size:10px; color:#4CAF50; margin-top:2px;">${texto}</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #4CAF50;'; 
        } else if (statusAcesso.tipo === 'temporario_pro') {
            rodapeHtml = `<span style="font-size:9px; color:#00c6ff;">Liberado PRO</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #00c6ff;';
        } else if (statusAcesso.tipo === 'temporario_roleta') {
            const horasRestantes = Math.ceil((statusAcesso.validade - new Date()) / (1000 * 60 * 60));
            rodapeHtml = `<span style="font-size:9px; color:#e57373;">Prêmio: ${horasRestantes}h</span>`;
            estiloBorda = 'border-color: #e57373;';
        } else {
            rodapeHtml = `<span style="font-size:10px; color:#ff9800; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; margin-top:2px;">R$${b.preco}</span>`;
            estiloBorda = 'opacity: 0.7;';
        }

        // Preview Visual do Balão dentro da loja
        const previewHtml = `
            <div class="chat-message ${b.classe} custom-bubble" style="width: 60px; height: 40px; display:flex; align-items:center; justify-content:center; font-size:10px; margin-bottom:5px;">
                Abc
            </div>
        `;

        container.innerHTML += `
            <div id="balao_${key}" class="moldura-item ${selecionado ? 'selecionada' : ''}" 
                 onclick="gerenciarBalao('${key}', this)" 
                 style="flex: 0 0 auto; width: 90px; display:flex; flex-direction:column; align-items:center; position:relative; cursor:pointer; margin: 0; ${estiloBorda}"> 
                 
                <div class="moldura-check" style="display: ${checkDisplay}; right: 10px;">✅</div>
                ${previewHtml}
                <span style="font-size:11px; font-weight:bold; color: #fff;">${b.nome}</span>
                ${rodapeHtml}
            </div>`;
    });
}

async function gerenciarBalao(key, element) {
    const b = BALOES[key];
    const statusAcesso = verificarAcessoBalao(key);
    
    if (statusAcesso.acesso) {
        selecionarMolduraVisualmente(element);
        try {
            exibirAguarde("Aplicando...");
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ balaoSelecionado: key });
            fecharTodosOsModais(); // Fecha Aguarde
            location.reload(); // <--- ATUALIZAÇÃO INSTANTÂNEA
        } catch (e) { 
            fecharTodosOsModais();
            exibirPopup("Erro ao salvar."); 
        }
        return;
    }
    executarCompraBalao(key, b);
}

function executarCompraBalao(key, b) {
    if (perfil.saldo < b.preco) {
        return exibirPopup("Saldo insuficiente", "Deposite fundos para comprar este estilo.", "aviso", () => abrirModal('modalCarteira'));
    }
    
    exibirConfirmacao(
        "Comprar Estilo de Chat?", 
        `Deseja adquirir "${b.nome}" VITALÍCIO por R$ ${b.preco.toFixed(2)}?`, 
        () => {
            exibirAguarde("Comprando...");
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                saldo: firebase.firestore.FieldValue.increment(-b.preco),
                baloesAdquiridos: firebase.firestore.FieldValue.arrayUnion(key),
                balaoSelecionado: key
            }).then(() => {
                fecharTodosOsModais();
                exibirPopup("Sucesso!", "Estilo de chat adquirido!", "sucesso", () => abrirModalPerfil());
            }).catch(e => {
                fecharTodosOsModais();
                exibirPopup("Erro na compra: " + e.message);
            });
        }
    );
}

async function gerenciarMoldura(key, element) {
    const m = MOLDURAS[key];
    const statusAcesso = verificarAcessoMoldura(key);
    
    if (statusAcesso.tipo === 'permanente') {
        selecionarMolduraVisualmente(element);
        try {
            exibirAguarde("Aplicando...");
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ molduraSelecionada: key });
            fecharTodosOsModais();
            location.reload(); // <--- ATUALIZAÇÃO INSTANTÂNEA
        } catch (e) {
            fecharTodosOsModais();
            exibirPopup("Erro", "Falha ao salvar moldura.");
        }
        return;
    }

    if (statusAcesso.tipo === 'temporario' || statusAcesso.tipo === 'temporario_roleta') {
        const modal = document.getElementById('modalConfirmacaoGenerica');
        document.getElementById('confirmacaoGenericaTitulo').textContent = "Item Liberado!";
        document.getElementById('confirmacaoGenericaMensagem').textContent = `Você tem acesso a este item.\n\nDeseja equipar agora ou comprar definitivo?`;
        
        const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
        const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
        
        btnNao.textContent = "Equipar (Grátis)";
        btnNao.style.backgroundColor = "#00c6ff";
        btnNao.onclick = async () => {
            exibirAguarde("Aplicando...");
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ molduraSelecionada: key });
            fecharTodosOsModais();
            location.reload(); // <--- ATUALIZAÇÃO INSTANTÂNEA
        };

        btnSim.textContent = `Comprar (R$ ${m.preco})`;
        btnSim.style.backgroundColor = "#4CAF50";
        btnSim.onclick = () => {
            executarCompraMoldura(key, m); 
        };

        abrirModal('modalConfirmacaoGenerica');
        return;
    }

    executarCompraMoldura(key, m);
}

// Função CORRIGIDA para usar Saldo Digital na Moldura
function executarCompraMoldura(key, m) {
    const saldoDigital = perfil.saldoDigital || 0;

    // CORREÇÃO: Verifica Saldo Digital
    if (saldoDigital < m.preco) {
        return exibirPopup("Moedas Insuficientes", "Você precisa de mais Saldo Digital (Moedas) para comprar este item.", "aviso", () => {
            iniciarCompraMoedas(); // Leva para compra de moedas
        });
    }
    
    exibirConfirmacao(
        "Comprar Moldura?", 
        `Deseja adquirir a moldura "${m.nome}" VITALÍCIA por ${m.preco.toFixed(2)} Moedas?`, 
        () => {
            exibirAguarde("Comprando...");
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                saldoDigital: firebase.firestore.FieldValue.increment(-m.preco), // CORREÇÃO: Desconta do Digital
                moldurasAdquiridas: firebase.firestore.FieldValue.arrayUnion(key),
                molduraSelecionada: key
            }).then(() => {
                fecharTodosOsModais();
                exibirPopup("Sucesso!", "Compra realizada!", "sucesso", () => abrirModalPerfil());
            }).catch(e => {
                fecharTodosOsModais();
                exibirPopup("Erro na compra: " + e.message);
            });
        }
    );
}

// Função auxiliar para formatar tempo restante
function formatarTempoRestante(dataFutura) {
    const agora = new Date();
    const diff = dataFutura - agora;

    if (diff <= 0) return "Expirado";

    // Calcula dias, horas, minutos, segundos
    const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
    const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const segundos = Math.floor((diff % (1000 * 60)) / 1000);

    // Se tiver mais de 1 dia, mostra "Xd HH:MM:SS"
    if (dias > 0) {
        return `${dias}d ${horas.toString().padStart(2,'0')}:${minutos.toString().padStart(2,'0')}:${segundos.toString().padStart(2,'0')}`;
    }
    // Senão mostra "HH:MM:SS"
    return `${horas.toString().padStart(2,'0')}:${minutos.toString().padStart(2,'0')}:${segundos.toString().padStart(2,'0')}`;
}

// Variável global para o intervalo dos relógios
let intervaloRelogiosPerfil = null;

function iniciarRelogiosPerfil() {
    // Limpa anterior se existir
    if (intervaloRelogiosPerfil) clearInterval(intervaloRelogiosPerfil);

    const atualizar = () => {
        const elementos = document.querySelectorAll('.contador-tempo-real');
        if (elementos.length === 0) return;

        elementos.forEach(el => {
            // CORREÇÃO: Garante que é um número
            const timestamp = parseInt(el.getAttribute('data-expire'));
            if (!timestamp || isNaN(timestamp)) {
                el.textContent = "Erro Data";
                return;
            }
            
            const dataFutura = new Date(timestamp);
            const texto = formatarTempoRestante(dataFutura);
            
            el.textContent = texto;
            
            if (texto === "Expirado") {
                el.style.color = "gray";
            }
        });
    };

    // Roda imediatamente e depois a cada 1s
    atualizar();
    intervaloRelogiosPerfil = setInterval(atualizar, 1000);
}

function renderizarSelecaoConquistas() {
    const container = document.getElementById('listaSelecaoConquistas');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Proteção: Garante que são arrays, mesmo que venham nulos do banco
    const minhasConquistas = Array.isArray(perfil.conquistas) ? perfil.conquistas : [];
    const selecionadas = Array.isArray(perfil.conquistasSelecionadas) ? perfil.conquistasSelecionadas : [];
    
    // Combina definições
    const todasDefinicoes = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
    
    if(minhasConquistas.length === 0) {
        container.innerHTML = "<p style='opacity:0.7; font-size:13px; text-align:center;'>Você ainda não desbloqueou conquistas. Complete serviços para ganhar!</p>";
        return;
    }

    // Ordenação: Selecionadas aparecem primeiro na lista
    minhasConquistas.sort((a, b) => {
        const selA = selecionadas.includes(a);
        const selB = selecionadas.includes(b);
        if (selA && !selB) return -1;
        if (!selA && selB) return 1;
        return 0;
    });

    minhasConquistas.forEach(cId => {
        const def = todasDefinicoes[cId];
        if(!def) return; 
        
        const isSelected = selecionadas.includes(cId);
        
        // Estilos Visuais Fortes para indicar seleção
        const bg = isSelected ? 'rgba(46, 204, 113, 0.2)' : 'var(--cor-botoes)'; // Fundo Verde se selecionado
        const border = isSelected ? '2px solid #2ecc71' : '1px solid var(--cor-borda)'; // Borda Verde
        const opacity = isSelected ? '1' : '0.7';

        container.innerHTML += `
            <div onclick="toggleConquistaChat('${cId}')" 
                 style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:8px; margin-bottom:5px; cursor:pointer; transition:all 0.2s; background:${bg}; border:${border}; opacity:${opacity};">
                <span style="font-size:24px;">${def.icone}</span> 
                <div style="flex-grow:1;">
                    <div style="font-weight:bold; color:#fff">${def.nome}</div>
                    <div style="font-size:10px; color:#aaa;">${def.descricao}</div>
                </div>
                ${isSelected ? '<span style="color:#2ecc71; font-weight:bold; font-size:18px;">✅</span>' : ''}
            </div>
        `;
    });
    
    // Contador no topo
    const contadorHtml = `<p style="font-size:12px; color:#aaa; margin-bottom:10px; text-align:center;">Exibindo no perfil: <b style="color:${selecionadas.length === 3 ? '#2ecc71' : '#fff'}">${selecionadas.length}/3</b></p>`;
    container.insertAdjacentHTML('afterbegin', contadorHtml);
}

async function toggleConquistaChat(cId) {
    // 1. Cria uma CÓPIA do array atual para não mexer na referência direta ainda
    let listaAtual = Array.isArray(perfil.conquistasSelecionadas) 
        ? [...perfil.conquistasSelecionadas] 
        : [];
    
    // 2. Verifica se o ID já está na lista
    const index = listaAtual.indexOf(cId);

    if (index > -1) {
        // --- DESELECIONAR ---
        // Se já existe, remove da lista
        listaAtual.splice(index, 1);
        tocarSom('ping'); // Feedback sonoro leve
    } else {
        // --- SELECIONAR ---
        // Verifica o limite de 3
        if (listaAtual.length >= 3) {
            return exibirPopup("Limite Atingido", "Você só pode exibir 3 conquistas. Desmarque uma para escolher outra.");
        }
        // Adiciona na lista
        listaAtual.push(cId);
        tocarSom('sucesso'); // Feedback sonoro positivo
    }

    // 3. ATUALIZAÇÃO INSTANTÂNEA (Optimistic UI)
    // Atualiza a variável global imediatamente para a tela reagir
    perfil.conquistasSelecionadas = listaAtual;
    
    // Força a atualização visual da lista AGORA
    renderizarSelecaoConquistas();

    // 4. SALVA NO BANCO (Em segundo plano)
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ 
            conquistasSelecionadas: listaAtual 
        });
        console.log("Seleção de conquistas salva no banco.");
    } catch(e) {
        console.error("Erro ao salvar seleção:", e);
        exibirPopup("Erro de conexão", "Não foi possível salvar sua seleção no servidor.");
        // Opcional: Recarregar perfil para desfazer a mudança visual se der erro grave
    }
}

async function salvarLocalizacaoConfig() {
    const estado = document.getElementById('configEstado').value;
    const cidade = document.getElementById('configCidade').value;
    if (!estado || !cidade) return exibirPopup("Selecione estado e cidade.");
    await db.collection('usuarios').doc(auth.currentUser.uid).update({ estado, cidade });
    exibirPopup("Localização salva!");
    fecharModalAtual();
}

document.getElementById('btnConfig').onclick = () => {
    setupConfiguracoes();
    abrirModal('modalConfiguracoes');
}
</script>
<script>
    if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/firebase-messaging-sw.js').then(function(reg) {
      console.log('✅ Service Worker registrado:', reg.scope);

      reg.addEventListener('updatefound', () => {
        newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
             // Força atualização imediata sem perguntar
             newWorker.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
    }).catch(function(err) { console.error('SW Falhou:', err); });

    let refreshing;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshing) return;
      // window.location.reload(); <--- COMENTE ESTA LINHA SE O APP RECARREGA SOZINHO DEMAIS
      // refreshing = true;
      console.log("SW Atualizado (Reload prevenido para estabilidade)");
    });

// --- NOVO CÓDIGO: Adiciona a funcionalidade de login com a tecla Enter ---
const loginFields = [document.getElementById('email'), document.getElementById('senha')];
loginFields.forEach(field => {
    field.addEventListener('keyup', function(event) {
        // Verifica se a tecla pressionada foi "Enter"
        if (event.key === 'Enter') {
            // Impede qualquer ação padrão do navegador
            event.preventDefault();
            // Pega o botão de entrar pelo texto, pois não tem ID
            const entrarButton = Array.from(document.querySelectorAll('#authView button')).find(btn => btn.textContent.includes('Entrar'));
            // Clica no botão
            if (entrarButton) {
                entrarButton.click();
            }
        }
    });
});
// --- FIM DO NOVO CÓDIGO ---

// ======================================================================
// --- FUNÇÕES DE FLUXO FINANCEIRO (DEPÓSITO/SAQUE) ---
// ======================================================================

// Função para voltar ao modal da carteira
function voltarParaCarteira() {
    // Passo C: Fecha o modalFluxoFinanceiro e reabre o modalCarteira
    const modalFluxoFinanceiro = document.getElementById('modalFluxoFinanceiro');
    if (modalFluxoFinanceiro) {
        modalFluxoFinanceiro.style.display = 'none';
    }
    
    // Reabre o modalCarteira
    const modalCarteira = document.getElementById('modalCarteira');
    if (modalCarteira) {
        modalCarteira.style.display = 'flex';
    }
}

// Sobrescreve window.iniciarDeposito - Versão simplificada: redireciona direto para WhatsApp
window.iniciarDeposito = function() {
    if (checkGuestLimit && checkGuestLimit()) return;
    
    const mensagem = encodeURIComponent("Olá, gostaria de fazer um depósito no App Navalha de Ouro.");
    const whatsappUrl = `https://wa.me/5527995003737?text=${mensagem}`;
    window.open(whatsappUrl, '_blank');
};

// Função para confirmar depósito no fluxo
async function confirmarDepositoFluxo() {
    const primeiroNome = document.getElementById('depositoPrimeiroNome').value.trim();
    const segundoNome = document.getElementById('depositoSegundoNome').value.trim();
    const cpf = document.getElementById('depositoCpf').value.trim();
    const telefone = document.getElementById('depositoTelefone').value.trim();
    const valor = parseFloat(document.getElementById('depositoValor').value);

    if (!primeiroNome || !segundoNome || !cpf || !telefone || isNaN(valor) || valor <= 0) {
        return exibirPopup("Por favor, preencha todos os campos corretamente.");
    }

    const nomeCompleto = `${primeiroNome} ${segundoNome}`;

    exibirAguarde("Salvando solicitação...");

    try {
        console.log("Salvando transação de depósito...", { uid: auth.currentUser.uid, tipo: "deposito", valor, status: "pendente" });
        
        // Salva na coleção 'transacoes' com status 'pendente' (CRUCIAL para o painel do Admin)
        const docRef = await db.collection("transacoes").add({
            uid: auth.currentUser.uid,
            tipo: "deposito",
            valor: valor,
            status: "pendente",
            data: firebase.firestore.FieldValue.serverTimestamp(),
            // Campos adicionais para referência
            usuarioNome: perfil.nome,
            dadosDeposito: { nomeCompleto, cpf, telefone }
        });

        console.log("✅ Transação de depósito salva com sucesso! ID:", docRef.id);

        fecharTodosOsModais();
        exibirPopup("✅ Solicitação de depósito enviada com sucesso!", "Sucesso", "sucesso", () => {
            // Reabre o modalCarteira após sucesso
            const modalCarteira = document.getElementById('modalCarteira');
            if (modalCarteira) {
                modalCarteira.style.display = 'flex';
            }
        });

    } catch (error) {
        console.error("Erro ao criar transação:", error);
        fecharTodosOsModais();
        exibirPopup("Erro ao processar solicitação. Tente novamente.");
    }
}

// Cria window.solicitarSaque - Versão simplificada: redireciona direto para WhatsApp
window.solicitarSaque = function() {
    const mensagem = encodeURIComponent("Olá, gostaria de solicitar um saque no App Navalha de Ouro.");
    const whatsappUrl = `https://wa.me/5527995003737?text=${mensagem}`;
    window.open(whatsappUrl, '_blank');
};

// Cria window.iniciarCompraMoedas - Versão simplificada: usa TWA Billing
window.iniciarCompraMoedas = function() {
    // Verifica se o serviço TWA Billing está disponível
    if (typeof playStoreService !== 'undefined' && playStoreService !== null) {
        // Tenta abrir o modal de moedas que já tem os botões de compra via Play Store
        const modalMoedas = document.getElementById('modalPacotesMoedasTWA');
        if (modalMoedas) {
            abrirModal('modalPacotesMoedasTWA');
        } else {
            // Se o modal não existir, tenta usar comprarComPlayStore diretamente
            if (typeof comprarComPlayStore === 'function') {
                // Usa um SKU padrão (o usuário pode escolher depois)
                comprarComPlayStore('moedas_10', 10.00);
            } else {
                alert("Redirecionando para Google Play...");
            }
        }
    } else {
        // Se TWA Billing não estiver disponível, mostra alert temporário
        alert("Redirecionando para Google Play...");
    }
};

// Função para confirmar saque no fluxo
async function confirmarSaqueFluxo() {
    const nome = document.getElementById('saqueNomeCompleto').value.trim();
    const valorSolicitado = parseFloat(document.getElementById('saqueValor').value);
    const chaveTipo = document.getElementById('saqueChavePixTipo').value;
    const chave = document.getElementById('saqueChavePix').value.trim();

    if (!nome || isNaN(valorSolicitado) || valorSolicitado <= 0 || !chaveTipo || !chave) {
        return exibirPopup("Preencha todos os dados corretamente.");
    }

    // Leitura dos saldos
    const saldoRealDisponivel = (perfil.saldoReal !== undefined) ? perfil.saldoReal : (perfil.saldo || 0);
    const saldoBonusDisponivel = perfil.saldoBonus || 0;

    // Regra de saque 1:1
    let debitoBonus = valorSolicitado / 2;
    let debitoReal = valorSolicitado / 2;

    if (debitoBonus > saldoBonusDisponivel) {
        const diferenca = debitoBonus - saldoBonusDisponivel;
        debitoBonus = saldoBonusDisponivel;
        debitoReal += diferenca;
    }

    if (debitoReal > saldoRealDisponivel) {
        return exibirPopup("Saldo Real Insuficiente", 
            `Para sacar R$ ${valorSolicitado.toFixed(2)}, pela regra de Bônus (1:1), você precisaria de:\n` +
            `• R$ ${debitoReal.toFixed(2)} de Saldo Real\n` +
            `• R$ ${debitoBonus.toFixed(2)} de Saldo Bônus\n\n` +
            `Seu Saldo Real disponível: R$ ${saldoRealDisponivel.toFixed(2)}`
        );
    }

    if(!confirm(`Confirma o saque de R$ ${valorSolicitado.toFixed(2)}?\n\nSerá debitado:\n- R$ ${debitoReal.toFixed(2)} (Real)\n- R$ ${debitoBonus.toFixed(2)} (Bônus)`)) return;

    exibirAguarde("Salvando solicitação...");

    try {
        console.log("Salvando transação de saque...", { uid: auth.currentUser.uid, tipo: "saque", valor: valorSolicitado, status: "pendente" });
        
        // Salva na coleção 'transacoes' com status 'pendente' (CRUCIAL para o painel do Admin)
        const docRef = await db.collection("transacoes").add({
            uid: auth.currentUser.uid,
            tipo: "saque",
            valor: valorSolicitado,
            status: "pendente",
            data: firebase.firestore.FieldValue.serverTimestamp(),
            // Campos adicionais para referência
            usuarioNome: perfil.nome,
            dadosSaque: { nomeTitular: nome },
            debitoRealCalculado: debitoReal,
            debitoBonusCalculado: debitoBonus,
            chavePixTipo: chaveTipo,
            chavePix: chave
        });

        console.log("✅ Transação de saque salva com sucesso! ID:", docRef.id);

        fecharTodosOsModais();
        exibirPopup("✅ Solicitação de saque enviada com sucesso!", "Sucesso", "sucesso", () => {
            // Reabre o modalCarteira após sucesso
            const modalCarteira = document.getElementById('modalCarteira');
            if (modalCarteira) {
                modalCarteira.style.display = 'flex';
            }
        });

    } catch (e) {
        console.error("Erro ao criar transação de saque:", e);
        fecharTodosOsModais();
        exibirPopup("Erro: " + e.message);
    }
}

// ======================================================================
// --- FIM DAS FUNÇÕES DE FLUXO FINANCEIRO ---
// ======================================================================

// ======================================================================
// --- FUNÇÃO ABRIR CHAT DO MAPA COM MODO-MAPA ---
// ======================================================================

// Sobrescreve window.abrirChatDoMapa para adicionar a classe .modo-mapa
// A função original abrirChatDoMapa() está no escopo global e será chamada
window.abrirChatDoMapa = function(id) {
    // Adiciona a classe .modo-mapa ao chat
    const janelaChat = document.getElementById('janelaChat');
    if (janelaChat) {
        janelaChat.classList.add('modo-mapa');
    }
    
    // Se foi passado um id, define o chatTempId
    if (id) {
        window.chatTempId = id;
    }
    
    // Chama a função original abrirChatDoMapa (definida anteriormente no código)
    // A função original está no escopo global, então podemos chamá-la diretamente
    // Verificamos se existe e não é a mesma referência (para evitar recursão)
    if (typeof abrirChatDoMapa === 'function' && abrirChatDoMapa !== window.abrirChatDoMapa) {
        abrirChatDoMapa();
    } else {
        // Fallback: executa a lógica básica de abrir o chat
        abrirModal('janelaChat');
        const modalChat = document.getElementById('janelaChat');
        if(modalChat) {
            modalChat.style.zIndex = '25000';
            const chatTitle = document.getElementById('chatTitle');
            if(chatTitle) chatTitle.textContent = "💬 Chat da Viagem";
        }
    }
};

// ======================================================================
// --- FIM DA FUNÇÃO ABRIR CHAT DO MAPA ---
// ======================================================================

</script>

<!-- Modal Fluxo Financeiro (Depósito/Saque) -->
<div id="modalFluxoFinanceiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" id="modalFluxoFinanceiroContent">
    <!-- Conteúdo será injetado dinamicamente -->
  </div>
</div>
</body>
</html>